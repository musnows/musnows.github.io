<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯ | æ…•é›ªçš„å¯’èˆ</title><meta name="author" content="æ…•é›ªå¹´å"><meta name="copyright" content="æ…•é›ªå¹´å"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ä»Šå¤©è®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡å™¨&#x2F;å®¢æˆ·ç«¯ä»£ç "><meta property="og:type" content="article"><meta property="og:title" content="ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯"><meta property="og:url" content="https://blog.musnow.top/posts/2171263616/index.html"><meta property="og:site_name" content="æ…•é›ªçš„å¯’èˆ"><meta property="og:description" content="ä»Šå¤©è®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡å™¨&#x2F;å®¢æˆ·ç«¯ä»£ç "><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.musnow.top/img/bg/gm10.jpg"><meta property="article:published_time" content="2023-02-05T04:30:55.000Z"><meta property="article:modified_time" content="2023-03-29T08:18:13.000Z"><meta property="article:author" content="æ…•é›ªå¹´å"><meta property="article:tag" content="Linux"><meta property="article:tag" content="çº¿ç¨‹"><meta property="article:tag" content="è®¡ç®—æœºç½‘ç»œ"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.musnow.top/img/bg/gm10.jpg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/2171263616/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"è·ç¦»ä¸Šæ¬¡æ›´æ–°æœ¬æ–‡å·²ç»è¿‡å»äº†","messageNext":"å¤©ï¼Œæ–‡ç« éƒ¨åˆ†å†…å®¹å¯èƒ½å·²ç»è¿‡æ—¶ï¼Œè¯·æ³¨æ„ç”„åˆ«"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":420},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":600,"languages":{"author":"ä½œè€…: æ…•é›ªå¹´å","link":"é“¾æ¥: ","source":"æ¥æº: æ…•é›ªçš„å¯’èˆ","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-03-29 16:18:13"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/equipment/equipment.css?1"><script>!function(r){"use strict";!function(){var t=window,s=document,e=r,c="".concat("https:"===s.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),i=s.createElement("script"),n=s.getElementsByTagName("script")[0];i.type="text/javascript",i.setAttribute("charset","UTF-8"),i.async=!0,i.src=c,i.id="LA_COLLECT",e.d=i;function o(){t.LA.ids.push(e)}t.LA?t.LA.ids&&o():(t.LA=r,t.LA.ids=[],o()),n.parentNode.insertBefore(i,n)}()}({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="æ…•é›ªçš„å¯’èˆ" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/favicon.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">22</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> èƒŒåŒ…</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url(/img/bg/gm10.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="æ…•é›ªçš„å¯’èˆ"><img class="site-icon" src="/favicon.jpg"><span class="site-name">æ…•é›ªçš„å¯’èˆ</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> èƒŒåŒ…</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-02-05T04:30:55.000Z" title="å‘è¡¨äº 2023-02-05 12:30:55">2023-02-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-29T08:18:13.000Z" title="æ›´æ–°äº 2023-03-29 16:18:13">2023-03-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">ç¼–ç¨‹å­¦ä¹ </a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/Linux/">Linux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">5.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>21åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span data-flag-title="ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>ä»Šå¤©è®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡å™¨&#x2F;å®¢æˆ·ç«¯ä»£ç </p><span id="more"></span><blockquote><p>å®Œæ•´ä»£ç è§æˆ‘çš„gitee <a target="_blank" rel="noopener" href="https://gitee.com/musnow/raspberry-practice/tree/master/code">è¿æ¥</a></p><p>é˜…è¯»æœ¬æ–‡å‰ï¼Œå»ºè®®å…ˆé˜…è¯»ğŸ‘‰ <a href="https://blog.musnow.top/posts/368672249/">udpæœåŠ¡å™¨</a></p></blockquote><h1 id="1-åŸºæœ¬æ¡†æ¶"><a href="#1-åŸºæœ¬æ¡†æ¶" class="headerlink" title="1.åŸºæœ¬æ¡†æ¶"></a>1.åŸºæœ¬æ¡†æ¶</h1><p>tcpçš„æœåŠ¡å™¨å’ŒudpæœåŠ¡å™¨åˆå§‹åŒ–æ¥å£æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼ŒåŒºåˆ«å°±åœ¨äºè¦é€‰æ‹©<code>å­—èŠ‚æµ</code>è¿›è¡Œåˆå§‹åŒ–</p><p>ä½†æ˜¯åˆ°è¿è¡ŒçŠ¶æ€å°±ä¸åŒäº†</p><ul><li>tcpæ˜¯éœ€è¦è¿æ¥çš„</li><li>udpä¸éœ€è¦è¿æ¥</li></ul><p>æ‰€ä»¥å°±ä¼šå‡ºç°åˆ†æ­§ï¼šudpå¯ä»¥ç”¨sendtoå’Œreceveæ¥å‘é€&#x2F;æ¥æ”¶ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯åªéœ€è¦ç›‘å¬ç‰¹å®šç«¯å£æ”¶åˆ°äº†ä»€ä¹ˆä¿¡æ¯ï¼›</p><p>ä½†tcpå¹¶ä¸èƒ½è¿™ä¹ˆåšï¼Œåœ¨é€šä¿¡ä¹‹å‰ï¼ŒtcpæœåŠ¡å™¨å¿…é¡»è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é“¾æ¥ã€‚</p><p>ä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼ŒudpæœåŠ¡å™¨å¥½æ¯”ä¸€ä¸ªæ°´ç›†ï¼Œç­‰å¾…æ°´çš„æ³¨å…¥ï¼›è€ŒtcpæœåŠ¡å™¨æ˜¯ä¸ªæ°´ç®¡ï¼Œå¿…é¡»è¦ä¸¤å¤´è¿é€šäº†ï¼Œæ‰èƒ½å¼€å§‹æ³¨æ°´</p><h2 id="1-1-ç±»æˆå‘˜"><a href="#1-1-ç±»æˆå‘˜" class="headerlink" title="1.1 ç±»æˆå‘˜"></a>1.1 ç±»æˆå‘˜</h2><p>ç±»çš„æˆå‘˜å˜é‡å’Œudpå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯éœ€è¦æœåŠ¡å™¨çš„ipã€ç«¯å£ã€sockfdè¿™äº›ä¿¡æ¯ã€‚ä¸ºäº†æ›´å®¹æ˜“åŒºåˆ†ï¼Œå°†tcpæœåŠ¡å™¨çš„<code>socket fd</code>æ”¹ä¸º<code>_listenSock</code>ï¼Œæ„ä¸ºç›‘å¬ç«¯å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ç«¯å£å·</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ipåœ°å€</span></span><br><span class="line">    string _ip;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨socket fdä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> _listenSock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1-2-å¤´æ–‡ä»¶"><a href="#1-2-å¤´æ–‡ä»¶" class="headerlink" title="1.2 å¤´æ–‡ä»¶"></a>1.2 å¤´æ–‡ä»¶</h2><p>è¿™é‡Œå¯¹å¤´æ–‡ä»¶è¿›è¡Œä¸€å®šçš„è¯´æ˜ï¼Œå› ä¸ºæœåŠ¡å™¨ä»£ç ä¸­çš„å¤´æ–‡ä»¶å®åœ¨å¤ªå¤šäº†</p><p>å½“ä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ¥å£çš„æ—¶å€™ï¼Œå¯ä»¥å»é‡‡ç”¨manæ‰‹å†Œæ¥è·å–è¯¥æ¥å£çš„å¤´æ–‡ä»¶ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// å¤´æ–‡ä»¶å¤ªå¤šäº†ï¼Œæ‰€ä»¥æ–°èµ·ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span><span class="comment">//åˆ¤æ–­å­—ç¬¦ä¸²å¤§å†™å°å†™æ¥å£éœ€è¦çš„åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strings.h&gt;</span><span class="comment">// å¿½ç•¥å¤§å°å†™æ¯”è¾ƒstrcasecmp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>  <span class="comment">//å¾ˆå¤šliunxç³»ç»Ÿæ¥å£éƒ½éœ€è¦è¿™ä¸ª</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_ERR 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIND_ERR   2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LISTEN_ERR 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USAGE_ERR  4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONN_ERR   5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br></pre></td></tr></table></figure><h1 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2.åˆå§‹åŒ–"></a>2.åˆå§‹åŒ–</h1><p>æ¥å£çš„ä»‹ç»å°±è·Ÿéšå®ç°ä¸€æ­¥ä¸€æ­¥æ¥å§</p><h2 id="2-1-æ„é€ sock"><a href="#2-1-æ„é€ sock" class="headerlink" title="2.1 æ„é€ sock"></a>2.1 æ„é€ sock</h2><p>è¿™é‡Œå‡ºç°äº†tcpå’Œudpç¬¬ä¸€ä¸ªä¸åŒä¹‹å¤„ï¼Œtcpæ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œudpé¢å‘çš„æ˜¯æ•°æ®æŠ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TcpServer</span>(<span class="type">uint16_t</span> port,<span class="type">const</span> string&amp; ip=<span class="string">&quot;&quot;</span>)</span><br><span class="line"> :_port(port), _ip(ip), _listenSock(<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºsocketå¥—æ¥å­—,é‡‡ç”¨å­—èŠ‚æµï¼ˆå³tcpï¼‰</span></span><br><span class="line">    _listenSock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//æœ¬è´¨æ˜¯æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (_listenSock &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">logging</span>(FATAL, <span class="string">&quot;socket:%s:%d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;socket create success: %d&quot;</span>, _listenSock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-åˆå§‹åŒ–sockaddr-in"><a href="#2-2-åˆå§‹åŒ–sockaddr-in" class="headerlink" title="2.2 åˆå§‹åŒ–sockaddr_in"></a>2.2 åˆå§‹åŒ–sockaddr_in</h2><p>ç»§ç»­ï¼Œåˆå§‹åŒ–sockaddr_inçš„æ“ä½œå’Œudpæ˜¯å®Œå…¨ä¸€è‡´çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. ç»‘å®šç½‘ç»œä¿¡æ¯ï¼ŒæŒ‡æ˜ip+port</span></span><br><span class="line"><span class="comment">// 2.1 å…ˆå¡«å……åŸºæœ¬ä¿¡æ¯åˆ° struct sockaddr_in</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> local;</span><br><span class="line"><span class="built_in">memset</span>(&amp;local,<span class="number">0</span>,<span class="built_in">sizeof</span>(local));<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// åè®®å®¶æ—ï¼Œè®¾ç½®ä¸ºipv4</span></span><br><span class="line">local.sin_family = AF_INET; </span><br><span class="line"><span class="comment">// ç«¯å£ï¼Œéœ€è¦è¿›è¡Œ æœ¬åœ°-&gt;ç½‘ç»œè½¬æ¢</span></span><br><span class="line">local.sin_port = <span class="built_in">htons</span>(_port);</span><br><span class="line"><span class="comment">// é…ç½®ip</span></span><br><span class="line"><span class="comment">// å¦‚æœåˆå§‹åŒ–æ—¶å€™çš„ipä¸ºç©ºï¼Œåˆ™è°ƒç”¨INADDR_ANYä»£è¡¨ä»»æ„ipã€‚å¦åˆ™å¯¹ä¼ å…¥çš„ipè¿›è¡Œè½¬æ¢åèµ‹å€¼</span></span><br><span class="line">local.sin_addr.s_addr = _ip.<span class="built_in">empty</span>() ? <span class="built_in">htonl</span>(INADDR_ANY) : <span class="built_in">inet_addr</span>(_ip.<span class="built_in">c_str</span>());</span><br></pre></td></tr></table></figure><h2 id="2-3-bind"><a href="#2-3-bind" class="headerlink" title="2.3 bind"></a>2.3 bind</h2><p>ä¹Ÿæ˜¯ä¸€æ ·ï¼Œç»‘å®šæœåŠ¡å™¨çš„ipå’Œç«¯å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.2 ç»‘å®šipç«¯å£</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">bind</span>(_listenSock,(<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)&amp;local, <span class="built_in">sizeof</span>(local)) == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">logging</span>(FATAL, <span class="string">&quot;bind: %s:%d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">logging</span>(DEBUG,<span class="string">&quot;socket bind success: %d&quot;</span>, _listenSock);</span><br></pre></td></tr></table></figure><h2 id="2-4-ç›‘å¬listen"><a href="#2-4-ç›‘å¬listen" class="headerlink" title="2.4 ç›‘å¬listen"></a>2.4 ç›‘å¬listen</h2><p>å¯¹äºtcpæœåŠ¡å™¨æ¥è¯´ï¼Œæˆå‘˜å˜é‡çš„<code>_listenSock</code>æ˜¯ç”¨æ¥ç›‘å¬çš„ï¼Œå³æ‰¾ä¸ªè€å“¥ä¸€ç›´ç›¯ç€äº‘æœåŠ¡å™¨çš„è¿™ä¸ªç«¯å£ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰éœ€è¦è¿æ¥å®ƒçš„å®¢æˆ·ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„<code>_listenSock</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºé™åˆ¶åœ¨é˜»å¡ç­‰å¾…è¿æ¥çš„æ•°é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The backlog argument defines the maximum length to which the queue of pending connections for sockfd may grow.   If  a connection  request arrives when the queue is full, the client may receive an error with an indication of ECONNREFUSED or, if the underlying protocol supports retransmission, the request may be ignored so that a later reattempt  at  conâ€nection succeeds.</span><br></pre></td></tr></table></figure><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œ<code>backlog</code>å‚æ•°é™åˆ¶äº†èƒ½è¢«é˜»å¡ç­‰å¾…è¿æ¥çš„æ•°é‡ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ª<code>ECONNREFUSED</code>é”™è¯¯ã€‚äº¦æˆ–è€…å¦‚æœåè®®æ”¯æŒé‡ä¼ ï¼Œå¤šä½™çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥ï¼Œåç»­å¯ä»¥é‡ä¼ </p><p>manæ‰‹å†Œä¸‹é¢çš„notesè¿˜æœ‰æ›´å¤šè§£é‡Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The behavior of the backlog argument on TCP sockets changed with Linux 2.2.  Now it specifies  the  queue  length  for completely  established  sockets waiting to be accepted, instead of the number of incomplete connection requests.  The maximum length of the queue for incomplete sockets can be set using /proc/sys/net/ipv4/tcp_max_syn_backlog.  When synâ€cookies are enabled there is no logical maximum length and this setting is ignored.  See tcp(7) for more information.</span><br><span class="line"></span><br><span class="line"> If  the  backlog  argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently truncated to that value; the default value in this file is 128.  In kernels before 2.4.25, this  limit  was  a  hard  coded  value,SOMAXCONN, with the value 128.</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>backlog</code>å‚æ•°é«˜äº<code>/proc/sys/net/core/somaxconn</code>ä¸­çš„é»˜è®¤å€¼128ï¼Œåˆ™ä¼šè¢«æˆªæ–­ä¸º128</p><hr><p>åœ¨æˆ‘ä»¬è¿™é‡Œï¼Œå°†å…¶è®¾ç½®ä¸º5å³å¯ï¼Œåæ­£ä¹Ÿæ˜¯åšæµ‹è¯•å˜›ï¼Œé—®é¢˜ä¸å¤§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.ç›‘å¬</span></span><br><span class="line"><span class="comment">// tcpæœåŠ¡å™¨æ˜¯éœ€è¦è¿æ¥çš„ï¼Œè¿æ¥ä¹‹å‰è¦å…ˆç›‘å¬æœ‰æ²¡æœ‰äººæ¥è¿</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">listen</span>(_listenSock, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">logging</span>(FATAL, <span class="string">&quot;listen: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">exit</span>(LISTEN_ERR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">logging</span>(DEBUG, <span class="string">&quot;listen: %s, %d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br></pre></td></tr></table></figure><h1 id="3-è¿è¡Œ"><a href="#3-è¿è¡Œ" class="headerlink" title="3.è¿è¡Œ"></a>3.è¿è¡Œ</h1><p>åˆå§‹åŒ–åˆ°è¿™å°±å®Œæ¯•äº†ï¼Œä¸‹é¢å°±æ˜¯å¼€è·‘äº†</p><h2 id="3-1-accept"><a href="#3-1-accept" class="headerlink" title="3.1 accept"></a>3.1 accept</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¥å£çš„ä½œç”¨å°±ç›¸å½“äºtcpä¸­çš„<code>recevefrom</code>ï¼Œä¼ å‚æ˜¯å®Œå…¨ç›¸åŒçš„ï¼›ä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå…¨æ–°çš„<code>sockfd</code></p><ul><li>tcpéœ€è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é“¾æ¥</li><li>é“¾æ¥éœ€è¦ç”¨socket fd æ¥ç®¡ç†</li><li>æ‰€ä»¥acceptå¿…é¡»è¿”å›æ–°çš„socket fdï¼Œè®©æœåŠ¡ç«¯æœ‰åŠæ³•ç®¡ç†æ–°çš„é“¾æ¥å’Œå·²æœ‰é“¾æ¥</li><li>åŸæœ‰çš„socket fdä¸å—å½±å“</li><li>å¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯æ¥è¿æ¥ï¼Œè¿›ç¨‹ä¼šåœ¨acceptå†…é˜»å¡ç­‰å¾…</li></ul><p>ä¸‹ä¸ºmanæ‰‹å†Œä¸­çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The  accept()  system  call  is  used  with connection-based socket types (SOCK_STREAM, SOCK_SEQPACKET).  It extracts the first connection request on the queue of pending connections for the listening socket, sockfd, creates a new connected  socket,  and  returns  a  new  file descriptor referring to that socket.  The newly created socket is not in the listening state.  The original socket sockfd is unaffected by this call.</span><br></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼ŒtcpæœåŠ¡å™¨è‡ªèº«çš„socket fdåªä¼šç”¨æ¥ç›‘å¬ç«¯å£ä¸Šæœ‰æ²¡æœ‰æ¶ˆæ¯ï¼Œå½“ç›‘å¬åˆ°æœ‰æ¶ˆæ¯å¹¶é€šè¿‡<code>accept</code>å»ºç«‹è¿æ¥åï¼Œå°±ä¼šè®©å¦å¤–ä¸€ä½æœåŠ¡å‘˜æ¥å¯¹è¿™ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peer;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(peer);</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥</span></span><br><span class="line">    <span class="type">int</span> conet = <span class="built_in">accept</span>(_listenSock,(<span class="keyword">struct</span> sockaddr*)&amp;peer,&amp;len);</span><br><span class="line">    <span class="keyword">if</span>(conet&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">logging</span>(FATAL, <span class="string">&quot;accept: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="built_in">exit</span>(CONN_ERR);<span class="comment">//è¿æ¥é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ã€‚ã€‚ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œlençš„å‚æ•°æ˜¯<code>socklen_t</code>ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´å½¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">__socklen_t</span> <span class="type">socklen_t</span>;</span><br><span class="line">__STD_TYPE __U32_TYPE <span class="type">__socklen_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __U32_TYPE		unsigned int</span></span><br></pre></td></tr></table></figure><h2 id="3-2-è·å–è¿æ¥ä¿¡æ¯"><a href="#3-2-è·å–è¿æ¥ä¿¡æ¯" class="headerlink" title="3.2 è·å–è¿æ¥ä¿¡æ¯"></a>3.2 è·å–è¿æ¥ä¿¡æ¯</h2><p>è¿™éƒ¨åˆ†å’Œudpæ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œé€šè¿‡acceptè¿”å›çš„socket fdï¼Œè·å–ç”¨æˆ·çš„ipå’Œç«¯å£è€¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è¿æ¥ä¿¡æ¯</span></span><br><span class="line">string senderIP = <span class="built_in">inet_ntoa</span>(peer.sin_addr);<span class="comment">// æ¥æºip</span></span><br><span class="line"><span class="type">uint16_t</span> senderPort = <span class="built_in">ntohs</span>(peer.sin_port); <span class="comment">// æ¥æºç«¯å£</span></span><br><span class="line"><span class="built_in">logging</span>(DEBUG, <span class="string">&quot;accept: %s | %s[%d], socket fd: %d&quot;</span>, <span class="built_in">strerror</span>(errno), senderIP.<span class="built_in">c_str</span>(), senderPort, conet);</span><br></pre></td></tr></table></figure><p>å…¶å®åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡ŒæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•äº†ã€‚å› ä¸ºtcpçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†™å®¢æˆ·ç«¯ï¼Œç›´æ¥ç”¨æµè§ˆå™¨å°±èƒ½è¿ä¸ŠæœåŠ¡ç«¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å‚æ•°åªæœ‰ä¸¤ä¸ªï¼ˆç«¯å£/ipï¼‰æ‰€ä»¥å‚æ•°ä¸ªæ•°åº”è¯¥æ˜¯2-3</span></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span> &amp;&amp; argc!=<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; port [ip]&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    string ip;</span><br><span class="line">    <span class="comment">// 3ä¸ªå‚æ•°ï¼Œæœ‰ip</span></span><br><span class="line">    <span class="keyword">if</span>(argc==<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ip = argv[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TcpServer <span class="title">t</span><span class="params">(atoi(argv[<span class="number">1</span>]),ip)</span></span>;</span><br><span class="line">    t.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆç¼–è¯‘åæ‰§è¡Œä»£ç ï¼Œè®©tcpæœåŠ¡å™¨è¿è¡Œèµ·æ¥</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e198bcc215e.png" alt="image-20230207081805916"></p><p>éšååœ¨æµè§ˆå™¨çš„åœ°å€æ è¾“å…¥<code>å…¬ç½‘ip:ç«¯å£</code>ï¼ˆå…ˆè¦å¼€å¯é˜²ç«å¢™å†…çš„ç«¯å£ï¼‰</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e198b144512.png" alt="image-20230207081754768"></p><p>æ­¤æ—¶ä¼šå‘ç°ä»€ä¹ˆéƒ½åŠ è½½ä¸å‡ºæ¥ï¼Œè¿™æ˜¯å¯¹çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å†™å‰ç«¯ï¼Œä¹Ÿæ²¡æœ‰æä¾›ä»»ä½•æœåŠ¡ã€‚ä½†æ˜¯æ¥åˆ°åå°ï¼Œå¯ä»¥çœ‹åˆ°å‡ºç°äº†ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå¹¶æ˜¾ç¤ºå‡ºäº†ip+ç«¯å£</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e19990d9e97.png" alt="image-20230207082138291"></p><h2 id="3-3-æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰"><a href="#3-3-æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰" class="headerlink" title="3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰"></a>3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰</h2><p>æ¥ä¸‹æ¥è¦åšçš„ï¼Œå°±æ˜¯å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡äº†ï¼Œè¿™é‡Œæˆ‘å†™çš„æ˜¯å­—ç¬¦ä¸²è½¬ASCIIç ï¼Œä¼šå°†å‘å‡ºå»çš„å­—ç¬¦ä¸²çš„asciiç åŠ åŠ èµ·æ¥åè¿”å›</p><h3 id="3-3-1-é—®é¢˜1-å¦‚ä½•é€šä¿¡"><a href="#3-3-1-é—®é¢˜1-å¦‚ä½•é€šä¿¡" class="headerlink" title="3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡"></a>3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡</h3><p>æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼ŒtcpæœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨recevefromå’Œsendtoï¼Œé‚£ä¹ˆè·å–åˆ°socketä¹‹åè¦æ€ä¹ˆè¿›è¡Œé€šä¿¡å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>ç”¨linuxçš„æ–‡ä»¶è¯»å†™æ¥å£</strong>ï¼Œreadå’Œwriteã€‚åˆ«å¿˜äº†ï¼Œsocket fdæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªlinuxä¸‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼</p><h3 id="3-3-2-é—®é¢˜2-å¤šå®¢æˆ·ç«¯"><a href="#3-3-2-é—®é¢˜2-å¤šå®¢æˆ·ç«¯" class="headerlink" title="3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯"></a>3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯</h3><p>tcpæœåŠ¡å™¨è¦æƒ³ç»™å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œå°±å¿…é¡»é‡‡ç”¨å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹çš„æ–¹å¼æ¥å®ç°æ“ä½œã€‚å¦åˆ™ä¼šå‡ºç°ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼ŒæœåŠ¡ç«¯å› ä¸ºæä¾›æœåŠ¡è€Œæ²¡æœ‰<code>accept</code>ï¼Œæ— æ³•é“¾æ¥ä¸Šä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//accept è·å–åˆ°é“¾æ¥ä¸Šçš„å®¢æˆ·ç«¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//å¦‚æœåœ¨è¿™é‡Œæä¾›æœåŠ¡ï¼Œåˆ™ä¼šå…¶ä»–è¿æ¥ä¼šåœ¨listené‡Œé¢é˜»å¡</span></span><br><span class="line">    	<span class="comment">//åªæœ‰å½“å‰æœåŠ¡ç»ˆæ­¢äº†ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„å…¶ä¸­ä¹‹ä¸€æ‰èƒ½è¿ä¸ŠæœåŠ¡å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-3-é—®é¢˜3-çº¿ç¨‹ä¼ å‚"><a href="#3-3-3-é—®é¢˜3-çº¿ç¨‹ä¼ å‚" class="headerlink" title="3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚"></a>3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚</h3><p>æ—¢ç„¶éœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹æœåŠ¡ï¼Œé‚£å°±éœ€è¦è®¾å®šå¥½ç»™çº¿ç¨‹ä¼ çš„å‚æ•°ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥acceptçš„è¿”å›å€¼<code>socket fd</code>å³å¯è¿›è¡Œ<code>read/write</code></p><p>ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰“å°debugæ¶ˆæ¯ï¼Œè¦çŸ¥é“å½“å‰æ˜¯è°å‘ä½ å‘é€äº†è¿™æ¡æ¶ˆæ¯ï¼Œipå’Œç«¯å£æ˜¯ä»€ä¹ˆã€‚</p><p>ä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œè¿™é‡Œå°è£…ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†socket fdï¼Œå®¢æˆ·ç«¯çš„ip+ç«¯å£å°è£…æˆä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ å‚ï¼ˆ<strong>çº¿ç¨‹çš„å‡½æ•°åªèƒ½ä¼ å…¥ä¸€ä¸ªå‚æ•°</strong>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ClientData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> _fd;</span><br><span class="line">    <span class="type">uint16_t</span> _port;</span><br><span class="line">    <span class="built_in">string</span> _ip;</span><br><span class="line">    TcpServer* _this;</span><br><span class="line"></span><br><span class="line">    ClientData(<span class="type">int</span> fd,<span class="type">uint16_t</span> port,<span class="type">const</span> <span class="built_in">string</span>&amp; ip,TcpServer* this1)</span><br><span class="line">        :_fd(fd),_port(port), _ip(ip),_this(this1)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½ä¼šæƒ³åˆ°å¦å¤–ä¸€ä¸ªåŠæ³•ï¼Œé‚£å°±æ˜¯åœ¨tcpæœåŠ¡å™¨çš„classä¸­æ–°å¢ä¸€ä¸ªmapæˆå‘˜å˜é‡ï¼Œç”¨äºæ˜ å°„socket fdå’Œå®¢æˆ·ç«¯ä¿¡æ¯çš„é”®å€¼å¯¹ï¼Œä½†æ˜¯è¿™æ— æ³•å®ç°ã€‚</p><p>å› ä¸ºåœ¨ç±»ä¸­è®¾è®¡çš„å¤šçº¿ç¨‹å‡½æ•°ï¼Œä¸ºäº†å»æ‰é»˜è®¤ä¼ å…¥çš„<code>this</code>æŒ‡é’ˆï¼Œå¿…é¡»è¦è®¾ç½®æˆ<code>static</code>é™æ€çš„ï¼Œæ­¤æ—¶è¯¥é™æ€å‡½æ•°<strong>æ— æ³•è®¿é—®</strong>ç±»å†…æˆå‘˜ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å› ä¸ºéœ€è¦å–æ¶ˆthisæŒ‡é’ˆï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®æˆé™æ€çš„</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">threadRoutine</span><span class="params">(<span class="type">void</span>*args)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>()); <span class="comment">//è®¾ç½®çº¿ç¨‹åˆ†ç¦»</span></span><br><span class="line">    ClientData* data=(ClientData*)args;</span><br><span class="line">    <span class="comment">// é€šè¿‡é¢„å…ˆè®¾ç½®çš„thisæŒ‡é’ˆæ¥è®¿é—®ç±»å†…æˆå‘˜ï¼Œå¹¶è¿›è¡Œä¼ å‚</span></span><br><span class="line">    data-&gt;_this-&gt;<span class="built_in">transService</span>(data-&gt;_fd,data-&gt;_ip,data-&gt;_port);</span><br><span class="line">    <span class="keyword">delete</span> data;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-4-æœåŠ¡ä»£ç "><a href="#3-3-4-æœåŠ¡ä»£ç " class="headerlink" title="3.3.4 æœåŠ¡ä»£ç "></a>3.3.4 æœåŠ¡ä»£ç </h3><p>è§£å†³äº†ä¸Šé¢çš„é—®é¢˜ï¼Œå°±å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹çœ‹æœåŠ¡ç«¯çš„ä»£ç äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›æœåŠ¡</span></span><br><span class="line"><span class="type">pthread_t</span> service;</span><br><span class="line"><span class="comment">// å› ä¸ºè¿™ä¸ªæˆå‘˜ä½¿ç”¨èŒƒå›´æå°ï¼Œæ‰€ä»¥é‡‡ç”¨new/deleteï¼Œé¿å…å ç”¨å¤ªå¤šç©ºé—´</span></span><br><span class="line">ClientData* data = <span class="keyword">new</span> <span class="built_in">ClientData</span>(conet,senderPort,senderIP,<span class="keyword">this</span>);</span><br><span class="line"><span class="built_in">pthread_create</span>(&amp;service,<span class="literal">nullptr</span>,threadRoutine,(<span class="type">void</span>*)data);</span><br></pre></td></tr></table></figure><p>åœ¨acceptä¹‹åï¼Œé€šè¿‡çº¿ç¨‹æ“ä½œç”¨çº¿ç¨‹æ¥æä¾›æœåŠ¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">threadRoutine</span><span class="params">(<span class="type">void</span>*args)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>()); <span class="comment">//è®¾ç½®çº¿ç¨‹åˆ†ç¦»</span></span><br><span class="line">    ClientData* data=(ClientData*)args;</span><br><span class="line">    <span class="comment">// é€šè¿‡é¢„å…ˆè®¾ç½®çš„thisæŒ‡é’ˆæ¥è®¿é—®ç±»å†…æˆå‘˜ï¼Œå¹¶è¿›è¡Œä¼ å‚</span></span><br><span class="line">    data-&gt;_this-&gt;<span class="built_in">transService</span>(data-&gt;_fd,data-&gt;_ip,data-&gt;_port);</span><br><span class="line">    <span class="keyword">delete</span> data;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>threadRoutine</code>çš„ä½œç”¨å°±æ˜¯æŠŠçº¿ç¨‹çš„å•å‚æ•°è½¬ä¸ºå¤šå‚æ•°ï¼Œä¼ ç»™çœŸæ­£ç”¨æ¥æœåŠ¡çš„å‡½æ•°ã€‚å‡½æ•°çš„æ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯Linuxä¸‹æ–‡ä»¶æ“ä½œçš„è¯»å†™ã€‚</p><p>è¯»å†™æˆåŠŸåï¼Œå°†å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯è½¬æˆASCIIç çš„å’Œå‘å›ç»™å®¢æˆ·ç«¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">transService</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> string &amp;clientIp, <span class="type">uint16_t</span> clientPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(sockfd &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">assert</span>(!clientIp.<span class="built_in">empty</span>());</span><br><span class="line">    <span class="built_in">assert</span>(clientPort&gt;<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// å¼€å§‹æœåŠ¡</span></span><br><span class="line">    <span class="type">char</span> buf[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è¯»å–å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯,sæ˜¯è¯»å–åˆ°çš„å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">read</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf)<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span>(s&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buf[s]=<span class="string">&#x27;\0&#x27;</span>;<span class="comment">//æ‰‹åŠ¨æ·»åŠ å­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(buf,<span class="string">&quot;quit&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">            &#123;<span class="comment">//å®¢æˆ·ç«¯ä¸»åŠ¨é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æœåŠ¡</span></span><br><span class="line">            string tmp = buf;</span><br><span class="line">            <span class="type">int</span> ret = <span class="built_in">str2ascii</span>(tmp);<span class="comment">//è·å–å­—ç¬¦ä¸²çš„asciiæ€»å’Œ</span></span><br><span class="line">            cout &lt;&lt; ret &lt;&lt; endl;</span><br><span class="line">            string retS =  <span class="built_in">to_string</span>(ret);<span class="comment">//è½¬å­—ç¬¦ä¸²</span></span><br><span class="line">            cout &lt;&lt; retS &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">write</span>(sockfd,retS.<span class="built_in">c_str</span>(),retS.<span class="built_in">size</span>());<span class="comment">//å†™å…¥</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">0</span>)</span><br><span class="line">        &#123;<span class="comment">//s == 0ä»£è¡¨å¯¹æ–¹å…³é—­,å®¢æˆ·ç«¯é€€å‡º</span></span><br><span class="line">            <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;client quit: %s[%d]&quot;</span>, clientIp.<span class="built_in">c_str</span>(), clientPort);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;read err: %s[%d] -  %s&quot;</span>, clientIp.<span class="built_in">c_str</span>(), clientPort, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">    <span class="built_in">logging</span>(DEBUG,<span class="string">&quot;server quit %d&quot;</span>,sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æœåŠ¡å‡½æ•°å¯ä»¥ä¸æš´éœ²</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">str2ascii</span><span class="params">(<span class="type">const</span> string&amp; str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> e:str)</span><br><span class="line">        &#123;</span><br><span class="line">            ret += e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="3-4-æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰"><a href="#3-4-æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰" class="headerlink" title="3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰"></a>3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰</h2><p>ä¸Šé¢çš„ä»£ç é‡‡ç”¨çš„æ˜¯çº¿ç¨‹æ¥æä¾›æœåŠ¡ï¼Œé™¤äº†çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿˜æœ‰çˆ¶å­è¿›ç¨‹çš„æ–¹å¼ï¼Œä¹Ÿèƒ½é¿å…é˜»å¡</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œçˆ¶å­è¿›ç¨‹éƒ½éœ€è¦å…³é—­æ‰å¯¹æ–¹ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…å‡ºç°æ–‡ä»¶æè¿°ç¬¦åœ¨æœåŠ¡ç»“æŸåè¿˜æ²¡æœ‰å…³é—­çš„æƒ…å†µ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pid_t</span> id = fork();</span><br><span class="line"><span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>(_listenSock);<span class="comment">//å› ä¸ºå­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬ï¼Œæ‰€ä»¥å…³é—­æ‰ç›‘å¬socket</span></span><br><span class="line">    <span class="comment">//å­è¿›ç¨‹</span></span><br><span class="line">    <span class="built_in">transService</span>(conet, senderIP, senderPort);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);<span class="comment">// æœåŠ¡ç»“æŸåï¼Œé€€å‡ºï¼Œå­è¿›ç¨‹ä¼šè¿›å…¥åƒµå°¸çŠ¶æ€ç­‰å¾…çˆ¶è¿›ç¨‹å›æ”¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">close</span>(conet); <span class="comment">// å› ä¸ºæ­¤æ—¶æ˜¯å­è¿›ç¨‹æä¾›æœåŠ¡ï¼Œconetä¼šæœ‰æ‹·è´ï¼Œç›¸å½“äºæœ‰ä¸¤ä¸ªè¿›ç¨‹æ‰“å¼€äº†è¯¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment">// å¦‚æœçˆ¶è¿›ç¨‹ä¸å…³é—­ï¼Œå³ä¾¿å­è¿›ç¨‹ç»“æŸæœåŠ¡äº†ï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦ä¹Ÿä¼šä¿æŒå¼€å¯</span></span><br><span class="line"><span class="type">pid_t</span> ret = <span class="built_in">waitpid</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿™æ ·å†™æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯çˆ¶è¿›ç¨‹æ²¡æœ‰åŠæ³•æ­£å¸¸é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æº</p><ul><li>å¦‚æœè¿›è¡Œé˜»å¡ç­‰å¾…ï¼Œé‚£å°±è¿èƒŒäº†åˆè¡·ï¼Œå®Œå…¨æ²¡æœ‰æ„ä¹‰</li><li>å¦‚æœè¿›è¡Œéé˜»å¡ç­‰å¾…ï¼Œåœ¨<code>waitpid</code>ç»“æŸä¹‹åï¼Œçˆ¶è¿›ç¨‹ç›´æ¥å»å¹²å…¶ä»–äº‹äº†ï¼Œå®Œå…¨å¿˜è®°äº†è¿™é‡Œçš„è¿™ä¸ªå­è¿›ç¨‹</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯åœ¨å­è¿›ç¨‹é€€å‡ºï¼Œå‘<strong>çˆ¶è¿›ç¨‹å‘é€ä¿¡å·</strong>çš„æ—¶å€™å›æ”¶å­è¿›ç¨‹</p><h3 id="3-4-1-ä¿¡å·å›æ”¶å­è¿›ç¨‹"><a href="#3-4-1-ä¿¡å·å›æ”¶å­è¿›ç¨‹" class="headerlink" title="3.4.1 ä¿¡å·å›æ”¶å­è¿›ç¨‹"></a>3.4.1 ä¿¡å·å›æ”¶å­è¿›ç¨‹</h3><p>é€šè¿‡è‡ªå®šä¹‰æ•æ‰ç³»ç»Ÿä¿¡å·ï¼Œæ¥å›æ”¶å­è¿›ç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGCHLD, FreeChild);<span class="comment">//è‡ªå®šä¹‰æ•æ‰</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›æ”¶å­è¿›ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FreeChild</span><span class="params">(<span class="type">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(signo == SIGCHLD);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰å­è¿›ç¨‹äº†ï¼Œwaitpidå°±ä¼šè°ƒç”¨å¤±è´¥</span></span><br><span class="line">        <span class="type">pid_t</span> id = <span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">nullptr</span>, WNOHANG); <span class="comment">// éé˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹ç­‰å¾…æˆåŠŸ, child pid: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//è¿˜æœ‰å­è¿›ç¨‹æ²¡æœ‰é€€å‡º</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;å°šæœ‰æœªé€€å‡ºçš„å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">//é€€å‡ºç­‰å¾…å­è¿›ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸ&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†è‡ªå®šä¹‰æ•æ‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®æˆignoreä¸æ­ç†å­è¿›ç¨‹ï¼Œè¿™æ ·å­è¿›ç¨‹é€€å‡ºçš„æ—¶å€™å°±ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGCHLD, SIG_IGN);</span><br></pre></td></tr></table></figure><h3 id="3-4-2-çˆ·çˆ·è¿›ç¨‹"><a href="#3-4-2-çˆ·çˆ·è¿›ç¨‹" class="headerlink" title="3.4.2 çˆ·çˆ·è¿›ç¨‹"></a>3.4.2 çˆ·çˆ·è¿›ç¨‹</h3><p>è¿™é‡Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªéªšæ“ä½œï¼Œé‚£å°±æ˜¯åœ¨åˆ›å»ºå­è¿›ç¨‹ä¹‹åï¼Œå†åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›æœåŠ¡ï¼ˆå­™å­è¿›ç¨‹ï¼‰-2</span></span><br><span class="line"><span class="type">pid_t</span> id = fork();</span><br><span class="line"><span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>(_listenSock);<span class="comment">//å› ä¸ºå­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬ï¼Œæ‰€ä»¥å…³é—­æ‰ç›‘å¬socket</span></span><br><span class="line">    <span class="comment">//åˆåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¤§äº0ä»£è¡¨æ˜¯çˆ¶è¿›ç¨‹ï¼Œå³åˆ›å»ºå®Œå­è¿›ç¨‹åçˆ¶è¿›ç¨‹ç›´æ¥é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(fork()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­™å­è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    <span class="built_in">transService</span>(conet, senderIP, senderPort);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);<span class="comment">// æœåŠ¡ç»“æŸåï¼Œé€€å‡ºï¼Œå­è¿›ç¨‹ä¼šè¿›å…¥åƒµå°¸çŠ¶æ€ç­‰å¾…çˆ¶è¿›ç¨‹å›æ”¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ·çˆ·è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">close</span>(conet); </span><br><span class="line"><span class="type">pid_t</span> ret = <span class="built_in">waitpid</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>); <span class="comment">//æ­¤æ—¶å°±å¯ä»¥ç›´æ¥ç”¨é˜»å¡å¼ç­‰å¾…äº†</span></span><br><span class="line"><span class="built_in">assert</span>(ret &gt; <span class="number">0</span>);<span class="comment">//retå¦‚æœä¸å¤§äº0ï¼Œåˆ™ä»£è¡¨ç­‰å¾…å‘ç”Ÿäº†é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>é‡‡ç”¨è¿™ç§åŠæ³•ä»¥åï¼Œç”±äºçˆ¶è¿›ç¨‹é€€å‡ºäº†ï¼Œ<strong>å­™å­è¿›ç¨‹ä¼šç›´æ¥è¢«æ“ä½œç³»ç»Ÿæ¥ç®¡</strong>ã€‚ä¸‹å›¾ä¸­èƒ½çœ‹åˆ°è¿™äº›è¿›ç¨‹çš„çˆ¶è¿›ç¨‹éƒ½æ˜¯<strong>1</strong>ï¼Œå³æ“ä½œç³»ç»Ÿã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ‹…å¿ƒå­è¿›ç¨‹çš„é‡Šæ”¾é—®é¢˜äº†</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e1c184403cd.png" alt="image-20230207111205871"></p><h1 id="4-å®¢æˆ·ç«¯"><a href="#4-å®¢æˆ·ç«¯" class="headerlink" title="4.å®¢æˆ·ç«¯"></a>4.å®¢æˆ·ç«¯</h1><p>å®¢æˆ·ç«¯éƒ¨åˆ†çš„ä»£ç å’Œudpä¹Ÿå¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡å°†sendtoæ”¹æˆäº†write</p><p>ä¸‹æ–¹æä¾›äº†å®¢æˆ·ç«¯çš„ä»£ç ï¼Œéƒ½å†™äº†æ³¨é‡ŠğŸ˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ./clientTcp serverIp serverPort</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>)<span class="comment">//å®¢æˆ·ç«¯å¿…é¡»è¦æœ‰3ä¸ªå‚æ•°</span></span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Usage:\n\t&quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; serverIp serverPort&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Example:\n\t&quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; 127.0.0.1 8080\n&quot;</span></span><br><span class="line">                &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(USAGE_ERR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è§£ææœåŠ¡ç«¯çš„ipå’Œç«¯å£</span></span><br><span class="line">    string serverIp = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> serverPort = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºtcpçš„socket SOCK_STREAM</span></span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(SOCKET_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. connectï¼Œå‘èµ·é“¾æ¥è¯·æ±‚ï¼Œä½ æƒ³è°å‘èµ·è¯·æ±‚å‘¢ï¼Ÿï¼Ÿå½“ç„¶æ˜¯å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚å–½</span></span><br><span class="line">    <span class="comment">// 2.1 å…ˆå¡«å……éœ€è¦è¿æ¥çš„è¿œç«¯ä¸»æœºçš„åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    server.sin_family = AF_INET;</span><br><span class="line">    server.sin_port = <span class="built_in">htons</span>(serverPort);</span><br><span class="line">    <span class="built_in">inet_aton</span>(serverIp.<span class="built_in">c_str</span>(), &amp;server.sin_addr);</span><br><span class="line">    <span class="comment">// 2.2 å‘èµ·è¯·æ±‚ï¼Œconnect ä¼šè‡ªåŠ¨bind</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(sock, (<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)&amp;server, <span class="built_in">sizeof</span>(server)) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(CONN_ERR);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;connect success: &quot;</span> &lt;&lt; sock &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯å‘ç°çš„æ¶ˆæ¯</span></span><br><span class="line">    string message;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        message.<span class="built_in">clear</span>();<span class="comment">//æ¯æ¬¡å¾ªç¯å¼€å§‹ï¼Œéƒ½æ¸…ç©ºä¸€ä¸‹msg</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯# &quot;</span>;</span><br><span class="line">        <span class="built_in">getline</span>(cin, message);<span class="comment">//è·å–è¾“å…¥</span></span><br><span class="line">        <span class="comment">// å¦‚æœå®¢æˆ·ç«¯è¾“å…¥äº†quitï¼Œåˆ™é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(message.<span class="built_in">c_str</span>(), <span class="string">&quot;quit&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">write</span>(sock, message.<span class="built_in">c_str</span>(), message.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>) <span class="comment">// å†™å…¥æˆåŠŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">            message.<span class="built_in">clear</span>();<span class="comment">//æ¸…ç©ºè¾“å…¥çš„æ¶ˆæ¯</span></span><br><span class="line">            message.<span class="built_in">resize</span>(BUFFER_SIZE);</span><br><span class="line">            <span class="comment">// å› ä¸ºstringçš„c_stræœ¬è´¨ä¸Šæ˜¯è¿”å›åœ°å€ï¼Œæ‰€ä»¥å¼ºè½¬åæ˜¯å¯ä»¥å¾€é‡Œé¢å†™å…¥çš„</span></span><br><span class="line">            s = <span class="built_in">read</span>(sock, (<span class="type">char</span> *)(message.<span class="built_in">c_str</span>()), BUFFER_SIZE);<span class="comment">// è·å–æœåŠ¡ç«¯çš„ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (s &gt; <span class="number">0</span>)<span class="comment">// è¯»å–æˆåŠŸ</span></span><br><span class="line">            &#123;</span><br><span class="line">                message[s] = <span class="string">&#x27;\0&#x27;</span>;<span class="comment">//è¿½åŠ \0</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ‰“å°è¿”å›å€¼</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Server Echo# &quot;</span> &lt;&lt; message &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s &lt;= <span class="number">0</span>) <span class="comment">// å†™å…¥å¤±è´¥</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="built_in">close</span>(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-1-è¿è¡Œæµ‹è¯•"><a href="#4-1-è¿è¡Œæµ‹è¯•" class="headerlink" title="4.1 è¿è¡Œæµ‹è¯•"></a>4.1 è¿è¡Œæµ‹è¯•</h2><p>å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œå†è¿è¡Œå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¾“å…¥åï¼ŒæœåŠ¡çŸ­ä¼šè¿”å›å­—ç¬¦ä¸²çš„asciiç æ€»å’Œ</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e1aff8cb944.png" alt="image-20230207095713615"></p><p>è€Œå®¢æˆ·ç«¯è¾“å…¥quitåï¼Œåœ¨æœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯é€€å‡ºï¼Œä½†æœåŠ¡ç«¯å¹¶æ²¡æœ‰æ¨å‡ºï¼Œæ­£åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e1b0576b69f.png" alt="image-20230207095848863"></p><h1 id="5-çº¿ç¨‹æ± "><a href="#5-çº¿ç¨‹æ± " class="headerlink" title="5.çº¿ç¨‹æ± "></a>5.çº¿ç¨‹æ± </h1><p>åœ¨ä¸Šé¢çš„æ“ä½œä¸­ï¼Œæ¯æ¬¡æä¾›æœåŠ¡éƒ½éœ€è¦å½“åœºæ–°å»ºä¸€ä¸ªçº¿ç¨‹ã€‚å¯¹äºtcpè¿™ç§è¦æ±‚é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨è€Œè¨€ï¼Œå…¶å®æ˜¯ä¸å¤ªåˆé€‚çš„ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›è¶Šæ—©ç»™å®¢æˆ·å»ºç«‹è”ç³»è¶Šå¥½ï¼Œè€Œä¸æ˜¯é£Ÿå®¢éƒ½æ¥äº†è€æ¿æ‰å»ä¹°èœã€‚</p><p>è¿™æ—¶å€™ï¼Œå°±å¯ä»¥æŠŠæˆ‘ä»¬å†™çš„<a href="https://blog.musnow.top/posts/1969264863/">çº¿ç¨‹æ± </a>å’ŒtcpæœåŠ¡å™¨ç»™è”ç³»èµ·æ¥ï¼</p><blockquote><p>çº¿ç¨‹æ± çš„ä»£ç è§æˆ‘çš„<a target="_blank" rel="noopener" href="https://gitee.com/musnow/raspberry-practice/tree/master/code/">gitee</a>ï¼Œæ­¤å¤„åªè¯´æ˜taskç±»çš„ç¼–å†™</p></blockquote><h2 id="5-1-task"><a href="#5-1-task" class="headerlink" title="5.1 task"></a>5.1 task</h2><p>å…ˆå‰ç¼–å†™çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œå°†çº¿ç¨‹æ± è¦å¤„ç†çš„ä»»åŠ¡å†™æˆäº†ä¸€ä¸ªtaskç±»ï¼Œå¹¶è§„å®šæ‰€æœ‰taskç±»éƒ½éœ€è¦æä¾›ä¸€ä¸ª<code>()æ“ä½œç¬¦é‡è½½</code>ï¼Œå³ä»¿å‡½æ•°ã€‚è¿™æ ·çº¿ç¨‹æ± å°±å¯ä»¥ä¸€è§†åŒä»çš„å¤„ç†è¿™äº›å·¥ä½œï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ–°å¢çš„å·¥ä½œæ·»åŠ åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="type">callback_t</span> = std::function&lt;<span class="built_in">void</span> (<span class="type">int</span>, std::string, <span class="type">uint16_t</span>)&gt;;<span class="comment">//ç›¸å½“äºtypedef</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Task</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// å°†éœ€è¦è°ƒç”¨çš„å‡½æ•°ä¼ å…¥ï¼Œç›¸å½“äºé€šç”¨</span></span><br><span class="line">    <span class="built_in">Task</span>(<span class="type">int</span> sockfd, <span class="type">const</span> std::string &amp;clientIP, <span class="type">uint16_t</span> clientPort,<span class="type">callback_t</span> func)</span><br><span class="line">        : _sockfd(sockfd), _ip(clientIP), _port(clientPort),_func(func)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»¿å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;TID[%p] = %s:%d START&quot;</span>,\</span><br><span class="line">            <span class="built_in">pthread_self</span>(), _ip.<span class="built_in">c_str</span>(), _port);</span><br><span class="line"></span><br><span class="line">        _func(_sockfd, _ip, _port);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;TID[%p] = %s:%d END  &quot;</span>,\</span><br><span class="line">            <span class="built_in">pthread_self</span>(), _ip.<span class="built_in">c_str</span>(), _port);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _sockfd;</span><br><span class="line">    std::string _ip;</span><br><span class="line">    <span class="type">uint16_t</span> _port;</span><br><span class="line">    <span class="type">callback_t</span> _func;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œï¼Œæˆ‘åˆå°†taské˜Ÿåˆ—ç»™å°è£…æˆäº†ä¸€ä¸ªå¯ä»¥æ¥æ”¶å‡½æ•°æŒ‡é’ˆçš„æ–¹å¼ã€‚è¿™æ ·ä¸€æ¥ï¼Œåªè¦æˆ‘ä»¬ä»»åŠ¡çš„å‡½æ•°å‚æ•°ä¸º<code>(SOCKET,IP,PROT)</code>ï¼Œå°±èƒ½ä¼ å…¥ç»™è¿™ä¸ªtaskç±»ï¼Œè®©çº¿ç¨‹æ± æ¥è¿è¡Œ</p><h2 id="5-2-tcpServerçš„å¤„ç†"><a href="#5-2-tcpServerçš„å¤„ç†" class="headerlink" title="5.2 tcpServerçš„å¤„ç†"></a>5.2 tcpServerçš„å¤„ç†</h2><p>å› ä¸ºéœ€è¦çº¿ç¨‹æ± ï¼Œæˆ‘ä»¬åœ¨tcpserverä¸­æ·»åŠ ä¸€ä¸ªçº¿ç¨‹æ± çš„æŒ‡é’ˆï¼Œé€šè¿‡çº¿ç¨‹æ± çš„ç±»åæ¥è·å–å•ä¾‹ï¼Œèµ‹å€¼ç»™æˆå‘˜å˜é‡ã€‚å¹¶è®©è·å–åˆ°çš„å•ä¾‹çº¿ç¨‹æ± å¼€å§‹è¿è¡Œ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.è·å–çº¿ç¨‹æ±  å•ä¾‹</span></span><br><span class="line">_tpool = ThreadPool&lt;Task&gt;::<span class="built_in">getInstance</span>(<span class="number">4</span>);</span><br><span class="line">_tpool-&gt;<span class="built_in">start</span>();<span class="comment">//å¼€å§‹è¿è¡Œ</span></span><br></pre></td></tr></table></figure><p>åœ¨<code>start</code>å‡½æ•°ä¸­ï¼Œåˆ™å°†ä¹‹å‰çš„ä»»åŠ¡å‡½æ•°å®ä¾‹åŒ–ä¸ºä¸€ä¸ªtaskï¼Œå¹¶å°†å…¶pushåˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›æœåŠ¡ï¼ˆé€šè¿‡çº¿ç¨‹æ± ï¼‰</span></span><br><span class="line"><span class="function">Task <span class="title">t</span><span class="params">(conet,senderIP,senderPort,transService)</span></span>;</span><br><span class="line">_tpool-&gt;<span class="built_in">push</span>(t);</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå°±èƒ½é€šè¿‡çº¿ç¨‹æ± æ¥æä¾›æœåŠ¡äº†ï¼</p><h2 id="5-3-è¿è¡Œæµ‹è¯•"><a href="#5-3-è¿è¡Œæµ‹è¯•" class="headerlink" title="5.3 è¿è¡Œæµ‹è¯•"></a>5.3 è¿è¡Œæµ‹è¯•</h2><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ± æ­£ç¡®è¿è¡Œäº†ä»»åŠ¡ï¼Œç»™å®¢æˆ·ç«¯æä¾›äº†asciiè¿”å›å€¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e44fa8f139b.png" alt="image-20230209094304860"></p><p>ä½¿ç”¨<code>ps -aL</code>å‘½ä»¤æŸ¥çœ‹è½»é‡çº§è¿›ç¨‹ï¼Œå¯ä»¥çœ‹åˆ°æœ‰4ä¸ªçº¿ç¨‹åœ¨ä¸ºæˆ‘ä»¬æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> PID   LWP TTY          TIME CMD</span><br><span class="line">7288  7288 pts/8    00:00:00 tcpServer</span><br><span class="line">7288  7289 pts/8    00:00:00 handler</span><br><span class="line">7288  7290 pts/8    00:00:00 handler</span><br><span class="line">7288  7291 pts/8    00:00:00 handler</span><br><span class="line">7288  7292 pts/8    00:00:00 handler</span><br><span class="line">7441  7441 pts/9    00:00:00 tcpClient</span><br><span class="line">7632  7632 pts/7    00:00:00 ps</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œå³ä¾¿æˆ‘ä»¬å¤šå¼€å‡ ä¸ªç»ˆç«¯ï¼ŒtcpæœåŠ¡å™¨ä¹Ÿèƒ½æ­£å¸¸æä¾›æœåŠ¡</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e4507c8c76f.png" alt="image-20230209094632613"></p><p>ä½†æ˜¯ï¼å¦‚æœå‡ºç°äº†ä¸€ä¸ªå°´å°¬çš„æƒ…å†µï¼Œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹&lt;å½“å‰éœ€è¦è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><h2 id="5-4-taskç­‰å¾…é—®é¢˜"><a href="#5-4-taskç­‰å¾…é—®é¢˜" class="headerlink" title="5.4 taskç­‰å¾…é—®é¢˜"></a>5.4 taskç­‰å¾…é—®é¢˜</h2><p>ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬å°†çº¿ç¨‹æ± å•ä¾‹ä¸­çš„çº¿ç¨‹ä¸ªæ•°åˆå§‹åŒ–ä¸º2ä¸ª</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e450bd253f3.png" alt="image-20230209094741651"></p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å‘ç°ç¬¬ä¸‰ä¸ªå®¢æˆ·ç«¯ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œä½†å®é™…ä¸Šå®ƒå·²ç»æˆåŠŸé“¾æ¥ä¸Šäº†æœåŠ¡å™¨ï¼Œtaskä¹Ÿè¢«æ’å…¥åˆ°äº†ä»»åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œ<strong>åªä¸è¿‡å½“å‰æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹æ¥è¿è¡Œå®ƒ</strong></p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e451f2d5c8f.png" alt="image-20230209095249694"></p><p>å¦‚æœæˆ‘ä»¬æŠŠå·¦ä¾§å…¶ä¸­ä¸€ä¸ªå®¢æˆ·ç«¯é€€å‡ºï¼Œæœ€å³ä¾§çš„å®¢æˆ·ç«¯å°±èƒ½æ­£å¸¸æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ç»“æœäº†</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/63e452570e754.png" alt="image-20230209095429982"></p><p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦è®©çº¿ç¨‹æ± æœ‰èƒ½åŠ›åˆ¤æ–­æ˜¯å¦å‡ºç°äº†é˜»å¡é—®é¢˜ï¼Œå¹¶æ‰©å®¹çº¿ç¨‹æ¥è§£å†³é˜»å¡ã€‚</p><p>å¯æ˜¯è¿™åˆå¼•å‡ºäº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœç©ºé—²äº†å¾ˆä¹…éƒ½æ²¡æœ‰ä»»åŠ¡è¿‡æ¥ï¼Œå¤šå‡ºæ¥çš„çº¿ç¨‹ä¸å°±æ˜¯åœ¨ç™½ç™½æ¶ˆè€—èµ„æºå—ï¼Ÿ</p><p>å®é™…ä¸Šï¼Œçº¿ç¨‹æ± é€‚åˆå¤„ç†çš„ï¼Œåº”è¯¥æ˜¯<strong>çŸ­å°çš„ä»»åŠ¡</strong>ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª<code>while(1)</code>å¾ªç¯ï¼›</p><blockquote><p>ä½†æ˜¯æˆ‘è¿˜æ²¡æœ‰å­¦ä¹ åˆ°å¦‚ä½•å°†å…¶ä¿®æ”¹ä¸ºæœåŠ¡äºçŸ­å°ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œä»å¾…åç»­çš„ç²¾è¿›</p></blockquote></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">æ…•é›ªå¹´å</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/2171263616/">https://blog.musnow.top/posts/2171263616/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://blog.musnow.top" target="_blank">æ…•é›ªçš„å¯’èˆ</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/%E7%BA%BF%E7%A8%8B/">çº¿ç¨‹</a><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">è®¡ç®—æœºç½‘ç»œ</a></div><div class="post_share"><div class="social-share" data-image="/img/bg/gm10.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://ifdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.png" alt="çˆ±å‘ç”µ"></a><div class="post-qr-code-desc">çˆ±å‘ç”µ</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/834577958/" title="ã€C++ã€‘usingçš„ä¸‰ç§ç”¨æ³• | è½¬è½½"><img class="cover" src="/img/bg/gm8.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ã€C++ã€‘usingçš„ä¸‰ç§ç”¨æ³• | è½¬è½½</div></div></a></div><div class="next-post pull-right"><a href="/posts/3761902412/" title="ã€Pythonã€‘è‡ªåŠ¨è§£æmarkdownä¸­çš„å›¾ç‰‡å¹¶ä¿å­˜"><img class="cover" src="/img/bg/gm19.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ã€Pythonã€‘è‡ªåŠ¨è§£æmarkdownä¸­çš„å›¾ç‰‡å¹¶ä¿å­˜</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/368672249/" title="ã€Linuxã€‘æ¥å†™ä¸€ä¸ªudpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯"><img class="cover" src="/img/bg/gm12.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">ã€Linuxã€‘æ¥å†™ä¸€ä¸ªudpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯</div></div></a></div><div><a href="/posts/1969264863/" title="ã€Linuxã€‘çº¿ç¨‹å®ä¾‹ | ç®€å•çº¿ç¨‹æ± "><img class="cover" src="/img/bg/gm19.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-19</div><div class="title">ã€Linuxã€‘çº¿ç¨‹å®ä¾‹ | ç®€å•çº¿ç¨‹æ± </div></div></a></div><div><a href="/posts/822375107/" title="ã€Linuxã€‘æ—‹è½¬é” | è¯»å†™é”"><img class="cover" src="/img/bg/gm5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-20</div><div class="title">ã€Linuxã€‘æ—‹è½¬é” | è¯»å†™é”</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/favicon.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">æ…•é›ªå¹´å</div><div class="author-info__description">çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">414</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="ä¸ªäººä¸»é¡µ"><i class="fas fa-globe-asia"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="å¯¼èˆªç«™ç‚¹"><i class="fas fa-server"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss-square"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æ¬¢è¿æ¥åˆ°å¯’èˆ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="toc-text">1.åŸºæœ¬æ¡†æ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E7%B1%BB%E6%88%90%E5%91%98"><span class="toc-text">1.1 ç±»æˆå‘˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-text">1.2 å¤´æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">2.åˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%9E%84%E9%80%A0sock"><span class="toc-text">2.1 æ„é€ sock</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%9D%E5%A7%8B%E5%8C%96sockaddr-in"><span class="toc-text">2.2 åˆå§‹åŒ–sockaddr_in</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-bind"><span class="toc-text">2.3 bind</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E7%9B%91%E5%90%AClisten"><span class="toc-text">2.4 ç›‘å¬listen</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E8%BF%90%E8%A1%8C"><span class="toc-text">3.è¿è¡Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-accept"><span class="toc-text">3.1 accept</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="toc-text">3.2 è·å–è¿æ¥ä¿¡æ¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%BA%BF%E7%A8%8B%EF%BC%89"><span class="toc-text">3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E9%97%AE%E9%A2%981-%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1"><span class="toc-text">3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E9%97%AE%E9%A2%982-%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E9%97%AE%E9%A2%983-%E7%BA%BF%E7%A8%8B%E4%BC%A0%E5%8F%82"><span class="toc-text">3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-4-%E6%9C%8D%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-text">3.3.4 æœåŠ¡ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%AD%90%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="toc-text">3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-1-%E4%BF%A1%E5%8F%B7%E5%9B%9E%E6%94%B6%E5%AD%90%E8%BF%9B%E7%A8%8B"><span class="toc-text">3.4.1 ä¿¡å·å›æ”¶å­è¿›ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-2-%E7%88%B7%E7%88%B7%E8%BF%9B%E7%A8%8B"><span class="toc-text">3.4.2 çˆ·çˆ·è¿›ç¨‹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-text">4.å®¢æˆ·ç«¯</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-text">4.1 è¿è¡Œæµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">5.çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-task"><span class="toc-text">5.1 task</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-tcpServer%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">5.2 tcpServerçš„å¤„ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-text">5.3 è¿è¡Œæµ‹è¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-task%E7%AD%89%E5%BE%85%E9%97%AE%E9%A2%98"><span class="toc-text">5.4 taskç­‰å¾…é—®é¢˜</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3646407477/" title="ã€macã€‘ä½¿ç”¨AIDenteé™åˆ¶macæœ€å¤§å……ç”µç”µé‡">ã€macã€‘ä½¿ç”¨AIDenteé™åˆ¶macæœ€å¤§å……ç”µç”µé‡</a><time datetime="2024-11-14T13:15:00.000Z" title="å‘è¡¨äº 2024-11-14 21:15:00">2024-11-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2620921861/" title="ã€Linuxã€‘å¦‚ä½•å°†ä¸€ä¸ªå‘½ä»¤è¦æ±‚çš„è¾“å…¥é€šè¿‡ç®¡é“ä¼ é€’ï¼Ÿ">ã€Linuxã€‘å¦‚ä½•å°†ä¸€ä¸ªå‘½ä»¤è¦æ±‚çš„è¾“å…¥é€šè¿‡ç®¡é“ä¼ é€’ï¼Ÿ</a><time datetime="2024-11-06T13:46:11.000Z" title="å‘è¡¨äº 2024-11-06 21:46:11">2024-11-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/1547470773/" title="ã€Pythonã€‘ä»peeweeåˆ‡æ¢åˆ°tortoise-ormå¼‚æ­¥ormåº“">ã€Pythonã€‘ä»peeweeåˆ‡æ¢åˆ°tortoise-ormå¼‚æ­¥ormåº“</a><time datetime="2024-10-23T22:58:58.000Z" title="å‘è¡¨äº 2024-10-24 06:58:58">2024-10-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/368684172/" title="ã€Hexoã€‘é€šè¿‡hexo-hide-postsæ’ä»¶éšè—æ–‡ç« ">ã€Hexoã€‘é€šè¿‡hexo-hide-postsæ’ä»¶éšè—æ–‡ç« </a><time datetime="2024-09-21T02:24:23.000Z" title="å‘è¡¨äº 2024-09-21 10:24:23">2024-09-21</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/main/mothra.webp)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By æ…•é›ªå¹´å</div><div class="footer_custom_text"><img src="/img/ico/gonganbeian.png" height="15">&nbsp;<a href="https://beian.mps.gov.cn/#/query/webSearch?code=44190002007715" rel="noreferrer" target="_blank">ç²¤å…¬ç½‘å®‰å¤‡44190002007715</a><br><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="/img/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4.svg" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="/img/badge/-SITEMAP-00CDCD.svg" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="/img/badge/%E7%B2%A4ICP%E5%A4%872023007189-red.svg" height="20px"></a><br><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/img/ico/upyun_cdn_w.png" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.3/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.2/mermaid.min.js').then(runMermaid)
  }

  btf.addModeChange('mermaid', runMermaid)

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>function loadArtalk () {
  function initArtalk () {
    window.artalkItem = new Artalk(Object.assign({
      el: '#artalk-wrap',
      server: 'https://artk.musnow.top',
      site: 'mublog',
      pageKey: location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      countEl: '.artalk-count'
    },null))

    if (GLOBAL_CONFIG.lightbox === 'null') return
    window.artalkItem.use(ctx => {
      ctx.on('list-loaded', () => {
        ctx.getCommentList().forEach(comment => {
          const $content = comment.getRender().$content
          btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
        })
      })
    })
  }

  if (typeof window.artalkItem === 'object') initArtalk()
  else {
    getCSS('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.css').then(()=>{
      getScript('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.js').then(initArtalk)
    })
  }
}

function artalkChangeMode (theme) {
  const artalkWrap = document.getElementById('artalk-wrap')
  if (!(artalkWrap && artalkWrap.children.length)) return
  const isDark = theme === 'dark'
  window.artalkItem.setDarkMode(isDark)
}

btf.addModeChange('artalk', artalkChangeMode)

if ('Artalk' === 'Artalk' || !false) {
  if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
  else loadArtalk()
} else {
  function loadOtherComment () {
    loadArtalk()
  }
}</script></div><script src="/js/domain_check.js"></script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async mobile="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/search/local-search.min.js"></script></div></div></body></html>