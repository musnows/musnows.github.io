<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ | æ…•é›ªçš„å¯’èˆ</title><meta name="author" content="æ…•é›ªå¹´å"><meta name="copyright" content="æ…•é›ªå¹´å"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="æˆ‘ä¹Ÿä¸çŸ¥é“å•¥æ—¶å€™èƒ½è¡¥ä¸Šè¿™ä¸ªâ€¦â€¦">
<meta property="og:type" content="article">
<meta property="og:title" content="ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ">
<meta property="og:url" content="https://blog.musnow.top/posts/1282431418/index.html">
<meta property="og:site_name" content="æ…•é›ªçš„å¯’èˆ">
<meta property="og:description" content="æˆ‘ä¹Ÿä¸çŸ¥é“å•¥æ—¶å€™èƒ½è¡¥ä¸Šè¿™ä¸ªâ€¦â€¦">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.musnow.top/i/2023/04/6427d4dd5855b.png">
<meta property="article:published_time" content="2023-04-01T08:13:46.000Z">
<meta property="article:modified_time" content="2024-04-10T04:46:15.000Z">
<meta property="article:author" content="æ…•é›ªå¹´å">
<meta property="article:tag" content="Cpp">
<meta property="article:tag" content="ç±»å’Œå¯¹è±¡">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.musnow.top/i/2023/04/6427d4dd5855b.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ",
  "url": "https://blog.musnow.top/posts/1282431418/",
  "image": "https://img.musnow.top/i/2023/04/6427d4dd5855b.png",
  "datePublished": "2023-04-01T08:13:46.000Z",
  "dateModified": "2024-04-10T04:46:15.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "æ…•é›ªå¹´å",
      "url": "https://blog.musnow.top/"
    }
  ]
}</script><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/1282431418/index.html"><link rel="preconnect"/><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"/><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"/><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":420,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":600,"languages":{"author":"ä½œè€…: æ…•é›ªå¹´å","link":"é“¾æ¥: ","source":"æ¥æº: æ…•é›ªçš„å¯’èˆ","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/equipment/equipment.css?1"><link rel="stylesheet" href="/rating/rating.css?1"><script src="/js/typing_style.js"></script><script>var _hmt = _hmt || [];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?f444e8de702765e309d1a751aa12203e";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="æ…•é›ªçš„å¯’èˆ" type="application/atom+xml">
</head><body><div id="web_bg" style="background-image: url(/img/main/mothra.webp);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">460</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">24</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/rating/"><i class="fa-fw fas fa-film"></i><span> ä¹¦Â·å½±</span></a></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> èƒŒåŒ…</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://img.musnow.top/i/2023/04/6427d4dd5855b.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/favicon.jpg" alt="Logo"><span class="site-name">æ…•é›ªçš„å¯’èˆ</span></a><a class="nav-page-title" href="/"><span class="site-name">ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/rating/"><i class="fa-fw fas fa-film"></i><span> ä¹¦Â·å½±</span></a></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> èƒŒåŒ…</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">ã€C++ã€‘æ™ºèƒ½æŒ‡é’ˆ</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-04-01T08:13:46.000Z" title="å‘è¡¨äº 2023-04-01 16:13:46">2023-04-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-04-10T04:46:15.000Z" title="æ›´æ–°äº 2024-04-10 12:46:15">2024-04-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">ç¼–ç¨‹å­¦ä¹ </a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/Cpp/">Cpp</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">8.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>34åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div class="ai-summary"><div class="ai-explanation" style="display: block;" data-summary="è¿™é‡Œæ˜¯æ…•é›ªçš„å°åŠ©æ‰‹ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†C++ä¸­å†…å­˜æ³„æ¼çš„é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å¼•å…¥æ™ºèƒ½æŒ‡é’ˆå’ŒRAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰æ€æƒ³æ¥è‡ªåŠ¨ç®¡ç†å†…å­˜èµ„æºï¼Œé¿å…æ‰‹åŠ¨é‡Šæ”¾å†…å­˜çš„ç¹çå’Œå¼‚å¸¸å¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚æ–‡ç« è¯¦ç»†å±•ç¤ºäº†æ™ºèƒ½æŒ‡é’ˆçš„å®ç°åŸç†å’ŒåŸºç¡€ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº†å…¶åœ¨æ„é€ æ—¶è·å–èµ„æºã€ææ„æ—¶é‡Šæ”¾èµ„æºçš„è¿‡ç¨‹ï¼Œå¹¶éªŒè¯äº†å³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£å¸¸é‡Šæ”¾å†…å­˜ï¼Œä»è€Œæœ‰æ•ˆè§£å†³å†…å­˜æ³„æ¼é—®é¢˜ã€‚">æ…•é›ªçš„å°åŠ©æ‰‹æ­£åœ¨ç»å°½è„‘æ±Â·Â·Â·</div><div class="ai-title"> <div class="ai-title-left"> <i class="fa-brands fa-slack"></i><div class="ai-title-text">æ…•é›ªå°åŠ©æ‰‹çš„æ€»ç»“</div></div><div class="ai-tag" id="ai-tag">LongCat-Flash-Chat</div></div></div><div id="post-outdate-notice" data="{&quot;limitDay&quot;:180,&quot;messagePrev&quot;:&quot;è·ç¦»ä¸Šæ¬¡æ›´æ–°æœ¬æ–‡å·²ç»è¿‡å»äº†&quot;,&quot;messageNext&quot;:&quot;å¤©ï¼Œæ–‡ç« éƒ¨åˆ†å†…å®¹å¯èƒ½å·²ç»è¿‡æ—¶ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚&quot;,&quot;postUpdate&quot;:&quot;2024-04-10 12:46:15&quot;}" hidden></div><p>ç»ˆäºæ¥å¡«å‘äº†ğŸ˜‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2022-10-19 -&gt; 2023-04-01</span><br></pre></td></tr></table></figure>
<h2 id="1-æƒ…æ™¯">1.æƒ…æ™¯</h2>
<p>å¯¹äºC/C++è€Œè¨€ï¼Œå†…å­˜æ³„æ¼æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ã€‚æ¯æ¬¡è¿›è¡Œ<code>new</code>æ“ä½œä¹‹åï¼Œæˆ‘ä»¬éƒ½éœ€è¦å¯¹å…¶è¿›è¡Œå¯¹åº”çš„<code>delete</code>ï¼Œå·²é¿å…å†…å­˜æ³„æ¼ã€‚</p>
<p>å¯ä»£ç ä¸€é•¿ï¼Œé€»è¾‘å¤æ‚èµ·æ¥äº†ï¼Œæƒ³å¤„ç†å°±æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“äº†ã€‚</p>
<h3 id="1-1-ä»£ç å¤ªé•¿ï¼Œçœ‹ä¸åˆ°å¤´">1.1 ä»£ç å¤ªé•¿ï¼Œçœ‹ä¸åˆ°å¤´</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* arr1 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span>* arr2 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="comment">//ä¸­é—´æœ‰è¶…çº§å¤šè¡Œä»£ç </span></span><br><span class="line">    <span class="keyword">delete</span> arr1[];</span><br><span class="line">    <span class="keyword">delete</span> arr2[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ—¥å¸¸çš„å­¦ä¹ ï¼Œå¯èƒ½å†™çš„ä»£ç å¹¶ä¸æ˜¯å¾ˆå¤šã€‚ä½†å¦‚æœæ˜¯ä¸€ä¸ªå¤§å‹çš„é¡¹ç›®ï¼Œnewå’Œdeleteä¹‹ä¸­å¯èƒ½éš”äº†<strong>æˆåƒä¸Šä¸‡</strong>è¡Œä»£ç ï¼Œé‚£æ—¶å€™è¿˜æƒ³å»æ‰¾è¿™ä¸ªå˜é‡çš„ä½ç½®ï¼Œå¯å°±ä¸é‚£ä¹ˆå¥½æ‰¾äº†ã€‚æå…¶å®¹æ˜“å‡ºç°å¿˜è®°deleteçš„æƒ…å†µ</p>
<h3 id="1-2-å¼‚å¸¸å®‰å…¨">1.2 å¼‚å¸¸å®‰å…¨</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(b==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">invalid_argument</span>(<span class="string">&quot;é™¤0é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a/b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* arr1 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span>* arr2 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">func</span>(<span class="number">1</span>,<span class="number">0</span>);<span class="comment">//æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">delete</span>[] arr1;</span><br><span class="line">    <span class="keyword">delete</span>[] arr2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="built_in">test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">       <span class="built_in">catch</span>(...)&#123;</span><br><span class="line">        cout &lt;&lt;<span class="string">&quot;å‡ºç°å¼‚å¸¸&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢çš„ä»£ç ï¼Œåœ¨testå‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†å¦å¤–ä¸€ä¸ªä¼šæŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°ã€‚å¦‚æœè¿™ä¸ªå‡½æ•°æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåç»­çš„<code>delete</code>æ“ä½œä¸ä¼šè¢«æ‰§è¡Œï¼Œå‡ºç°å†…å­˜æ³„æ¼ã€‚</p>
<p>å¦‚æœæ“ä½œçš„å †åŒºå˜é‡è¾ƒå°‘ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a,<span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(b==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">invalid_argument</span>(<span class="string">&quot;é™¤0é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a/b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* arr1 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span>* arr2 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">func</span>(<span class="number">1</span>,<span class="number">0</span>);<span class="comment">//æŠ›å¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...)&#123;<span class="comment">//æ¥ç®¡å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// é”€æ¯</span></span><br><span class="line">        <span class="keyword">delete</span>[] arr1;</span><br><span class="line">        <span class="keyword">delete</span>[] arr2;</span><br><span class="line">        <span class="keyword">throw</span>;<span class="comment">// åŸæ ·æŠ›å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] arr1;</span><br><span class="line">    <span class="keyword">delete</span>[] arr2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">         <span class="built_in">test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">       <span class="built_in">catch</span>(...)&#123;</span><br><span class="line">        cout &lt;&lt;<span class="string">&quot;å‡ºç°å¼‚å¸¸&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œè¿™æ ·å¹¶ä¸èƒ½å®Œå…¨è§£å†³é—®é¢˜ï¼Œå› ä¸ºnewå‡½æ•°æœ¬èº«ä¹Ÿæœ‰å¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* arr1 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span>* arr2 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];<span class="comment">//è¿™é‡ŒæŠ›å¼‚å¸¸äº†</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶æ— æ³•è¢«æ¥ç®¡ï¼</span></span><br><span class="line">    <span class="comment">// arr1æ²¡æœ‰è¢«ææ„ï¼Œå‡ºç°å†…å­˜æ³„æ¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">func</span>(<span class="number">1</span>,<span class="number">0</span>);<span class="comment">//æŠ›å¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...)&#123;<span class="comment">//æ¥ç®¡å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// é”€æ¯</span></span><br><span class="line">        <span class="keyword">delete</span>[] arr1;</span><br><span class="line">        <span class="keyword">delete</span>[] arr2;</span><br><span class="line">        <span class="keyword">throw</span>;<span class="comment">// åŸæ ·æŠ›å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] arr1;</span><br><span class="line">    <span class="keyword">delete</span>[] arr2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠŠnewä¹Ÿä¸¢åˆ°tryé‡Œé¢ï¼Ÿä¾æ—§ä¸è¡Œï¼ˆè¯¦è§æ³¨é‡Šï¼‰</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">int</span>* arr1 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">        <span class="type">int</span>* arr2 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];<span class="comment">//è¿™é‡ŒæŠ›å¼‚å¸¸äº†</span></span><br><span class="line">        <span class="type">int</span>* arr3 = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">func</span>(<span class="number">1</span>,<span class="number">0</span>);<span class="comment">//æŠ›å¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...)&#123;</span><br><span class="line">        <span class="comment">// ä½ ä¸çŸ¥é“å“ªä¸€ä¸ªå‡ºäº†å¼‚å¸¸ï¼</span></span><br><span class="line">        <span class="comment">// å‡è®¾arr2å‡ºå¼‚å¸¸ï¼Œarr2å’Œarr3éƒ½æ²¡æœ‰ç”³è¯·ç©ºé—´æˆåŠŸ</span></span><br><span class="line">        <span class="comment">// æ€ä¹ˆè¿›è¡Œé”€æ¯ï¼Ÿ</span></span><br><span class="line">        <span class="keyword">delete</span>[] arr1;</span><br><span class="line">        <span class="keyword">delete</span>[] arr2;</span><br><span class="line">        <span class="keyword">delete</span>[] arr3;</span><br><span class="line">        <span class="keyword">throw</span>;<span class="comment">// åŸæ ·æŠ›å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] arr1;</span><br><span class="line">    <span class="keyword">delete</span>[] arr2;</span><br><span class="line">    <span class="keyword">delete</span>[] arr3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œä¸”ï¼Œå¦‚æœéœ€è¦æ“ä½œçš„newå˜é‡å¾ˆå¤šï¼Œé‚£ä¹ˆåœ¨catché‡Œé¢å°±éœ€è¦åŠ ä¸Šå¤šä¸ªdeleteï¼Œä»£ç å°±æ˜¾å¾—è¿‡äºé‡å¤äº†ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒC++å¼•å…¥äº†<strong>æ™ºèƒ½æŒ‡é’ˆ</strong></p>
<h2 id="2-æ™ºèƒ½æŒ‡é’ˆ">2.æ™ºèƒ½æŒ‡é’ˆ</h2>
<h3 id="2-1-RAII">2.1 RAII</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAII - Resource Acquisition is Initialization</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRAIIæ˜¯ä¸€ç§<strong>æ€æƒ³</strong>ï¼Œå¹¶ä¸èƒ½ç”¨å®ƒæ¥æŒ‡ä»£æ™ºèƒ½æŒ‡é’ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAII != æ™ºèƒ½æŒ‡é’ˆ</span><br></pre></td></tr></table></figure>
<p>å®ƒæ˜¯ä¸€ç§åˆ©ç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¥æ§åˆ¶ç¨‹åºèµ„æºï¼ˆå†…å­˜ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œé“¾æ¥ã€äº’æ–¥é‡ç­‰ï¼‰çš„æŠ€æœ¯</p>
<blockquote>
<p>åªè¦æ˜¯ä¸¤æ­¥æ“ä½œçš„ï¼Œéœ€è¦ç”³è¯·+é‡Šæ”¾çš„èµ„æºï¼Œéƒ½å¯ä»¥ä½¿ç”¨RAIIçš„æ€æƒ³æ¥è¿›è¡Œå¤„ç†ã€‚æ¯”å¦‚è‡ªå·±å°è£…ä¸€ä¸ªè‡ªåŠ¨å¤„ç†<code>pthread_mutex</code>é”çš„initå’Œdestoryçš„ç±»ï¼Œ<code>std::unique_lock</code>å°±æ˜¯ä½¿ç”¨äº†RAIIæ€æƒ³çš„é”ç®¡ç†ç±»ï¼Œä¼šè‡ªåŠ¨åŠ é”å¹¶åœ¨å‡ºä½œç”¨åŸŸçš„æ—¶å€™è§£é”ã€‚</p>
</blockquote>
<p>è¯´äººè¯å°±æ˜¯ï¼Œåœ¨å¯¹è±¡<strong>æ„é€ </strong>çš„æ—¶å€™è·å–èµ„æºï¼Œ<strong>ææ„</strong>çš„æ—¶å€™é‡Šæ”¾èµ„æºã€‚</p>
<ul>
<li>åœ¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸåˆ°äº†ä¹‹åï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œå…å»äº†æˆ‘ä»¬æ‰‹åŠ¨é‡Šæ”¾èµ„æºorå¿˜è®°é‡Šæ”¾çš„ç¹çï¼›</li>
<li>èµ„æºåœ¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†…å§‹ç»ˆæœ‰æ•ˆï¼›</li>
</ul>
<p>åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šç”¨æ™ºèƒ½æŒ‡é’ˆæ¥ç®¡ç†å †åŒºç©ºé—´ã€‚</p>
<h2 id="3-demo">3.demo</h2>
<h3 id="3-1-åŸºç¡€ç¤ºä¾‹">3.1 åŸºç¡€ç¤ºä¾‹</h3>
<p>åœ¨è®¤è¯†ä¸åŒç±»å‹çš„æ™ºèƒ½æŒ‡é’ˆä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸ªæœ€ç®€å•çš„demo</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> mu &#123;</span><br><span class="line">    <span class="keyword">using</span> std::cout;</span><br><span class="line">    <span class="keyword">using</span> std::endl;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SmartPtr</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">SmartPtr</span>(T* ptr)</span><br><span class="line">            :_ptr(ptr)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;init &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ~<span class="built_in">SmartPtr</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;des  &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">delete</span>[] _ptr;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        T* _ptr;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å®ç°çš„ï¼Œå°±æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„æ™ºèƒ½æŒ‡é’ˆã€‚å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®¡ç†å †åŒºä¸Šçš„<strong>æ•°ç»„</strong>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _CRT_SECURE_NO_WARNINGS 1</span></span><br><span class="line"><span class="comment">//#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;demo.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">char</span>&gt; <span class="title">p4</span><span class="params">(<span class="keyword">new</span> <span class="type">char</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">double</span>&gt; <span class="title">p3</span><span class="params">(<span class="keyword">new</span> <span class="type">double</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;test&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test1</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œåï¼Œè¾“å‡ºçš„ç»“æœå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">init 006697A8</span><br><span class="line">init 006724D0</span><br><span class="line">init 00668860</span><br><span class="line">test</span><br><span class="line">des  00668860</span><br><span class="line">des  006724D0</span><br><span class="line">des  006697A8</span><br></pre></td></tr></table></figure>
<p>å…¶å®ç°äº†åœ¨æ„é€ ä¸­æ‰˜ç®¡ï¼Œåœ¨ææ„ä¸­é”€æ¯èµ„æºçš„æ“ä½œã€‚</p>
<hr>
<p>å³ä¾¿æŠ›å‡º<strong>å¼‚å¸¸</strong>ï¼Œä¾æ—§èƒ½æ­£å¸¸ææ„</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;demo.hpp&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (b == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">invalid_argument</span>(<span class="string">&quot;é™¤0é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">char</span>&gt; <span class="title">p2</span><span class="params">(<span class="keyword">new</span> <span class="type">char</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">double</span>&gt; <span class="title">p3</span><span class="params">(<span class="keyword">new</span> <span class="type">double</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;test1&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">func</span>(<span class="number">3</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...)&#123;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;test2&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">test1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (...)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;mian  å‡ºç°å¼‚å¸¸&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸åˆä¸è¿›è¡Œcatchï¼Œç¨‹åºä¼šè¢«abortç»ˆæ­¢ï¼Œæ— æ³•è§‚æµ‹åˆ°ç°è±¡ã€‚</p>
<p>ä»¥ä¸‹æ˜¯è¿è¡Œçš„ç»“æœï¼Œå¯ä»¥çœ‹åˆ°å¼‚å¸¸å‡ºç°åï¼Œèµ°åˆ°äº†<code>test1</code>å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸæœ«å°¾ï¼Œé‡Šæ”¾äº†3ä¸ªæŒ‡é’ˆï¼Œæ‰è¢«mainä¸­çš„<code>catch</code>æ•è·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">init 012B8F00</span><br><span class="line">init 012C3010</span><br><span class="line">init 012B8860</span><br><span class="line">test1</span><br><span class="line">des  012B8860</span><br><span class="line">des  012C3010</span><br><span class="line">des  012B8F00</span><br><span class="line">mian  å‡ºç°å¼‚å¸¸</span><br></pre></td></tr></table></figure>
<h3 id="3-2-è¿ç®—ç¬¦é‡è½½">3.2 è¿ç®—ç¬¦é‡è½½</h3>
<p>å½“ç„¶ï¼Œè¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆè¿˜æ˜¯å´å°‘å¾ˆå¤šä¸œè¥¿çš„</p>
<ul>
<li>å†™æ­»äº†<code>delete[]</code>ï¼Œæˆ‘åªæƒ³è®©å¥¹ç®¡ç†å•ä¸ªå˜é‡æ€ä¹ˆåŠï¼Ÿ</li>
<li>å¦‚ä½•è·å–æŒ‡é’ˆå†…çš„èµ„æºï¼Ÿ</li>
</ul>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬æš‚ä¸”ä¸æï¼ˆåç»­è®²è§£åº“ä¸­æ™ºèƒ½æŒ‡é’ˆçš„æ—¶å€™ä¼šè¯´æ˜ï¼‰ç¬¬äºŒä¸ªé—®é¢˜çš„ç­”æ¡ˆä¾¿æ˜¯ï¼šé‡è½½<code>*</code>å’Œ<code>-&gt;</code>æ“ä½œç¬¦</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">T&amp; <span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *_ptr;</span><br><span class="line">&#125;</span><br><span class="line">T* <span class="keyword">operator</span>-&gt;()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> _ptr;</span><br><span class="line">&#125;</span><br><span class="line">T&amp; <span class="keyword">operator</span>[](<span class="type">const</span> T&amp; n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> _ptr[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡è½½äº†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ“ä½œç±»å†…çš„æŒ‡é’ˆæˆå‘˜äº†</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">char</span>&gt; <span class="title">p2</span><span class="params">(<span class="keyword">new</span> <span class="type">char</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">double</span>&gt; <span class="title">p3</span><span class="params">(<span class="keyword">new</span> <span class="type">double</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;test&quot;</span> &lt;&lt; endl;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    cout &lt;&lt; p2[<span class="number">0</span>] &lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt; p2[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; *p2 + <span class="number">1</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">init 01661C30</span><br><span class="line">init 01671748</span><br><span class="line">init 016689B8</span><br><span class="line">test</span><br><span class="line">a b</span><br><span class="line">98</span><br><span class="line">des  016689B8</span><br><span class="line">des  01671748</span><br><span class="line">des  01661C30</span><br></pre></td></tr></table></figure>
<h3 id="3-3-æ‹·è´">3.3 æ‹·è´</h3>
<p>å¯¹äºæ™ºèƒ½æŒ‡é’ˆè€Œè¨€ï¼Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜æ˜¯é’ˆå¯¹æ‹·è´çš„ã€‚åœ¨ä¸€äº›åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æŒ‡é’ˆè¿›è¡Œæ‹·è´ï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°å¼‚å¸¸</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>])</span></span>;</span><br><span class="line">    <span class="function">mu::SmartPtr&lt;<span class="type">int</span>&gt; <span class="title">p2</span><span class="params">(p1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">init 00BBFB20</span><br><span class="line">des  00BBFB20</span><br><span class="line">des  00BBFB20</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å™¨æŠ¥é”™äº†</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/04/6427e7dd055e4.png" alt="image-20230401161340352"></p>
<p>åŸå› å°±æ˜¯ï¼Œé»˜è®¤çš„æ‹·è´æ„é€ ä½¿ç”¨çš„æ˜¯æµ…æ‹·è´ï¼Œå†ææ„çš„æ—¶å€™ï¼Œä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹åŒä¸€ä¸ªåœ°å€ææ„ï¼Œç›¸å½“äºææ„äº†ä¸¤æ¬¡ï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼</p>
<p>æ¥ä¸‹æ¥ï¼Œå°±è®©æˆ‘ä»¬çœ‹çœ‹cppåº“ä¸­æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„å§ï¼</p>
<h2 id="4-auto-ptr">4.auto_ptr</h2>
<p>ä¸ºäº†é¿å…æ‹·è´çš„æ—¶å€™ï¼Œå¯¼è‡´å¤šæ¬¡ææ„ï¼Œ<code>C++98</code>åº“å‡½æ•°ä¸­æä¾›äº†<code>auto_ptr</code>ã€‚åœ¨æ‹·è´çš„æ—¶å€™ï¼Œ<code>auto_ptr</code>é‡‡ç”¨çš„æ˜¯<strong>ç®¡ç†æƒè½¬ç§»</strong>çš„æ€è·¯</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">auto_ptr&lt;<span class="type">int</span>&gt;  <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>)</span></span>;<span class="comment">//æ— æ³•ç»§ç»­ä½¿ç”¨</span></span><br><span class="line">auto_ptr&lt;<span class="type">int</span>&gt;  sp2 = sp1;<span class="comment">//sp2æ¥ç®¡äº†sp1</span></span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬è¿™æ ·æ“ä½œäº†ä¹‹åï¼Œ<code>sp1</code>å¯¹è±¡å°†ä¸èƒ½å†è¢«ä½¿ç”¨ï¼Œå…¶å†…ç½®æŒ‡é’ˆä¼šè¢«ç½®ä¸º<code>nullptr</code>ï¼Œä½¿ç”¨ç›¸å½“äºè§£å¼•ç”¨ç©ºæŒ‡é’ˆï¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">auto_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>; </span><br><span class="line">auto_ptr&lt;<span class="type">int</span>&gt; sp2 = sp1;    <span class="comment">// sp2æ¥ç®¡äº†sp1ï¼Œsp1æ— æ³•ç»§ç»­ä½¿ç”¨</span></span><br><span class="line">cout &lt;&lt; *sp2 &lt;&lt; endl; <span class="comment">// æ‰“å°10</span></span><br><span class="line">cout &lt;&lt; *sp1 &lt;&lt; endl; <span class="comment">// è§£å¼•ç”¨ç©ºæŒ‡é’ˆï¼Œæ®µé”™è¯¯</span></span><br></pre></td></tr></table></figure>
<p>å› ä¸ºè¿™ä¸ªæ“ä½œå®åœ¨å¤ªå‘äººäº†ï¼Œå¦‚æœåœ¨æŸäº›å‡½æ•°ä¼ å‚çš„æ—¶å€™ï¼Œè¿›è¡Œå€¼æ‹·è´äº†ï¼Œå°±ä¼šå¯¼è‡´åŸæœ‰çš„æŒ‡é’ˆå¤±æ•ˆï¼Œä»è€Œå¼•å‘ç¨‹åºé”™è¯¯ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨C++11ä¹‹åï¼Œåº”<strong>é¿å…ä½¿ç”¨</strong><code>auto_ptr</code>ã€‚åœ¨ä½¿ç”¨æ–°ç‰ˆæœ¬g++è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œä¹Ÿä¼šæç¤º<code>auto_ptr</code>å·²ç»è¢«æŠ›å¼ƒäº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warning: â€˜template&lt;class&gt; class std::auto_ptrâ€™ is deprecated: use &#x27;std::unique_ptr&#x27; instead [-Wdeprecated-declarations]</span><br></pre></td></tr></table></figure>
<h2 id="5-unique-ptr">5.unique_ptr</h2>
<h3 id="5-1-åŸºæœ¬è¯´æ˜">5.1 åŸºæœ¬è¯´æ˜</h3>
<blockquote>
<p>åœ¨booståº“ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>scpoed_ptr</code>ï¼Œå…¶å°±æ˜¯<code>unique_ptr</code>çš„å‰èº«ã€‚</p>
</blockquote>
<p>uniqueçš„åšæ³•æ›´ç»ï¼Œæ—¢ç„¶æ‹·è´ä¼šå‡ºç°é—®é¢˜ï¼Œé‚£æˆ‘ç›´æ¥<strong>ä¸å…è®¸ä½ æ‹·è´</strong>ä¸å°±è¡Œäº†ï¼Ÿ</p>
<p>ç›´æ¥å°†æ‹·è´æ„é€ å’Œèµ‹å€¼é‡è½½ç»™<code>delete</code>äº†ï¼Œå³ç¦æ­¢å¯¹æ–¹ä½¿ç”¨æ‹·è´ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unique_ptr</span>(<span class="type">const</span> unique_ptr&lt;T&gt;&amp; n) = <span class="keyword">delete</span>;</span><br><span class="line">unique_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> unique_ptr&lt;T&gt;&amp; n) = <span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯C++11ä¹‹å‰ï¼Œå¯ä»¥é‡‡ç”¨<strong>åªå£°æ˜ä¸å®ç°</strong>çš„æ–¹å¼æ¥ç¦ç”¨æ‹·è´æ„é€ ã€‚ä¸ºäº†é¿å…ä½¿ç”¨è€…è‡ªå·±å†™ä¸€ä¸ªæ‹·è´æ„é€ ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶é…ç½®ä¸ºç§æœ‰ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:<span class="comment">//åªå£°æ˜ä¸å®ç°</span></span><br><span class="line">  <span class="built_in">unique_ptr</span>(<span class="type">const</span> unique_ptr&lt;T&gt;&amp; n);</span><br><span class="line">  unique_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> unique_ptr&lt;T&gt;&amp; n);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬å†™å‡ºè¿™æ ·çš„ä»£ç ï¼Œè§¦å‘äº†æ‹·è´æ„é€ çš„åœºæ™¯ï¼Œæ­¤æ—¶å› ä¸ºæ— æ³•è®¿é—®<code>unique_ptr</code>çš„æ‹·è´æ„é€ ï¼Œæ˜¯æ— æ³•ç¼–è¯‘æˆåŠŸçš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp2</span><span class="params">(sp1)</span></span>; <span class="comment">// æ— æ³•ç¼–è¯‘</span></span><br></pre></td></tr></table></figure>
<p>è™½ç„¶<code>unique_ptr</code>ä»æºå¤´è§£å†³äº†æ‹·è´çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå°é—®é¢˜ï¼š<strong>åŠŸèƒ½ä¸å…¨</strong>ã€‚å¦‚æœæˆ‘çœŸçš„éœ€è¦æ‹·è´å‘¢ï¼Ÿä½ è¿™ä¸ªå²‚ä¸æ˜¯ç”¨ä¸äº†å‘€ã€‚</p>
<h3 id="5-2-å¯ä»¥è¢«moveå—ï¼Ÿ">5.2 å¯ä»¥è¢«moveå—ï¼Ÿ</h3>
<p>é¢è¯•çš„æ—¶å€™è¢«è€ƒåˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå·²çŸ¥<code>unique_ptr</code>æ— æ³•æ‹·è´ï¼Œé‚£è¯·é—®ä»–å¯ä»¥è¢«<code>std::move</code>ç»™å…¶ä»–å˜é‡å—ï¼Ÿ</p>
<p>ä½¿ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">20</span>))</span></span>;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp1:&quot;</span> &lt;&lt; *sp1 &lt;&lt; endl; <span class="comment">// æ‰“å°20</span></span><br><span class="line"></span><br><span class="line">unique_ptr&lt;<span class="type">int</span>&gt; sp2 = std::<span class="built_in">move</span>(sp1);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp2:&quot;</span> &lt;&lt; *sp2 &lt;&lt; endl; <span class="comment">// æ‰“å°20</span></span><br><span class="line"></span><br><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp3</span><span class="params">(std::move(sp2))</span></span>;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp3:&quot;</span> &lt;&lt; *sp3 &lt;&lt; endl; <span class="comment">// æ‰“å°20</span></span><br><span class="line"></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp1(after move):&quot;</span> &lt;&lt; *sp1 &lt;&lt; endl; <span class="comment">// æ®µé”™è¯¯</span></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp2(after move):&quot;</span> &lt;&lt; *sp2 &lt;&lt; endl; <span class="comment">// æ®µé”™è¯¯</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹ï¼Œè®¿é—®sp1çš„æ—¶å€™ä¼šæ®µé”™è¯¯ï¼ˆè®¿é—®sp2çš„æ—¶å€™ä¹Ÿä¼šï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sp1:20</span><br><span class="line">sp2:20</span><br><span class="line">sp3:20</span><br><span class="line">[1]    6693 segmentation fault  ./test1</span><br></pre></td></tr></table></figure>
<p>å†æ¥è¯•è¯•èµ‹å€¼é‡è½½å¯ä»¥ä¸ï¼Œä¼šå‘ç°æ˜¯å¯è¡Œçš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp3</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">30</span>))</span></span>;</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp3:&quot;</span> &lt;&lt; *sp3 &lt;&lt; endl; <span class="comment">// æ‰“å°30</span></span><br><span class="line"></span><br><span class="line">sp3 = std::<span class="built_in">move</span>(sp2);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;sp3:&quot;</span> &lt;&lt; *sp3 &lt;&lt; endl; <span class="comment">// æ‰“å°20</span></span><br></pre></td></tr></table></figure>
<p>å¯å¾—ç»“è®ºï¼š<code>unique_ptr</code>å¯ä»¥è¢«moveï¼ŒmoveååŸæœ‰å¯¹è±¡å¤±æ•ˆï¼Œè®¿é—®åŸæœ‰å¯¹è±¡ä¼šæ®µé”™è¯¯ã€‚</p>
<blockquote>
<p>å°†ä¸Šé¢çš„<code>unique_ptr</code>æ¢æˆ<code>shared_ptr</code>ä¹Ÿæ˜¯ä¸€æ ·çš„ç»“æœï¼Œç¬¦åˆå³å€¼æ‹·è´çš„ç‰¹æ€§ã€‚</p>
</blockquote>
<p>å…¶å®è¿™ä¸ªé—®é¢˜æ˜¯å–å†³äº<code>unique_ptr</code>æ˜¯å¦å®ç°äº†å³å€¼æ‹·è´ã€‚ä½¿ç”¨vscodeè·³è½¬åˆ°linuxä¸‹<code>unique_ptr</code>çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯å®ç°äº†å³å€¼æ‹·è´çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Move constructor.</span></span><br><span class="line">     <span class="built_in">unique_ptr</span>(unique_ptr&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/** @brief Converting constructor from another type</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * Requires that the pointer owned by @p __u is convertible to the</span></span><br><span class="line"><span class="comment">      * type of pointer owned by this object, @p __u does not own an array,</span></span><br><span class="line"><span class="comment">      * and @p __u has a compatible deleter type.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="keyword">template</span>&lt;<span class="keyword">typename</span> _Up, <span class="keyword">typename</span> _Ep, <span class="keyword">typename</span> = _Require&lt;</span><br><span class="line">              __safe_conversion_up&lt;_Up, _Ep&gt;,</span><br><span class="line">       <span class="keyword">typename</span> conditional&lt;is_reference&lt;_Dp&gt;::value,</span><br><span class="line">                is_same&lt;_Ep, _Dp&gt;,</span><br><span class="line">                is_convertible&lt;_Ep, _Dp&gt;&gt;::type&gt;&gt;</span><br><span class="line"><span class="built_in">unique_ptr</span>(unique_ptr&lt;_Up, _Ep&gt;&amp;&amp; __u) <span class="keyword">noexcept</span></span><br><span class="line">: _M_t(__u.<span class="built_in">release</span>(), std::forward&lt;_Ep&gt;(__u.<span class="built_in">get_deleter</span>()))</span><br><span class="line">&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ä¹Ÿèƒ½æ‰¾åˆ°å³å€¼çš„èµ‹å€¼é‡è½½ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assignment.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** @brief Move assignment operator.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Invokes the deleter if this object owns a pointer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">unique_ptr&amp;</span><br><span class="line"><span class="keyword">operator</span>=(unique_ptr&amp;&amp;) = <span class="keyword">default</span>;</span><br></pre></td></tr></table></figure>
<h2 id="6-shared-ptr">6.shared_ptr</h2>
<p>shareå³åˆ†äº«ï¼Œè¿™ä¸ªæ™ºèƒ½æŒ‡é’ˆæ˜¯æ”¯æŒæ‹·è´çš„ã€‚é‚£å®ƒåº”è¯¥å¦‚ä½•è§£å†³åŒä¸€ç‰‡ç©ºé—´è¢«é‡Šæ”¾å¤šæ¬¡çš„é—®é¢˜å‘¢ï¼Ÿ</p>
<h3 id="6-1-å¼•ç”¨è®¡æ•°">6.1 å¼•ç”¨è®¡æ•°</h3>
<p>ä¸ºäº†ä¿è¯èµ„æºåªä¼šè¢«é‡Šæ”¾ä¸€æ¬¡ï¼Œå…¶é‡‡ç”¨äº†å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥å®ç°ã€‚</p>
<ul>
<li>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå¼•ç”¨è®¡æ•°ä¸º1;</li>
<li>æ¯æ¬¡æ‹·è´ï¼Œå¼•ç”¨è®¡æ•°éƒ½+1ï¼ˆåŒ…æ‹¬æ‹·è´æ„é€ å’Œèµ‹å€¼é‡è½½ï¼‰;</li>
<li>ææ„çš„æ—¶å€™ï¼Œå¼•ç”¨è®¡æ•°ä¸ä¸º1ï¼Œå°†è®¡æ•°å™¨-1;</li>
<li>åªæœ‰å¼•ç”¨è®¡æ•°ä¸º1ï¼ˆå½“å‰æ˜¯æœ€åä¸€ä¸ªå¯¹è±¡äº†ï¼‰ï¼Œæ‰åœ¨ææ„çš„æ—¶å€™é‡Šæ”¾èµ„æº;</li>
</ul>
<p>è¿™æ ·å°±è§£å†³äº†è¢«ææ„å¤šæ¬¡çš„é—®é¢˜ï¼</p>
<h3 id="6-2-å¦‚ä½•å®ç°ï¼Ÿ">6.2 å¦‚ä½•å®ç°ï¼Ÿ</h3>
<ul>
<li>ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Ÿ</li>
</ul>
<p>ä¸è¡Œï¼Œä¸€ä¸ªå¯¹è±¡çš„ä¿®æ”¹ä¸å½±å“ç¬¬äºŒä¸ªå¯¹è±¡çš„æˆå‘˜ï¼Œä¾æ—§ä¼šå‡ºç°ææ„å¤šæ¬¡çš„é—®é¢˜ã€‚</p>
<ul>
<li>ä½¿ç”¨staticæˆå‘˜ï¼Ÿ</li>
</ul>
<p>staticæˆå‘˜å±äºæ•´ä¸ªç±»ï¼Œè¿™æ ·å¼„ç›¸å½“äºç»™è¿™ä¸ªç±»åŠ äº†ä¸ªå·²æœ‰å¯¹è±¡æ•°é‡çš„è®¡æ•°å™¨ï¼Œå—è¾•åŒ—è¾™ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T* _ptr;</span><br><span class="line"><span class="type">int</span>* _pcount;<span class="comment">//è®¡æ•°å™¨</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªintç±»å‹çš„æŒ‡é’ˆï¼Œåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–å¯¹è±¡çš„æ—¶å€™ï¼Œç»™è¿™ä¸ªæŒ‡é’ˆåˆ›å»ºå †åŒºçš„intç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–ä¸º1ï¼›</p>
<p>è¿™æ ·æ¯æ¬¡æ‹·è´ã€èµ‹å€¼çš„æ—¶å€™ï¼Œéƒ½ç»™è¿™ä¸ªpcountæŒ‡å‘çš„intç»™<code>+1</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*_pcount)++</span><br></pre></td></tr></table></figure>
<p>æ¯æ¬¡ææ„çš„æ—¶å€™éƒ½<code>-1</code>ï¼Œåªæœ‰ä¸º0çš„æ—¶å€™ï¼Œæ‰è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚åŒæ—¶é‡Šæ”¾æŒ‡é’ˆæ‰˜ç®¡çš„å†…å­˜ä»¥åŠpcountå ç”¨çš„å†…å­˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(*_pcount)--;<span class="comment">//å…ˆå°†è‡ªå·±çš„-1</span></span><br><span class="line"><span class="keyword">if</span>((*_pcount==<span class="number">0</span>))<span class="comment">//å¦‚æœä¸º0ï¼Œåˆ™ä»£è¡¨è‡ªå·±æ˜¯æœ€åä¸€ä¸ª</span></span><br><span class="line">&#123;<span class="comment">//é‡Šæ”¾è‡ªå·±çš„èµ„æº</span></span><br><span class="line">    <span class="keyword">delete</span> _ptr;</span><br><span class="line">    <span class="keyword">delete</span> _pcount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-3-èµ‹å€¼">6.3 èµ‹å€¼</h3>
<p>èµ‹å€¼æœ‰ä¸¤ç§æƒ…å†µ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">1</span>))</span></span>;</span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; sp2; </span><br><span class="line">sp2 = sp1;<span class="comment">//æƒ…å†µ1</span></span><br><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp3</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">3</span>))</span></span>;</span><br><span class="line">sp1 = sp3;<span class="comment">//æƒ…å†µ2</span></span><br><span class="line">shared_ptr&lt;<span class="type">int</span>&gt; sp4 = sp1;<span class="comment">//å®é™…ä¸Šè°ƒç”¨çš„æ˜¯æ‹·è´æ„é€  </span></span><br></pre></td></tr></table></figure>
<p><strong>ç¬¬ä¸€ç§</strong> æ˜¯å¯¹è±¡æ²¡æœ‰åˆå§‹åŒ–ï¼Œè°ƒç”¨äº†é»˜è®¤æ— å‚æ„é€ å‡½æ•°ï¼Œå…¶å†…éƒ¨æ‰˜ç®¡çš„æŒ‡é’ˆæ˜¯<code>nullptr</code>ï¼Œ<code>sp2=sp1</code>ï¼Œç›¸å½“äºæ˜¯åˆå§‹åŒ–<code>sp2</code>å¯¹è±¡ã€‚</p>
<p><strong>ç¬¬äºŒç§</strong> æ˜¯å¯¹è±¡å·²ç»åˆå§‹åŒ–äº†ï¼Œä½†æ˜¯æˆ‘æƒ³è®©ä»–ç®¡ç†å¦å¤–ä¸€ä»½èµ„æºã€‚</p>
<ul>
<li>é’ˆå¯¹æƒ…å†µ1ï¼Œæ“ä½œå’Œæ‹·è´æ„é€ ç›¸åŒï¼Œæˆ‘ä»¬åªéœ€è¦èµ‹å€¼ç»™sp2åï¼Œå°†å¼•ç”¨è®¡æ•°åŠ +1å³å¯</li>
<li>é’ˆå¯¹æƒ…å†µ2ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ¤æ–­sp1çš„æƒ…å†µäº†ã€‚å¦‚æœsp1çš„å¼•ç”¨è®¡æ•°ä¸º1ï¼Œåˆ™éœ€è¦å…ˆ<strong>é”€æ¯sp1æ‰˜ç®¡çš„ç©ºé—´</strong>ï¼Œå†è¿›è¡Œèµ‹å€¼ã€‚å¹¶å°†sp3çš„å¼•ç”¨è®¡æ•°èµ‹å€¼ç»™sp1ï¼Œå¹¶å°†sp3çš„å¼•ç”¨è®¡æ•°+1</li>
</ul>
<p>è½åˆ°ä»£ç ä¸Šï¼Œåº”è¯¥å¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">shared_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;T&gt;&amp; p)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(p._ptr == _ptr)<span class="comment">//æŒ‡å‘çš„ç©ºé—´ç›¸åŒ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;<span class="comment">//å•¥éƒ½ä¸åš</span></span><br><span class="line">    &#125;</span><br><span class="line">    (*_pcount)--;<span class="comment">//å…ˆå°†è‡ªå·±çš„-1</span></span><br><span class="line">    <span class="keyword">if</span>((*_pcount==<span class="number">0</span>))<span class="comment">//å¦‚æœä¸º0ï¼Œåˆ™ä»£è¡¨è‡ªå·±æ˜¯æœ€åä¸€ä¸ª</span></span><br><span class="line">    &#123;<span class="comment">//é‡Šæ”¾è‡ªå·±çš„èµ„æº</span></span><br><span class="line">        <span class="keyword">delete</span> _ptr;</span><br><span class="line">        <span class="keyword">delete</span> _pcount;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//èµ‹å€¼å¯¹æ–¹çš„èµ„æº</span></span><br><span class="line">    _ptr = p._ptr;</span><br><span class="line">    _pcount = p._pcount;</span><br><span class="line">    (*_pcount)++;<span class="comment">//å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-4-ç®€å•å®ç°">6.4 ç®€å•å®ç°</h3>
<p>åº“ä¸­çš„å®ç°æ›´ä¸ºå¤æ‚ï¼Œå…¶è¿˜é‡è½½äº†<code>&lt;&lt;</code>æ“ä½œç¬¦ï¼Œå®ç°äº†æ›´å¤šæˆå‘˜å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">   <span class="keyword">class</span> <span class="title class_">shared_ptr</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">public</span>:</span><br><span class="line">           <span class="built_in">shared_ptr</span>(T* ptr = <span class="literal">nullptr</span>)</span><br><span class="line">               :_ptr(ptr),</span><br><span class="line">           _pcount(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               cout &lt;&lt; <span class="string">&quot;[init] &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//æ‹·è´æ„é€ </span></span><br><span class="line">           <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;T&gt;&amp; p)</span><br><span class="line">           &#123;</span><br><span class="line">               cout &lt;&lt; <span class="string">&quot;[copy] &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">               _ptr = p._ptr;</span><br><span class="line">               _pcount = p._pcount;</span><br><span class="line">               (*_pcount)++;<span class="comment">//å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//èµ‹å€¼é‡è½½</span></span><br><span class="line">           shared_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;T&gt;&amp; p)</span><br><span class="line">           &#123;</span><br><span class="line">               cout &lt;&lt; <span class="string">&quot;[operator=] &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">               <span class="keyword">if</span> (p._ptr == _ptr)<span class="comment">//æŒ‡å‘çš„ç©ºé—´ç›¸åŒ</span></span><br><span class="line">               &#123;</span><br><span class="line">                   <span class="keyword">return</span> *<span class="keyword">this</span>;<span class="comment">//å•¥éƒ½ä¸åš</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">//é‡Šæ”¾è‡ªå·±çš„èµ„æºï¼ˆåˆ¤æ–­ï¼‰</span></span><br><span class="line">               _Release();</span><br><span class="line">               <span class="comment">//èµ‹å€¼å¯¹æ–¹çš„èµ„æº</span></span><br><span class="line">               _ptr = p._ptr;</span><br><span class="line">               _pcount = p._pcount;</span><br><span class="line">               (*_pcount)++;<span class="comment">//å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line"></span><br><span class="line">               <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           T&amp; <span class="keyword">operator</span>*()</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> *_ptr;</span><br><span class="line">           &#125;</span><br><span class="line">           T* <span class="keyword">operator</span>-&gt;()</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> _ptr;</span><br><span class="line">           &#125;</span><br><span class="line">           T&amp; <span class="keyword">operator</span>[](<span class="type">const</span> T&amp; n)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">return</span> _ptr[n];</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="function">T* <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">           </span>&#123;</span><br><span class="line">               <span class="keyword">return</span> _ptr;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           ~<span class="built_in">shared_ptr</span>()</span><br><span class="line">           &#123;</span><br><span class="line">               _Release();</span><br><span class="line">           &#125;</span><br><span class="line">       <span class="keyword">private</span>:</span><br><span class="line">           <span class="type">void</span> _Release()</span><br><span class="line">           &#123;</span><br><span class="line">               (*_pcount)--;</span><br><span class="line">               cout &lt;&lt; <span class="string">&quot;[des] pcount:&quot;</span> &lt;&lt; (*_pcount) &lt;&lt; <span class="string">&quot; ptr:&quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">               <span class="keyword">if</span> ((*_pcount) == <span class="number">0</span>)</span><br><span class="line">               &#123;</span><br><span class="line">                   cout &lt;&lt; <span class="string">&quot;[des] delete &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl; <span class="comment">// å¦‚æœé‡Šæ”¾äº†èµ„æºï¼Œä¼šæ‰“å°è¿™ä¸ª</span></span><br><span class="line">                   <span class="keyword">if</span>(_ptr)<span class="comment">//_pträ¸ä¸ºç©ºçš„æ—¶å€™æ‰é‡Šæ”¾å®ƒ</span></span><br><span class="line">                       <span class="keyword">delete</span> _ptr;</span><br><span class="line">                   <span class="comment">//æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½éœ€è¦åˆ é™¤è®¡æ•°å™¨ï¼Œå¦åˆ™ä¼šæœ‰å†…å­˜æ³„æ¼</span></span><br><span class="line">                   <span class="keyword">delete</span> _pcount;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       T* _ptr;</span><br><span class="line">       <span class="type">int</span>* _pcount;<span class="comment">//å¼•ç”¨è®¡æ•°</span></span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="6-5-æµ‹è¯•">6.5 æµ‹è¯•</h3>
<p>ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">    <span class="function">mu::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p2</span><span class="params">(p1)</span></span>;</span><br><span class="line">    mu::shared_ptr&lt;<span class="type">int</span>&gt; p3 = p1;<span class="comment">//å®é™…ä¸Šè°ƒç”¨çš„æ˜¯æ‹·è´æ„é€ </span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 &quot;</span> &lt;&lt; (*p1) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 &quot;</span> &lt;&lt; (*p2) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p3 &quot;</span> &lt;&lt; (*p3) &lt;&lt; endl;</span><br><span class="line">    mu::shared_ptr&lt;<span class="type">int</span>&gt; p4;</span><br><span class="line">    p4 = p1;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p4 &quot;</span> &lt;&lt; (*p4) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="function">mu::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p5</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">20</span>))</span></span>;</span><br><span class="line">    p1 = p5;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 &quot;</span> &lt;&lt; (*p1) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p5 &quot;</span> &lt;&lt; (*p5) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œçš„ç»“æœå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[init] 00BE0B10</span><br><span class="line">[copy] 00000000</span><br><span class="line">[copy] 00000000</span><br><span class="line">p1 10</span><br><span class="line">p2 10</span><br><span class="line">p3 10</span><br><span class="line">[init] 00000000</span><br><span class="line">[operator=] 00000000</span><br><span class="line">[des] pcount:0 ptr:00000000</span><br><span class="line">[des] delete 00000000</span><br><span class="line">p4 10</span><br><span class="line">[init] 00BD8B30</span><br><span class="line">[operator=] 00BE0B10</span><br><span class="line">[des] pcount:3 ptr:00BE0B10</span><br><span class="line">p1 20</span><br><span class="line">p5 20</span><br><span class="line">[des] pcount:1 ptr:00BD8B30</span><br><span class="line">[des] pcount:2 ptr:00BE0B10</span><br><span class="line">[des] pcount:1 ptr:00BE0B10</span><br><span class="line">[des] pcount:0 ptr:00BE0B10</span><br><span class="line">[des] delete 00BE0B10</span><br><span class="line">[des] pcount:0 ptr:00BD8B30</span><br><span class="line">[des] delete 00BD8B30</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡ææ„ï¼Œå®é™…ä¸Šéƒ½ä¼šå…ˆå¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œ<code>-1</code>çš„æ“ä½œï¼Œåªæœ‰å¼•ç”¨è®¡æ•°ä¸º0çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šçœŸçš„ææ„æ‰å¯¹åº”çš„å€¼ã€‚</p>
<p>èµ‹å€¼çš„æ—¶å€™ï¼Œä¹Ÿæ²¡æœ‰å‡ºç°å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">mu::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line">    <span class="function">mu::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p2</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">20</span>))</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 &quot;</span> &lt;&lt; (*p1) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 &quot;</span> &lt;&lt; (*p2) &lt;&lt; endl;</span><br><span class="line">    p1 = p2;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p1 &quot;</span> &lt;&lt; (*p1) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;p2 &quot;</span> &lt;&lt; (*p2) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>p2åœ¨èµ‹å€¼ç»™p1ä¹‹å‰ï¼Œå…ˆææ„äº†p1ç»´æŠ¤çš„å˜å…ƒï¼Œæ‰è¿›è¡Œäº†èµ‹å€¼æ“ä½œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[init] 014DF1B8</span><br><span class="line">[init] 014D89A8</span><br><span class="line">p1 10</span><br><span class="line">p2 20</span><br><span class="line">[operator=] 014DF1B8</span><br><span class="line">[des] pcount:0 ptr:014DF1B8</span><br><span class="line">[des] delete 014DF1B8</span><br><span class="line">p1 20</span><br><span class="line">p2 20</span><br><span class="line">[des] pcount:1 ptr:014D89A8</span><br><span class="line">[des] pcount:0 ptr:014D89A8</span><br><span class="line">[des] delete 014D89A8</span><br></pre></td></tr></table></figure>
<h3 id="6-6-çº¿ç¨‹å®‰å…¨é—®é¢˜">6.6 çº¿ç¨‹å®‰å…¨é—®é¢˜</h3>
<p>åœ¨å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å¤šçº¿ç¨‹å¯¹è¯¥æŒ‡é’ˆè¿›è¡Œæ‹·è´çš„é—®é¢˜ã€‚ä¸ºäº†é¿å…å¼•ç”¨è®¡æ•°<code>pcount</code>åœ¨å¤šçº¿ç¨‹æ‹·è´çš„æ—¶å€™å‡ºç°äºŒä¹‰æ€§é—®é¢˜ï¼Œéœ€è¦å¯¹å¼•ç”¨è®¡æ•°çš„æ“ä½œè¿›è¡ŒåŠ é”</p>
<p>è¯¦è§ <a href="https://blog.musnow.top/posts/1249427441/">https://blog.musnow.top/posts/1249427441/</a> çš„ <code>12.shared_ptr</code>ï¼›é‡Šæ”¾èµ„æºçš„æ—¶å€™éœ€è¦ä½¿ç”¨é”æ¥åŠ é”è§£é”ï¼Œä¿è¯è®¡æ•°å™¨çš„æ“ä½œæ˜¯åŸå­æ€§çš„ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Release</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> flag = <span class="literal">false</span>;<span class="comment">//åˆ¤æ–­é”æ˜¯å¦éœ€è¦è¢«é‡Šæ”¾</span></span><br><span class="line"></span><br><span class="line">    _pMutex-&gt;<span class="built_in">lock</span>();</span><br><span class="line">    <span class="keyword">if</span> (--(*_pRefCount) == <span class="number">0</span> &amp;&amp; _ptr)</span><br><span class="line">    &#123;</span><br><span class="line">               <span class="comment">//è¿›å…¥äº†è¿™ä¸ªå‡½æ•°ï¼Œä»£è¡¨å¼•ç”¨è®¡æ•°ä¸º0</span></span><br><span class="line">        <span class="keyword">delete</span> _ptr;</span><br><span class="line">        <span class="keyword">delete</span> _pRefCount;</span><br><span class="line">        <span class="comment">//æ ‡è¯†éœ€è¦é‡Šæ”¾é”</span></span><br><span class="line">        flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _pMutex-&gt;<span class="built_in">unlock</span>();<span class="comment">//è§£é”</span></span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">        <span class="keyword">delete</span> _pMutex;</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¯æ¬¡æ‹·è´çš„æ—¶å€™ï¼Œå¼•ç”¨è®¡æ•°çš„æ“ä½œä¹Ÿéœ€è¦åŠ é”</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddRef</span><span class="params">()</span><span class="comment">//æ–°å¢å¼•ç”¨</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _pMutex-&gt;<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line">    ++(*_pRefCount);</span><br><span class="line"></span><br><span class="line">    _pMutex-&gt;<span class="built_in">unlock</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-7-å¾ªç¯å¼•ç”¨é—®é¢˜">6.7 å¾ªç¯å¼•ç”¨é—®é¢˜</h3>
<p><code>shared_ptr</code>çš„å¼•ç”¨è®¡æ•°å¯èƒ½ä¼šå‡ºç°<strong>å¾ªç¯å¼•ç”¨</strong>çš„é—®é¢˜ï¼Œå®ƒéœ€è¦ç”¨<code>weak_ptr</code>æ¥è§£å†³ã€‚åæ–‡ä¼šæåˆ°ã€‚</p>
<h3 id="6-8-make-sharedå’Œç›´æ¥æ„é€ shared-ptrçš„åŒºåˆ«">6.8 make_sharedå’Œç›´æ¥æ„é€ shared_ptrçš„åŒºåˆ«</h3>
<blockquote>
<p>æ¥è‡ªGPT</p>
</blockquote>
<p>make_shared å’Œç›´æ¥ä½¿ç”¨ shared_ptr çš„æ„é€ å‡½æ•°æœ‰å‡ ä¸ªå…³é”®åŒºåˆ«ï¼š</p>
<ol>
<li>æ€§èƒ½ï¼šmake_shared åœ¨åˆ›å»ºå¯¹è±¡æ—¶å°†åˆ†é…å†…å­˜æ¥åŒæ—¶å­˜å‚¨å¯¹è±¡å’Œæ§åˆ¶å—ï¼ˆcontrol blockï¼‰ï¼Œè€Œç›´æ¥ä½¿ç”¨ shared_ptr çš„æ„é€ å‡½æ•°åˆ™ä¼šåˆ†åˆ«åˆ†é…å†…å­˜æ¥å­˜å‚¨å¯¹è±¡å’Œæ§åˆ¶å—ã€‚å› æ­¤ï¼Œmake_shared å¯ä»¥å‡å°‘å†…å­˜åˆ†é…çš„æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ï¼Œå°¤å…¶åœ¨é¢‘ç¹åˆ›å»ºå’Œé”€æ¯ shared_ptr å¯¹è±¡æ—¶æ›´ä¸ºæ˜æ˜¾ã€‚</li>
<li>å†…å­˜ç®¡ç†ï¼šmake_shared ä¼šå°†å¯¹è±¡å’Œæ§åˆ¶å—ä¸€èµ·å­˜å‚¨åœ¨ä¸€å—è¿ç»­çš„å†…å­˜ä¸­ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å†…å­˜ç¢ç‰‡åŒ–ã€‚è€Œç›´æ¥ä½¿ç”¨ shared_ptr çš„æ„é€ å‡½æ•°åˆ™ä¼šåˆ†åˆ«åˆ†é…ä¸¤å—å†…å­˜ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜ç¢ç‰‡åŒ–çš„é—®é¢˜ã€‚</li>
<li>å¼‚å¸¸å®‰å…¨æ€§ï¼šä½¿ç”¨ make_shared å¯ä»¥æä¾›æ›´å¼ºçš„å¼‚å¸¸å®‰å…¨æ€§ï¼Œå› ä¸ºå¯¹è±¡å’Œæ§åˆ¶å—æ˜¯åœ¨åŒä¸€æ¬¡å†…å­˜åˆ†é…ä¸­åˆ›å»ºçš„ã€‚å¦‚æœåœ¨åˆ›å»ºå¯¹è±¡æˆ–æ§åˆ¶å—æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œmake_shared ä¼šè‡ªåŠ¨é”€æ¯å·²ç»åˆ†é…çš„å†…å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚è€Œç›´æ¥ä½¿ç”¨ shared_ptr çš„æ„é€ å‡½æ•°å¯èƒ½ä¼šå¯¼è‡´éƒ¨åˆ†å†…å­˜æ³„æ¼ï¼Œå› ä¸ºå¯¹è±¡æˆ–æ§åˆ¶å—å¯èƒ½å·²ç»è¢«æˆåŠŸåˆ†é…äº†ï¼Œä½†å¦ä¸€å—å†…å­˜åˆ†é…å¤±è´¥æ—¶å¯èƒ½æ— æ³•æ­£ç¡®é‡Šæ”¾ã€‚</li>
<li>ä½¿ç”¨æ–¹ä¾¿æ€§ï¼šmake_shared çš„è¯­æ³•æ›´ä¸ºç®€æ´æ˜äº†ï¼Œåªéœ€æä¾›å¯¹è±¡ç±»å‹å’Œæ„é€ å‡½æ•°å‚æ•°å³å¯ï¼Œä¸éœ€è¦æ˜¾å¼æŒ‡å®š shared_ptr çš„æ¨¡æ¿ç±»å‹ã€‚è€Œç›´æ¥ä½¿ç”¨ shared_ptr çš„æ„é€ å‡½æ•°åˆ™éœ€è¦æ˜¾å¼æŒ‡å®šæ¨¡æ¿ç±»å‹ï¼Œå¹¶ä¸”éœ€è¦åˆ†åˆ«ä¸ºå¯¹è±¡å’Œæ§åˆ¶å—è¿›è¡Œå†…å­˜åˆ†é…å’Œåˆå§‹åŒ–ã€‚</li>
</ol>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œå°½é‡ä¼˜å…ˆä½¿ç”¨ make_shared æ¥åˆ›å»º shared_ptr å¯¹è±¡ï¼Œä»¥æé«˜æ€§èƒ½å’Œå†…å­˜ç®¡ç†æ•ˆç‡ï¼Œå¹¶å¢å¼ºå¼‚å¸¸å®‰å…¨æ€§ã€‚</p>
<h2 id="7-weak-ptr">7.weak_ptr</h2>
<h3 id="7-1-ç®€ä»‹">7.1 ç®€ä»‹</h3>
<p>è¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸“é—¨ç”¨æ¥è¾…åŠ©è§£å†³<code>shared_ptr</code>å¾ªç¯å¼•ç”¨é—®é¢˜çš„ï¼Œå¯ä»¥è®¤ä¸ºå®ƒæ˜¯<code>shared_ptr</code>çš„å°å¼Ÿã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//default (1)    </span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> <span class="title">weak_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"><span class="comment">//copy (2)    </span></span><br><span class="line"><span class="built_in">weak_ptr</span> (<span class="type">const</span> weak_ptr&amp; x) <span class="keyword">noexcept</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="built_in">weak_ptr</span> (<span class="type">const</span> weak_ptr&lt;U&gt;&amp; x) <span class="keyword">noexcept</span>;</span><br><span class="line"><span class="comment">//from shared_ptr (3)    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="built_in">weak_ptr</span> (<span class="type">const</span> shared_ptr&lt;U&gt;&amp; x) <span class="keyword">noexcept</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//copy (1)    </span></span><br><span class="line">weak_ptr&amp; <span class="keyword">operator</span>= (<span class="type">const</span> weak_ptr&amp; x) <span class="keyword">noexcept</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; weak_ptr&amp; <span class="keyword">operator</span>= (<span class="type">const</span> weak_ptr&lt;U&gt;&amp; x) <span class="keyword">noexcept</span>;</span><br><span class="line"><span class="comment">//from shared_ptr (2)    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; weak_ptr&amp; <span class="keyword">operator</span>= (<span class="type">const</span> shared_ptr&lt;U&gt;&amp; x) <span class="keyword">noexcept</span>;</span><br></pre></td></tr></table></figure>
<p>ç›¸æ¯”äºå…¶ä»–æ™ºèƒ½æŒ‡é’ˆçš„æ„é€ å‡½æ•°ï¼Œ<code>weak_ptr</code>åªèƒ½è¿›è¡Œæ‹·è´ï¼Œæˆ–ä»ä¸€ä¸ª<code>shared_ptr</code>æ¥æ„é€ ã€‚</p>
<p>å®ƒæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ï¼šåªæ‰˜ç®¡èµ„æºï¼Œä¸å¤„ç†å¼•ç”¨è®¡æ•°ï¼Œææ„æ—¶ä¹Ÿä¸è¿›è¡Œèµ„æºé‡Šæ”¾ã€‚å¯ä»¥è®¤ä¸ºï¼Œå®ƒåªæ˜¯å¯¹æŒ‡é’ˆè¿›è¡Œäº†ç®€å•çš„å°è£…ã€‚</p>
<p>è¿™ä¸ªç‰¹æ€§ä¹Ÿå†³å®šäº†ï¼Œ<code>weak_ptr</code>ä¸èƒ½ä½¿ç”¨åŸç”ŸæŒ‡é’ˆæ¥æ„é€ ï¼</p>
<h3 id="7-2-ä»€ä¹ˆæ˜¯å¾ªç¯å¼•ç”¨">7.2 ä»€ä¹ˆæ˜¯å¾ªç¯å¼•ç”¨</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span></span><br><span class="line">&#123;</span><br><span class="line">    ListNode* _prev;</span><br><span class="line">    ListNode* _next;</span><br><span class="line">    T _val;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ListNode</span>(<span class="type">const</span> T&amp; val=<span class="built_in">T</span>())</span><br><span class="line">        :_prev(<span class="literal">nullptr</span>),</span><br><span class="line">        _next(<span class="literal">nullptr</span>),</span><br><span class="line">        _val(val)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ListNode</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[~ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p1</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>));</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p2</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">20</span>));	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªä»£ç æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„åŒé“¾è¡¨ï¼Œåœ¨æ²¡æœ‰ç»™é“¾è¡¨å†…èŠ‚ç‚¹èµ‹å€¼ä¹‹å‰ï¼Œå®ƒæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆèƒ½æˆåŠŸè°ƒç”¨å¯¹è±¡çš„ææ„ï¼Œå¹¶é”€æ¯ç©ºé—´</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ListNode()] 00DE10E0</span><br><span class="line">[init] 00DE10E0</span><br><span class="line">[ListNode()] 00DE14D0</span><br><span class="line">[init] 00DE14D0</span><br><span class="line">[des] pcount:0 ptr:00DE14D0</span><br><span class="line">[des] delete 00DE14D0</span><br><span class="line">[~ListNode()] 00DE14D0</span><br><span class="line">[des] pcount:0 ptr:00DE10E0</span><br><span class="line">[des] delete 00DE10E0</span><br><span class="line">[~ListNode()] 00DE10E0</span><br></pre></td></tr></table></figure>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/04/6428e469f0817.png" alt="image-20230402101147142"></p>
<p>ä½†å¦‚æœæƒ³è¦å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹é“¾æ¥èµ·æ¥ï¼Œé‚£å°±å‡ºbugäº†</p>
<p>é¦–å…ˆï¼Œè‡ªç„¶æ˜¯æˆ‘ä»¬æ²¡åŠæ³•å°†ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆèµ‹å€¼ç»™æ™®é€šçš„æŒ‡é’ˆï¼Œå› ä¸ºç±»å‹ä¸åŒã€‚æˆ‘ä»¬ä¹Ÿä¸èƒ½ç›´æ¥å¯¹å®ƒä»¬è¿›è¡Œå¼ºè½¬</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/04/6428e4f4b85a6.png" alt="image-20230402101413177"></p>
<p>è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å°†<code>listnode</code>ä¸­çš„æŒ‡é’ˆæˆå‘˜ä¹Ÿæ”¹æˆæ™ºèƒ½æŒ‡é’ˆ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span></span><br><span class="line">&#123;</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;T&gt;&gt; _prev;</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;T&gt;&gt; _next;</span><br><span class="line">    T _val;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ListNode</span>(<span class="type">const</span> T&amp; val=<span class="built_in">T</span>())</span><br><span class="line">        :_prev(<span class="literal">nullptr</span>),</span><br><span class="line">        _next(<span class="literal">nullptr</span>),</span><br><span class="line">        _val(val)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ListNode</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[~ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p1</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>));</span><br><span class="line">    mu::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p2</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">    p1-&gt;_next = p2;</span><br><span class="line">    p2-&gt;_prev = p1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡è¿è¡Œï¼Œè¯¶ï¼Œå‡ºé—®é¢˜äº†ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[init] 00000000</span><br><span class="line">[init] 00000000</span><br><span class="line">[ListNode()] 00FFF1B8</span><br><span class="line">[init] 00FFF1B8</span><br><span class="line">[init] 00000000</span><br><span class="line">[init] 00000000</span><br><span class="line">[ListNode()] 00FF8D78</span><br><span class="line">[init] 00FF8D78</span><br><span class="line">[operator=] 00000000</span><br><span class="line">[des] pcount:0 ptr:00000000</span><br><span class="line">[operator=] 00000000</span><br><span class="line">[des] pcount:0 ptr:00000000</span><br><span class="line">[des] pcount:1 ptr:00FF8D78</span><br><span class="line">[des] pcount:1 ptr:00FFF1B8</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶<code>shared_ptr</code>çš„ææ„å‡½æ•°è¢«è°ƒç”¨äº†ï¼Œä½†ç›´åˆ°æœ€åï¼Œéƒ½æ²¡æœ‰æ‰“å°å‡º<code>[des] delete</code>ï¼Œä¹Ÿæ²¡æœ‰è¿›å…¥<code>ListNode</code>çš„ææ„å‡½æ•°ï¼Œå³å‡ºç°äº†å†…å­˜æ³„æ¼ï¼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> _Release()</span><br><span class="line">&#123;</span><br><span class="line">    (*_pcount)--;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[des] pcount:&quot;</span> &lt;&lt; (*_pcount) &lt;&lt; <span class="string">&quot; ptr:&quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span> ((*_pcount) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[des] delete &quot;</span> &lt;&lt; (<span class="type">void</span>*)_ptr &lt;&lt; endl; <span class="comment">// å¦‚æœé‡Šæ”¾äº†èµ„æºï¼Œä¼šæ‰“å°è¿™ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span>(_ptr)<span class="comment">//_pträ¸ä¸ºç©ºçš„æ—¶å€™æ‰é‡Šæ”¾å®ƒ</span></span><br><span class="line">            <span class="keyword">delete</span> _ptr;</span><br><span class="line">        <span class="comment">//æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½éœ€è¦åˆ é™¤è®¡æ•°å™¨ï¼Œå¦åˆ™ä¼šæœ‰å†…å­˜æ³„æ¼</span></span><br><span class="line">        <span class="keyword">delete</span> _pcount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”»ä¸ªå›¾ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯ä¸ºç”š</p>
<ul>
<li>p1ç®¡ç†èµ„æºAï¼Œp2ç®¡ç†èµ„æºBï¼›äºŒè€…å¼•ç”¨è®¡æ•°éƒ½ä¸º1</li>
<li>p1-&gt;next=p2ï¼Œp1-&gt;nextä¹Ÿå¼€å§‹ç®¡ç†èµ„æºBï¼Œå¼•ç”¨è®¡æ•°ä¸º2</li>
<li>p2-&gt;prev=p1ï¼Œp2-&gt;prevä¹Ÿå¼€å§‹ç®¡ç†èµ„æºAï¼Œå¼•ç”¨è®¡æ•°ä¸º2</li>
<li>å‡ºä½œç”¨åŸŸï¼Œå…ˆææ„p2ï¼ŒBå¼•ç”¨è®¡æ•°-1ï¼Œæ­¤æ—¶èµ„æºBæ˜¯åªç”±<code>p1-&gt;next</code>ç®¡ç†çš„</li>
<li>åææ„p1ï¼ŒAå¼•ç”¨è®¡æ•°-1ï¼Œæ­¤æ—¶èµ„æºAæ˜¯åªç”±<code>p2-&gt;prev</code>ç®¡ç†</li>
<li>ä½†æ˜¯<code>p1-&gt;next</code>å¿…é¡»è¦å®Œå…¨ææ„èµ„æºAæ‰ä¼šè¢«é‡Šæ”¾ï¼›åŒç†ï¼Œ<code>p2-&gt;prev</code>ä¹Ÿéœ€è¦å®Œå…¨ææ„èµ„æºBæ‰ä¼šé‡Šæ”¾</li>
</ul>
<p>è¿™æ—¶å€™å°±é™·å…¥äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå› ä¸ºèµ„æºAå’Œèµ„æºBå®é™…ä¸Šå·²ç»<strong>æ²¡æœ‰å¤–äºº</strong>åœ¨ä½¿ç”¨äº†ï¼Œå®ƒä»¬ä¹Ÿæ— æ³•è¢«å½»åº•é‡Šæ”¾æ‰ï¼Œå†…å­˜æ³„æ¼äº†ï¼</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/04/6428e82869304.png" alt="image-20230402102752756"></p>
<h3 id="7-3-è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜">7.3 è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</h3>
<p>è®²åˆ°è¿™é‡Œï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å¾ˆæ˜äº†äº†ã€‚å› ä¸º<code>weak_ptr</code>æ˜¯ä¸è¿›è¡Œå¼•ç”¨è®¡æ•°çš„æ“ä½œçš„ï¼Œå…¶åªå¯¹èµ„æºè¿›è¡Œæ‰˜ç®¡ã€‚æˆ‘ä»¬åªéœ€è¦å°†listnodeä¹‹ä¸­çš„æŒ‡é’ˆä»<code>shared_ptr</code>æ”¹ä¸º<code>weak_ptr</code>å³å¯</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*mu::shared_ptr&lt;ListNode&lt;T&gt;&gt; _prev;</span></span><br><span class="line"><span class="comment">    mu::shared_ptr&lt;ListNode&lt;T&gt;&gt; _next;*/</span></span><br><span class="line"></span><br><span class="line">    std::weak_ptr&lt;ListNode&lt;T&gt;&gt; _next;</span><br><span class="line">    std::weak_ptr&lt;ListNode&lt;T&gt;&gt; _prev;</span><br><span class="line">    T _val;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ListNode</span>(<span class="type">const</span> T&amp; val=<span class="built_in">T</span>())</span><br><span class="line">        :_val(val)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">ListNode</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[~ListNode()] &quot;</span> &lt;&lt; (<span class="type">void</span>*)<span class="keyword">this</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test6</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p1</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">10</span>));</span><br><span class="line">    std::shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">p2</span>(<span class="keyword">new</span> <span class="built_in">ListNode</span>&lt;<span class="type">int</span>&gt;(<span class="number">20</span>));</span><br><span class="line"></span><br><span class="line">    p1-&gt;_next = p2;</span><br><span class="line">    p2-&gt;_prev = p1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶å€™å°±èƒ½æˆåŠŸé‡Šæ”¾èŠ‚ç‚¹äº†ï¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ListNode()] 0117F348</span><br><span class="line">[ListNode()] 01171950</span><br><span class="line">[~ListNode()] 01171950</span><br><span class="line">[~ListNode()] 0117F348</span><br></pre></td></tr></table></figure>
<h3 id="7-4-ç®€å•å®ç°">7.4 ç®€å•å®ç°</h3>
<p>åº“é‡Œé¢çš„å®ç°æ¯”æˆ‘ä»¬è¿™ä¸ªå¤æ‚å¾ˆå¤šï¼Œå®ç°åªæ˜¯ä¸ºäº†ç†è§£è®¾è®¡æ€è·¯</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">weak_ptr</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">weak_ptr</span>()</span><br><span class="line">        :_ptr(<span class="literal">nullptr</span>)</span><br><span class="line">    &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ </span></span><br><span class="line">    <span class="built_in">weak_ptr</span>(<span class="type">const</span> shared_ptr&lt;T&gt;&amp; p)</span><br><span class="line">        :_ptr(p.<span class="built_in">get</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        _ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ‹·è´æ„é€ </span></span><br><span class="line">    <span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&lt;T&gt;&amp; p)</span><br><span class="line">        :_ptr(p._ptr)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="comment">//èµ‹å€¼é‡è½½</span></span><br><span class="line">    weak_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(shared_ptr&lt;T&gt;&amp; p)</span><br><span class="line">    &#123;</span><br><span class="line">        _ptr = p.<span class="built_in">get</span>();</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    weak_ptr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&lt;T&gt;&amp; p)</span><br><span class="line">    &#123;</span><br><span class="line">        _ptr = p._ptr;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    T&amp; <span class="keyword">operator</span>*()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> *_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    T* <span class="keyword">operator</span>-&gt;()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _ptr;</span><br><span class="line">    &#125;</span><br><span class="line">    T&amp; <span class="keyword">operator</span>[](<span class="type">const</span> T&amp; n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _ptr[n];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    T* _ptr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è‡ªå·±ä¹Ÿå®ç°ä¸€ä¸ªç®€å•çš„<code>weak_ptr</code>ï¼Œè¿˜æ˜¯ç”¨ç›¸åŒçš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸè¿›è¡Œäº†ææ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ ListNode()] 00C903C8</span><br><span class="line">[init] 00C903C8</span><br><span class="line">[ ListNode()] 00C90128</span><br><span class="line">[init] 00C90128</span><br><span class="line">[des] pcount:0 ptr:00C90128</span><br><span class="line">[des] delete 00C90128</span><br><span class="line">[~ListNode()] 00C90128</span><br><span class="line">[des] pcount:0 ptr:00C903C8</span><br><span class="line">[des] delete 00C903C8</span><br><span class="line">[~ListNode()] 00C903C8</span><br></pre></td></tr></table></figure>
<h3 id="7-5-æˆå‘˜å‡½æ•°">7.5 æˆå‘˜å‡½æ•°</h3>
<p>å¯¹<a target="_blank" rel="noopener" href="https://legacy.cplusplus.com/reference/memory/weak_ptr/">åº“ä¸­å®ç°çš„weak_ptr</a>çš„æˆå‘˜å‡½æ•°åšä¸€å®šè§£é‡Š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">swap</span> <span class="params">(weak_ptr&amp; x)</span> <span class="keyword">noexcept</span></span>; <span class="comment">// äº¤æ¢ä¸¤ä¸ªweak_ptræ‰˜ç®¡çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span></span>;<span class="comment">// é‡ç½® (ç›¸å½“äºæ¢å¤æˆé»˜è®¤æ„é€ çš„å¯¹è±¡)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›weak_ptrç®¡ç†çš„ç©ºé—´çš„å¼•ç”¨è®¡æ•°ï¼ˆæœ¬èº«ä¸è®¡å…¥ï¼‰</span></span><br><span class="line"><span class="function"><span class="type">long</span> <span class="type">int</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­weak_ptræ˜¯å¦å·²ç»è¿‡æœŸï¼ˆå³ç”¨äºæ„é€ è¿™ä¸ªweak_ptrçš„shared_ptræ˜¯å¦å·²ç»é‡Šæ”¾èµ„æºï¼‰</span></span><br><span class="line"><span class="comment">// å› ä¸ºweak_pträ¸å‚ä¸èµ„æºçš„ç®¡ç†ï¼Œåªè¿›è¡Œæ‰˜ç®¡ã€‚æ‰€ä»¥å¦‚æœshared_ptrå·²ç»å°†ç©ºé—´é‡Šæ”¾ï¼Œé‚£ä¹ˆweak_ptræŒ‡å‘çš„ç©ºé—´å°±å·²ç»è¿‡æœŸäº†ï¼Œä¸èƒ½ç»§ç»­ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœweak_ptræ²¡æœ‰è¿‡æœŸ/ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›å…¶æ‰˜ç®¡çš„shared_ptrå¯¹è±¡</span></span><br><span class="line"><span class="comment">// ç­‰æ•ˆäºè¿”å› expired() ? shared_ptr&lt;T&gt;() : shared_ptr&lt;T&gt;(*this) </span></span><br><span class="line"><span class="comment">// è¯¥å‡½æ•°å…·æœ‰åŸå­æ€§</span></span><br><span class="line"><span class="comment">// https://legacy.cplusplus.com/reference/memory/weak_ptr/lock/</span></span><br><span class="line"><span class="function">shared_ptr&lt;element_type&gt; <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸¤ä¸ªå‡½æ•°å°±æœ‰ç‚¹çœ‹ä¸æ‡‚äº†</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="function"><span class="type">bool</span> <span class="title">owner_before</span> <span class="params">(<span class="type">const</span> weak_ptr&lt;U&gt;&amp; x)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>&gt; <span class="function"><span class="type">bool</span> <span class="title">owner_before</span> <span class="params">(<span class="type">const</span> shared_ptr&lt;U&gt;&amp; x)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">//https://blog.csdn.net/weixin_45590473/article/details/113040456</span></span><br></pre></td></tr></table></figure>
<h3 id="7-6-weak-ptrå’Œå¼•ç”¨è®¡æ•°é—®é¢˜">7.6 weak_ptrå’Œå¼•ç”¨è®¡æ•°é—®é¢˜</h3>
<p>ä¸Šæ–‡å¯¹<code>shared_ptr</code>å’Œ<code>weak_ptr</code>çš„å®ç°åªæ˜¯æœ€åŸºç¡€çš„ä¸€ä¸ªå¤„ç†ï¼Œè¿˜æœ‰å¾ˆå¤šé—®é¢˜æ²¡æœ‰è§£å†³</p>
<ul>
<li>weak_ptré‡Œé¢çœŸçš„æ²¡æœ‰å¼•ç”¨è®¡æ•°å—ï¼Ÿ</li>
</ul>
<p>stdä¸­çš„weak_ptræœ‰ä¸€ä¸ªå‡½æ•°æ˜¯<code>expired()</code>ï¼Œå¦‚æœweak_ptrå†…éƒ¨ä¸å­˜åœ¨å¼•ç”¨è®¡æ•°ï¼Œå®ƒå°±æ²¡æœ‰åŠæ³•åˆ¤æ–­æ‰˜ç®¡çš„å¯¹è±¡æ˜¯å¦å·²ç»è¿‡æœŸã€‚æ‰€ä»¥ç­”æ¡ˆå¾ˆæ˜ç¡®äº†ï¼Œweak_ptré‡Œé¢è‚¯å®šæ˜¯æœ‰ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„ï¼</p>
<p>è¿™å°±ä¼šå¼•å‡ºå¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸Šé¢å®ç°çš„shared_ptrçš„ä»£ç å°±åŒ…å«äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<ul>
<li>å¦‚æœshared_ptrææ„çš„æ—¶å€™å·²ç»å°†å¼•ç”¨è®¡æ•°ç»™deleteäº†ï¼Œweak_ptrè¿˜æ€ä¹ˆåˆ¤æ–­ï¼Ÿ</li>
</ul>
<p>å…¶å®è§£å†³å®ƒå¹¶ä¸éš¾ï¼šç»§ç»­åˆ©ç”¨å¼•ç”¨è®¡æ•°çš„æ€è·¯ï¼Œç»™shared_ptrçš„å¼•ç”¨è®¡æ•°å†ä¸Šä¸€ä¸ªå¼•ç”¨è®¡æ•°ã€‚è¿™é‡Œå°†share_ptrçš„å¼•ç”¨è®¡æ•°è®°ä¸ºcountï¼ˆèµ„æºè¢«å¼•ç”¨çš„è®¡æ•°ï¼‰ï¼Œå¯¹countçš„å¼•ç”¨è®¡æ•°è®°ä¸ºweakï¼ˆå¼•ç”¨è®¡æ•°çš„è®¡æ•°ï¼‰ï¼›</p>
<ul>
<li>å½“shared_ptrå‡ºç°æ‹·è´çš„æ—¶å€™ï¼ŒåŒæ—¶æ“ä½œcountå’Œweakï¼ˆéƒ½ä¼šåŠ åŠ ï¼‰ï¼›</li>
<li>å½“ä»shared_ptræ‹·è´ç»™weak_ptrï¼Œæˆ–è€…weak_pträ¹‹é—´æ‹·è´ï¼Œç»™weakåŠ åŠ ï¼›</li>
<li>å½“shared_ptré”€æ¯çš„æ—¶å€™ï¼ŒåŒæ—¶æ“ä½œcountå’Œweakï¼ˆéƒ½ä¼šå‡å‡ï¼‰ï¼›</li>
<li>å½“countä¸º0çš„æ—¶å€™ï¼Œé”€æ¯æ‰˜ç®¡çš„èµ„æºï¼›</li>
<li>å½“weakä¸º0çš„æ—¶å€™ï¼Œé”€æ¯countï¼ˆç”±weak_ptrå’Œshared_ptråŒæ—¶æ¥ç®¡ç†ï¼‰ï¼›</li>
</ul>
<p>è¿™æ—¶å€™å°±éœ€è¦ä¸¤æŠŠé”äº†ï¼Œ<strong>ä¸€ä¸ªç”¨æ¥é”weakä¸€ä¸ªç”¨æ¥é”count</strong>ï¼Œweak_ptråœ¨æ‹·è´çš„æ—¶å€™åªæ“ä½œweaké”ï¼Œåœ¨è°ƒç”¨<code>expired()</code>å‡½æ•°çš„æ—¶å€™ä¼šè°ƒç”¨counté”æ¥åˆ¤æ–­countæ˜¯å¦ä¸º0ã€‚</p>
<p>å¦‚æœæ˜¯è‡ªä¸»å®ç°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨cppé‡Œé¢æä¾›çš„atmoicåŸå­å˜é‡æ¥æ“ä½œï¼Œé¿å…å®šä¹‰å¤šä¸ªé”çš„éº»çƒ¦ã€‚è¿™é‡Œå¯ä»¥çœ‹çœ‹ç²¾ç®€åçš„mvccæºç ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/680068428">https://zhuanlan.zhihu.com/p/680068428</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼•ç”¨è®¡æ•°ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Ty&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">RefCount</span> &#123;</span><br><span class="line">    std::<span class="type">atomic_int32_t</span> _uses = <span class="number">1</span>;</span><br><span class="line">    std::<span class="type">atomic_int32_t</span> _weaks = <span class="number">1</span>;</span><br><span class="line">    Ty *_ptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// shared_ptrå’Œweak_ptrçš„çˆ¶ç±»</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Ty</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Ptr_base</span> &#123;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">shared_ptr</span>&lt;Ty&gt;;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">weak_ptr</span>&lt;Ty&gt;;</span><br><span class="line">    Ty *_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">    RefCount&lt;Ty&gt; *_ref = <span class="literal">nullptr</span>; <span class="comment">// æ•´ä¸ªéƒ½æ˜¯æŒ‡é’ˆ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„åˆ°è¿™é‡Œï¼Œ<code>_ptr</code> å­˜äº†ä¸¤ä»½ï¼Œä¸€ä¸ªåœ¨counté‡Œé¢ä¸€ä¸ªå°±åœ¨ptrBaseé‡Œé¢ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿ç›´æ¥<code>get()</code>ï¼Œå°‘ä¸€æ¬¡é€šè¿‡RefCountçš„å†…å­˜è®¿é—®ã€‚</p>
<h2 id="8-å®šåˆ¶åˆ é™¤å™¨">8.å®šåˆ¶åˆ é™¤å™¨</h2>
<p>å¯¹äºæˆ‘ä»¬è‡ªå·±å†™çš„<code>shared_ptr</code>ï¼Œæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œææ„çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯å†™æ­»çš„<code>delete</code>ï¼›</p>
<p>å¦‚æœç”¨æˆ·ä¼ å…¥çš„æ˜¯ä¸€ä¸ªæ•°ç»„<code>new int[10]</code>ï¼Œæ­¤æ—¶<code>delete</code>å°±ä¸å¯¹åº”ï¼ˆéœ€è¦ç”¨<code>delete[]</code>)ï¼Œä¼šå‡ºç°é—®é¢˜ï¼ˆä½†ä¸ä¸€å®šä¼šæŠ¥é”™ï¼‰</p>
<p>è¿˜æœ‰äº›æƒ…å†µï¼Œæˆ‘ä»¬æƒ³ç»™æ™ºèƒ½æŒ‡é’ˆä¼ å…¥ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆï¼Œæ­¤æ—¶å°±ä¸èƒ½ç”¨deleteæ¥è¿›è¡Œèµ„æºé‡Šæ”¾äº†ã€‚ä¸ºäº†é¿å…è¿™äº›æƒ…å†µï¼Œæ™ºèƒ½æŒ‡é’ˆå¼•å…¥äº†<strong>å®šåˆ¶åˆ é™¤å™¨</strong></p>
<h3 id="8-1-unique-ptrå’Œshared-ptrçš„ä¸åŒç”¨æ³•">8.1 unique_ptrå’Œshared_ptrçš„ä¸åŒç”¨æ³•</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//non-specialized    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">D</span> = default_delete&lt;T&gt;&gt; <span class="keyword">class</span> unique_ptr;</span><br><span class="line"><span class="comment">//array specialization    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">D</span>&gt; <span class="keyword">class</span> <span class="title class_">unique_ptr</span>&lt;T[],D&gt;;</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚åº“ä¸­<code>unique_ptr</code>çš„æ¨¡æ¿å‚æ•°ä¸­ï¼Œå°±æœ‰ä¸€ä¸ªæ¨¡æ¿å‚æ•°Dç”¨äºæ¥æ”¶ç”¨æˆ·ä¼ å…¥çš„åˆ é™¤å™¨ã€‚è€Œ<code>shared_ptr</code>åˆ™æ˜¯é‡‡ç”¨åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥åˆ é™¤å™¨å¯¹è±¡çš„æ–¹å¼æ¥å®ç°å®šåˆ¶åˆ é™¤</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//with deleter (4)    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">U</span>, <span class="keyword">class</span> <span class="title class_">D</span>&gt; <span class="built_in">shared_ptr</span> (U* p, D del);</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">D</span>&gt; <span class="built_in">shared_ptr</span> (<span class="type">nullptr_t</span> p, D del);</span><br></pre></td></tr></table></figure>
<p>åº“ä¸­é»˜è®¤çš„åˆ é™¤å™¨å¦‚ä¸‹</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//non-specialized    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="keyword">class</span> <span class="title class_">default_delete</span>;</span><br><span class="line"><span class="comment">//array specialization    </span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="keyword">class</span> <span class="title class_">default_delete</span>&lt;T[]&gt;;</span><br></pre></td></tr></table></figure>
<p>å†…éƒ¨é‡‡ç”¨äº†é‡è½½æ“ä½œç¬¦<code>()</code>çš„åŠæ³•ï¼Œæ¥å®ç°ä»¿å‡½æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨çš„æ˜¯<code>delete</code>ï¼Œå¦‚æœæŒ‡å®šäº†æ˜¯æ•°ç»„ç±»å‹ï¼Œåˆ™ä¼šä½¿ç”¨<code>delete[]</code></p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/04/642902e5ec848.png" alt="image-20230402122158558"></p>
<p>å¦‚æœæˆ‘ä»¬è¦å¤„ç†çš„æ˜¯æ–‡ä»¶æŒ‡é’ˆæˆ–è€…mallocçš„å€¼ï¼Œå°±åªéœ€è¦è‡ªå·±ä¼ å…¥ä¸€ä¸ªä»¿å‡½æ•°ï¼ˆå®šåˆ¶åˆ é™¤å™¨ï¼‰å³å¯</p>
<h3 id="8-2-ä½¿ç”¨">8.2 ä½¿ç”¨</h3>
<p>è¿™é‡Œæˆ‘å®šåˆ¶äº†ä¸€ä¸ªfreeçš„åˆ é™¤å™¨ï¼Œå’Œæ–‡ä»¶æŒ‡é’ˆfcloseçš„åˆ é™¤å™¨</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Free</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(T* ptr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[free]  &quot;</span> &lt;&lt; ptr &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Fclose</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(FILE* ptr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[fclose] &quot;</span> &lt;&lt; ptr &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">fclose</span>(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç”¨å¦‚ä¸‹ä»£ç è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unique_ptr&lt;<span class="type">int</span>, default_delete&lt;<span class="type">int</span>[]&gt;&gt; <span class="built_in">up1</span>(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>]);</span><br><span class="line"></span><br><span class="line">unique_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;, default_delete&lt;ListNode&lt;<span class="type">int</span>&gt;[]&gt;&gt; <span class="built_in">up2</span>(<span class="keyword">new</span> ListNode&lt;<span class="type">int</span>&gt;[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line"><span class="function">unique_ptr&lt;FILE, Fclose&gt; <span class="title">up3</span><span class="params">((FILE*)fopen(<span class="string">&quot;test.cpp&quot;</span>, <span class="string">&quot;r&quot;</span>))</span></span>;</span><br><span class="line"></span><br><span class="line">unique_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;, Free&lt;ListNode&lt;<span class="type">int</span>&gt;&gt;&gt; <span class="built_in">up4</span>((ListNode&lt;<span class="type">int</span>&gt;*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(ListNode&lt;<span class="type">int</span>&gt;)));</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸè¿›è¡Œäº†<code>ListNode</code>æ•°ç»„çš„é”€æ¯ï¼Œä»¥åŠmallocã€æ–‡ä»¶æŒ‡é’ˆçš„freeã€å…³é—­æ“ä½œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ ListNode()] 011D5B7C</span><br><span class="line">[ ListNode()] 011D5B88</span><br><span class="line">[free]  011E1070</span><br><span class="line">[fclose] 011D89A8</span><br><span class="line">[~ListNode()] 011D5B88</span><br><span class="line">[~ListNode()] 011D5B7C</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œmallocåˆ›å»ºçš„<code>ListNode&lt;int&gt;</code>ç©ºé—´å¹¶ä¸ä¼šè°ƒç”¨<code>ListNode</code>çš„æ„é€ å‡½æ•°ï¼Œfreeä¹Ÿä¸ä¼šè°ƒç”¨ææ„å‡½æ•°</p>
<hr>
<p>å› ä¸ºshared_ptréœ€è¦é‡‡ç”¨ç±»å¯¹è±¡çš„æ–¹å¼åœ¨æ„é€ å‡½æ•°ä¸­è¿›è¡Œä¼ å‚ã€‚è¿™æ–¹é¢çš„åº•å±‚å®ç°æœ‰äº›å¤æ‚ã€‚éšä¹‹è€Œæ¥çš„å¥½å¤„å°±æ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ª<code>lambda</code>è¡¨è¾¾å¼æ¥ä½œä¸ºåˆ é™¤å™¨ï¼Œé¿å…äº†ä»£ç å†—é•¿ä¹‹åï¼Œæ‰¾ä¸åˆ°æƒ³è¦çš„åˆ é™¤å™¨çš„å®šä¹‰çš„é—®é¢˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// shared_ptréœ€è¦é‡‡ç”¨ä¼ å…¥å¯¹è±¡çš„æ–¹å¼</span></span><br><span class="line">default_delete&lt;ListNode&lt;<span class="type">int</span>&gt;[]&gt; d1;</span><br><span class="line">shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">sp1</span>(<span class="keyword">new</span> ListNode&lt;<span class="type">int</span>&gt;[<span class="number">3</span>], d1);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;###########################&quot;</span> &lt;&lt; endl;</span><br><span class="line">shared_ptr&lt;ListNode&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">sp2</span>(<span class="keyword">new</span> ListNode&lt;<span class="type">int</span>&gt;[<span class="number">3</span>], [](ListNode&lt;<span class="type">int</span>&gt;* ptr)&#123;<span class="keyword">delete</span>[] ptr; &#125;);</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ ListNode()] 0127F1BC</span><br><span class="line">[ ListNode()] 0127F1C8</span><br><span class="line">[ ListNode()] 0127F1D4</span><br><span class="line">###########################</span><br><span class="line">[ ListNode()] 01278D4C</span><br><span class="line">[ ListNode()] 01278D58</span><br><span class="line">[ ListNode()] 01278D64</span><br><span class="line">[~ListNode()] 01278D64</span><br><span class="line">[~ListNode()] 01278D58</span><br><span class="line">[~ListNode()] 01278D4C</span><br><span class="line">[~ListNode()] 0127F1D4</span><br><span class="line">[~ListNode()] 0127F1C8</span><br><span class="line">[~ListNode()] 0127F1BC</span><br></pre></td></tr></table></figure>
<h2 id="9-æ€»ç»“">9.æ€»ç»“</h2>
<table>
<thead>
<tr>
<th>æ™ºèƒ½æŒ‡é’ˆ</th>
<th>æ‹·è´ç‰¹ç‚¹</th>
<th>å®šåˆ¶åˆ é™¤å™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>auto_ptr(C++98)</td>
<td>ç®¡ç†æƒè½¬ç§»ã€‚å¤åˆ¶åï¼ŒåŸæœ‰å¯¹è±¡å¤±æ•ˆï¼Œä½¿ç”¨åŸæœ‰å¯¹è±¡ä¼šæ®µé”™è¯¯ã€‚</td>
<td>-</td>
</tr>
<tr>
<td>unique_ptr(scpoed_ptr)</td>
<td>ç¦æ­¢æ‹·è´ï¼Œä½†æ˜¯å¯ä»¥è¢«moveã€‚</td>
<td>ä½¿ç”¨æ¨¡æ¿å‚æ•°æ¥ä¼ å…¥å®šåˆ¶åˆ é™¤å™¨</td>
</tr>
<tr>
<td>shared_ptr</td>
<td>æ”¯æŒæ‹·è´ï¼Œé‡‡ç”¨å¼•ç”¨è®¡æ•°ï¼Œä½†æ˜¯ä¼šæœ‰å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚</td>
<td>åœ¨æ„é€ å‡½æ•°ä¸­ä¼ å…¥åˆ é™¤å™¨å¯¹è±¡</td>
</tr>
<tr>
<td>weak_ptr</td>
<td>æ”¯æŒæ‹·è´ï¼Œåªç”¨äºæ‰˜ç®¡æŒ‡é’ˆï¼Œä¸å‚ä¸æŒ‡é’ˆç©ºé—´çš„é‡Šæ”¾ï¼Œä¸è®¡å…¥å¼•ç”¨è®¡æ•°ã€‚ç”¨äºè§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚ï¼ˆæ³¨æ„ä¸è®¡å…¥å¼•ç”¨è®¡æ•°ä¸ä»£è¡¨æ²¡æœ‰å¼•ç”¨è®¡æ•°ï¼‰</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="The-end">The end</h2>
<p>æ™ºèƒ½æŒ‡é’ˆçš„åŸºæœ¬ç”¨æ³•åˆ°è¿™é‡Œå°±overäº†ï¼Œäº†è§£æ™ºèƒ½æŒ‡é’ˆçš„åŒæ—¶ï¼Œéœ€è¦ç†ŸçŸ¥RAIIæ€æƒ³ã€‚åœ¨ä¸å°‘ç±»çš„è®¾è®¡ä¸­ï¼Œéƒ½ä¼šç”¨åˆ°è¿™ä¸ªæ€æƒ³ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">æ…•é›ªå¹´å</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/1282431418/">https://blog.musnow.top/posts/1282431418/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://blog.musnow.top" target="_blank">æ…•é›ªçš„å¯’èˆ</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Cpp/">Cpp</a><a class="post-meta__tags" href="/tags/%E7%B1%BB%E5%92%8C%E5%AF%B9%E8%B1%A1/">ç±»å’Œå¯¹è±¡</a></div><div class="post-share"><div class="social-share" data-image="https://img.musnow.top/i/2023/04/6427d4dd5855b.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>èµåŠ©</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://ifdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.webp" alt="çˆ±å‘ç”µ"/></a><div class="post-qr-code-desc">çˆ±å‘ç”µ</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/1758576550/" title="ã€æ—¥å¿—ã€‘åˆæ‹äº‘CDNè¢«æ¶æ„è¯·æ±‚"><img class="cover" src="https://img.musnow.top/i/2023/03/6424f0c047909.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">ã€æ—¥å¿—ã€‘åˆæ‹äº‘CDNè¢«æ¶æ„è¯·æ±‚</div></div><div class="info-2"><div class="info-item-1">è‡ª23.03.23èµ·ï¼Œå›¾åºŠCDNé­åˆ°äº†æŒç»­ä¸€å‘¨çš„æ¶æ„è¯·æ±‚ï¼</div></div></div></a><a class="pagination-related" href="/posts/577382991/" title="ã€MySQLã€‘å®‰è£…å’ŒåŸºç¡€ç¯å¢ƒé…ç½®"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">ã€MySQLã€‘å®‰è£…å’ŒåŸºç¡€ç¯å¢ƒé…ç½®</div></div><div class="info-2"><div class="info-item-1">åœ¨æœ¬åœ°å®‰è£…mysqlï¼Œä»¥mariadbä¸ºä¾‹</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/2582381960/" title="ã€C++ã€‘ç±»å’Œå¯¹è±¡1ï¼šåˆè¯†ç±»+thisæŒ‡é’ˆ"><img class="cover" src="/img/bg/gm6.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-19</div><div class="info-item-2">ã€C++ã€‘ç±»å’Œå¯¹è±¡1ï¼šåˆè¯†ç±»+thisæŒ‡é’ˆ</div></div><div class="info-2"><div class="info-item-1">ä¸çŸ¥ä½ åœ¨å­¦ä¹ Cè¯­è¨€å’ŒC++çš„é€‚åˆï¼Œæ›¾å¦å¬è¿‡è€å¸ˆè¿™ä¹ˆè®²è¿°è¿™ä¸¤ä¸ªè¯­è¨€ä¹‹é—´çš„åŒºåˆ«ï¼š  Cè¯­è¨€æ˜¯é¢å‘è¿‡ç¨‹çš„ C++æ˜¯é¢å‘å¯¹è±¡çš„   æˆ‘ä¸€ç›´ä¸å¤ªç†è§£è¿™äºŒè€…ä¹‹é—´çš„åŒºåˆ«ï¼Œåœ¨æŸ¥é˜…äº†ä¸€äº›åšå®¢åï¼Œå‘ç°äº†ä¸€ä¸ªæ¯”è¾ƒå¥½çš„è§£é‡ŠğŸ‘‰ã€ä¼ é€é—¨ã€‘  ç”¨é¢å‘è¿‡ç¨‹çš„æ–¹æ³•å†™å‡ºæ¥çš„ç¨‹åºæ˜¯ä¸€ä»½è›‹ç‚’é¥­ï¼Œè€Œç”¨é¢å‘å¯¹è±¡å†™å‡ºæ¥çš„ç¨‹åºæ˜¯ä¸€ä»½ç›–æµ‡é¥­ã€‚æ‰€è°“ç›–æµ‡é¥­ï¼ŒåŒ—äº¬å«ç›–é¥­ï¼Œä¸œåŒ—å«çƒ©é¥­ï¼Œå¹¿ä¸œå«ç¢Ÿå¤´é¥­ï¼Œå°±æ˜¯åœ¨ä¸€ç¢—ç™½ç±³é¥­ä¸Šé¢æµ‡ä¸Šä¸€ä»½ç›–èœï¼Œä½ å–œæ¬¢ä»€ä¹ˆèœï¼Œä½ å°±æµ‡ä¸Šä»€ä¹ˆèœã€‚  æœ¬ç¯‡åšå®¢ï¼Œå°±è®©æˆ‘ä»¬ä»ç±»å’Œå¯¹è±¡å¼€å§‹ï¼Œæ¸æ¸äº†è§£ä»€ä¹ˆæ˜¯â€œé¢å‘å¯¹è±¡ç¼–ç¨‹â€  æ„Ÿè°¢ä½ å…³æ³¨æ…•é›ªï¼Œæ¬¢è¿æ¥æˆ‘çš„å¯’èˆååâ„æ…•é›ªçš„å¯’èˆ   [TOC] 1.ç±»çš„å¼•å…¥ 1.1ç»“æ„ä½“ åœ¨Cè¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰è‡ªå®šä¹‰ç±»å‹ï¼šç»“æ„ä½“ã€‚åœ¨C++ä¸­å¯¹ç»“æ„ä½“çš„è¯­æ³•è¿›è¡Œäº†æ‰©å……ï¼Œç»“æ„ä½“å†…éƒ¨ä¸ä»…èƒ½å®šä¹‰å˜é‡ï¼Œè¿˜èƒ½å®šä¹‰å‡½æ•° 12345678910struct Student&#123;    void Print()    &#123;        cout&lt;&lt;_name&lt;&lt;&quot; &quot;&lt;&lt;_sex&lt;&lt;&quot;...</div></div></div></a><a class="pagination-related" href="/posts/2894176175/" title="ã€C++ã€‘ç±»å’Œå¯¹è±¡2ï¼šé»˜è®¤æˆå‘˜å‡½æ•°+æ“ä½œç¬¦é‡è½½"><img class="cover" src="/img/bg/gm7.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-20</div><div class="info-item-2">ã€C++ã€‘ç±»å’Œå¯¹è±¡2ï¼šé»˜è®¤æˆå‘˜å‡½æ•°+æ“ä½œç¬¦é‡è½½</div></div><div class="info-2"><div class="info-item-1">æœ¬ç¯‡æ˜¯ç±»å’Œå¯¹è±¡çš„ç¬¬äºŒç«™ğŸšŒ ä¸»è¦è®²è¿°ç±»çš„å‡ ä¸ªé»˜è®¤æˆå‘˜å‡½æ•°ï¼Œä»¥åŠæ“ä½œç¬¦é‡è½½ æœ¬ç¯‡åšå®¢ä¼šæ¶‰åŠåˆ°å¾ˆå¤šä¹‹å‰C++ä¸“æ é‡Œé¢æåˆ°çš„çŸ¥è¯†ç‚¹ï¼Œå»ºè®®è¿èµ·æ¥è§‚çœ‹ã€‚   æ„Ÿè°¢ä½ å…³æ³¨æ…•é›ªï¼Œæ¬¢è¿æ¥æˆ‘çš„å¯’èˆååâ„æ…•é›ªçš„å¯’èˆ   [TOC] é»˜è®¤æˆå‘˜å‡½æ•° å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œå³ä¾¿ç±»é‡Œé¢å•¥éƒ½ä¸æ”¾ï¼Œéƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸‹é¢6ä¸ªé»˜è®¤æˆå‘˜å‡½æ•°  å®ƒä»¬éƒ½æœ‰å•¥åŠŸèƒ½å‘¢ï¼Ÿä¸”å¬æˆ‘ä¸€ä¸€é“æ¥ 1.æ„é€ å‡½æ•° ä¼—æ‰€å‘¨å‘¨çŸ¥ï¼Œå½“æˆ‘ä»¬å†™Cè¯­è¨€çš„é¡ºåºè¡¨ã€é“¾è¡¨ç­‰ä»£ç çš„æ—¶å€™ï¼Œä¸€èˆ¬éƒ½ä¼šå†™ä¸€ä¸ªInitå‡½æ•°æ¥åˆå§‹åŒ–å†…å®¹ã€‚ 123456void Init()&#123;    a=(int*)malloc(sizeof(int)*4);    size=0;   ...</div></div></div></a><a class="pagination-related" href="/posts/3040822590/" title="ã€C++ã€‘å¿«é€Ÿå­¦ä¹ ç±»å’Œå¯¹è±¡ï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†"><img class="cover" src="/img/bg/gm12.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-30</div><div class="info-item-2">ã€C++ã€‘å¿«é€Ÿå­¦ä¹ ç±»å’Œå¯¹è±¡ï¼Œçœ‹è¿™ä¸€ç¯‡å°±å¤Ÿäº†</div></div><div class="info-2"><div class="info-item-1">æœ¬ç¯‡åšå®¢æ˜¯å­¦æ ¡å¤§ä¸€ä¸‹C++æœŸæœ«è€ƒå¯Ÿçš„è¦æ±‚ï¼ŒåŒ…å«äº†C++ä¸­ç±»å’Œå¯¹è±¡çš„å¤§éƒ¨åˆ†å†…å®¹ï¼Œé€‚åˆå­¦ä¹ ç±»å’Œå¯¹è±¡çš„ä½ è§‚çœ‹ã€‚æœ€åè¿˜æœ‰ä¸¤ä¸ªå°é¡¹ç›®ï¼Œç»¼åˆäº†ç»å¤§éƒ¨åˆ†ç±»å’Œå¯¹è±¡çš„çŸ¥è¯†ï¼Œå¾ˆé€‚åˆç»ƒæ‰‹+æ·±åŒ–å­¦ä¹ ã€‚  ä¸ºäº†é¿å…è¢«åŒæ ¡copyï¼Œæœ¬ç¯‡åšå®¢åªåœ¨æˆ‘çš„HEXOä¸ªäººåšå®¢ä¸Šå‘å¸ƒ ç¬¬ä¸€ç«  ç»ªè®º 1.1 é¢å‘å¯¹è±¡ç¨‹åºç‰¹ç‚¹ä¸ç›®æ ‡ é¢å‘å¯¹è±¡æœ‰ä¸‹é¢å‡ ä¸ªç‰¹å¾ï¼š  ç±»ä¸å¯¹è±¡ï¼šæŠŠç°å®ä¸–ç•Œä¸­çš„æŸä¸€ç±»ä¸œè¥¿ï¼Œæå–å‡ºæ¥ï¼Œç”¨ä»£ç è¡¨ç¤ºï¼› å°è£…æ€§ï¼šæŠŠè¿‡ç¨‹å’Œæ•°æ®å°è£…åˆ°ä¸€ä¸ªåŒ…è£¹é‡Œé¢ï¼Œå¯¹æ•°æ®çš„è®¿é—®åªèƒ½é€šè¿‡å…¬å¼€æƒé™çš„å‡½æ•°æ¥å£æ¥è¿›è¡Œæ“ä½œï¼› ç»§æ‰¿æ€§ï¼šä¸€ç§è”ç»“ç±»çš„å±‚æ¬¡æ¨¡å‹ï¼Œç±»ä¼¼æ ‘çŠ¶ç»“æ„ï¼› å¤šæ€æ€§ï¼šå…è®¸ä¸åŒç±»çš„å¯¹è±¡å¯¹åŒä¸€æ¶ˆæ¯åšå‡ºå“åº”ï¼Œç”¨ä¸åŒçš„æ–¹æ³•æ¥è§£å†³ä¸€ä¸ªé—®é¢˜ã€‚  å…¶ä¸­ å°è£…ã€ç»§æ‰¿ã€å¤šæ€ è¢«ç§°ä¸ºé¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§ é€šè¿‡è¿™äº›ç‰¹å¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å¾—åˆ°ï¼Œå…¶å®é¢å‘å¯¹è±¡çš„ç¨‹åºä¹Ÿæ˜¯åœ¨Cè¯­è¨€çš„é¢å‘è¿‡ç¨‹çš„åŸºç¡€ä¸Šå¾—æ¥çš„ã€‚å…¶ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„æœåŠ¡æŸä¸€ä¸ªå…·ä½“çš„é—®é¢˜ï¼Œå¹¶é€šè¿‡è¿™ä¸ªé—®é¢˜è¡ç”Ÿå‡ºä¸åŒçš„è§£é¢˜æ–¹æ³•ï¼Œå¹¶ç”¨ä»£ç æ¥è¡¨ç¤ºè§£å†³ä¸€ä¸ªé—®é¢˜å¯¹è±¡çš„è¿‡ç¨‹ã€‚ 1.2 é¢å‘å¯¹è±¡ç¨‹åºçŸ¥è¯†æ¶æ„   ç¬¬äºŒç«  é¢å‘ç¨‹åºå¯¹è±¡å…³é”®æ”¯æ’‘æŠ€æœ¯ 2.1...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">æ…•é›ªå¹´å</div><div class="author-info-description">çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">460</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">76</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="ä¸ªäººä¸»é¡µ"><i class="fa fa-home"></i></a><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="å¯¼èˆªç«™ç‚¹"><i class="fas fa-server"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss-square"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æ¬¢è¿æ¥åˆ°å¯’èˆï¼Œè¿‘æ¥å¯å¥½ï¼Ÿ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%83%85%E6%99%AF"><span class="toc-text">1.æƒ…æ™¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%A3%E7%A0%81%E5%A4%AA%E9%95%BF%EF%BC%8C%E7%9C%8B%E4%B8%8D%E5%88%B0%E5%A4%B4"><span class="toc-text">1.1 ä»£ç å¤ªé•¿ï¼Œçœ‹ä¸åˆ°å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BC%82%E5%B8%B8%E5%AE%89%E5%85%A8"><span class="toc-text">1.2 å¼‚å¸¸å®‰å…¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88"><span class="toc-text">2.æ™ºèƒ½æŒ‡é’ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-RAII"><span class="toc-text">2.1 RAII</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-demo"><span class="toc-text">3.demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%9F%BA%E7%A1%80%E7%A4%BA%E4%BE%8B"><span class="toc-text">3.1 åŸºç¡€ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E8%BF%90%E7%AE%97%E7%AC%A6%E9%87%8D%E8%BD%BD"><span class="toc-text">3.2 è¿ç®—ç¬¦é‡è½½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%8B%B7%E8%B4%9D"><span class="toc-text">3.3 æ‹·è´</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-auto-ptr"><span class="toc-text">4.auto_ptr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-unique-ptr"><span class="toc-text">5.unique_ptr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%9F%BA%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="toc-text">5.1 åŸºæœ¬è¯´æ˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%8F%AF%E4%BB%A5%E8%A2%ABmove%E5%90%97%EF%BC%9F"><span class="toc-text">5.2 å¯ä»¥è¢«moveå—ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-shared-ptr"><span class="toc-text">6.shared_ptr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0"><span class="toc-text">6.1 å¼•ç”¨è®¡æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="toc-text">6.2 å¦‚ä½•å®ç°ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E8%B5%8B%E5%80%BC"><span class="toc-text">6.3 èµ‹å€¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">6.4 ç®€å•å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E6%B5%8B%E8%AF%95"><span class="toc-text">6.5 æµ‹è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-text">6.6 çº¿ç¨‹å®‰å…¨é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-text">6.7 å¾ªç¯å¼•ç”¨é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-make-shared%E5%92%8C%E7%9B%B4%E6%8E%A5%E6%9E%84%E9%80%A0shared-ptr%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">6.8 make_sharedå’Œç›´æ¥æ„é€ shared_ptrçš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-weak-ptr"><span class="toc-text">7.weak_ptr</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E7%AE%80%E4%BB%8B"><span class="toc-text">7.1 ç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8"><span class="toc-text">7.2 ä»€ä¹ˆæ˜¯å¾ªç¯å¼•ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8%E9%97%AE%E9%A2%98"><span class="toc-text">7.3 è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0"><span class="toc-text">7.4 ç®€å•å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-text">7.5 æˆå‘˜å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-weak-ptr%E5%92%8C%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E9%97%AE%E9%A2%98"><span class="toc-text">7.6 weak_ptrå’Œå¼•ç”¨è®¡æ•°é—®é¢˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%AE%9A%E5%88%B6%E5%88%A0%E9%99%A4%E5%99%A8"><span class="toc-text">8.å®šåˆ¶åˆ é™¤å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-unique-ptr%E5%92%8Cshared-ptr%E7%9A%84%E4%B8%8D%E5%90%8C%E7%94%A8%E6%B3%95"><span class="toc-text">8.1 unique_ptrå’Œshared_ptrçš„ä¸åŒç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E4%BD%BF%E7%94%A8"><span class="toc-text">8.2 ä½¿ç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%80%BB%E7%BB%93"><span class="toc-text">9.æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-end"><span class="toc-text">The end</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/5899307553/" title="ã€Hexoã€‘ä¸ºè‡ªå·±çš„åšå®¢ç«™ç‚¹åŠ ä¸Šç¦»çº¿çš„AIæ‘˜è¦">ã€Hexoã€‘ä¸ºè‡ªå·±çš„åšå®¢ç«™ç‚¹åŠ ä¸Šç¦»çº¿çš„AIæ‘˜è¦</a><time datetime="2025-10-02T01:08:21.000Z" title="å‘è¡¨äº 2025-10-02 09:08:21">2025-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4044218607/" title="ã€Agent.04ã€‘AIæ—¶ä»£çš„hello worldï¼šè°ƒç”¨OpenAIæ¥å£ï¼Œä¸å¤§æ¨¡å‹äº¤äº’">ã€Agent.04ã€‘AIæ—¶ä»£çš„hello worldï¼šè°ƒç”¨OpenAIæ¥å£ï¼Œä¸å¤§æ¨¡å‹äº¤äº’</a><time datetime="2025-09-30T07:25:08.000Z" title="å‘è¡¨äº 2025-09-30 15:25:08">2025-09-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3454235760/" title="ã€é¢è¯•ã€‘æ±‚èŒé¢è¯•å¤§å¿Œï¼šè‡ªæ–­åè·¯">ã€é¢è¯•ã€‘æ±‚èŒé¢è¯•å¤§å¿Œï¼šè‡ªæ–­åè·¯</a><time datetime="2025-09-29T11:31:10.000Z" title="å‘è¡¨äº 2025-09-29 19:31:10">2025-09-29</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4200815612/" title="ã€AIã€‘é…ç½®claude-code-routerè½¬å‘Claude Codeè¯·æ±‚è‡³OpenAI APIæ ¼å¼">ã€AIã€‘é…ç½®claude-code-routerè½¬å‘Claude Codeè¯·æ±‚è‡³OpenAI APIæ ¼å¼</a><time datetime="2025-09-27T12:33:46.000Z" title="å‘è¡¨äº 2025-09-27 20:33:46">2025-09-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/main/mothra.webp);"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By æ…•é›ªå¹´å</div><div class="footer_custom_text"><img src="/img/ico/gonganbeian.png" height="15" style="position:relative; top:2px;">&nbsp;<a href="https://beian.mps.gov.cn/#/query/webSearch?code=44190002007715" rel="noreferrer" target="_blank">ç²¤å…¬ç½‘å®‰å¤‡44190002007715</a></br><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="/img/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4.svg" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="/img/badge/-SITEMAP-00CDCD.svg" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="/img/badge/%E7%B2%A4ICP%E5%A4%872023007189-red.svg" height="20px"></a></br><a href="https://travel.moe/go.html" target="_blank"><img src="/img/ico/moe-default-white.png" style="width:auto;height:25px" title="å¼‚æ¬¡å…ƒä¹‹æ—…-è·ƒè¿-æˆ‘ä»¬ä¸€èµ·å»èŒç«™æˆå‘˜çš„æ˜Ÿçƒæ—…è¡Œå§ï¼"></a>&nbsp<a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = '/pluginsSrc/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('/pluginsSrc/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let artalkItem = null
  const option = null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'

  const destroyArtalk = () => {
    if (artalkItem) {
      artalkItem.destroy()
      artalkItem = null
    }
  }

  const artalkChangeMode = theme => artalkItem && artalkItem.setDarkMode(theme === 'dark')

  const initArtalk = (el = document, pageKey = location.pathname) => {
    artalkItem = Artalk.init({
      el: el.querySelector('#artalk-wrap'),
      server: 'https://artk.musnow.top',
      site: 'mublog',
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      ...option,
      pageKey: isShuoshuo ? pageKey : (option && option.pageKey) || pageKey
    })

    if (GLOBAL_CONFIG.lightbox === 'null') return
    artalkItem.on('list-loaded', () => {
      artalkItem.ctx.get('list').getCommentNodes().forEach(comment => {
        const $content = comment.getRender().$content
        btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
      })
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyArtalk = () => {
        destroyArtalk()
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    btf.addGlobalFn('pjaxSendOnce', destroyArtalk, 'destroyArtalk')
    btf.addGlobalFn('themeChange', artalkChangeMode, 'artalk')
  }

  const loadArtalk = async (el, pageKey) => {
    if (typeof Artalk === 'object') initArtalk(el, pageKey)
    else {
      await btf.getCSS('/pluginsSrc/artalk/dist/Artalk.css')
      await btf.getScript('/pluginsSrc/artalk/dist/Artalk.js')
      initArtalk(el, pageKey)
    }
  }

  if (isShuoshuo) {
    'Artalk' === 'Artalk'
      ? window.shuoshuoComment = { loadComment: loadArtalk }
      : window.loadOtherComment = loadArtalk
    return
  }

  if ('Artalk' === 'Artalk' || !false) {
    if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
    else setTimeout(loadArtalk, 100)
  } else {
    window.loadOtherComment = loadArtalk
  }
})()</script></div><script src="/js/domain_check.js"></script><script>document.addEventListener('DOMContentLoaded',()=>{if(window.location.pathname.includes('/posts')){const e=document.querySelector('.footnotes');e&&e.insertBefore(document.createElement('strong').appendChild(document.createTextNode('è„šæ³¨ï¼š')).parentNode,e.firstChild);}});</script><script id="click-heart" src="/pluginsSrc/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>