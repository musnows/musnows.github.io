<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>【MySQL】事务 | 慕雪的寒舍</title><meta name="author" content="慕雪年华"><meta name="copyright" content="慕雪年华"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="事务的学习"><meta property="og:type" content="article"><meta property="og:title" content="【MySQL】事务"><meta property="og:url" content="https://blog.musnow.top/posts/2200233148/index.html"><meta property="og:site_name" content="慕雪的寒舍"><meta property="og:description" content="事务的学习"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.musnow.top/i/2023/04/64302610057ae.png"><meta property="article:published_time" content="2023-09-10T00:52:14.000Z"><meta property="article:modified_time" content="2024-05-16T07:40:30.000Z"><meta property="article:author" content="慕雪年华"><meta property="article:tag" content="Linux"><meta property="article:tag" content="mysql"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.musnow.top/i/2023/04/64302610057ae.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/2200233148/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"距离上次更新本文已经过去了","messageNext":"天，文章部分内容可能已经过时，请注意甄别"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":420},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":600,"languages":{"author":"作者: 慕雪年华","link":"链接: ","source":"来源: 慕雪的寒舍","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"【MySQL】事务",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-05-16 15:40:30"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/equipment/equipment.css?1"><script>!function(r){"use strict";!function(){var t=window,s=document,e=r,c="".concat("https:"===s.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),i=s.createElement("script"),n=s.getElementsByTagName("script")[0];i.type="text/javascript",i.setAttribute("charset","UTF-8"),i.async=!0,i.src=c,i.id="LA_COLLECT",e.d=i;function o(){t.LA.ids.push(e)}t.LA?t.LA.ids&&o():(t.LA=r,t.LA.ids=[],o()),n.parentNode.insertBefore(i,n)}()}({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="慕雪的寒舍" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/favicon.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">373</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 友链文章</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url(https://img.musnow.top/i/2023/04/64302610057ae.png)"><nav id="nav"><span id="blog-info"><a href="/" title="慕雪的寒舍"><img class="site-icon" src="/favicon.jpg"><span class="site-name">慕雪的寒舍</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 友链文章</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【MySQL】事务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-10T00:52:14.000Z" title="发表于 2023-09-10 08:52:14">2023-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-16T07:40:30.000Z" title="更新于 2024-05-16 15:40:30">2024-05-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">编程学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E5%BA%93SQL/">数据库SQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>41分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title="【MySQL】事务"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>学习了之后，你会对MySQL如何进行数据的访问控制有更深刻的了解；</p><span id="more"></span><p>本文中有大量截图，如果出现404的图片，请评论告知，谢谢；</p><h1 id="1-什么是事务？"><a href="#1-什么是事务？" class="headerlink" title="1.什么是事务？"></a>1.什么是事务？</h1><h2 id="1-1-场景举例"><a href="#1-1-场景举例" class="headerlink" title="1.1 场景举例"></a>1.1 场景举例</h2><h3 id="1-1-1-转账"><a href="#1-1-1-转账" class="headerlink" title="1.1.1 转账"></a>1.1.1 转账</h3><p>当A需要给B转账50元的时候，后台应该进行如何处理？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 先判断用户还有多少余额（这里的user_id=A只是一个示例，知道什么意思就行）</span></span><br><span class="line"><span class="keyword">select</span> money <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> user_id<span class="operator">=</span>A;</span><br><span class="line"><span class="comment">-- 如果余额充足，那就给A扣50</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> money <span class="operator">=</span> money <span class="operator">-</span> <span class="number">50</span> <span class="keyword">where</span> user_id<span class="operator">=</span>A;</span><br><span class="line"><span class="comment">-- 然后给B加50</span></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> money <span class="operator">=</span> money <span class="operator">+</span> <span class="number">50</span> <span class="keyword">where</span> user_id<span class="operator">=</span>B;</span><br></pre></td></tr></table></figure><p>这一个操作，需要3个SQL语句才能完成，但很明显，我们即便在当前的服务器端对这3条语句的操作进行加锁，也没有办法避免如下的情况</p><ul><li>服务器负载过高，进程被kill了</li><li>服务器断电了</li><li>MySQL服务器抽风挂掉了</li><li>等等不可抗力</li></ul><p>这时候，如果在执行第一条查询语句后就挂掉了，那还不会有啥问题；但如果是在执行完毕第二条扣钱的语句之后挂掉了，那问题就大了！</p><ul><li>A给B转钱，A的钱扣了，B的钱没有加，这怎么可以？</li></ul><p>最终还需要程序员通过MySQL的日志一个个核对到底是谁出现了这样的情况，给人家把钱加回去，那太过麻烦；在数据量大的时候，这种工作更是不应该由人工手动完成的！</p><p>所以，MySQL就需要提供一种方法，让我们能够实现类似原子性的操作。在执行这3条语句的时候，<strong>只能出现两种情况</strong>：</p><ul><li>成功执行，A扣了钱，B也加了钱，转账成功；</li><li>执行失败，但是A和B的钱都没有变化，并告知用户转账失败；</li></ul><p>这样才是靠谱的结果！</p><h3 id="1-1-2-卖票"><a href="#1-1-2-卖票" class="headerlink" title="1.1.2 卖票"></a>1.1.2 卖票</h3><p>另外<span id="jump1">一个场景</span>就是卖票，其也包含了多条SQL</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> ticket <span class="keyword">where</span> tid<span class="operator">=</span>?; <span class="comment">-- 查询某某车次高铁的票还有没有余量</span></span><br><span class="line"><span class="comment">-- 有余量，进行售卖流程；这里可能要操作另外一张表来添加买票者的用户信息</span></span><br><span class="line"><span class="keyword">update</span> ticket <span class="keyword">set</span> num<span class="operator">=</span>num<span class="number">-1</span> <span class="keyword">where</span> tid<span class="operator">=</span>?; <span class="comment">-- 售卖流程结束，扣去这张票</span></span><br></pre></td></tr></table></figure><p>如果有两个客户端都同时来执行这两条SQL语句，那么就会出现问题；</p><ul><li>只剩一张票</li><li>客户端A进行查询，发现有票，开始执行卖票流程</li><li>客户端B进行查询，也发现有票，开始执行卖票流程</li><li>此时A执行完毕，将票的数量-1，卖完票了；</li><li>随后B执行完毕，也将票的数量-1，此时就会出现票数是负数的情况！</li><li>更难受的是，同一张票被错误地卖给了两个用户！</li></ul><p>这时候在客户端里面加锁是不顶用的，两个客户端都不是同一个进程，锁无法共享；需要MySQL解决这个问题，就还得提供更加严格的访问控制，在A没有完成整个卖票逻辑，票数没有扣掉的情况下，<strong>B不可以来查询票数</strong>；</p><h2 id="1-2-事务的介绍-ACID"><a href="#1-2-事务的介绍-ACID" class="headerlink" title="1.2 事务的介绍 ACID"></a>1.2 事务的介绍 ACID</h2><p>事务（transaction）就是一组DML语句的集合，这些语句在逻辑上是一个整体；执行这组语句，必须全部成功，亦或者是全部失败。</p><blockquote><p>在数据库中，<strong>并发控制的基本单位</strong>是<strong>事务</strong>。</p></blockquote><p>在执行这组SQL的时候，MySQL需要将其视作一个原子性的操作；这个操作不能被其他事务打断，出现问题的时候还需要回滚到开始执行之前的初始状态；事务还能使不同客户端看到的数据是不同的，不同事务之间的操作不会相互影响；只有事务结束后，双方才能看到对方的操作（根据隔离级别不同，这点也会有区别）；</p><p>正如上面的两个场景所提到的操作，同一个时刻对于MySQL的一个数据库来说，其可能有多个客户端进行不同业务的操作，如果都在访问同一个表，在不加访问控制的情况下，一定会出现访问临界资源的数据二义性问题。</p><blockquote><p>事务的出现，是客户端在实际应用场景下的需要，</p></blockquote><p>所以，一个完整的事务，除了是多条DML语句的集合，还需要满足下面4个特性</p><ul><li>原子性：<strong>一个事务中的所有操作，要么全部完成，要么全部失败</strong>；如果事务在执行过程中发现错误，那就需要回滚（Rollback）到事务开始之前的状态，就好比这个事务并没有执行过一般</li><li>一致性：<strong>事务开始之前和结束后，数据库的完整性没有被破坏</strong>。进行的操作复合我们预设的要求；这包含数据的准确度、串联性以及后续数据库可以自发完成预定的工作；</li><li>隔离性：数据库允许多个<strong>并发事务</strong>同时对数据库中的数据进行CURD操作，隔离性保证这些事务之间的操作并不会由于并发的交叉运行而出现不一致的情况。事务隔离性分为不同级别，具体的区别会在后文详解<ul><li>读未提交（Read Uncommitted）</li><li>读已提交（Read Committed）</li><li>可重复读（Repeatble Read）</li><li>串行化（Serializable）</li></ul></li><li>持久性：事务处理完毕后，<strong>对事务的修改是永久的</strong>，即便系统宕机了也不会丢失（除非硬盘坏了）</li></ul><p>上面的四个属性，简称为ACID；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原子性（Atomicity，或称不可分割性）</span><br><span class="line">一致性（Consistency）</span><br><span class="line">隔离性（Isolation，又称独立性）</span><br><span class="line">持久性（Durability）</span><br></pre></td></tr></table></figure><p>其中，一致性是由原子性、隔离性、持久性来保证的，只要满足了这三个性质，自然能实现一致性。简单记忆，AID来保证C；另外还有个知识点：<strong>数据库的完整性是指数据的正确性和一致性</strong>。</p><h2 id="1-3-事务的存储引擎支持"><a href="#1-3-事务的存储引擎支持" class="headerlink" title="1.3 事务的存储引擎支持"></a>1.3 事务的存储引擎支持</h2><p>在MySQL中，只有<code>Innodb</code>支持事务，<code>MyISAM</code>是不支持事务的；</p><p>我们可以用如下语句来查询MySQL的引擎和支持的特性</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]<span class="operator">&gt;</span> <span class="keyword">show</span> engines \G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MEMORY</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MRG_MyISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Collection <span class="keyword">of</span> identical MyISAM tables</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: CSV</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Stores tables <span class="keyword">as</span> CSV files</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: BLACKHOLE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: <span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> storage engine (anything you write <span class="keyword">to</span> it disappears)</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MyISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Non<span class="operator">-</span>transactional engine <span class="keyword">with</span> good performance <span class="keyword">and</span> small data footprint</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">6.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: ARCHIVE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: gzip<span class="operator">-</span>compresses tables <span class="keyword">for</span> a low storage footprint</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">7.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: FEDERATED</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Allows <span class="keyword">to</span> access tables <span class="keyword">on</span> other MariaDB servers, supports transactions <span class="keyword">and</span> more</span><br><span class="line">Transactions: YES</span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: YES</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">8.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">9.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: SEQUENCE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Generated tables filled <span class="keyword">with</span> sequential <span class="keyword">values</span></span><br><span class="line">Transactions: YES</span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: YES</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">10.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: InnoDB</span><br><span class="line">     Support: <span class="keyword">DEFAULT</span> <span class="comment">-- 默认引擎</span></span><br><span class="line">     Comment: Supports transactions, <span class="type">row</span><span class="operator">-</span>level locking, <span class="keyword">foreign</span> keys <span class="keyword">and</span> encryption <span class="keyword">for</span> tables <span class="comment">-- 描述</span></span><br><span class="line">Transactions: YES  <span class="comment">-- 支持事务</span></span><br><span class="line">          XA: YES  </span><br><span class="line">  Savepoints: YES  <span class="comment">-- 支持事务中的保存点</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">11.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: Aria</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Crash<span class="operator">-</span>safe tables <span class="keyword">with</span> MyISAM heritage</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="number">11</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><h2 id="1-4-保存点"><a href="#1-4-保存点" class="headerlink" title="1.4 保存点"></a>1.4 保存点</h2><p>所谓保存点，就是在事务执行过程中，给当前的数据设置一个savepoint，这样在出现问题的时候，可以回退到当前的数据中；就好比之后的操作没有进行一样；</p><p>游戏中的保存点其实也是这样的功能，让玩家回退到打某个BOSS之前，包括当时你收集的材料，都会回退到打这个BOSS之前的状态；</p><p>你可以理解为，是给当前的数据拍了张照片，出现问题的时候，用这个照片里面的东西复写掉新的东西。这便是保存点的作用；</p><h2 id="1-5-基础命令操作"><a href="#1-5-基础命令操作" class="headerlink" title="1.5 基础命令操作"></a>1.5 基础命令操作</h2><p>先提一下事务的开启和结束方式，以及如何设置保存点和回滚吧</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启，这两种方式是一样的</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="comment">-- 设置保存点（名字可以自由更改，但不能有重复）</span></span><br><span class="line"><span class="keyword">savepoint</span> save1; <span class="comment">-- 创建一个保存点save1</span></span><br><span class="line"><span class="comment">-- 事务回滚</span></span><br><span class="line"><span class="keyword">rollback</span> <span class="keyword">to</span> save1; <span class="comment">-- 回滚到保存点save1</span></span><br><span class="line"><span class="keyword">rollback</span>; <span class="comment">-- 回滚到事务开始</span></span><br><span class="line"><span class="comment">-- 结束</span></span><br><span class="line"><span class="keyword">commit</span>; <span class="comment">-- 提交事务</span></span><br></pre></td></tr></table></figure><h1 id="2-使用"><a href="#2-使用" class="headerlink" title="2.使用"></a>2.使用</h1><p>了解了事务为什么存在，下面就是来使用一下事务了；</p><h2 id="2-1-提交方式"><a href="#2-1-提交方式" class="headerlink" title="2.1 提交方式"></a>2.1 提交方式</h2><p>事务的提交方式有两种方式</p><ul><li>自动提交</li><li>手动提交</li></ul><p>默认情况下，MySQL的自动提交是处于开启状态的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; show variables like &#x27;autocommit&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.001 sec)</span><br></pre></td></tr></table></figure><p>我们可以用下面的语句来设置是否开启自动提交（只对当前会话生效）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span>; <span class="comment">-- 关闭自动提交</span></span><br><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">1</span>; <span class="comment">-- 开启</span></span><br></pre></td></tr></table></figure><p>这两个提交方式有啥区别呢？是不是开了自动提交就什么都不用管了？后文我们再通过实测来说明；</p><h2 id="2-2-场景演示"><a href="#2-2-场景演示" class="headerlink" title="2.2 场景演示"></a>2.2 场景演示</h2><p>最开始测试的时候，先将事务隔离级别设置为读未提交；请注意，不要在有生产环境的MySQL中进行此项操作；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置全局隔离级别为读未提交</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level READ UNCOMMITTED; </span><br><span class="line"><span class="comment">-- 重启mysql终端后查看隔离级别</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx_isolation</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx_isolation</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>UNCOMMITTED <span class="operator">|</span>   <span class="comment">-- 成功设置读未提交的隔离级级别</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><h3 id="2-2-1-数据回滚演示"><a href="#2-2-1-数据回滚演示" class="headerlink" title="2.2.1 数据回滚演示"></a>2.2.1 数据回滚演示</h3><p>设置完毕后，进入测试数据库，创建如下测试表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test_ruc(</span><br><span class="line">	id <span class="type">int</span> unsigned <span class="keyword">primary</span> key,</span><br><span class="line">	user_id <span class="type">int</span> unsigned <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>先给表里面插入几个基本的数据：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_ruc <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">10</span>,<span class="string">&#x27;李华&#x27;</span>),(<span class="number">2</span>,<span class="number">20</span>,<span class="string">&#x27;王五&#x27;</span>);</span><br></pre></td></tr></table></figure><p>插入后，我们在两侧的终端中都可以看到已有的数据</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/319fbe3f23373d34fb0eff4a249ef16b.png" alt="image-20230910163833837"></p><p>随后在两个终端中都开启一个事务，左侧终端插入一个数据，右侧终端查看</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_ruc <span class="keyword">values</span> (<span class="number">3</span>,<span class="number">30</span>,<span class="string">&#x27;左侧终端插入&#x27;</span>);</span><br></pre></td></tr></table></figure><p>可以看到，两侧的终端都可以看到这份数据</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8021cf95d4fa8a29c24771161f17cf52.png" alt="image-20230910164315360"></p><p>此时将左侧终端强制退出（使用<code>CTRL+\</code>），右侧再次查询，会发现新插入的数据没有了；这里便是事务的<strong>原子性</strong>的体现，左侧的终端所执行的事务没有<code>commit</code>就因为异常退出了，MySQL自动将数据回滚到了这个事务执行之前，即没有插入这份新数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/db2ea78350e2fe7927f8367f7aecf2db.png" alt="image-20230910164414488"></p><p>左侧重新链接MySQL，开启一个事务；在右侧插入一个数据，随后创建保存点<code>save1</code>；插入第二个数据，创建保存点<code>save2</code>；</p><p>在左侧查询，我们可以看到右侧插入的两条新数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/cf012a62e99049bc5b41b66583e7b49a.png" alt="image-20230910165426916"></p><p>在右侧回滚到保存点save1，会发现插入的数据2没有了；这与保存点的预期操作相符合；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/99e569e2c4fde9770594fc1176aa52ec.png" alt="image-20230910165719357"></p><p>将右侧终端强制退出，再次查询数据，可以看到第一次插入的数据也没有了，数据又回到了右侧终端事务开始之前的样子。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/60cb747da1ac4756bce1c6e6ff12ace0.png" alt="image-20230910171826318"></p><p>这里能得出一个结论：如果终端异常退出，MySQL会将数据回滚到事务开始时；你可以理解为，我们使用<code>begin;</code>的时候就已经创建了一个隐藏的保存点，MySQL在异常的时候只会将数据回退到这个<strong>事务开始之时</strong>的隐藏保存点，无论中途用户有没有设置其他保存点！</p><p>即：在异常退出的时候，MySQL会自动帮我们执行<code>rollback</code>命令回退到事务开头！</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">rollback</span>; <span class="comment">-- 回退到事务开头</span></span><br></pre></td></tr></table></figure><p>这样就能避免最开始提到的，转账系统中给A扣了钱但是没有给B加钱的问题！</p><h3 id="2-2-2-数据持久化演示"><a href="#2-2-2-数据持久化演示" class="headerlink" title="2.2.2 数据持久化演示"></a>2.2.2 数据持久化演示</h3><p>接着我们再来看看，如果执行了commit之后又会是什么情况；</p><p>右侧提交了事务后退出，左侧依旧能查询倒已经提交的数据。代表数据已经被持久化写入到了磁盘（当然这个时候也不一定立刻刷盘了，但是这已经能代表MySQL将我们的数据加入到了持久化策略中，并不需要我们管啥时候刷盘的问题！）</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/e04e7e3b782a176b62e140c1143b1695.png" alt="image-20230910213252764"></p><h3 id="2-2-3-自动提交"><a href="#2-2-3-自动提交" class="headerlink" title="2.2.3 自动提交"></a>2.2.3 自动提交</h3><p>前面提到了，MySQL的自动提交默认是开启的；那么这个自动提交有什么作用呢？是不是开启了自动提交，就不需要手动创建事务了？</p><p><strong>并不是</strong>！在之前的测试中，<code>autocommit</code>是开启的；我们已经证明了，手动<code>begin</code>创建的事务，在没有手动<code>commit</code>的时候不会被写入磁盘（不进行持久化）；这代表我们手动创建的事务，不会受到<code>autocommit</code>是否开关的影响；（开着的时候都没有自动提交，关闭的时候肯定更不会自动提交了）</p><ul><li>那么这个<code>autocommit</code>会影响谁呢？</li></ul><p>开启两个终端，左侧将自动提交关闭，随后插入一个数据；插入后会发现右侧看不到左侧新插入的数据！</p><blockquote><p>备注：<code>set autocommit = 0;</code>语句只会影响当前终端，不会影响另外的终端。</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/05a473c988222c4e9f669040110ce010.png" alt="image-20230911081342217"></p><p>此时手动进行<code>commit</code>，右侧就看得到数据了！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/b0c20ecfa43ae1ba23143c78abea5a3d.png" alt="image-20230911081509985"></p><p>而如果我们不手动执行<code>commit</code>就把左侧终端<code>CTRL+\</code>退出，那么新插入的这一条数据会丢失！</p><h3 id="2-2-4-单条SQL和事务的关系"><a href="#2-2-4-单条SQL和事务的关系" class="headerlink" title="2.2.4 单条SQL和事务的关系"></a>2.2.4 单条SQL和事务的关系</h3><p>欸？我们明明没有<code>begin</code>开启事务，为什么可以执行<code>commit</code>呢？</p><p>这是因为，在MySQL中，每一个不主动使用事务的单条SQL语句，都会视作一个事务进行操作！既我们之前没学习事务时，执行的所有单条SQL也是一个个各自独立的事务！</p><p>知道了这一点，你就能理解<strong>自动提交的作用</strong>了：在执行单条SQL的时候，是否自动提交该SQL语句的事务。</p><p>将<code>autocommit</code>重新开启，再进行测试；会发现左侧插入的数据右侧可以立马看到，无需手动<code>commit</code>。这便是自动提交的作用的体现！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/2fa8f41ee1644efb200d2fdbe65677ac.png" alt="image-20230911082134863"></p><h2 id="2-3-结论"><a href="#2-3-结论" class="headerlink" title="2.3 结论"></a>2.3 结论</h2><p>经过上面的这些简单测试，我们可以看到事务的原子性和持久性，做一个总结</p><ul><li>输入了<code>begin/start transaction</code>手动创建的事务，必须通过<code>commit</code>手动挡提交，才会持久化；这一点和<code>autocommit</code>无关！</li><li>事务可以设置保存点和手动回滚，出现异常的时候，MySQL会自动回退到事务开头；</li><li>对于<code>InnoDB</code>存储引擎而言，所有的单条SQL语句都会被视作一个事务，自动提交；</li><li><code>select</code>语句会有一些差别，因为MySQL有MVCC访问控制（后文讲解）</li></ul><p>操作事务的一些注意事项</p><ul><li>只有<code>InnoDB</code>才支持事务，<code>MyISAM</code>不支持;</li><li>一个事务被提交了之后，不可以执行<code>rollback</code>;</li><li>创建了保存点后，可以选择回退到哪一个保存点，亦或者是回退到事务开头；</li></ul><h1 id="3-事务隔离级别"><a href="#3-事务隔离级别" class="headerlink" title="3.事务隔离级别"></a>3.事务隔离级别</h1><h2 id="3-1-基本说明"><a href="#3-1-基本说明" class="headerlink" title="3.1 基本说明"></a>3.1 基本说明</h2><p>事务的隔离级别和事务的隔离性息息相关</p><ul><li>MySQL的单个数据库可能被多个进程&#x2F;线程同时进行访问和事务操作；</li><li>一个事务是由多个SQL语句组成的，任何一个事务，都会存在执行前&#x2F;中&#x2F;后的阶段。所谓原子性，就是MySQL要保证各个客户端要么只能看到事务执行前或者执行后的数据；执行中的事务，对于其他用户来看是原子的，出现异常会被自动回滚；</li><li>但事务毕竟还是存在执行中的概念，其他客户端是有可能看到某个事物执行中的状态的，这就需要隔离性来介入了；</li><li>隔离性：保证事务在执行过程中尽量不受干扰；</li><li>隔离级别：允许事务受不同程度的干扰；</li></ul><p>开头就提到了，MySQL的事务有4种隔离级别</p><ul><li>读未提交（Read Uncommitted）：在这个隔离级别中，所有事务都可以看到其他事物还没有提交的内容（你可以理解为<strong>压根没有隔离性</strong>，之前的测试使用的就是这个隔离级别）这种情况下就容易引起并发和读取数据的不一致问题，还有<strong>脏读</strong>问题（对方没有commit的数据就叫做脏数据，读取脏数据是脏读），生产环境中是打死不能用这个隔离级别的！</li><li>读已提交（Read Committed）：在这个隔离级别中，事务只可以看到其他事务已经提交了的内容。这已经满足了隔离的基本定义：只能看到其他事务开始前或者开始后的内容；但是这种隔离模式会产生<strong>不可重复读</strong>的问题（相同<code>select</code>会出现不同结果）；</li><li>可重复读（Repeatable Read）：为了解决不可重复读的问题，这个隔离级别保证了事务在运行过程中多次读取相同数据时会得到相同结果；但是这个隔离级别在某些数据库中可能会出现<strong>幻读</strong>（一个事务在执行过程中读取到了另一个事务已提交的插入数据）问题；MySQL默认采用此隔离级别；</li><li>串行化（Serializable）：所谓串行化，就是MySQL给数据库的所有操作都上锁，必须要排队运行。一个事务在运行时，另外一个事务得等它运行完毕了才能进来运行，这样能最大程度保证隔离性；但是会降低效率；</li></ul><p>隔离级别是由MySQL进行各种类型的加锁来实现的，比如表锁、行锁、读写锁、间隙锁（GAP）、NEXT-KEY锁（GAP+行锁）等等；</p><blockquote><p>这里还需要验证另外一件事，MySQL如果开启了串行化，客户端c&#x2F;cpp操作还需要加锁吗？<code>mysqlquery</code>的操作是会阻塞还是直接错误退出？</p></blockquote><p>在MySQL中，事务的隔离级别可以分别设置全局的隔离级别和当前客户端的隔离级别；如果没有主动设置客户端的隔离级别，则会继承全局的隔离级别。顾名思义，会话隔离级别只会影响当前的会话，不会影响另外的客户端；</p><p>另外，全局的隔离级别会在数据库服务重启后，被重置为配置文件中默认的隔离级别（一般是RR）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 设置 会话/全局 隔离级别</span></span><br><span class="line"><span class="keyword">set</span> [session <span class="operator">|</span> <span class="keyword">global</span>] transaction isolation level [read uncommitted <span class="operator">|</span> read committed <span class="operator">|</span> repeatable read <span class="operator">|</span> serializable ]</span><br><span class="line"><span class="comment">-- 查看当前会话的隔离级别</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@session</span>.tx_isolation;</span><br><span class="line"><span class="comment">-- 查看全局的隔离级别</span></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx_isolation</span>;</span><br></pre></td></tr></table></figure><p>总结一下几个不正常的读问题：</p><ul><li>脏读：一个事务读到了其他事务还没有提交的修改；</li><li>幻读：一个事务读到了其他事务已经提交了的新增数据；</li></ul><h2 id="3-2-读未提交"><a href="#3-2-读未提交" class="headerlink" title="3.2 读未提交"></a>3.2 读未提交</h2><p>这个隔离级别在第二大点里面就已经测试过了，左侧终端插入的数据，即便没有commit，在右侧终端中也能看得到，这里就不二次演示了</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8021cf95d4fa8a29c24771161f17cf52.png" alt="image-20230910164315360"></p><p>清除已有的数据，来测试一下会话隔离级别的作用；默认情况下，全局和会话的隔离级别都是RR；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; select @@tx_isolation;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@tx_isolation  |</span><br><span class="line">+-----------------+</span><br><span class="line">| REPEATABLE-READ |</span><br><span class="line">+-----------------+</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hello_mysql]&gt; select @@session.tx_isolation;</span><br><span class="line">+------------------------+</span><br><span class="line">| @@session.tx_isolation |</span><br><span class="line">+------------------------+</span><br><span class="line">| REPEATABLE-READ        |</span><br><span class="line">+------------------------+</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure><p>将左侧的终端中的会话隔离级别设置为读未提交</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> session transaction isolation level read uncommitted;</span><br></pre></td></tr></table></figure><p><strong>插入数据之前</strong>，执行一次<code>select</code>全列查询，两侧都是空；</p><p>在左侧插入数据后，右侧查看会发现依旧是<code>empty set</code>没有结果；只有左侧<code>commit</code>之后，右侧才能看到数据；这是因为在之前测试的时候，<strong>我们将自动提交关闭了</strong>；右侧看不到我们还没有提交的事务；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/9c76acac8deca528d4226b226146de13.png" alt="image-20230911100829407"></p><p>右侧手动开启事务后，即便没有进行<code>commit</code>，但是左侧因为设置了读未提交，所以可以直接看到右侧还没有提交的事务中的修改。这便是这个隔离级别的特性；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/6ba51b47e8c05b4171645e423f1ad6a2.png" alt="image-20230911101100927"></p><h2 id="3-3-读已提交"><a href="#3-3-读已提交" class="headerlink" title="3.3 读已提交"></a>3.3 读已提交</h2><p>接下来再将全局隔离级别设置为读已提交，重新开启两个终端进行测试；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global transaction isolation level read committed;</span><br></pre></td></tr></table></figure><p>设置完毕，重启终端后，可以看到两侧的隔离级别都是读已提交，自动提交都是开启的；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/bc6c1464a3c9331191aee2a24f9273e4.png" alt="image-20230911102633596"></p><p>两侧都开启一个事务，左侧插入数据，右侧查看，发现没有内容；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8e60ab3a2b5b4bff70b80ed22bce706b.png" alt="image-20230911103402950"></p><p>左侧commit之后，右侧才可以看到这个数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/9ec9807c381ccebd42a77a741151c422.png" alt="image-20230911103432740"></p><p>这符合我们对<strong>读已提交</strong>这个隔离级别的字面理解，但是这并不代表这个隔离级别没有问题！</p><h3 id="3-3-1-出问题的场景"><a href="#3-3-1-出问题的场景" class="headerlink" title="3.3.1 出问题的场景"></a>3.3.1 出问题的场景</h3><p>来看看下面这个场景：</p><ul><li>公司需要根据员工工资，分发不同级别的奖金：<ul><li>2000-4000 级别一</li><li>4001-8000 级别二</li><li>8001-15000 级别三</li></ul></li><li>甲开启了一个客户端，开始用MySQL筛选不同工资区间的员工，记录下来；</li><li>乙开启了一个客户端，想要给员工丁加工资<ul><li>丁原本的工资是3000</li><li>乙给丁加了2000工资，丁的工资变成了5000，跳到了工资级别二；</li><li>乙提交修改（commit）</li></ul></li><li>假设甲已经完成了对2000-4000级别工资的员工筛选，此时乙过来给丁加了工资，丁跳到了工资级别二；</li><li>因为隔离级别是读已提交，甲在筛选工资级别二的人员时，会把刚刚被修改过的丁也给纳入进去；</li><li>这时候，对于甲而言，<strong>丁就同时出现在了工资级别一和二的人员中，这明显是不合理的</strong>！</li></ul><p>这个场景被称为<code>不可重复读</code>，即在一个事务中，同一个查询语句，可能会因为其他事务的提交而产生不同的结果；换做SQL语句来描述，在读已提交的隔离级别中，同一个select语句只能执行一次，第二次执行的时候，可能会获取到和第一次不同的结果，所以这个问题才被称作<code>不可重复读</code>（不可以重复执行select）问题；</p><hr><p>来实际演示一下，两侧都开启一个新的事务，左侧终端更新表中的用户id，只要它不提交，右侧就看不到修改。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8789693271635e5d27c7ad0873937af8.png" alt="image-20230911105147039"></p><p>但是提交了之后，右侧就能看到这个用户id的改变，在进行数据筛选的时候，这种情形就会出现问题！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/c9f4f3c119361dfcfab135c9e4342921.png" alt="image-20230911105214340"></p><h2 id="3-4-可重复读"><a href="#3-4-可重复读" class="headerlink" title="3.4 可重复读"></a>3.4 可重复读</h2><p>所以，为了避免上面提到的这个问题，MySQL还提供了一个可重复读的隔离级别，且默认采用的就是这个隔离级别；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level  repeatable read;</span><br></pre></td></tr></table></figure><p>可重复读就解决了上面提到的问题，即便其他事务提交了修改，当前事务也看不到这份修改，只有当前事务结束后，才能看到最新的数据；</p><p>看下图，两侧都开启一个事务，不管左侧是否有提交事务，右侧都看不到左侧新插入的数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/c702bd94bb9b4f1b39da177aba23faf0.png" alt="image-20230911150201158"></p><p>只有右侧也提交了自己的事务，才能看到左侧插入的新数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8e5ce5e2e310cf65a10b003bb0036e3e.png" alt="image-20230911150323005"></p><p>这就保证了，右侧这个事务在运行的始终，它执行的相同<code>select</code>语句的结果永远都是一样的，不会出现不可重复读的问题！</p><p>而如果在RR级别中，同时访问相同数据，会出现<strong>加锁</strong>的情况，下图中，右侧插入了主键为6的数据，此时左侧如果也尝试插入一个主键为6的数据，会进入阻塞状态；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/fa7dbb9ad31fd27e00307f37aac40a4e.png" alt="image-20230911151027879"></p><p>如果很久都不继续操作，就会因为等待超时，跳出等待</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; insert into test_ruc values (6,60,&#x27;天数&#x27;);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure><p>但当前事务中插入的数据依旧是存在的，当前事务也没有结束</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/d8de538b5a89adf04842efd2097239c6.png" alt="image-20230911151335335"></p><p>再次尝试插入这个主键为6的数据，依旧会陷入阻塞态，只有右侧的事务被提交了之后，左侧才会出现主键冲突的提示，禁止插入；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/be7f7f5c5a63329fbe574ba4ff22d085.png" alt="image-20230911151444595"></p><p>左侧commit了之后，右侧才能看到左侧新插入的主键为5的数据；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/0827a5499036b9e5b024b60f174ec44a.png" alt="image-20230911151710391"></p><h2 id="3-5-串行化"><a href="#3-5-串行化" class="headerlink" title="3.5 串行化"></a>3.5 串行化</h2><p>这个就比较简单了，一个事务没结束，另外一个就阻塞等待；</p><p>串行化是最高的隔离级别，但其并发性能很低，实际上用的也不多；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> transaction isolation level serializable;</span><br></pre></td></tr></table></figure><p>两侧终端都开始事务，查询的时候是不会加锁的，但是左侧执行<code>update</code>的时候，阻塞了（可以通过左侧update的执行时间观察到阻塞现象，截图看的不是很明显）；右侧也执行一次<code>update</code>，左侧的update就立马成功了，右侧显示报错检测到死锁，建议尝试重启事务；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/d75f063fa7959ec6c7926eba70d25e35.png" alt="image-20230911110259760"></p><p>再来试试，两侧都开启事务，左侧尝试插入一个数据，<strong>会阻塞</strong>；右侧<code>commit</code>之后，左侧的插入就立马成功了！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/8f8ed448629e2b9a842eb819c91f6cea.png" alt="image-20230911110525989"></p><p>这便是串行化的表现：两个事务如果都是在执行select的读取操作，则不会被阻塞，但如果有一个事务要执行<strong>增删改</strong>，那么就必须等待其他事务都结束了，这个操作才能被执行；</p><h3 id="3-5-1-串行化的适用场景"><a href="#3-5-1-串行化的适用场景" class="headerlink" title="3.5.1 串行化的适用场景"></a>3.5.1 串行化的适用场景</h3><p>回到 <a href="#jump1">1.1.2 卖票</a> 的场景，在这个场景下，如果你需要保证客户端A的卖票逻辑完全执行完毕了，客户端B才能过来查询票数，那就需要使用串行化；</p><p>但是，串行化中，我们是可以执行查询操作的！那么在A没有结束的情况下，B不还是会查询到有剩余票数？</p><blockquote><p>实际上，我们的卖票操作并不是直连数据库实现的，而是有一个服务端进程来提供API，供客户端来查询剩余票数，剩下的卖票操作其实都是服务端来实现的（让客户端直连MySQL来执行SQL是非常不可靠的，很有可能出现SQL注入攻击）</p></blockquote><p>所以，这个问题得在服务端进程中加锁解决！MySQL本身即便使用串行化也是没有办法解决这个问题的；</p><p>但是，别忘了，MySQL还有另外一个东西——<strong>约束</strong>；你可以设置一个触发器，更新剩余票数的时候，拒绝将票数设置为负数；这样客户端B即便进入了卖票业务，最终将剩余票数的数据设置为负数的时候，<strong>也会被MySQL阻止插入</strong>，这个卖票的事务B就相当于错误退出了，所有操作都会被回滚！而隔离级别就是避免A和B同时修改一个数据而导致的错误；</p><p>二者相辅相成，就能解决这个问题；当然，在服务端API处理逻辑中加锁是更好的解决办法，既可以保证数据一致性，又能隔离客户端和MySQL服务；</p><blockquote><p>后文讲到的当前读也能在某种程度上解决这个问题，反正解决的办法多多！</p></blockquote><h3 id="3-5-2-串行化和CPP"><a href="#3-5-2-串行化和CPP" class="headerlink" title="3.5.2 串行化和CPP"></a>3.5.2 串行化和CPP</h3><p>如果将 MySQL 的隔离级别（isolation level）设置为最高级别的串行化（SERIALIZABLE），那么并发的多线程操作可能会遇到以下情况之一：</p><ol><li>阻塞：当一个线程正在使用某个数据时，其他线程需要等待该线程释放锁才能继续进行操作。这会导致其他线程在获得所需锁之前被阻塞。</li><li>错误退出：如果多个线程同时操作相同的数据，并且它们无法同时持有访问该数据的锁，就会引发死锁。在这种情况下，某些线程会被系统终止，从而导致错误退出。</li></ol><p>所以，并不是说你将MySQL的隔离级别设置好了，那么客户端就啥事不用干了；最好的操作依旧是在客户端就加锁进行一定的访问控制，因为MySQL Query函数的错误退出+退出情况识别，相比于客户端进行访问控制更难以操作；</p><h2 id="3-6-总结"><a href="#3-6-总结" class="headerlink" title="3.6 总结"></a>3.6 总结</h2><ul><li>隔离级别越高，安全性越高，数据库的并发性能就越低；我们需要根据业务逻辑，选用合适的隔离级别；</li><li>不可重复读的问题在于其他客户端的修改和删除，同样的select语句会查出不同的结果，是不合理的；</li><li>幻读的重点在于新增，其他客户端新增的记录可能被我们当前的客户端查询到；但是在MySQL中，这个问题是不存在的，因为<code>InnoDB</code>通过NEXT-KEY锁解决了幻读问题；</li><li>事务也分为长短事务的概念，事务之间互相影响，主要指的是事务在并行阶段（都没有<code>commit</code>的时候）产生的影响；</li><li>一般情况下，我们使用MySQL默认的RR的事务级别就可以了；</li></ul><p>下面给出一个不同事务级别之间的区别的表格，Y代表会出现这个问题，N代表不会出现这个问题</p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>加锁读</th></tr></thead><tbody><tr><td>读未提交</td><td>Y</td><td>Y</td><td>Y</td><td>不加锁</td></tr><tr><td>读已提交</td><td>N</td><td>Y</td><td>Y</td><td>不加锁</td></tr><tr><td>可重复读</td><td>N</td><td>N</td><td>N</td><td>不加锁</td></tr><tr><td>串行化</td><td>N</td><td>N</td><td>N</td><td>加锁</td></tr></tbody></table><h2 id="3-7-一致性"><a href="#3-7-一致性" class="headerlink" title="3.7 一致性"></a>3.7 一致性</h2><ul><li>事务执行的结果，必须使数据库从一个一致性状态，变到另一个一致性状态。当数据库只包含事务 成功提交的结果时，数据库处于一致性状态。</li><li>如果系统运行发生中断，某个事务尚未完成而被迫中 断，而改未完成的事务对数据库所做的修改已被写入数据库，此时数据库就处于一种不正确（不一致）的状态。因此一致性是通过<strong>原子性</strong>来保证的。</li><li>其实一致性和用户的业务逻辑强相关，一般MySQL提供技术支持，但是一致性还是要用户业务逻辑做支撑（比如客户端如果不使用事务，那MySQL也没有办法帮助维护），所以说，一致性是由用户决定是否维护的。</li><li>技术上，通过AID保证C</li></ul><h1 id="4-隔离性的理解"><a href="#4-隔离性的理解" class="headerlink" title="4.隔离性的理解"></a>4.隔离性的理解</h1><p>说完了隔离级别，接下来再深入理解一下隔离性</p><h2 id="4-1-MVCC"><a href="#4-1-MVCC" class="headerlink" title="4.1 MVCC"></a>4.1 MVCC</h2><p>数据库并发的场景一共有下面三种</p><ul><li><code>读-读</code>：不存在任何问题，不需要访问控制</li><li><code>读-写</code>：有线程安全问题，可能会遇到隔离性中的脏读、幻读、不可重复读问题；</li><li><code>写-写</code>：有线程安全问题，还有可能出现更新丢失问题；</li></ul><p>我们主要关注的是读写并发的情况，这也是数据库最常遇到的处理场景；</p><p>再MySQL中，采用了MVCC（多版本并发控制）来解决读写冲突，这是一种无锁的并发控制机制；</p><p>在了解MVCC之前，我们需要了解几个前置知识：</p><ul><li>三个隐藏列字段</li><li>UNDO日志</li><li>READ VIEW</li></ul><h3 id="4-1-1-隐藏列字段"><a href="#4-1-1-隐藏列字段" class="headerlink" title="4.1.1 隐藏列字段"></a>4.1.1 隐藏列字段</h3><p>在MySQL中，每一个表都存在三个隐藏的列字段</p><ul><li><strong>DB_TRX_ID</strong>：6 byte，最近修改(修改&#x2F;插入)事务ID，记录创建这条记录&#x2F;最后一次修改该记录的事务ID；</li><li><strong>DB_ROLL_PTR</strong>: 7 byte，回滚指针，指向这条记录的上一个版本（简单理解成，指向历史版本就 行，这些数据一般在 <code>undo log</code> 中）</li><li><strong>DB_ROW_ID</strong>: 6 byte，隐含的自增ID（隐藏主键），如果数据表没有主键， InnoDB 会自动以 DB_ROW_ID 产生一个<strong>聚簇索引</strong>；</li><li>补充：实际还有一个删除flag隐藏字段。某一条记录被删除时并不代表真的删除，而是删除flag变了，相当于隐藏了这条记录；这种操作叫<strong>软删除</strong>，在很多系统的删除操作中都是一个常见做法。</li></ul><p>假设有如下表结构</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> student(</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    age <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 插入一条记录</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student (name, age) <span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">19</span>);</span><br></pre></td></tr></table></figure><p>那么这个表中的实际数据是这样的</p><table><thead><tr><th>name</th><th>age</th><th>DB_TRX_ID(创建这个记录的事务ID)</th><th>DB_ROW_ID（隐藏主键）</th><th>DB_ROLL_PTR（回滚指针）</th></tr></thead><tbody><tr><td>张三</td><td>19</td><td>NULL</td><td>1</td><td>NULL</td></tr></tbody></table><p>我们并不知道创建这个记录的事务ID，所以设置为NULL；因为是第一条记录，所以隐藏主键是1；同样因为是第一条记录，所以没有回滚的地方，回滚指针也是NULL（换句话说，如果回滚指针为NULL，代表这个就是这个表中的第一条记录了）。</p><h3 id="4-1-2-undo日志"><a href="#4-1-2-undo日志" class="headerlink" title="4.1.2 undo日志"></a>4.1.2 undo日志</h3><p>MySQL是以服务进程的方式在内存中运行的，我们对数据的CURD操作，都需要通过MySQL将其刷入到硬盘上进行持久化，MySQL为这些操作会提供一个专门的<code>buffer pool</code>内存缓冲区；而<code>undo log/redo log</code>也是内存中的一块区域，对于MySQL而言</p><ul><li>日志需要立刻刷盘（有一个专门的线程来管理日志）</li><li>数据根据运行策略，选择合适的时间刷盘（因为数据量一般比较大，如果实时刷盘会造成较大IO负载，影响进程运行）</li></ul><p>先来说说<code>redo log</code>，这里包含了MySQL中的所有尚未落盘的CURD操作；如果MySQL还没有写入数据的时候就挂了，那么下次启动的时候就会从<code>redo log</code>里面恢复数据，来确保数据的一致性和完整性；</p><p>在MySQL存储路径<code>/var/lib/mysql</code>中的<code>ib_logfile0/ib_logfile1</code>就是<code>redo log</code>；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-rw-rw----. 1 mysql mysql  50331648 Sep 11 03:16 ib_logfile0</span><br><span class="line">-rw-rw----. 1 mysql mysql  50331648 Sep  9 21:03 ib_logfile1</span><br></pre></td></tr></table></figure><p>而<code>undo log</code>主要用于以下功能</p><ol><li>回滚事务</li><li>MVCC（多版本控制&#x2F;隔离性和隔离级别）</li></ol><p>假设我们来了一个update操作，将刚刚插入的张三的年龄改成30岁，对于MySQL而言就会在<code>undo log</code>里面做如下处理；</p><ul><li>该update操作对应的事务<code>DB_TRX_ID</code>是10；</li><li>将旧数据放入<code>undo log</code>中，并将当前数据的<code>DB_ROLL_PTR</code>指向旧数据的地址；</li><li>如果需要回滚，那么就通过<code>DB_ROLL_PTR</code>找到旧数据，复写回去；</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/6f386ba45e0c26e72de76bff973c4a4f.png" alt="image-20230911172501941"></p><p>如果再来一次修改，将张三的名字改成李四，也是依照这个逻辑在<code>undo log</code>中新增旧数据，并链接<code>DB_ROLL_PTR</code>指针；</p><ul><li>事务11修改这条数据，先申请锁；</li><li>将现有数据复制到<code>undo log</code>中（头插），并将<code>DB_ROLL_PTR</code>指针指向旧数据的地址；</li><li>修改记录中的name，并且将<code>DB_TRX_ID</code>改成当前事务的ID 11；</li><li>事务11提交，释放锁；</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/d4a9aca8bdd9c3e38daa5b07896e7684.png" alt="image-20230911173024425"></p><p>这样，我们就有了一个类似于链表的历史版本链；每次回退的时候，都可以找到历史数据，覆盖当前的数据。这些版本我们称之为<code>快照</code>；</p><p>而插入和删除都可以写入<code>undo log</code>，但是只有更新和删除能形成历史版本链；</p><ul><li>删除是将删除flag置为真，旧数据依旧可以写入到<code>undo log</code>中，如果需要回滚，将这行记录恢复；</li><li>插入并没有历史版本，但也需要将其放入<code>undo log</code>中，事务回滚的时候需要将新插入的数据删除；</li><li>事务提交了之后，已有的历史记录可以被删除；</li></ul><p>增删改都说了，那么<code>select</code>呢？</p><p>一般而言，查询不会产生数据写入操作，也不需要设置历史版本链；</p><p>但是在之前关于RR级别隔离性的验证中，我们看到了<code>select</code>无法看到另外一个事务已经提交了的数据，这说明<code>select</code>有时候读取的是<strong>历史版本</strong>的数据，而并非当前最新的数据！</p><p>读取历史数据我们称之为<code>快照读</code>，在RR级别中默认采用的就是快照读；读取最新数据叫做当前读（增删改都是当前读）；还有一种读取是为了更新而查询；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ... <span class="comment">-- 在RR级别下，默认是快照读</span></span><br><span class="line"><span class="keyword">select</span> ... <span class="keyword">for</span> <span class="keyword">update</span>; <span class="comment">-- 为了更新而查询</span></span><br><span class="line"><span class="comment">-- MySQL会将当前行上排他锁，上锁了之后，其他客户端只能查询该行，无法修改</span></span><br><span class="line"><span class="keyword">select</span> ... lock <span class="keyword">in</span> share mode; <span class="comment">-- 查询最新数据（当前读）</span></span><br><span class="line"><span class="comment">-- 是串行化的，只有其他事务完成了，才能查询到最新结果；</span></span><br></pre></td></tr></table></figure><p>除了手动指定<code>select</code>的查询方式以外，隔离级别会影响<code>select</code>的默认行为，比如在串行化隔离级别的场景下，默认执行的就是<strong>当前读</strong>；</p><p>在RR模式下进行测试，会发现当前读会阻塞当前的客户端（右侧客户端阻塞）；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/4025f787fda333689872e3295712df1b.png" alt="image-20230911200703608"></p><p>只有左侧的事务在提交了之后，右侧的查询才会返回最新的结果；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/1675840504edd0a5689e3a6ec052a4dd.png" alt="image-20230911201033979"></p><p>这是因为<strong>当前读</strong>，包括增删改操作，是需要加锁的；如果要在RR模式下实现当前读，那么整个系统就需要<strong>串行化</strong>执行；</p><p>而快照读不需要加锁，因为它可以读取历史版本，而历史版本是不会被其他线程修改的，也就不需要维护访问控制，提高了并发效率；</p><p>那么，MySQL是如何实现快照读的呢？</p><h3 id="4-1-3-Read-View"><a href="#4-1-3-Read-View" class="headerlink" title="4.1.3 Read View"></a>4.1.3 Read View</h3><p><code>Read View</code>就是MySQL为快照读生成的一个<strong>读视图</strong>；在事务执行快照读的时候（即执行<code>select</code>的时候）将当前数据拍一张照，这样在这个事务中，后续的所有<code>select</code>都只会看到这个照片里面的结果，看不到其他事务最新的修改（不管其他事务是否commit）。</p><blockquote><p>快照读的现象我们已经在本文 <code>3.4 可重复读</code> 中演示过了，这里就不再二次演示了；</p></blockquote><p><code>Read View</code>在MySQL的源码中其实就是一个类，该类中包含一些可读性判断的信息，内部有条件，来标明当前事务能够看到那个版本的数据，即有可能是当前最新的数据，也有可能是<code>undo log</code>中的某个历史版本；</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReadView</span> &#123;</span><br><span class="line"><span class="comment">// 省略...</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">/** 高水位，大于等于这个ID的事务均不可见*/</span></span><br><span class="line">    <span class="type">trx_id_t</span> m_low_limit_id</span><br><span class="line">    <span class="comment">/** 低水位：小于这个ID的事务均可见 */</span></span><br><span class="line">    <span class="type">trx_id_t</span> m_up_limit_id;</span><br><span class="line">    <span class="comment">/** 创建该 Read View 的事务ID*/</span></span><br><span class="line">    <span class="type">trx_id_t</span> m_creator_trx_id;</span><br><span class="line">    <span class="comment">/** 创建视图时的活跃事务id列表，是一个位图 */</span></span><br><span class="line">    <span class="type">ids_t</span> m_ids;</span><br><span class="line">    <span class="comment">/** 配合purge，标识该视图不需要小于m_low_limit_no的UNDO LOG，</span></span><br><span class="line"><span class="comment">    * 如果其他视图也不需要，则可以删除小于m_low_limit_no的UNDO LOG*/</span></span><br><span class="line">    <span class="type">trx_id_t</span> m_low_limit_no;</span><br><span class="line">    <span class="comment">/** 标记视图是否被关闭*/</span></span><br><span class="line">    <span class="type">bool</span> m_closed;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>单独说明一下这里的4个重要的变量；其中需要注意，在这里面<strong>up是低水位，low是高水位</strong>，这是由他们保存的数据的性质决定的，请不要和这两个单词的本意混淆！</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m_ids; <span class="comment">// 一张位图，用来保存Read View生成时，系统正活跃（没有结束的）的事务ID</span></span><br><span class="line">up_limit_id; <span class="comment">// 记录m_ids列表中事务ID最小的ID </span></span><br><span class="line">low_limit_id; <span class="comment">// ReadView生成时刻系统尚未分配的下一个事务ID，也就是目前已出现过的事务ID的最大值+1</span></span><br><span class="line">creator_trx_id <span class="comment">// 创建该ReadView的事务ID</span></span><br></pre></td></tr></table></figure><p>要知道，当前事务是知道自己的事务ID的（<code>DB_TRX_ID</code>），那么我们手中就有快照读中最大最小的事务ID，以及当前活跃中的事务ID；那么在读取版本链的时候，就进行如下匹配，设当前开启的这个<strong>事务为A</strong>:</p><ul><li>版本链中的事务ID不存在于<code>m_ids</code>中，代表<strong>事务A开启</strong>的时候，这个事务已经提交了，所以我们可以读取这个事务操作的结果；</li><li>版本链中的事务ID存在于<code>m_ids</code>中，代表事务A开启的时候，这个事务是<strong>活跃状态</strong>，那么我就不应该读到这个事务的操作结果；</li><li>版本链的中的事务ID大于<code>low_limit_id</code>，代表事务A开启的时候，这个事务还不存在，所以也不应该看到这个在A之后来的事务的操作结果；（A还没操作完毕，这个新事务就来了）</li><li>版本链中的事物ID小于<code>up_limit_id</code>，代表事物A开启的时候，这个事物都不知道是是它的父亲辈还是爷爷辈了，<strong>长辈给你留下的东西肯定得好好收着</strong>；说人话：这个是A来之前的之前就已经结束了的事物，肯定是可以读取其结果的；</li></ul><p>在MySQL中我们可以看到如下源码，链接也贴出来了，github上可以查看源码；这个函数就是用来判断当前事务应该能看到那些版本链的，具体的判断逻辑参考中文注释（英文注释是官方留的）</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个函数是ReadView类的成员函数 ReadView::changes_visible </span></span><br><span class="line"><span class="comment">// 源码链接 https://github.com/mysql/mysql-server/blob/ea1efa9822d81044b726aab20c857d5e1b7e046a/storage/innobase/include/read0types.h#L162  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [[nodiscard]] 代表这个函数的返回值不能被忽略，一定需要使用该返回值；否则编译器会爆警告；即告知程序员必须关注这个函数的返回值！</span></span><br><span class="line"><span class="comment">// 函数的返回值是当前事务能否看到某一个事务id值的版本链，入参是目标事务id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** Check whether the changes by id are visible.</span></span><br><span class="line"><span class="comment">  @param[in]    id      transaction id to check against the view</span></span><br><span class="line"><span class="comment">  @param[in]    name    table name</span></span><br><span class="line"><span class="comment">  @return whether the view sees the modifications of id. */</span></span><br><span class="line">  [[nodiscard]] <span class="function"><span class="type">bool</span> <span class="title">changes_visible</span><span class="params">(<span class="type">trx_id_t</span> id,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     <span class="type">const</span> <span class="type">table_name_t</span> &amp;name)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ut_ad</span>(id &gt; <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 小于最小的事务id或者等于当前事务id，则代表这个事务我们可以看到 </span></span><br><span class="line">    <span class="keyword">if</span> (id &lt; m_up_limit_id || id == m_creator_trx_id) &#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">check_trx_id_sanity</span>(id, name);</span><br><span class="line">	<span class="comment">// 如果这个id比当前事务中的高水位还大，说明这个id是后来者，不应该看到</span></span><br><span class="line">    <span class="keyword">if</span> (id &gt;= m_low_limit_id) &#123;</span><br><span class="line">      <span class="keyword">return</span> (<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 如果当前事务创建时，没有活跃事务</span></span><br><span class="line">    <span class="comment">// 且 m_up_limit_id &lt;= id &lt; m_low_limit_id </span></span><br><span class="line">    <span class="comment">// 那么这个事务ID就可以被看到，返回真</span></span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span> (m_ids.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">      <span class="built_in">return</span> (<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">ids_t</span>::value_type *p = m_ids.<span class="built_in">data</span>();</span><br><span class="line">	<span class="comment">// 如果上面都没有匹配到，那就检查这个id是否在活跃列表m_ids中</span></span><br><span class="line">    <span class="comment">// std::binary_search的返回值：是否在位图中，true代表在，false代表不在</span></span><br><span class="line">    <span class="comment">// 如果在，那么这个事务是活跃状态，不能被看到</span></span><br><span class="line">    <span class="comment">// 如果不在，那么这个事务是已经提交了，可以被看到</span></span><br><span class="line">    <span class="keyword">return</span> (!std::<span class="built_in">binary_search</span>(p, p + m_ids.<span class="built_in">size</span>(), id));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>如果查到不应该看到当前版本，接下来就是遍历下一个版本，直到符合条件，即可以看到。这便是我们select当前读的时候，会自动产生的<code>ReadView</code>结构体的作用；</p><p>根据这份源码，我们也能知道<code>m_ids</code>位图中，并不需要存放当前事务ID，因为会有额外的判断来处理当前事务ID！</p><h2 id="4-2-快照读实操"><a href="#4-2-快照读实操" class="headerlink" title="4.2 快照读实操"></a>4.2 快照读实操</h2><h3 id="4-2-1-快照是什么时候生成的？"><a href="#4-2-1-快照是什么时候生成的？" class="headerlink" title="4.2.1 快照是什么时候生成的？"></a>4.2.1 快照是什么时候生成的？</h3><p>假设当前的事务流程如下，省略号代表这个事务没有进行操作，事务2能看到事务1的操作结果吗？</p><table><thead><tr><th>事务1</th><th>事务2</th></tr></thead><tbody><tr><td>事务开始</td><td>事务开始</td></tr><tr><td>插入数据1并提交事务</td><td>……</td></tr><tr><td>……</td><td>第一次查询</td></tr><tr><td>重开一个新事务，插入数据2并提交</td><td>……</td></tr><tr><td>……</td><td>第二次查询</td></tr></tbody></table><p>来实操一下，开两个MySQL终端，隔离级别设置为RR；图中黄字标出了每一个SQL的执行顺序；我们会发现，当左侧终端提交了第一个插入的数据后，右侧才查询，<strong>是可以看到这条新插入的数据的</strong>！</p><p>而左侧插入的第二条数据右侧就看不到了，很明显，此时访问的就是快照中的旧数据，而不是新数据了；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/c8def576b68454081f60029cfa781b5a.png" alt="image-20230912094327001"></p><p>这就告诉我们：快照读的<strong>快照</strong>是在事务中第一次执行<code>select</code>语句的时候生成的！并不是事务开始的时候生成的！</p><p>这也非常合理，如果你的当前事务压根没有进行<code>select</code>语句，那我也就没有必要生成快照了。毕竟快照的底层是<code>ReadView</code>对象，也是会占用内存空间的！而增删改操作本身就是当前读，无需生成快照！</p><h3 id="4-2-2-实例解释ReadView的成员变量"><a href="#4-2-2-实例解释ReadView的成员变量" class="headerlink" title="4.2.2 实例解释ReadView的成员变量"></a>4.2.2 实例解释ReadView的成员变量</h3><p>用实际例子来解释一下ReadView里面的4个成员变量到底应该存放什么值；</p><p>假设有下面这个数据</p><table><thead><tr><th>name</th><th>age</th><th>DB_TRX_ID(创建这个记录的事务ID)</th><th>DB_ROW_ID（隐藏主键）</th><th>DB_ROLL_PTR（回滚指针）</th></tr></thead><tbody><tr><td>张三</td><td>19</td><td>NULL</td><td>1</td><td>NULL</td></tr></tbody></table><p>一共有4个事务同时运行，认为事务序号就是事务ID；</p><table><thead><tr><th>事务2</th><th>事务3</th><th>事务4</th><th>事务5</th></tr></thead><tbody><tr><td>事务开始</td><td>事务开始</td><td>事务开始</td><td>事务开始</td></tr><tr><td>……</td><td>……</td><td>……</td><td>修改张三的年龄并提交</td></tr><tr><td>运行</td><td>快照读</td><td>运行</td><td>……</td></tr><tr><td>……</td><td>……</td><td>……</td><td>……</td></tr></tbody></table><p>在这种情况下，事务3对某行数据进行了快照读，MySQL就会在这时候生成一个<code>ReadView</code>，内部变量赋值如下</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">m_ids; <span class="comment">// 2,4 (当前事务5已经提交了，所以除了自己就只有2和4活跃中)</span></span><br><span class="line">up_limit_id; <span class="comment">// 2 (m_ids中最小事务ID)</span></span><br><span class="line">low_limit_id; <span class="comment">// 5 + 1 = 6 (当前已经出现的最大事务ID+1)</span></span><br><span class="line">creator_trx_id <span class="comment">// 3 (当前事务ID)</span></span><br></pre></td></tr></table></figure><p>当事务3进行快照读的时候，就会拿事务5的这份数据进行比较，最终得到的结果是，事务3的快照是<strong>可以</strong>看到事务5对数据进行的修改的！</p><p>而且对于全局来说，事务5提交的这份数据也是当前最新的数据！</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 比较流程（依照上方MySQL的源码）</span></span><br><span class="line"><span class="number">5</span> &lt; up_limit_id || <span class="number">5</span> == <span class="number">3</span>; <span class="comment">// 不小于最小的，且也不等于当前的事务ID 3</span></span><br><span class="line"><span class="number">5</span> &gt; low_limit_id; <span class="comment">// 不大于最大的</span></span><br><span class="line"><span class="comment">// 判断5是否在m_ids里面</span></span><br><span class="line">m_ids.<span class="built_in">contains</span>(<span class="number">5</span>); <span class="comment">// 不在</span></span><br><span class="line"><span class="comment">// 结论：return true;</span></span><br><span class="line"><span class="comment">// 也就是事务3可以看到事务5的修改</span></span><br></pre></td></tr></table></figure><h2 id="4-3-当前读实操"><a href="#4-3-当前读实操" class="headerlink" title="4.3 当前读实操"></a>4.3 当前读实操</h2><p>快照读的场景基本搞明白了，再来试试当前读（这里小提一嘴，<strong>写-写并发</strong>可以理解为所有操作都是当前读，需要串行化）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ... lock <span class="keyword">in</span> share mode;</span><br></pre></td></tr></table></figure><p>下面是两个不同的操作流程，最终会得到不同的结果；操作之前，先执行如下两个sql</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test_ruc;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_ruc <span class="keyword">values</span> (<span class="number">1</span>,<span class="number">20</span>,<span class="string">&#x27;张三&#x27;</span>);</span><br></pre></td></tr></table></figure><p>在第一次测试中，我们在左侧终端更新数据之前就执行了一次快照读，此时MySQL会生成快照，即便在左侧终端的事务commit了之后，右侧也无法看到最新的<code>user_id=18</code>的数据；</p><p>但此时<strong>使用当前读，就可以读取到最新的数据</strong>！见图中右下角的红色第六次当前读操作，读到了最新修改的<code>user_id=18</code>的数据。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/c7088a7f3657cc02ea436a8bfd30cb88.png" alt="image-20230912103634717"></p><p>而在第二次测试中，我们让左侧终端完成所有操作并提交事务后，右侧终端再去查询。会发现快照读和当前读都能查询到最新的修改，因为此时对于右侧终端而言并没有其他活跃的事务，当前读和快照读就没有区别了。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/615e7b7cfb64f9d8f4020469bd669cf3.png" alt="image-20230912103902180"></p><p>由此可见</p><ul><li>快照读的快照是第一次select查询的时候生成的；</li><li>当前读能绕过快照，实时查看到最新数据！</li></ul><h2 id="4-4-RR和RC的区别"><a href="#4-4-RR和RC的区别" class="headerlink" title="4.4 RR和RC的区别"></a>4.4 RR和RC的区别</h2><p>先复习一下，RC是读已提交（Read Committed），RR是可重复读（Repeatble Read）。</p><ul><li>经过上面的测试我们可以知道，正是Read View生成时机的不同，从而造成RC&#x2F;RR级别下快照读的结果的不同；</li><li>在RR级别下的某个事务的对某条记录的第一次快照读会创建一个快照及Read View, 将当前系统活跃的其他事务记录起来；</li></ul><p>此后在调用快照读的时候，还是使用的是<strong>同一个Read View</strong>，所以只要当前事务在其他事务提交更新之前使用过快照读，那么之后的快照读使用的都是同一个Read View，所以当前事务对<strong>第一次快照读之后</strong>的修改不可见。</p><ul><li>即RR级别下，快照读生成Read View时，Read View会记录此时所有其他活动事务的快照，这些事务的修改对于当前事务都是不可见的。而早于Read View创建的事务所做的修改均是可见。</li><li>而在RC级别下的事务中，每次快照读都会<strong>新生成一个快照</strong>和Read View, 这就是我们在RC级别下的事务中可以看到别的事务提交的更新的原因；</li></ul><p>总之在RC隔离级别下，是每个快照读都会生成并获取最新的Read View；而在RR隔离级别下，则是同一个事务中的第一个快照读才会创建Read View，之后的快照读获取的都是同一个Read View。</p><p>正是RC每次快照读，都会形成新的Read View，能看到其他事务的实时修改，所以，RC才会有<strong>不可重复读</strong>问题。</p><h2 id="4-5-封锁和封锁协议"><a href="#4-5-封锁和封锁协议" class="headerlink" title="4.5 封锁和封锁协议"></a>4.5 封锁和封锁协议</h2><p>在《数据库系统原理》学习中会涉及到这个概念。</p><h3 id="4-5-1-X锁和S锁"><a href="#4-5-1-X锁和S锁" class="headerlink" title="4.5.1 X锁和S锁"></a>4.5.1 X锁和S锁</h3><p>首先认识一下两种封锁类型，分别是X锁和S锁：</p><ul><li>X锁（写锁）：上了X锁后其他事务不能对对象上其他锁，只有上锁的事务才能操作读写；</li><li>S锁（读锁）：上了S锁后，其他事务也能上S锁和读取，但是不能修改。上了S锁后不能上X锁；</li></ul><p>其实S锁和X锁就是一个基本的读写锁的概念，比较好理解。</p><p>下图是一个封锁类型的相容矩阵。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2024/01/b8734d0acaa70626527c9b1155b72a9b.png" alt="image.png"></p><h3 id="4-5-2-三级封锁协议"><a href="#4-5-2-三级封锁协议" class="headerlink" title="4.5.2 三级封锁协议"></a>4.5.2 三级封锁协议</h3><p>然后是分为三级的封锁协议：</p><ul><li>一级：事务T操作数据之前上X锁，事务结束才能释放</li><li>二级：事务T操作数据之前上X锁（一级）其他事务读取该数据之前上S锁，读取完毕后释放S；</li><li>三级：事务T操作数据之前上X锁（一级）其他事务读取该数据之前上S锁，直到事务结束释放；这样能避免丢失修改、读脏数据和不可重复读，也是最常用的维护一致性的手段；</li></ul><p>如果所有事务都遵循<strong>第三级封锁协议</strong>，由于其隔离级别高，这些事务无论如何交叉并行，最终都是可串行化的调度。</p><h3 id="4-5-3-两段锁协议-2PL"><a href="#4-5-3-两段锁协议-2PL" class="headerlink" title="4.5.3 两段锁协议 2PL"></a>4.5.3 两段锁协议 2PL</h3><p>因为第三级封锁协议太过严苛，对并发性有负面影响，三级封锁协议其实是两段锁协议的特例（更严苛的两段锁协议）</p><p>两段锁协议要求：事务在对任何数据进行读写前，需要获得对该数据的封锁；而事务在释放任何一个封锁后，不可以在获得任何其他封锁。</p><p>事务遵顼两段锁协议是可串行化的充分条件，但遵循两段锁协议<strong>是可能发生死锁的</strong>。</p><h1 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h1><p>关于MySQL事务的内容到这里基本就OVER了，内容多多，也需要多多理解和复习！</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可以深入阅读如下文章</span><br><span class="line">https://blog.csdn.net/SnailMann/article/details/94724197</span><br><span class="line">https://www.cnblogs.com/f-ck-need-u/archive/2018/05/08/9010872.html</span><br><span class="line">https://blog.csdn.net/chenghan_yang/article/details/97630626</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">慕雪年华</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/2200233148/">https://blog.musnow.top/posts/2200233148/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.musnow.top" target="_blank">慕雪的寒舍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="https://img.musnow.top/i/2023/04/64302610057ae.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://afdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.png" alt="爱发电"></a><div class="post-qr-code-desc">爱发电</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3873856211/" title="【MySQL】字节跳动MySQL连环40问"><img class="cover" src="https://img.musnow.top/i/2023/09/6503a383ea905.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【MySQL】字节跳动MySQL连环40问</div></div></a></div><div class="next-post pull-right"><a href="/posts/3474107655/" title="【MySQL】索引"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【MySQL】索引</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/577382991/" title="【MySQL】安装和基础环境配置"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-06</div><div class="title">【MySQL】安装和基础环境配置</div></div></a></div><div><a href="/posts/3474107655/" title="【MySQL】索引"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-07</div><div class="title">【MySQL】索引</div></div></a></div><div><a href="/posts/2259981507/" title="【Sqlite3】maraidb和sqlite3部分命令操作区别"><img class="cover" src="https://img.musnow.top/i/2023/05/6455b03a09341.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-05-04</div><div class="title">【Sqlite3】maraidb和sqlite3部分命令操作区别</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/favicon.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">慕雪年华</div><div class="author-info__description">爱折腾的代码初学者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">373</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">20</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="个人主页"><i class="fas fa-globe-asia"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="导航站点"><i class="fas fa-server"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss-square"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到寒舍</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-text">1.什么是事务？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%9C%BA%E6%99%AF%E4%B8%BE%E4%BE%8B"><span class="toc-text">1.1 场景举例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E8%BD%AC%E8%B4%A6"><span class="toc-text">1.1.1 转账</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E5%8D%96%E7%A5%A8"><span class="toc-text">1.1.2 卖票</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BB%8B%E7%BB%8D-ACID"><span class="toc-text">1.2 事务的介绍 ACID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%94%AF%E6%8C%81"><span class="toc-text">1.3 事务的存储引擎支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E4%BF%9D%E5%AD%98%E7%82%B9"><span class="toc-text">1.4 保存点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4%E6%93%8D%E4%BD%9C"><span class="toc-text">1.5 基础命令操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8"><span class="toc-text">2.使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8F%90%E4%BA%A4%E6%96%B9%E5%BC%8F"><span class="toc-text">2.1 提交方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%9C%BA%E6%99%AF%E6%BC%94%E7%A4%BA"><span class="toc-text">2.2 场景演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E6%95%B0%E6%8D%AE%E5%9B%9E%E6%BB%9A%E6%BC%94%E7%A4%BA"><span class="toc-text">2.2.1 数据回滚演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96%E6%BC%94%E7%A4%BA"><span class="toc-text">2.2.2 数据持久化演示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-%E8%87%AA%E5%8A%A8%E6%8F%90%E4%BA%A4"><span class="toc-text">2.2.3 自动提交</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-4-%E5%8D%95%E6%9D%A1SQL%E5%92%8C%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-text">2.2.4 单条SQL和事务的关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E7%BB%93%E8%AE%BA"><span class="toc-text">2.3 结论</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-text">3.事务隔离级别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%9F%BA%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="toc-text">3.1 基本说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E8%AF%BB%E6%9C%AA%E6%8F%90%E4%BA%A4"><span class="toc-text">3.2 读未提交</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4"><span class="toc-text">3.3 读已提交</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E5%87%BA%E9%97%AE%E9%A2%98%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-text">3.3.1 出问题的场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="toc-text">3.4 可重复读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E4%B8%B2%E8%A1%8C%E5%8C%96"><span class="toc-text">3.5 串行化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E4%B8%B2%E8%A1%8C%E5%8C%96%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">3.5.1 串行化的适用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-%E4%B8%B2%E8%A1%8C%E5%8C%96%E5%92%8CCPP"><span class="toc-text">3.5.2 串行化和CPP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-%E6%80%BB%E7%BB%93"><span class="toc-text">3.6 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">3.7 一致性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E9%9A%94%E7%A6%BB%E6%80%A7%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-text">4.隔离性的理解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-MVCC"><span class="toc-text">4.1 MVCC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E9%9A%90%E8%97%8F%E5%88%97%E5%AD%97%E6%AE%B5"><span class="toc-text">4.1.1 隐藏列字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-undo%E6%97%A5%E5%BF%97"><span class="toc-text">4.1.2 undo日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-Read-View"><span class="toc-text">4.1.3 Read View</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%BF%AB%E7%85%A7%E8%AF%BB%E5%AE%9E%E6%93%8D"><span class="toc-text">4.2 快照读实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BF%AB%E7%85%A7%E6%98%AF%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%9F%E6%88%90%E7%9A%84%EF%BC%9F"><span class="toc-text">4.2.1 快照是什么时候生成的？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E5%AE%9E%E4%BE%8B%E8%A7%A3%E9%87%8AReadView%E7%9A%84%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-text">4.2.2 实例解释ReadView的成员变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E5%BD%93%E5%89%8D%E8%AF%BB%E5%AE%9E%E6%93%8D"><span class="toc-text">4.3 当前读实操</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-RR%E5%92%8CRC%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">4.4 RR和RC的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%B0%81%E9%94%81%E5%92%8C%E5%B0%81%E9%94%81%E5%8D%8F%E8%AE%AE"><span class="toc-text">4.5 封锁和封锁协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-X%E9%94%81%E5%92%8CS%E9%94%81"><span class="toc-text">4.5.1 X锁和S锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-%E4%B8%89%E7%BA%A7%E5%B0%81%E9%94%81%E5%8D%8F%E8%AE%AE"><span class="toc-text">4.5.2 三级封锁协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-3-%E4%B8%A4%E6%AE%B5%E9%94%81%E5%8D%8F%E8%AE%AE-2PL"><span class="toc-text">4.5.3 两段锁协议 2PL</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-end"><span class="toc-text">The end</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/2052482894/" title="【win】如何在微软官网下载windows10的iso镜像">【win】如何在微软官网下载windows10的iso镜像</a><time datetime="2024-06-19T01:59:54.000Z" title="发表于 2024-06-19 09:59:54">2024-06-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3193784003/" title="【leetcode】115.不同的子序列">【leetcode】115.不同的子序列</a><time datetime="2024-06-12T08:48:17.000Z" title="发表于 2024-06-12 16:48:17">2024-06-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3529841087/" title="【leetcode】392.判断子序列">【leetcode】392.判断子序列</a><time datetime="2024-06-09T01:44:27.000Z" title="发表于 2024-06-09 09:44:27">2024-06-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/3174951422/" title="【leetcode】买卖股票的最佳时机（汇总篇）">【leetcode】买卖股票的最佳时机（汇总篇）</a><time datetime="2024-06-07T11:39:46.000Z" title="发表于 2024-06-07 19:39:46">2024-06-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/main/mothra.webp)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By 慕雪年华</div><div class="footer_custom_text"><img src="/img/ico/gonganbeian.png" height="15">&nbsp;<a href="https://beian.mps.gov.cn/#/query/webSearch?code=44190002007715" rel="noreferrer" target="_blank">粤公网安备44190002007715</a><br><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="/img/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4.svg" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="/img/badge/-SITEMAP-00CDCD.svg" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="/img/badge/%E7%B2%A4ICP%E5%A4%872023007189-red.svg" height="20px"></a><br><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/img/ico/upyun_cdn_w.png" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.3/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.2/mermaid.min.js').then(runMermaid)
  }

  btf.addModeChange('mermaid', runMermaid)

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>function loadArtalk () {
  function initArtalk () {
    window.artalkItem = new Artalk(Object.assign({
      el: '#artalk-wrap',
      server: 'https://artk.musnow.top',
      site: 'mublog',
      pageKey: location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      countEl: '.artalk-count'
    },null))

    if (GLOBAL_CONFIG.lightbox === 'null') return
    window.artalkItem.use(ctx => {
      ctx.on('list-loaded', () => {
        ctx.getCommentList().forEach(comment => {
          const $content = comment.getRender().$content
          btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
        })
      })
    })
  }

  if (typeof window.artalkItem === 'object') initArtalk()
  else {
    getCSS('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.css').then(()=>{
      getScript('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.js').then(initArtalk)
    })
  }
}

function artalkChangeMode (theme) {
  const artalkWrap = document.getElementById('artalk-wrap')
  if (!(artalkWrap && artalkWrap.children.length)) return
  const isDark = theme === 'dark'
  window.artalkItem.setDarkMode(isDark)
}

btf.addModeChange('artalk', artalkChangeMode)

if ('Artalk' === 'Artalk' || !false) {
  if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
  else loadArtalk()
} else {
  function loadOtherComment () {
    loadArtalk()
  }
}</script></div><script src="/js/domain_check.js"></script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async mobile="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/search/local-search.min.js"></script></div></div></body></html>