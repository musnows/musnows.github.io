<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>【MySQL】索引 | 慕雪的寒舍</title><meta name="author" content="慕雪年华"><meta name="copyright" content="慕雪年华"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="索引的学习"><meta property="og:type" content="article"><meta property="og:title" content="【MySQL】索引"><meta property="og:url" content="https://blog.musnow.top/posts/3474107655/index.html"><meta property="og:site_name" content="慕雪的寒舍"><meta property="og:description" content="索引的学习"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.musnow.top/i/2023/04/64302610057ae.png"><meta property="article:published_time" content="2023-09-07T09:52:14.000Z"><meta property="article:modified_time" content="2024-04-11T07:59:29.000Z"><meta property="article:author" content="慕雪年华"><meta property="article:tag" content="Linux"><meta property="article:tag" content="mysql"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.musnow.top/i/2023/04/64302610057ae.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/3474107655/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"距离上次更新本文已经过去了","messageNext":"天，文章部分内容可能已经过时，请注意甄别"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":420},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":600,"languages":{"author":"作者: 慕雪年华","link":"链接: ","source":"来源: 慕雪的寒舍","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"【MySQL】索引",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-04-11 15:59:29"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/equipment/equipment.css?1"><script>!function(r){"use strict";!function(){var t=window,s=document,e=r,c="".concat("https:"===s.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),i=s.createElement("script"),n=s.getElementsByTagName("script")[0];i.type="text/javascript",i.setAttribute("charset","UTF-8"),i.async=!0,i.src=c,i.id="LA_COLLECT",e.d=i;function o(){t.LA.ids.push(e)}t.LA?t.LA.ids&&o():(t.LA=r,t.LA.ids=[],o()),n.parentNode.insertBefore(i,n)}()}({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="慕雪的寒舍" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/favicon.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> 机器人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 友链文章</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url(https://img.musnow.top/i/2023/04/64302610057ae.png)"><nav id="nav"><span id="blog-info"><a href="/" title="慕雪的寒舍"><img class="site-icon" src="/favicon.jpg"><span class="site-name">慕雪的寒舍</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> 机器人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 友链文章</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">【MySQL】索引</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-07T09:52:14.000Z" title="发表于 2023-09-07 17:52:14">2023-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-04-11T07:59:29.000Z" title="更新于 2024-04-11 15:59:29">2024-04-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">编程学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/%E6%95%B0%E6%8D%AE%E5%BA%93SQL/">数据库SQL</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>39分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title="【MySQL】索引"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-索引"><a href="#1-索引" class="headerlink" title="1.索引"></a>1.索引</h1><h2 id="1-1-为啥需要索引？"><a href="#1-1-为啥需要索引？" class="headerlink" title="1.1 为啥需要索引？"></a>1.1 为啥需要索引？</h2><p>对于数据库而言，查询始终是一个高频的操作；假设在数据量到百万级的时候，查询一个用户信息就要花5秒中，那用户肯定不愿意等待你的系统响应，这就造成了用户流失。</p><p>所以，MySQL必须使用某种方式来保证查询的高速可靠，索引就诞生了；</p><p>对于使用者而言，索引是很香的，因为你只需要执行<code>create index</code>给指定的列，那么MySQL就会自动帮你维护一系列索引创建的操作，查询嘎嘎快！</p><p>但，查询速度的提高是以插入、更新、删除等操作的速度为代价的，这些写操作会增加大量的IO；索引的价值在于提高海量数据的查询速度；</p><p>常见的索引</p><ul><li>主键索引</li><li>唯一键索引</li><li>普通索引</li><li>复合索引</li><li>全文索引</li></ul><h2 id="1-2-索引的效果"><a href="#1-2-索引的效果" class="headerlink" title="1.2 索引的效果"></a>1.2 索引的效果</h2><p>通过如下的大数据用例，我们能看到索引的效果几何</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database if <span class="keyword">exists</span> `bit_index`;</span><br><span class="line"><span class="keyword">create</span> database if <span class="keyword">not</span> <span class="keyword">exists</span> `bit_index` <span class="keyword">default</span> <span class="type">character</span> <span class="keyword">set</span> utf8;</span><br><span class="line">use `bit_index`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 构建一个8000000条记录的数据</span></span><br><span class="line"><span class="comment">-- 构建的海量表数据需要有差异性，所以使用存储过程来创建， 拷贝下面代码就可以了，暂时不用理解</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 产生随机字符串</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_string(n <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">returns</span> <span class="type">varchar</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> chars_str <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span></span><br><span class="line"><span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line"><span class="keyword">declare</span> return_str <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">while i <span class="operator">&lt;</span> n do</span><br><span class="line"><span class="keyword">set</span> return_str <span class="operator">=</span>concat(return_str,<span class="built_in">substring</span>(chars_str,<span class="built_in">floor</span>(<span class="number">1</span><span class="operator">+</span>rand()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line"><span class="keyword">set</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">end</span> while;</span><br><span class="line"><span class="keyword">return</span> return_str;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 产生随机数字</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_num( )</span><br><span class="line"><span class="keyword">returns</span> <span class="type">int</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">set</span> i <span class="operator">=</span> <span class="built_in">floor</span>(<span class="number">10</span><span class="operator">+</span>rand()<span class="operator">*</span><span class="number">500</span>);</span><br><span class="line"><span class="keyword">return</span> i;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建存储过程，向雇员表添加海量数据</span></span><br><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_emp(<span class="keyword">in</span> <span class="keyword">start</span> <span class="type">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="type">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">declare</span> i <span class="type">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">repeat</span><br><span class="line"><span class="keyword">set</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> EMP <span class="keyword">values</span> ((<span class="keyword">start</span><span class="operator">+</span>i)</span><br><span class="line">,rand_string(<span class="number">6</span>),<span class="string">&#x27;SALESMAN&#x27;</span>,<span class="number">0001</span>,curdate(),<span class="number">2000</span>,<span class="number">400</span>,rand_num());</span><br><span class="line">until i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">end</span> repeat;</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 雇员表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `EMP` (</span><br><span class="line">  `empno` <span class="type">int</span>(<span class="number">6</span>) unsigned zerofill <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;雇员编号&#x27;</span>,</span><br><span class="line">  `ename` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;雇员姓名&#x27;</span>,</span><br><span class="line">  `job` <span class="type">varchar</span>(<span class="number">9</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;雇员职位&#x27;</span>,</span><br><span class="line">  `mgr` <span class="type">int</span>(<span class="number">4</span>) unsigned zerofill <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;雇员领导编号&#x27;</span>,</span><br><span class="line">  `hiredate` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;雇佣时间&#x27;</span>,</span><br><span class="line">  `sal` <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;工资月薪&#x27;</span>,</span><br><span class="line">  `comm` <span class="type">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;奖金&#x27;</span>,</span><br><span class="line">  `deptno` <span class="type">int</span>(<span class="number">2</span>) unsigned zerofill <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;部门编号&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行存储过程，添加8000000条记录</span></span><br><span class="line"><span class="keyword">call</span> insert_emp(<span class="number">100001</span>, <span class="number">8000000</span>);</span><br></pre></td></tr></table></figure><p>在这个表里面，有大量的数据，其默认状态下，并没有配置索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; desc EMP;</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">| Field    | Type                     | Null | Key | Default | Extra |</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">| empno    | int(6) unsigned zerofill | NO   |     | NULL    |       |</span><br><span class="line">| ename    | varchar(10)              | YES  |     | NULL    |       |</span><br><span class="line">| job      | varchar(9)               | YES  |     | NULL    |       |</span><br><span class="line">| mgr      | int(4) unsigned zerofill | YES  |     | NULL    |       |</span><br><span class="line">| hiredate | datetime                 | YES  |     | NULL    |       |</span><br><span class="line">| sal      | decimal(7,2)             | YES  |     | NULL    |       |</span><br><span class="line">| comm     | decimal(7,2)             | YES  |     | NULL    |       |</span><br><span class="line">| deptno   | int(2) unsigned zerofill | YES  |     | NULL    |       |</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">8 rows in set (0.001 sec)</span><br></pre></td></tr></table></figure><p>此时如果你直接全列查询，进程就会阻塞在这里</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/bd7ed9436789f27dec4d4ba2ab40ea5b.png" alt="image-20230907172052198"></p><p>进MySQL的文件路径看看，会发现这张表的大小已经到了惊人的564mb，虽然我们的内存也许能存的下这么大的数据，但实际IO读写这么大量的数据是非常耗时的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vm-cnt8:/var/lib/mysql/bit_index]# ll -h</span><br><span class="line">total 565M</span><br><span class="line">-rw-rw----. 1 mysql mysql   61 Sep  6 05:36 db.opt</span><br><span class="line">-rw-rw----. 1 mysql mysql  770 Sep  6 05:36 EMP.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql 564M Sep  6 05:39 EMP.ibd</span><br></pre></td></tr></table></figure><p>在之前的查询操作中提到过，对于这种大数据表的时候，我们应该避免使用全列查询，而应该设置<code>limit</code>只查询出少量用例数据，来判断这个表的数据结构和作用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; select * from EMP limit 3;</span><br><span class="line">+--------+--------+----------+------+---------------------+---------+--------+--------+</span><br><span class="line">| empno  | ename  | job      | mgr  | hiredate            | sal     | comm   | deptno |</span><br><span class="line">+--------+--------+----------+------+---------------------+---------+--------+--------+</span><br><span class="line">| 100002 | FNXAKX | SALESMAN | 0001 | 2023-09-06 00:00:00 | 2000.00 | 400.00 |    327 |</span><br><span class="line">| 100003 | rQbLBy | SALESMAN | 0001 | 2023-09-06 00:00:00 | 2000.00 | 400.00 |    394 |</span><br><span class="line">| 100004 | wRVdDF | SALESMAN | 0001 | 2023-09-06 00:00:00 | 2000.00 | 400.00 |    195 |</span><br><span class="line">+--------+--------+----------+------+---------------------+---------+--------+--------+</span><br><span class="line">3 rows in set (0.001 sec)</span><br></pre></td></tr></table></figure><p>在没有索引的情况下进行一个查询，用时大约在1.6秒左右</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/cec2caa51179f05f7309b5c968a539df.png" alt="image-20230907172357990"></p><p>这时候我们来对empno列创建一个主键索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> EMP <span class="keyword">add</span> <span class="keyword">primary</span> key(empno);</span><br></pre></td></tr></table></figure><p>因为表中的数据很多，所以设置主键索引也需要耗费一定时间，这个时间内，其实就是MySQL在后台帮我们创建索引所需要的数据结构的过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; alter table EMP add primary key(empno);</span><br><span class="line">Query OK, 0 rows affected (17.184 sec)              </span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>再来查询一下刚刚查询的数据，可以看到，用时只有<code>0.000 sec</code>，直接秒回！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/0a7e44f14cf052534721da8beca3a073.png" alt="image-20230907172541115"></p><p>这便是索引在提升性能方面的重大作用！</p><h2 id="1-3-MySQL和文件系统"><a href="#1-3-MySQL和文件系统" class="headerlink" title="1.3 MySQL和文件系统"></a>1.3 MySQL和文件系统</h2><h3 id="1-3-1-Linux文件系统"><a href="#1-3-1-Linux文件系统" class="headerlink" title="1.3.1 Linux文件系统"></a>1.3.1 Linux文件系统</h3><p>在之前对<a href="https://blog.musnow.top/posts/2864480005/">Linux文件系统</a>的学习中，我们知道在磁盘中，一个区块是512KB，在Linux系统中，为了提高效率，会采用4KB的分块对数据进行读取。哪怕你只是修改1KB，也是需要将4KB完整读取，再写入回去的。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/cda9058519a11abeed3a167eb6690d0c.png" alt="image-20230907174710578"></p><p>因为机械硬盘物理结构的限制，<strong>随机读取的性能不佳</strong>，一次性读取100KB数据，远远优于100次读取1KB。因为一次性读取的时候，只需要一次寻道就能将磁头摆到正确的位置，往里面写数据就完事了。但多次读取小数据的时候，尽管相邻的两次IO操作在同一时刻发出，但如果它们的请求的扇区地址相差很大的话也只能称为随机访问，而非连续访问。</p><p>随机访问就要多次寻道，每次写入的量又很少，大大增加了IO的负担。</p><h3 id="1-3-2-MySQL和磁盘交互基本单位-16KB"><a href="#1-3-2-MySQL和磁盘交互基本单位-16KB" class="headerlink" title="1.3.2 MySQL和磁盘交互基本单位 16KB"></a>1.3.2 MySQL和磁盘交互基本单位 16KB</h3><p>而MySQL中，为了更好的实现对数据IO量的缩减和控制，其内部将16KB作为一次IO的基本单位，这个大小我们叫做MySQL的文件Page；</p><ul><li>MySQL中的数据文件，都是以Page为基本单位保存至磁盘里面的；</li><li>MySQL中的CURD操作，都需要通过计算来定位到需要修改和访问的数据的位置；</li><li>涉及到计算的操作都需要CPU参与，CPU只能处理内存中的数据，这就要求MySQL需要提前将一部分数据加载到内存中；</li><li>所以在MySQL运行的这段时间内，其操作的数据会同时存在于内存和磁盘中，需要以特定的策略将内存中的数据刷新到磁盘中；这个操作就是IO，基本单位是Page；</li><li>为了更好的管理这些操作，MySQL会自己维护一个<code>buffer pool</code>的内存空间，来进行缓存。</li><li>MySQL是一个应用程序，它的所有文件IO操作都需要通过操作系统提供的接口来实现！但内部的刷盘逻辑是可以由MySQL来调用系统接口来自主控制的，而不需要呆板地遵守操作系统的自动策略；（MySQL创建<code>buffer pool</code>也是基于更高的自主性来考虑的）</li><li>最终目标是尽可能地减少IO操作，提高运行效率；</li></ul><p>运行如下命令可以看到MySQL中关于Page设置的全局变量，即16KB</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; SHOW GLOBAL STATUS LIKE &#x27;innodb_page_size&#x27;;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Innodb_page_size | 16384 |</span><br><span class="line">+------------------+-------+</span><br><span class="line">1 row in set (0.001 sec)</span><br></pre></td></tr></table></figure><h3 id="1-3-3-为什么要用Page为单位进行交互？"><a href="#1-3-3-为什么要用Page为单位进行交互？" class="headerlink" title="1.3.3 为什么要用Page为单位进行交互？"></a>1.3.3 为什么要用Page为单位进行交互？</h3><p>为何MySQL和磁盘进行IO交互的时候，要采用Page的方案进行交互呢？用多少，加载多少不香吗？</p><p>先来个测试用例看看吧，这是一个非常简单的用户表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 主键默认生成主键索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">user</span> (</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> key, </span><br><span class="line">    age <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">16</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 插入多条记录，主键没有按顺序插入</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, age, name) <span class="keyword">values</span>(<span class="number">3</span>, <span class="number">18</span>, <span class="string">&#x27;杨过&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, age, name) <span class="keyword">values</span>(<span class="number">4</span>, <span class="number">16</span>, <span class="string">&#x27;小龙女&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, age, name) <span class="keyword">values</span>(<span class="number">2</span>, <span class="number">26</span>, <span class="string">&#x27;黄蓉&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, age, name) <span class="keyword">values</span>(<span class="number">5</span>, <span class="number">36</span>, <span class="string">&#x27;郭靖&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, age, name) <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">56</span>, <span class="string">&#x27;欧阳锋&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="comment">-- 最终发现数据是有序的</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> age <span class="operator">|</span> name      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1</span>  <span class="operator">|</span> <span class="number">56</span>  <span class="operator">|</span> 欧阳锋     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">2</span>  <span class="operator">|</span> <span class="number">26</span>  <span class="operator">|</span> 黄蓉       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3</span>  <span class="operator">|</span> <span class="number">18</span>  <span class="operator">|</span> 杨过       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">4</span>  <span class="operator">|</span> <span class="number">16</span>  <span class="operator">|</span> 小龙女     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">5</span>  <span class="operator">|</span> <span class="number">36</span>  <span class="operator">|</span> 郭靖       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----+-----------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>在上面的5条记录中，如果MySQL要查找id&#x3D;2的记录，第一次加载id&#x3D;1，第二次加载id&#x3D;2，一次一条记录，<strong>那么就需要2次IO</strong>。如果要找id&#x3D;5，那么就需要5次IO。</p><p>但，如果这5条(或者更多)都被保存在一个Page中(16KB，能保存很多记录)，那么第一次IO查找id&#x3D;2的时候，整个Page会被加载到MySQL的<code>Buffer Pool</code>中，这里完成了一次IO。但是往后如果在查找id&#x3D;1,3,4,5等，完全不需要进行IO了，而是直接在内存中进行了。所以，就在单Page里面，大大减少了IO的次数！</p><p>虽然我们不能保证后续的几次IO一定在这次加载的Page中，但根据<code>局部性原理</code>，其访问相近的几条数据的概率是很大的！所以这样最终是能提升IO效率的！</p><p>往往IO效率低下的最主要矛盾不是IO单次数据量的大小，<strong>而是IO的次数</strong>。</p><h2 id="1-4-B-树和Page"><a href="#1-4-B-树和Page" class="headerlink" title="1.4 B+树和Page"></a>1.4 B+树和Page</h2><p>有了对Page的认识，接下来就需要用一个数据结构来维护这些加载到<code>Buffer Pool</code>当中的Page了。这时候，我们的B+树就登场了。</p><h3 id="1-4-1-单个Page"><a href="#1-4-1-单个Page" class="headerlink" title="1.4.1 单个Page"></a>1.4.1 单个Page</h3><p>单个Page里面存放的肯定是一部分的数据，我们可以加上前后指针，以双链表的形式将所有Page连起来，这样就能实现数据的遍历；在MySQL中，就是这么操作的。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/fafa9750da8082ecdf3927663eb49941.png" alt="image-20230907182425023"></p><p>因为存在主键，MySQL还会给单个Page中的数据依照主键进行排序，从上图就能看出阿里，单个Page中数据是依照主键按序排列的；且每一个数据都会链接到下一个数据上；</p><p>这样排序后，数据库在进行数据筛选的时候，就能更好的定位到数据的位置，减少查询耗时。插入时排序也能让后续在进行数据降序&#x2F;升序输出的时候，无需二次对数据进行排序了；</p><h3 id="1-4-2-多个Page"><a href="#1-4-2-多个Page" class="headerlink" title="1.4.2 多个Page"></a>1.4.2 多个Page</h3><p>既然一个Page是如此，那多个Page呢？</p><ul><li>前面提到了，当MySQL需要加载数据的时候，会将和这个数据相邻近的其他数据，以16KB为单位一起加载到一个Page里面，并连接到这个双向链表上；</li><li>这样，我们就可以通过多个Page的遍历来进行数据的定位</li><li>可链表是一个线性结构，MySQL肯定不可能用线性结构来维护数据吧？那样查询的效率也太低了，每次都需要O(N)的遍历，数据一多就慢慢慢！</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/12d3385dee351703d07d0104f014b80a.png" alt="image-20230907183025895"></p><p>所以，我们肯定要在双向链表的基础上添加其他的结构来进行查找的优化！这时候就可以引入<strong>目录</strong>了</p><h4 id="页目录"><a href="#页目录" class="headerlink" title="页目录"></a>页目录</h4><p>在我们看书的时候，就会有目录来帮助我们快速查找到某一个章节。比如我们想看第九章的内容，那就可以先看目录，找到第九章的页码，再进行阅读。</p><p>对于MySQL中的数据，这个情景也是适用的，我们给数据上一个目录，查询的时候先根据目录定位到具体的page，我们可以知道1-10号数据都在这个page里面，那就直接去里面找就行了；这时候查找的效率就比单纯的从链表开头进行遍历快多了！</p><p>当然，和书籍的目录需要消耗纸张一样，在MySQL中对数据设置目录也是需要消耗空间的，这就是一种用空间换时间的做法，而在生产环境中，时间显然更加宝贵！</p><h4 id="单页目录"><a href="#单页目录" class="headerlink" title="单页目录"></a>单页目录</h4><p>在单个Page里面，我们可以安如下的方式设定一个目录，嗝一定间隔就设置一个新的节点作为目录。在数据量小的时候，这个目录的作用不算大，但数据量一大，目录对搜索效率的提升是非常可观的！</p><blockquote><p>比如，我们要查找id&#x3D;4记录，之前必须线性遍历4次，才能拿到结果。现在直接通过目录2[3]，直接进行定位新的起始位置，只需要遍历3次就能找到结果，提高了效率。</p></blockquote><p>即便在单个Page中添加目录会导致这个Page实际存放的数据变少，但这是必要的牺牲！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/052c18b6ad7065a68f008d8234f08dfc.png" alt="image-20230907191523912"></p><h4 id="多页目录"><a href="#多页目录" class="headerlink" title="多页目录"></a>多页目录</h4><p>前面提到，MySQL会自动把新的数据加载到一个Page中，并链接到已有链表上；但是线性遍历需要大量的IO，每次遇到新的Page的时候，就需要将其加载到内存里面，进行遍历，这就使得单个Page中的目录不那么实用了；</p><ul><li>单个Page的目录是小节目录</li><li>多个Page的目录是章节目录</li></ul><p>所以我们必须给多个Page也加上一个顶层的章节目录，进一步优化效率！</p><ul><li>使用一个Page来指向多个Page，存放每个Page的起始key值（假设每个Page中的key都有序且为升序）；这个Page中不存放实际的数据，只有目录值；</li><li>遍历的时候，先通过多Page的目录找到我们要去的Page，再去访问该实际存储数据的Page中的单Page目录，最终查找到目标数据；</li><li>所以，每个多Page的目录项中就是一个键值+对应普通Page的指针</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/f14ce259e947e2cc699ae2341e3e83cd.png" alt="image-20230907192840730"></p><p>一层目录Page不够，我们还可以再加一层。这样就实现了一个类似于二叉树的结构，只不过每一个节点Page中都包含多个Page的key+指针，最终只有叶子节点是实际存储数据的！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/485204263a90e86428707dd92244878b.png" alt="image-20230907193042036"></p><p>这个数据结构就叫做B+树（注意，不是B树！）而整个上图中的数据接就是MySQL中对user表做的索引！</p><p>此时的查询，需要经过的节点肯定变少了，比如我们需要查询<code>id=12</code>的用户：</p><ul><li>顶层判断，12&gt;11&gt;1，向右走【2次比较】</li><li>第二层判断，12&gt;11且12&lt;16，向左走，来到具体的Page【2次比较】</li><li>查找单页目录，12&gt;11且12&lt;13；【2次比较】</li><li>从11开始遍历，走一步就能找到【1次比较】</li></ul><p>最终，我们查找12的操作只用了7次就成功了。而从头开始遍历需要12次才能找到它；</p><p>遍历次数的减少，就等同于IO次数的减少，最终查询的效率就变高了！</p><blockquote><p>这里的分析可能有误，不过结论是没有问题的，分页肯定能增加查找的效率！</p></blockquote><p>另外，MySQL还可以根据访问的频率，定期的释放一些Page；比如在B+树中，可能树的右半部分很少被访问，那就可以暂时释放这部分Page的空间，给其他表使用，真到遇到访问的时候，再去读盘加载这部分数据。<strong>这是由MySQL的缓存策略来自主决定的</strong>；</p><p>毕竟当一个表非常大的时候，将其全部加载到内存里面是不可行的！必须要用缓存策略和局部性原理来加载频繁使用的数据到内存中，才能在效率和负载上达到平衡；</p><p>不然你的MySQL无脑缓存Page导致占用过多内存，操作系统看不下去直接给你KILL了，那业务就完蛋了！🤣</p><h3 id="1-4-3-小结"><a href="#1-4-3-小结" class="headerlink" title="1.4.3 小结"></a>1.4.3 小结</h3><p>关于Page查找的小结如下</p><ul><li>Page分为目录页和数据页。目录页只放各个下级Page的最小键值和该Page的指针。</li><li>查找的时候，自顶向下找，只需要加载部分目录页到内存，即可完成算法的整个查找过程，大大减少了IO次数</li><li>范围查询的时候，可以找到区间边界的两个节点的位置，然后直接通过叶子节点的链表进行遍历，取出数据即可！</li><li>MySQL可以根据访问频率，适当地预先加载或者释放一些Page的空间，并不是说一张表的所有数据都必须全部加载到内存里面；</li></ul><p>后续我还会学习B树和B+树数据结构在CPP中的实现，敬请关注我的博客！</p><h2 id="1-5-为什么其他数据结构不适合索引？"><a href="#1-5-为什么其他数据结构不适合索引？" class="headerlink" title="1.5 为什么其他数据结构不适合索引？"></a>1.5 为什么其他数据结构不适合索引？</h2><p>在认识这个问题之前，我们首先要记住上文提到的一个结论：真正影响索引性能的，是和硬盘IO的次数，IO次数越少，性能越高；</p><ul><li>链表、线性表：都是线性遍历，压根没有索引的功能</li><li>二叉搜索树：在极端场景下会退化成普通二叉树，还是线性遍历</li><li><code>AVLTree/RBTree</code>：虽然相对平衡，但二叉结构会导致树的整体过高，自顶向下查询的时候，需要经过多层的多次IO，才能找到目标数据（B+树的层数更少，在这种情况下B+树更优秀）</li><li>HASH：虽然查找的时候很快，基本能做到<code>O(1)</code>，但<strong>范围查询</strong>的效果不佳；在MySQL中也是支持HASH索引的，比如<code>MEMOY/HEAP/NDB</code>存储引擎；</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/ab7bb4e2660ff869b45d61974beb6ed7.png" alt="image-20230907193621724"></p><p>那B树为什么不适合呢？作为一个多叉树结构，B树的同层能比红黑树存储更多信息，看上去也是可以做索引的呀？</p><p>牵扯到B树和B+树的区别了，来看看二者的结构图</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/d485930385b11585cdb3c15e87e2b2df.png" alt="image-20230907145442565"></p><p>文字说明如下：</p><ul><li>B树的每一个节点都会存放一定的数据和page指针；</li><li>B+树只有叶子节点会存放数据，非叶子节点只有page的目录；</li><li>B+树的叶子节点全部相连；</li></ul><p>这就引出了B+树的两个优点：</p><ul><li>因为B+树的非叶子节点只需要存储page目录，所以在一个非叶子节点中就能存放较多的目录索引，使得树整体更矮；</li><li>B+树的叶子节点全部相连，方便进行范围遍历，比如<code>where sal&gt;100 and sal &lt; 300</code>的这种范围条件，就可以直接通过叶子节点的链表向后遍历来解决；</li></ul><p>最终的效率问题依旧落到了如何让树更矮来<strong>减少IO次数</strong>，因为在整体上B+树都能做到较矮，查询效率优秀，方便范围查询；所以MySQL主要选用了B+树作为索引结构。</p><h2 id="1-6-聚簇-x2F-非聚簇索引"><a href="#1-6-聚簇-x2F-非聚簇索引" class="headerlink" title="1.6 聚簇&#x2F;非聚簇索引"></a>1.6 聚簇&#x2F;非聚簇索引</h2><h3 id="1-6-1-说明"><a href="#1-6-1-说明" class="headerlink" title="1.6.1 说明"></a>1.6.1 说明</h3><p>InnoDB的数据是和B+树一起存放的，叶子节点里面才有数据；这种数据和索引在一起的形式，叫做<strong>聚簇索引</strong>。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/c569f1a484e8f61b916751b6d6305a2b.png" alt="image-20230907145652553"></p><p>MyISAM的叶子中没有数据，而是存放的指向数据表对应位置的指针，有额外的一张表来存放所有数据；这种<strong>数据和索引分离</strong>的形式，叫做<strong>非聚簇索引</strong>；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/6be83a012b547b33adf2f8e9cab5252d.png" alt="image-20230907145704130"></p><p>对于MyISAM存储引擎来说，<strong>其很适合进行查询</strong>，特别是大文本查找和全文索引（后文会提到）；因为MyISAM中还有一个额外的<code>倒排索引</code>：倒排索引可以更有效地处理文本搜索，因为它将文档中的每个单词映射到包含该单词的文档列表，从而使得搜索更快速和高效。</p><p>倒排索引有下面两项结构：</p><ol><li>词项（Term）列表： 对文档集合中的每个单词建立一个词项列表，该列表包含了包含该单词的所有文档的引用（例如文档ID或者文档的位置信息）。</li><li>文档索引（Document Index）： 对每个文档建立一个文档索引，该索引包含了文档中的所有单词及其位置信息。</li></ol><p>这样我们查询某个单词的时候，会先通过单词表再找到某个单词的位置信息，从而实现了索引速度的提升。而不是遍历全文查找单词。</p><h3 id="1-6-2-实机演示"><a href="#1-6-2-实机演示" class="headerlink" title="1.6.2 实机演示"></a>1.6.2 实机演示</h3><blockquote><p>在MySQL中，我们可以通过实际文件的数量看出InnoDB和MyISAM存储引擎的区别；其也反映了聚簇&#x2F;非聚簇索引的性质。</p></blockquote><p>这里我们新建一个数据库，创建user1表，默认采用的是InnoDB作为存储引擎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; create table user1( id int unsigned primary key, name varchar(200) NOT NULL );</span><br><span class="line">Query OK, 0 rows affected (0.008 sec)</span><br></pre></td></tr></table></figure><p>在MySQL的文件存储路径中，可以查看到user1表对应了两个文件，其中<code>.ibd</code>后缀指的就是InnoDB，其内部同时包含了该表中的数据和索引值；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@vm-cnt8:/var/lib/mysql/hello_mysql]# ll</span><br><span class="line">total 104</span><br><span class="line">-rw-rw----. 1 mysql mysql    61 Sep  7 02:59 db.opt</span><br><span class="line">-rw-rw----. 1 mysql mysql  1545 Sep  7 03:00 user1.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql 98304 Sep  7 03:00 user1.ibd</span><br></pre></td></tr></table></figure><p>再来创建一个属性完全相同的user2表，但采用MyISAM存储引擎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; create table user2( id int unsigned primary key, name varchar(200) NOT NULL ) engine=MyISAM;</span><br><span class="line">Query OK, 0 rows affected (0.002 sec)</span><br></pre></td></tr></table></figure><p>此时能看到，MyISAM对应的存储文件有3个，<code>.MYI</code>包含的是索引，<code>.MYD</code>包含的是实际数据；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@vm-cnt8:/var/lib/mysql/hello_mysql]# ll</span><br><span class="line">total 112</span><br><span class="line">-rw-rw----. 1 mysql mysql    61 Sep  7 02:59 db.opt</span><br><span class="line">-rw-rw----. 1 mysql mysql  1545 Sep  7 03:00 user1.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql 98304 Sep  7 03:00 user1.ibd</span><br><span class="line">-rw-rw----. 1 mysql mysql  1545 Sep  7 03:03 user2.frm</span><br><span class="line">-rw-rw----. 1 mysql mysql     0 Sep  7 03:03 user2.MYD</span><br><span class="line">-rw-rw----. 1 mysql mysql  1024 Sep  7 03:03 user2.MYI</span><br></pre></td></tr></table></figure><p>两表都有一个占用空间完全相同的<code>.frm</code>文件，这个文件中存储的就是该表的结构属性信息，因为两个表的结构完全相同，所以这个文件的大小也相同；</p><h2 id="1-7-回表查找"><a href="#1-7-回表查找" class="headerlink" title="1.7 回表查找"></a>1.7 回表查找</h2><p>创建<strong>辅助索引</strong>的时候，MyISAM依旧创建一个B+树，叶子节点也是指向对应位置的指针；所以在MyISAM中，主键&#x2F;非主键索引区别不大，无非是是否允许冗余数据的问题。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/2540a3c70fb29ad3e861374ef8a0cbe1.png" alt="image-20230907145845574"></p><p>InnoDB的辅助索引中，不再直接存放节点数据，而是存放<strong>主键key值</strong>，查询的时候根据key值回到<strong>主键索引表</strong>中进行查询，需要<strong>查询两次</strong>才能获取到结果。</p><blockquote><p>如果辅助索引中还保存数据，就会造成极大的空间浪费，一份数据被保存两次甚至更多次，显然是不合理的。</p></blockquote><p>InnoDB这个先查辅助索引表，再回到主键表中查询的动作，叫做<code>回表查询</code>；</p><p>话虽是这么说，但也并不是每次查询我们都需要回表的。比如下图是一个复合键的索引表，假设数字是用户ID（主键），文字是用户姓名，在这种情况下，我们通过用户姓名查询用户ID的时候，就不需要回到主键表也能获取到结果。</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/6004dda4aa0dd67277e214f2fa4497db.png" alt="image-20230907144213435"></p><p>另外，在一般的数据库中，B+树并不会很深，所以即便需要进行回表的两次查询，效率也不会受到较大影响；（但肯定会有一定损失）</p><h1 id="2-索引操作"><a href="#2-索引操作" class="headerlink" title="2.索引操作"></a>2.索引操作</h1><h2 id="2-1-创建索引的原则"><a href="#2-1-创建索引的原则" class="headerlink" title="2.1 创建索引的原则"></a>2.1 创建索引的原则</h2><ul><li>比较频繁作为查询条件的字段应该创建索引</li><li>唯一性太差的字段不适合单独创建索引，即使频繁作为查询条件</li><li>更新非常频繁的字段不适合作创建索引（因为每次更新都得重置索引，增加IO压力）</li><li>不会出现在where子句中的字段不该创建索引（不作为查询条件的字段）</li></ul><p>另外，如果在创建表的时候么有指定主键，那么MySQL会自动帮我们创建一个隐藏的自增主键ID（不然就没办法支持其他索引和其本身的快速查找了）</p><h2 id="2-2-创建主键索引"><a href="#2-2-创建主键索引" class="headerlink" title="2.2 创建主键索引"></a>2.2 创建主键索引</h2><p>创建表的时候指定<code>primary key</code>，默认就会创建主键索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user1( </span><br><span class="line">	id <span class="type">int</span> unsigned <span class="keyword">primary</span> key, </span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>创建表的最后，指定某列为主键索引，这个和第一种方式本质上没区别</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user1( </span><br><span class="line">	id <span class="type">int</span> unsigned , </span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, </span><br><span class="line">	<span class="keyword">primary</span> key(id) </span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>创建表了之后再添加主键</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user1( </span><br><span class="line">	id <span class="type">int</span> unsigned , </span><br><span class="line">	name <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 添加主键</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user1 <span class="keyword">add</span> <span class="keyword">primary</span> key(id);</span><br></pre></td></tr></table></figure><p>主键索引的特点：</p><ul><li>一个表里面本来就只能有一个主键，所以主键索引也只有一个（复合主键也只算一个主键）</li><li>主键索引的效率高（主键列不可重复）</li><li>主键列不能为NULL，所以也不存在无法被索引的值</li><li>一般都会用数字来作为主键，在索引中方便数据比较</li></ul><h2 id="2-3-唯一键索引"><a href="#2-3-唯一键索引" class="headerlink" title="2.3 唯一键索引"></a>2.3 唯一键索引</h2><p>当你给某一列设置为唯一键的时候，MySQL就会自动创建唯一键索引；唯一键索引其实就是普通的辅助索引，只不过其和主键一样都包含唯一的键值约束；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 直接指定唯一键</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user2(id <span class="type">int</span> <span class="keyword">primary</span> key, name <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">unique</span>);</span><br><span class="line"><span class="comment">-- 创建语句末尾指定唯一键</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user2(id <span class="type">int</span> <span class="keyword">primary</span> key, name <span class="type">varchar</span>(<span class="number">200</span>),<span class="keyword">unique</span>(name));</span><br><span class="line"><span class="comment">-- 创建后再添加唯一键</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user2(id <span class="type">int</span> <span class="keyword">primary</span> key, name <span class="type">varchar</span>(<span class="number">200</span>));</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user2 <span class="keyword">add</span> <span class="keyword">unique</span>(name);</span><br></pre></td></tr></table></figure><p>唯一索引的特点：</p><ul><li>一个表中，可以有多个唯一索引，包括复合唯一键的索引；</li><li>查询效率高；</li><li>如果在某一列建立唯一索引，必须保证这列不能有重复数据；</li><li>如果一个唯一索引上指定<code>not null</code>，等价于主键索引；</li><li>如果删除唯一键索引，也会同时删除唯一的约束属性；</li></ul><h2 id="2-4-普通键索引"><a href="#2-4-普通键索引" class="headerlink" title="2.4 普通键索引"></a>2.4 普通键索引</h2><p>创建普通索引依旧有3种方式</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在表的定义最后，指定某列为索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user3(id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    email <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">    index(name)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建完表以后指定某列为普通索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user3(id <span class="type">int</span> <span class="keyword">primary</span> key, name <span class="type">varchar</span>(<span class="number">20</span>), email</span><br><span class="line"><span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user3 <span class="keyword">add</span> index(name);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建索引的时候指定名字</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user3(id <span class="type">int</span> <span class="keyword">primary</span> key, name <span class="type">varchar</span>(<span class="number">20</span>), email</span><br><span class="line"><span class="type">varchar</span>(<span class="number">30</span>));</span><br><span class="line"><span class="keyword">create</span> index idx_name <span class="keyword">on</span> user3(name); <span class="comment">-- 创建一个索引名为 idx_name 的索引</span></span><br></pre></td></tr></table></figure><p>普通索引的特点：</p><ul><li>一个表中可以有多个普通索引</li><li>普通索引中的键值可以重复，但不要在大量重复的键值上建立索引（比如性别）</li></ul><h2 id="2-5-复合-x2F-联合索引"><a href="#2-5-复合-x2F-联合索引" class="headerlink" title="2.5 复合&#x2F;联合索引"></a>2.5 复合&#x2F;联合索引</h2><p>给多个键值创建索引，操作如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> index 索引名字 <span class="keyword">on</span> 表名(字段<span class="number">1</span>,字段<span class="number">2</span>);</span><br><span class="line"><span class="comment">-- 如果需要索引按不同的规则排序，可以在字段后加DESC和ASC</span></span><br><span class="line"><span class="keyword">create</span> index 索引名字 <span class="keyword">on</span> 表名(字段<span class="number">1</span> <span class="keyword">DESC</span>,字段<span class="number">2</span> <span class="keyword">ASC</span>);</span><br></pre></td></tr></table></figure><p>此时我们创建的索引，在字段1和字段2上会共用一个索引的<code>Key_name</code>，索引名字是相同的。</p><p>复合索引有一个好处，如果使用InnoDB时，<strong>需要查询的结果包含在索引字段中</strong>，那就可以节省一次返还到主键索引中查询的回表步骤，可以在一定程度上提高效率（在上文中已经提及此事）</p><ul><li>上面这种操作叫做<strong>索引覆盖</strong>（覆盖索引），直接从普通索引表中查询到结果；</li><li>建立复合索引相比于建立多个单列索引，还能在一定程度上减少空间消耗，提高效率；</li></ul><p>另外，在进行复合索引的查询的时候，<strong>我们只能使用用户名来查询用户ID</strong>，返过来是不行的（不会使用索引）。因为在MySQL对索引进行匹配的时候，只会匹配最左侧的索引值；</p><p>比如下图中，充当判断条件的是用户名字，通过用户名字查用户ID是OK的，反过来就不行；这种情况下MySQL不会使用索引，依旧是全表遍历；</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/6004dda4aa0dd67277e214f2fa4497db.png" alt="image-20230907144213435"></p><p>这种叫做MySQL索引的<strong>最左匹配原则</strong></p><blockquote><p>详解：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47162914/article/details/123793589">联合索引-最左匹配原则</a></p></blockquote><p>MySQL在创建复合索引的时候，首先会<strong>对最左边字段排序</strong>，也就是第一个字段，然后再在保证第一个字段有序的情况下，再排序第二个字段，以此类推。所以联合索引最左列是绝对有序的，其他字段无序。</p><p>举个例子：可以把联合索引看成“电话簿”，姓名作为联合索引，姓是第一列，名是第二列，当查找人名时，是先确定这个人姓再根据名确定人。只有名没有姓就查不到。</p><h2 id="2-6-全文索引"><a href="#2-6-全文索引" class="headerlink" title="2.6 全文索引"></a>2.6 全文索引</h2><p>如果对文章或者大量文字的字段进行检索的时候，就会使用到全文索引。MySQL提供全文索引机制，但是要求表的存储引擎必须是<code>MyISAM</code>；而且默认的全文索引只支持英文，不支持中文。如果对中文进行全文检索，可以使用sphinx的中文版(coreseek)。</p><p>这里创建的FULLTEXT全文索引其实就是一个倒排索引。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表，FULLTEXT设置全文索引</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> articles (</span><br><span class="line">    id <span class="type">INT</span> UNSIGNED AUTO_INCREMENT <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    title <span class="type">VARCHAR</span>(<span class="number">200</span>),</span><br><span class="line">    body TEXT,</span><br><span class="line">    FULLTEXT (title,body) </span><br><span class="line">)engine<span class="operator">=</span>MyISAM;</span><br><span class="line"><span class="comment">-- 插入测试数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> articles (title,body) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="string">&#x27;MySQL Tutorial&#x27;</span>,<span class="string">&#x27;DBMS stands for DataBase ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;How To Use MySQL Well&#x27;</span>,<span class="string">&#x27;After you went through a ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;Optimizing MySQL&#x27;</span>,<span class="string">&#x27;In this tutorial we will show ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;1001 MySQL Tricks&#x27;</span>,<span class="string">&#x27;1. Never run mysqld as root. 2. ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;MySQL vs. YourSQL&#x27;</span>,<span class="string">&#x27;In the following database comparison ...&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;MySQL Security&#x27;</span>,<span class="string">&#x27;When configured properly, MySQL ...&#x27;</span>);</span><br></pre></td></tr></table></figure><p>创建好表之后，查询表中索引信息，可以看到title和body字段都用上了索引名字为<code>title</code>的全文索引</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/f0c396d35a81e6ab863f7bec84174f48.png" alt="image-20230907155913783"></p><p>假设我们查询这个表中有没有包含database的文字数据，虽然成功查询了结果，但是并没有使用到全文索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> articles <span class="keyword">where</span> body <span class="keyword">like</span> <span class="string">&#x27;%database%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------------+------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> title             <span class="operator">|</span> body                                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------------+------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> MySQL Tutorial    <span class="operator">|</span> DBMS stands <span class="keyword">for</span> DataBase ...             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> MySQL vs. YourSQL <span class="operator">|</span> <span class="keyword">In</span> the following database comparison ... <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------------+------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.000</span> sec)</span><br></pre></td></tr></table></figure><p>使用explain语句可以看出是否有使用全文索引，这里的key为NULL就代表么有使用上索引；这个工具的作用是<strong>预执行</strong>，并不会实际上运行这个语句，但是会告诉你我想<strong>怎么运行它</strong>；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">explain select * from articles where body like &#x27;%database%&#x27;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: articles</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 6</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure><p>要想使用全文索引，得这么写</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> articles <span class="keyword">WHERE</span> <span class="keyword">MATCH</span> (title,body) AGAINST (<span class="string">&#x27;database&#x27;</span>);</span><br></pre></td></tr></table></figure><p>再用explain工具看看，此时就可以看到key里面显示的是title，成功使用上了全文索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">explain SELECT * FROM articles WHERE MATCH (title,body) AGAINST</span><br><span class="line">    -&gt; (&#x27;database&#x27;)\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: articles</span><br><span class="line">         type: fulltext</span><br><span class="line">possible_keys: title</span><br><span class="line">          key: title</span><br><span class="line">      key_len: 0</span><br><span class="line">          ref: </span><br><span class="line">         rows: 1</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br></pre></td></tr></table></figure><h3 id="explain工具"><a href="#explain工具" class="headerlink" title="explain工具"></a>explain工具</h3><p>这里对explain工具显示的列作一个说明。这个工具的作用是<strong>预执行</strong>，并不会实际上运行这个语句，但是会告诉你我想<strong>怎么运行它</strong>；输出结果包含如下列：</p><ul><li>id — 选择标识符，id 越大优先级越高，越先被执行；</li><li>select_type — 表示查询的类型；</li><li>table — 输出结果集的表；</li><li>partitions — 匹配的分区；</li><li>type — 表示表的连接类型；</li><li>possible_keys — 表示查询时，可能使用的索引；</li><li><strong>key — 表示实际使用的索引；</strong></li><li>key_len — 索引字段的长度；</li><li>ref— 列与索引的比较；</li><li>rows — 大概估算的行数；</li><li>filtered — 按表条件过滤的行百分比；</li><li>Extra — 执行情况的描述和说明。</li></ul><h2 id="2-7-查询-x2F-删除索引"><a href="#2-7-查询-x2F-删除索引" class="headerlink" title="2.7 查询&#x2F;删除索引"></a>2.7 查询&#x2F;删除索引</h2><p>如果需要删除主键索引，直接把主键删了就行了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> <span class="keyword">primary</span> key;</span><br></pre></td></tr></table></figure><p>删除普通索引语句如下</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> index 索引名字;</span><br></pre></td></tr></table></figure><p>注意，索引的名字不一定和字段名相同（在创建索引的时候可以指定索引名字），需要使用如下语句查看</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> keys <span class="keyword">from</span> 表名;</span><br></pre></td></tr></table></figure><p>比如user2表中包含id主键索引和name的主键索引，其结果查询如下；其中的<code>Key_name</code>才是索引的名字，不一定和字段名相同！删除索引的时候需要使用索引名字！</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/e01d3842d22be7c1f41568ef3802d1e0.png" alt="image-20230907153259042"></p><p>还可以用如下语句来更加清楚的看到每个索引的相关属性</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> index <span class="keyword">from</span> 表名\G;</span><br></pre></td></tr></table></figure><p>我给user2表添加一个键值，并设置普通索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user2 <span class="keyword">add</span> qq <span class="type">varchar</span>(<span class="number">40</span>); <span class="comment">-- 添加一个键值</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user2 <span class="keyword">add</span> index(qq); <span class="comment">-- 添加普通索引</span></span><br></pre></td></tr></table></figure><p>使用<code>show index from 表名\G;</code>语句查看user2表的索引属性；在这里可以看到，唯一键索引的属性和普通索引是完全相同的，<strong>所以才说唯一键的索引本质上还是普通索引</strong>。</p><p>这里还写明了索引的类型是BTREE，其就是B+树；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; desc user2;</span><br><span class="line">+-------+------------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type             | Null | Key | Default | Extra |</span><br><span class="line">+-------+------------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(10) unsigned | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | varchar(200)     | NO   | UNI | NULL    |       |</span><br><span class="line">| qq    | varchar(40)      | YES  | MUL | NULL    |       |</span><br><span class="line">+-------+------------------+------+-----+---------+-------+</span><br><span class="line">3 rows in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hello_mysql]&gt; show index from user2\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">        Table: user2</span><br><span class="line">   Non_unique: 0</span><br><span class="line">     Key_name: PRIMARY</span><br><span class="line"> Seq_in_index: 1</span><br><span class="line">  Column_name: id</span><br><span class="line">    Collation: A</span><br><span class="line">  Cardinality: 0</span><br><span class="line">     Sub_part: NULL</span><br><span class="line">       Packed: NULL</span><br><span class="line">         Null: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">        Table: user2</span><br><span class="line">   Non_unique: 0</span><br><span class="line">     Key_name: name</span><br><span class="line"> Seq_in_index: 1</span><br><span class="line">  Column_name: name</span><br><span class="line">    Collation: A</span><br><span class="line">  Cardinality: 0</span><br><span class="line">     Sub_part: NULL</span><br><span class="line">       Packed: NULL</span><br><span class="line">         Null: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">        Table: user2</span><br><span class="line">   Non_unique: 1</span><br><span class="line">     Key_name: qq</span><br><span class="line"> Seq_in_index: 1</span><br><span class="line">  Column_name: qq</span><br><span class="line">    Collation: A</span><br><span class="line">  Cardinality: NULL</span><br><span class="line">     Sub_part: NULL</span><br><span class="line">       Packed: NULL</span><br><span class="line">         Null: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">3 rows in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><h2 id="2-8-什么时候索引会失效？"><a href="#2-8-什么时候索引会失效？" class="headerlink" title="2.8 什么时候索引会失效？"></a>2.8 什么时候索引会失效？</h2><blockquote><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2035778">https://cloud.tencent.com/developer/article/2035778</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/361172794">https://zhuanlan.zhihu.com/p/361172794</a></p></blockquote><h3 id="2-8-1-如果条件中有or-x2F-and"><a href="#2-8-1-如果条件中有or-x2F-and" class="headerlink" title="2.8.1 如果条件中有or&#x2F;and"></a>2.8.1 如果条件中有or&#x2F;and</h3><p>如果条件中有or&#x2F;and，即使其中<strong>有部分条件带索引</strong>也不会使用；</p><p>先说结论：如果在使用and和or进行查询的时候，只有两列都包含了索引才会使用；</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建示例表，其中id是主键，user_id没有创建索引</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user3(</span><br><span class="line">	id <span class="type">int</span> unsigned <span class="keyword">primary</span> key,</span><br><span class="line">	user_id <span class="type">int</span> unsigned <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- 插入示例数据</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user3 <span class="keyword">values</span> </span><br><span class="line">	(<span class="number">1</span>,<span class="number">10</span>,<span class="string">&#x27;甲&#x27;</span>),	(<span class="number">2</span>,<span class="number">20</span>,<span class="string">&#x27;丙&#x27;</span>),	(<span class="number">3</span>,<span class="number">30</span>,<span class="string">&#x27;乙&#x27;</span>),	(<span class="number">4</span>,<span class="number">40</span>,<span class="string">&#x27;丁&#x27;</span>),</span><br><span class="line">	(<span class="number">5</span>,<span class="number">50</span>,<span class="string">&#x27;尼斯&#x27;</span>),(<span class="number">6</span>,<span class="number">23</span>,<span class="string">&#x27;企鹅&#x27;</span>),(<span class="number">7</span>,<span class="number">14</span>,<span class="string">&#x27;倪浩&#x27;</span>),(<span class="number">9</span>,<span class="number">21</span>,<span class="string">&#x27;test&#x27;</span>);</span><br></pre></td></tr></table></figure><p>这时候如果用如下语句进行查询，那就不会使用索引</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> user3 <span class="keyword">where</span> id<span class="operator">=</span><span class="number">3</span> <span class="keyword">or</span> user_id<span class="operator">=</span><span class="number">40</span>;</span><br></pre></td></tr></table></figure><p>使用<code>explain</code>命令来查看运行过程，可以看到key一列为空，代表没有使用索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id=3 or user_id=40\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 4</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br><span class="line"></span><br><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id=2 and user_id=30\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: NULL</span><br><span class="line">         type: NULL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: NULL</span><br><span class="line">        Extra: Impossible WHERE noticed after reading const tables</span><br><span class="line">1 row in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><p>直接查询id，有使用索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id=2\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: const</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 4</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">        Extra: </span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><p>此时如果给<code>user_id</code>列加上索引后重新操作，那结果就不一样了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> user3 <span class="keyword">add</span> <span class="keyword">unique</span>(user_id); <span class="comment">-- 唯一键索引</span></span><br></pre></td></tr></table></figure><p>可以看到，有使用索引（在我的测试中，并不是每次都会使用索引，这大概是因为我的内容列太少了，不如直接遍历？）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id=2 and user_id=20\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: const</span><br><span class="line">possible_keys: PRIMARY,user_id</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 4</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">        Extra: </span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><h3 id="2-8-2-复合索引没有使用最左列"><a href="#2-8-2-复合索引没有使用最左列" class="headerlink" title="2.8.2 复合索引没有使用最左列"></a>2.8.2 复合索引没有使用最左列</h3><p>使用sn + name + age创建复合索引，我们假设它们的顺序是 A + B + C，以下联合索引的使用情况如下：</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/d5285b42e3341a5dda532dfdaf6fc7dc.png" alt="image"></p><p>从结果可以看出，只有A+B+C或者A+B&#x2F;A+C才能触发索引，而使用B+C无法触发索引，因为没有使用最左列；</p><h3 id="2-8-3-错误模糊查询"><a href="#2-8-3-错误模糊查询" class="headerlink" title="2.8.3  错误模糊查询"></a>2.8.3 错误模糊查询</h3><p>模糊查询的时候，只有<code>关键字%</code>才能用到索引，使用<code>%关键字</code>或者<code>%关键字%</code>都是无法使用索引的；</p><p>测试表结构如下，其中ename是用户名，我给他添加了一个普通索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; desc EMP;</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">| Field    | Type                     | Null | Key | Default | Extra |</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">| empno    | int(6) unsigned zerofill | NO   | PRI | NULL    |       |</span><br><span class="line">| ename    | varchar(10)              | YES  |     | NULL    |       |</span><br><span class="line">| job      | varchar(9)               | YES  |     | NULL    |       |</span><br><span class="line">| mgr      | int(4) unsigned zerofill | YES  |     | NULL    |       |</span><br><span class="line">| hiredate | datetime                 | YES  |     | NULL    |       |</span><br><span class="line">| sal      | decimal(7,2)             | YES  |     | NULL    |       |</span><br><span class="line">| comm     | decimal(7,2)             | YES  |     | NULL    |       |</span><br><span class="line">| deptno   | int(2) unsigned zerofill | YES  |     | NULL    |       |</span><br><span class="line">+----------+--------------------------+------+-----+---------+-------+</span><br><span class="line">8 rows in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [bit_index]&gt; alter table EMP add index(ename);</span><br><span class="line">Query OK, 0 rows affected (11.911 sec)              </span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure><p>然后进行测试。注意看下方3次查询的like条件区别，以及是否使用了索引；可以看到，只有第一次使用<code>FN%</code>作为查询条件的时候，才使用了索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [bit_index]&gt; explain select * from EMP where ename like &#x27;FN%&#x27;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: EMP</span><br><span class="line">         type: range</span><br><span class="line">possible_keys: ename</span><br><span class="line">          key: ename</span><br><span class="line">      key_len: 33</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 22000</span><br><span class="line">        Extra: Using index condition</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br><span class="line"></span><br><span class="line">MariaDB [bit_index]&gt; explain select * from EMP where ename like &#x27;%FN%&#x27;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: EMP</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 7968250</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br><span class="line"></span><br><span class="line">MariaDB [bit_index]&gt; explain select * from EMP where ename like &#x27;%FN&#x27;\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: EMP</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 7968250</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><h3 id="2-8-4-列运算"><a href="#2-8-4-列运算" class="headerlink" title="2.8.4 列运算"></a>2.8.4 列运算</h3><p>如果包含索引的列进行了运算，也不会使用索引；</p><p>比如下方，直接进行<code>id=5</code>查询的时候，可以使用索引，但用<code>id+2=5</code>进行查询的时候无法使用索引；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id=5\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: const</span><br><span class="line">possible_keys: PRIMARY</span><br><span class="line">          key: PRIMARY</span><br><span class="line">      key_len: 4</span><br><span class="line">          ref: const</span><br><span class="line">         rows: 1</span><br><span class="line">        Extra: </span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br><span class="line"></span><br><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where id+2=5\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 8</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.000 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><h3 id="2-8-5-使用函数"><a href="#2-8-5-使用函数" class="headerlink" title="2.8.5 使用函数"></a>2.8.5 使用函数</h3><p>查询列如果使用任意 MySQL 提供的函数就会导致索引失效，这一点的情况和上一点进行运算其实是类似的，毕竟函数也是一种内置的运算；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hello_mysql]&gt; explain select * from user3 where ifnull(id,0)=5\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: user3</span><br><span class="line">         type: ALL</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 8</span><br><span class="line">        Extra: Using where</span><br><span class="line">1 row in set (0.001 sec)</span><br><span class="line"></span><br><span class="line">ERROR: No query specified</span><br></pre></td></tr></table></figure><h3 id="2-8-6-类型转换"><a href="#2-8-6-类型转换" class="headerlink" title="2.8.6 类型转换"></a>2.8.6 类型转换</h3><p>当查询的条件和其本身的数据类型不同时，不会触发索引；</p><p>比如 address 为字符串类型，而查询的时候设置了 int 类型的值就会导致索引失效，如下图所示：</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/fb421f166c9d97c932ad6c579ea55f10.png" alt="image"></p><h3 id="2-8-7-使用is-not-null"><a href="#2-8-7-使用is-not-null" class="headerlink" title="2.8.7 使用is not null"></a>2.8.7 使用is not null</h3><p>当在查询中使用了 is not null 也会导致索引失效，而 is null 则会正常触发索引的，如下图所示：</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/09/87c89678b12c5b3a0fbb33686e46c6ec.png" alt="image.png"></p><h1 id="3-索引优化"><a href="#3-索引优化" class="headerlink" title="3.索引优化"></a>3.索引优化</h1><h2 id="3-1-关联查询优化"><a href="#3-1-关联查询优化" class="headerlink" title="3.1 关联查询优化"></a>3.1 关联查询优化</h2><p>保证被驱动表的JOIN字段已经创建了索引，需要 JOIN 的字段，数据类型保持绝对一致。</p><ul><li>LEFT JOIN 时，<strong>选择小表作为驱动表， 大表作为被驱动表</strong> 。减少外层循环的次数。</li><li>INNER JOIN 时，MySQL会自动将小结果集的表选为驱动表 。</li></ul><p><strong>选择相信MySQL优化策略</strong>。能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数）</p><blockquote><p>不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询，参考第二点；</p></blockquote><p>另外，衍生表建不了索引。这点也需要注意</p><h2 id="3-2-子查询优化"><a href="#3-2-子查询优化" class="headerlink" title="3.2 子查询优化"></a>3.2 子查询优化</h2><p>MySQL从4.1版本开始支持子查询，使用子查询可以进行SELECT语句的嵌套查询，即一个SELECT查询的结果作为另一个SELECT语句的条件。</p><p>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的SQL操作，子查询是 MySQL 的一项重要的功能，可以帮助我们通过一个 SQL 语句实现比较复杂的查询。</p><p>但是，<strong>子查询的执行效率不高</strong>。原因：</p><ul><li>执行子查询时，MySQL需要为内层查询语句的查询结果 建立一个临时表 ，然后外层查询语句从临时表中查询记录。查询完毕后，再撤销这些临时表。这样会消耗过多的CPU和IO资源，产生大量的慢查询。</li><li>子查询的结果集存储的<strong>临时表</strong>，不论是内存临时表还是磁盘临时表都<strong>不会存在索引</strong> ，所以查询性能会受到一定的影响。</li><li>对于返回结果集比较大的子查询，其对查询性能的影响也就越大。 在MySQL中，可以使用连接（JOIN）查询来替代子查询。连接查询不需要建立临时表 ，其速度比子查询要快 ，如果查询中使用索引的话，性能就会更好。</li></ul><p>结论：尽量不要使用 NOT IN 或者 NOT EXISTS，用<code>LEFT JOIN xxx ON xx WHERE xx IS NULL</code>替代；</p><h2 id="3-3-排序优化"><a href="#3-3-排序优化" class="headerlink" title="3.3 排序优化"></a>3.3 排序优化</h2><ul><li>SQL 中，可以在 WHERE 子句和 ORDER BY 子句中使用索引，目的是在 WHERE 子句中 避免全表扫 描 ，在 ORDER BY 子句 避免使用 FileSort 排序 。当然，某些情况下全表扫描，或者 FileSort 排 序不一定比索引慢。但总的来说，我们还是要避免，以提高查询效率。</li><li>尽量使用 Index 完成 ORDER BY 排序。如果 WHERE 和 ORDER BY 后面是相同的列就使用单索引列； 如果不同就使用联合索引。</li><li>无法使用 Index 时，需要对 FileSort 方式进行调优。</li></ul><h2 id="3-4-GROUP-BY优化"><a href="#3-4-GROUP-BY优化" class="headerlink" title="3.4 GROUP BY优化"></a>3.4 GROUP BY优化</h2><p>group by使用索引的原则几乎跟<code>order by</code>一致 ，group by即使没有过滤条件用到索引，也可以直接使用索引。</p><ul><li>group by 先排序再分组，遵照索引建的<strong>最佳左前缀法则</strong>；</li><li>当无法使用索引列事，增大 <code>max_length_for_sort_data</code> 和 <code>sort_buffer_size</code> 参数的设置；</li><li>where效率高于having，能写在where限定的条件就不要写在having中了！</li><li>减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的。</li><li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行 以内，否则SQL会很慢。</li></ul><h2 id="3-5-索引覆盖"><a href="#3-5-索引覆盖" class="headerlink" title="3.5 索引覆盖"></a>3.5 索引覆盖</h2><p>这一点在上文的回表查找中已经提及了，即使用复合索引，并将你需要查询的目标字段以最左匹配原则设置到复合索引中，减少回表操作。</p><blockquote><p>innodb的索引存放的是索引列+主键值，如果尝试通过索引列来查询其他数据时，最终还是会通过主键在主键索引中重新查询一次。这就叫回表操作。</p></blockquote><p>使用复合索引，能让索引节点中包含了我们需要找到的值，比如姓名和学号等，这样可以减少因为在非主键索引中找不到目标列而产生的回表操作。</p><p>当然，这依旧需要遵循索引创建的原则，即如果某列数据重复量过多，则不应该作为索引列（如果真的需要，可以放在复合索引的最后面，这样能减少以之为查询判据的场景）</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">慕雪年华</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/3474107655/">https://blog.musnow.top/posts/3474107655/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.musnow.top" target="_blank">慕雪的寒舍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/mysql/">mysql</a></div><div class="post_share"><div class="social-share" data-image="https://img.musnow.top/i/2023/04/64302610057ae.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://afdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.png" alt="爱发电"></a><div class="post-qr-code-desc">爱发电</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2200233148/" title="【MySQL】事务"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【MySQL】事务</div></div></a></div><div class="next-post pull-right"><a href="/posts/2529084145/" title="【MySQL】复合查询 | 内外链接"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【MySQL】复合查询 | 内外链接</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/577382991/" title="【MySQL】安装和基础环境配置"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-06</div><div class="title">【MySQL】安装和基础环境配置</div></div></a></div><div><a href="/posts/2529084145/" title="【MySQL】复合查询 | 内外链接"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-07</div><div class="title">【MySQL】复合查询 | 内外链接</div></div></a></div><div><a href="/posts/2109090511/" title="【MySQL】C&#x2F;C++代码操作数据库"><img class="cover" src="https://img.musnow.top/i/2023/04/64302610057ae.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-08</div><div class="title">【MySQL】C&#x2F;C++代码操作数据库</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/favicon.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">慕雪年华</div><div class="author-info__description">爱折腾的代码初学者</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">356</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">21</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="个人主页"><i class="fas fa-globe-asia"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="导航站点"><i class="fas fa-server"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到寒舍</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%B4%A2%E5%BC%95"><span class="toc-text">1.索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%B8%BA%E5%95%A5%E9%9C%80%E8%A6%81%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="toc-text">1.1 为啥需要索引？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%88%E6%9E%9C"><span class="toc-text">1.2 索引的效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-MySQL%E5%92%8C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">1.3 MySQL和文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-Linux%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">1.3.1 Linux文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-MySQL%E5%92%8C%E7%A3%81%E7%9B%98%E4%BA%A4%E4%BA%92%E5%9F%BA%E6%9C%AC%E5%8D%95%E4%BD%8D-16KB"><span class="toc-text">1.3.2 MySQL和磁盘交互基本单位 16KB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8Page%E4%B8%BA%E5%8D%95%E4%BD%8D%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92%EF%BC%9F"><span class="toc-text">1.3.3 为什么要用Page为单位进行交互？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-B-%E6%A0%91%E5%92%8CPage"><span class="toc-text">1.4 B+树和Page</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E5%8D%95%E4%B8%AAPage"><span class="toc-text">1.4.1 单个Page</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E5%A4%9A%E4%B8%AAPage"><span class="toc-text">1.4.2 多个Page</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E7%9B%AE%E5%BD%95"><span class="toc-text">页目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E9%A1%B5%E7%9B%AE%E5%BD%95"><span class="toc-text">单页目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E9%A1%B5%E7%9B%AE%E5%BD%95"><span class="toc-text">多页目录</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E5%B0%8F%E7%BB%93"><span class="toc-text">1.4.3 小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8D%E9%80%82%E5%90%88%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="toc-text">1.5 为什么其他数据结构不适合索引？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E8%81%9A%E7%B0%87-x2F-%E9%9D%9E%E8%81%9A%E7%B0%87%E7%B4%A2%E5%BC%95"><span class="toc-text">1.6 聚簇&#x2F;非聚簇索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-1-%E8%AF%B4%E6%98%8E"><span class="toc-text">1.6.1 说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-2-%E5%AE%9E%E6%9C%BA%E6%BC%94%E7%A4%BA"><span class="toc-text">1.6.2 实机演示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7-%E5%9B%9E%E8%A1%A8%E6%9F%A5%E6%89%BE"><span class="toc-text">1.7 回表查找</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-text">2.索引操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E5%88%99"><span class="toc-text">2.1 创建索引的原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%94%AE%E7%B4%A2%E5%BC%95"><span class="toc-text">2.2 创建主键索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E5%94%AF%E4%B8%80%E9%94%AE%E7%B4%A2%E5%BC%95"><span class="toc-text">2.3 唯一键索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E6%99%AE%E9%80%9A%E9%94%AE%E7%B4%A2%E5%BC%95"><span class="toc-text">2.4 普通键索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E5%A4%8D%E5%90%88-x2F-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95"><span class="toc-text">2.5 复合&#x2F;联合索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95"><span class="toc-text">2.6 全文索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#explain%E5%B7%A5%E5%85%B7"><span class="toc-text">explain工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E6%9F%A5%E8%AF%A2-x2F-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">2.7 查询&#x2F;删除索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%B4%A2%E5%BC%95%E4%BC%9A%E5%A4%B1%E6%95%88%EF%BC%9F"><span class="toc-text">2.8 什么时候索引会失效？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-1-%E5%A6%82%E6%9E%9C%E6%9D%A1%E4%BB%B6%E4%B8%AD%E6%9C%89or-x2F-and"><span class="toc-text">2.8.1 如果条件中有or&#x2F;and</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-2-%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95%E6%B2%A1%E6%9C%89%E4%BD%BF%E7%94%A8%E6%9C%80%E5%B7%A6%E5%88%97"><span class="toc-text">2.8.2 复合索引没有使用最左列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-3-%E9%94%99%E8%AF%AF%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-text">2.8.3 错误模糊查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-4-%E5%88%97%E8%BF%90%E7%AE%97"><span class="toc-text">2.8.4 列运算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-5-%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">2.8.5 使用函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-6-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-text">2.8.6 类型转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-7-%E4%BD%BF%E7%94%A8is-not-null"><span class="toc-text">2.8.7 使用is not null</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">3.索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">3.1 关联查询优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="toc-text">3.2 子查询优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="toc-text">3.3 排序优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-GROUP-BY%E4%BC%98%E5%8C%96"><span class="toc-text">3.4 GROUP BY优化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E7%B4%A2%E5%BC%95%E8%A6%86%E7%9B%96"><span class="toc-text">3.5 索引覆盖</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/1455984707/" title="【leetcode】2两数相加和989数组数字的相加问题"><img src="/img/bg/gm24.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="【leetcode】2两数相加和989数组数字的相加问题"></a><div class="content"><a class="title" href="/posts/1455984707/" title="【leetcode】2两数相加和989数组数字的相加问题">【leetcode】2两数相加和989数组数字的相加问题</a><time datetime="2024-04-14T07:13:00.000Z" title="发表于 2024-04-14 15:13:00">2024-04-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2259793534/" title="【网络】QUIC协议和HTTP3"><img src="/img/bg/gm21.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="【网络】QUIC协议和HTTP3"></a><div class="content"><a class="title" href="/posts/2259793534/" title="【网络】QUIC协议和HTTP3">【网络】QUIC协议和HTTP3</a><time datetime="2024-04-11T03:17:57.000Z" title="发表于 2024-04-11 11:17:57">2024-04-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3488338229/" title="【算法】贪心算法"><img src="/img/bg/gm5.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="【算法】贪心算法"></a><div class="content"><a class="title" href="/posts/3488338229/" title="【算法】贪心算法">【算法】贪心算法</a><time datetime="2024-04-07T02:33:18.000Z" title="发表于 2024-04-07 10:33:18">2024-04-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/137069193/" title="【win】windows11让蓝牙耳机不进入通话模式"><img src="/img/bg/gm2.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="【win】windows11让蓝牙耳机不进入通话模式"></a><div class="content"><a class="title" href="/posts/137069193/" title="【win】windows11让蓝牙耳机不进入通话模式">【win】windows11让蓝牙耳机不进入通话模式</a><time datetime="2024-04-06T01:07:34.000Z" title="发表于 2024-04-06 09:07:34">2024-04-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/main/mothra.webp)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By 慕雪年华</div><div class="footer_custom_text"><img src="/img/ico/gonganbeian.png" height="15">&nbsp;<a href="https://beian.mps.gov.cn/#/query/webSearch?code=44190002007715" rel="noreferrer" target="_blank">粤公网安备44190002007715</a><br><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="/img/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4.svg" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="/img/badge/-SITEMAP-00CDCD.svg" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="/img/badge/%E7%B2%A4ICP%E5%A4%872023007189-red.svg" height="20px"></a><br><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/img/ico/upyun_cdn_w.png" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.3/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.2.2/mermaid.min.js').then(runMermaid)
  }

  btf.addModeChange('mermaid', runMermaid)

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>function loadArtalk () {
  function initArtalk () {
    window.artalkItem = new Artalk(Object.assign({
      el: '#artalk-wrap',
      server: 'https://artk.musnow.top',
      site: 'mublog',
      pageKey: location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      countEl: '.artalk-count'
    },null))

    if (GLOBAL_CONFIG.lightbox === 'null') return
    window.artalkItem.use(ctx => {
      ctx.on('list-loaded', () => {
        ctx.getCommentList().forEach(comment => {
          const $content = comment.getRender().$content
          btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
        })
      })
    })
  }

  if (typeof window.artalkItem === 'object') initArtalk()
  else {
    getCSS('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.css').then(()=>{
      getScript('https://cdnjs.cloudflare.com/ajax/libs/artalk/2.5.5/Artalk.min.js').then(initArtalk)
    })
  }
}

function artalkChangeMode (theme) {
  const artalkWrap = document.getElementById('artalk-wrap')
  if (!(artalkWrap && artalkWrap.children.length)) return
  const isDark = theme === 'dark'
  window.artalkItem.setDarkMode(isDark)
}

btf.addModeChange('artalk', artalkChangeMode)

if ('Artalk' === 'Artalk' || !false) {
  if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
  else loadArtalk()
} else {
  function loadOtherComment () {
    loadArtalk()
  }
}</script></div><script src="/js/domain_check.js"></script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async mobile="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/search/local-search.min.js"></script></div></div></body></html>