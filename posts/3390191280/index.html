<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ã€Linuxã€‘é«˜çº§IOå’Œå¤šè·¯è½¬æ¥ | select/poll/epoll | æ…•é›ªçš„å¯’èˆ</title><meta name="author" content="æ…•é›ªå¹´å"><meta name="copyright" content="æ…•é›ªå¹´å"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="å¤šè·¯è½¬æ¥å’Œé«˜çº§IO"><meta property="og:type" content="article"><meta property="og:title" content="ã€Linuxã€‘é«˜çº§IOå’Œå¤šè·¯è½¬æ¥ | select&#x2F;poll&#x2F;epoll"><meta property="og:url" content="https://blog.musnow.top/posts/3390191280/index.html"><meta property="og:site_name" content="æ…•é›ªçš„å¯’èˆ"><meta property="og:description" content="å¤šè·¯è½¬æ¥å’Œé«˜çº§IO"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://img.musnow.top/i/2023/08/748d3a20ba69bb3b3671f5b344cba650.png"><meta property="article:published_time" content="2023-08-25T00:22:36.000Z"><meta property="article:modified_time" content="2023-08-25T04:05:36.000Z"><meta property="article:author" content="æ…•é›ªå¹´å"><meta property="article:tag" content="Linux"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.musnow.top/i/2023/08/748d3a20ba69bb3b3671f5b344cba650.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/3390191280/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"è·ç¦»ä¸Šæ¬¡æ›´æ–°æœ¬æ–‡å·²ç»è¿‡å»äº†","messageNext":"å¤©ï¼Œæ–‡ç« éƒ¨åˆ†å†…å®¹å¯èƒ½å·²ç»è¿‡æ—¶ï¼Œè¯·æ³¨æ„ç”„åˆ«"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":600,"languages":{"author":"ä½œè€…: æ…•é›ªå¹´å","link":"é“¾æ¥: ","source":"æ¥æº: æ…•é›ªçš„å¯’èˆ","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdn.staticfile.org/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ã€Linuxã€‘é«˜çº§IOå’Œå¤šè·¯è½¬æ¥ | select/poll/epoll",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-25 12:05:36"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="æ…•é›ªçš„å¯’èˆ" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/favicon.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">293</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">73</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">13</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> æœºå™¨äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> Keep</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51cto</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/memos/"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url(https://img.musnow.top/i/2023/08/748d3a20ba69bb3b3671f5b344cba650.png)"><nav id="nav"><span id="blog-info"><a href="/" title="æ…•é›ªçš„å¯’èˆ"><img class="site-icon" src="/favicon.jpg"><span class="site-name">æ…•é›ªçš„å¯’èˆ</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> æœºå™¨äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> Keep</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51cto</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" href="/memos/"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ã€Linuxã€‘é«˜çº§IOå’Œå¤šè·¯è½¬æ¥ | select/poll/epoll</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2023-08-25T00:22:36.000Z" title="å‘è¡¨äº 2023-08-25 08:22:36">2023-08-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-08-25T04:05:36.000Z" title="æ›´æ–°äº 2023-08-25 12:05:36">2023-08-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">18.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>67åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span data-flag-title="ã€Linuxã€‘é«˜çº§IOå’Œå¤šè·¯è½¬æ¥ | select/poll/epoll"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>å¤šè·¯è½¬æ¥å’Œé«˜çº§IO</p><span id="more"></span><p>å’³å’³ï¼Œå†™çš„æ—¶å€™å‡ºäº†ç‚¹é—®é¢˜ï¼Œæ ‡ç‚¹ç¬¦å·å…¨ä¹±äº†ï¼ˆæ‰¹é‡æ›¿æ¢äº†å‡ æ¬¡ï¼‰ï¼Œå¹²è„†å°±æŠŠå…¨æ–‡çš„é€—å·å’Œå¥å·éƒ½æ”¹æˆè‹±æ–‡çš„äº†ï¼ˆä¸ç„¶ä»£ç å—é‡Œé¢çš„ä»£ç éƒ½æ˜¯ä¸­æ–‡æ ‡ç‚¹å°±è·‘ä¸åŠ¨äº†ï¼‰</p><blockquote><p>IOå¤šè·¯å¤ç”¨å’Œæœ¬æ–‡æåˆ°çš„å¤šè·¯è½¬æ¥æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼</p></blockquote><h1 id="1-é«˜çº§IO"><a href="#1-é«˜çº§IO" class="headerlink" title="1.é«˜çº§IO"></a>1.é«˜çº§IO</h1><h2 id="1-1-äº”ç§IOæ¨¡å‹"><a href="#1-1-äº”ç§IOæ¨¡å‹" class="headerlink" title="1.1 äº”ç§IOæ¨¡å‹"></a>1.1 äº”ç§IOæ¨¡å‹</h2><p>ç”¨é’“é±¼ä½¬çš„æ —å­, æ¥çœ‹çœ‹äº”ç§ä¸åŒçš„IOæ¨¡å‹å§</p><ul><li>A, æ‹¿ç€é±¼ç«¿å»é’“é±¼, ä¸€ç›´ç›¯ç€é±¼æ¼‚, é±¼æ¼‚æœ‰åŠ¨é™å°±æ”¶é’©</li><li>B, æ‹¿ç€é±¼ç«¿å»é’“é±¼, æ—¶ä¸æ—¶çœ‹çœ‹é±¼æ¼‚, æœ‰åŠ¨é™å°±æ”¶è´­</li><li>C, æ‹¿ç€é±¼ç«¿å»é’“é±¼, åœ¨é±¼æ¼‚ä¸Šå¼„ä¸ªé“ƒé“›, ç„¶åå¹²å…¶ä»–çš„äº‹æƒ…, å¬åˆ°é“ƒé“›çš„å£°éŸ³å°±æ”¶é’©</li><li>D, æ‹¿äº†ä¸€å¤§å †é±¼ç«¿è¿‡æ¥, éƒ½æ‘†å¼„å¥½, åªè¦æœ‰ä¸€ä¸ªé±¼æ¼‚æœ‰åŠ¨é™, å°±æ”¶é’©</li><li>Eæ˜¯å¤§è€æ¿, ç›´æ¥å«äººå¸®å¿™é’“é±¼, é’“åˆ°ä¸€å®šæ•°é‡çš„ğŸŸåé€šçŸ¥è‡ªå·±, è‡ªå·±è¿‡æ¥å–ğŸŸï¼ˆæ²¡æœ‰å‚ä¸é’“é±¼è¿‡ç¨‹ï¼‰</li></ul><p>è¿™äº”ç§é’“é±¼æ–¹å¼, å°±å¯¹åº”äº†äº”ç§IOæ¨¡å‹</p><ul><li>A, <strong>é˜»å¡ç­‰å¾…</strong>, ç­‰å¾…åˆ°æ•°æ®å°±ç«‹å³è¯»å–</li><li>B, <strong>è½®è¯¢æ£€æµ‹</strong>, æ£€æµ‹åˆ°æ•°æ®çš„æ—¶å€™è¯»å–</li><li>C, åˆ©ç”¨é“ƒé“›æ¥ä½œä¸ºé€šçŸ¥æ–¹å¼, å¬åˆ°äº†ä¿¡å·ä¹‹å, å°±å»è¯»å–æ•°æ®ï¼ˆ<strong>ä¿¡å·é©±åŠ¨</strong>ï¼‰</li><li>D, ä¸€æ¬¡æ€§æ£€æµ‹å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ<strong>å¤šè·¯è½¬æ¥</strong>ï¼‰</li><li>E, æ²¡æœ‰è‡ªå·±å‚ä¸é’“é±¼è¿‡ç¨‹, æœ‰åˆ«äººå¸®å¿™ç›‘æ§æ–‡ä»¶æè¿°ç¬¦, è‡ªå·±åªå…³å¿ƒæ‹¿èµ°æ•°æ®ï¼ˆ<strong>å¼‚æ­¥IO</strong>ï¼‰</li></ul><p>åœ¨è¿™äº”ç§IOæ¨¡å¼ä¸­, <strong>Dçš„æ•ˆç‡æ˜¯æœ€é«˜çš„</strong>ã€‚å› ä¸ºå®ƒä¸€æ¬¡æ€§ç›‘æ§äº†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦, è¿™äº›æ–‡ä»¶æè¿°ç¬¦çš„IOåœ¨ä¸€å®šç¨‹åº¦ä¸Šé‡åˆäº†, æ›´å®¹æ˜“ç­‰åˆ°æ•°æ®ã€‚</p><p>è¦çŸ¥é“, Dæ˜¯è¿‡æ¥é’“é±¼çš„, ä»–åªè¦èƒ½é’“åˆ°é±¼å°±å¤Ÿäº†, å¹¶ä¸ç”¨å…³å¿ƒåˆ°åº•æ˜¯å“ªä¸ªé±¼é’©é’“ä¸Šæ¥çš„é±¼ã€‚åŒç†, æˆ‘ä»¬çš„IOæœåŠ¡å™¨ä¹Ÿå¹¶ä¸éœ€è¦å…³å¿ƒåˆ°åº•æ˜¯å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦åœ¨ç»™è‡ªå·±ä¼ é€’ä¿¡æ¯, æˆ‘ä»¬åªè¦æ¯æ—¶æ¯åˆ»éƒ½åœ¨å¤„ç†ä¿¡æ¯ï¼ˆéƒ½èƒ½é’“åˆ°é±¼ï¼‰æ‰æ˜¯æœ€é«˜æ•ˆç‡çš„ä½“ç°ã€‚</p><p>æ¢å¥è¯è¯´, åœ¨é’“é±¼ï¼ˆå¤„ç†IOï¼‰çš„æ—¶å€™, ç­‰çš„æ—¶é—´æ¯”ä¾‹è¶Šä½, æ•ˆç‡è¶Šé«˜ï¼</p><h2 id="1-2-é˜»å¡å’Œéé˜»å¡"><a href="#1-2-é˜»å¡å’Œéé˜»å¡" class="headerlink" title="1.2 é˜»å¡å’Œéé˜»å¡"></a>1.2 é˜»å¡å’Œéé˜»å¡</h2><p>è¿™ä¸¤ä¸ªæ¦‚å¿µæˆ‘ä»¬åœ¨å…ˆå‰å¯¹IOçš„å­¦ä¹ ä¸­å·²ç»è§è¿‡äº†</p><ul><li>é˜»å¡ï¼šè¿›ç¨‹ä¼šåœ¨å‡½æ•°è°ƒç”¨ä¸­å¡ä½, åœ¨æ²¡æœ‰æˆåŠŸè°ƒç”¨ä¹‹å‰ä¸ä¼šç»§ç»­å‘åè¿è¡Œ</li><li>éé˜»å¡ï¼šä¸ç®¡èƒ½å¦è·å–åˆ°æ•°æ®, å‡½æ•°éƒ½æ˜¯ç›´æ¥è¿”å›ç»“æœ;</li></ul><h2 id="1-3-å¼‚æ­¥ä¸åŒæ­¥é€šä¿¡"><a href="#1-3-å¼‚æ­¥ä¸åŒæ­¥é€šä¿¡" class="headerlink" title="1.3 å¼‚æ­¥ä¸åŒæ­¥é€šä¿¡"></a>1.3 å¼‚æ­¥ä¸åŒæ­¥é€šä¿¡</h2><ul><li>å¼‚æ­¥é€šä¿¡ï¼šåœ¨è°ƒç”¨å‘å‡ºå, è¿™ä¸ªè°ƒç”¨ç›´æ¥è¿”å›, å¹¶æ²¡æœ‰æºå¸¦ç»“æœ;ç±»ä¼¼<code>std::async/future</code>, åœ¨è°ƒç”¨å‘å‡ºå, è¢«è°ƒç”¨ç€é€šè¿‡çŠ¶æ€æˆ–é€šçŸ¥æ¥å‘ŠçŸ¥è°ƒç”¨è€…, äº¦æˆ–è€…æ˜¯ç”¨å›è°ƒå‡½æ•°æ¥å¤„ç†è¿™ä¸ªå¼‚æ­¥è°ƒç”¨</li><li>åŒæ­¥é€šä¿¡ï¼šåœ¨å‘å‡ºè°ƒç”¨å, æ²¡æœ‰å¾—åˆ°ç»“æœå‰, è¯¥è°ƒç”¨ä¸è¿”å›;ä¸€æ—¦è¿”å›å°±è¡¨æ˜è¯¥è°ƒç”¨æˆåŠŸè·å–åˆ°äº†è¿”å›å€¼ï¼ˆè°ƒç”¨è€…ä¸»åŠ¨ç­‰å¾…è°ƒç”¨ç»“æœï¼‰</li></ul><p>è¿™é‡Œçš„åŒæ­¥å’Œçº¿ç¨‹&#x2F;è¿›ç¨‹åŒæ­¥å¹¶ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼š</p><ul><li>çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒæ­¥æŒ‡çš„æ˜¯çº¿ç¨‹å’Œè¿›ç¨‹ä¹‹é—´æœ‰ç›¸äº’åˆ¶çº¦çš„å…³ç³», éœ€è¦åœ¨æŸäº›æƒ…å†µä¸­åè°ƒä»–ä»¬çš„å·¥ä½œæ¬¡åºè€Œè¿›è¡Œç­‰å¾…</li></ul><hr><p>äº†è§£å®ŒIOæ¨¡å‹å’Œä¸Šæ–¹çš„çŸ¥è¯†å, ä¸‹é¢å°±è®©æˆ‘ä»¬æ¥è®¤è¯†ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ¥å£å§ï¼</p><h1 id="2-fcntl"><a href="#2-fcntl" class="headerlink" title="2.fcntl"></a>2.fcntl</h1><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨, å¯ä»¥ç»™æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œä¸åŒçš„ç­–ç•¥è®¾ç½®ã€‚</p><p>å½“æˆ‘ä»¬åœ¨linuxä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™, é»˜è®¤åˆ›å»ºçš„éƒ½æ˜¯é˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>fcntl</code>æ¥å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆ<strong>éé˜»å¡</strong>çš„ã€‚</p><h2 id="2-1-æ¥å£"><a href="#2-1-æ¥å£" class="headerlink" title="2.1 æ¥å£"></a>2.1 æ¥å£</h2><p>è¯¥å‡½æ•°çš„åŸå‹å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span> )</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­cmdæ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„ç­–ç•¥, ä¸‹é¢æ˜¯å¸¸è§çš„å‡ ç§é€‰é¡¹</p><ul><li>å¤åˆ¶ä¸€ä¸ªç°æœ‰çš„æè¿°ç¬¦ï¼ˆcmd&#x3D;F_DUPFDï¼‰</li><li>è·å¾—&#x2F;è®¾ç½®æ–‡ä»¶æè¿°ç¬¦æ ‡è®°(cmd&#x3D;F_GETFDæˆ–F_SETFD)</li><li>è·å¾—&#x2F;è®¾ç½®æ–‡ä»¶çŠ¶æ€æ ‡è®°(cmd&#x3D;F_GETFLæˆ–F_SETFL)</li><li>è·å¾—&#x2F;è®¾ç½®å¼‚æ­¥I&#x2F;Oæ‰€æœ‰æƒ(cmd&#x3D;F_GETOWNæˆ–F_SETOWN)</li><li>è·å¾—&#x2F;è®¾ç½®è®°å½•é”(cmd&#x3D;F_GETLK, F_SETLKæˆ–F_SETLKW)</li></ul><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰ä¸ªåŠŸèƒ½, æ¥è·å–å’Œè®¾ç½®æ–‡ä»¶çš„çŠ¶æ€æ ‡è®°, å°±å¯ä»¥å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡ï¼ˆè¿™é‡Œè¦æ³¨æ„, ä¸æ˜¯ç”¨ç¬¬äºŒç§ï¼‰</p><h2 id="2-2-è®¾ç½®éé˜»å¡"><a href="#2-2-è®¾ç½®éé˜»å¡" class="headerlink" title="2.2 è®¾ç½®éé˜»å¡"></a>2.2 è®¾ç½®éé˜»å¡</h2><p>æˆ‘ä»¬éœ€è¦å…ˆå°†æ–‡ä»¶æè¿°ç¬¦åŸæœ¬çš„å±æ€§ç»™å–å‡ºæ¥, ç„¶åå†åŠ ä¸Šéé˜»å¡çš„çŠ¶æ€, ä½¿ç”¨<code>fcntl</code>è®¾ç½®å±æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">SetNoBlock</span><span class="params">(<span class="type">int</span> fd)</span> </span><br><span class="line">&#123; </span><br><span class="line">    <span class="type">int</span> fl = fcntl(fd, F_GETFL);  <span class="comment">// å…ˆè·å–æ–‡ä»¶å·²æœ‰çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (fl &lt; <span class="number">0</span>) &#123; </span><br><span class="line">       perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœ¨å·²æœ‰çŠ¶æ€çš„åŸºç¡€ä¸Š, è®¾ç½®O_NONBLOCKéé˜»å¡</span></span><br><span class="line">    fcntl(fd, F_SETFL, fl | O_NONBLOCK);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3-stdinæµ‹è¯•"><a href="#2-3-stdinæµ‹è¯•" class="headerlink" title="2.3 stdinæµ‹è¯•"></a>2.3 stdinæµ‹è¯•</h2><p>ç„¶å, æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªä¼šå‡ºç°é˜»å¡çš„æ–‡ä»¶æè¿°ç¬¦æ¥ä½œä¸ºæµ‹è¯•ã€‚ä½†æ˜¯, å¦‚æœæ˜¯ç›´æ¥æ‰“å¼€ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶, å¹¶ä¸ä¼šå‡ºç°é˜»å¡æ€ï¼ˆå› ä¸ºæ–‡ä»¶æµä¼šè¢«ä¸€æ¬¡æ€§è¯»å–å‡ºæ¥ï¼‰</p><p>ä¸è¿‡, åœ¨æˆ‘ä»¬æœ€å¸¸ç”¨çš„3ä¸ªé»˜è®¤æ–‡ä»¶æè¿°ç¬¦ä¸­, å°±æœ‰ä¸€ä¸ªæ˜¯èƒ½å¤Ÿå®ç°è¿›ç¨‹é˜»å¡çš„, å®ƒå°±æ˜¯<code>stdin</code>, å› ä¸ºåœ¨æ§åˆ¶å°é‡Œé¢ç­‰å¾…ç”¨æˆ·è¾“å…¥çš„æ—¶å€™, è¿›ç¨‹å°±æ˜¯å¤„äºé˜»å¡çŠ¶æ€çš„ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./test</span><br><span class="line">è¯·è¾“å…¥ï¼š</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å°è¯•å°†stdinè®¾ç½®ä¸ºéé˜»å¡, æ¥è§‚å¯Ÿä¸€ä¸‹ç»“æœ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">SetNoBlock</span>(stdin-&gt;_fileno);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ssize_t</span> read_size = <span class="built_in">read</span>(stdin-&gt;_fileno, buf, <span class="built_in">sizeof</span>(buf) - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(read_size &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;read err&quot;</span>);</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input:%s\n&quot;</span>, buf);</span><br><span class="line">        buf[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘è¿è¡Œ, å½“æ²¡æœ‰è¯»å–åˆ°è¾“å…¥å†…å®¹çš„æ—¶å€™, å¹¶ä¸ä¼šåœ¨<code>stdin</code>ä¸­é˜»å¡, è€Œæ˜¯ä¼šé€šè¿‡perroræ‰“å°å‡ºèµ„æºæš‚æ—¶ä¸å¯ç”¨çš„è­¦å‘Šä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ ./test</span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">asdlfjklaf</span><br><span class="line">input:asdlfjklaf</span><br><span class="line"></span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">adslfkjaldfjklasjfa</span><br><span class="line">input:adslfkjaldfjklasjfa</span><br><span class="line">a</span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">ewqrqreqqrwer</span><br><span class="line">input:ewqrqreqqrwer</span><br><span class="line">asjfa</span><br><span class="line">a</span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">qweioruqoruioqewur</span><br><span class="line">input:qweioruqoruioqewur</span><br><span class="line"></span><br><span class="line">a</span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">weqioruqoieuotqitqwertq</span><br><span class="line">input:weqioruqoieuotqitqwertq</span><br><span class="line">ï¿½ï¿½ï¿½ï¿½a</span><br><span class="line">read err: Resource temporarily unavailable</span><br><span class="line">^C</span><br></pre></td></tr></table></figure><h1 id="3-å¤šè·¯è½¬æ¥ä¹‹select"><a href="#3-å¤šè·¯è½¬æ¥ä¹‹select" class="headerlink" title="3.å¤šè·¯è½¬æ¥ä¹‹select"></a>3.å¤šè·¯è½¬æ¥ä¹‹select</h1><p>æ¥ä¸‹æ¥å°±è¦è¿›å…¥æˆ‘ä»¬çš„æ­£é¢˜äº†, å…³äº<strong>å¤šè·¯è½¬æ¥</strong>çš„çŸ¥è¯†ã€‚</p><p>åœ¨ä¹‹å‰çš„æ—¶å€™, æˆ‘ä»¬å¦‚æœæƒ³åœ¨ä¸€ä¸ªè¿›ç¨‹é‡Œé¢ç»´æŠ¤å¤šä¸ªtcpé“¾æ¥, å°±éœ€è¦ç”¨åˆ°å­çº¿ç¨‹æˆ–è€…å­è¿›ç¨‹æ¥å•ç‹¬ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·æä¾›æœåŠ¡ã€‚<strong>ä½†ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¼€çš„çº¿ç¨‹æ˜¯æœ‰æ•°é‡é™åˆ¶çš„</strong>, åœ¨32ä½ç³»ç»Ÿä¸­, è¿™ä¸ªæ•°å­—å¤§æ¦‚æ˜¯2000ã€‚</p><p>å¯¹äºä¸€ä¸ªé«˜å¹¶å‘çš„æœåŠ¡å™¨æ¥è¯´, è¿™ç‚¹çº¿ç¨‹æ•°æ˜¯å®Œå…¨ä¸å¤Ÿç”¨çš„ï¼å¦‚æœä½ çš„ç½‘ç«™ä¸€æ¬¡æ€§æœ‰2000ä¸ªäººè®¿é—®, ä½ çš„æœåŠ¡å™¨å°±ä¼šå› ä¸ºå¼€ä¸å‡ºæ›´å¤šçš„çº¿ç¨‹è€Œæ— æ³•ä¸ºæ›´å¤šçš„ç”¨æˆ·æä¾›æœåŠ¡ï¼</p><p>æ‰€ä»¥, <strong>å¤šè·¯è½¬æ¥</strong>å°±å‡ºç°äº†, ä»–èƒ½å¸®æˆ‘ä»¬å®ç°å•ä¸ªè¿›ç¨‹ç›‘æ§å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦, åŒæ—¶ä¸ºå¤šä¸ªsocketé“¾æ¥æä¾›æœåŠ¡çš„æ“ä½œï¼</p><blockquote><p>æ™®é€šçš„æœ¬åœ°æ–‡ä»¶æè¿°ç¬¦ä¹Ÿæ˜¯å¯ä»¥æ‰˜ç®¡ç»™å¤šè·¯è½¬æ¥çš„ï¼</p></blockquote><h2 id="3-1-è®¤è¯†select"><a href="#3-1-è®¤è¯†select" class="headerlink" title="3.1 è®¤è¯†select"></a>3.1 è®¤è¯†select</h2><p>selectçš„å‡½æ•°åŸå‹å’Œæˆ‘ä»¬ä¹‹å‰æ¥è§¦è¿‡çš„linuxç³»ç»Ÿè°ƒç”¨æ¥å£éƒ½ä¸å¤§ç›¸ä¼¼, å®ƒçš„æ‰€æœ‰å‚æ•°éƒ½æ˜¯è¾“å…¥è¾“å‡ºå‹å‚æ•°, è€Œä¸”è¿˜ç”¨åˆ°äº†ä¸€ä¸ªæˆ‘ä»¬å¹³æ—¶è¾ƒå°‘æ¥è§¦çš„æ•°æ®ç»“æ„â€”â€”ä½å›¾</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* According to POSIX.1-2001, POSIX.1-2008 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">select</span><span class="params">(<span class="type">int</span> nfds, fd_set *readfds, fd_set *writefds, </span></span></span><br><span class="line"><span class="params"><span class="function">           fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span></span>;</span><br></pre></td></tr></table></figure><p>å…ˆæ¥ä¾æ¬¡è¯´æ˜ä¸€ä¸‹æ¯ä¸€ä¸ªå‚æ•°çš„ä½œç”¨å§</p><ul><li><code>nfds</code>ï¼šéœ€è¦selectå¸®æˆ‘ä»¬ç›‘è§†çš„<code>æœ€å¤§æ–‡ä»¶æè¿°ç¬¦+1</code></li><li><code>readfds/writefds/exceptfds</code>, éœ€è¦selectå¸®æˆ‘ä»¬æ£€æµ‹çš„è¯»&#x2F;å†™&#x2F;å¼‚å¸¸æ–‡ä»¶æè¿°ç¬¦ï¼ˆé€šè¿‡<strong>ä½å›¾</strong>æ¥è®¾å®šï¼‰</li><li><code>timeout</code>ï¼šé˜»å¡ç›‘æ§çš„æ—¶é•¿, ç”¨æ¥è®¾ç½®selectå•æ¬¡é˜»å¡ç­‰å¾…çš„æ—¶é—´</li></ul><h3 id="3-1-1-timeval"><a href="#3-1-1-timeval" class="headerlink" title="3.1.1 timeval"></a>3.1.1 timeval</h3><p>é¦–å…ˆæ¥çœ‹çœ‹timeoutçš„è¿™ä¸ªå‚æ•°çš„<code>struct timeval</code>ç»“æ„ä½“æ¡†æ¶, å†…éƒ¨åŒ…å«ä¸¤ä¸ªæˆå‘˜å˜é‡, ä¸€ä¸ªè¡¨ç¤ºç§’æ•°, ä¸€ä¸ªè¡¨ç¤ºå¾®ç§’æ•°ã€‚æœ€ç»ˆselectç­‰å¾…çš„æ—¶é—´æ˜¯è¿™ä¸¤ä¸ªå‚æ•°çš„<strong>å’Œ</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">    <span class="type">long</span>    tv_sec;         <span class="comment">/* seconds */</span></span><br><span class="line">    <span class="type">long</span>    tv_usec;        <span class="comment">/* microseconds */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè®¾ç½®æˆ0, åˆ™ä»…æ£€æµ‹æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€, ä¸ç®¡ä»€ä¹ˆæƒ…å†µéƒ½ä¼šç«‹å³è¿”å›ï¼ˆå®Œå…¨éé˜»å¡ï¼‰</li><li>å¦‚æœè®¾ç½®æˆæŒ‡å®šçš„æ—¶é—´, åˆ™ä¼šé˜»å¡ç­‰å¾…è¿™ç«¯æ—¶é—´, å¦‚æœæœ‰æ–‡ä»¶äº‹ä»¶åˆ™è¿”å›;å¦‚æœæ²¡æœ‰ç­‰åˆ°æ–‡ä»¶æ—¶é—´, é‚£ä¹ˆæ—¶é—´åˆ°äº†å°±ä¼šè¿”å›</li><li>å¦‚æœå°†<code>timeout</code>å‚æ•°è®¾ç½®æˆ<code>nullptr</code>, åˆ™ä¼š<strong>é˜»å¡ç­‰å¾…</strong></li></ul><p>è¿™ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªè¾“å…¥è¾“å‡ºå‹å‚æ•°, è¿”å›å€¼ä¸ºå‰©ä½™çš„ç§’æ•°ï¼ˆå¦‚æœç­‰å¾…æˆåŠŸçš„è¯ï¼‰</p><h3 id="3-1-2-fd-set"><a href="#3-1-2-fd-set" class="headerlink" title="3.1.2 fd_set"></a>3.1.2 fd_set</h3><p>å‡½æ•°ä¸­æœ‰3ä¸ªå‚æ•°éƒ½æ˜¯ç”¨åˆ°äº†è¿™ä¸ª<code>fd_set</code>ç»“æ„, å®ƒæ˜¯ä¸€ä¸ªä½å›¾ç»“æ„, åŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªè¾“å…¥è¾“å‡ºå‚æ•°</p><ul><li>è¾“å…¥ï¼šç”¨æˆ·å‘Šè¯‰æ“ä½œç³»ç»Ÿ, éœ€è¦å¸®æˆ‘ç›‘æ§é‚£å‡ ä¸ªæ–‡ä»¶æè¿°ç¬¦, åœ¨éœ€è¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šç½®1</li><li>è¾“å‡ºï¼šç³»ç»Ÿå‘Šè¯‰ç”¨æˆ·, é‚£äº›æ–‡ä»¶æè¿°ç¬¦çš„ç›¸å…³äº‹ä»¶å°±ç»ªäº†</li></ul><p>è™½ç„¶è¿™æ˜¯ä¸€ä¸ªä½å›¾ç»“æ„, ä½†å…¶å¹¶ä¸éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å»è®¾ç½®, æ“ä½œç³»ç»Ÿé¡ºä¾¿å¸®æˆ‘ä»¬å°è£…äº†ç›¸å…³çš„è®¾ç½®â€œå‡½æ•°â€, åªéœ€è¦ä¼ å…¥fdå’Œè¯¥ç»“æ„ä½“å³å¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;  <span class="comment">// æ¸…ç©ºä½å›¾ä¸­å¯¹è¯¥æ–‡ä»¶æè¿°ç¬¦çš„è®¾ç½®</span></span><br><span class="line"><span class="function"><span class="type">int</span>  <span class="title">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;<span class="comment">// åˆ¤æ–­æ˜¯å¦è¢«è®¾ç½®äº†</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *set)</span></span>;  <span class="comment">// è®¾ç½®å¯¹åº”ä½ç½®çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *set)</span></span>;         <span class="comment">// æ¸…ç©ºæ•´ä¸ªä½å›¾</span></span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½å›è§‰å¾—å¥‡æ€ª, ä¸ºä»€ä¹ˆè¿™äº›â€œå‡½æ•°â€æ˜¯å¤§å†™çš„å‘¢ï¼ŸLinuxä¸­å¤§å†™çš„åº”è¯¥æ˜¯å®æ‰å¯¹å§ï¼Ÿ</p><p>ç­”å¯¹äº†ï¼è¿™é‡Œçš„è®¾ç½®å‡½æ•°å…¶å®éƒ½æ˜¯å®å®šä¹‰ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Access macros for `fd_set&#x27;.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	FD_SET(fd, fdsetp)	__FD_SET (fd, fdsetp)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	FD_CLR(fd, fdsetp)	__FD_CLR (fd, fdsetp)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	FD_ISSET(fd, fdsetp)	__FD_ISSET (fd, fdsetp)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	FD_ZERO(fdsetp)		__FD_ZERO (fdsetp)</span></span><br></pre></td></tr></table></figure><p>æ—¢ç„¶æ˜¯ä¸€ä¸ªé¢„å®šä¹‰å¥½çš„ä½å›¾, é‚£ä¹ˆå®ƒçš„é•¿åº¦å°±ä¼šæ”¶åˆ°æ“ä½œç³»ç»Ÿåº•å±‚çš„ä¸€å®šé™åˆ¶, ä»¥ä¸‹ä¸ºæºä»£ç ä¸­<code>fd_set</code>ç»“æ„ä½“çš„å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·¯å¾„ usr/include/sys/select.h</span></span><br><span class="line"><span class="comment">/* The fd_set member is required to be an array of longs.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">long</span> <span class="type">int</span> __fd_mask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Some versions of &lt;linux/posix_types.h&gt; define this macros.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span>	__NFDBITS</span></span><br><span class="line"><span class="comment">/* It&#x27;s easier to assume 8-bit bytes than to get CHAR_BIT.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __NFDBITS	(8 * (int) sizeof (__fd_mask))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	__FD_ELT(d)	((d) / __NFDBITS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	__FD_MASK(d)	((__fd_mask) (1UL &lt;&lt; ((d) % __NFDBITS)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fd_set for select and pselect.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* XPG4.2 requires this member name.  Otherwise avoid the name</span></span><br><span class="line"><span class="comment">       from the global namespace.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __USE_XOPEN</span></span><br><span class="line">    __fd_mask fds_bits[__FD_SETSIZE / __NFDBITS];</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __FDS_BITS(set) ((set)-&gt;fds_bits)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    __fd_mask __fds_bits[__FD_SETSIZE / __NFDBITS];</span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __FDS_BITS(set) ((set)-&gt;__fds_bits)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125; fd_set;</span><br></pre></td></tr></table></figure><p>åœ¨å¦å¤–ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­, å¯ä»¥æ‰¾åˆ°<code>__FD_SETSIZE</code>è¿™ä¸ªå®çš„å®šä¹‰, æ˜¯1024;ä¹Ÿå°±æ˜¯è¯´, <code>fd_set</code>è¿™ä¸ªä½å›¾æœ€å¤§çš„é•¿åº¦åªæœ‰1024ä¸ªæ¯”ç‰¹ä½, æˆ‘ä»¬ä¹Ÿåªèƒ½ç›‘çœ‹è¿™ä¹ˆå¤šæ–‡ä»¶æè¿°ç¬¦ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·¯å¾„ usr/include/bits/typesizes.h</span></span><br><span class="line"><span class="comment">/* Number of descriptors that can fit in an `fd_set&#x27;.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FD_SETSIZE		1024</span></span><br></pre></td></tr></table></figure><p>è¿™ä¹Ÿæ˜¯<code>select</code>çš„ç¼ºç‚¹ä¹‹ä¸€, åŒæ—¶ç›‘çœ‹çš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡æ˜¯<strong>æœ‰é™åˆ¶</strong>çš„ï¼</p><h3 id="3-1-3-nfds"><a href="#3-1-3-nfds" class="headerlink" title="3.1.3 nfds"></a>3.1.3 nfds</h3><p>è¿™ä¸ªå‚æ•°æ˜¯selectéœ€è¦å¸®æˆ‘ä»¬ç›‘çœ‹çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦+1, è¿™æ˜¯å› ä¸ºselectåœ¨ç›‘çœ‹çš„è¿‡ç¨‹ä¸­éœ€è¦ç”¨å¾ªç¯æ¥è¿›è¡Œæ£€æµ‹, è¿™ä¸ªæœ€å¤§æ–‡ä»¶æè¿°ç¬¦+1ç›¸å½“äºæ˜¯ä¸€ä¸ªå¾ªç¯çš„è¾¹ç•Œæ¡ä»¶;</p><p>ä½ åªéœ€æ ¹æ®å½“å‰å·²æœ‰çš„æ–‡ä»¶æè¿°ç¬¦å·, è®¡ç®—å‡ºæœ€å¤§æ–‡ä»¶æè¿°ç¬¦, å†åŠ ä¸€ä¼ ç»™è¿™ä¸ªå‡½æ•°å³å¯ã€‚</p><h3 id="3-1-4-è¿”å›å€¼"><a href="#3-1-4-è¿”å›å€¼" class="headerlink" title="3.1.4 è¿”å›å€¼"></a>3.1.4 è¿”å›å€¼</h3><p>manæ‰‹å†Œä¸­å¯¹è¿”å›å€¼çš„æè¿°å¦‚ä¸‹</p><ul><li>æˆåŠŸçš„æ—¶å€™, è¿”å›äº‹ä»¶å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡</li><li>å¤±è´¥çš„æ—¶å€™è¿”å›<code>-1</code>, å¹¶è®¾ç½®errno</li><li>å¦‚æœå·²ç»<code>timeout</code>äº†è¿˜æ²¡æœ‰äº‹ä»¶å°±ç»ª, è¿”å›0</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RETURN VALUE</span><br><span class="line">       On success, select() and pselect() return the number of file descriptors contained in the three returned descriptor  sets  (that  is,  the total  number  of  bits that are set in readfds, writefds, exceptfds) which may be zero if the timeout expires before anything interesting happens.  On error, -1 is returned, and errno is set to indicate the error; the file descriptor sets are unmodified, and  timeout becomes undefined.</span><br></pre></td></tr></table></figure><h2 id="3-2-å®ä¾‹"><a href="#3-2-å®ä¾‹" class="headerlink" title="3.2 å®ä¾‹"></a>3.2 å®ä¾‹</h2><p>å‡½æ•°åŸå‹çœ‹å®Œäº†, å¾—ä»å®ä¾‹å‡ºå‘æ¥è¯•è¯•äº†</p><h3 id="3-2-1-socket"><a href="#3-2-1-socket" class="headerlink" title="3.2.1 socket"></a>3.2.1 socket</h3><p>è¿™é‡Œå…ˆå¯¹<span id="jump-select">socket</span>åšäº†ä¸€ä¸ªç®€å•çš„å°è£…, åŒ…æ‹¬åˆå§‹åŒ–, ç»‘å®šç›¸å…³çš„æ¥å£, åªéœ€è¦åœ¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶é‡Œé¢è°ƒç”¨è¿™ä¸ªå¤´æ–‡ä»¶å³å¯ !</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Sock.hpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sock</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> gbacklog = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">SocketInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> listenSock = <span class="built_in">socket</span>(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (listenSock &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®ç«¯å£å¤ç”¨, é¿å…timewaité˜»å¡ç«¯å£</span></span><br><span class="line">        <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">setsockopt</span>(listenSock, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &amp;opt, <span class="built_in">sizeof</span>(opt));</span><br><span class="line">        <span class="keyword">return</span> listenSock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Bind</span><span class="params">(<span class="type">int</span> socket, <span class="type">uint16_t</span> port)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> local; <span class="comment">// ç”¨æˆ·æ ˆ</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;local, <span class="number">0</span>, <span class="keyword">sizeof</span> local);</span><br><span class="line">        local.sin_family = PF_INET;</span><br><span class="line">        local.sin_port = <span class="built_in">htons</span>(port);</span><br><span class="line">        local.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.2 æœ¬åœ°socketä¿¡æ¯, å†™å…¥sock_å¯¹åº”çš„å†…æ ¸åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">bind</span>(socket, (<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)&amp;local, <span class="built_in">sizeof</span>(local)) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">Listen</span><span class="params">(<span class="type">int</span> socket)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">listen</span>(socket, gbacklog) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">Accept</span><span class="params">(<span class="type">int</span> socket, std::string *clientip, <span class="type">uint16_t</span> *clientport)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peer;</span><br><span class="line">        <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(peer);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> serviceSock = <span class="built_in">accept</span>(socket, (<span class="keyword">struct</span> sockaddr *)&amp;peer, &amp;len);</span><br><span class="line">        <span class="keyword">if</span> (serviceSock &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è·å–é“¾æ¥å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(clientport) *clientport = <span class="built_in">ntohs</span>(peer.sin_port);</span><br><span class="line">        <span class="keyword">if</span>(clientip) *clientip = <span class="built_in">inet_ntoa</span>(peer.sin_addr);</span><br><span class="line">        <span class="keyword">return</span> serviceSock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¦å¤–é‡ç‚¹è¯´æ˜ä¸€ä¸‹è¿™ä¸¤è¡Œ, åœ¨ä¹‹å‰å­¦ä¹ tcpæœåŠ¡å™¨çš„æ—¶å€™å°±æåˆ°è¿‡, è¿™é‡Œçš„<code>SO_REUSEADDR</code>æ˜¯è®©ç«¯å£å¯ä»¥è¢«å¤ç”¨, ä¸ä¼šå› ä¸ºå­˜åœ¨<code>TIME_WAIT</code>çš„é“¾æ¥è€Œæ— æ³•ç»‘å®šç«¯å£ã€‚é€‚ç”¨äºæœåŠ¡å™¨å¿«é€Ÿé‡å¯çš„æƒ…å†µã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¾ç½®ç«¯å£å¤ç”¨, é¿å…timewaité˜»å¡ç«¯å£</span></span><br><span class="line"><span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">setsockopt</span>(listenSock, SOL_SOCKET, SO_REUSEADDR | SO_REUSEPORT, &amp;opt, <span class="built_in">sizeof</span>(opt));</span><br></pre></td></tr></table></figure><h3 id="3-2-2-åˆå§‹åŒ–"><a href="#3-2-2-åˆå§‹åŒ–" class="headerlink" title="3.2.2 åˆå§‹åŒ–"></a>3.2.2 åˆå§‹åŒ–</h3><p>è¿˜æ˜¯è€ä¸€å¥—, é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è·å–åˆ°ç«¯å£å·, åˆ›å»ºsocket_fdå¹¶ç»‘å®šç«¯å£å’Œå¼€å§‹<code>listen</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">cmd_usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–socket, è·å–socket fdå¹¶ç»‘å®šç«¯å£</span></span><br><span class="line">    <span class="type">int</span> listensock = Sock::<span class="built_in">SocketInit</span>();</span><br><span class="line">    Sock::<span class="built_in">Bind</span>(listensock, <span class="built_in">atoi</span>(argv[<span class="number">1</span>]));</span><br><span class="line">    Sock::<span class="built_in">Listen</span>(listensock); <span class="comment">// å¼€å§‹ç›‘å¬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯, åœ¨selectä¸­çš„æ–‡ä»¶æè¿°ç¬¦éƒ½åªå‰©ä½å›¾äº†, æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç»„æ¥ååŠ©æˆ‘ä»¬ç®¡ç†æ­£åœ¨ç»´æŠ¤çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿, æˆ‘è®¾ç«‹äº†ä¸€ä¸ªå…¨å±€çš„æ•°ç»„å˜é‡, é•¿åº¦ä¸º<code>sizeof(fd_set) * 8</code>, æ˜¯<code>fd_set</code>è¿™ä¸ªä½å›¾ç»“æ„ä½“èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§socketæ•°é‡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fdsArray[<span class="built_in">sizeof</span>(fd_set) * <span class="number">8</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// ä¿å­˜å†å²ä¸Šæ‰€æœ‰çš„åˆæ³•fd</span></span><br><span class="line"><span class="type">int</span> fdsArraySz = <span class="built_in">sizeof</span>(fdsArray) / <span class="built_in">sizeof</span>(fdsArray[<span class="number">0</span>]);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFL_FD -1 <span class="comment">// æ•°ç»„ä¸­é»˜è®¤å€¼</span></span></span><br></pre></td></tr></table></figure><p>åœ¨mainå‡½æ•°ä¸­, æˆ‘ä»¬éœ€è¦é€šè¿‡éå†æ¥å°†è¿™ä¸ªæ•°ç»„è®¾ç½®ä¸ºé»˜è®¤çš„æ–‡ä»¶æè¿°ç¬¦<code>-1</code>æ¥è¡¨æ˜å½“å‰ä½ç½®æ²¡æœ‰è¢«ä½¿ç”¨, å¹¶å°†0ä¸‹æ ‡å¤„è®¾ç½®ä¸º<code>listensock</code>;å¦‚æœä½ ä½¿ç”¨çš„æ˜¯vector, åˆ™å¯ä»¥ç›´æ¥ç”¨æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–;</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†æ•°ç»„é‡Œé¢çš„æ–‡ä»¶æè¿°ç¬¦éƒ½åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼, å¹¶å°†ç¬¬ä¸€ä¸ªä¸‹æ ‡è®¾ç½®ä¸ºlistensocket</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fdsArraySz; i++)&#123;</span><br><span class="line">    fdsArray[i] = DFL_FD;</span><br><span class="line">&#125;</span><br><span class="line">fdsArray[<span class="number">0</span>] = listensock;</span><br></pre></td></tr></table></figure><h3 id="3-2-3-ç›‘å¬"><a href="#3-2-3-ç›‘å¬" class="headerlink" title="3.2.3 ç›‘å¬"></a>3.2.3 ç›‘å¬</h3><p>åˆå§‹åŒ–å®Œæ¯•æ•°ç»„å, å°±å¯ä»¥å¼€å§‹å¾ªç¯è°ƒç”¨<code>select</code>æ¥è¿›è¡Œç›‘å¬äº†ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯, å› ä¸º<code>select</code>çš„<code>fd_set</code>æ˜¯ä¸€ä¸ªä½å›¾, è€Œä¸”æ˜¯è¾“å…¥è¾“å‡ºå‚æ•°ã€‚æ¯æ¬¡çš„<code>select</code>è°ƒç”¨ä¹‹å, è¿™äº›ä½å›¾å°±ä¼šè¢«æ“ä½œç³»ç»Ÿä¿®æ”¹ä¸ºå·²ç»å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆå³å‚æ•°æœ¬èº«ä¼šè¢«ä¿®æ”¹ï¼‰æ‰€ä»¥æˆ‘ä»¬ä¸‹ä¸€æ¬¡è°ƒç”¨ä¹‹å‰, <strong>éœ€è¦é‡æ–°è®¾ç½®ä½å›¾å‚æ•°</strong>ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼€å§‹ç›‘å¬</span></span><br><span class="line">fd_set readfds;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> maxFd = DFL_FD;</span><br><span class="line">    <span class="built_in">FD_ZERO</span>(&amp;readfds); <span class="comment">// æ¸…ç©ºä½å›¾</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> timeout = &#123;<span class="number">5</span>, <span class="number">0</span>&#125;; <span class="comment">// è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º5ç§’</span></span><br><span class="line">    <span class="comment">// éå†å…¨å±€æ•°ç»„, å°†æœ‰æ•ˆçš„fdéƒ½æ·»åŠ è¿›å», å¹¶æ›´æ–°maxfd</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fdsArraySz; i++)</span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="comment">// 1. è¿‡æ»¤ä¸åˆæ³•çš„fd</span></span><br><span class="line">        <span class="keyword">if</span> (fdsArray[i] == DFL_FD) <span class="keyword">continue</span>;   </span><br><span class="line">        <span class="comment">// 2. æ·»åŠ æ‰€æœ‰çš„åˆæ³•çš„fdåˆ°readfdsä¸­, æ–¹ä¾¿selectç»Ÿä¸€è¿›è¡Œå°±ç»ªç›‘å¬</span></span><br><span class="line">        <span class="built_in">FD_SET</span>(fdsArray[i], &amp;readfds); </span><br><span class="line">        <span class="keyword">if</span> (maxFd &lt; fdsArray[i]) &#123;</span><br><span class="line">            maxFd = fdsArray[i]; <span class="comment">// 3. æ›´æ–°å‡ºfdæœ€å¤§å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è°ƒç”¨selectå¼€å§‹ç›‘å¬</span></span><br><span class="line">    <span class="type">int</span> sret = <span class="built_in">select</span>(maxFd+<span class="number">1</span>, &amp;readfds, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, &amp;timeout);</span><br><span class="line">    <span class="keyword">switch</span> (sret)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">// ç­‰å¾…è¶…æ—¶</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;time out ... : &quot;</span> &lt;&lt; (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>) &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:<span class="comment">// ç­‰å¾…å¤±è´¥</span></span><br><span class="line">        cerr &lt;&lt; errno &lt;&lt; <span class="string">&quot; : &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// ç­‰å¾…æˆåŠŸ</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;wait success: &quot;</span> &lt;&lt; sret &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬æ¡†æ¶æ­èµ·æ¥äº†, æˆ‘ä»¬è¿™æ—¶å€™å°±åªéœ€è¦å®ç°ç­‰å¾…æˆåŠŸåå–å‡ºé“¾æ¥å’ŒIOä¿¡æ¯çš„æ“ä½œäº†;</p><p>å…ˆæ¥æµ‹è¯•ä¸€ä¸‹å½“å‰çš„æ‰‹è„šæ¶å§</p><h3 id="3-2-4-æ‰‹è„šæ¶æµ‹è¯•"><a href="#3-2-4-æ‰‹è„šæ¶æµ‹è¯•" class="headerlink" title="3.2.4 æ‰‹è„šæ¶æµ‹è¯•"></a>3.2.4 æ‰‹è„šæ¶æµ‹è¯•</h3><p>ç¼–è¯‘å¯åŠ¨, ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ¥ç»‘å®šç«¯å£, åœ¨æ²¡æœ‰æ”¶åˆ°æ•°æ®ä¹‹å‰, è¿›ç¨‹ä¼šåœ¨selectä¸­é˜»å¡ç­‰å¾…5ç§’, éšåå› ä¸ºè¶…æ—¶è·³å‡ºé˜»å¡æ€, è¿”å›0å¹¶æ‰“å°å½“å‰æ—¶é—´æˆ³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ g++ main.cpp -o test</span><br><span class="line">$ ./test 10000</span><br><span class="line">time out ... : 1692955522</span><br><span class="line">time out ... : 1692955527</span><br><span class="line">time out ... : 1692955532</span><br><span class="line">time out ... : 1692955537</span><br><span class="line">time out ... : 1692955542</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>telnet</code>å‘½ä»¤æ¥é“¾æ¥å½“å‰æœåŠ¡, <code>select</code>æ£€æµ‹åˆ°listensockæ–‡ä»¶æè¿°ç¬¦å°±ç»ª, ä¼šç«‹åˆ»è¿”å›ï¼ˆå¯¹äºlistensockæ¥è¯´, æ¥äº†æ–°é“¾æ¥å°±æ˜¯è¯»IOå°±ç»ªï¼‰ä½†å› ä¸ºæˆ‘ä»¬æ²¡æœ‰å†™å–èµ°æ–°socketçš„ä»£ç , æ‰€ä»¥è¿™é‡Œä¼šä¸€ç›´æ‰“å°äº‹ä»¶å°±ç»ª;</p><p>è¿”å›å€¼ä¸º1, ä»£è¡¨æœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/bcd37076cf11a3ec0d3caac5f7f0501f.png" alt="image-20230825172642067"></p><h3 id="3-2-5-å¤„ç†æ–°è¿æ¥"><a href="#3-2-5-å¤„ç†æ–°è¿æ¥" class="headerlink" title="3.2.5 å¤„ç†æ–°è¿æ¥"></a>3.2.5 å¤„ç†æ–°è¿æ¥</h3><p>åœ¨<code>select</code>äº‹ä»¶å°±ç»ªå, ä½¿ç”¨å¦‚ä¸‹å‡½æ•°æ¥å¤„ç†æ–°çš„é“¾æ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">HandlerEvent</span><span class="params">(<span class="type">int</span> listensock, fd_set &amp;readfds)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢å¤–å†™äº†ä¸€ä¸ªæ‰“å°æ•°ç»„ä¸­å…ƒç´ çš„å‡½æ•°, æ–¹ä¾¿æˆ‘ä»¬è§‚å¯Ÿç»“æœã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// @brief æ‰“å°æ•°ç»„ä¸­çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ShowArray</span><span class="params">(<span class="type">int</span> arr[], <span class="type">int</span> num)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;å½“å‰åˆæ³•sock list: &quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] == DFL_FD )</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; arr[i] &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦éå†æ•´ä¸ªé“¾æ¥æ•°ç»„, å¹¶åˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚æ— æ•ˆç›´æ¥è·³è¿‡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; fdsArraySz; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (fdsArray[i] == DFL_FD)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// å¤„ç†æ–°è¿æ¥å’Œå·²æœ‰é“¾æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†çš„æ—¶å€™, æˆ‘ä»¬éœ€è¦å¯¹listensockåšå•ç‹¬çš„å¤„ç†, æ¯•ç«Ÿè·å–æ–°è¿æ¥å’Œç»´æŠ¤å·²æœ‰é“¾æ¥çš„æµç¨‹æ˜¯å®Œå…¨ä¸åŒçš„ã€‚ä¸‹é¢è¯´è¯´æµç¨‹</p><ul><li>åˆ¤æ–­æ˜¯å¦æœ‰åœ¨selectä¸­ç›‘å¬è¯¥æ–‡ä»¶æè¿°ç¬¦</li><li>æœ‰ç›‘å¬, ç»§ç»­å¾€åæ‰§è¡Œ, å¼€å§‹è¿›è¡Œ<code>accept</code>è·å–æ–°çš„é“¾æ¥</li><li>è·å–å¤±è´¥, ç›´æ¥è·³å‡ºè¯¥å‡½æ•°, ç»“æŸè¯¥è½®å¤„ç†</li><li>è·å–æˆåŠŸ, ä¸èƒ½ç›´æ¥read&#x2F;write, è€Œæ˜¯åº”è¯¥é€šè¿‡æ•°ç»„äº¤ä»˜ç»™selectå¸®æˆ‘ä»¬ç›‘å¬äº‹ä»¶</li><li>ä¸‹ä¸€è½®å¾ªç¯ä¸­, selectä¾¿ä¼šå¸®æˆ‘ä»¬ç›‘å¬è¯¥æ–°é“¾æ¥çš„äº‹ä»¶æ˜¯å¦å°±ç»ª</li></ul><p>å› ä¸ºèµ°åˆ°è¿™é‡Œçš„æ—¶å€™, æˆ‘ä»¬çš„<code>listensocket</code>é‡Œé¢æ˜¯ä¸€å®šæœ‰æ–°è¿æ¥çš„, æ‰€ä»¥å¯¹<code>accept</code>çš„è°ƒç”¨æ˜¯ä¸ä¼šé˜»å¡çº¿ç¨‹çš„ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (i == <span class="number">0</span> &amp;&amp; fdsArray[i] == listensock)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­listensocketæœ‰æ²¡æœ‰äº‹ä»¶ç›‘å¬</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">FD_ISSET</span>(listensock, &amp;readfds))&#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;listensocket not set in readfds&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…·æœ‰äº†ä¸€ä¸ªæ–°é“¾æ¥</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;get new connection&quot;</span> &lt;&lt; endl;</span><br><span class="line">    string clientip;</span><br><span class="line">    <span class="type">uint16_t</span> clientport = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> sock = Sock::<span class="built_in">Accept</span>(listensock, &amp;clientip, &amp;clientport); <span class="comment">// ä¸ä¼šé˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// å‡ºé”™äº†, ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="comment">// æˆåŠŸè·å–æ–°è¿æ¥</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;new conn:&quot;</span> &lt;&lt; clientip &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; clientport &lt;&lt; <span class="string">&quot; | sock: &quot;</span> &lt;&lt; sock &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™é‡Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å¯¹è¿™ä¸ªsocketè¿›è¡Œç‹¬å†™, å› ä¸ºæ–°é“¾æ¥æ¥äº†å¹¶ä¸ä»£è¡¨æ–°æ•°æ®ä¸€å¹¶è¿‡æ¥äº†</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥éœ€è¦å°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦åˆ©ç”¨å…¨å±€æ•°ç»„, äº¤ä»˜ç»™select</span></span><br><span class="line">    <span class="comment">// select å¸®æˆ‘ä»¬ç›‘çœ‹socketä¸Šçš„è¯»äº‹ä»¶æ˜¯å¦å°±ç»ª</span></span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; fdsArraySz; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (fdsArray[i] == DFL_FD)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¾¾åˆ°ä¸Šé™äº†</span></span><br><span class="line">    <span class="keyword">if</span> (i == fdsArraySz)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;reach the maximum number of connections&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">close</span>(sock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// æ²¡æœ‰è¾¾åˆ°</span></span><br><span class="line">    &#123;</span><br><span class="line">        fdsArray[i] = sock; <span class="comment">// æ–°çš„é“¾æ¥, æ’å…¥åˆ°æ•°ç»„ä¸­, ä¸‹æ¬¡éå†å°±ä¼šæ·»åŠ åˆ°selectç›‘çœ‹ä¸­</span></span><br><span class="line">        <span class="built_in">ShowArray</span>(fdsArray, fdsArraySz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-6-å¤„ç†å·²æœ‰é“¾æ¥"><a href="#3-2-6-å¤„ç†å·²æœ‰é“¾æ¥" class="headerlink" title="3.2.6 å¤„ç†å·²æœ‰é“¾æ¥"></a>3.2.6 å¤„ç†å·²æœ‰é“¾æ¥</h3><p>è¿™é‡Œæš‚æ—¶åªåšäº†å¯¹è¯»çš„æ“ä½œ, å½“è¯»äº‹ä»¶å°±ç»ªçš„æ—¶å€™, æˆ‘ä»¬é€šè¿‡readè¯»å–å·²æœ‰çš„æ•°æ®ã€‚è¿™é‡Œå› ä¸ºsocketä¸­è‚¯å®šæ˜¯æœ‰æ•°æ®çš„, æ‰€ä»¥ä¹Ÿä¸ä¼šå‡ºç°é˜»å¡çš„æƒ…å†µã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// end if (i == 0 &amp;&amp; fdsArray[i] == listensock)</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¤„ç†æ™®é€šsockçš„IOäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">FD_ISSET</span>(fdsArray[i], &amp;readfds))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// readã€recvè¯»å–å³å¯</span></span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">recv</span>(fdsArray[i], buffer, <span class="built_in">sizeof</span>(buffer), <span class="number">0</span>); <span class="comment">// ä¸ä¼šé˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buffer[s] = <span class="number">0</span>;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;client[&quot;</span> &lt;&lt; fdsArray[i] &lt;&lt; <span class="string">&quot;]# &quot;</span> &lt;&lt; buffer &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">0</span>) <span class="comment">// å¯¹ç«¯å…³é—­</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;client[&quot;</span> &lt;&lt; fdsArray[i] &lt;&lt; <span class="string">&quot;] quit, server close &quot;</span> &lt;&lt; fdsArray[i] &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">close</span>(fdsArray[i]);</span><br><span class="line">            fdsArray[i] = DFL_FD; <span class="comment">// å»é™¤å¯¹è¯¥æ–‡ä»¶æè¿°ç¬¦çš„selectäº‹ä»¶ç›‘å¬</span></span><br><span class="line">            <span class="built_in">ShowArray</span>(fdsArray, fdsArraySz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">// å¼‚å¸¸äº†</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;client[&quot;</span> &lt;&lt; fdsArray[i] &lt;&lt; <span class="string">&quot;] error, server close &quot;</span> &lt;&lt; fdsArray[i] &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">close</span>(fdsArray[i]);</span><br><span class="line">            fdsArray[i] = DFL_FD; <span class="comment">// å»é™¤å¯¹è¯¥æ–‡ä»¶æè¿°ç¬¦çš„selectäº‹ä»¶ç›‘å¬</span></span><br><span class="line">            <span class="built_in">ShowArray</span>(fdsArray, fdsArraySz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘å•æ¬¡è¯»å–çš„æ—¶å€™, æœ€å¤šåªèƒ½è¯»å‡º1024å­—èŠ‚çš„æ•°æ®;å¦‚æœæƒ³ä¸€æ¬¡æ€§è¯»å–å®Œæ¯•, åˆ™éœ€è¦ä½¿ç”¨å¾ªç¯+è®¾ç½®éé˜»å¡æ¥è¿›è¡Œè¯»å–ã€‚åç»­åœ¨epollçš„ä»£ç ç¤ºä¾‹ä¸­ä¼šå±•ç¤ºè¿™ç§å†™æ³•ã€‚</p><h3 id="3-2-7-å®æµ‹"><a href="#3-2-7-å®æµ‹" class="headerlink" title="3.2.7 å®æµ‹"></a>3.2.7 å®æµ‹</h3><p>åˆ°è¿™é‡Œ, æˆ‘ä»¬è¿™å¥—ä»£ç å°±åŸºæœ¬å®Œæˆäº†, å¯ä»¥æ¥æµ‹è¯•ä¸€ä¸‹èƒ½å¦å®ç°å•çº¿ç¨‹ç›‘å¬å¤šä¸ªé“¾æ¥;</p><p>åœ¨æœ¬åœ°ä½¿ç”¨telnet+å¤šä¸ªç»ˆç«¯è¿›è¡Œæµ‹è¯•, å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸå®ç°äº†åŒæ—¶ç›‘å¬ä¸¤ä¸ªé“¾æ¥, å¹¶æ¥å—è¿™ä¸¤ä¸ªé“¾æ¥ç»™è‡ªå·±å‘é€çš„ä¿¡æ¯çš„åŠŸèƒ½ã€‚å½“telneté€€å‡ºçš„æ—¶å€™, ä¹Ÿèƒ½æˆåŠŸå›æ”¶æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/c14d2576fc599392522042a1bb12ddc5.png" alt="image-20230825183501900"></p><p>selectçš„å°å®ç°æš‚æ—¶å…ˆçœ‹åˆ°è¿™é‡Œ, å¦‚æœæƒ³ç”¨selectå®ç°åŒæ—¶è¯»+å†™, å…¶å®æ˜¯å¾ˆå¤æ‚çš„ã€‚éœ€è¦ä¸€å¥—å®Œæ•´çš„é€»è¾‘ã€‚è¿™å°±ç•™ç€åˆ°æœ€åepollçš„æ—¶å€™å†ç»Ÿä¸€å±•ç°å§ï¼</p><h2 id="3-3-socketå°±ç»ªæ¡ä»¶"><a href="#3-3-socketå°±ç»ªæ¡ä»¶" class="headerlink" title="3.3 socketå°±ç»ªæ¡ä»¶"></a>3.3 socketå°±ç»ªæ¡ä»¶</h2><p><span id="jump3">socketä¸åŒäº‹ä»¶çš„å°±ç»ªæœ‰å„è‡ªçš„æ¡ä»¶</span></p><h3 id="3-3-1-è¯»å°±ç»ª"><a href="#3-3-1-è¯»å°±ç»ª" class="headerlink" title="3.3.1 è¯»å°±ç»ª"></a>3.3.1 è¯»å°±ç»ª</h3><ul><li>socketå†…æ ¸ä¸­, æ¥æ”¶ç¼“å†²åŒºä¸­çš„å­—èŠ‚æ•°, å¤§äºç­‰äºä½æ°´ä½æ ‡è®°<code>SO_RCVLOWAT</code>, æ­¤æ—¶å¯ä»¥æ— é˜»å¡çš„è¯»è¯¥æ–‡ä»¶æè¿°ç¬¦, å¹¶ä¸”è¿”å›å€¼å¤§äº0;</li><li>socketåœ¨TCPé€šä¿¡ä¸­, å¯¹ç«¯å…³é—­è¿æ¥, æ­¤æ—¶å¯¹è¯¥socketè¯», åˆ™è¿”å›0;</li><li>ç›‘å¬çš„socketä¸Šæœ‰æ–°çš„è¿æ¥è¯·æ±‚;</li><li>socketä¸Šæœ‰æœªå¤„ç†çš„é”™è¯¯;</li></ul><h3 id="3-3-2-å†™å°±ç»ª"><a href="#3-3-2-å†™å°±ç»ª" class="headerlink" title="3.3.2 å†™å°±ç»ª"></a>3.3.2 å†™å°±ç»ª</h3><ul><li>socketå†…æ ¸ä¸­, å‘é€ç¼“å†²åŒºä¸­çš„å¯ç”¨å­—èŠ‚æ•°(å‘é€ç¼“å†²åŒºçš„ç©ºé—²ä½ç½®å¤§å°), å¤§äºç­‰äºä½æ°´ä½æ ‡è®° <code>SO_SNDLOWAT</code>, æ­¤æ—¶å¯ä»¥æ— é˜»å¡çš„å†™, å¹¶ä¸”è¿”å›å€¼å¤§äº0;</li><li>socketçš„å†™æ“ä½œè¢«å…³é—­(closeæˆ–è€…shutdown). å¯¹ä¸€ä¸ªå†™æ“ä½œè¢«å…³é—­çš„socketè¿›è¡Œå†™æ“ä½œ, ä¼šè§¦å‘ <code>SIGPIPE</code> ä¿¡å·;</li><li>socketä½¿ç”¨éé˜»å¡connectè¿æ¥æˆåŠŸæˆ–å¤±è´¥ä¹‹å;</li><li>socketä¸Šæœ‰æœªè¯»å–çš„é”™è¯¯;</li></ul><h3 id="3-3-3-å¼‚å¸¸å°±ç»ª"><a href="#3-3-3-å¼‚å¸¸å°±ç»ª" class="headerlink" title="3.3.3 å¼‚å¸¸å°±ç»ª"></a>3.3.3 å¼‚å¸¸å°±ç»ª</h3><p>socketä¸Šæ”¶åˆ°å¸¦å¤–æ•°æ®ï¼ˆTCPæŠ¥å¤´ä¸­çš„URGå’Œç´§æ€¥æŒ‡é’ˆï¼‰</p><h2 id="3-4-selectçš„ç‰¹ç‚¹"><a href="#3-4-selectçš„ç‰¹ç‚¹" class="headerlink" title="3.4 selectçš„ç‰¹ç‚¹"></a>3.4 selectçš„ç‰¹ç‚¹</h2><ul><li>å¯ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ä¸Šé™, å–å†³äº<code>fd_set</code>ä½å›¾ç»“æ„ä½“çš„é…ç½®</li><li>åœ¨ç›‘æ§æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™, éœ€è¦ç”¨æˆ·é¢å¤–çš„æ•°ç»„æ¥ç»´æŠ¤æ–‡ä»¶æè¿°ç¬¦</li><li>æ¯æ¬¡å¾ªç¯éƒ½å¾—éå†æ•´ä¸ªæ•°ç»„, æ•ˆç‡è¾ƒä½ï¼ˆå¯ä»¥ä¼˜åŒ–ä¸ºä¿è¯æœ‰æ•ˆæ–‡ä»¶æè¿°ç¬¦éƒ½åœ¨æ•°ç»„çš„å‰æ–¹ï¼‰</li></ul><p>ä¸€ä¸‹æ˜¯å®ƒåœ¨æ•ˆç‡ä¸Šçš„ä¸€äº›ç¼ºç‚¹</p><ul><li>æ¯æ¬¡è°ƒç”¨selectéƒ½å¾—æ‰‹åŠ¨è®¾ç½®ä¸€è¾¹fdé›†å’Œï¼ˆå› ä¸º<code>fd_set</code>ä¹Ÿæ˜¯è¾“å‡ºå‹å‚æ•°, åœ¨å†…æ ¸ä¸­ä¼šè¢«ä¿®æ”¹ï¼‰</li><li>æ¯æ¬¡è°ƒç”¨select, éƒ½éœ€è¦æŠŠæ‰€æœ‰fdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€, å°é™†åœ°</li><li>æ¯æ¬¡è°ƒç”¨, å†…æ ¸éƒ½é¡»éå†ä¼ é€’è¿›æ¥çš„ä½å›¾, æ•ˆç‡ä½</li><li>ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ä¸Šé™, æ•°é‡å°</li></ul><h1 id="4-å¤šè·¯è½¬æ¥ä¹‹poll"><a href="#4-å¤šè·¯è½¬æ¥ä¹‹poll" class="headerlink" title="4.å¤šè·¯è½¬æ¥ä¹‹poll"></a>4.å¤šè·¯è½¬æ¥ä¹‹poll</h1><h2 id="4-1-å‡½æ•°åŸå‹"><a href="#4-1-å‡½æ•°åŸå‹" class="headerlink" title="4.1 å‡½æ•°åŸå‹"></a>4.1 å‡½æ•°åŸå‹</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦äº†è§£çš„æ˜¯å¦å¤–ä¸€ä¸ªå¤šè·¯è½¬æ¥æ–¹æ¡ˆ, <strong>poll</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds,  <span class="type">nfds_t</span> nfds,  <span class="type">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="4-1-1-å‚æ•°"><a href="#4-1-1-å‚æ•°" class="headerlink" title="4.1.1 å‚æ•°"></a>4.1.1 å‚æ•°</h3><p>è¿™é‡Œçš„å‚æ•°å°±å’Œselectå®Œå…¨ä¸åŒäº†, å‡ºç°äº†å¦å¤–ä¸€ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>   fd;         <span class="comment">/* file descriptor */</span></span><br><span class="line">    <span class="type">short</span> events;     <span class="comment">/* requested events */</span></span><br><span class="line">    <span class="type">short</span> revents;    <span class="comment">/* returned events */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€ä¸ªç»“æ„ä½“åˆ†åˆ«åŒ…å«äº†ä¸‰ä¸ªæˆå‘˜</p><ul><li>æ–‡ä»¶æè¿°ç¬¦fd;</li><li>ç”¨æˆ·å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘çœ‹çš„äº‹ä»¶events;</li><li>å†…æ ¸è¿”å›çš„å°±ç»ªäº‹ä»¶revents;</li></ul><p>ä½†æ˜¯ä»è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸Šçœ‹æ¥, è²Œä¼¼å®ƒæ˜¯ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå…ƒç´ çš„è¾“å…¥è¾“å‡ºå‹å‚æ•°, éš¾é“è¯´pollåªèƒ½ç›‘çœ‹ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å—ï¼ŸğŸ§</p><p>éä¹Ÿ, æˆ‘ä»¬å°†å‡½æ•°åŸå‹æ”¹ä¸€ä¸‹å°±èƒ½çœ‹æ˜ç™½äº†, å®é™…ä¸Š, ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<strong>ç»“æ„ä½“æ•°ç»„</strong>, ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¯¥ç»“æ„ä½“æ•°ç»„çš„<strong>é•¿åº¦</strong>ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd fds[],  <span class="type">nfds_t</span> nfds,  <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰ä¸ªå‚æ•°å’Œselectä¸­çš„timeoutçš„åŠŸèƒ½ç›¸åŒ, å¦‚æœåˆ°è¾¾ä¸€å®šæ—¶é—´è¿˜æ²¡æœ‰è·å–åˆ°å‚æ•°, åˆ™ç›´æ¥è¿”å›;å¦‚æœè®¾ç½®ä¸º<code>-1</code>åˆ™é˜»å¡ç­‰å¾…, è®¾ç½®ä¸º0ä¸ºå®Œå…¨éé˜»å¡ã€‚</p><p>è¿™é‡Œçš„timeoutå¹¶éè¾“å…¥è¾“å‡ºå‹å·å‚æ•°, å…¶åªæ˜¯ä¸€ä¸ªè¾“å…¥å‚æ•°, å•ä½ä¸º<strong>æ¯«ç§’</strong>ï¼ˆè®°ä½, ä¸æ˜¯ç§’, æ˜¯æ¯«ç§’ï¼‰</p><h3 id="4-1-2-è¿”å›å€¼"><a href="#4-1-2-è¿”å›å€¼" class="headerlink" title="4.1.2 è¿”å›å€¼"></a>4.1.2 è¿”å›å€¼</h3><ul><li>å°äº0, å‡ºé”™</li><li>ç­‰äº0, ç­‰å¾…è¶…æ—¶</li><li>å¤§äº0, æ–‡ä»¶æè¿°ç¬¦å·²ç»å°±ç»ªçš„æ•°é‡</li></ul><h3 id="4-1-3-äº‹ä»¶"><a href="#4-1-3-äº‹ä»¶" class="headerlink" title="4.1.3 äº‹ä»¶"></a>4.1.3 äº‹ä»¶</h3><p>è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸‹pollåŒ…å«çš„äº‹ä»¶ç±»å‹äº†, æˆ‘ä»¬éœ€è¦æ ¹æ®ä¸åŒæƒ…å†µæ¥é€‰æ‹©æƒ³è¦çš„äº‹ä»¶, å¹¶è®¾ç½®åˆ°ç»“æ„ä½“çš„<code>event</code>ä¸­;å¯¹äºselect&#x2F;poll&#x2F;epollæ¥è¯´, è¿™äº›socketçš„å°±ç»ªæ¡ä»¶éƒ½æ˜¯ç›¸åŒçš„ã€‚è¯¦è§ <a href="#jump3">3.3 socketå°±ç»ªæ¡ä»¶</a>;</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/748d3a20ba69bb3b3671f5b344cba650.png" alt="img"></p><h2 id="4-2-pollä¼˜ç¼ºç‚¹"><a href="#4-2-pollä¼˜ç¼ºç‚¹" class="headerlink" title="4.2 pollä¼˜ç¼ºç‚¹"></a>4.2 pollä¼˜ç¼ºç‚¹</h2><h3 id="4-2-1-ä¼˜ç‚¹"><a href="#4-2-1-ä¼˜ç‚¹" class="headerlink" title="4.2.1 ä¼˜ç‚¹"></a>4.2.1 ä¼˜ç‚¹</h3><p>åœ¨pollä¸­, ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„æ¥è¡¨ç¤ºéœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦, ä»¥åŠäº‹ä»¶å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦</p><ul><li>å› ä¸ºç»“æ„ä½“ä¸­ç”¨æˆ·éœ€è¦ç›‘å¬çš„eventå’Œå†…æ ¸è¿”å›çš„å°±ç»ªeventå¹¶ä¸åœ¨ä¸€ä¸ªå˜é‡ä¸Š, æ‰€ä»¥åªéœ€è¦è®¾ç½®ä¸€æ¬¡å³å¯ï¼ˆå¦‚æœéœ€æ±‚æ²¡æœ‰å˜åŠ¨çš„è¯ï¼‰, æ— éœ€åƒselectæ¯æ¬¡éƒ½å¾—é‡æ–°éå†æ¥è®¾ç½®ä½å›¾</li><li>pollæ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶</li><li>pollæ— éœ€ç”¨æˆ·é¢å¤–ç»´æŠ¤ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç»„, ç›´æ¥æ²¿ç”¨è¯¥ç»“æ„ä½“æ•°ç»„å³å¯</li></ul><h3 id="4-2-2-ç¼ºç‚¹"><a href="#4-2-2-ç¼ºç‚¹" class="headerlink" title="4.2.2 ç¼ºç‚¹"></a>4.2.2 ç¼ºç‚¹</h3><ul><li>å’Œselectä¸€æ ·, pollä¹Ÿéœ€è¦è½®è¯¢æ£€æµ‹å°±ç»ªçš„fdå’Œç›¸å…³äº‹ä»¶</li><li>æ¯æ¬¡è°ƒç”¨polléœ€è¦æŠŠpollfdç»“æ„ä½“ä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€</li><li>è™½ç„¶pollæ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦é™åˆ¶, ä½†æ˜¯ç›‘çœ‹çš„å¤šäº†åæ€§èƒ½ä¼šçº¿æ€§ä¸‹é™</li></ul><h2 id="4-3-çœ‹çœ‹ç¤ºä¾‹ä»£ç "><a href="#4-3-çœ‹çœ‹ç¤ºä¾‹ä»£ç " class="headerlink" title="4.3 çœ‹çœ‹ç¤ºä¾‹ä»£ç "></a>4.3 çœ‹çœ‹ç¤ºä¾‹ä»£ç </h2><p>pollçš„ä»£ç éƒ¨åˆ†çš„ä¸»æœºç»“æ„å’ŒselectåŸºæœ¬ç›¸åŒï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦æ¥è¯´ä¸€ä¸‹ä¸åŒçš„åœ°æ–¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFL_FD -1</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fdsArray</span>[<span class="title">NUM</span>];</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯å…¨å±€çš„æ•°ç»„ï¼Œè¿™æ—¶å€™ä¸éœ€è¦è‡ªå·±ç»´æŠ¤ä¸€ä¸ªintæ–‡ä»¶æè¿°ç¬¦æ•°ç»„äº†ï¼Œç›´æ¥ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“ä½œä¸ºå…¨å±€æ•°ç»„å°±OKäº†ï¼›åœ¨mainå‡½æ•°é‡Œé¢è¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬å¾—æŠŠæ•´ä¸ªæ•°ç»„çš„fdéƒ½è®¾ç½®æˆé»˜è®¤çš„fdä½œä¸ºæ ‡è¯†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM; i++)</span><br><span class="line">&#123;</span><br><span class="line">    fdsArray[i].fd = DFL_FD;</span><br><span class="line">    fdsArray[i].events = <span class="number">0</span>;</span><br><span class="line">    fdsArray[i].revents = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">fdsArray[<span class="number">0</span>].fd = listensock;</span><br><span class="line">fdsArray[<span class="number">0</span>].events = POLLIN;</span><br></pre></td></tr></table></figure><p>åœ¨mainå‡½æ•°çš„ä¸»å¾ªç¯ä¸­ï¼Œä¹Ÿæ˜¯ç”¨pollæ¥ä¾æ¬¡ç›‘å¬äº‹ä»¶ï¼Œå¹¶åˆ¤æ–­pollå‡½æ•°çš„è¿”å›å€¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> timeout = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n = poll(fdsArray, NUM, timeout);</span><br><span class="line">    <span class="keyword">switch</span> (n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;time out ... : &quot;</span> &lt;&lt; (<span class="type">unsigned</span> <span class="type">long</span>)time(nullptr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">            <span class="built_in">cerr</span> &lt;&lt; errno &lt;&lt; <span class="string">&quot; : &quot;</span> &lt;&lt; strerror(errno) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            HandlerEvent(listensock);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>HandlerEvent</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åˆ¤æ–­ç»“æ„ä½“å†…éƒ¨çš„<code>revent</code>æ¥å¾—çŸ¥æ˜¯å¦æœ‰äº‹ä»¶å°±ç»ª</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fdsArray[i].revents &amp; POLLIN)&#123;&#125; <span class="comment">// è¯»äº‹ä»¶æ˜¯å¦å°±ç»ª</span></span><br></pre></td></tr></table></figure><p>å¯¹äºlistensocketæ¥è¯´ï¼Œå°±ç»ªäº†å°±æ‰§è¡Œacceptï¼›å¹¶å°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°æ•°ç»„ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; NUM; j++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (fdsArray[j].fd == DFL_FD)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡forå¾ªç¯æ‰¾åˆ°å½“å‰ä½ç½®æ˜¯é»˜è®¤çš„ç»“æ„ä½“ä¸‹æ ‡</span></span><br><span class="line"><span class="keyword">if</span> (j == NUM) <span class="comment">// å¦‚æœè¾¾åˆ°ä¸Šé™æ‰break</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">&quot;æˆ‘çš„æœåŠ¡å™¨å·²ç»åˆ°äº†æœ€å¤§çš„ä¸Šé™äº†ï¼Œæ— æ³•åœ¨æ‰¿è½½æ›´å¤šåŒæ—¶ä¿æŒçš„è¿æ¥äº†&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    fdsArray[j].fd = sock; <span class="comment">// å°†sockæ·»åŠ åˆ°æ•°ç»„ä¸­</span></span><br><span class="line">    fdsArray[j].events = POLLIN;</span><br><span class="line">    fdsArray[j].revents = <span class="number">0</span>;</span><br><span class="line">    ShowArray(fdsArray, NUM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå…¶ä»–é“¾æ¥æ¥è¯´ï¼Œå°±ç»ªäº†å°±å¼€å§‹readã€‚å¦‚æœreadå¼‚å¸¸æˆ–è€…å¯¹ç«¯å…³é—­ï¼Œé‚£å°±å°†å¯¹åº”ä½ç½®çš„ç»“æ„ä½“å…¨éƒ¨åˆå§‹åŒ–ï¼ˆæ¸…ç©ºï¼‰ï¼Œç›¸å½“äºå°†è¿™ä¸ªé“¾æ¥ä»ç›‘å¬ä¸­å»æ‰ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fdsArray[i].fd = DFL_FD; </span><br><span class="line">fdsArray[i].events = 0;</span><br><span class="line">fdsArray[i].revents = 0;</span><br></pre></td></tr></table></figure><p>å…¶ä½™çš„æ“ä½œå’Œselectå®Œå…¨ä¸€è‡´ï¼Œåœ¨è¿™é‡Œå°±ä¸å±•ç¤ºä»£ç äº†ï¼</p><h1 id="5-epoll"><a href="#5-epoll" class="headerlink" title="5.epoll"></a>5.epoll</h1><p>manæ‰‹å†Œä¸­æåˆ°, epollæ˜¯ä¸ºäº†å¤„ç†å¤§é‡socketæ–‡ä»¶æè¿°ç¬¦å¥æŸ„è€Œè¿›è¡Œäº†ä¸€å®šæ”¹è¿›çš„poll;</p><h2 id="5-1-æ¥å£"><a href="#5-1-æ¥å£" class="headerlink" title="5.1 æ¥å£"></a>5.1 æ¥å£</h2><p>epollå°±ä¸æ˜¯åªæœ‰ä¸€ä¸ªå‡½æ•°æ¥å£äº†, è€Œæ˜¯æœ‰3ä¸ªç›¸å…³çš„å‡½æ•°ï¼Œä½¿ç”¨è¿‡ç¨‹å°±æ˜¯ä¸‰éƒ¨æ›²ï¼š</p><ul><li>epoll_create åˆ›å»ºepollæ–‡ä»¶å¥æŸ„</li><li>epoll_ctl å°†éœ€è¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ³¨å†Œ</li><li>epoll_wait ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ª</li></ul><h3 id="5-1-1-epoll-create"><a href="#5-1-1-epoll-create" class="headerlink" title="5.1.1 epoll_create"></a>5.1.1 epoll_create</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create1</span><span class="params">(<span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure><p>epollåœ¨ä½¿ç”¨çš„æ—¶å€™, æˆ‘ä»¬éœ€è¦ç”¨createå‡½æ•°åˆ›å»ºä¸€ä¸ªepollçš„å¥æŸ„ï¼ˆæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼‰, æ¥ç®¡ç†å½“å‰è¿›ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿå¸®æˆ‘ä»¬ç›‘çœ‹çš„æ–‡ä»¶æè¿°ç¬¦</p><ul><li>è‡ªä»<code>linux 2.6.8</code> å, è¿™é‡Œçš„sizeå‚æ•°æ˜¯è¢«å¿½ç•¥çš„</li><li>epollçš„å¥æŸ„åœ¨ä½¿ç”¨å®Œæ¯•åä¹Ÿéœ€è¦ç”¨<code>close()</code>å‡½æ•°å…³é—­</li><li>é”™è¯¯çš„æ—¶å€™è¿”å›<code>-1</code>å¹¶è®¾ç½®errno, æ­£ç¡®çš„æ—¶å€™è¿”å›æ–‡ä»¶æè¿°ç¬¦</li></ul><h3 id="5-1-2-epoll-ctl"><a href="#5-1-2-epoll-ctl" class="headerlink" title="5.1.2 epoll_ctl"></a>5.1.2 epoll_ctl</h3><p>è¯¥å‡½æ•°æ˜¯å¯¹epollä¸­éœ€è¦ç›‘çœ‹çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè®¾ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd,  <span class="type">int</span> op,  <span class="type">int</span> fd,  <span class="keyword">struct</span> epoll_event *event)</span>;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>epoll_create</code>çš„è¿”å›å€¼</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯åŠ¨ä½œ, åŒ…å«ä¸‰ä¸ªä¸åŒçš„é€‰é¡¹<ul><li><code>EPOLL_CTL_ADD</code>ï¼šå°†æ–°çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°<code>epfd</code>ä¸­</li><li><code>EPOLL_CTL_MOD</code>ï¼šä¿®æ”¹å·²æœ‰æ–‡ä»¶æè¿°ç¬¦çš„ç›‘å¬äº‹ä»¶</li><li><code>EPOLL_CTL_DEL</code>ï¼šåˆ é™¤å·²æœ‰æ–‡ä»¶æè¿°ç¬¦</li></ul></li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦</li><li>ç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<code>epoll_event</code>ç»“æ„ä½“</li></ul><p>è¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>        *ptr;</span><br><span class="line">    <span class="type">int</span>          fd;</span><br><span class="line">    <span class="type">uint32_t</span>     u32;</span><br><span class="line">    <span class="type">uint64_t</span>     u64;</span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span>     events;      <span class="comment">/* Epoll events */</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data;        <span class="comment">/* User data variable */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="äº‹ä»¶"><a href="#äº‹ä»¶" class="headerlink" title="äº‹ä»¶"></a>äº‹ä»¶</h4><p>äº‹ä»¶<code>events</code>å¯ä»¥æ˜¯ä¸‹é¢çš„è¿™äº›é€‰é¡¹</p><table><thead><tr><th>äº‹ä»¶</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>EPOLLIN</td><td>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯» (åŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­);</td></tr><tr><td>EPOLLOUT</td><td>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™;</td></tr><tr><td>EPOLLPRI</td><td>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯» (è¿™é‡Œåº”è¯¥è¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥);</td></tr><tr><td>EPOLLERR</td><td>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯;</td></tr><tr><td>EPOLLHUP</td><td>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­;</td></tr><tr><td>EPOLLET</td><td>å°†EPOLLè®¾ä¸º<strong>è¾¹ç¼˜è§¦å‘ <strong>(Edge Triggered)æ¨¡å¼, è¿™æ˜¯ç›¸å¯¹äº</strong>æ°´å¹³è§¦å‘</strong>(Level Triggered) æ¥è¯´çš„ï¼›</td></tr><tr><td>EPOLLONESHOT</td><td><strong>åªç›‘å¬ä¸€æ¬¡äº‹ä»¶,</strong> å½“ç›‘å¬å®Œè¿™æ¬¡äº‹ä»¶ä¹‹å, å¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ªsocketçš„è¯, éœ€è¦æ‰‹åŠ¨å†æ¬¡æŠŠè¿™ä¸ªsocketåŠ å…¥åˆ°EPOLLé˜Ÿåˆ—é‡Œï¼›</td></tr></tbody></table><h3 id="5-1-3-epoll-wait"><a href="#5-1-3-epoll-wait" class="headerlink" title="5.1.3 epoll_wait"></a>5.1.3 epoll_wait</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd,  <span class="keyword">struct</span> epoll_event *events, </span></span><br><span class="line"><span class="params">               <span class="type">int</span> maxevents,  <span class="type">int</span> timeout)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_pwait</span><span class="params">(<span class="type">int</span> epfd,  <span class="keyword">struct</span> epoll_event *events, </span></span><br><span class="line"><span class="params">                <span class="type">int</span> maxevents,  <span class="type">int</span> timeout, </span></span><br><span class="line"><span class="params">                <span class="type">const</span> <span class="type">sigset_t</span> *sigmask)</span>;</span><br></pre></td></tr></table></figure><p>æ”¹å‡½æ•°çš„ä½œç”¨æ˜¯æ”¶é›†åœ¨epollç›‘æ§çš„äº‹ä»¶ä¸­ï¼Œå·²ç»å°±ç»ªçš„äº‹ä»¶</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯epollçš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„</li><li>å‚æ•°eventsæ˜¯<code>epoll_events</code>ç»“æ„ä½“æ•°ç»„ï¼Œæ˜¯ä¸€ä¸ªè¾“å‡ºå‹å‚æ•°ã€‚epollä¼šå°†å°±ç»ªçš„äº‹ä»¶èµ‹å€¼åˆ°eventsæ•°ç»„é‡Œé¢ï¼›</li><li>maxevents å‘Šè¯‰å†…æ ¸è¿™ä¸ªeventsçš„å¤§å°ï¼Œå…¶ä¸å¯ä»¥è¶…è¿‡<code>epoll_create</code>çš„sizeï¼›</li><li>å‚æ•°timeoutæ˜¯è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿæ˜¯æ¯«ç§’ï¼ˆ0éé˜»å¡ï¼Œ-1æ°¸ä¹…é˜»å¡ï¼‰</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›IOäº‹ä»¶å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œ0ä»£è¡¨è¶…æ—¶ï¼Œè´Ÿæ•°ä»£è¡¨å¤±è´¥</li></ul><h2 id="5-2-å·¥ä½œåŸç†"><a href="#5-2-å·¥ä½œåŸç†" class="headerlink" title="5.2 å·¥ä½œåŸç†"></a>5.2 å·¥ä½œåŸç†</h2><h3 id="5-2-1-ä»æºç çœ‹æµç¨‹"><a href="#5-2-1-ä»æºç çœ‹æµç¨‹" class="headerlink" title="5.2.1 ä»æºç çœ‹æµç¨‹"></a>5.2.1 ä»æºç çœ‹æµç¨‹</h3><p>æˆ‘ä»¬çŸ¥é“ï¼Œselecté€šè¿‡ä½å›¾æ¥å‘Šè¯‰æ“ä½œç³»ç»Ÿéœ€è¦ç®¡ç†çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œpollé€šè¿‡ç»“æ„ä½“æ•°ç»„æ¥å‘Šè¯‰æ“ä½œç³»ç»Ÿéœ€è¦ç®¡ç†çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ä½†epollé‡Œé¢ï¼Œå´å˜æˆäº†ä¸€ä¸ªepfdæ–‡ä»¶å¥æŸ„ï¼Œæˆ‘ä»¬åªæ˜¯ç»™è¿™ä¸ªç‰¹å®šçš„å¥æŸ„äº¤ä»˜æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™è¯´æ˜åº•å±‚è‚¯å®šéœ€è¦å…¶ä»–çš„æ•°æ®ç»“æ„ï¼Œæ¥ç®¡ç†æŸä¸ªè¿›ç¨‹çš„æŸä¸ªepfdäº¤ä»˜ç»™æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥åŠéœ€è¦ç›‘çœ‹çš„äº‹ä»¶ï¼</p><p>åœ¨<code>Linux 2.6.32.16</code>æºç <code>fs/eventpoll.c</code>ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å¦‚ä¸‹è¿™ä¸ªç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linuxæºç æ–‡ä»¶è·¯å¾„ï¼šfs/eventpoll.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This structure is stored inside the &quot;private_data&quot; member of the file</span></span><br><span class="line"><span class="comment"> * structure and rapresent the main data sructure for the eventpoll</span></span><br><span class="line"><span class="comment"> * interface.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">eventpoll</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Protect the this structure access */</span></span><br><span class="line">	<span class="type">spinlock_t</span> lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This mutex is used to ensure that files are not removed</span></span><br><span class="line"><span class="comment">	 * while epoll is using them. This is held during the event</span></span><br><span class="line"><span class="comment">	 * collection loop, the file cleanup path, the epoll file exit</span></span><br><span class="line"><span class="comment">	 * code and the ctl operations.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mtx</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Wait queue used by sys_epoll_wait() */</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> wq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Wait queue used by file-&gt;poll() */</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> poll_wait;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* List of ready file descriptors */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">rdllist</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* RB tree root used to store monitored fd structs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> <span class="title">rbr</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * This is a single linked list that chains all the &quot;struct epitem&quot; that</span></span><br><span class="line"><span class="comment">	 * happened while transfering ready events to userspace w/out</span></span><br><span class="line"><span class="comment">	 * holding -&gt;lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">epitem</span> *<span class="title">ovflist</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The user that created the eventpoll descriptor */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œé¢ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥çœ‹åˆ°ç†Ÿæ‚‰çš„<code>mutex</code>é”ï¼Œåˆå¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>wait_queue</code>ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸€ä¸ªåŒé“¾è¡¨ï¼Œå’Œä¸€ä¸ª<code>rb_root</code>çº¢é»‘æ ‘èŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;; <span class="comment">// å†…æ ¸ä¸­çš„åŒé“¾è¡¨</span></span><br></pre></td></tr></table></figure><p>æŠ½è±¡å‡ºæ¥ä¹‹åï¼Œå…¶å¤§æ¦‚çš„ç»“æ„å›¾å¦‚ä¸‹</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/6ca5fd02f9838c2ef2d41a014623262d.png" alt="image-20230826160246637"></p><p>å½“æŸä¸€ä¸ªè¿›ç¨‹è°ƒç”¨<code>epoll_create</code>åˆ›å»º<code>epoll</code>çš„æ–‡ä»¶æè¿°ç¬¦å¥æŸ„çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šå¸®æˆ‘ä»¬åœ¨åº•å±‚åˆ›å»ºä¸€ä¸ª<code>struct eventpoll</code>ç»“æ„ä½“ï¼Œå†…éƒ¨åŒ…å«äº†å°±ç»ªé˜Ÿåˆ—å’Œä¸€ä¸ªçº¢é»‘æ ‘ï¼ˆä¸»è¦å…³æ³¨è¿™ä¸¤ä¸ªæˆå‘˜ï¼‰</p><ul><li>è°ƒç”¨<code>epoll_ctl</code>çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šå°†æˆ‘ä»¬é…ç½®çš„æ–‡ä»¶æè¿°ç¬¦å’Œå¯¹äºçš„äº‹ä»¶æ·»åŠ åˆ°çº¢é»‘æ ‘èŠ‚ç‚¹ä¸­ï¼›</li><li>é‡å¤æ·»åŠ çš„äº‹ä»¶ä¹Ÿå¯ä»¥é€šè¿‡çº¢é»‘æ ‘çš„é”®å€¼å”¯ä¸€æ€§æ£€æŸ¥å‡ºæ¥ï¼ˆé¿å…å†—ä½™ï¼‰</li><li>æ‰€æœ‰æ·»åŠ åˆ°epollä¸­çš„äº‹ä»¶éƒ½ä¼šä¸è®¾å¤‡çš„<strong>ç½‘å¡é©±åŠ¨ç¨‹åº</strong>å»ºç«‹å›è°ƒæ¶ˆæ¯ï¼Œå½“æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„é“¾æ¥æœ‰ä¿¡æ¯ä¼ æ¥çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨<strong>å›è°ƒå‡½æ•°</strong>ï¼Œå‘ŠçŸ¥epoll<ul><li>ç½‘å¡æ”¶åˆ°æ¶ˆæ¯</li><li>é©±åŠ¨ç¨‹åºå¤„ç†ï¼Œå¹¶è°ƒç”¨å¯¹åº”çš„å›è°ƒæœºåˆ¶</li><li>epollé€šè¿‡å›è°ƒæ¶ˆæ¯æ”¶åˆ°äº‹ä»¶å°±ç»ªï¼Œå°†å…¶é“¾å…¥<code>rdllist</code>åŒé“¾è¡¨ä¸­</li><li>ä¸Šå±‚åªéœ€è¦è°ƒå›<code>epoll_wait</code>ä»è¯¥åŒé“¾è¡¨ä¸­è·å–å°±ç»ªäº‹ä»¶</li></ul></li><li>è¯¥å›è°ƒåŠæ³•åœ¨åº•å±‚ä¸º<code>ep_poll_callback</code>ï¼Œå®ƒä¼šå°†å°±ç»ªçš„äº‹ä»¶æ’å…¥åˆ°<code>rdllist</code>åŒé“¾è¡¨ä¸­</li><li>epollä¸­æ¯ä¸€ä¸ªäº‹ä»¶éƒ½ä¼šå»ºç«‹ä¸€ä¸ªå¯¹åº”çš„<code>epitem</code>ç»“æ„ä½“</li><li>å½“è°ƒç”¨<code>epoll_wait</code>æœ‰äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œåªéœ€è¦æ£€æŸ¥<code>eventpoll</code>å¯¹è±¡çš„<code>rdllist</code>åŒé“¾è¡¨ä¸­æ˜¯å¦æœ‰<code>epitem</code>å…ƒç´ å³å¯ï¼Œæœ‰åˆ™å–å‡ºï¼›</li><li>å¦‚æœ<code>rdllist</code>ä¸ä¸ºç©ºï¼Œåˆ™å°†å‘ç”Ÿçš„äº‹ä»¶å¤åˆ¶åˆ°ç”¨æˆ·æ€ï¼Œå¹¶å°†äº‹ä»¶æ•°é‡è¿”å›ç»™ç”¨æˆ·ï¼›å¯¹æ¯”éœ€è¦éå†çš„<code>select/poll</code>ï¼Œè¿™ä¸ªè·å–å°±ç»ªäº‹ä»¶çš„<strong>æ—¶é—´å¤æ‚åº¦</strong>æ˜¯<code>O(1)</code>çš„ï¼ˆç›´æ¥åˆ¤æ–­å¹¶å–å‡ºå°±å¯ä»¥äº†ï¼‰</li></ul><p>è¿™ä¸€å¤§åœˆæ“ä½œéƒ½æ˜¯æ“ä½œç³»ç»Ÿè‡ªè¡Œå®Œæˆçš„ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ï¼</p><p>å…³äºepitemç»“æ„ä½“ï¼Œå¯ä»¥ç…ä¸€çœ¼ä¸‹é¢çš„æ³¨é‡Šï¼Œä»–ä¹Ÿæ˜¯åœ¨æºç çš„<code>fs/eventpoll.c</code>æ–‡ä»¶ä¸­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epitem</span> &#123;</span><br><span class="line">	<span class="comment">/* RB tree node used to link this structure to the eventpoll RB tree */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">rb_node</span> rbn; <span class="comment">// è¿™ä¸ªäº‹ä»¶å¯¹åº”çš„çº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* List header used to link this structure to the eventpoll ready list */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">list_head</span> rdllink; <span class="comment">// è¿™ä¸ªäº‹ä»¶å¯¹åº”çš„åŒé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Works together &quot;struct eventpoll&quot;-&gt;ovflist in keeping the</span></span><br><span class="line"><span class="comment">	 * single linked chain of items.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">epitem</span> *next; </span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The file descriptor information this item refers to */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">epoll_filefd</span> ffd; <span class="comment">// äº‹ä»¶å¥æŸ„ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Number of active wait queue attached to poll operations */</span></span><br><span class="line">	<span class="type">int</span> nwait; </span><br><span class="line"></span><br><span class="line">	<span class="comment">/* List containing poll wait queues */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">list_head</span> pwqlist;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The &quot;container&quot; of this item */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">eventpoll</span> *ep; <span class="comment">// æŒ‡å‘å…¶æ‰€å±çš„epolleventå¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* List header used to link this item to the &quot;struct file&quot; items list */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">list_head</span> fllink;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The structure that describe the interested events and the source fd */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">epoll_event</span> event; <span class="comment">// è¯¥fdå…³æ³¨çš„äº‹ä»¶</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="5-2-2-PSHæ ‡è®°ä½"><a href="#5-2-2-PSHæ ‡è®°ä½" class="headerlink" title="5.2.2 PSHæ ‡è®°ä½"></a>5.2.2 PSHæ ‡è®°ä½</h3><p>åœ¨å­¦ä¹ TCPçš„æ—¶å€™ï¼Œæˆ‘ä»¬äº†è§£è¿‡PSHè¿™ä¸ªæ ‡è®°ä½ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘Šè¯‰å¯¹ç«¯çš„åº”ç”¨å±‚ï¼Œå°½å¿«å–èµ°ç¼“å†²åŒºä¸­çš„æ•°æ®ã€‚</p><p>å¯¹äºepollè€Œè¨€ï¼Œè¿™ä¸ªPSHçš„ä½œç”¨å°±æ˜¯è®©epollåœ¨<code>rdllist</code>é‡Œé¢æ–°å»ºä¸€ä¸ªå°±ç»ªèŠ‚ç‚¹ï¼Œè¿™æ ·ä¸Šå±‚å°±èƒ½çŸ¥é“è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªäº†ï¼ˆè‡³äºè¯»ä¸è¯»å–ä¾æ—§æ˜¯ä¸Šå±‚çš„é—®é¢˜ï¼‰</p><ul><li>ä½ å¯èƒ½ä¼šé—®ï¼Œæ—¢ç„¶å¯¹æ–¹éƒ½å‘æ¶ˆæ¯æ¥å‚¬ä½ å–æ•°æ®äº†ï¼Œé‚£ä¸åº”è¯¥ä½ çš„æ•°æ®å¹¶æ²¡æœ‰è¢«å–èµ°å—ï¼Ÿè¿™æ—¶å€™è¯¥æ–‡ä»¶æè¿°ç¬¦çš„å°±ç»ªèŠ‚ç‚¹ä¸åº”è¯¥å·²ç»å­˜åœ¨äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦é¢å¤–åˆ›å»ºä¸€ä¸ªå°±ç»ªäº‹ä»¶çš„èŠ‚ç‚¹æ¥é€šçŸ¥ç”¨æˆ·å‘¢ï¼Ÿ</li></ul><p>è¿™å°±æ¶‰åŠåˆ°epollçš„ä¸¤ç§å·¥ä½œç­–ç•¥LT&#x2F;ETäº†ï¼Œåæ–‡ä¼šè®²è§£ï¼›</p><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œepollå¹¶æ²¡æœ‰å¯¹URGè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œè€Œæ˜¯è§†ä¹‹ä¸ºæ­£å¸¸çš„å¯è¯»äº‹ä»¶è¿å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œä½†æ˜¯äº‹ä»¶ç±»å‹æœ‰æ‰€ä¸åŒï¼Œå¯ä»¥ç”¨<code>EPOLLPRI</code>æ¥å…³æ³¨ç´§æ€¥äº‹ä»¶</p><p>ï¼ˆå­˜ç–‘ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œæš‚ä¸”è¿™ä¹ˆè®¤ä¸ºï¼‰</p></blockquote><h3 id="5-2-3-epollä¼˜ç‚¹"><a href="#5-2-3-epollä¼˜ç‚¹" class="headerlink" title="5.2.3 epollä¼˜ç‚¹"></a>5.2.3 epollä¼˜ç‚¹</h3><p>ä¸€ä¸‹æ˜¯epollç›¸æ¯”pollå’Œselectçš„ä¼˜ç‚¹</p><ul><li>æ¥å£ä½¿ç”¨æ–¹ä¾¿ï¼Œè™½ç„¶æ‹†åˆ†äº†3ä¸ªå‡½æ•°ï¼Œä½†æ˜¯æ¯ä¸ªå‡½æ•°çš„åŠŸèƒ½éå¸¸æ˜ç¡®ï¼›ä¸éœ€è¦æ¯æ¬¡ä½¿ç”¨éƒ½é‡æ–°è®¾ç½®æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå®ç°äº†è¾“å…¥å’Œè¾“å‡ºå‚æ•°çš„åˆ†ç¦»</li><li>æ•°æ®æ‹·è´è½»é‡ï¼šåœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨epoll_ctlæ¥å¤„ç†æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶ï¼Œå¹¶ä¸ä¼šæ¯æ¬¡è°ƒç”¨éƒ½å¾—å¤§æ‰¹é‡åœ¨ç”¨æˆ·å’Œå†…æ ¸æ€ä¹‹é—´æ‹·è´æ•°æ®ï¼ˆpollå’Œselectéƒ½éœ€è¦ï¼‰</li><li>äº‹ä»¶å›è°ƒæœºåˆ¶ï¼šä½¿ç”¨äº‹ä»¶å›è°ƒæ¥æ›¿ä»£éå†ï¼Œå›è°ƒå‡½æ•°å°†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ç»“æ„åŠ å…¥åˆ°å°±ç»ªé˜Ÿåˆ—ä¸­ï¼›<code>epoll_wait</code>ç›´æ¥ä½¿ç”¨å°±ç»ªé˜Ÿåˆ—ï¼Œå°±èƒ½çŸ¥é“é‚£äº›æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼›å³ä¾¿æ–‡ä»¶æè¿°ç¬¦è¾ƒå¤šçš„æ—¶å€™ï¼Œä¹Ÿèƒ½å¿«é€ŸçŸ¥é“å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆçœå»äº†éå†çš„æ—¶é—´æ¶ˆè€—ï¼‰</li><li>æ— ä¸Šé™ï¼šæ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰æ•°é‡é™åˆ¶</li><li>çº¿ç¨‹å®‰å…¨ï¼šåœ¨<code>eventpoll</code>ç»“æ„ä½“é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª<code>mutex</code>é”ï¼Œåœ¨linuxåº•å±‚å·²ç»å¸®æˆ‘ç»´æŠ¤äº†epollç›¸å…³æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ï¼</li></ul><p>åœ¨æœ‰äº›åšå®¢é‡Œé¢è¯´epollä½¿ç”¨äº†<strong>å†…å­˜æ˜ å°„æœºåˆ¶</strong>ï¼Œè¿™ç§è¯´æ³•æ˜¯<strong>é”™è¯¯</strong>çš„ï¼å› ä¸º<code>epoll_event</code>ç»“æ„ä½“æ˜¯åœ¨ç”¨æˆ·æ€åˆ›å»ºçš„ï¼Œæˆ‘ä»¬åŠ¿å¿…è¿˜æ˜¯éœ€è¦è¿›è¡Œä¸€å®šçš„ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ‹·è´ã€‚</p><blockquote><p>å†…å­˜æ˜ å°„æœºåˆ¶ï¼šlinuxå†…æ ¸ç›´æ¥å°†å°±ç»ªé˜Ÿåˆ—é€šè¿‡mmapçš„æ–¹å¼æ˜ å°„åˆ°ç”¨æˆ·æ€ï¼Œé¿å…æ‹·è´æ¶ˆè€—ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºç”¨æˆ·æ€å’Œå†…æ ¸æ€ä¹‹é—´çš„å…±äº«å†…å­˜ï¼‰</p></blockquote><h2 id="5-3-å·¥ä½œæ¨¡å¼"><a href="#5-3-å·¥ä½œæ¨¡å¼" class="headerlink" title="5.3 å·¥ä½œæ¨¡å¼"></a>5.3 å·¥ä½œæ¨¡å¼</h2><p>åœ¨epollçš„å·¥ä½œæ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘ï¼Œè¿™å°±å¥½æ¯”ç‰©ç†å®éªŒä¸­ç¤ºæ³¢å™¨çš„ä¸¤ç§è§¦å‘æ¨¡å¼ï¼›</p><p>å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªtcpé€šä¿¡çš„æ —å­ï¼š</p><ul><li>å¯¹æ–¹ç»™æˆ‘å‘é€äº†2kbæ•°æ®</li><li>æˆ‘é€šè¿‡epoll_waitæˆåŠŸè·å–åˆ°è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„è¯»äº‹ä»¶å°±ç»ª</li><li>æˆ‘å–å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡<code>recv</code>è¯»å–äº†1kbçš„æ•°æ®</li><li>ä½†ç¼“å†²åŒºé‡Œé¢è¿˜æœ‰1kbâ€¦â€¦</li></ul><h3 id="5-3-1-æ°´å¹³è§¦å‘-LT"><a href="#5-3-1-æ°´å¹³è§¦å‘-LT" class="headerlink" title="5.3.1 æ°´å¹³è§¦å‘ LT"></a>5.3.1 æ°´å¹³è§¦å‘ LT</h3><p>æ‰€è°“æ°´å¹³è§¦å‘ï¼Œå°±æ˜¯åªè¦fdçš„ç¼“å­˜åŒºé‡Œé¢æœ‰æ•°æ®ï¼Œé‚£ä¹ˆepollå°±ä¼šä¸€ç›´è®¤ä¸ºè¿™ä¸ªfdçš„è¯»äº‹ä»¶æ˜¯å°±ç»ªçš„ï¼Œå¹¶ä¸€ç›´é€šçŸ¥ç”¨æˆ·ï¼›</p><ul><li>ä¸Šé¢çš„æ —å­ä¸­ï¼Œå› ä¸ºç”¨æˆ·åªæ‹¿èµ°äº†1kbæ•°æ®ï¼Œç¼“å†²åŒºé‡Œé¢è¿˜æœ‰1kbï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨<code>epoll_wait</code>çš„æ—¶å€™ï¼Œepollè¿˜æ˜¯ä¼šæŠ¥å‘Šè¯¥æ–‡ä»¶æè¿°ç¬¦çš„è¯»äº‹ä»¶å°±ç»ªï¼Œè®©ç”¨æˆ·å–èµ°å‰©ä¸‹çš„æ•°æ®</li><li>åªæœ‰æ‰€æœ‰çš„æ•°æ®éƒ½è¢«å¤„ç†å®Œæ¯•ï¼Œepollæ‰ä¸ä¼šç»§ç»­é€šçŸ¥</li><li>LTæ”¯æŒé˜»å¡å’Œéé˜»å¡è¯»å†™</li></ul><p>å› ä¸ºLTæ¨¡å¼åªè¦ç¼“å†²åŒºä¸­è¿˜æœ‰å‰©ä½™æ•°æ®ï¼Œepollå°±ä¼šä¸€ç›´é€šçŸ¥æˆ‘ä»¬ï¼Œè¿™å°±å…è®¸ä¸Šå±‚ä¸éœ€è¦ä¸€æ¬¡æ€§å–èµ°æ‰€æœ‰æ•°æ®ï¼Œæˆ–è€…è¯´ä¸ç«‹åˆ»å¤„ç†å½“å‰ç¼“å†²åŒºçš„æ•°æ®ã€‚</p><p>å› æ­¤ï¼Œåœ¨LTæ¨¡å¼ä¸­ï¼Œåªè¦æ˜¯äº‹ä»¶å°±ç»ªï¼Œé‚£ä¹ˆç¼“å†²åŒºé‡Œé¢ä¸€å®šä¼šæœ‰æ•°æ®ã€‚æ‰€ä»¥å®ƒæ˜¯å³æ”¯æŒé˜»å¡ï¼Œä¹Ÿæ”¯æŒéé˜»å¡çš„æ–‡ä»¶è¯»å†™çš„ï¼</p><blockquote><p>select&#x2F;polléƒ½æ˜¯é»˜è®¤çš„LTæ¨¡å¼ï¼Œä¸”ä¸å¯ä»¥åˆ‡æ¢æ¨¡å¼ï¼›epollé»˜è®¤æ˜¯LTï¼Œä½†å¯ä»¥åˆ‡æ¢åˆ°ET</p></blockquote><h3 id="5-3-2-è¾¹ç¼˜è§¦å‘-ET"><a href="#5-3-2-è¾¹ç¼˜è§¦å‘-ET" class="headerlink" title="5.3.2 è¾¹ç¼˜è§¦å‘ ET"></a>5.3.2 è¾¹ç¼˜è§¦å‘ ET</h3><p>è¾¹ç¼˜è§¦å‘çš„å«ä¹‰ï¼Œæ˜¯åªæœ‰æŸä¸ªæ–‡ä»¶æè¿°ç¬¦çš„æ•°æ®å˜åŠ¨çš„æ—¶å€™ï¼Œæ‰ä¼šé€šçŸ¥ç”¨æˆ·ï¼›ååº”åˆ°è¯»äº‹ä»¶ä¸Šï¼Œåªæœ‰ç¼“å†²åŒºæ•°æ®å¢å¤šäº†ï¼Œæ‰ä¼šé€šçŸ¥ç”¨æˆ·ï¼›</p><ul><li>åœ¨ä¸Šé¢çš„tcpé€šä¿¡æ —å­ä¸­ï¼Œepollä¼šåœ¨æ•°æ®åˆ°æ¥çš„æ—¶å€™é€šçŸ¥ç”¨æˆ·ï¼›ä½†å³ä¾¿ç”¨æˆ·æ²¡æœ‰ä¸€æ¬¡æ€§è¯»å–å®Œæ¯•æ‰€æœ‰æ•°æ®ï¼Œepollå¹¶ä¸ä¼šç»§ç»­é€šçŸ¥äº†ï¼ˆé™¤éæœ‰PSHä¿¡æ¯åˆ°æ¥ï¼‰</li><li>åœ¨ETæ¨¡å¼ä¸‹ï¼Œæ–‡ä»¶æè¿°ç¬¦çš„äº‹ä»¶å°±ç»ªåï¼Œåªæœ‰ä¸€æ¬¡å¤„ç†æœºä¼šã€‚ç¬¬äºŒæ¬¡ä½ å°±æ— æ³•å¾—çŸ¥è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šæ˜¯å¦è¿˜æœ‰æ²¡æœ‰è¯»å®Œçš„æ•°æ®äº†</li><li>å› ä¸ºETæ¨¡å¼ä¸‹<code>epoll_wait</code>è¿”å›çš„æ¬¡æ•°æ›´å°‘ï¼Œæ‰€ä»¥ETçš„æ€§èƒ½è¿œé«˜äºLTï¼ˆnginxé»˜è®¤é‡‡ç”¨ETæ¨¡å¼çš„epollï¼‰</li><li>å› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€æ¬¡æœºä¼šï¼Œæ‰€ä»¥æ”¶åˆ°äº‹ä»¶åå¿…é¡»ç«‹å³å¤„ç†</li><li>åªæ”¯æŒéé˜»å¡</li></ul><h3 id="5-3-3-LTå’ŒETçš„åŒºåˆ«"><a href="#5-3-3-LTå’ŒETçš„åŒºåˆ«" class="headerlink" title="5.3.3 LTå’ŒETçš„åŒºåˆ«"></a>5.3.3 LTå’ŒETçš„åŒºåˆ«</h3><p>å› ä¸ºETæ¨¡å¼ä¸‹ï¼Œepollåªä¼šæç¤ºä½ ä¸€æ¬¡äº‹ä»¶å°±ç»ªï¼Œæ‰€ä»¥å°±å€’é€¼ç¨‹åºçŒ¿åœ¨æ”¶åˆ°è¿™ä¸ªäº‹ä»¶ä¹‹åï¼Œä¸€æ¬¡æ€§å¤„ç†å®Œæ•°æ®ï¼›</p><p>å½“ç„¶ï¼ŒLTæ¨¡å¼ä¸‹ä½ ä¹Ÿå¯ä»¥è¿™ä¹ˆåšï¼ˆå¦‚æœæ¯æ¬¡éƒ½èƒ½ä¸€æ¬¡æ€§å–èµ°æ•°æ®ï¼Œé‚£ä¹ˆLTå’ŒETçš„æ€§èƒ½å·®è·å°±ä¸å¤§äº†ï¼‰ã€‚ä½†ETæ¨¡å¼å°±ç›¸å½“äºå‘Šè¯‰æ‰€æœ‰ä½¿ç”¨è€…ï¼Œå¿…é¡»è¿™ä¹ˆåšï¼Œå‡å°‘äº†å®¹é”™ç‡ï¼›</p><p>ä½†ETçš„ä»£ç å¤æ‚åº¦ä¼šå¢åŠ ï¼›</p><h3 id="5-3-4-ETå’Œéé˜»å¡"><a href="#5-3-4-ETå’Œéé˜»å¡" class="headerlink" title="5.3.4 ETå’Œéé˜»å¡"></a>5.3.4 ETå’Œéé˜»å¡</h3><p>ä¸ºä»€ä¹ˆETå¿…é¡»è¦å°†æ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆéé˜»å¡å‘¢ï¼Ÿ</p><p>å‡è®¾ä¸‹é¢è¿™ä¸ªåœºæ™¯ï¼Œå®¢æˆ·ç«¯Cç»™æœåŠ¡ç«¯Så‘é€10kbæ•°æ®ï¼Œåœ¨æ²¡æœ‰æ”¶åˆ°æœåŠ¡ç«¯å¯¹è¿™ä¸ªæ•°æ®çš„å“åº”ä¹‹å‰ï¼Œä¸ä¼šç»§ç»­å‘é€æ•°æ®ï¼›</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/1320c1d24627c05783f4d64dc6f43f21.png" alt="image-20230826180800176"></p><p>ä½†æœåŠ¡å™¨ä¸€æ¬¡æ€§åªè¯»å–äº†1KBï¼Œå‰©ä¸‹äº†9KBæ•°æ®åœ¨ç¼“å†²åŒºä¸­ï¼›å› ä¸ºæ•°æ®æ²¡æœ‰è¯»å®Œï¼Œæ‰€ä»¥ä¸ä¼šç»™å®¢æˆ·ç«¯å‘é€å“åº”ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/42b5a34b96663a7b0314afd41e325896.png" alt="image-20230826180840435"></p><p>å› ä¸ºepollè®¾ç½®äº†ETæ¨¡å¼ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šè®¤ä¸ºæ­¤æ—¶çš„æ–‡ä»¶æè¿°ç¬¦è¯»å°±ç»ªï¼›<code>epoll_wait</code>ä¸ä¼šé’ˆå¯¹è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿”å›ï¼Œå‰©ä¸‹çš„9KBæ•°æ®ä¼šä¸€ç›´ç•™åœ¨ç¼“å†²åŒºä¸­ï¼›</p><ul><li>æ³¨æ„ï¼ŒæœåŠ¡ç«¯çš„ä»£ç é€»è¾‘æ˜¯æ”¶åˆ°å°±ç»ªäº‹ä»¶å°±è¯»å–ä¸€æ¬¡ï¼›å¹¶ä¸å­˜åœ¨å†æ¬¡è¯»å–çš„å¯èƒ½</li></ul><p>é—®é¢˜å°±æ¥äº†ï¼</p><ul><li>æœåŠ¡ç«¯å¿…é¡»è¦æ”¶åˆ°å°±ç»ªäº‹ä»¶æ‰ä¼šæŠŠå‰©ä¸‹çš„9kbæ•°æ®ç»™è¯»å–å®Œæ¯•</li><li>æœåŠ¡ç«¯æƒ³è¦æ”¶åˆ°å°±ç»ªäº‹ä»¶ï¼Œå°±å¿…é¡»æ”¶åˆ°å®¢æˆ·ç«¯Cå‘æ¥çš„æ–°æ•°æ®</li><li>ä½†å®¢æˆ·ç«¯Cè®¤ä¸ºæœåŠ¡å™¨æ²¡æœ‰ç»™è‡ªå·±å‘é€å“åº”ï¼Œä¸ä¼šç»§ç»­å‘é€æ•°æ®</li></ul><p>è¿™å°±ç›¸å½“äºä¸€ä¸ªæ­»å¾ªç¯äº†ï¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/be296238e7cd395dabf1599602a8b193.png" alt="image-20230826181214987"></p><p>å› æ­¤ï¼ŒæœåŠ¡ç«¯ä¸ºäº†ä¿è¯ä¸€æ¬¡æ€§èƒ½å°†æ•°æ®å…¨éƒ¨å–å‡ºï¼Œå¿…é¡»è¦é‡‡ç”¨å¾ªç¯è¯»å–+éé˜»å¡çš„æ–¹å¼æ¥å°†ç¼“å†²åŒºè¯»å®Œï¼</p><p>å¦‚æœé‡‡ç”¨é˜»å¡å¼ï¼Œé‚£ä¹ˆåœ¨è½®è¯¢è¯»å–çš„æ—¶å€™ï¼Œå°±æœ‰å¯èƒ½å› ä¸ºç¼“å†²åŒºå·²ç»ç©ºäº†è€Œé˜»å¡ï¼å› ä¸ºæˆ‘ä»¬è¿™ä¸ªæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ¨¡å‹ï¼Œè¿™æ ·ä¼šç›´æ¥å¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨å®•æœºäº†ã€‚</p><p>è€ŒLTåˆ™ä¸ä¼šå‡ºç°æ­¤é—®é¢˜ï¼Œå› ä¸ºåªè¦ç¼“å†²åŒºä¸­æœ‰æ•°æ®å°±ä¼šé€šçŸ¥ä½ ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡è¯»å–å®šé•¿ï¼Œå†å°†è¯»åˆ°çš„æ•°æ®æ‹¼æ¥èµ·æ¥ã€‚</p><h3 id="5-3-5-epollçš„ä½¿ç”¨åœºæ™¯"><a href="#5-3-5-epollçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="5.3.5 epollçš„ä½¿ç”¨åœºæ™¯"></a>5.3.5 epollçš„ä½¿ç”¨åœºæ™¯</h3><p>epollçš„é«˜æ€§èƒ½æ˜¯æœ‰ä¸€å®šç‰¹æ®Šåœºæ™¯çš„ï¼Œå¦‚æœåœºæ™¯ä¸é€‚åˆï¼Œepollçš„æ€§èƒ½å¯èƒ½è¡¨ç°ä¸ä½³ï¼›</p><ul><li>å¯¹äºå¤šé“¾æ¥ä¸”é“¾æ¥ä¸­æœ‰ä¸€éƒ¨åˆ†æ´»è·ƒçš„æ—¶å€™ï¼Œé€‚åˆä½¿ç”¨epoll</li></ul><p>æ¯”å¦‚å„ç§äº’è”ç½‘APPçš„å…¥å£æœåŠ¡å™¨ï¼Œå°±å¾ˆé€‚åˆä½¿ç”¨epollæ¥å¤„ç†ä¸Šä¸‡å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼›</p><p>å¦‚æœæ˜¯ç³»ç»Ÿå†…éƒ¨å¤„ç†æœåŠ¡å™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œé“¾æ¥æ•°è¾ƒå°‘çš„æƒ…å†µï¼Œè¿™ç§æ—¶å€™ä½¿ç”¨epollå¹¶ä¸æ–¹ä¾¿ã€‚å¾—æ ¹æ®å…·ä½“éœ€è¦é€‰æ‹©æ›´åŠ é€‚åˆçš„IOæ¨¡å‹ã€‚</p><h2 id="5-4-æƒŠç¾¤æ•ˆåº”"><a href="#5-4-æƒŠç¾¤æ•ˆåº”" class="headerlink" title="5.4 æƒŠç¾¤æ•ˆåº”"></a>5.4 æƒŠç¾¤æ•ˆåº”</h2><blockquote><p>å‚è€ƒ <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/359774959">https://zhuanlan.zhihu.com/p/359774959</a></p></blockquote><h3 id="5-4-1-æ¦‚å¿µ"><a href="#5-4-1-æ¦‚å¿µ" class="headerlink" title="5.4.1 æ¦‚å¿µ"></a>5.4.1 æ¦‚å¿µ</h3><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°epollçš„æƒŠç¾¤æ•ˆåº”ï¼›</p><ul><li>é‚£ä¹ˆä»€ä¹ˆæ˜¯æƒŠç¾¤æ•ˆåº”å‘¢ã€‚å…¶äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</li></ul><p>æƒŠç¾¤æ•ˆåº”çš„å…·ä½“æƒ…å†µæ˜¯ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹åœ¨ epoll ä¸Šç­‰å¾…æŸä¸ªäº‹ä»¶ï¼ˆå¦‚å¥—æ¥å­—å¯è¯»äº‹ä»¶ï¼‰ï¼Œå½“è¯¥äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹æˆ–è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ã€‚ç„¶è€Œï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹å¯ä»¥æˆåŠŸåœ°å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œè€Œå…¶ä»–çš„çº¿ç¨‹æˆ–è¿›ç¨‹ä¼šè¿›è¡Œä¸å¿…è¦çš„ç«äº‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´é¢å¤–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€é”ç«äº‰ç­‰é—®é¢˜ï¼Œä»è€Œé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</p><ul><li>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…·ä½“åœºæ™¯çš„è¯´æ˜</li></ul><p>åœ¨å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹ç¯å¢ƒä¸‹ï¼Œæœ‰äº›äººä¸ºäº†æé«˜ç¨‹åºçš„ç¨³å®šæ€§ï¼Œå¾€å¾€ä¼šè®©<strong>å¤šä¸ªçº¿ç¨‹</strong>æˆ–è€…<strong>å¤šä¸ªè¿›ç¨‹</strong>åŒæ—¶åœ¨<code>epoll_wait</code>ç›‘å¬çš„socketæè¿°ç¬¦ã€‚å½“ä¸€ä¸ªæ–°çš„é“¾æ¥è¯·æ±‚è¿›æ¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿ<strong>ä¸çŸ¥é“</strong>é€‰æ´¾é‚£ä¸ªçº¿ç¨‹æˆ–è€…è¿›ç¨‹å¤„ç†æ­¤äº‹ä»¶ï¼Œåˆ™å¹²è„†å°†å…¶ä¸­<strong>å‡ ä¸ªçº¿ç¨‹</strong>æˆ–è€…è¿›ç¨‹ç»™å”¤é†’ï¼Œè€Œå®é™…ä¸Šåªæœ‰å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹èƒ½å¤ŸæˆåŠŸå¤„ç†acceptäº‹ä»¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½å°†å¤±è´¥ï¼Œä¸”errnoé”™è¯¯ç ä¸º<code>EAGAIN</code>ã€‚è¿™ç§ç°è±¡ç§°ä¸ºæƒŠç¾¤æ•ˆåº”ã€‚</p><p>ç»“æœæ˜¯è‚¯å®šçš„ï¼ŒæƒŠç¾¤æ•ˆåº”è‚¯å®šä¼šå¸¦æ¥èµ„æºçš„æ¶ˆè€—å’Œæ€§èƒ½çš„å½±å“ï¼Œå› ä¸ºä½ æ— ç«¯åœ°å¤šå”¤é†’äº†å‡ ä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹&#x2F;è¿›ç¨‹å´æ²¡æœ‰æ´»å¹²ã€‚</p><h3 id="5-4-2-å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è§£å†³åŠæ³•"><a href="#5-4-2-å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è§£å†³åŠæ³•" class="headerlink" title="5.4.2 å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è§£å†³åŠæ³•"></a>5.4.2 å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è§£å†³åŠæ³•</h3><ul><li>ä¸“é—¨çš„çº¿ç¨‹è´Ÿè´£ç­‰å¾…ï¼šåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä¸å»ºè®®è®©å¤šä¸ªçº¿ç¨‹è¿›è¡Œ<code>epoll_wait</code>ï¼Œè€Œç”¨å•ä¸ªçº¿ç¨‹è¿›è¡Œwaitï¼Œå¹¶ç”±è¯¥çº¿ç¨‹è°ƒç”¨<code>accept</code>å»ºç«‹æ–°é“¾æ¥ï¼Œå¹¶å°†å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦äº¤ä»˜ç»™å…¶ä»–çº¿ç¨‹ï¼Œæ¥å¤„ç†åç»­çš„è¯»å†™æ“ä½œã€‚</li><li>ä½¿ç”¨çº¿ç¨‹æ± ï¼šä¸ä¸ºæ¯ä¸ªé“¾æ¥éƒ½åˆ›ç«‹ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹ï¼Œè€Œæ˜¯æ ¹æ®è¯»å†™äº‹ä»¶ï¼Œå°†å…¶äº¤ä»˜ç»™çº¿ç¨‹æ± ä¸­å·²æœ‰çº¿ç¨‹æ¥å¤„ç†ï¼›</li><li>ä½¿ç”¨ETæ¨¡å¼ï¼šè¯¥æ¨¡å¼ä¸‹è¯»å†™å°±ç»ªçš„æ—¶å€™åªä¼šé€šçŸ¥ä¸€æ¬¡ï¼Œå†åŠ ä¸Šepollæœ¬èº«æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‹¿åˆ°è¿™ä¸ªå°±ç»ªäº‹ä»¶ï¼Œä»è€Œé¿å…æƒŠç¾¤ç°è±¡ï¼›</li><li>äº’æ–¥é”ï¼šåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç­‰å¾…å’Œäº‹ä»¶å¤„ç†ï¼›</li></ul><h3 id="5-4-3-å¤šè¿›ç¨‹ä¸‹è§£å†³åŠæ³•"><a href="#5-4-3-å¤šè¿›ç¨‹ä¸‹è§£å†³åŠæ³•" class="headerlink" title="5.4.3 å¤šè¿›ç¨‹ä¸‹è§£å†³åŠæ³•"></a>5.4.3 å¤šè¿›ç¨‹ä¸‹è§£å†³åŠæ³•</h3><p>ç›®å‰å¾ˆå¤šå¼€æºè½¯ä»¶ï¼Œå¦‚lighttpdå’Œnginxç­‰éƒ½é‡‡ç”¨<code>master/workers</code>çš„æ¨¡å¼æé«˜è½¯ä»¶çš„ååèƒ½åŠ›åŠå¹¶å‘èƒ½åŠ›ï¼Œåœ¨nginxä¸­ç”šè‡³è¿˜é‡‡ç”¨äº†<strong>è´Ÿè½½å‡è¡¡</strong>çš„æŠ€æœ¯ï¼Œåœ¨æŸä¸ªå­è¿›ç¨‹çš„å¤„ç†èƒ½åŠ›è¾¾åˆ°ä¸€å®šè´Ÿè½½ä¹‹åï¼Œç”±å…¶ä»–<strong>è´Ÿè½½è¾ƒè½»çš„å­è¿›ç¨‹</strong>è´Ÿè´£Â·çš„è°ƒç”¨ï¼Œé‚£ä¹ˆnginxå’ŒLighttpdæ˜¯å¦‚ä½•é¿å…<code>epoll_wait</code>çš„æƒŠç¾¤æ•ˆç”¨çš„å‘¢ï¼Ÿ</p><ul><li>lighttpdçš„è§£å†³æ€è·¯æ˜¯<strong>æ— è§†</strong>æƒŠç¾¤æ•ˆåº”</li></ul><p>ä»ç„¶é‡‡ç”¨<code>master/workers</code>æ¨¡å¼ï¼Œæ¯ä¸ªå­è¿›ç¨‹ä»ç„¶è‡ªå·±åœ¨ç›‘å¬çš„socketä¸Šè°ƒç”¨<code>epoll_wait</code>ï¼Œå½“æœ‰æ–°çš„é“¾æ¥è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œæ“ä½œç³»ç»Ÿä»ç„¶åªæ˜¯å”¤é†’å…¶ä¸­éƒ¨åˆ†çš„å­è¿›ç¨‹æ¥å¤„ç†è¯¥äº‹ä»¶ï¼Œä»ç„¶åªæœ‰ä¸€ä¸ªå­è¿›ç¨‹èƒ½å¤ŸæˆåŠŸå¤„ç†æ­¤äº‹ä»¶ï¼Œé‚£ä¹ˆå…¶ä»–è¢«æƒŠé†’çš„å­è¿›ç¨‹æ•è·<code>EAGAIN</code>é”™è¯¯ï¼Œå¹¶æ— è§†ã€‚</p><ul><li>nginxçš„è§£å†³æ€è·¯æ˜¯äº’æ–¥é”</li></ul><p>åœ¨åŒä¸€æ—¶åˆ»ï¼Œ<strong>æ°¸è¿œéƒ½åªæœ‰ä¸€ä¸ª</strong>å­è¿›ç¨‹åœ¨ç›‘å¬çš„socketä¸Š<code>epoll_wait</code>ï¼Œå…¶åšæ³•æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªå…¨å±€çš„<code>pthread_mutex_t</code>ï¼Œåœ¨å­è¿›ç¨‹è¿›è¡Œ<code>epoll_wait</code>å‰ï¼Œåˆ™å…ˆè·å–é”ã€‚å½“<code>epoll_wait</code>è¿”å›ä¹‹åï¼Œnginxä¼šè°ƒç”¨acceptæŠŠè¿æ¥å–å‡ºæ¥ï¼Œç„¶åé‡Šæ”¾æ–‡ä»¶é”ï¼Œè®©åˆ«çš„è¿›ç¨‹å»ç›‘å¬ã€‚</p><p>è¿™æ˜¯ä¸€ç§æŠ˜è¡·çš„åŠæ³•ï¼Œå¹¶æ²¡æœ‰å¾ˆå®Œç¾ï¼Œé¦–å…ˆè¿›ç¨‹é—´<strong>äº‰æŠ¢é”</strong>ä¼šæœ‰æ€§èƒ½å¼€è€—ï¼ˆå³ä½¿æ˜¯éé˜»å¡çš„é”ï¼‰ï¼Œä¸­é—´å¯èƒ½ä¼šæœ‰å°æ®µæ—¶é—´æ²¡æœ‰è¿›ç¨‹å»è·å–é”ï¼Œæ¯”å¦‚Aè¿›ç¨‹æ‹¿åˆ°é”ï¼Œå…¶ä»–è¿›ç¨‹å°†ä¼šè¿‡ä¸€å°æ®µæ—¶é—´å°è¯•å†å»è·å–é”ï¼Œè€Œè¿™å°æ®µæ—¶é—´é‡Œé¢å¦‚æœè¯·æ±‚é‡å¾ˆå¤§ï¼ŒAä»…æ¥å—ä¸€å°éƒ¨åˆ†è¯·æ±‚å°±è®©å‡ºé”ï¼Œåˆ™ä¸­é—´è¿‡ç¨‹ä¼šæœ‰ä¸€äº›è¿æ¥äº‹ä»¶è¢«hangä½ï¼›</p><h3 id="5-4-4-å†…æ ¸è§£å†³äº†æƒŠç¾¤æ•ˆåº”äº†å—"><a href="#5-4-4-å†…æ ¸è§£å†³äº†æƒŠç¾¤æ•ˆåº”äº†å—" class="headerlink" title="5.4.4 å†…æ ¸è§£å†³äº†æƒŠç¾¤æ•ˆåº”äº†å—"></a>5.4.4 å†…æ ¸è§£å†³äº†æƒŠç¾¤æ•ˆåº”äº†å—</h3><p>æƒŠç¾¤çš„æ ¹æœ¬åŸå› åœ¨äºepollçš„é»˜è®¤è¡Œä¸ºæ˜¯å¯¹äº<strong>å¤šè¿›ç¨‹ç›‘å¬åŒä¸€æ–‡ä»¶ä¸ä¼šè®¾ç½®äº’æ–¥</strong>ï¼Œè¿›è€Œå°†æ‰€æœ‰è¿›ç¨‹å”¤é†’ï¼Œåç»­çš„å†…æ ¸ç‰ˆæœ¬ä¸»è¦æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆ</p><ol><li>æ—¢ç„¶é»˜è®¤ä¸ä¼šè®¾ç½®äº’æ–¥ï¼Œé‚£å°±åŠ ä¸€ä¸ªäº’æ–¥åŠŸèƒ½å¥½äº†ï¼Œ<code>linux 4.5</code>å†…æ ¸ä¹‹åç»™epollæ·»åŠ äº†ä¸€ä¸ª<code>EPOLLEXCLUSIVE</code>çš„æ ‡å¿—ä½ï¼Œå¦‚æœè®¾ç½®äº†è¿™ä¸ªæ ‡å¿—ä½ï¼Œé‚£epollå°†è¿›ç¨‹æŒ‚åˆ°ç­‰å¾…é˜Ÿåˆ—æ—¶å°†ä¼šè®¾ç½®ä¸€ä¸‹äº’æ–¥æ ‡å¿—ä½ï¼Œè¿™æ—¶å®ç°è·Ÿå†…æ ¸åŸç”Ÿacceptä¸€æ ·çš„ç‰¹æ€§ï¼Œåªä¼šå”¤é†’é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªè¿›ç¨‹</li><li>ç¬¬äºŒç§æ–¹æ³•ï¼š<code>linux 3.9</code>å†…æ ¸ä¹‹åç»™socketæä¾›<code>SO_REUSEPORT</code>æ ‡å¿—ï¼Œè¿™ç§æ–¹å¼è§£å†³å¾—æ›´å½»åº•ï¼Œä»–å…è®¸ä¸åŒè¿›ç¨‹çš„socketç»‘å®šåˆ°åŒä¸€ä¸ªç«¯å£ï¼Œå–ä»£ä»¥å¾€éœ€è¦å­è¿›ç¨‹å…±äº«socketç›‘å¬çš„æ–¹å¼ï¼Œè¿™æ—¶å€™ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ç›‘å¬socketå°†æŒ‡å‘<code>open_file_tables</code>ä¸‹çš„ä¸åŒèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒè¿›ç¨‹æ˜¯åœ¨è‡ªå·±çš„è®¾å¤‡ç­‰å¾…é˜Ÿåˆ—ä¸‹è¢«æŒ‚èµ·çš„ï¼Œä¸å­˜åœ¨å…±äº«fdçš„é—®é¢˜ï¼Œä¹Ÿå°±ä¸å­˜åœ¨è¢«åŒæ—¶å”¤é†’çš„å¯èƒ½ã€‚è€Œå†…æ ¸åˆ™åœ¨é©±åŠ¨ä¸­å°†è®¾ç½®äº†<code>SO_REUSEPORT</code>å¹¶ä¸”ç»‘å®šåŒä¸€ç«¯å£çš„è¿™äº›socketåˆ†åˆ°åŒä¸€ä¸ªgroupä¸­ï¼Œå½“æœ‰tcpè¿æ¥äº‹ä»¶åˆ°è¾¾çš„æ—¶å€™ï¼Œå†…æ ¸å°†ä¼šå¯¹æº<code>IP+æºç«¯å£</code>å–hashç„¶åæŒ‡å®šè¿™ä¸ªgroupä¸­å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹æ¥æ¥å—è¿æ¥ï¼Œç›¸å½“äºåœ¨å†…æ ¸çº§åˆ«ä¸­å®ç°äº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡</li></ol><p>åŸºäºä»¥ä¸Šä¸¤ç§æ–¹æ³•ï¼Œå…¶å®epollç”Ÿæ€åœ¨ç›®å‰æ¥è¯´ä¸å­˜åœ¨æ‰€è°“çš„æƒŠç¾¤æ•ˆåº”äº†ã€‚è€Œæ–°ç‰ˆæœ¬çš„nginxä¹Ÿé‡‡ç”¨äº† <code>SO_REUSEPORT</code>æ¥è§£å†³æ­¤é—®é¢˜ã€‚</p><p>é™¤éä½ æº¢ç”¨epollï¼Œæ¯”å¦‚å¤šè¿›ç¨‹ä¹‹é—´å…±äº«äº†åŒä¸€ä¸ªepfdï¼ˆçˆ¶è¿›ç¨‹åˆ›å»ºepollç”±å¤šä¸ªå­è¿›ç¨‹æ¥è°ƒç”¨ï¼‰ï¼Œé‚£å°±ä¸èƒ½æ€ªepolläº†ï¼Œå› ä¸ºè¿™æ—¶å€™å¤šä¸ªè¿›ç¨‹éƒ½è¢«æŒ‚åˆ°è¿™ä¸ªepollä¸‹ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå·²ç»ä¸æ˜¯ä»…ä»…æ˜¯æƒŠç¾¤æ•ˆåº”çš„é—®é¢˜äº†ï¼›æ¯”å¦‚è¯´ï¼ŒAè¿›ç¨‹åœ¨epollæŒ‚äº†socket1çš„è¿æ¥äº‹ä»¶ï¼ŒBè¿›ç¨‹è°ƒç”¨äº†epoll_waitï¼Œç”±äºå±äºåŒä¸€ä¸ªepfdï¼Œå½“socket1äº§ç”Ÿäº‹ä»¶çš„æ—¶å€™ï¼Œè¿›ç¨‹Bä¹Ÿä¼šè¢«å”¤é†’ï¼Œè€Œæ›´ä¸¥é‡çš„äº‹æƒ…åœ¨äºï¼Œåœ¨Bè¿›ç¨‹çš„ç©ºé—´ä¸‹å¹¶ä¸å­˜åœ¨socket1è¿™ä¸ªfdï¼Œä»è€ŒæŠŠé—®é¢˜æå¾—å¾ˆå¤æ‚ã€‚</p><p>æ€»ç»“ï¼šåƒä¸‡ä¸è¦åœ¨å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹ä¹‹é—´å…±äº«epfdï¼</p><h1 id="6-Reactoræ¨¡å‹"><a href="#6-Reactoræ¨¡å‹" class="headerlink" title="6.Reactoræ¨¡å‹"></a>6.Reactoræ¨¡å‹</h1><p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬æ¥ç”¨epollç¼–å†™ä¸€ä¸ªåŸºäºReactoræ¨¡å¼çš„æœåŠ¡å™¨å§ï¼</p><h2 id="6-1-ä»€ä¹ˆæ˜¯Reactorï¼Ÿ"><a href="#6-1-ä»€ä¹ˆæ˜¯Reactorï¼Ÿ" class="headerlink" title="6.1 ä»€ä¹ˆæ˜¯Reactorï¼Ÿ"></a>6.1 ä»€ä¹ˆæ˜¯Reactorï¼Ÿ</h2><ul><li>Reactoræ¨¡å‹æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ï¼Œé€šè¿‡ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¾“å…¥åŒæ—¶ä¼ é€’ç»™æœåŠ¡ç«¯è¿›è¡Œå¤„ç†</li><li>æœåŠ¡ç«¯è¯·æ±‚ç¨‹åºå¤„ç†ä¼ å…¥çš„å¤šä¸ªè¯·æ±‚ï¼Œå¹¶åˆ†å‘åˆ°ç›¸åº”çš„å¤„ç†çº¿ç¨‹</li><li>åŸºäºIOå¤šè·¯è½¬æ¥ï¼ˆå¤šè·¯å¤ç”¨ï¼‰æ¨¡å‹ï¼šå¤šä¸ªé“¾æ¥é€šç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ï¼Œå¼•ç”¨ç¨‹åºåªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ç­‰å¾…ï¼Œæ— éœ€é˜»å¡ç­‰å¾…æ‰€æœ‰é“¾æ¥ï¼›å½“æœ‰æ–°é“¾æ¥æˆ–è€…äº‹ä»¶å°±ç»ªçš„æ—¶å€™ï¼Œç”±æ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨ç¨‹åºï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†</li><li>åŸºäºçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹èµ„æºï¼šä¸å¿…ç»™æ¯ä¸ªé“¾æ¥å•ç‹¬åˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯å°†é“¾æ¥å®Œæˆåçš„ä¸šåŠ¡å¤„ç†äº¤ä»˜ç»™å·²æœ‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œä¸€ä¸ªçº¿ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥å¤„ç†å¤šä¸ªé“¾æ¥çš„ä¸šåŠ¡ã€‚</li></ul><p>reactoræ¨¡å¼æœ‰ä¸‹é¢3ç§æ–¹å¼ï¼Œ<a target="_blank" rel="noopener" href="https://blog.csdn.net/wlddhj/article/details/123872275">å‚è€ƒåšå®¢ @é¡½çŸ³ä¹å˜</a></p><h3 id="6-1-1-ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹"><a href="#6-1-1-ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="6.1.1 ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹"></a>6.1.1 ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</h3><p>ç¬¬ä¸€ç§æ˜¯å¤šçº¿ç¨‹æ¨¡å¼çš„ï¼Œæœ‰ä¸åŒçš„ä»å±reactoræ¥è¿›è¡Œäº‹ä»¶ç›‘æ§å’Œå¤„ç†</p><ul><li>Reactorä¸»çº¿ç¨‹è´Ÿè´£ç›‘å¬äº‹ä»¶å¹¶è¿›è¡Œé“¾æ¥çš„accept</li><li>accpetè·å–åˆ°é“¾æ¥åï¼Œåˆ†é…ç»™æŸä¸€ä¸ªä»Reactorè¿›è¡Œè¯»å†™äº‹ä»¶çš„ç›‘å¬</li><li>ä»Reactorè¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œå½“æœ‰æ–°äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œåˆ›å»ºHandlerè¿›è¡Œäº‹ä»¶å¤„ç†</li><li>Headleré€šè¿‡readè¯»å–æ•°æ®ï¼Œå¹¶å¤„ç†æ•°æ®ï¼ˆè¿™é‡Œè¿˜å¯ä»¥å°†è¯»å–æ•°æ®åçš„å“åº”æ“ä½œåˆ†å‘ç»™çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œçº¿ç¨‹æ± å¤„ç†å®Œæ¯•åè¿”å›ç»™Handlerï¼‰ï¼Œé€šè¿‡sendè¿”å›ç»™å®¢æˆ·ç«¯</li><li>Reactorä¸»çº¿ç¨‹å¯ä»¥å¯¹åº”å¤šä¸ªå­çº¿ç¨‹</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/9b1f1f0aec63e52ed44fca99f18d6e5a.png" alt="image-20230828085218401"></p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/ecdd89978c73b286f89f29703c620c7e.png" alt="img"></p><h3 id="6-1-2-å•Reactorå¤šçº¿ç¨‹"><a href="#6-1-2-å•Reactorå¤šçº¿ç¨‹" class="headerlink" title="6.1.2 å•Reactorå¤šçº¿ç¨‹"></a>6.1.2 å•Reactorå¤šçº¿ç¨‹</h3><ul><li>Reactoré€šè¿‡å¤šè·¯è½¬æ¥ç›‘å¬å®¢æˆ·ç«¯äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åï¼Œè¿›è¡Œåˆ†å‘</li><li>å¦‚æœæ˜¯å»ºç«‹é“¾æ¥çš„è¯·æ±‚ï¼Œåˆ™æ‰§è¡Œacceptï¼Œå»ºç«‹é“¾æ¥åï¼Œåˆ›å»ºä¸€ä¸ªHandlerå®Œæˆé“¾æ¥å»ºç«‹åçš„å„ä¸ªæ“ä½œ</li><li>å¦‚æœä¸æ˜¯é“¾æ¥è¯·æ±‚ï¼ˆè¯»å†™å°±ç»ªï¼‰åˆ™ç”±Reactoråˆ†å‘è°ƒç”¨é“¾æ¥å¯¹åº”çš„è¯»å†™Handleræ¥è¿›è¡Œå¤„ç†</li><li>Handleråªè´Ÿè´£å“åº”å…·ä½“çš„äº‹ä»¶ï¼Œè€Œä¸è¿›è¡Œå…·ä½“çš„ä¸šåŠ¡å¤„ç†</li><li>é€šè¿‡Handlerä¸­çš„readè¯»å–åˆ°æ•°æ®åï¼Œåˆ†å‘ç»™çº¿ç¨‹æ± å­ä¸­çš„çº¿ç¨‹å¤„ç†ï¼Œå¤„ç†å®Œæ¯•åè¿”å›Handlerï¼Œå†é€šè¿‡å†™æ–¹æ³•å‘é€ç»™å®¢æˆ·ç«¯</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/18889218bcf8b973dd2140f84ee48c1d.png" alt="img"></p><h3 id="6-1-3-å•Reactorå•çº¿ç¨‹"><a href="#6-1-3-å•Reactorå•çº¿ç¨‹" class="headerlink" title="6.1.3 å•Reactorå•çº¿ç¨‹"></a>6.1.3 å•Reactorå•çº¿ç¨‹</h3><p>ç¬¬ä¸‰ç§æ˜¯å•çº¿ç¨‹æ¨¡å¼ä¸‹çš„ï¼ˆåŠå¼‚æ­¥åŠåŒæ­¥æ¨¡å‹ï¼‰ï¼Œå½“æ”¶åˆ°æŸä¸ªå®¢æˆ·ç«¯çš„å°±ç»ªäº‹ä»¶ï¼Œå°±å»å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚æ­¤æ—¶Handlerä¼šå®Œæˆreadåˆ°ä¸šåŠ¡å¤„ç†åˆ°sendçš„å…¨æµç¨‹ï¼›</p><p>æœ¬æ¬¡ä¸»è¦å†™çš„æ˜¯è¯¥æ¨¡å¼ä¸‹çš„æ“ä½œï¼Œå› ä¸ºå®ƒåŸºæœ¬æ˜¯<strong>ä¸²è¡Œ</strong>è¿è¡Œçš„ï¼Œæ€è·¯æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ¨¡å¼æ”¯æŒçš„å®¢æˆ·ç«¯é‡ä¸åº”è¿‡å¤šï¼Œå¦åˆ™ä¼šæå¤§å½±å“æ€§èƒ½ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/bd8688effc6efb18264e9785cc78b54e.png" alt="image-20230828085239238"></p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/b057900a9b937973503f493cfa576711.png" alt="img"></p><h3 id="6-1-4-æ€»ç»“"><a href="#6-1-4-æ€»ç»“" class="headerlink" title="6.1.4 æ€»ç»“"></a>6.1.4 æ€»ç»“</h3><p><strong>ä¸‰ç§æ¨¡å¼ç”¨ç”Ÿæ´»æ¡ˆä¾‹æ¥ç†è§£</strong></p><ol><li><p>å•Reactorå•çº¿ç¨‹ï¼Œå‰å°æ¥å¾…å‘˜å’ŒæœåŠ¡å‘˜æ˜¯åŒä¸€ä¸ªäººï¼Œå…¨ç¨‹ä¸ºé¡¾å®¢æœåŠ¡</p></li><li><p>å•Reactorå¤šçº¿ç¨‹ï¼Œ1ä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜ï¼Œæ¥å¾…å‘˜åªè´Ÿè´£æ¥å¾…</p></li><li><p>ä¸»ä»Reactorå¤šçº¿ç¨‹ï¼Œå¤šä¸ªå‰å°æ¥å¾…å‘˜ï¼Œå¤šä¸ªæœåŠ¡å‘˜</p></li></ol><p><strong>Reactoræ¨¡å‹å…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹</strong></p><ol><li><p>å“åº”å¿«ï¼Œä¸å¿…ä¸ºå•ä¸ªåŒæ­¥äº‹ä»¶æ‰€é˜»å¡ï¼Œè™½ç„¶Reactoræœ¬èº«ä¾ç„¶æ˜¯åŒæ­¥çš„</p></li><li><p>å¯ä»¥æœ€å¤§ç¨‹åº¦çš„é¿å…å¤æ‚çš„å¤šçº¿ç¨‹åŠåŒæ­¥é—®é¢˜ï¼Œå¹¶ä¸”é¿å…äº†å¤šçº¿ç¨‹&#x2F;è¿›ç¨‹çš„åˆ‡æ¢å¼€é”€</p></li><li><p>æ‰©å±•æ€§å¥½ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡å¢åŠ Reactorå®ä¾‹ä¸ªæ•°æ¥å……åˆ†åˆ©ç”¨CPUèµ„æº</p></li><li><p>å¤ç”¨æ€§å¥½ï¼ŒReactoræ¨¡å‹æœ¬èº«ä¸å…·ä½“äº‹ä»¶å¤„ç†é€»è¾‘æ— å…³ï¼Œå…·æœ‰å¾ˆé«˜çš„å¤ç”¨æ€§</p></li></ol><h2 id="6-2-ä»£ç åˆ†æ"><a href="#6-2-ä»£ç åˆ†æ" class="headerlink" title="6.2 ä»£ç åˆ†æ"></a>6.2 ä»£ç åˆ†æ</h2><p>è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç å§ï¼æœ¬æ¬¡å°†æ‰€æœ‰å¤„ç†æ¨¡å—éƒ½ç»™æ‹†åˆ†å¼€æ¥ï¼Œä¸€ä¸€è¿›è¡Œè¯´æ˜</p><h3 id="6-2-1-Epoller-hpp"><a href="#6-2-1-Epoller-hpp" class="headerlink" title="6.2.1 Epoller.hpp"></a>6.2.1 Epoller.hpp</h3><p>é¦–å…ˆæ˜¯å°†å¯¹epollçš„ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°è¿›è¡Œä¸€å®šçš„å°è£…ï¼Œç»Ÿä¸€è¿›è¡Œé”™è¯¯çš„åˆ¤æ–­å¤„ç†ã€‚æ–¹ä¾¿äº†å…¶ä»–æ¨¡å—çš„è°ƒç”¨ç”¨ï¼›</p><p>è¿™éƒ¨åˆ†çš„ä»£ç éå¸¸ç®€å•ï¼Œå°±åªåœ¨æ³¨é‡Šé‡Œå†™ä¸€ä¸‹è§£æå§ï¼</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Log.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Epoller</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> gsize = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">CreateEpoller</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> epfd = <span class="built_in">epoll_create</span>(gsize); <span class="comment">// åˆ›å»ºå¯¹åº”sizeçš„epfd</span></span><br><span class="line">        <span class="keyword">if</span> (epfd &lt; <span class="number">0</span>) <span class="comment">// é”™è¯¯åˆ¤æ–­</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logMessage</span>(FATAL, <span class="string">&quot;epoll_create : %d : %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> epfd; <span class="comment">// æ­£ç¡®è¿”å›epfd</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">AddEvent</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> sock, <span class="type">uint32_t</span> event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">        ev.events = event; <span class="comment">// è®¾ç½®event</span></span><br><span class="line">        ev.data.fd = sock;</span><br><span class="line">        <span class="comment">// ç»™å¯¹åº”çš„socketæ·»åŠ åˆ°epollä¸­</span></span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, sock, &amp;ev);</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>; <span class="comment">// è¿”å›å€¼æ˜¯æ˜¯å¦è°ƒç”¨æˆåŠŸ</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">ModEvent</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> sock, <span class="type">uint32_t</span> event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">        ev.events = event;</span><br><span class="line">        ev.data.fd = sock;</span><br><span class="line">        <span class="comment">// ä¿®æ”¹å·²æœ‰scoketçš„event</span></span><br><span class="line">        <span class="comment">// è¯¥socketå¿…é¡»å…ˆç”¨ADDæ·»åŠ ï¼Œå¦åˆ™æ— æ³•ä¿®æ”¹ï¼Œä¼šè¿”å›ENOENTé”™è¯¯</span></span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_MOD, sock, &amp;ev);</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">DelEvent</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> sock)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ é™¤æŒ‡å®šsocket</span></span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_DEL, sock, <span class="literal">nullptr</span>);</span><br><span class="line">        <span class="keyword">return</span> n == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">LoopOnce</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event revs[], <span class="type">int</span> num)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// å•æ¬¡waitçš„è°ƒç”¨ï¼Œä»æ•°ç»„é‡Œé¢å–å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">        <span class="type">int</span> n = <span class="built_in">epoll_wait</span>(epfd, revs, num, <span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span>(n == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logMessage</span>(FATAL, <span class="string">&quot;epoll_wait : %d : %s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-2-2-Sock-hpp"><a href="#6-2-2-Sock-hpp" class="headerlink" title="6.2.2 Sock.hpp"></a>6.2.2 Sock.hpp</h3><p>åŒselectï¼Œè§ä¸Šæ–‡ <a href="#jump-select">3.2.1 socket</a> éƒ¨åˆ†ï¼›</p><h3 id="6-2-3-Log-hpp"><a href="#6-2-3-Log-hpp" class="headerlink" title="6.2.3 Log.hpp"></a>6.2.3 Log.hpp</h3><p>ä¸€ä¸ªå·¨ç®€å•çš„æ—¥å¿—ç±»</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdarg&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cerrno&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NOTICE 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WARNING 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FATAL 3</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *log_level[] = &#123;<span class="string">&quot;DEBUG&quot;</span>, <span class="string">&quot;NOTICE&quot;</span>, <span class="string">&quot;WARINING&quot;</span>, <span class="string">&quot;FATAL&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOGFILE <span class="string">&quot;serverTcp.log&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Log</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Log</span>():<span class="built_in">logFd</span>(<span class="number">-1</span>)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">enable</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">umask</span>(<span class="number">0</span>);</span><br><span class="line">        logFd = <span class="built_in">open</span>(LOGFILE, O_WRONLY | O_CREAT | O_APPEND, <span class="number">0666</span>);</span><br><span class="line">        <span class="built_in">assert</span>(logFd != <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">dup2</span>(logFd, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">dup2</span>(logFd, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">Log</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(logFd != <span class="number">-1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">fsync</span>(logFd);</span><br><span class="line">            <span class="built_in">close</span>(logFd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> logFd;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// logMessage(DEBUG, &quot;%d&quot;, 10);</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">logMessage</span><span class="params">(<span class="type">int</span> level, <span class="type">const</span> <span class="type">char</span> *format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(level &gt;= DEBUG);</span><br><span class="line">    <span class="built_in">assert</span>(level &lt;= FATAL);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *name = <span class="built_in">getenv</span>(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> logInfo[<span class="number">1024</span>];</span><br><span class="line">    va_list ap;</span><br><span class="line">    <span class="built_in">va_start</span>(ap, format);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">vsnprintf</span>(logInfo, <span class="built_in">sizeof</span>(logInfo) - <span class="number">1</span>, format, ap);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">va_end</span>(ap); <span class="comment">// ap = NULL</span></span><br><span class="line"></span><br><span class="line">    FILE *out = (level == FATAL) ? stderr : stdout;</span><br><span class="line">    <span class="built_in">fprintf</span>(out, <span class="string">&quot;%s | %u | %s | %s\n&quot;</span>,</span><br><span class="line">            log_level[level],</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>),</span><br><span class="line">            name == <span class="literal">nullptr</span> ? <span class="string">&quot;unknow&quot;</span> : name,</span><br><span class="line">            logInfo);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fflush</span>(out); <span class="comment">// å°†Cè¯­è¨€ç¼“å†²åŒºä¸­çš„æ•°æ®åˆ·æ–°åˆ°OS</span></span><br><span class="line">    <span class="built_in">fsync</span>(<span class="built_in">fileno</span>(out));   <span class="comment">// å°†OSä¸­çš„æ•°æ®å°½å¿«å†™å…¥ç¡¬ç›˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-4-TcpServer"><a href="#6-2-4-TcpServer" class="headerlink" title="6.2.4 TcpServer"></a>6.2.4 TcpServer</h3><p>è¿™æ˜¯æˆ‘ä»¬reactoræ¨¡å‹çš„é‡ç‚¹</p><h4 id="1-Connectionç±»"><a href="#1-Connectionç±»" class="headerlink" title="1.Connectionç±»"></a>1.Connectionç±»</h4><p>è¿™é‡Œå…ˆå®šä¹‰äº†ä¸€ä¸ªConnectioné“¾æ¥ç±»ï¼Œæ¯”è¾ƒé‡è¦çš„æ˜¯ç±»é‡Œé¢æœ‰3ä¸ªå›è°ƒæ–¹æ³•çš„æŒ‡é’ˆã€‚åœ¨Reactorä¸­ï¼Œæˆ‘ä»¬ç”¨å›è°ƒæ–¹æ³•æ¥æ›¿ä»£äº†ä¸»æ‰§è¡Œæµç›´æ¥è°ƒç”¨å‡½æ•°çš„æ–¹å¼ã€‚çº¿ç¨‹åªéœ€è¦æ¥æ”¶åˆ°è¿™ä¸ª<code>Connection</code>å¯¹è±¡ï¼Œå°±å¯ä»¥ç”¨å›è°ƒæ–¹æ³•æ¥å®ç°å¯¹é“¾æ¥çš„æ•°æ®å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">using <span class="type">func_t</span> = <span class="built_in">std</span>::function&lt;<span class="type">int</span>(Connection *)&gt;;</span><br><span class="line">using <span class="type">callback_t</span> = <span class="built_in">std</span>::function&lt;<span class="type">int</span>(Connection *, <span class="built_in">std</span>::<span class="built_in">string</span> &amp;)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">    <span class="comment">// æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="type">int</span> sock_;</span><br><span class="line">    TcpServer *R_;<span class="comment">// ä¸»æœåŠ¡å™¨çš„ç±»æŒ‡é’ˆ</span></span><br><span class="line">    <span class="comment">// è‡ªå·±çš„æ¥å—å’Œå‘é€ç¼“å†²åŒº</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> inbuffer_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> outbuffer_;</span><br><span class="line">    <span class="comment">// è¯»ã€å†™ã€å¼‚å¸¸çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">    <span class="type">func_t</span> recver_; </span><br><span class="line">    <span class="type">func_t</span> sender_;</span><br><span class="line">    <span class="type">func_t</span> excepter_;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    Connection(<span class="type">int</span> sock, TcpServer *r) : sock_(sock), R_(r)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetRecver</span><span class="params">(<span class="type">func_t</span> recver)</span> &#123; recver_ = recver; &#125;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetSender</span><span class="params">(<span class="type">func_t</span> sender)</span> &#123; sender_ = sender; &#125;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">SetExcepter</span><span class="params">(<span class="type">func_t</span> excepter)</span> &#123; excepter_ = excepter; &#125;</span><br><span class="line">    ~Connection() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="2-TcpServeræˆå‘˜å˜é‡"><a href="#2-TcpServeræˆå‘˜å˜é‡" class="headerlink" title="2.TcpServeræˆå‘˜å˜é‡"></a>2.TcpServeræˆå‘˜å˜é‡</h4><p>å†æ¥çœ‹çœ‹tcpserverçš„æˆå‘˜å˜é‡æœ‰ä»€ä¹ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">private:</span><br><span class="line">	<span class="comment">// æ¥æ”¶é˜Ÿåˆ—çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> revs_num = <span class="number">64</span>;</span><br><span class="line">    <span class="comment">// 1. ç½‘ç»œsocket</span></span><br><span class="line">    <span class="type">int</span> listensock_;</span><br><span class="line">    <span class="comment">// 2. epollçš„fd</span></span><br><span class="line">    <span class="type">int</span> epfd_;</span><br><span class="line">    <span class="comment">// 3. å°†epollå’Œä¸Šå±‚ä»£ç è¿›è¡Œç»“åˆï¼Œå·²æœ‰é“¾æ¥</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="type">int</span>, Connection *&gt; connections_;</span><br><span class="line">    <span class="comment">// 4. å°±ç»ªäº‹ä»¶åˆ—è¡¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> *<span class="title">revs_</span>;</span></span><br><span class="line">    <span class="comment">// 5. è®¾ç½®å®Œæ•´æŠ¥æ–‡çš„å¤„ç†å›è°ƒæ–¹æ³•</span></span><br><span class="line">    <span class="type">callback_t</span> cb_;</span><br></pre></td></tr></table></figure><h4 id="3-æ„é€ "><a href="#3-æ„é€ " class="headerlink" title="3.æ„é€ "></a>3.æ„é€ </h4><p>éšåä¾¿æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–è¿™äº›æˆå‘˜å˜é‡ï¼Œå…ˆæ˜¯ä»<code>Sock.hpp</code>ä¸­è·å–åˆ°ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åå†é€šè¿‡Epollerç±»è·å–åˆ°epfdå¥æŸ„ï¼Œæœ€åæ˜¯å°†listensocketæ”¾å…¥epollçš„ç›‘å¬ä¸­ï¼›</p><p>è¿™é‡Œçš„<code>std::bind</code>çš„ä½œç”¨ï¼Œæ˜¯å°†å½“å‰TcpServerçš„<code>this</code>æŒ‡é’ˆç»‘å®šåˆ°<code>TcpServer::Accepter</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸Šï¼Œå¦åˆ™åœ¨ç±»å¤–æ²¡æœ‰åŠæ³•é€šè¿‡<code>Connection</code>ç±»çš„å›è°ƒæŒ‡é’ˆæ¥è°ƒç”¨è¿™ä¸ªç±»çš„æˆå‘˜å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">TcpServer(<span class="type">callback_t</span> cb, <span class="type">int</span> port = <span class="number">8080</span>) : cb_(cb)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å½“å‰ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦åŠå…¶äº‹ä»¶</span></span><br><span class="line">    revs_ = new <span class="keyword">struct</span> epoll_event[revs_num]; </span><br><span class="line">    <span class="comment">// ç½‘ç»œåŠŸèƒ½</span></span><br><span class="line">    listensock_ = Sock::SocketInit();</span><br><span class="line">    Util::SetNonBlock(listensock_);</span><br><span class="line">    Sock::Bind(listensock_, port);</span><br><span class="line">    Sock::Listen(listensock_);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤šè·¯è½¬æ¥</span></span><br><span class="line">    epfd_ = Epoller::CreateEpoller();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ listensockåŒ¹é…çš„connection</span></span><br><span class="line">    AddConnection(listensock_, EPOLLIN | EPOLLET,</span><br><span class="line">                  <span class="built_in">std</span>::bind(&amp;TcpServer::Accepter, this, <span class="built_in">std</span>::placeholders::_1), nullptr, nullptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-æ·»åŠ é“¾æ¥"><a href="#4-æ·»åŠ é“¾æ¥" class="headerlink" title="4.æ·»åŠ é“¾æ¥"></a>4.æ·»åŠ é“¾æ¥</h4><p>åœ¨<code>AddConnection</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†socketç»™æ·»åŠ åˆ°epfdä¸­ï¼›å¦‚æœè¿™ä¸ªepfdæ˜¯ä½¿ç”¨äº†<code>EPOLLET</code>çš„ETæ¨¡å¼ï¼Œåˆ™è¿˜éœ€è¦è®¾ç½®éé˜»å¡ï¼›</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AddConnection</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">uint32_t</span> event, <span class="type">func_t</span> recver, <span class="type">func_t</span> sender, <span class="type">func_t</span> excepter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (event &amp; EPOLLET)</span><br><span class="line">        Util::<span class="built_in">SetNonBlock</span>(sockfd);</span><br><span class="line">    <span class="comment">// æ·»åŠ sockfdåˆ°epoll</span></span><br><span class="line">    Epoller::<span class="built_in">AddEvent</span>(epfd_, sockfd, event);</span><br><span class="line">    <span class="comment">// å°†sockfdåŒ¹é…çš„Connectionä¹Ÿæ·»åŠ åˆ°å½“å‰çš„unordered_mapä¸­</span></span><br><span class="line">    Connection *conn = <span class="keyword">new</span> <span class="built_in">Connection</span>(sockfd, <span class="keyword">this</span>);</span><br><span class="line">    conn-&gt;<span class="built_in">SetRecver</span>(recver);</span><br><span class="line">    conn-&gt;<span class="built_in">SetSender</span>(sender);</span><br><span class="line">    conn-&gt;<span class="built_in">SetExcepter</span>(excepter);</span><br><span class="line"></span><br><span class="line">    connections_.<span class="built_in">insert</span>(std::<span class="built_in">make_pair</span>(sockfd, conn));</span><br><span class="line">    <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;æ·»åŠ æ–°é“¾æ¥åˆ°connectionsæˆåŠŸ: %d&quot;</span>, sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®éé˜»å¡çš„ä»£ç å¾ˆç®€å•ï¼Œåœ¨å‰æ–‡å·²ç»æ¼”ç¤ºè¿‡äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Util</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">    <span class="type">static</span> <span class="type">void</span> <span class="title function_">SetNonBlock</span><span class="params">(<span class="type">int</span> fd)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> fl = fcntl(fd, F_GETFL);</span><br><span class="line">        fcntl(fd, F_SETFL, fl | O_NONBLOCK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="5-ææ„"><a href="#5-ææ„" class="headerlink" title="5.ææ„"></a>5.ææ„</h4><p>åœ¨ææ„å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†listensocketå’Œepfdä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦å…³é—­ï¼Œå¹¶ææ„æ‰é“¾æ¥æ•°ç»„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~<span class="built_in">TcpServer</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (listensock_ != <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">close</span>(listensock_);</span><br><span class="line">    <span class="keyword">if</span> (epfd_ != <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">close</span>(epfd_);</span><br><span class="line">    <span class="keyword">delete</span>[] revs_;</span><br><span class="line">    <span class="comment">// è¿˜éœ€è¦ææ„æ‰è¿æ¥æ± ä¸­å°šå­˜åœ¨çš„connectionå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp;c:connections_)&#123;</span><br><span class="line">        <span class="keyword">delete</span> c.second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-è·å–æ–°è¿æ¥Accept"><a href="#6-è·å–æ–°è¿æ¥Accept" class="headerlink" title="6.è·å–æ–°è¿æ¥Accept"></a>6.è·å–æ–°è¿æ¥Accept</h4><p>åœ¨è·å–æ–°è¿æ¥è¿™é‡Œï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ä¸ªæ­»å¾ªç¯æ¥è·å–ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºlistensocketæ–‡ä»¶æè¿°ç¬¦è€Œè¨€ï¼Œåªè¦æ¥äº†ä¸€ä¸ªæ–°é“¾æ¥ï¼Œåœ¨ETæ¨¡å¼ä¸‹å°±ä¼šæç¤ºæˆ‘ä»¬ã€‚ä½†æœ‰å¯èƒ½ä¼šå‡ºç°æˆ‘ä»¬è¿˜æ²¡æœ‰æ¥å¾—åŠå–èµ°è¿™ä¸ªé“¾æ¥ï¼Œå°±åˆæ¥äº†ä¸€ä¸ªæ–°é“¾æ¥çš„æƒ…å†µï¼ˆå¯ä»¥ç®€åŒ–ç†è§£ä¸ºä¸€æ¬¡æ€§æ¥äº†ä¸¤ä¸ªé“¾æ¥ï¼‰</p><p>è¿™æ—¶å€™å› ä¸ºETçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€æ¬¡æ€§å–èµ°æ‰€æœ‰é“¾æ¥ï¼›ä¸ºäº†é¿å…åœ¨Acceptçš„æ—¶å€™ï¼Œå› ä¸ºé“¾æ¥å·²ç»éƒ½è¢«å–èµ°äº†è€Œé˜»å¡ä½ï¼Œæˆ‘ä»¬éœ€è¦å°†listensocketè®¾ç½®ä¸º<strong>éé˜»å¡</strong>ï¼›</p><blockquote><p>å…³äºæ–°é“¾æ¥ä¸ºä»€ä¹ˆåªå…³æ³¨è¯»äº‹ä»¶ï¼Œåœ¨æ³¨é‡Šä¸­æœ‰è¯´æ˜ï¼›</p></blockquote><p>å¯¹äºlistensocketæ¥è¯´ï¼Œè¿™ä¸ªAccepterå‡½æ•°å°±æ˜¯å®ƒçš„è¯»äº‹ä»¶å›è°ƒï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª<code>Connection *conn</code>å¯¹è±¡ï¼Œå…¶æ˜¯ä¸ºäº†ä¸å…¶ä»–äº‹ä»¶å¤„ç†å‡½æ•°ç»Ÿä¸€ï¼ˆå› ä¸ºè¿™ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ä¸åœ¨<code>Connection</code>ç±»ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦è·å–ä¸€ä¸ªå¯¹è±¡æ‰èƒ½è®¿é—®åˆ°å®ƒçš„æˆå‘˜å˜é‡ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">Accepter</span><span class="params">(Connection *conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::string clientip;</span><br><span class="line">        <span class="type">uint16_t</span> clientport = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> sockfd = Sock::<span class="built_in">Accept</span>(conn-&gt;sock_, &amp;clientip, &amp;clientport);</span><br><span class="line">        <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// æ¥æ”¶å‡½æ•°è¢«äº‹ä»¶æ‰“æ–­äº†</span></span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// æœ¬æ¬¡æ•°æ®æ²¡æœ‰å‡†å¤‡å¥½ï¼Œå¯ä»¥ç†è§£ä¸ºæ¥æ”¶ç¼“å†²åŒºç©ºäº†</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">logMessage</span>(WARNING, <span class="string">&quot;accept error&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;get a new link: %d&quot;</span>, sockfd);</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šé»˜è®¤æˆ‘ä»¬åªè®¾ç½®äº†è®©epollå¸®æˆ‘ä»¬å…³å¿ƒè¯»äº‹ä»¶ï¼Œæ²¡æœ‰å…³å¿ƒå†™äº‹ä»¶</span></span><br><span class="line">        <span class="comment">// ä¸ºä»€ä¹ˆæ²¡æœ‰å…³æ³¨å†™äº‹ä»¶ï¼šå› ä¸ºæœ€å¼€å§‹çš„æ—¶å€™ï¼Œå†™ç©ºé—´ä¸€å®šæ˜¯å°±ç»ªçš„ï¼</span></span><br><span class="line">        <span class="comment">// è¿è¡Œä¸­å¯èƒ½æ‰ä¼šå­˜åœ¨å†™æ¡ä»¶ä¸æ»¡è¶³ -- å†™ç©ºé—´è¢«å†™æ»¡äº†</span></span><br><span class="line">        <span class="built_in">AddConnection</span>(sockfd, EPOLLIN | EPOLLET,</span><br><span class="line">                      std::<span class="built_in">bind</span>(&amp;TcpServer::TcpRecver, <span class="keyword">this</span>, std::placeholders::_1),</span><br><span class="line">                      std::<span class="built_in">bind</span>(&amp;TcpServer::TcpSender, <span class="keyword">this</span>, std::placeholders::_1),</span><br><span class="line">                      std::<span class="built_in">bind</span>(&amp;TcpServer::TcpExcepter, <span class="keyword">this</span>, std::placeholders::_1));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EAGAIN or EWOULDBLOCK</span><br><span class="line">	The socket is marked nonblocking and the receive operation would block, or a receive timeout had been set and the timeout expired before data was received.  POSIX.1 allows either error to be returned for this case, and does not require these constants to have the same value, so  a  portable application should check for both possibilities.</span><br></pre></td></tr></table></figure><h4 id="7-é“¾æ¥çš„äº‹ä»¶å¤„ç†å‡½æ•°"><a href="#7-é“¾æ¥çš„äº‹ä»¶å¤„ç†å‡½æ•°" class="headerlink" title="7.é“¾æ¥çš„äº‹ä»¶å¤„ç†å‡½æ•°"></a>7.é“¾æ¥çš„äº‹ä»¶å¤„ç†å‡½æ•°</h4><p>å…¶ä»–é“¾æ¥çš„ä¸‰ä¸ªå¤„ç†å‡½æ•°åˆ†åˆ«æ˜¯<code>TcpRever/TcpSender/TcpExcepter</code>;</p><p>é¦–å…ˆï¼Œåœ¨å¤„ç†æŸä¸€ä¸ªé“¾æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»è¦ä¿è¯è¿™ä¸ªé“¾æ¥åœ¨å·²æœ‰çš„mapé‡Œé¢ï¼Œå¦åˆ™ä»£è¡¨è¿™ä¸ªé“¾æ¥å·²ç»è¢«å…³é—­æˆ–è€…å¼‚å¸¸é€€å‡ºäº†ï¼›åŒç†ï¼Œåœ¨å¼‚å¸¸å’Œå…³é—­é“¾æ¥çš„å¤„ç†æµç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†é“¾æ¥ä»mapä¸­åˆ é™¤</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">IsExists</span><span class="params">(<span class="type">int</span> sock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> iter = connections_.<span class="built_in">find</span>(sock);</span><br><span class="line">    <span class="keyword">if</span> (iter == connections_.<span class="built_in">end</span>())</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="è¯»"><a href="#è¯»" class="headerlink" title="è¯»"></a>è¯»</h5><p>å¯¹äºè¯»äº‹ä»¶è€Œè¨€æˆ‘ä»¬ä¹Ÿæ˜¯è¿›è¡Œå¾ªç¯è¯»å–ï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦ä¹Ÿéœ€è¦è¢«è®¾ç½®ä¸ºéé˜»å¡ã€‚è¯»å–çš„å†…å®¹æ‹¼æ¥åˆ°è¯¥Connectionå¯¹è±¡çš„è¾“å…¥ç¼“å†²åŒºstringä¸­ï¼›</p><p>åœ¨è¯»å–å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦åœ¨åè®®é‡Œé¢å®šä¹‰ä¸€ä¸ªæ ¹æ®<strong>åº”ç”¨å±‚åè®®å­—æ®µ</strong>æ¥åˆ†ç¦»æŠ¥æ–‡çš„å‡½æ•°ï¼ˆé¿å…tcpçš„ç²˜åŒ…é—®é¢˜ï¼‰ï¼Œæœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªstringçš„æ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„æˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„æŠ¥æ–‡ï¼›</p><p>æœ€åï¼Œæˆ‘ä»¬ç›´æ¥ä¸€ä¸ªforå¾ªç¯ï¼Œé€šè¿‡è¯¥tcpserverå¯¹è±¡åœ¨åˆå§‹åŒ–æ—¶å€™è®¾ç½®çš„<code>cb_</code>å‡½æ•°å›è°ƒæŒ‡é’ˆï¼Œæ¥å¤„ç†æ¯ä¸€ä¸ªæŠ¥æ–‡ï¼ˆä¸ºæ¯ä¸€ä¸ªæŠ¥æ–‡æä¾›æœåŠ¡ï¼‰</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">TcpRecver</span><span class="params">(Connection *conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">recv</span>(conn-&gt;sock_, buffer, <span class="built_in">sizeof</span>(buffer) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buffer[s] = <span class="number">0</span>;</span><br><span class="line">            conn-&gt;inbuffer_ += buffer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;client quit&quot;</span>);</span><br><span class="line">            conn-&gt;<span class="built_in">excepter_</span>(conn);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno == EINTR) <span class="comment">// æ¥æ”¶äº‹ä»¶è¢«æ‰“æ–­</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// æ¥æ”¶ç¼“å†²åŒºç©ºäº†</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK)</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// å‡ºé”™äº†</span></span><br><span class="line">                <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;recv error: %d:%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                conn-&gt;<span class="built_in">excepter_</span>(conn);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†æœ¬è½®å…¨éƒ¨è¯»å–å®Œæ¯•</span></span><br><span class="line">    std::vector&lt;std::string&gt; result;</span><br><span class="line">    <span class="built_in">PackageSplit</span>(conn-&gt;inbuffer_, &amp;result);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;message : result)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cb_</span>(conn, message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¡†æ¶çš„å¥½å¤„å°±åœ¨äºï¼Œä½ å¯ä»¥å•ç‹¬å®ç°ä¸åŒåè®®çš„æŠ¥æ–‡åˆ†ç¦»å‡½æ•°å’Œæ•°æ®æœåŠ¡å‡½æ•°ï¼Œè€Œä¸éœ€è¦é‡å†™TcpServerçš„å®ç°ï¼Œç›¸å½“äºè§£è€¦ï¼›</p><h5 id="å†™"><a href="#å†™" class="headerlink" title="å†™"></a>å†™</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">TcpSender</span><span class="params">(Connection *conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ssize_t</span> n = <span class="built_in">send</span>(conn-&gt;sock_, conn-&gt;outbuffer_.<span class="built_in">c_str</span>(), conn-&gt;outbuffer_.<span class="built_in">size</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å»é™¤å·²ç»æˆåŠŸå‘é€çš„æ•°æ®</span></span><br><span class="line">            conn-&gt;outbuffer_.<span class="built_in">erase</span>(<span class="number">0</span>, n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å†™å…¥æ“ä½œè¢«æ‰“æ–­</span></span><br><span class="line">            <span class="keyword">if</span>(errno == EINTR) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// å†™å…¥ç¼“å†²åŒºæ»¡äº†ï¼Œæ²¡åŠæ³•ç»§ç»­å†™</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(errno == EAGAIN || errno == EWOULDBLOCK) <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">else</span> <span class="comment">// å¼‚å¸¸</span></span><br><span class="line">            &#123;</span><br><span class="line">                conn-&gt;<span class="built_in">excepter_</span>(conn);</span><br><span class="line">                <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;send error: %d:%s&quot;</span>, errno, <span class="built_in">strerror</span>(errno));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œè¿™é‡Œçš„å†™å…¥å¦‚æœé‡åˆ°<code>(errno == EAGAIN || errno == EWOULDBLOCK)</code> è¿™ä¸¤ç§æƒ…å†µï¼Œå¹¶ä¸èƒ½ç¡®ä¿è¾“å‡ºç¼“å†²åŒºä¸­çš„æ•°æ®å·²ç»è¢«å…¨éƒ¨å†™å…¥äº†ï¼›æœ‰å¯èƒ½æ˜¯å†™å…¥ç¼“å†²åŒºæ»¡äº†å¯¼è‡´æ— æ³•ç»§ç»­å†™å…¥ï¼›</p><p>è¿™ç§iæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­<code>outbuffer</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¿˜æ˜¯éœ€è¦è®¾ç½®<code>EPOLLOUT</code>æ ‡è®°ä½ï¼Œå‘ŠçŸ¥epollç»§ç»­å¸®æˆ‘ä»¬å…³æ³¨å†™äº‹ä»¶ï¼ˆè¿™æ ·epollå°±ä¼šå‘ä¿¡æ¯å‘ŠçŸ¥Reactorï¼ŒReactorä¼šé‡æ–°è°ƒç”¨å†™å…¥å‡½æ•°ï¼Œç»§ç»­å†™å…¥ç¼“å†²åŒºçš„å‰©ä¸‹æ•°æ®ï¼‰è¿™ä¸ªæ“ä½œä¼šåœ¨ä¸»æ‰§è¡Œæµä¸­è¿›è¡Œç»Ÿä¸€åˆ¤æ–­</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸»æ‰§è¡Œæµ</span></span><br><span class="line">conn-&gt;<span class="built_in">sender_</span>(conn); <span class="comment">// ä¸»æ‰§è¡Œæµè°ƒç”¨å‘é€å‡½æ•°</span></span><br><span class="line"><span class="comment">// åˆ¤æ–­æœ¬æ¬¡æ˜¯å¦å‘å®Œæ¯•äº†ï¼Œæ²¡æœ‰å‘å®Œæ¯•è¿˜éœ€è¦ç»§ç»­å…³å¿ƒè¯»å†™</span></span><br><span class="line"><span class="keyword">if</span>(conn-&gt;outbuffer_.<span class="built_in">empty</span>()) conn-&gt;R_-&gt;<span class="built_in">EnableReadWrite</span>(conn-&gt;sock_, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">else</span> conn-&gt;R_-&gt;<span class="built_in">EnableReadWrite</span>(conn-&gt;sock_, <span class="literal">true</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“å¼€æˆ–è€…å…³é—­å¯¹äºç‰¹å®šsocketæ˜¯å¦è¦å…³å¿ƒè¯»æˆ–è€…å†™</span></span><br><span class="line"><span class="comment">//- EnableReadWrite(sock, true, false); //åªå…³å¿ƒè¯»</span></span><br><span class="line"><span class="comment">//- EnableReadWrite(sock, true, true);  //åŒæ—¶å…³å¿ƒè¯»å†™</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EnableReadWrite</span><span class="params">(<span class="type">int</span> sock, <span class="type">bool</span> readable, <span class="type">bool</span> writeable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> event = <span class="number">0</span>;</span><br><span class="line">    event |= (readable ? EPOLLIN : <span class="number">0</span>);</span><br><span class="line">    event |= (writeable ? EPOLLOUT : <span class="number">0</span>);</span><br><span class="line">    Epoller::<span class="built_in">ModEvent</span>(epfd_, sock, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¼‚å¸¸"><a href="#å¼‚å¸¸" class="headerlink" title="å¼‚å¸¸"></a>å¼‚å¸¸</h5><p>ä¸ºäº†ç»Ÿä¸€è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œåœ¨ä¸Šæ–‡ä¸­å½“æˆ‘ä»¬é‡åˆ°è¯»å†™å‡ºé”™çš„æ—¶å€™ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼›</p><p>åœ¨è¿™ä¸ªå‡½æ•°ä½“å†…ï¼Œä¼šå°†é“¾æ¥ä»epollä¸­åˆ é™¤ã€å…³é—­é“¾æ¥ã€é‡Šæ”¾connectionå¯¹è±¡ã€å°†æ–‡ä»¶æè¿°ç¬¦ä»mapé‡Œé¢å‰”é™¤ï¼›</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€å®šè¦å…ˆå°†socketä»epollé‡Œé¢å‰”é™¤æ‰ï¼Œå†å…³é—­socketï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">TcpExcepter</span><span class="params">(Connection *conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 0. åˆ¤æ–­æœ‰æ•ˆæ€§</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">IsExists</span>(conn-&gt;sock_)) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰€æœ‰çš„æœåŠ¡å™¨å¼‚å¸¸ï¼Œéƒ½ä¼šè¢«å½’ç±»åˆ°è¿™é‡Œ</span></span><br><span class="line">    <span class="comment">// 1. åˆ é™¤epollçš„ç›‘çœ‹</span></span><br><span class="line">    Epoller::<span class="built_in">DelEvent</span>(epfd_, conn-&gt;sock_);</span><br><span class="line">    <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;remove epoll event!&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. close</span></span><br><span class="line">    <span class="built_in">close</span>(conn-&gt;sock_);</span><br><span class="line">    <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;close fd: %d&quot;</span>, conn-&gt;sock_);</span><br><span class="line">    <span class="comment">// 3. delete conn;</span></span><br><span class="line">    <span class="keyword">delete</span> connections_[conn-&gt;sock_];</span><br><span class="line">    <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;delete connection object done&quot;</span>);</span><br><span class="line">    <span class="comment">// 4. erase conn;</span></span><br><span class="line">    connections_.<span class="built_in">erase</span>(conn-&gt;sock_);</span><br><span class="line">    <span class="built_in">logMessage</span>(DEBUG, <span class="string">&quot;erase connection from connections&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="8-è¿è¡Œ"><a href="#8-è¿è¡Œ" class="headerlink" title="8.è¿è¡Œ"></a>8.è¿è¡Œ</h4><p>å¯¹äºTcpServerè€Œè¨€ï¼Œä¸€æ¬¡çš„è¿è¡Œå°±æ˜¯è°ƒç”¨ä¸€æ¬¡<code>epoll_wait</code>ï¼Œå†æ ¹æ®äº‹ä»¶å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨ä¸åŒçš„äº‹ä»¶å¤„ç†å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Dispatcher</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> n = Epoller::<span class="built_in">LoopOnce</span>(epfd_, revs_, revs_num);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> sock = revs_[i].data.fd;</span><br><span class="line">        <span class="type">uint32_t</span> revent = revs_[i].events;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦å‡ºç°é”™è¯¯ï¼Œå¦‚æœå‡ºç°äº†é”™è¯¯ï¼Œé‚£å°±æŠŠEPOLLINå’ŒOUTéƒ½åŠ ä¸Š</span></span><br><span class="line">        <span class="comment">// è¿™æ ·è¿™ä¸ªé“¾æ¥ä¼šè¿›å…¥ä¸‹é¢çš„å¤„ç†å‡½æ•°ï¼Œå¹¶åœ¨å¤„ç†å‡½æ•°ä¸­å‡ºç°å¼‚å¸¸</span></span><br><span class="line">        <span class="comment">// å¤„ç†å‡½æ•°ä¸­å‡ºç°å¼‚å¸¸å›ç»Ÿä¸€è°ƒç”¨TcpExcpterå‡½æ•°</span></span><br><span class="line">        <span class="keyword">if</span>(revent &amp; EPOLLHUP) revent |= (EPOLLIN|EPOLLOUT);</span><br><span class="line">        <span class="keyword">if</span>(revent &amp; EPOLLERR) revent |= (EPOLLIN|EPOLLOUT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (revent &amp; EPOLLIN)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsExists</span>(sock) &amp;&amp; connections_[sock]-&gt;recver_)</span><br><span class="line">                connections_[sock]-&gt;<span class="built_in">recver_</span>(connections_[sock]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“é“¾æ¥çš„å†™äº‹ä»¶è¢«æ¿€æ´»çš„æ—¶å€™ï¼Œåœ¨è¿™é‡Œå°±ä¼šè§¦å‘å†™äº‹ä»¶çš„å¤„ç†</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å¹¶ä¸éœ€è¦åœ¨recvé‡Œé¢ä¸»åŠ¨è°ƒç”¨å†™äº‹ä»¶å¤„ç†å‡½æ•°</span></span><br><span class="line">        <span class="comment">// åªéœ€è¦å‘Šè¯‰epollè®©å®ƒå¸®æˆ‘ä»¬ç›‘æ§å†™äº‹ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è¿™é‡Œè§¦å‘å†™æ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (revent &amp; EPOLLOUT)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsExists</span>(sock) &amp;&amp; connections_[sock]-&gt;sender_)</span><br><span class="line">                connections_[sock]-&gt;<span class="built_in">sender_</span>(connections_[sock]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæœåŠ¡å™¨è¿è¡Œèµ·æ¥ï¼Œå°±ä¸€ç›´è°ƒç”¨åˆ†å‘å‡½æ•°å°±OKå•¦~</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Dispatcher</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-5-ä¸»æ‰§è¡Œæµ"><a href="#6-2-5-ä¸»æ‰§è¡Œæµ" class="headerlink" title="6.2.5 ä¸»æ‰§è¡Œæµ"></a>6.2.5 ä¸»æ‰§è¡Œæµ</h3><p>å¯¹äºä¸»æ‰§è¡Œæµè€Œè¨€ï¼Œè¦åšçš„å°±æ˜¯è·å–åˆ°å‘½ä»¤è¡Œå‚æ•°çš„ç«¯å£ï¼Œç„¶ååˆ›å»ºtcpserverå¯¹è±¡å¹¶ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcpServer.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Service.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">usage</span><span class="params">(std::string process)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;\nUsage: &quot;</span> &lt;&lt; process &lt;&lt; <span class="string">&quot; port\n&quot;</span></span><br><span class="line">         &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">usage</span>(argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TcpServer <span class="title">svr</span><span class="params">(HandlerRequest, atoi(argv[<span class="number">1</span>]))</span></span>;</span><br><span class="line">    svr.<span class="built_in">Run</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>äº‹ä»¶å¤„ç†å‡½æ•°å¯ä»¥åšä»»æ„å°è£…ï¼Œæ¥å®ç°ä½ è‡ªå·±æƒ³è¦çš„åŠŸèƒ½</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">HandlerRequest</span><span class="params">(Connection *conn, std::string &amp;message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// beginhandleré‡Œé¢æ˜¯å…·ä½“çš„è°ƒç”¨é€»è¾‘ï¼Œcalculatoræ˜¯æœ¬æ¬¡äº‹åŠ¡å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">BeginHandler</span>(conn, message, calculator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±æ˜¯æˆ‘ä»¬å•ä¸ªå®Œæ•´æŠ¥æ–‡çš„å¤„ç†å‡½æ•°ï¼Œåœ¨tcprecveræ–¹æ³•é‡Œé¢è¢«è°ƒç”¨äº†ï¼›</p><p>æ ¹æ®ä¸Šæ–‡æè¿°çš„è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼Œè¿™é‡Œä¼ å…¥æ¥çš„<code>message</code>è‚¯å®šæ˜¯ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨å±‚æŠ¥æ–‡ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªå±äºæˆ‘ä»¬è‡ªå·±çš„åè®®å’Œåè®®ä¸­çš„æ•°æ®å¤„ç†å‡½æ•°å°±OKäº†ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">BeginHandler</span><span class="params">(Connection *conn, std::string &amp;message, <span class="type">service_t</span> service)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// messageä¸€å®šæ˜¯ä¸€ä¸ªå®Œæ•´çš„æŠ¥æ–‡ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å¯¹å®ƒè¿›è¡Œäº†è§£ç </span></span><br><span class="line">    Request req;</span><br><span class="line">    <span class="comment">// ååºåˆ—åŒ–ï¼Œè¿›è¡Œå¤„ç†çš„é—®é¢˜</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Parser</span>(message, &amp;req))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å†™å›é”™è¯¯æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">// å¯ä»¥ç›´æ¥å…³é—­è¿æ¥</span></span><br><span class="line">        <span class="comment">// conn-&gt;excepter_(conn);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    Response resp = <span class="built_in">service</span>(req);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; req.x &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; req.op &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; req.y &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; resp.code &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; resp.result &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">    std::string sendstr;</span><br><span class="line">    <span class="built_in">Serialize</span>(resp, &amp;sendstr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å®Œæ¯•çš„ç»“æœï¼Œå‘é€å›ç»™client</span></span><br><span class="line">    conn-&gt;outbuffer_ += sendstr;</span><br><span class="line">    conn-&gt;<span class="built_in">sender_</span>(conn);</span><br><span class="line">    <span class="keyword">if</span>(conn-&gt;outbuffer_.<span class="built_in">empty</span>()) conn-&gt;R_-&gt;<span class="built_in">EnableReadWrite</span>(conn-&gt;sock_, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">else</span> conn-&gt;R_-&gt;<span class="built_in">EnableReadWrite</span>(conn-&gt;sock_, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;--- end ---&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-6-åè®®å’Œæ•°æ®å¤„ç†"><a href="#6-2-6-åè®®å’Œæ•°æ®å¤„ç†" class="headerlink" title="6.2.6 åè®®å’Œæ•°æ®å¤„ç†"></a>6.2.6 åè®®å’Œæ•°æ®å¤„ç†</h3><p>ä¸‹é¢æä¾›ä¸€ä¸ªæœ€åŸºç¡€çš„è®¡ç®—å™¨åè®®ï¼Œè¿™ä¸ªåè®®çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨telnetå°±æ¨¡æ‹Ÿå‡ºè¯·æ±‚ï¼Œæ— éœ€å†™ä¸€ä¸ªtcpå®¢æˆ·ç«¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x æ“ä½œç¬¦ y#</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªåè®®ä¸­ï¼Œæ¯ä¸ªæœ‰æ•ˆæ•°æ®ä¸­éƒ½ä¼šå¸¦ä¸Šä¸€ä¸ªç©ºæ ¼ï¼Œå¹¶ä»¥<code>#</code>ä½œä¸ºå•ä¸ªæŠ¥æ–‡çš„ç»“å°¾ï¼›</p><p>å“åº”å’Œè¯·æ±‚çš„ç»“æ„ä½“æ ¼å¼ä¹Ÿéå¸¸ç®€å•ï¼Œå“åº”é‡Œé¢æ˜¯çŠ¶æ€ç å’Œè®¡ç®—ç»“æœï¼›æˆ‘ä»¬åœ¨åè®®ä¸­æ·»åŠ åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‡½æ•°å°±å¯ä»¥å°†å“åº”å’Œè¯·æ±‚ç»“æ„ä½“è½¬æˆå­—ç¬¦ä¸²</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Request</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">char</span> op;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> code;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEP <span class="string">&#x27;#&#x27;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SEP_LEN sizeof(SEP)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRLF <span class="string">&quot;\r\n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRLF_LEN strlen(CRLF)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPACE <span class="string">&quot; &quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPACE_LEN strlen(SPACE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†ç¦»ç‹¬ç«‹æŠ¥æ–‡</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">PackageSplit</span><span class="params">(std::string &amp;inbuffer, std::vector&lt;std::string&gt; *result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="type">size_t</span> pos = inbuffer.<span class="built_in">find</span>(SEP);</span><br><span class="line">        <span class="keyword">if</span> (pos == std::string::npos)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        result-&gt;<span class="built_in">push_back</span>(inbuffer.<span class="built_in">substr</span>(<span class="number">0</span>, pos));</span><br><span class="line">        inbuffer.<span class="built_in">erase</span>(<span class="number">0</span>, pos + SEP_LEN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Request</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    <span class="type">int</span> y;</span><br><span class="line">    <span class="type">char</span> op;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Response</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> code;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Parser</span><span class="params">(std::string &amp;in, Request *req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 1 + 1, 2 * 4, 5 * 9, 6 *1</span></span><br><span class="line">    std::<span class="type">size_t</span> spaceOne = in.<span class="built_in">find</span>(SPACE);</span><br><span class="line">    <span class="keyword">if</span> (std::string::npos == spaceOne)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    std::<span class="type">size_t</span> spaceTwo = in.<span class="built_in">rfind</span>(SPACE);</span><br><span class="line">    <span class="keyword">if</span> (std::string::npos == spaceTwo)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    std::string dataOne = in.<span class="built_in">substr</span>(<span class="number">0</span>, spaceOne);</span><br><span class="line">    std::string dataTwo = in.<span class="built_in">substr</span>(spaceTwo + SPACE_LEN);</span><br><span class="line">    std::string oper = in.<span class="built_in">substr</span>(spaceOne + SPACE_LEN, spaceTwo - (spaceOne + SPACE_LEN));</span><br><span class="line">    <span class="keyword">if</span> (oper.<span class="built_in">size</span>() != <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è½¬æˆå†…éƒ¨æˆå‘˜</span></span><br><span class="line">    req-&gt;x = <span class="built_in">atoi</span>(dataOne.<span class="built_in">c_str</span>());</span><br><span class="line">    req-&gt;y = <span class="built_in">atoi</span>(dataTwo.<span class="built_in">c_str</span>());</span><br><span class="line">    req-&gt;op = oper[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Serialize</span><span class="params">(<span class="type">const</span> Response &amp;resp, std::string *out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string ec = std::<span class="built_in">to_string</span>(resp.code);</span><br><span class="line">    std::string res = std::<span class="built_in">to_string</span>(resp.result);</span><br><span class="line"></span><br><span class="line">    *out = ec;</span><br><span class="line">    *out += SPACE;</span><br><span class="line">    *out += res;</span><br><span class="line">    *out += CRLF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>service.hpp</code>é‡Œé¢åˆ™æ˜¯æ•°æ®å¤„ç†çš„è®¡ç®—å‡½æ•°ï¼Œé€šè¿‡æˆ‘ä»¬ä¼ å…¥çš„è¯·æ±‚ï¼Œè®¡ç®—å‡ºç»“æ„å¹¶æ„é€ å“åº”è¿”å›ç»™ç”¨æˆ·</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Protocol.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="type">service_t</span> = std::function&lt;<span class="built_in">Response</span> (<span class="type">const</span> Request &amp;req)&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> Response <span class="title">calculator</span><span class="params">(<span class="type">const</span> Request &amp;req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Response resp = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">switch</span> (req.op)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">        resp.result = req.x + req.y;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">        resp.result = req.x - req.y;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">        resp.result = req.x * req.y;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">    &#123; <span class="comment">// x_ / y_</span></span><br><span class="line">        <span class="keyword">if</span> (req.y == <span class="number">0</span>)</span><br><span class="line">            resp.code = <span class="number">-1</span>; <span class="comment">// -1. é™¤0</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            resp.result = req.x / req.y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">    &#123; <span class="comment">// x_ / y_</span></span><br><span class="line">        <span class="keyword">if</span> (req.y == <span class="number">0</span>)</span><br><span class="line">            resp.code = <span class="number">-2</span>; <span class="comment">// -2. æ¨¡0</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            resp.result = req.x % req.y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        resp.code = <span class="number">-3</span>; <span class="comment">// -3: éæ³•æ“ä½œç¬¦</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> resp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-2-7-æµ‹è¯•"><a href="#6-2-7-æµ‹è¯•" class="headerlink" title="6.2.7 æµ‹è¯•"></a>6.2.7 æµ‹è¯•</h3><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„æœåŠ¡å¯åŠ¨äº†ä¹‹åï¼ŒæˆåŠŸæ¥æ”¶äº†ä¸€ä¸ªé“¾æ¥ï¼Œå¹¶è®¡ç®—å‡ºäº†æˆ‘ä»¬å‘é€çš„ç»“æœ</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/5e164406ab4e280265a7fcd8fdc3de67.png" alt="image-20230828115411040"></p><p>å¤šä¸ªé“¾æ¥ä¹Ÿä¸åœ¨è¯ä¸‹ï¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/58a989acdf95c2dc2c89a1677f8a4d56.png" alt="image-20230828115525101"></p><h1 id="The-end"><a href="#The-end" class="headerlink" title="The end"></a>The end</h1><p>å¤šè·¯è½¬æ¥è¿™éƒ¨åˆ†æ˜¯linuxæœåŠ¡å™¨æœ€é‡è¦çš„ä¸€éƒ¨åˆ†çŸ¥è¯†ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æœåŠ¡å™¨éƒ½æŠ›å¼ƒäº†æœ€ä¼ ç»Ÿçš„ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªé“¾æ¥è¿™æ ·çš„æ–¹å¼ï¼Œè€Œé‡‡ç”¨äº†å¤šè·¯è½¬æ¥æ¥å®ç°å¯¹å¤§é‡è¿›ç¨‹çš„ç»´æŠ¤ï¼›</p><p>æœ¬æ–‡æ˜¯å­¦ä¹ é˜¶æ®µçš„äº§ç‰©ï¼Œæœ‰é”™è¯¯åœ¨æ‰€éš¾å…ï¼Œè¯·å¤§ä½¬ä»¬æŒ‡æ•™ï¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/08/56eecd58cac3b6593f83998c9f30eb4b.gif" alt="QQå›¾ç‰‡20220413084241"></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">æ…•é›ªå¹´å</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/3390191280/">https://blog.musnow.top/posts/3390191280/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://blog.musnow.top" target="_blank">æ…•é›ªçš„å¯’èˆ</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://img.musnow.top/i/2023/08/748d3a20ba69bb3b3671f5b344cba650.png" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.staticfile.org/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.staticfile.org/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://afdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.png" alt="çˆ±å‘ç”µ"></a><div class="post-qr-code-desc">çˆ±å‘ç”µ</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/73383828/" title="ã€APIã€‘APIçš„å„ç§åˆ†ç±»è¯¦è§£"><img class="cover" src="/img/bg/gm17.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ã€APIã€‘APIçš„å„ç§åˆ†ç±»è¯¦è§£</div></div></a></div><div class="next-post pull-right"><a href="/posts/2628258650/" title="ã€C++ã€‘æ„é€ å‡½æ•°å’Œåˆå§‹åŒ–åˆ—è¡¨çš„æ€§èƒ½å·®è·"><img class="cover" src="/img/bg/gm10.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ã€C++ã€‘æ„é€ å‡½æ•°å’Œåˆå§‹åŒ–åˆ—è¡¨çš„æ€§èƒ½å·®è·</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/656771008/" title="ã€Linuxã€‘ä½¿ç”¨è…¾è®¯äº‘æ­å»ºCentOSçš„Linuxç¼–ç¨‹å­¦ä¹ ç¯å¢ƒï¼Œå®ç°å¤šç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªäº‘æœåŠ¡å™¨"><img class="cover" src="/img/bg/gm6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-06</div><div class="title">ã€Linuxã€‘ä½¿ç”¨è…¾è®¯äº‘æ­å»ºCentOSçš„Linuxç¼–ç¨‹å­¦ä¹ ç¯å¢ƒï¼Œå®ç°å¤šç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ªäº‘æœåŠ¡å™¨</div></div></a></div><div><a href="/posts/3785030062/" title="ã€Linuxã€‘è¿›ç¨‹æ¦‚å¿µ"><img class="cover" src="/img/bg/gm24.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-31</div><div class="title">ã€Linuxã€‘è¿›ç¨‹æ¦‚å¿µ</div></div></a></div><div><a href="/posts/977518181/" title="ã€Linuxã€‘ç¯å¢ƒå˜é‡"><img class="cover" src="/img/bg/gm18.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-05</div><div class="title">ã€Linuxã€‘ç¯å¢ƒå˜é‡</div></div></a></div></div></div><hr class="custom-hr"><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/favicon.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">æ…•é›ªå¹´å</div><div class="author-info__description">çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">293</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">73</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="ä¸ªäººä¸»é¡µ"><i class="fas fa-globe-asia"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="å¯¼èˆªç«™ç‚¹"><i class="fas fa-server"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æ¬¢è¿æ¥åˆ°å¯’èˆ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E9%AB%98%E7%BA%A7IO"><span class="toc-text">1.é«˜çº§IO</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E4%BA%94%E7%A7%8DIO%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.1 äº”ç§IOæ¨¡å‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%98%BB%E5%A1%9E%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-text">1.2 é˜»å¡å’Œéé˜»å¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%BC%82%E6%AD%A5%E4%B8%8E%E5%90%8C%E6%AD%A5%E9%80%9A%E4%BF%A1"><span class="toc-text">1.3 å¼‚æ­¥ä¸åŒæ­¥é€šä¿¡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-fcntl"><span class="toc-text">2.fcntl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%8E%A5%E5%8F%A3"><span class="toc-text">2.1 æ¥å£</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E8%AE%BE%E7%BD%AE%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-text">2.2 è®¾ç½®éé˜»å¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-stdin%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3 stdinæµ‹è¯•</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5%E4%B9%8Bselect"><span class="toc-text">3.å¤šè·¯è½¬æ¥ä¹‹select</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E8%AE%A4%E8%AF%86select"><span class="toc-text">3.1 è®¤è¯†select</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-timeval"><span class="toc-text">3.1.1 timeval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2-fd-set"><span class="toc-text">3.1.2 fd_set</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3-nfds"><span class="toc-text">3.1.3 nfds</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-text">3.1.4 è¿”å›å€¼</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E5%AE%9E%E4%BE%8B"><span class="toc-text">3.2 å®ä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-socket"><span class="toc-text">3.2.1 socket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">3.2.2 åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3-%E7%9B%91%E5%90%AC"><span class="toc-text">3.2.3 ç›‘å¬</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4-%E6%89%8B%E8%84%9A%E6%9E%B6%E6%B5%8B%E8%AF%95"><span class="toc-text">3.2.4 æ‰‹è„šæ¶æµ‹è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-5-%E5%A4%84%E7%90%86%E6%96%B0%E8%BF%9E%E6%8E%A5"><span class="toc-text">3.2.5 å¤„ç†æ–°è¿æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-6-%E5%A4%84%E7%90%86%E5%B7%B2%E6%9C%89%E9%93%BE%E6%8E%A5"><span class="toc-text">3.2.6 å¤„ç†å·²æœ‰é“¾æ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-7-%E5%AE%9E%E6%B5%8B"><span class="toc-text">3.2.7 å®æµ‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-socket%E5%B0%B1%E7%BB%AA%E6%9D%A1%E4%BB%B6"><span class="toc-text">3.3 socketå°±ç»ªæ¡ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-%E8%AF%BB%E5%B0%B1%E7%BB%AA"><span class="toc-text">3.3.1 è¯»å°±ç»ª</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-%E5%86%99%E5%B0%B1%E7%BB%AA"><span class="toc-text">3.3.2 å†™å°±ç»ª</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-%E5%BC%82%E5%B8%B8%E5%B0%B1%E7%BB%AA"><span class="toc-text">3.3.3 å¼‚å¸¸å°±ç»ª</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-select%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-text">3.4 selectçš„ç‰¹ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E5%A4%9A%E8%B7%AF%E8%BD%AC%E6%8E%A5%E4%B9%8Bpoll"><span class="toc-text">4.å¤šè·¯è½¬æ¥ä¹‹poll</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B"><span class="toc-text">4.1 å‡½æ•°åŸå‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1-%E5%8F%82%E6%95%B0"><span class="toc-text">4.1.1 å‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2-%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-text">4.1.2 è¿”å›å€¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3-%E4%BA%8B%E4%BB%B6"><span class="toc-text">4.1.3 äº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-poll%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">4.2 pollä¼˜ç¼ºç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E4%BC%98%E7%82%B9"><span class="toc-text">4.2.1 ä¼˜ç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-%E7%BC%BA%E7%82%B9"><span class="toc-text">4.2.2 ç¼ºç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E7%9C%8B%E7%9C%8B%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-text">4.3 çœ‹çœ‹ç¤ºä¾‹ä»£ç </span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-epoll"><span class="toc-text">5.epoll</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%8E%A5%E5%8F%A3"><span class="toc-text">5.1 æ¥å£</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-epoll-create"><span class="toc-text">5.1.1 epoll_create</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-epoll-ctl"><span class="toc-text">5.1.2 epoll_ctl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-text">äº‹ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-epoll-wait"><span class="toc-text">5.1.3 epoll_wait</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">5.2 å·¥ä½œåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8B%E6%B5%81%E7%A8%8B"><span class="toc-text">5.2.1 ä»æºç çœ‹æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-PSH%E6%A0%87%E8%AE%B0%E4%BD%8D"><span class="toc-text">5.2.2 PSHæ ‡è®°ä½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-epoll%E4%BC%98%E7%82%B9"><span class="toc-text">5.2.3 epollä¼˜ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-text">5.3 å·¥ä½œæ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E6%B0%B4%E5%B9%B3%E8%A7%A6%E5%8F%91-LT"><span class="toc-text">5.3.1 æ°´å¹³è§¦å‘ LT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E8%BE%B9%E7%BC%98%E8%A7%A6%E5%8F%91-ET"><span class="toc-text">5.3.2 è¾¹ç¼˜è§¦å‘ ET</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-LT%E5%92%8CET%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">5.3.3 LTå’ŒETçš„åŒºåˆ«</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-4-ET%E5%92%8C%E9%9D%9E%E9%98%BB%E5%A1%9E"><span class="toc-text">5.3.4 ETå’Œéé˜»å¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-5-epoll%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">5.3.5 epollçš„ä½¿ç”¨åœºæ™¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94"><span class="toc-text">5.4 æƒŠç¾¤æ•ˆåº”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-%E6%A6%82%E5%BF%B5"><span class="toc-text">5.4.1 æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-text">5.4.2 å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è§£å†³åŠæ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8B%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-text">5.4.3 å¤šè¿›ç¨‹ä¸‹è§£å†³åŠæ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-4-%E5%86%85%E6%A0%B8%E8%A7%A3%E5%86%B3%E4%BA%86%E6%83%8A%E7%BE%A4%E6%95%88%E5%BA%94%E4%BA%86%E5%90%97"><span class="toc-text">5.4.4 å†…æ ¸è§£å†³äº†æƒŠç¾¤æ•ˆåº”äº†å—</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Reactor%E6%A8%A1%E5%9E%8B"><span class="toc-text">6.Reactoræ¨¡å‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BB%80%E4%B9%88%E6%98%AFReactor%EF%BC%9F"><span class="toc-text">6.1 ä»€ä¹ˆæ˜¯Reactorï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-1-%E4%B8%BB%E4%BB%8EReactor%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-text">6.1.1 ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-2-%E5%8D%95Reactor%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">6.1.2 å•Reactorå¤šçº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-3-%E5%8D%95Reactor%E5%8D%95%E7%BA%BF%E7%A8%8B"><span class="toc-text">6.1.3 å•Reactorå•çº¿ç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-4-%E6%80%BB%E7%BB%93"><span class="toc-text">6.1.4 æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">6.2 ä»£ç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-1-Epoller-hpp"><span class="toc-text">6.2.1 Epoller.hpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-2-Sock-hpp"><span class="toc-text">6.2.2 Sock.hpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-3-Log-hpp"><span class="toc-text">6.2.3 Log.hpp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-4-TcpServer"><span class="toc-text">6.2.4 TcpServer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Connection%E7%B1%BB"><span class="toc-text">1.Connectionç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-TcpServer%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="toc-text">2.TcpServeræˆå‘˜å˜é‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9E%84%E9%80%A0"><span class="toc-text">3.æ„é€ </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B7%BB%E5%8A%A0%E9%93%BE%E6%8E%A5"><span class="toc-text">4.æ·»åŠ é“¾æ¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%9E%90%E6%9E%84"><span class="toc-text">5.ææ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E8%8E%B7%E5%8F%96%E6%96%B0%E8%BF%9E%E6%8E%A5Accept"><span class="toc-text">6.è·å–æ–°è¿æ¥Accept</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E9%93%BE%E6%8E%A5%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-text">7.é“¾æ¥çš„äº‹ä»¶å¤„ç†å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB"><span class="toc-text">è¯»</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%99"><span class="toc-text">å†™</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8"><span class="toc-text">å¼‚å¸¸</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E8%BF%90%E8%A1%8C"><span class="toc-text">8.è¿è¡Œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-5-%E4%B8%BB%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-text">6.2.5 ä¸»æ‰§è¡Œæµ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-6-%E5%8D%8F%E8%AE%AE%E5%92%8C%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">6.2.6 åè®®å’Œæ•°æ®å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-7-%E6%B5%8B%E8%AF%95"><span class="toc-text">6.2.7 æµ‹è¯•</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-end"><span class="toc-text">The end</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/3894841472/" title="ã€Hexoã€‘åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ·»åŠ ç©ºæ ¼"><img src="/img/bg/gm12.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Hexoã€‘åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ·»åŠ ç©ºæ ¼"></a><div class="content"><a class="title" href="/posts/3894841472/" title="ã€Hexoã€‘åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ·»åŠ ç©ºæ ¼">ã€Hexoã€‘åœ¨ä¸­è‹±æ–‡ä¹‹é—´æ·»åŠ ç©ºæ ¼</a><time datetime="2023-12-10T07:32:14.000Z" title="å‘è¡¨äº 2023-12-10 15:32:14">2023-12-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3528013149/" title="ã€Nginxã€‘NGINX é…ç½®é¿å… IP è®¿é—®æ—¶è¯ä¹¦æš´éœ²åŸŸå"><img src="https://img.musnow.top/i/2023/12/035ad572d3638bb917c07e53e24c9575.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Nginxã€‘NGINX é…ç½®é¿å… IP è®¿é—®æ—¶è¯ä¹¦æš´éœ²åŸŸå"></a><div class="content"><a class="title" href="/posts/3528013149/" title="ã€Nginxã€‘NGINX é…ç½®é¿å… IP è®¿é—®æ—¶è¯ä¹¦æš´éœ²åŸŸå">ã€Nginxã€‘NGINX é…ç½®é¿å… IP è®¿é—®æ—¶è¯ä¹¦æš´éœ²åŸŸå</a><time datetime="2023-12-09T09:12:55.000Z" title="å‘è¡¨äº 2023-12-09 17:12:55">2023-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2029711168/" title="ã€Nginxã€‘nginxé€šè¿‡é…ç½®æ–‡ä»¶é˜»æ­¢æµ·å¤–ipè®¿é—®"><img src="/img/bg/gm18.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Nginxã€‘nginxé€šè¿‡é…ç½®æ–‡ä»¶é˜»æ­¢æµ·å¤–ipè®¿é—®"></a><div class="content"><a class="title" href="/posts/2029711168/" title="ã€Nginxã€‘nginxé€šè¿‡é…ç½®æ–‡ä»¶é˜»æ­¢æµ·å¤–ipè®¿é—®">ã€Nginxã€‘nginxé€šè¿‡é…ç½®æ–‡ä»¶é˜»æ­¢æµ·å¤–ipè®¿é—®</a><time datetime="2023-12-09T08:12:55.000Z" title="å‘è¡¨äº 2023-12-09 16:12:55">2023-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3595872827/" title="ã€å›¾åºŠã€‘åˆ é™¤å¯¹è±¡å­˜å‚¨æ¡¶å‰ä¸€å®šè¦æ£€æŸ¥ï¼"><img src="/img/bg/gm13.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€å›¾åºŠã€‘åˆ é™¤å¯¹è±¡å­˜å‚¨æ¡¶å‰ä¸€å®šè¦æ£€æŸ¥ï¼"></a><div class="content"><a class="title" href="/posts/3595872827/" title="ã€å›¾åºŠã€‘åˆ é™¤å¯¹è±¡å­˜å‚¨æ¡¶å‰ä¸€å®šè¦æ£€æŸ¥ï¼">ã€å›¾åºŠã€‘åˆ é™¤å¯¹è±¡å­˜å‚¨æ¡¶å‰ä¸€å®šè¦æ£€æŸ¥ï¼</a><time datetime="2023-12-09T02:32:14.000Z" title="å‘è¡¨äº 2023-12-09 10:32:14">2023-12-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/bg/mothra.png)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2023 By æ…•é›ªå¹´å</div><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="https://img.shields.io/badge/-SITEMAP-00CDCD" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="https://img.shields.io/badge/%E7%B2%A4ICP%E5%A4%872023007189-red" height="20px"></a><br><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="https://img.foreverblog.cn/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/img/ico/upyun_cdn_w.png" height="25px"></a><a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.staticfile.org/hexo-theme-butterfly/4.9.0/js/utils.min.js"></script><script src="https://cdn.staticfile.org/hexo-theme-butterfly/4.9.0/js/main.min.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.staticfile.org/vanilla-lazyload/17.8.3/lazyload.iife.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.staticfile.org/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>function loadArtalk () {
  function initArtalk () {
    window.artalkItem = new Artalk(Object.assign({
      el: '#artalk-wrap',
      server: 'https://artk.musnow.top',
      site: 'mublog',
      pageKey: location.pathname,
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      countEl: '.artalk-count'
    },null))

    if (GLOBAL_CONFIG.lightbox === 'null') return
    window.artalkItem.use(ctx => {
      ctx.on('list-loaded', () => {
        ctx.getCommentList().forEach(comment => {
          const $content = comment.getRender().$content
          btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
        })
      })
    })
  }

  if (typeof window.artalkItem === 'object') initArtalk()
  else {
    getCSS('https://cdn.staticfile.org/artalk/2.5.5/Artalk.min.css').then(()=>{
      getScript('https://cdn.staticfile.org/artalk/2.5.5/Artalk.min.js').then(initArtalk)
    })
  }
}

function artalkChangeMode (theme) {
  const artalkWrap = document.getElementById('artalk-wrap')
  if (!(artalkWrap && artalkWrap.children.length)) return
  const isDark = theme === 'dark'
  window.artalkItem.setDarkMode(isDark)
}

btf.addModeChange('artalk', artalkChangeMode)

if ('Artalk' === 'Artalk' || !false) {
  if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
  else loadArtalk()
} else {
  function loadOtherComment () {
    loadArtalk()
  }
}</script></div><script id="click-heart" src="https://cdn.staticfile.org/butterfly-extsrc/1.1.3/click-heart.min.js" async mobile="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdn.staticfile.org/hexo-theme-butterfly/4.9.0/js/search/local-search.min.js"></script></div></div></body></html>