<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>【MCP】了解远程MCP调用背后使用的SSE协议 | 慕雪的寒舍</title><meta name="author" content="慕雪年华"><meta name="copyright" content="慕雪年华"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本文介绍了远程MCP使用的SSE协议，通过wireshark抓包的方式了解MCP客户端和服务端之间通过SSE协议交互涉及到的请求与响应。">
<meta property="og:type" content="article">
<meta property="og:title" content="【MCP】了解远程MCP调用背后使用的SSE协议">
<meta property="og:url" content="https://blog.musnow.top/posts/2725694758/index.html">
<meta property="og:site_name" content="慕雪的寒舍">
<meta property="og:description" content="本文介绍了远程MCP使用的SSE协议，通过wireshark抓包的方式了解MCP客户端和服务端之间通过SSE协议交互涉及到的请求与响应。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp">
<meta property="article:published_time" content="2025-04-20T06:47:57.000Z">
<meta property="article:modified_time" content="2025-08-11T13:46:36.000Z">
<meta property="article:author" content="慕雪年华">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="MCP">
<meta property="article:tag" content="AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "【MCP】了解远程MCP调用背后使用的SSE协议",
  "url": "https://blog.musnow.top/posts/2725694758/",
  "image": "https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp",
  "datePublished": "2025-04-20T06:47:57.000Z",
  "dateModified": "2025-08-11T13:46:36.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "慕雪年华",
      "url": "https://blog.musnow.top/"
    }
  ]
}</script><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/2725694758/index.html"><link rel="preconnect"/><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"/><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"/><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/pluginsSrc/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":420,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":600,"languages":{"author":"作者: 慕雪年华","link":"链接: ","source":"来源: 慕雪的寒舍","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: '/pluginsSrc/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '【MCP】了解远程MCP调用背后使用的SSE协议',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/equipment/equipment.css?1"><link rel="stylesheet" href="/rating/rating.css?1"><script>var _hmt = _hmt || [];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?f444e8de702765e309d1a751aa12203e";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="慕雪的寒舍" type="application/atom+xml">
</head><body><div id="web_bg" style="background-image: url(/img/main/mothra.webp);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">451</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/rating/"><i class="fa-fw fas fa-film"></i><span> 书·影</span></a></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 朋友圈</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url(https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/favicon.jpg" alt="Logo"><span class="site-name">慕雪的寒舍</span></a><a class="nav-page-title" href="/"><span class="site-name">【MCP】了解远程MCP调用背后使用的SSE协议</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 归档</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/rating/"><i class="fa-fw fas fa-film"></i><span> 书·影</span></a></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> 留言</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-user-friends"></i><span> 友人</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></li><li><a class="site-page child" href="/fcircle/"><i class="fa-fw fas fa-link"></i><span> 朋友圈</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> 开往</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> 虫洞</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> 异次元</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-glass-whiskey"></i><span> 镜像</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnow.blog.csdn.net/"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fab fa-blackberry"></i><span> 更多</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> 画廊</span></a></li><li><a class="site-page child" href="/equipment/"><i class="fa-fw fas fa-laptop"></i><span> 背包</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> 说说</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li><li><a class="site-page child" href="/atom.xml"><i class="fa-fw fas fa-rss-square"></i><span> RSS</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">【MCP】了解远程MCP调用背后使用的SSE协议</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-20T06:47:57.000Z" title="发表于 2025-04-20 14:47:57">2025-04-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-08-11T13:46:36.000Z" title="更新于 2025-08-11 21:46:36">2025-08-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/">编程学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/Agent%E6%99%BA%E8%83%BD%E4%BD%93%E5%BC%80%E5%8F%91/">Agent智能体开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">7.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="ArtalkPV"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:180,&quot;messagePrev&quot;:&quot;距离上次更新本文已经过去了&quot;,&quot;messageNext&quot;:&quot;天，文章部分内容可能已经过时，请注意甄别。&quot;,&quot;postUpdate&quot;:&quot;2025-08-11 21:46:36&quot;}" hidden></div><p>本文介绍了远程MCP使用的SSE协议，通过wireshark抓包的方式了解MCP客户端和服务端之间通过SSE协议交互涉及到的请求与响应。</p>
<h2 id="1-什么是SSE协议？">1. 什么是SSE协议？</h2>
<blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/1894024642395619635">科普一下MCP时代重要的SSE协议</a>、<a target="_blank" rel="noopener" href="https://blog.csdn.net/aerror/article/details/146208818">关于MCP SSE 服务器的工作原理</a></p>
</blockquote>
<p>MCP的远程服务是通过SSE（Server-Sent Events）启动的，SSE是一个基于HTTP的长连接协议。SSE在逻辑上是一个由客户端发起、由服务器同意而建立的<strong>从服务器向客户端发消息的单向管道</strong>。这个管道建立之后，<strong>客户端给服务器发消息时用传统方式发</strong>，服务器给客户端发消息时用这个管道发，双方就可以灵活地进行通信了。</p>
<p>MCP SSE客户端会发起多个请求，第一个请求是<code>/sse</code>路径，这是建立SSE长连接的第一步。服务端会使用chunked方式来回传数据，每次不告诉客户端数据量有多少，让客户端保持连接始终联通，即维护了一个长连接。后续每一次服务端与客户端的通讯，都会采用事件字节数、事件名称event、data三个字段来通信（服务端发送给客户端）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">事件字节数（十六进制）</span><br><span class="line">event: 事件名称</span><br><span class="line">data: 事件数据</span><br><span class="line">&lt;这里一定会有一个空行，作为单个事件结束标志&gt;</span><br></pre></td></tr></table></figure>
<p>其中第一行是消息的字节数，以十六进制给出。从第二行event开始一直到data结束，都是这个事件字节数的长度范围内（不包括末尾的<code>\r\n</code>）</p>
<blockquote>
<p>2025.08.11 备注：在更新之前的博客中，第一行的<strong>事件字节数</strong>被我错误的理解为了不变的事件ID，在此对受误导的读者表示抱歉！感谢评论区网友的指正！</p>
</blockquote>
<h2 id="2-实际测试：运行MCP服务端和QwenAgent">2. 实际测试：运行MCP服务端和QwenAgent</h2>
<p>因为使用sse远程方式启动mcp服务端时是在本地回环地址启动的， 所以可以通过wireshark工具监听到我们本地客户端与服务端之间传输的请求与响应，通过这种方式来进一步了解mcp每一步都请求了什么，响应了什么。</p>
<p>首先是用sse模式启动我们的mcp服务端demo，也就是官方python sdk中的<code>mcp-python-sdk/examples/servers/simple-tool</code>，设置端口为8000。注意修改命令中<code>--directory</code>之后的路径为你电脑上<code>simple-tool</code>的正确路径。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uv run \</span><br><span class="line">    --directory mcp-python-sdk/examples/servers/simple-tool \</span><br><span class="line">    mcp-simple-tool \</span><br><span class="line">    --transport sse --port 8000</span><br></pre></td></tr></table></figure>
<p>然后再在wireshark里面监听<strong>本地回环</strong>地址，使用过滤器<code>tcp.port==8000</code>筛选出所有和8000端口有关的请求。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/960acbb8a0e910ffcaf90cfba3a6a669.webp" alt="image.png"></p>
<p>使用如下代码，运行一次QwenAgent，调用mcp工具。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qwen_agent.agents <span class="keyword">import</span> Assistant</span><br><span class="line"><span class="comment"># DEBUG模式，列出详细处理日志</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG, </span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>, </span><br><span class="line">                    filename=<span class="string">&#x27;app.log&#x27;</span>, </span><br><span class="line">                    filemode=<span class="string">&#x27;a&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_agent_service</span>():</span><br><span class="line">    llm_cfg = &#123;</span><br><span class="line">        <span class="string">&#x27;model&#x27;</span>: <span class="string">&#x27;Qwen/Qwen2.5-32B-Instruct&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;model_server&#x27;</span>: <span class="string">&#x27;https://api.siliconflow.cn/v1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;api_key&#x27;</span>: <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    system = (<span class="string">&#x27;你是一个强大的助手，可以帮用户处理问题。&#x27;</span>)</span><br><span class="line">    tools = [&#123;</span><br><span class="line">        <span class="string">&quot;mcpServers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;exmaple-server&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:8000/sse&quot;</span>,</span><br><span class="line">                <span class="string">&quot;disabled&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;timeout&quot;</span>: <span class="number">30</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">    bot = Assistant(</span><br><span class="line">        llm=llm_cfg,</span><br><span class="line">        name=<span class="string">&#x27;网页查看助手&#x27;</span>,</span><br><span class="line">        description=<span class="string">&#x27;网页查看&#x27;</span>,</span><br><span class="line">        system_message=system,</span><br><span class="line">        function_list=tools,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bot</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">text=<span class="string">&#x27;这个网站是什么？https://blog.musnow.top/&#x27;</span></span>):</span><br><span class="line">    bot = init_agent_service()</span><br><span class="line">    messages = [&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: text&#125;]</span><br><span class="line">    <span class="comment"># 请求</span></span><br><span class="line">    <span class="keyword">for</span> response <span class="keyword">in</span> bot.run(messages):</span><br><span class="line">        logging.info(<span class="string">&#x27;bot response: &#x27;</span> + <span class="built_in">str</span>(response)) <span class="comment"># 这里也用logging打印</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>MCP服务端服务端的日志中会出现下面五条请求记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">❯ uv run --directory /Users/mothra/data/code/python/openai/mcp-python-sdk/examples/servers/simple-tool mcp-simple-tool --transport sse --port 8000</span><br><span class="line">start server sse</span><br><span class="line">INFO:     Started server process [87086]</span><br><span class="line">INFO:     Waiting for application startup.</span><br><span class="line">INFO:     Application startup complete.</span><br><span class="line">INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)</span><br><span class="line">INFO:     127.0.0.1:49652 - &quot;GET /sse HTTP/1.1&quot; 200 OK</span><br><span class="line">INFO:     127.0.0.1:49654 - &quot;POST /?session_id=b53301ca408f4da4a12562ce2fde23de HTTP/1.1&quot; 202 Accepted</span><br><span class="line">INFO:     127.0.0.1:49656 - &quot;POST /?session_id=b53301ca408f4da4a12562ce2fde23de HTTP/1.1&quot; 202 Accepted</span><br><span class="line">INFO:     127.0.0.1:49658 - &quot;POST /?session_id=b53301ca408f4da4a12562ce2fde23de HTTP/1.1&quot; 202 Accepted</span><br><span class="line">INFO:     127.0.0.1:49668 - &quot;POST /?session_id=b53301ca408f4da4a12562ce2fde23de HTTP/1.1&quot; 202 Accepted</span><br></pre></td></tr></table></figure>
<h2 id="3-分析wireshark抓包结果">3. 分析wireshark抓包结果</h2>
<h3 id="3-1-第一条请求：-SSE">3.1. 第一条请求：/SSE</h3>
<p>首先在wireshark中找到第一条sse请求，在wireshark中能清晰的看到客户端从49652端口向8000端口发起<strong>TCP三次握手</strong>的记录。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/69148f26b67e74bd190c98224b0e15e9.webp" alt="image.png"></p>
<p>客户端发起的<code>/sse</code>接口的请求报文如下，没有什么特别的</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/sse</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-httpx/0.28.1</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/event-stream</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-store</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>服务端的响应如下，这一串响应是在两个tcp报文中发出的，下图中用紫色荧光笔标注len不为0的就是服务端发出的两个报文。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp" alt="image.png"></p>
<blockquote>
<p><strong>注意</strong>：这里的HTTP响应报文是一个chunked类型的，也就是这一条HTTP响应报文后续还一直会有其他内容（服务端和客户端之间的管道），直到客户端和服务端的交互结束了，这一条HTTP响应报文才算完整结束！</p>
</blockquote>
<p>这两个报文的内容拼接起来如下，为了更直观的展示HTTP报文格式，这里将HTTP协议的<code>\r\n</code>换行符也人工标识出来。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK\r\n</span><br><span class="line"><span class="attribute">date</span><span class="punctuation">: </span>Sun, 20 Apr 2025 06:00:38 GMT\r\n</span><br><span class="line"><span class="attribute">server</span><span class="punctuation">: </span>uvicorn\r\n</span><br><span class="line"><span class="attribute">cache-control</span><span class="punctuation">: </span>no-cache\r\n</span><br><span class="line"><span class="attribute">connection</span><span class="punctuation">: </span>keep-alive\r\n</span><br><span class="line"><span class="attribute">x-accel-buffering</span><span class="punctuation">: </span>no\r\n</span><br><span class="line"><span class="attribute">content-type</span><span class="punctuation">: </span>text/event-stream; charset=utf-8\r\n</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked\r\n</span><br><span class="line">\r\n</span><br><span class="line">51\r\n</span><br><span class="line"><span class="attribute">event</span><span class="punctuation">: </span>endpoint\r\n</span><br><span class="line"><span class="attribute">data</span><span class="punctuation">: </span>/messages/?session_id=b53301ca408f4da4a12562ce2fde23de\r\n</span><br><span class="line">\r\n\r\n</span><br></pre></td></tr></table></figure>
<p>这里便是服务端发出的第一个SSE协议事件数据了。其中：</p>
<ul>
<li>事件字节数是十六进制的51（十进制81，是从event开始一直到data结束共81字节）；</li>
<li>事件名称是endpoint（告诉客户端后续需要请求的接口路径是啥）‘</li>
<li>事件内容就是endpoint的具体值了。</li>
</ul>
<p>在data之后还额外出现了两个<code>\r\n</code>，这便是单个事件的结束标志。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">51</span><br><span class="line"><span class="attribute">event</span><span class="punctuation">: </span>endpoint</span><br><span class="line"><span class="attribute">data</span><span class="punctuation">: </span>/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span><br><span class="line">&lt;空行&gt;</span><br></pre></td></tr></table></figure>
<p>这个endpoint响应就是告诉客户端，后续的请求全都要使用<code>/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</code>这个路径来发起，这个路径中包含本次会话的session id，客户端使用这个路径，服务端就能够知道要在哪一个管道里面向客户端发回结果。</p>
<p>在QwenAgent的debug日志中（底层mcp交互用的是httpx库）也能观察到这个事件，客户端收到了服务端提供的endpoint URL。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 14:32:01,570 - INFO - HTTP Request: GET http://127.0.0.1:8000/sse &quot;HTTP/1.1 200 OK&quot;</span><br><span class="line">2025-04-20 14:32:01,570 - DEBUG - SSE connection established</span><br><span class="line">2025-04-20 14:32:01,570 - DEBUG - receive_response_body.started request=&lt;Request [b&#x27;GET&#x27;]&gt;</span><br><span class="line">2025-04-20 14:32:01,570 - DEBUG - Received SSE event: endpoint</span><br><span class="line">2025-04-20 14:32:01,570 - INFO - Received endpoint URL: http://127.0.0.1:8000/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span><br></pre></td></tr></table></figure>
<h3 id="3-2-第二条请求：初始化">3.2. 第二条请求：初始化</h3>
<p>第二条客户端的请求如下，这里已经开始使用服务端刚刚返回的endpoint了。请求体部分是json格式的内容，initialize代表是初始化MCP客户端，告诉服务端当前客户端使用的协议版本protocolVersion、支持的能力capabilities、jsonrpc版本等等信息</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-httpx/0.28.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>194</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/event-stream</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;initialize&quot;</span><span class="punctuation">,</span><span class="attr">&quot;params&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;protocolVersion&quot;</span><span class="punctuation">:</span><span class="string">&quot;2024-11-05&quot;</span><span class="punctuation">,</span><span class="attr">&quot;capabilities&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;sampling&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;roots&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;listChanged&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;clientInfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;mcp&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.1.0&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>针对这次请求，服务端发回的响应就比较简单了，一个Accepted告诉客户端他的请求已经被接受了，并没有返回实际性的内容。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">date</span><span class="punctuation">: </span>Sun, 20 Apr 2025 06:00:38 GMT</span><br><span class="line"><span class="attribute">server</span><span class="punctuation">: </span>uvicorn</span><br><span class="line"><span class="attribute">content-length</span><span class="punctuation">: </span>8</span><br><span class="line"></span><br><span class="line"><span class="language-ebnf"><span class="attribute">Accepted</span></span></span><br></pre></td></tr></table></figure>
<p>这正是前文提到过的SSE协议的特性，服务端传回的数据不会使用HTTP响应直接传回，<strong>而是会在第一次/sse请求后建立的长连接管道里面传回</strong>！上述响应只是针对客户端的POST请求，依照HTTP协议的要求发出的而已（HTTP要求每一个req都需要有一个res）</p>
<p>如下图所示，在服务端返回Accepted响应之后，就能观察到一个服务端向客户端发出的len不为0的TCP报文，这个报文中就包含了服务端针对客户端这次发起的初始化请求的实际事件响应。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/7a567ad3ca62c706b0d93587ea3212a9.webp" alt="image.png"></p>
<p>这个报文的内容如下，e9是当前消息的长度（十进制233），event事件名称是一个message，data中就包含了服务端对这次初始化请求的响应，返回了服务端的jsonrpc版本、支持的协议版本protocolVersion、支持的能力capabilities、服务端的信息serverInfo。</p>
<p>同样的，这里也是额外出现了两个<code>\r\n</code>作为事件结束标志。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e9\r\n</span><br><span class="line"><span class="attribute">event</span><span class="punctuation">: </span>message\r\n</span><br><span class="line"><span class="attribute">data</span><span class="punctuation">: </span>&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;result&quot;:&#123;&quot;protocolVersion&quot;:&quot;2024-11-05&quot;,&quot;capabilities&quot;:&#123;&quot;experimental&quot;:&#123;&#125;,&quot;tools&quot;:&#123;&quot;listChanged&quot;:false&#125;&#125;,&quot;serverInfo&quot;:&#123;&quot;name&quot;:&quot;mcp-website-fetcher&quot;,&quot;version&quot;:&quot;1.6.1.dev14+babb477&quot;&#125;&#125;&#125;\r\n</span><br><span class="line">\r\n\r\n</span><br></pre></td></tr></table></figure>
<h3 id="3-3-第三条请求：初始化成功告知">3.3. 第三条请求：初始化成功告知</h3>
<p>第三条请求就是客户端告诉服务端自己已经准备好了，初始化成功initialized。同样会有一对POST和Accepted的HTTP请求，这里不再赘述</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-httpx/0.28.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>54</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/event-stream</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;notifications/initialized&quot;</span><span class="punctuation">,</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">date</span><span class="punctuation">: </span>Sun, 20 Apr 2025 06:00:38 GMT</span><br><span class="line"><span class="attribute">server</span><span class="punctuation">: </span>uvicorn</span><br><span class="line"><span class="attribute">content-length</span><span class="punctuation">: </span>8</span><br><span class="line"></span><br><span class="line"><span class="language-ebnf"><span class="attribute">Accepted</span></span></span><br></pre></td></tr></table></figure>
<p>从抓包结果中可以看到，这一条请求到下一条请求之间没有服务端向客户端发出len不为0的TCP报文，因为这一次请求只是客户端告知服务端自己已经准备好了，服务端没必要额外返回任何信息。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/7629117d0ef69dbcbf91511e93b6d3dc.webp" alt="image.png"></p>
<h3 id="3-4-第四条请求：请求工具列表">3.4. 第四条请求：请求工具列表</h3>
<p>第四条请求就是客户端向服务端请求服务端提供的工具列表了</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-httpx/0.28.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>46</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/event-stream</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;tools/list&quot;</span><span class="punctuation">,</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>服务端照常进行了Accepted响应</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">202</span> Accepted</span><br><span class="line"><span class="attribute">date</span><span class="punctuation">: </span>Sun, 20 Apr 2025 06:00:38 GMT</span><br><span class="line"><span class="attribute">server</span><span class="punctuation">: </span>uvicorn</span><br><span class="line"><span class="attribute">content-length</span><span class="punctuation">: </span>8</span><br><span class="line"></span><br><span class="line"><span class="language-ebnf"><span class="attribute">Accepted</span></span></span><br></pre></td></tr></table></figure>
<p>随后在管道里面发出的TCP报文中，就包含了服务端当前支持的工具，以及工具的参数和参数的类型与释义。这里第一行依旧是消息的十六进制字节数，109对应十进制265。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">109\r\n</span><br><span class="line"><span class="attribute">event</span><span class="punctuation">: </span>message\r\n</span><br><span class="line"><span class="attribute">data</span><span class="punctuation">: </span>&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:&#123;&quot;tools&quot;:[&#123;&quot;name&quot;:&quot;fetch&quot;,&quot;description&quot;:&quot;Fetches a website and returns its content&quot;,&quot;inputSchema&quot;:&#123;&quot;type&quot;:&quot;object&quot;,&quot;required&quot;:[&quot;url&quot;],&quot;properties&quot;:&#123;&quot;url&quot;:&#123;&quot;type&quot;:&quot;string&quot;,&quot;description&quot;:&quot;URL to fetch&quot;&#125;&#125;&#125;&#125;]&#125;&#125;\r\n</span><br><span class="line">\r\n\r\n</span><br></pre></td></tr></table></figure>
<p>从日志中看，QwenAgent会把这部分内容转换为prompt发送给AI，让AI来调用这个工具。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 14:32:01,637 - DEBUG - Request options: &#123;&#x27;method&#x27;: &#x27;post&#x27;, &#x27;url&#x27;: &#x27;/chat/completions&#x27;, &#x27;files&#x27;: None, &#x27;json_data&#x27;: &#123;&#x27;messages&#x27;: [&#123;&#x27;role&#x27;: &#x27;system&#x27;, &#x27;content&#x27;: &#x27;你是一个强大的助手，可以帮用户处理问题。\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:\n&lt;tools&gt;\n&#123;&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: &#123;&quot;name&quot;: &quot;exmaple-server-fetch&quot;, &quot;description&quot;: &quot;Fetches a website and returns its content&quot;, &quot;parameters&quot;: &#123;&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: &#123;&quot;url&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;URL to fetch&quot;&#125;&#125;, &quot;required&quot;: [&quot;url&quot;]&#125;&#125;&#125;\n&lt;/tools&gt;\n\nFor each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:\n&lt;tool_call&gt;\n&#123;&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;&#125;\n&lt;/tool_call&gt;&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;user&#x27;, &#x27;content&#x27;: &#x27;这个网站是什么？https://blog.musnow.top/&#x27;&#125;], &#x27;model&#x27;: &#x27;Qwen/Qwen2.5-32B-Instruct&#x27;, &#x27;seed&#x27;: 44742000, &#x27;stream&#x27;: True&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>其中上下文信息如下，可以看到这里并没有使用function call的请求格式，而是直接在system的prompt里把工具相关信息以XML格式发送给AI了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x27;messages&#x27;<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;role&#x27;<span class="punctuation">:</span></span><br><span class="line">        &#x27;system&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;content&#x27;<span class="punctuation">:</span></span><br><span class="line">        &#x27;你是一个强大的助手，可以帮用户处理问题。\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags<span class="punctuation">:</span>\n&lt;tools&gt;\n<span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;function&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;exmaple-server-fetch&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Fetches a website and returns its content&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;parameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;object&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;URL to fetch&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;required&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;url&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>\n&lt;/tools&gt;\n\nFor each function call<span class="punctuation">,</span> return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags<span class="punctuation">:</span>\n&lt;tool_call&gt;\n<span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> &lt;function-name&gt;<span class="punctuation">,</span> <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> &lt;args-json-object&gt;<span class="punctuation">&#125;</span>\n&lt;/tool_call&gt;&#x27;</span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">        &#x27;role&#x27;<span class="punctuation">:</span> &#x27;user&#x27;<span class="punctuation">,</span></span><br><span class="line">        &#x27;content&#x27;<span class="punctuation">:</span> &#x27;这个网站是什么？https<span class="punctuation">:</span><span class="comment">//blog.musnow.top/&#x27;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p>在输出的bot response中，能看到AI针对这个tools生成了请求参数，url参数的值也是正确的，和我们提出的问题保持了一致。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">t = [&#123;</span><br><span class="line">    <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;reasoning_content&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;网页查看助手&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;function_call&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;exmaple-server-fetch&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;arguments&#x27;</span>: <span class="string">&#x27;&#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="3-5-第五条请求：调用工具">3.5. 第五条请求：调用工具</h3>
<p>在日志中能观察到，在AI生成了包含function_call的响应之后，QwenAgent的SDK就开始准备调用远程MCP工具了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 15:32:49,370 - INFO - bot response: [&#123;&#x27;role&#x27;: &#x27;assistant&#x27;, &#x27;content&#x27;: &#x27;&#x27;, &#x27;reasoning_content&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;网页查看助手&#x27;, &#x27;function_call&#x27;: &#123;&#x27;name&#x27;: &#x27;exmaple-server-fetch&#x27;, &#x27;arguments&#x27;: &#x27;&#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#x27;&#125;&#125;]</span><br><span class="line">2025-04-20 15:32:49,370 - DEBUG - receive_response_body.complete</span><br><span class="line">2025-04-20 15:32:49,371 - DEBUG - response_closed.started</span><br><span class="line">2025-04-20 15:32:49,371 - DEBUG - response_closed.complete</span><br><span class="line">2025-04-20 15:32:49,373 - DEBUG - Sending client message: root=JSONRPCRequest(method=&#x27;tools/call&#x27;, params=&#123;&#x27;name&#x27;: &#x27;fetch&#x27;, &#x27;arguments&#x27;: &#123;&#x27;url&#x27;: &#x27;https://blog.musnow.top/&#x27;&#125;&#125;, jsonrpc=&#x27;2.0&#x27;, id=2)</span><br></pre></td></tr></table></figure>
<p>此时发起的请求如下，请求体中包含了需要请求的工具名称fetch，以及传输过来的参数arguments</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/messages/?session_id=b53301ca408f4da4a12562ce2fde23de</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>python-httpx/0.28.1</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>119</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/event-stream</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;method&quot;</span><span class="punctuation">:</span><span class="string">&quot;tools/call&quot;</span><span class="punctuation">,</span><span class="attr">&quot;params&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;fetch&quot;</span><span class="punctuation">,</span><span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;https://blog.musnow.top/&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;jsonrpc&quot;</span><span class="punctuation">:</span><span class="string">&quot;2.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure>
<p>服务端还是会返回一个accpet响应</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 202 Accepted</span><br><span class="line">date: Sun, 20 Apr 2025 06:00:39 GMT</span><br><span class="line">server: uvicorn</span><br><span class="line">content-length: 8</span><br><span class="line"></span><br><span class="line">Accepted</span><br></pre></td></tr></table></figure>
<p>随后，MCP服务端会根据这个请求，调用实际的工具，并最终返回结果。由于这个请求结果的content是慕雪个人博客首页的html源码，所以内容非常之大，这里就不贴出来完整的事件data了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f0bd</span><br><span class="line">event: message</span><br><span class="line">data: &#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:2,&quot;result&quot;:&#123;&quot;content&quot;:[&#123;&quot;type&quot;:&quot;text&quot;,&quot;text&quot;:&quot;&lt;!DOCTYPE html&gt;&lt;html lang=\&quot;zh-CN\&quot; data-theme=\&quot;light\&quot;&gt;&lt;head&gt;&lt;meta charset=\&quot;UTF-8\&quot;&gt;&lt;meta http-equiv=\&quot;X-UA-Compatible\&quot; content=\&quot;IE=edge\&quot;&gt;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1.0,viewport-fit=cover\&quot;&gt;&lt;title&gt;慕雪的寒舍 - 雪下了一夜&lt;/title&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到，服务端通过三次TCP报文才把整个首页的html完整传输给客户端。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/a529e0c2bae9294ce4903ef635dc112e.webp" alt="image.png"></p>
<p>到这里，针对<code>/sse</code>接口的HTTP响应就完整结束了，MCP服务端以tools调用结果返回为标志来结束HTTP响应。</p>
<p>在wireshark拼接出来的完整HTTP响应中可以观察到，tools调用结果的json完整结束了，这个HTTP响应就是结束了，<strong>随后便出现了TCP四次挥手的报文</strong>。其中调用工具的响应json末尾会包含一个字段<code>&quot;isErr&quot;</code>，应该是用于标识本次mcp工具调用是否成功的，为false代表调用成功。</p>
<p><img src= "/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2025/04/9d00d0ef699833554e935274a84bb4fb.webp" alt="image.png"></p>
<h3 id="3-6-工具调用结果交付AI处理">3.6. 工具调用结果交付AI处理</h3>
<p>在收到工具调用结果之后，日志中就能够观察到QwenAgent将这个工具调用结果拼接在prompt里面发送给AI了。这里我把html文档的内容全部删掉了，改成了“首页HTML内容”，保留了其他字段。</p>
<p>首先这里能看到完整的MCP服务端工具调用结果的响应，包含jsonrpc字段、id字段、result字段、isError字段。其中工具调用结果是在result/content里面返回的。</p>
<p>QwenAgent的SDK依旧是在消息上下文里面将MCP工具的响应结果通过<code>&lt;tool_response&gt;\n首页HTML内容\n&lt;/tool_response&gt;</code>的拼接了起来，以user身份发送给了AI。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 14:33:18,289 - DEBUG - Received SSE event: message</span><br><span class="line">2025-04-20 14:33:18,291 - DEBUG - Received server message: root=JSONRPCResponse(jsonrpc=&#x27;2.0&#x27;, id=2, result=&#123;&#x27;content&#x27;: [&#123;&#x27;type&#x27;: &#x27;text&#x27;, &#x27;text&#x27;: &#x27;首页HTML内容&#x27;&#125;], &#x27;isError&#x27;: False&#125;)</span><br><span class="line">2025-04-20 14:33:18,330 - DEBUG - Request options: &#123;&#x27;method&#x27;: &#x27;post&#x27;, &#x27;url&#x27;: &#x27;/chat/completions&#x27;, &#x27;files&#x27;: None, &#x27;json_data&#x27;: &#123;&#x27;messages&#x27;: [&#123;&#x27;role&#x27;: &#x27;system&#x27;, &#x27;content&#x27;: &#x27;你是一个强大的助手，可以帮用户处理问题。\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:\n&lt;tools&gt;\n&#123;&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: &#123;&quot;name&quot;: &quot;exmaple-server-fetch&quot;, &quot;description&quot;: &quot;Fetches a website and returns its content&quot;, &quot;parameters&quot;: &#123;&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: &#123;&quot;url&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;URL to fetch&quot;&#125;&#125;, &quot;required&quot;: [&quot;url&quot;]&#125;&#125;&#125;\n&lt;/tools&gt;\n\nFor each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:\n&lt;tool_call&gt;\n&#123;&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;&#125;\n&lt;/tool_call&gt;&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;user&#x27;, &#x27;content&#x27;: &#x27;这个网站是什么？https://blog.musnow.top/&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;assistant&#x27;, &#x27;content&#x27;: &#x27;&lt;tool_call&gt;\n&#123;&quot;name&quot;: &quot;exmaple-server-fetch&quot;, &quot;arguments&quot;: &#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#125;\n&lt;/tool_call&gt;&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;user&#x27;, &#x27;content&#x27;: &#x27;&lt;tool_response&gt;\n首页HTML内容\n&lt;/tool_response&gt;&#x27;&#125;], &#x27;model&#x27;: &#x27;Qwen/Qwen2.5-32B-Instruct&#x27;, &#x27;seed&#x27;: 181793637, &#x27;stream&#x27;: True&#125;&#125;</span><br><span class="line">2025-04-20 14:33:18,330 - DEBUG - Sending HTTP Request: POST https://api.siliconflow.cn/v1/chat/completions</span><br></pre></td></tr></table></figure>
<p>最终，AI理解并处理“首页HTML内容”，输出了回答</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;role&#x27;: &#x27;assistant&#x27;, &#x27;content&#x27;: &#x27;该网站名为&quot;慕雪的寒舍 - 雪下了一夜&quot;，由作者&quot;慕雪年华&quot;创建。该网站看起来是一个个人博客，包含了各种类型的文章，例如编程学习、博客建站等。网站中的文章包含了不同的主题，如使用Python管理虚拟环境、MCP协议的理解和使用等。此外，网站顶部和底部列出了作者的一些社交链接和其他网站。&#x27;, &#x27;reasoning_content&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;网页查看助手&#x27;&#125;</span><br></pre></td></tr></table></figure>
<p>不过，这里日志中出现了一个奇怪的地方，那就是代码里面打印的bot response上下文中的工具调用格式又变成了<code>function_call</code>，<strong>这里应该是QwenAgent SDK针对mcp工具在对外输出的response里面做的额外解析处理</strong>，并没有把内部通过prompt让AI调用MCP工具的格式输出出来，在最终输出的时候还是会使用<code>function_call</code>的格式来标识AI和MCP工具的调用，方便用户解析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 15:32:57,549 - INFO - bot response: [&#123;&#x27;role&#x27;: &#x27;assistant&#x27;, &#x27;content&#x27;: &#x27;&#x27;, &#x27;reasoning_content&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;网页查看助手&#x27;, &#x27;function_call&#x27;: &#123;&#x27;name&#x27;: &#x27;exmaple-server-fetch&#x27;, &#x27;arguments&#x27;: &#x27;&#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#x27;&#125;&#125;, &#123;&#x27;role&#x27;: &#x27;function&#x27;, &#x27;content&#x27;: &#x27;首页HTML内容&#x27;, &#x27;reasoning_content&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;exmaple-server-fetch&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;assistant&#x27;, &#x27;content&#x27;: &#x27;该网站名为&quot;慕雪的寒舍 - 雪下了一夜&quot;，由作者&quot;慕雪年华&quot;创建。该网站看起来是一个个人博客，包含了各种类型的文章，例如编程学习、博客建站等。网站中的文章包含了不同的主题，如使用Python管理虚拟环境、MCP协议的理解和使用等。此外，网站顶部和底部列出了作者的一些社交链接和其他网站。&#x27;, &#x27;reasoning_content&#x27;: &#x27;&#x27;, &#x27;name&#x27;: &#x27;网页查看助手&#x27;&#125;]</span><br></pre></td></tr></table></figure>
<p>从前文的日志分析中我们已经能够确定QwenAgent在调用工具的时候是直接通过prompt的方式让AI识别mcp工具的。在之前的博客中也提到过，这是MCP工具集成在Agent中的两种方式之一（另外一个方式就是直接使用AI的function call功能来调用），两种方式并没有好坏之分，只是将MCP集成到Agent中的不同的实现方式而已。</p>
<hr>
<p>我顺带测试了一下QwenAgent的自定义工具是否也是用prompt方式的，果不其然，通过QwenAgent提供的<code>@register_tool</code>注册的自定义工具也是通过prompt方式让AI来调用的。</p>
<p>以下是运行<code>Qwen-Agent/examples/assistant_add_custom_tool.py</code>时DEBUG日志中prompt内容，这里也是通过prompt让AI了解了自定义工具<code>my_image_gen</code>的调用方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025-04-20 16:17:52,865 - DEBUG - Request options: &#123;&#x27;method&#x27;: &#x27;post&#x27;, &#x27;url&#x27;: &#x27;/chat/completions&#x27;, &#x27;files&#x27;: None, &#x27;json_data&#x27;: &#123;&#x27;messages&#x27;: [&#123;&#x27;role&#x27;: &#x27;system&#x27;, &#x27;content&#x27;: &#x27;According to the user\&#x27;s request, you first draw a picture and then automatically run code to download the picture and select an image operation from the given document to process the image\n\n# 知识库\n\n## 来自 [文件](doc.pdf) 的内容：\n\n```\n# Python Image Processing Tutorial: Downloading Images and Performing Flip Operations \n\nIn  this  tutorial,  we  will  learn  how  to  download  images  using  Python  and  perform  basic  image \noperations such as flipping and rotating using the Pillow library. \n ## Prerequisites \n Before we begin, make sure you have the following libraries installed in your Python environment: \n\n- `requests`: for downloading images \n- `Pillow`: for image processing \n If you haven\&#x27;t installed these libraries yet, you can install them using pip: \n\n```bash \npip install requests Pillow \n``` \n ## Step 1: Downloading an Image \n First, we need to download an image. We will use the `requests` library to accomplish this task. \n\n``` \nimport requests \n\ndef download_image(url, filename): \n\tresponse = requests.get(url) \n\tif response.status_code == 200: \n\twith open(filename, \&#x27;wb\&#x27;) as file: \n\tfile.write(response.content) \n\telse: \n\tprint(f&quot;Error: Failed to download image from &#123;url&#125;&quot;) \n\n# Example usage \nimage_url = &quot;https://example.com/image.jpg&quot;    # Replace with the URL of the image you want to \ndownload \nfilename = &quot;downloaded_image.jpg&quot; \ndownload_image(image_url, filename) \n``` \n ## Step 2: Opening and Displaying the Image \n Next, we will use the `Pillow` library to open and display the image we just downloaded. \n\n``` \nfrom PIL import Image \n\ndef open_and_show_image(filename): \n\timage = Image.open(filename) \n\timage.show() \n\n# Example usage \nopen_and_show_image(filename) \n``` \n ## Step 3: Flipping and Rotating the Image \n\nNow we can perform flip and rotate operations on the image. The `Pillow` library provides several \nmethods for image manipulation. \n\n``` \ndef flip_image(filename, mode=\&#x27;horizontal\&#x27;): \n\timage = Image.open(filename) \n\tif mode == \&#x27;horizontal\&#x27;: \n\tflipped_image = image.transpose(Image.FLIP_LEFT_RIGHT) \n\telif mode == \&#x27;vertical\&#x27;: \n\tflipped_image = image.transpose(Image.FLIP_TOP_BOTTOM) \n\telse: \n\tprint(&quot;Error: Mode should be \&#x27;horizontal\&#x27; or \&#x27;vertical\&#x27;&quot;) \n\treturn \n\tflipped_image.show() \n\treturn flipped_image \n\ndef rotate_image(filename, degrees): \n\timage = Image.open(filename) \n\trotated_image = image.rotate(degrees) \n\trotated_image.show() \n\treturn rotated_image \n\n# Example usage \nflipped_image = flip_image(filename, mode=\&#x27;horizontal\&#x27;)    # Horizontally flip \nflipped_image.save(&quot;flipped_horizontal.jpg&quot;)    # Save the horizontally flipped image \n\nflipped_image = flip_image(filename, mode=\&#x27;vertical\&#x27;)    # Vertically flip \nflipped_image.save(&quot;flipped_vertical.jpg&quot;)    # Save the vertically flipped image \n\nrotated_image = rotate_image(filename, 90)    # Rotate by 90 degrees \nrotated_image.save(&quot;rotated_90.jpg&quot;)    # Save the rotated image \n\n``` \n ## Step 4: Saving the Modified Image \n\nIn the examples above, we have seen how to save flipped and rotated images. You can use the \n`save` method to save any modified image. \n\n``` \n# Save the image \ndef save_image(image, filename): \n\timage.save(filename) \n\n# Example usage \nsave_image(flipped_image, &quot;flipped_image.jpg&quot;) \nsave_image(rotated_image, &quot;rotated_image.jpg&quot;) \n``` \n\nBy  now,  you  have  learned  how  to  download  images  using  Python  and  perform  basic  image \noperations using the Pillow library. You can extend these basics to implement more complex image \nprocessing functions as needed. \n\n```\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:\n&lt;tools&gt;\n&#123;&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: &#123;&quot;name&quot;: &quot;my_image_gen&quot;, &quot;description&quot;: &quot;AI painting (image generation) service, input text description, and return the image URL drawn based on text information.&quot;, &quot;parameters&quot;: [&#123;&quot;name&quot;: &quot;prompt&quot;, &quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;Detailed description of the desired image content, in English&quot;, &quot;required&quot;: true&#125;]&#125;&#125;\n&#123;&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: &#123;&quot;name&quot;: &quot;code_interpreter&quot;, &quot;description&quot;: &quot;Python code sandbox, which can be used to execute Python code.&quot;, &quot;parameters&quot;: [&#123;&quot;name&quot;: &quot;code&quot;, &quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;The python code.&quot;, &quot;required&quot;: true&#125;]&#125;&#125;\n&lt;/tools&gt;\n\nFor each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:\n&lt;tool_call&gt;\n&#123;&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;&#125;\n&lt;/tool_call&gt;&#x27;&#125;, &#123;&#x27;role&#x27;: &#x27;user&#x27;, &#x27;content&#x27;: &#x27;画一只猫的图片&#x27;&#125;], &#x27;model&#x27;: &#x27;Qwen/Qwen2.5-32B-Instruct&#x27;, &#x27;seed&#x27;: 652077296, &#x27;stream&#x27;: True&#125;&#125;</span><br><span class="line">2025-04-20 16:17:52,865 - DEBUG - Sending HTTP Request: POST https://api.siliconflow.cn/v1/chat/completions</span><br></pre></td></tr></table></figure>
<h2 id="4-The-end">4. The end</h2>
<p>今天心血来潮，通过抓包看了一下MCP客户端和服务端到底是怎么交互的，也算是学到了不少新知识，SSE协议也是第一次听说。如果对MCP或SSE有任何问题，欢迎评论讨论。</p>
<p>这次测试也借机了解了QwenAgent SDK底层是如何让Qwen大模型去处理tools的，采用的是prompt方案。所以QwenAgent在对接其他<strong>非Qwen大模型</strong>的时候<strong>基本不可用</strong>，比如我尝试了硅基流动的<code>THUDM/GLM-4-9B-0414</code>和<code>deepseek-ai/DeepSeek-V3</code>，都没办法正常处理QwenAgent提供的prompt，其中GLM-4-9B-0414尝试输出工具调用参数，但并不符合QwenAgent的需要，没有办法被SDK识别，程序直接停止运行了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># THUDM/chatglm3-6b 输出，工具调用方式不正确</span></span><br><span class="line">[&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;mcp-simple-tool-fetch\n&#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#x27;</span>, <span class="string">&#x27;reasoning_content&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;网页查看助手&#x27;</span>&#125;] </span><br></pre></td></tr></table></figure>
<p>DeepSeek-V3尝试了多次，也是会出现<strong>无法正常输出工具调用参数</strong>的问题，勉强能成功一两次。这里给出DeepSeek成功处理的上下文，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 请求体，包含工具prompt</span></span><br><span class="line">&#123;<span class="string">&#x27;method&#x27;</span>: <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/chat/completions&#x27;</span>, <span class="string">&#x27;files&#x27;</span>: <span class="literal">None</span>, <span class="string">&#x27;json_data&#x27;</span>: &#123;<span class="string">&#x27;messages&#x27;</span>: [&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;你是一个强大的助手，可以帮用户处理问题。\n\n# Tools\n\nYou may call one or more functions to assist with the user query.\n\nYou are provided with function signatures within &lt;tools&gt;&lt;/tools&gt; XML tags:\n&lt;tools&gt;\n&#123;&quot;type&quot;: &quot;function&quot;, &quot;function&quot;: &#123;&quot;name&quot;: &quot;mcp-simple-tool-fetch&quot;, &quot;description&quot;: &quot;Fetches a website and returns its content&quot;, &quot;parameters&quot;: &#123;&quot;type&quot;: &quot;object&quot;, &quot;properties&quot;: &#123;&quot;url&quot;: &#123;&quot;type&quot;: &quot;string&quot;, &quot;description&quot;: &quot;URL to fetch&quot;&#125;&#125;, &quot;required&quot;: [&quot;url&quot;]&#125;&#125;&#125;\n&lt;/tools&gt;\n\nFor each function call, return a json object with function name and arguments within &lt;tool_call&gt;&lt;/tool_call&gt; XML tags:\n&lt;tool_call&gt;\n&#123;&quot;name&quot;: &lt;function-name&gt;, &quot;arguments&quot;: &lt;args-json-object&gt;&#125;\n&lt;/tool_call&gt;&#x27;</span>&#125;, &#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;这个网站是什么？https://blog.musnow.top/&#x27;</span>&#125;], <span class="string">&#x27;model&#x27;</span>: <span class="string">&#x27;deepseek-ai/DeepSeek-V3&#x27;</span>, <span class="string">&#x27;seed&#x27;</span>: <span class="number">832221696</span>, <span class="string">&#x27;stream&#x27;</span>: <span class="literal">True</span>&#125;&#125;</span><br><span class="line"><span class="comment"># deepseek 成功输出工具调用参数</span></span><br><span class="line">[&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;reasoning_content&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;网页查看助手&#x27;</span>, <span class="string">&#x27;function_call&#x27;</span>: &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;mcp-simple-tool-fetch&#x27;</span>, <span class="string">&#x27;arguments&#x27;</span>: <span class="string">&#x27;&#123;&quot;url&quot;: &quot;https://blog.musnow.top/&quot;&#125;&#x27;</span>&#125;&#125;]</span><br><span class="line"><span class="comment"># deepseek 也正常识别出了工具返回结果，并输出了总结</span></span><br><span class="line">&#123;<span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;assistant&#x27;</span>, <span class="string">&#x27;content&#x27;</span>: <span class="string">&#x27;这个网站是“慕雪的寒舍”，是一个个人博客网站，由“慕雪年华”维护。博客主要涵盖了编程学习、技术教程、项目开发记录等内容，包括Python、SLAM（实时定位与地图构建）、图床工具、ROS（机器人操作系统）等技术方向的文章。此外，博客还展示了作者的书影评价、个人生活记录等内容。\n\n以下是一些关键信息：\n- **博客名称**：慕雪的寒舍  \n- **作者**：慕雪年华  \n- **简介**：爱折腾的代码初学者  \n- **内容分类**：编程学习、博客建站、工具推荐等  \n- **文章数量**：441篇  \n- **标签**：Hexo、Linux、Python、C语言等  \n\n此外，博客还提供了友链、关于页面、留言功能等社交互动模块。如果你对技术类内容感兴趣，可以进一步探索该博客的详细内容。&#x27;</span>, <span class="string">&#x27;reasoning_content&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;网页查看助手&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>总而言之，QwenAgent的这个prompt只有在使用Qwen自家模型的时候识别度才好，使用其他家模型的时候非常容易出现tools无法正常识别的情况。不过这也是意料之中了，毕竟人家都叫QwenAgent SDK了，本来就不是面向所有大模型的通用SDK。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">慕雪年华</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/2725694758/">https://blog.musnow.top/posts/2725694758/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://blog.musnow.top" target="_blank">慕雪的寒舍</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Python/">Python</a><a class="post-meta__tags" href="/tags/MCP/">MCP</a><a class="post-meta__tags" href="/tags/AI/">AI</a></div><div class="post-share"><div class="social-share" data-image="https://img.musnow.top/i/2025/04/815180df9842b41001a215e6d4b373d2.webp" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="/pluginsSrc/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="/pluginsSrc/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://ifdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.webp" alt="爱发电"/></a><div class="post-qr-code-desc">爱发电</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/posts/2831928244/" title="【MCP】详细了解MCP协议：和function call的区别何在？如何使用MCP？"><img class="cover" src="https://img.musnow.top/i/2025/04/fef69c3cdacdc7927b494ed945c9210a.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">【MCP】详细了解MCP协议：和function call的区别何在？如何使用MCP？</div></div><div class="info-2"><div class="info-item-1">本文介绍了MCP大模型上下文协议的的概念，并对比了MCP协议和function call的区别，同时用python sdk为例介绍了mcp的使用方式。</div></div></div></a><a class="pagination-related" href="/posts/7827607861/" title="【Hexo】将代码块中tab替换为空格（修改tab_replace）"><img class="cover" src="/img/bg/gm40.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">【Hexo】将代码块中tab替换为空格（修改tab_replace）</div></div><div class="info-2"><div class="info-item-1">通过修改hexo配置文件将代码块中出现的tab制表符改成4个空格，全主题通用</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/4192678800/" title="【Python】使用uv管理python虚拟环境"><img class="cover" src="https://img.musnow.top/i/2025/04/aaa8558a5e2d0fa98f7e21687a22c62a.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-14</div><div class="info-item-2">【Python】使用uv管理python虚拟环境</div></div><div class="info-2"><div class="info-item-1">本文介绍了python虚拟环境管理工具uv，包括uv的作用、uv的常用命令等等。</div></div></div></a><a class="pagination-related" href="/posts/2831928244/" title="【MCP】详细了解MCP协议：和function call的区别何在？如何使用MCP？"><img class="cover" src="https://img.musnow.top/i/2025/04/fef69c3cdacdc7927b494ed945c9210a.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2">【MCP】详细了解MCP协议：和function call的区别何在？如何使用MCP？</div></div><div class="info-2"><div class="info-item-1">本文介绍了MCP大模型上下文协议的的概念，并对比了MCP协议和function call的区别，同时用python sdk为例介绍了mcp的使用方式。</div></div></div></a><a class="pagination-related" href="/posts/4159326627/" title="【Linux】tar命令打包 | 查看压缩文件 | 打包时忽略文件"><img class="cover" src="/img/bg/gm30.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-16</div><div class="info-item-2">【Linux】tar命令打包 | 查看压缩文件 | 打包时忽略文件</div></div><div class="info-2"><div class="info-item-1">tar命令打包 | 查看压缩文件 | 打包时忽略文件 等操作  1.起因 今天下午写阿狸bot的代码的时候，写错了aiofiles的保存操作 12345678# 正确写法async def write_file_aio(path:str, value):    async with aiofiles.open(path, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27;) as f:        await f.write(json.dumps(value, indent=2, sort_keys=True,ensure_ascii=False))        # 错误写法# 前面是一样的await f.write(json.dump(value, indent=2,...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="artalk-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">慕雪年华</div><div class="author-info-description">爱折腾的代码初学者</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">451</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">75</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows/"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="个人主页"><i class="fa fa-home"></i></a><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="导航站点"><i class="fas fa-server"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss-square"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到寒舍，近来可好？</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AFSSE%E5%8D%8F%E8%AE%AE%EF%BC%9F"><span class="toc-text">1. 什么是SSE协议？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95%EF%BC%9A%E8%BF%90%E8%A1%8CMCP%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%92%8CQwenAgent"><span class="toc-text">2. 实际测试：运行MCP服务端和QwenAgent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%86%E6%9E%90wireshark%E6%8A%93%E5%8C%85%E7%BB%93%E6%9E%9C"><span class="toc-text">3. 分析wireshark抓包结果</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%AC%AC%E4%B8%80%E6%9D%A1%E8%AF%B7%E6%B1%82%EF%BC%9A-SSE"><span class="toc-text">3.1. 第一条请求：&#x2F;SSE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E7%AC%AC%E4%BA%8C%E6%9D%A1%E8%AF%B7%E6%B1%82%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">3.2. 第二条请求：初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E7%AC%AC%E4%B8%89%E6%9D%A1%E8%AF%B7%E6%B1%82%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E6%88%90%E5%8A%9F%E5%91%8A%E7%9F%A5"><span class="toc-text">3.3. 第三条请求：初始化成功告知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E7%AC%AC%E5%9B%9B%E6%9D%A1%E8%AF%B7%E6%B1%82%EF%BC%9A%E8%AF%B7%E6%B1%82%E5%B7%A5%E5%85%B7%E5%88%97%E8%A1%A8"><span class="toc-text">3.4. 第四条请求：请求工具列表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E7%AC%AC%E4%BA%94%E6%9D%A1%E8%AF%B7%E6%B1%82%EF%BC%9A%E8%B0%83%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-text">3.5. 第五条请求：调用工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%9C%E4%BA%A4%E4%BB%98AI%E5%A4%84%E7%90%86"><span class="toc-text">3.6. 工具调用结果交付AI处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-The-end"><span class="toc-text">4. The end</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/6151856853/" title="【Agent.02】市面上常见的大模型有哪些？">【Agent.02】市面上常见的大模型有哪些？</a><time datetime="2025-09-15T00:42:09.000Z" title="发表于 2025-09-15 08:42:09">2025-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/6796656750/" title="【Agent.01】AI Agent智能体开发专题引言">【Agent.01】AI Agent智能体开发专题引言</a><time datetime="2025-09-06T14:12:23.000Z" title="发表于 2025-09-06 22:12:23">2025-09-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/4710483697/" title="【AI】AI对26届计算机校招的影响">【AI】AI对26届计算机校招的影响</a><time datetime="2025-08-31T07:12:29.000Z" title="发表于 2025-08-31 15:12:29">2025-08-31</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/9373074383/" title="【win】关闭windows系统切换输入法的其他快捷键（除了win+空格）">【win】关闭windows系统切换输入法的其他快捷键（除了win+空格）</a><time datetime="2025-08-24T07:52:44.000Z" title="发表于 2025-08-24 15:52:44">2025-08-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/main/mothra.webp);"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2025 By 慕雪年华</div><div class="footer_custom_text"><img src="/img/ico/gonganbeian.png" height="15">&nbsp;<a href="https://beian.mps.gov.cn/#/query/webSearch?code=44190002007715" rel="noreferrer" target="_blank">粤公网安备44190002007715</a></br><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="/img/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4.svg" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="/img/badge/-SITEMAP-00CDCD.svg" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="/img/badge/%E7%B2%A4ICP%E5%A4%872023007189-red.svg" height="20px"></a></br><a href="https://travel.moe/go.html" target="_blank"><img src="/img/ico/moe-default-white.png" style="width:auto;height:25px" title="异次元之旅-跃迁-我们一起去萌站成员的星球旅行吧！"></a>&nbsp<a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/pluginsSrc/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="/pluginsSrc/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = '/pluginsSrc/mathjax/es5/tex-mml-chtml.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('/pluginsSrc/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  let artalkItem = null
  const option = null
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'

  const destroyArtalk = () => {
    if (artalkItem) {
      artalkItem.destroy()
      artalkItem = null
    }
  }

  const artalkChangeMode = theme => artalkItem && artalkItem.setDarkMode(theme === 'dark')

  const initArtalk = (el = document, pageKey = location.pathname) => {
    artalkItem = Artalk.init({
      el: el.querySelector('#artalk-wrap'),
      server: 'https://artk.musnow.top',
      site: 'mublog',
      darkMode: document.documentElement.getAttribute('data-theme') === 'dark',
      ...option,
      pageKey: isShuoshuo ? pageKey : (option && option.pageKey) || pageKey
    })

    if (GLOBAL_CONFIG.lightbox === 'null') return
    artalkItem.on('list-loaded', () => {
      artalkItem.ctx.get('list').getCommentNodes().forEach(comment => {
        const $content = comment.getRender().$content
        btf.loadLightbox($content.querySelectorAll('img:not([atk-emoticon])'))
      })
    })

    if (isShuoshuo) {
      window.shuoshuoComment.destroyArtalk = () => {
        destroyArtalk()
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }

    btf.addGlobalFn('pjaxSendOnce', destroyArtalk, 'destroyArtalk')
    btf.addGlobalFn('themeChange', artalkChangeMode, 'artalk')
  }

  const loadArtalk = async (el, pageKey) => {
    if (typeof Artalk === 'object') initArtalk(el, pageKey)
    else {
      await btf.getCSS('/pluginsSrc/artalk/dist/Artalk.css')
      await btf.getScript('/pluginsSrc/artalk/dist/Artalk.js')
      initArtalk(el, pageKey)
    }
  }

  if (isShuoshuo) {
    'Artalk' === 'Artalk'
      ? window.shuoshuoComment = { loadComment: loadArtalk }
      : window.loadOtherComment = loadArtalk
    return
  }

  if ('Artalk' === 'Artalk' || !false) {
    if (false) btf.loadComment(document.getElementById('artalk-wrap'), loadArtalk)
    else setTimeout(loadArtalk, 100)
  } else {
    window.loadOtherComment = loadArtalk
  }
})()</script></div><script src="/js/domain_check.js"></script><script id="click-heart" src="/pluginsSrc/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="true"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>