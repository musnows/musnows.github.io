<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥ | æ…•é›ªçš„å¯’èˆ</title><meta name="author" content="æ…•é›ªå¹´å"><meta name="copyright" content="æ…•é›ªå¹´å"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œç»ˆäºåˆ°å¤šçº¿ç¨‹æ–¹é¢çš„å­¦ä¹ äº†ï¼"><meta property="og:type" content="article"><meta property="og:title" content="ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥"><meta property="og:url" content="https://blog.musnow.top/posts/1309150756/index.html"><meta property="og:site_name" content="æ…•é›ªçš„å¯’èˆ"><meta property="og:description" content="åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œç»ˆäºåˆ°å¤šçº¿ç¨‹æ–¹é¢çš„å­¦ä¹ äº†ï¼"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog.musnow.top/img/bg/gm1.jpg"><meta property="article:published_time" content="2022-12-23T08:30:16.000Z"><meta property="article:modified_time" content="2023-03-29T08:18:13.000Z"><meta property="article:author" content="æ…•é›ªå¹´å"><meta property="article:tag" content="Linux"><meta property="article:tag" content="çº¿ç¨‹"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.musnow.top/img/bg/gm1.jpg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://blog.musnow.top/posts/1309150756/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="google-site-verification" content="iR4A6ntiwhI9JX_YDe2ZFY6DerPD7c-NaLyIDlrDguY"><meta name="msvalidate.01" content="D5CD621F38EE3FB5071F785AD4977161"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.json","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"è·ç¦»ä¸Šæ¬¡æ›´æ–°æœ¬æ–‡å·²ç»è¿‡å»äº†","messageNext":"å¤©ï¼Œæ–‡ç« éƒ¨åˆ†å†…å®¹å¯èƒ½å·²ç»è¿‡æ—¶ï¼Œè¯·æ³¨æ„ç”„åˆ«"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":600,"languages":{"author":"ä½œè€…: æ…•é›ªå¹´å","link":"é“¾æ¥: ","source":"æ¥æº: æ…•é›ªçš„å¯’èˆ","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-03-29 16:18:13"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><script>!function(r){"use strict";!function(){var t=window,s=document,e=r,c="".concat("https:"===s.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),i=s.createElement("script"),n=s.getElementsByTagName("script")[0];i.type="text/javascript",i.setAttribute("charset","UTF-8"),i.async=!0,i.src=c,i.id="LA_COLLECT",e.d=i;function o(){t.LA.ids.push(e)}t.LA?t.LA.ids&&o():(t.LA=r,t.LA.ids=[],o()),n.parentNode.insertBefore(i,n)}()}({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="æ…•é›ªçš„å¯’èˆ" type="application/atom+xml"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/favicon.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">306</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">69</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">14</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> æœºå™¨äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image:url(/img/bg/gm1.jpg)"><nav id="nav"><span id="blog-info"><a href="/" title="æ…•é›ªçš„å¯’èˆ"><img class="site-icon" src="/favicon.jpg"><span class="site-name">æ…•é›ªçš„å¯’èˆ</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> å½’æ¡£</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> æ–‡ç« </span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/qa/"><i class="fa-fw fa-fw fas fa-comment-dots"></i><span> ç•™è¨€</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-robot"></i><span> æœºå™¨äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/posts/847195815/"><i class="fa-fw fab fa-waze"></i><span> Kook-Valorant</span></a></li><li><a class="site-page child" href="/posts/2556995516/"><i class="fa-fw fas fa-ticket-alt"></i><span> Kook-Ticket</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://kdocs.cn/l/cn3OnSwigGxx"><i class="fa-fw fas fa-microphone-alt"></i><span> Kook-VoiceShop</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://github.com/musnows/Kook-Afd-Webhook-Bot"><i class="fa-fw fa-brands fa-square-github"></i><span> Kook-AfdWh</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-friends"></i><span> å‹äºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.travellings.cn/go.html"><i class="fa-fw fas fa-train"></i><span> å¼€å¾€</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://www.foreverblog.cn/go.html"><i class="fa-fw fab fa-superpowers"></i><span> è™«æ´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://travel.moe/go.html?travel=on"><i class="fa-fw fas fa-globe-americas"></i><span> å¼‚æ¬¡å…ƒ</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-glass-whiskey"></i><span> é•œåƒ</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="https://blog.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-home"></i><span> Main</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog1.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-battle-net"></i><span> Netlify</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://musnows.github.io/?utm_source=mirror"><i class="fa-fw fa-brands fa-square-github"></i><span> Github</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog2.musnow.top/?utm_source=mirror"><i class="fa-fw fa-solid fa-square-caret-up"></i><span> Vercel</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog3.musnow.top/?utm_source=mirror"><i class="fa-fw fas fa-cloud"></i><span> Cloudflare</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://keep-hexo.musnow.top/?utm_source=mirror"><i class="fa-fw fa-brands fa-kickstarter"></i><span> KeepTheme</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen"><i class="fa-fw fas fa-copyright"></i><span> CSDN</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://blog.51cto.com/u_15307009"><i class="fa-fw fas fa-dice-five"></i><span> 51CTO</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fab fa-blackberry"></i><span> æ›´å¤š</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> å…³äº</span></a></li><li><a class="site-page child" href="/gallery/"><i class="fa-fw fas fa-images"></i><span> ç”»å»Š</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://memos.musnow.top"><i class="fa-fw fas fa-map-signs"></i><span> è¯´è¯´</span></a></li><li><a class="site-page child" target="_blank" rel="noopener" href="https://stats.uptimerobot.com/qrNpVSLkgV"><i class="fa-fw fas fa-chart-bar"></i><span> Uptime</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-12-23T08:30:16.000Z" title="å‘è¡¨äº 2022-12-23 16:30:16">2022-12-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-03-29T08:18:13.000Z" title="æ›´æ–°äº 2023-03-29 16:18:13">2023-03-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">12.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>46åˆ†é’Ÿ</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œç»ˆäºåˆ°å¤šçº¿ç¨‹æ–¹é¢çš„å­¦ä¹ äº†ï¼</p><span id="more"></span><blockquote><p>æ‰€ç”¨ç³»ç»Ÿ<code>Centos7.6</code> æœ¬æ–‡çš„æºç ğŸ‘‰<a target="_blank" rel="noopener" href="https://gitee.com/musnow/raspberry-practice/tree/master/code/22-12-15_pthread">ã€ä¼ é€é—¨ã€‘</a></p></blockquote><p>[TOC]</p><h1 id="1-çº¿ç¨‹çš„æ¦‚å¿µ"><a href="#1-çº¿ç¨‹çš„æ¦‚å¿µ" class="headerlink" title="1.çº¿ç¨‹çš„æ¦‚å¿µ"></a>1.çº¿ç¨‹çš„æ¦‚å¿µ</h1><p>åœ¨ä¹‹å‰çš„linuxå­¦ä¹ ä¸­ï¼Œå·²ç»æ¥è§¦è¿‡äº†è¿›ç¨‹çš„æ¦‚å¿µï¼Œè¿›ç¨‹ç”±ä¸€ä¸ª<code>task_struct</code>ç»“æ„ä½“åœ¨æ“ä½œç³»ç»Ÿä¸­è¿›è¡Œæè¿°ï¼ŒCPUåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šä¾ç…§è¿›ç¨‹æ—¶é—´ç‰‡è¿›è¡Œè½®è¯¢è°ƒåº¦ï¼Œè®©æ¯ä¸€ä¸ªè¿›ç¨‹çš„ä»£ç éƒ½å¾—ä»¥æ¨è¿›ï¼Œå®ç°å¤šä¸ªè¿›ç¨‹çš„åŒæ—¶è¿è¡Œ</p><p>è€Œçº¿ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§è½»é‡åŒ–çš„è¿›ç¨‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¿›ç¨‹:çº¿ç¨‹ = 1:N</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„å¤šè¿›ç¨‹æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>fork</code>æ¥å£åˆ›å»ºå­è¿›ç¨‹ï¼Œé€šè¿‡<code>if/else</code>è¯­å¥åˆ¤æ–­ï¼Œå®ç°å¯¹ç‰¹å®šæ‰§è¡Œæµçš„åˆ’åˆ†</p><ul><li>åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œéœ€è¦æ‹·è´ä¸€ä»½<code>task_struct/mm_struct</code>å¹¶åˆ›å»ºé¡µè¡¨</li><li>å½“å­è¿›ç¨‹ä¿®æ”¹äº†ä¸€éƒ¨åˆ†å˜é‡ï¼Œä¼šå‘ç”Ÿ<strong>å†™æ—¶æ‹·è´</strong>ï¼Œä¿®æ”¹é¡µè¡¨åœ¨ç‰©ç†å†…å­˜ä¸Šçš„æ˜ å°„</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<strong>æ–°è¿›ç¨‹</strong>çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦åšä¸å°‘çš„å·¥ä½œ</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212151917491.png" alt="image-20221215191721355"></p><h2 id="1-1-æ‰§è¡Œæµ"><a href="#1-1-æ‰§è¡Œæµ" class="headerlink" title="1.1 æ‰§è¡Œæµ"></a>1.1 æ‰§è¡Œæµ</h2><p>è®©æˆ‘ä»¬åº·åº·æ‰§è¡Œæµè¿™ä¸€æ¦‚å¿µï¼š</p><ul><li>å•æ‰§è¡Œæµè¿›ç¨‹ï¼šå†…éƒ¨åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµçš„è¿›ç¨‹</li><li>å¤šæ‰§è¡Œæµè¿›ç¨‹ï¼šå†…éƒ¨æœ‰å¤šä¸ªæ‰§è¡Œæµçš„è¿›ç¨‹</li></ul><p><code>è¿›ç¨‹=å†…æ ¸æ•°æ®ç»“æ„+ä»£ç å’Œæ•°æ®</code>ï¼Œåœ¨å†…æ ¸è§†è§’ä¸­ï¼Œè¿›ç¨‹æ˜¯<code>æ‰¿æ‹…åˆ†é…ç³»ç»Ÿèµ„æºçš„åŸºæœ¬å®ä½“</code>ï¼ˆè¿›ç¨‹çš„åŸºåº§å±æ€§ï¼‰</p><ul><li>è¿›ç¨‹ï¼šå‘ç³»ç»Ÿç”³è¯·èµ„æºçš„åŸºæœ¬å•ä½ï¼ˆç³»ç»Ÿåˆ†é…ï¼‰</li><li>çº¿ç¨‹ï¼šç³»ç»Ÿè°ƒåº¦çš„åŸºæœ¬å•ä½</li></ul><hr><h2 id="1-2-çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#1-2-çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ"></a>1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ</h2><p>é‚£çº¿ç¨‹çš„åˆ›å»ºéœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>ä¸åŒæ“ä½œç³»ç»Ÿçš„å®ç°ä¸åŒï¼Œä¸€èˆ¬ç”¨<code>tcb</code>æŒ‡ä»£æè¿°çº¿ç¨‹çš„ç»“æ„ä½“</p></blockquote><p>åœ¨linuxä¸­ï¼Œæ²¡æœ‰è¿›ç¨‹å’Œçº¿ç¨‹åœ¨æ¦‚å¿µä¸Šçš„åŒºåˆ†ï¼Œå…¶ä»¥<strong>æ‰§è¡Œæµ</strong>ä¸ºåŸºç¡€ï¼Œçº¿ç¨‹åªæ˜¯ç®€å•çš„å¯¹<code>task_strcut</code>è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼›<strong>çº¿ç¨‹æ˜¯åœ¨è¿›ç¨‹å†…éƒ¨è¿è¡Œçš„æ‰§è¡Œæµ</strong></p><ul><li>è¯´äººè¯ï¼šlinuxä¸‹çš„çº¿ç¨‹æ˜¯<strong>ç”¨è¿›ç¨‹æ¨¡æ‹Ÿ</strong>çš„</li><li>æ¢å¥è¯ï¼šlinuxä¸‹çš„è¿›ç¨‹ä¹Ÿæ˜¯ä¸€ç§çº¿ç¨‹ï¼Œä½†æ˜¯å…¶<strong>åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµ</strong></li><li>å¯¹äºCPUè€Œè¨€ï¼Œå…¶çœ‹åˆ°çš„<code>task_struct</code>éƒ½æ˜¯ä¸€ä¸ªæ‰§è¡Œæµ</li></ul><p>è€Œåˆ›å»ºçº¿ç¨‹æ—¶ä¹Ÿæœ‰è¯´æ³•ï¼Œçº¿ç¨‹éš¶å±äºæŸä¸€ä¸ªè¿›ç¨‹ä¸‹ï¼Œå¹¶ä¸æ˜¯ç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ›å»ºæ–°çš„<code>mm_struct</code>å’Œé¡µè¡¨æ˜ å°„ï¼Œåˆ›å»ºçš„æ•ˆç‡é«˜äºå­è¿›ç¨‹ã€‚åªéœ€è¦å°†<code>task_struct</code>æŒ‡å‘åŸæœ‰è¿›ç¨‹çš„<code>mm_struct</code>å’Œé¡µè¡¨å³å¯ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212151923818.png" alt="image-20221215192345757"></p><p>åŒæ ·çš„ï¼ŒCPUåœ¨æ¨è¡Œå¤šçº¿ç¨‹æ“ä½œçš„æ—¶å€™ï¼Œæ— é¡»æ‰§è¡Œpcbåˆ‡æ¢ï¼Œå°±èƒ½å®ç°<strong>å•è¿›ç¨‹å¤šä¸ªçº¿ç¨‹æ“ä½œ</strong>çš„åŒæ—¶è¿›è¡Œï¼Œæ‰§è¡Œæ•ˆç‡å˜é«˜ï¼</p><blockquote><p>çº¿ç¨‹æ˜¯ä¸€ç§ <code>Light weight process è½»é‡çº§è¿›ç¨‹</code>ï¼Œç®€ç§°<code>LWP</code>ï¼›æ˜¯ç°ä»£linuxå¯¹çº¿ç¨‹æä¾›çš„åŸç”Ÿæ”¯æŒ</p></blockquote><h2 id="1-3-å†…æ ¸æºç ä¸­çš„ä½“ç°"><a href="#1-3-å†…æ ¸æºç ä¸­çš„ä½“ç°" class="headerlink" title="1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°"></a>1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°</h2><p>åœ¨<code>task_strcut</code>ç»“æ„ä½“ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªå­—æ®µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* CPU-specific state of this task */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span></span><br></pre></td></tr></table></figure><p>è½¬åˆ°å®šä¹‰ï¼Œå…¶å†…éƒ¨éƒ½æ˜¯ä¸€äº›<strong>å¯„å­˜å™¨</strong>ä¿¡æ¯ï¼Œç”¨äºæ ‡è¯†è¿™ä¸ªçº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ã€‚è¿™ä¹Ÿæ˜¯linuxä¸­æ²¡æœ‰<strong>å•ç‹¬</strong>å®ç°çº¿ç¨‹tcbçš„ä½“ç°ï¼Œè€Œæ˜¯ç”¨<code>task_struct</code>æ¥æ¨¡æ‹Ÿçš„ï¼ˆ<code>task_struct</code>ä¸­åŒ…å«çº¿ç¨‹çš„ä¿¡æ¯ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Cached TLS descriptors: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	<span class="title">tls_array</span>[<span class="title">GDT_ENTRY_TLS_ENTRIES</span>];</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sp0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sysenter_cs;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		usersp;	<span class="comment">/* Copy from PDA */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		es;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		ds;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		fsindex;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		gsindex;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		ip;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		fs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		gs;</span><br><span class="line">	<span class="comment">/* Hardware debugging registers: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg3;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg6;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg7;</span><br><span class="line">	<span class="comment">/* Fault info: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		cr2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		trap_no;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		error_code;</span><br><span class="line">	<span class="comment">/* floating point and extended processor state */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">thread_xstate</span>	*<span class="title">xstate</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="comment">/* Virtual 86 mode info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm86_struct</span> __<span class="title">user</span> *<span class="title">vm86_info</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		screen_bitmap;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		v86flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		v86mask;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		saved_sp0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		saved_fs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		saved_gs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* IO permissions: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		*io_bitmap_ptr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		iopl;</span><br><span class="line">	<span class="comment">/* Max allowed port in the bitmap, in bytes: */</span></span><br><span class="line">	<span class="type">unsigned</span>		io_bitmap_max;</span><br><span class="line"><span class="comment">/* MSR_IA32_DEBUGCTLMSR value to switch in if TIF_DEBUGCTLMSR is set.  */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	debugctlmsr;</span><br><span class="line">	<span class="comment">/* Debug Store context; see asm/ds.h */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ds_context</span>	*<span class="title">ds_ctx</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼ŒLinuxå†…æ ¸ä¼šä¸ºè¯¥çº¿ç¨‹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„çº¿ç¨‹æ ‡è¯†ç¬¦ï¼ˆTIDï¼‰ï¼Œå¹¶åœ¨å†…éƒ¨ç»´æŠ¤çº¿ç¨‹ç›¸å…³çš„æ•°æ®ç»“æ„ã€‚ç„¶è€Œï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨å†…æ ¸ä¸­ä»ç„¶è¢«è§†ä¸ºç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¹¶ä¸”å…±äº«åŒä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦è¡¨ä»¥åŠå…¶ä»–è¿›ç¨‹èµ„æºã€‚</p><p>é€šè¿‡ä½¿ç”¨è¿›ç¨‹æ¨¡æ‹Ÿçº¿ç¨‹çš„æ–¹å¼ï¼ŒLinuxå®ç°äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p><ol><li><p>è½»é‡çº§ï¼šç›¸æ¯”äºä¼ ç»Ÿæ„ä¹‰ä¸Šçš„è¿›ç¨‹ï¼Œçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯æ›´åŠ é«˜æ•ˆï¼Œå ç”¨çš„ç³»ç»Ÿèµ„æºæ›´å°‘ã€‚</p></li><li><p>å¹¶å‘æ€§ï¼šçº¿ç¨‹ä¹‹é—´å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œé€šè¿‡å…±äº«ç›¸åŒçš„åœ°å€ç©ºé—´ï¼Œçº¿ç¨‹å¯ä»¥ç›´æ¥è®¿é—®è¿›ç¨‹çš„å†…å­˜åŒºåŸŸï¼Œç®€åŒ–äº†çº¿ç¨‹é—´çš„é€šä¿¡å’ŒåŒæ­¥æ“ä½œã€‚</p></li><li><p>å…¼å®¹æ€§ï¼šç”±äºæ—©æœŸç‰ˆæœ¬çš„Linuxå†…æ ¸å¹¶ä¸ç›´æ¥æ”¯æŒçº¿ç¨‹ï¼Œä½¿ç”¨è¿›ç¨‹æ¨¡æ‹Ÿçº¿ç¨‹çš„æ–¹å¼ä½¿å¾—è€æ—§çš„ä»£ç å¯ä»¥æ— ç¼è¿ç§»åˆ°æ–°çš„å†…æ ¸ç‰ˆæœ¬ä¸­è¿è¡Œã€‚</p></li></ol><p>ç°ä»£çš„Linuxå†…æ ¸å·²ç»æä¾›äº†å¯¹çº¿ç¨‹çš„åŸç”Ÿæ”¯æŒï¼Œç§°ä¸ºè½»é‡çº§è¿›ç¨‹ï¼ˆLightweight Processï¼ŒLWPï¼‰ã€‚é€šè¿‡ä½¿ç”¨LWPï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥åœ¨å†…æ ¸ä¸­ç‹¬ç«‹åœ°è¿›è¡Œè°ƒåº¦å’Œç®¡ç†ï¼Œè€Œæ— éœ€ä¾èµ–è¿›ç¨‹èµ„æºã€‚è¿™ç§æ–¹å¼æ›´åŠ é«˜æ•ˆï¼Œå¹¶ä¸”æ›´ç¬¦åˆçº¿ç¨‹æ¦‚å¿µçš„å®šä¹‰ã€‚ç„¶è€Œï¼Œä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ï¼ŒLinuxä»ç„¶ä¿ç•™äº†ä½¿ç”¨è¿›ç¨‹æ¨¡æ‹Ÿçº¿ç¨‹çš„æœºåˆ¶ã€‚</p><h2 id="1-4-çº¿ç¨‹çš„ç§æœ‰ç‰©"><a href="#1-4-çº¿ç¨‹çš„ç§æœ‰ç‰©" class="headerlink" title="1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©"></a>1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªè¿›ç¨‹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚ä½†æ˜¯çº¿ç¨‹å¹¶ä¸æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åªæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªæ‰§è¡Œæµåˆ†æ”¯ï¼Œå®ƒä»è¿›ç¨‹ç»§æ‰¿äº†ç»å¤§éƒ¨åˆ†å±æ€§ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯å…±äº«çš„ï¼‰</p><ul><li>ç”¨æˆ·idå’Œç»„id</li><li>è¿›ç¨‹id</li><li>è¿›ç¨‹å·¥ä½œç›®å½•</li><li>æ–‡ä»¶æè¿°ç¬¦è¡¨</li><li>ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼ˆå¦‚æœè¿›ç¨‹æœ‰å¯¹æŸä¸ªä¿¡å·è¿›è¡Œè‡ªå®šä¹‰æ•æ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šå…±ç”¨è¿™ä¸ªè‡ªå®šä¹‰æ•æ‰ï¼‰</li><li>å’Œè¿›ç¨‹å…±ç”¨ä¸€ä¸ªå †</li></ul><p>ä½†çº¿ç¨‹ä¹Ÿä¼šæœ‰è‡ªå·±çš„<strong>ç§æœ‰ç‰©</strong>ï¼</p><ul><li>çº¿ç¨‹id</li><li>çº¿ç¨‹ç‹¬ç«‹çš„å¯„å­˜å™¨ï¼ˆå› ä¸ºçº¿ç¨‹ä¹Ÿéœ€è¦æ‰§è¡Œä»£ç ï¼Œæœ‰ä¸Šä¸‹æ–‡æ•°æ®ï¼‰</li><li>æ ˆï¼ˆçº¿ç¨‹è¿è¡Œå‡½æ•°æ—¶ä¹Ÿéœ€è¦å‹æ ˆå’Œå‡ºæ ˆï¼Œå¿…é¡»ç‹¬ç«‹å¦åˆ™æ‰§è¡Œæµä¼šå‡ºé—®é¢˜ï¼‰</li><li>errnoï¼ˆå•ç‹¬çš„æŠ¥é”™ä¿¡æ¯ï¼‰</li><li>ä¿¡å·å±è”½å­—ï¼ˆå¯ä»¥å•ç‹¬é’ˆå¯¹æŸä¸ªä¿¡å·å¤„ç†ï¼‰</li><li>çº¿ç¨‹è°ƒåº¦ä¼˜å…ˆçº§</li></ul><h3 id="1-5-3-çº¿ç¨‹ç»“æ„ä½“"><a href="#1-5-3-çº¿ç¨‹ç»“æ„ä½“" class="headerlink" title="1.5.3 çº¿ç¨‹ç»“æ„ä½“"></a>1.5.3 çº¿ç¨‹ç»“æ„ä½“</h3><p>åœ¨Linuxå†…æ ¸ä¸­çš„<code>struct thread_struct</code>ç»“æ„ä½“ä¸­åŒ…å«äº†å¦‚ä¸‹å­—æ®µï¼Œè¿™äº›å­—æ®µæœ‰åŠ©äºæ¨¡æ‹Ÿçº¿ç¨‹ã€‚å› ä¸ºæˆ‘ä»¬å¯¹linuxå†…æ ¸ä»£ç çš„äº†è§£å¹¶ä¸å¤šï¼Œè¿™é‡ŒåªåšåŸºæœ¬è®¤è¯†ï¼Œå¯ä»¥å’Œä¸Šæ–¹çš„<code>struct thread_struct</code>ç»“æ„ä½“æºç å¯¹ç…§ç€çœ‹</p><ol><li><p><code>tls_array</code>: è¿™ä¸ªå­—æ®µè¡¨ç¤ºçº¿ç¨‹çš„TLSï¼ˆThread Local Storageï¼‰æè¿°ç¬¦æ•°ç»„ã€‚TLSæ˜¯ä¸€ç§æœºåˆ¶ï¼Œå…è®¸çº¿ç¨‹åœ¨å…¶å•ç‹¬çš„å­˜å‚¨åŒºåŸŸä¸­å­˜å‚¨å’Œè®¿é—®å˜é‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æœ‰è‡ªå·±çš„TLSæ•°ç»„ã€‚</p></li><li><p><code>sp0</code>å’Œ<code>sp</code>: è¿™äº›å­—æ®µè¡¨ç¤ºçº¿ç¨‹çš„æ ˆæŒ‡é’ˆï¼Œç”¨äºç®¡ç†çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆã€‚</p></li><li><p><code>sysenter_cs</code>, <code>usersp</code>, <code>es</code>, <code>ds</code>, <code>fsindex</code>, <code>gsindex</code>: è¿™äº›å­—æ®µç”¨äºä¿å­˜ä¸çº¿ç¨‹ç›¸å…³çš„æ®µå¯„å­˜å™¨ä¿¡æ¯ï¼Œä¾‹å¦‚ä»£ç æ®µé€‰æ‹©å­ã€ç”¨æˆ·æ ˆæŒ‡é’ˆä»¥åŠå„ç§æ®µå¯„å­˜å™¨çš„ç´¢å¼•ã€‚</p></li><li><p><code>ip</code>, <code>fs</code>, <code>gs</code>: è¿™äº›å­—æ®µè®°å½•çº¿ç¨‹çš„æŒ‡ä»¤æŒ‡é’ˆå’Œæ®µå¯„å­˜å™¨çš„å€¼ã€‚</p></li><li><p><code>debugreg0</code>, <code>debugreg1</code>, <code>debugreg2</code>, <code>debugreg3</code>, <code>debugreg6</code>, <code>debugreg7</code>: è¿™äº›å­—æ®µç”¨äºä¿å­˜ç¡¬ä»¶è°ƒè¯•å¯„å­˜å™¨çš„å€¼ï¼Œç”¨äºè°ƒè¯•ç›®çš„ã€‚</p></li><li><p><code>cr2</code>, <code>trap_no</code>, <code>error_code</code>: è¿™äº›å­—æ®µè®°å½•äº†å‘ç”Ÿå¼‚å¸¸æˆ–ä¸­æ–­æ—¶çš„ç›¸å…³ä¿¡æ¯ã€‚</p></li><li><p><code>xstate</code>: è¿™ä¸ªå­—æ®µç”¨äºä¿å­˜æµ®ç‚¹æ•°å’Œæ‰©å±•å¤„ç†å™¨çŠ¶æ€ã€‚</p></li></ol><h2 id="1-5-çº¿ç¨‹ä¼˜ç¼ºç‚¹"><a href="#1-5-çº¿ç¨‹ä¼˜ç¼ºç‚¹" class="headerlink" title="1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹"></a>1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹</h2><h3 id="1-5-1-ç¼ºç‚¹"><a href="#1-5-1-ç¼ºç‚¹" class="headerlink" title="1.5.1 ç¼ºç‚¹"></a>1.5.1 ç¼ºç‚¹</h3><ul><li><p>çº¿ç¨‹æ˜¯ç¼ºä¹ä¿æŠ¤çš„ï¼ˆä¸å…·å¤‡è¿›ç¨‹çš„<strong>ç‹¬ç«‹æ€§</strong>ï¼‰è¿™ä¹Ÿè¢«ç§°ä¸º<code>å¥å£®æ€§</code>ï¼›çº¿ç¨‹çš„å¥å£®æ€§ä½</p><ul><li>å½“è¿›ç¨‹è¢«åœæ­¢çš„æ—¶å€™ï¼Œå…¶ä¸‹çº¿ç¨‹ä¹Ÿä¼šè¢«åœæ­¢</li><li>å½“æœ‰ä¸€ä¸ªçº¿ç¨‹å‡ºbugäº†ï¼Œä¼šè®©æ•´ä¸ªè¿›ç¨‹é€€å‡º</li><li>å¤šçº¿ç¨‹ä¸­çš„å…¨å±€å˜é‡é—®é¢˜</li></ul></li><li><p>çº¿ç¨‹ç¼ºä¹è®¿é—®æ§åˆ¶ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨æŸäº›æ“ä½œç³»ç»Ÿçš„æ¥å£ä¼šå½±å“æ•´ä¸ªè¿›ç¨‹</p></li><li><p>debugå¤šçº¿ç¨‹è¾ƒéº»çƒ¦</p></li><li><p>å¦‚æœåŒä¸€ä¸ªè¿›ç¨‹æ‰€ç”¨çº¿ç¨‹å¤ªå¤šï¼Œå¯èƒ½ä¼šæ— æ³•å……åˆ†åˆ©ç”¨cpuæ€§èƒ½è€Œé€ æˆæ€§èƒ½æŸå¤±</p></li></ul><h3 id="1-5-2-ä¼˜ç‚¹"><a href="#1-5-2-ä¼˜ç‚¹" class="headerlink" title="1.5.2 ä¼˜ç‚¹"></a>1.5.2 ä¼˜ç‚¹</h3><ul><li>çº¿ç¨‹å¼€è¾Ÿçš„æ¶ˆè€—ä½äºè¿›ç¨‹ï¼Œå ç”¨çš„èµ„æºä½äºè¿›ç¨‹</li><li>åˆ‡æ¢çº¿ç¨‹æ— é¡»åˆ‡æ¢é¡µè¡¨ç­‰ç»“æ„ï¼Œé€Ÿåº¦å¿«ï¼</li><li>ç­‰å¾…æ…¢IOè®¾å¤‡æ—¶ï¼Œè¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼›å°†éƒ¨åˆ†IOæ“ä½œé‡å ï¼Œèƒ½è®©è¿›ç¨‹åŒæ—¶ç­‰å¾…å¤šä¸ªIOæ“ä½œï¼›</li><li>èƒ½å……åˆ†åˆ©ç”¨å¤„ç†å™¨çš„<strong>å¯å¹¶è¡Œæ•°é‡</strong>ï¼›</li></ul><h2 id="1-6-linuxä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«"><a href="#1-6-linuxä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«" class="headerlink" title="1.6 linuxä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«"></a>1.6 linuxä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«</h2><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹æ˜¯ä¸¤ä¸ªå¹¶å‘æ‰§è¡Œçš„åŸºæœ¬å•ä½ã€‚å®ƒä»¬ä¹‹é—´æœ‰ä»¥ä¸‹åŒºåˆ«ï¼š</p><ol><li>èµ„æºå ç”¨ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ã€å †æ ˆç­‰èµ„æºï¼Œè€Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼ŒåŒ…æ‹¬åœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚å› æ­¤ï¼Œåˆ›å»ºçº¿ç¨‹æ¯”åˆ›å»ºè¿›ç¨‹æ›´åŠ è½»é‡çº§ã€‚åœ¨çº¿ç¨‹ç›´æ¥åˆ‡æ¢ä¹Ÿæ¯”è¿›ç¨‹åˆ‡æ¢æ•ˆç‡æ›´é«˜ã€‚</li><li>è°ƒåº¦ï¼šè¿›ç¨‹æ˜¯ç”±æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦å’Œåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€Œçº¿ç¨‹æ˜¯<strong>è¿›ç¨‹çš„æ‰§è¡Œå•å…ƒ</strong>ï¼Œç”±æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦å’Œåˆ†é…CPUæ—¶é—´ç‰‡ã€‚</li><li>é€šä¿¡å’ŒåŒæ­¥ï¼šè¿›ç¨‹é—´é€šä¿¡éœ€è¦ä½¿ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„æœºåˆ¶ï¼Œå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ç­‰ã€‚è€Œçº¿ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡å…±äº«å†…å­˜çš„æ–¹å¼ç›´æ¥è¿›è¡Œé€šä¿¡ã€‚æ­¤å¤–ï¼Œçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ›´åŠ æ–¹ä¾¿ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”ã€æ¡ä»¶å˜é‡ç­‰æœºåˆ¶ã€‚</li><li>ç‹¬ç«‹æ€§ï¼šè¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œä¸€ä¸ªè¿›ç¨‹çš„å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ã€‚è€Œçº¿ç¨‹å…±äº«è¿›ç¨‹çš„èµ„æºï¼Œä¸€ä¸ªçº¿ç¨‹çš„å´©æºƒä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹çš„å´©æºƒã€‚</li></ol><p>æ€»ç»“æ¥è¯´ï¼Œ<strong>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯æ‰§è¡Œçš„åŸºæœ¬å•ä½</strong>ã€‚è¿›ç¨‹ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«éƒ¨åˆ†èµ„æºã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®æƒ…å†µçš„ä¸åŒï¼Œé€‰æ‹©ä½¿ç”¨è¿›ç¨‹æˆ–çº¿ç¨‹æ¥å®ç°å¹¶å‘æ‰§è¡Œã€‚</p><hr><h1 id="2-åŸºç¡€å‡½æ•°"><a href="#2-åŸºç¡€å‡½æ•°" class="headerlink" title="2.åŸºç¡€å‡½æ•°"></a>2.åŸºç¡€å‡½æ•°</h1><p>linuxä¸‹æä¾›äº†<code>pthread</code>åº“æ¥å®ç°çº¿ç¨‹æ“ä½œ</p><h2 id="2-1-pthread-create"><a href="#2-1-pthread-create" class="headerlink" title="2.1 pthread_create"></a>2.1 pthread_create</h2><p>äººå¦‚å…¶åï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ¥åˆ›å»ºæ–°è¿›ç¨‹çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *thread, <span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *(*start_routine) (<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<strong>è¾“å‡ºå‹å‚æ•°</strong>ï¼Œä¸ºè¯¥çº¿ç¨‹çš„id</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºæŒ‡å®šçº¿ç¨‹çš„å±æ€§ï¼Œæš‚æ—¶è®¾ç½®ä¸º<code>NULL</code>ä½¿ç”¨é»˜è®¤å±æ€§</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è®©è¯¥è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½ä¸º<code>void*</code></li><li>ç¬¬å››ä¸ªå‚æ•°æ˜¯<strong>ä¼ ç»™ç¬¬ä¸‰ä¸ªæ‰§è¡Œå‡½æ•°çš„å‚æ•°</strong></li></ul><p>åˆ›å»ºæ­£å¸¸åè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç </p><p>æ³¨æ„ï¼Œä½¿ç”¨äº†pthreadåº“åï¼Œéœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™æŒ‡å®šé“¾æ¥ï¼Œ<code>-lpthread</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">pthread_t</span>;<span class="comment">//çº¿ç¨‹id</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºçº¿ç¨‹åæ‰“å°å¯ä»¥å‘ç°ï¼Œçº¿ç¨‹idæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå¹¶ä¸åƒè¿›ç¨‹PIDé‚£ä¹ˆå°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cout &lt;&lt; &quot;pthread_create &quot;&lt;&lt; t1 &lt;&lt; &quot; &quot; &lt;&lt; t2 &lt;&lt; endl;</span></span><br><span class="line">pthread_create <span class="number">140689524995840</span> <span class="number">140689516603136</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡<code>printf %x</code>çš„æ–¹å¼æ‰“å°åå…­è¿›åˆ¶ï¼Œæ¥å‡å°‘æ‰“å°é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//printf(&quot;0x%x  0x%x\n&quot;,t1,t2);</span></span><br><span class="line"><span class="number">0x393d0700</span>  <span class="number">0x38bcf700</span></span><br></pre></td></tr></table></figure><h2 id="2-2-pthread-join"><a href="#2-2-pthread-join" class="headerlink" title="2.2 pthread_join"></a>2.2 pthread_join</h2><p>å…‰æ˜¯åˆ›å»ºè¿›ç¨‹è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿›ç¨‹<strong>è¿›è¡Œç­‰å¾…</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯çº¿ç¨‹çš„idï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€</p><p>ç­‰å¾…æˆåŠŸåè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç </p><ul><li>joinå¯ä»¥åœ¨çº¿ç¨‹é€€å‡ºåï¼Œé‡Šæ”¾çº¿ç¨‹çš„èµ„æº</li><li>åŒæ—¶è·å–çº¿ç¨‹å¯¹åº”çš„é€€å‡ºç </li><li>joinè¿˜èƒ½ä¿è¯æ˜¯æ–°åˆ›å»ºçš„çº¿ç¨‹é€€å‡ºåï¼Œä¸»çº¿ç¨‹æ‰é€€å‡º</li></ul><h3 id="2-2-1-åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ"><a href="#2-2-1-åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ" class="headerlink" title="2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ"></a>2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ</h3><p>æœ‰äº†è¿™ä¸¤ä¸ªï¼Œæˆ‘ä»¬å°±èƒ½å†™ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹æ“ä½œäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main::&quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¼šå‘ç°ï¼Œå¤šçº¿ç¨‹æ“ä½œæˆåŠŸå¯åŠ¨ï¼Œä¸”æ‰“å°çš„è¿›ç¨‹pidéƒ½æ˜¯ä¸€æ ·çš„ï¼Œ<strong>ä»£è¡¨å…¶éš¶å±äºåŒä¸€ä¸ªè¿›ç¨‹</strong></p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212152032424.png" alt="image-20221215203210372"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„è¯­å¥æ¥æŸ¥çœ‹è½»é‡çº§è¿›ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -aL</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†ç¨‹åºä¹‹åï¼Œå‡ºç°äº†3ä¸ª<code>PID</code>ç›¸åŒï¼Œ<code>LWP</code>ä¸åŒçš„è½»é‡çº§è¿›ç¨‹ï¼Œè¿™å°±ä»£è¡¨æˆ‘ä»¬çš„å¤šçº¿ç¨‹æ“ä½œæˆåŠŸäº†ï¼›</p><p>åŒæ—¶ä¹Ÿèƒ½çœ‹åˆ°ï¼Œåœ¨å¤šçº¿ç¨‹æ“ä½œæ—¶ï¼Œè°å…ˆè¿è¡Œæ˜¯ä¸ç¡®å®šçš„ã€‚è¿™æ˜¯ç”±ç³»ç»Ÿè°ƒåº¦éšæœºå†³å®šçš„</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212152033288.png" alt="image-20221215203326193"></p><h3 id="2-2-2-C-çš„å¤šçº¿ç¨‹æ“ä½œ"><a href="#2-2-2-C-çš„å¤šçº¿ç¨‹æ“ä½œ" class="headerlink" title="2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ"></a>2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ</h3><p>C++11ä¹Ÿæ”¯æŒäº†å¤šçº¿ç¨‹æ“ä½œï¼Œå…¶å°è£…äº†æ“ä½œç³»ç»Ÿçš„pthreadæ¥å£ï¼ŒåŸºæœ¬çš„æ“ä½œå¾ˆç›¸ä¼¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(func1,(<span class="type">char</span>*)<span class="string">&quot;test1&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(func2,(<span class="type">char</span>*)<span class="string">&quot;test2&quot;</span>)</span></span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒC++çš„threadåº“è¿˜å¯ä»¥ä¼ å…¥<code>functional</code>å°è£…çš„å¯è°ƒç”¨å‡½æ•°ï¼Œå’Œ<code>lambda</code>è¡¨è¾¾å¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212152054822.png" alt="image-20221215205453606"></p><h2 id="2-3-çº¿ç¨‹é€€å‡º"><a href="#2-3-çº¿ç¨‹é€€å‡º" class="headerlink" title="2.3 çº¿ç¨‹é€€å‡º"></a>2.3 çº¿ç¨‹é€€å‡º</h2><h3 id="2-3-1-retval"><a href="#2-3-1-retval" class="headerlink" title="2.3.1 retval"></a>2.3.1 retval</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ¥è·å–çº¿ç¨‹æ‰€æ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼ã€‚<code>retval</code>æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ª<strong>è¾“å‡ºå‹å‚æ•°</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func1 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1;</span><br><span class="line">    <span class="type">void</span>* r2;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="built_in">test3</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹é€€å‡ºä¹‹åï¼Œä¸»å‡½æ•°ä¸­æˆåŠŸæ‰“å°å‡ºäº†ä»–ä»¬çš„è¿”å›å€¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212161842059.png" alt="image-20221216184220924"></p><p>æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å°†<code>void*</code>çš„æŒ‡é’ˆå¼ºè½¬ä¸ºintï¼Œå¦‚æœåœ¨æ‰“å°çš„æ—¶å€™å¼ºè½¬ä¸º<code>int</code>ï¼Œä¼šå‡ºç°<strong>ç²¾åº¦ä¸¢å¤±</strong>çš„æŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨<code>long long</code>æ¥è§„é¿æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ make</span><br><span class="line">g++ test.cpp -o test -lpthread -std=c++11</span><br><span class="line">.test.cpp: In function â€˜void test3()â€™:</span><br><span class="line">test.cpp:88:35: error: cast from â€˜void*â€™ to â€˜intâ€™ loses precision [-fpermissive]</span><br><span class="line">     cout &lt;&lt; &quot;retval 1 : &quot; &lt;&lt; (int)r1 &lt;&lt; endl;</span><br><span class="line">                                   ^</span><br><span class="line">make: *** [test] Error 1</span><br></pre></td></tr></table></figure><h3 id="2-3-2-pthread-exit"><a href="#2-3-2-pthread-exit" class="headerlink" title="2.3.2 pthread_exit"></a>2.3.2 pthread_exit</h3><p>é™¤äº†ç›´æ¥returnï¼Œçº¿ç¨‹è¿˜å¯ä»¥è°ƒç”¨<code>pthread_exit</code>å‡½æ•°å®ç°é€€å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_exit</span><span class="params">(<span class="type">void</span> *retval)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå®Œå…¨ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//return (void*)10;</span></span><br><span class="line">pthread_exit((<span class="type">void</span>*)<span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸»çº¿ç¨‹mainä¸­è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶ä¸ä¼šå¯¼è‡´è¿›ç¨‹é€€å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot; tid: &quot;</span> &lt;&lt; <span class="built_in">syscall</span>(SYS_gettid) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">pthread_exit</span>((<span class="type">void</span>*)<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">	<span class="comment">//func2ä¼šæ‰§è¡Œ10s</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="built_in">test5</span>();</span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="number">0</span>);<span class="comment">//ä¸»çº¿ç¨‹æå‰é€€å‡º</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main exit&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸»å‡½æ•°å·²ç»è°ƒç”¨äº†<code>pthread_exit</code>é€€å‡ºäº†ï¼Œä½†æ˜¯çº¿ç¨‹è¿˜åœ¨è·‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br><span class="line">main exit</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br></pre></td></tr></table></figure><h3 id="2-3-3-ptrhead-cancel"><a href="#2-3-3-ptrhead-cancel" class="headerlink" title="2.3.3 ptrhead_cancel"></a>2.3.3 ptrhead_cancel</h3><p>é™¤äº†ä¸Šé¢ä¿©ç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨mainé‡Œé¢ç›´æ¥æŠŠæŸä¸€ä¸ªçº¿ç¨‹ç»™å…³æ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(a==<span class="number">11</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cancel</span>(t1);</span><br><span class="line">            <span class="built_in">pthread_cancel</span>(t2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span>* r1;</span><br><span class="line">    <span class="type">void</span>* r2;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«æå‰ç»ˆæ­¢çš„è¿›ç¨‹ï¼Œè¿”å›å€¼éƒ½ä¸º-1</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212161903290.png" alt="image-20221216190338205"></p><h3 id="2-3-4-ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ"><a href="#2-3-4-ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ" class="headerlink" title="2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ"></a>2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ</h3><p>è¦ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦æ·±çŸ¥ä¸€ä¸ªæ¦‚å¿µï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œæµï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ã€‚</p><p>å…ˆæ¥å›é¡¾ä¸€ä¸‹è¿›ç¨‹é€€å‡ºçš„å‡ ç§æƒ…å†µï¼š</p><ul><li>ä»£ç è·‘å®Œï¼Œç»“æœæ­£ç¡®</li><li>ä»£ç è·‘å®Œï¼Œç»“æœæœ‰é—®é¢˜</li><li>ä»£ç å‡ºé”™äº†ï¼Œå¼‚å¸¸</li></ul><p>çº¿ç¨‹é€€å‡ºçš„æƒ…å†µä¹Ÿæ˜¯è¿™æ ·ï¼Œä½†çº¿ç¨‹å¦‚æœå› ä¸ºæŸäº›å¼‚å¸¸é€€å‡ºï¼Œ<strong>è¿›ç¨‹ä¹Ÿä¼šåŒæ­¥é€€å‡º</strong>ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">this is main:: 13845</span><br><span class="line">Floating point exception</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯è§ï¼Œ<code>çº¿ç¨‹å¼‚å¸¸ = è¿›ç¨‹å¼‚å¸¸</code></p><p>è¿™é‡Œä¹Ÿå°±æ¶‰åŠåˆ°<code>1.5.1</code>ä¸­æåˆ°çš„çº¿ç¨‹<strong>å¥å£®æ€§</strong>é—®é¢˜ï¼Œçº¿ç¨‹çš„å¼‚å¸¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œï¼Œä¼šå¯¼è‡´è¿›ç¨‹æ•´ä½“å¼‚å¸¸é€€å‡ºã€‚</p><p>æ‰€ä»¥åœ¨<code>join</code>ç­‰å¾…çº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘çº¿ç¨‹æ­£å¸¸é€€å‡ºçš„æƒ…å†µï¼›</p><blockquote><p>å¼‚å¸¸é€€å‡ºçš„æ—¶å€™ææ€•ä¹Ÿç­‰ä¸äº†ğŸ˜‚å› ä¸ºè¿›ç¨‹ä¹ŸæŒ‚äº†</p></blockquote><h2 id="2-3-5-exit"><a href="#2-3-5-exit" class="headerlink" title="2.3.5 exit"></a>2.3.5 exit</h2><p>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ<code>exit()</code>å‡½æ•°ï¼Œéƒ½ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡º</p><hr><h2 id="2-4-pthread-detach"><a href="#2-4-pthread-detach" class="headerlink" title="2.4 pthread_detach"></a>2.4 pthread_detach</h2><p>ç­‰å¾…æ˜¯æœ‰æ€§èƒ½æŸå¤±çš„ï¼é»˜è®¤åˆ›å»ºçš„è¿›ç¨‹æ˜¯<code>joinable</code>ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¢«ä¸»çº¿ç¨‹è¿›è¡Œ<code>pthread_join</code>ç­‰å¾…çš„ï¼›</p><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è®©ä¸»çº¿ç¨‹ä¸ç®¡åˆ›å»ºå‡ºæ¥çš„å­çº¿ç¨‹ï¼Œä¹Ÿä¸ç”¨å»ç­‰å¾…å®ƒï¼Œç›¸å½“äºå–æ¶ˆäº†å®ƒçš„<code>joinable</code>å±æ€§ï¼›</p><p>å°±å¥½æ¯”çˆ¶è¿›ç¨‹ä¸æƒ³ç®¡å­è¿›ç¨‹çš„æ—¶å€™ï¼Œå°†<code>SIGCHLD</code>è®¾ç½®ä¸º<code>SIG_IGN</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦åº”è¯¥ç­‰å¾…ï¼Œå–å†³äºæ˜¯å¦éœ€è¦è·å–è¯¥çº¿ç¨‹çš„è¿”å›å€¼ï¼›å¦‚æœæ— é¡»è·å–è¿”å›å€¼ï¼Œåˆ™ä½¿ç”¨åˆ†ç¦»èƒ½æé«˜è¿è¡Œæ•ˆç‡</p><blockquote><p>å³ä¾¿çº¿ç¨‹æ‰€è¿è¡Œçš„å‡½æ•°returnæ˜¯æ— æ•ˆçš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥ç”¨è¾“å‡ºå‹å‚æ•°æ¥è·å–è¿”å›å€¼</p></blockquote><h3 id="2-4-1-å®æ“"><a href="#2-4-1-å®æ“" class="headerlink" title="2.4.1 å®æ“"></a>2.4.1 å®æ“</h3><p>ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æŒ‡å®šçº¿ç¨‹çš„idå°±è¡Œäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬å·²æ— æ³•è·å–åˆ°è¯¥çº¿ç¨‹çš„è¿”å›å€¼</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181127252.png" alt="image-20221218112720052"></p><hr><h3 id="2-4-2-detachåjoin"><a href="#2-4-2-detachåjoin" class="headerlink" title="2.4.2 detachåjoin"></a>2.4.2 detachåjoin</h3><p>ä½†å¦‚æœæˆ‘ä»¬åœ¨detachä¹‹ååˆè¿›è¡Œ<code>pthread_join</code>ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func3</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>());</span><br><span class="line">    <span class="type">int</span> a = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;func thread:%s - global:%d - &amp;global:%p\n&quot;</span>,(<span class="type">char</span>*)arg,global,&amp;global);</span><br><span class="line">        global++;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">void</span>* r2=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¶ï¼Œè¿™ä¸è¿˜æ˜¯è·å–åˆ°äº†è¿”å›å€¼å—ï¼Ÿè¿™ä¹ˆè¯´ï¼Œä»–è¿™ä¸ª<code>detach</code>å²‚ä¸æ˜¯æ²¡ç”¨ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func thread:1 - global:103 - &amp;global:0x7fb5648b06fc</span><br><span class="line">func thread:2 - global:103 - &amp;global:0x7fb5640af6fc</span><br><span class="line">func thread:1 - global:104 - &amp;global:0x7fb5648b06fc</span><br><span class="line">func thread:2 - global:104 - &amp;global:0x7fb5640af6fc</span><br><span class="line">func exit</span><br><span class="line">func exit</span><br><span class="line">retval 1 : 10</span><br><span class="line">retval 2 : 10</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬createä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œå®ƒä¼šå…ˆå»æ‰§è¡Œçº¿ç¨‹åˆ›å»ºçš„ç›¸å…³ä»£ç ï¼Œæ­¤æ—¶mainåˆç›´æ¥å»æ‰§è¡Œåé¢çš„ä»£ç äº†ï¼›æ­¤æ—¶<code>pthread_join</code>çš„è°ƒç”¨æ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºçº¿ç¨‹è‡ªå·±çš„<code>detach</code>ä»£ç <strong>è¿˜æ²¡æœ‰è¢«æ‰§è¡Œ</strong>ï¼</p><hr><p>è€Œå¦‚æœæˆ‘ä»¬åœ¨createä¹‹åï¼Œç­‰çº¿ç¨‹å¼€å§‹è¿è¡Œäº†åœ¨æ‰§è¡Œ<code>detach</code>ï¼Œæ­¤æ—¶joinå°±ä¼šå¤±è´¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">void</span>* r2=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    cout &lt;&lt; ret &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">strerror</span>(ret) &lt;&lt; endl;</span><br><span class="line">    ret = <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line">    cout &lt;&lt; ret &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">strerror</span>(ret) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°é”™è¯¯ç ä¹Ÿèƒ½çœ‹åˆ°ï¼Œç³»ç»Ÿæç¤ºæˆ‘ä»¬ç»™<code>join</code>ä¼ å…¥äº†ä¸€ä¸ªæ— æ•ˆçš„å‚æ•°ï¼Œçº¿ç¨‹ä¾æ—§åœ¨æ­£å¸¸è¿è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt<span class="number">-7274</span>:~/git/linux/code/<span class="number">22</span><span class="number">-12</span><span class="number">-15</span>_pthread]$ ./test</span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">101</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">101</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">102</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">102</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br><span class="line"><span class="number">22</span>:Invalid argument</span><br><span class="line"><span class="number">22</span>:Invalid argument</span><br><span class="line">retval <span class="number">1</span> : <span class="number">0</span></span><br><span class="line">retval <span class="number">2</span> : <span class="number">0</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">103</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">103</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ­£ç¡®çš„åšæ³•ï¼Œ<strong>åº”è¯¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»çº¿ç¨‹</strong>ï¼Œä¸è¦åœ¨çº¿ç¨‹è‡ªå·±çš„ä»£ç ä¸­æ‰§è¡Œdetachï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸Šé¢çš„åˆ†ç¦»å¤±è´¥çš„æƒ…å†µ</p><h3 id="2-4-3-çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º"><a href="#2-4-3-çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º" class="headerlink" title="2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º"></a>2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º</h3><p>å¦‚æœæ‰§è¡Œå®Œæ¯•<code>pthread_detach</code>åï¼Œä¸»çº¿ç¨‹æå‰é€€å‡ºäº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§ï¼Œçº¿ç¨‹ä¹Ÿè·Ÿç€ä¸€å¹¶é€€å‡ºäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func thread:1 - global:100 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">func thread:2 - global:100 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:2 - global:101 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:1 - global:101 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">func thread:2 - global:102 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:1 - global:102 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">main exit</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>å› ä¸ºçº¿ç¨‹<strong>æ²¡æœ‰ç‹¬ç«‹æ€§</strong>ï¼Œå®Œå…¨å±äºè¿™ä¸ªè¿›ç¨‹ã€‚ä¸å¯èƒ½å‡ºç°ä½ å®¶æˆ¿å­å¡Œäº†ï¼Œä½ è‡ªå·±çš„æˆ¿é—´è¿˜åœ¨çš„æƒ…å†µğŸ˜‚</p><blockquote><p>è¿›ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±å›æ”¶äº†è¿™ä¸ªè¿›ç¨‹çš„ç¨‹åºåœ°å€ç©ºé—´ï¼Œè¿èµ„æºéƒ½è¢«é‡Šæ”¾äº†ï¼Œçº¿ç¨‹å°±æ²¡æœ‰åŠæ³•ç»§ç»­è¿è¡Œï¼Œè‡ªç„¶å°±é€€å‡ºäº†ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬æˆ‘ä»¬åˆ†ç¦»çº¿ç¨‹çš„æ—¶å€™ï¼Œéƒ½å€¾å‘äºè®©ä¸»çº¿ç¨‹ä¿æŒåœ¨åå°è¿è¡Œï¼ˆå¸¸é©»å†…å­˜çš„ç¨‹åºï¼‰</p><h2 id="2-5-gettid-x2F-syscall"><a href="#2-5-gettid-x2F-syscall" class="headerlink" title="2.5 gettid&#x2F;syscall"></a>2.5 gettid&#x2F;syscall</h2><p>è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªç³»ç»Ÿæ¥å£ï¼Œ<strong>ä½†å®ƒå¹¶ä¸èƒ½ç›´æ¥è¿è¡Œ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       gettid - get thread identification</span><br><span class="line">SYNOPSIS</span><br><span class="line">       #include &lt;sys/types.h&gt;</span><br><span class="line">       pid_t gettid(void);</span><br><span class="line"></span><br><span class="line">       Note:  There  is  no  glibc wrapper for this system call; see</span><br><span class="line">       NOTES.</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ç”¨<strong>syscallå‡½æ•°</strong>æ¥è°ƒç”¨è¯¥æ¥å£ï¼Œè¿™ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°syscallå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE         <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span>   <span class="comment">/* For SYS_xxx definitions */</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">syscall</span><span class="params">(<span class="type">int</span> number, ...)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨syscallçš„manæ‰‹å†Œä¸­ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°è·å–çº¿ç¨‹idç›¸å…³çš„ç¤ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EXAMPLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> tid;</span><br><span class="line"></span><br><span class="line">    tid = syscall(SYS_gettid);</span><br><span class="line">    tid = syscall(SYS_tgkill, getpid(), tid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot; tid: &quot;</span> &lt;&lt; <span class="built_in">syscall</span>(SYS_gettid) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">pthread_exit</span>((<span class="type">void</span>*)<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;tis is main - pid:%d - tid:%d\n&quot;</span>,<span class="built_in">getpid</span>(),<span class="built_in">syscall</span>(SYS_gettid));</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹æ‰“å°å‡ºäº†ç›¸åŒçš„PIDå’Œä¸åŒçš„TIDï¼Œå…¶TIDå¯¹åº”çš„å°±æ˜¯<code>ps -aL</code>ä¸­æ˜¾ç¤ºçš„<code>LWP</code>ç¼–å·</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181307710.png" alt="image-20221218130755643"></p><h1 id="3-ç›¸å…³æ¦‚å¿µ"><a href="#3-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="3.ç›¸å…³æ¦‚å¿µ"></a>3.ç›¸å…³æ¦‚å¿µ</h1><h2 id="3-1-çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#3-1-çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ"></a>3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å‰é¢æåˆ°è¿‡ï¼Œ<code>pthread_t</code>æ˜¯çº¿ç¨‹ç‹¬ç«‹çš„idï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ— ç¬¦å·é•¿æ•´å½¢ï¼Œæ‰“å°å‡ºæ¥åï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚è¿™ä¸ªæ•°å­—æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰å—ï¼Ÿ</p><p>å…ˆæ¥å›é¡¾ä¸€ä¸‹çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>çº¿ç¨‹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæµ</li><li>çº¿ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿè‡ªå·±çš„ä¸´æ—¶æ•°æ®</li><li>çº¿ç¨‹è°ƒç”¨å‡½æ•°çš„å‹æ ˆå‡ºæ ˆæ“ä½œï¼Œæœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç»“æ„</li></ul><p>å› æ­¤ï¼Œæ—¢ç„¶æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ ˆç»“æ„ï¼Œå…¶å°±éœ€è¦æœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦æ¥æŒ‡å‘è¿™ä¸ªæ ˆç»“æ„ï¼Œæ–¹ä¾¿ç¨‹åºè¿è¡Œçš„æ—¶å€™è¿›è¡Œè°ƒç”¨ï¼</p><p>æ‰€ä»¥ï¼Œ<code>pthread_t</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåœ°å€ï¼å…¶æŒ‡å‘çš„å°±æ˜¯è¿™ä¸ª<strong>çº¿ç¨‹çš„æ§åˆ¶å—</strong>ï¼Œå…¶å†…éƒ¨åŒ…å«äº†è¿™ä¸ªçº¿ç¨‹çš„ç‹¬ç«‹æ ˆç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//printf(&quot;0x%x  0x%x\n&quot;,t1,t2);</span></span><br><span class="line"><span class="number">0x393d0700</span>  <span class="number">0x38bcf700</span> <span class="comment">//æ‰“å°å‡ºæ¥çš„ç»“æœä¹Ÿå¾ˆåƒåœ°å€</span></span><br></pre></td></tr></table></figure><h2 id="3-2-pthreadåº“"><a href="#3-2-pthreadåº“" class="headerlink" title="3.2 pthreadåº“"></a>3.2 pthreadåº“</h2><p>pthreadåº“å¹¶ä¸æ˜¯ä¸€ä¸ªå†…æ ¸çº§çš„æ¥å£åº“ï¼Œå…¶å®é™…ä¸Šæ˜¯å°è£…äº†ç³»ç»Ÿçš„<code>clone/vfork</code>ç­‰æ¥å£ï¼Œä»è€Œä¸ºæˆ‘ä»¬æä¾›çš„ç”¨æˆ·çº§çš„çº¿ç¨‹åº“ã€‚</p><p>ä½¿ç”¨pthreadåº“åˆ›å»ºçš„è¿›ç¨‹ï¼Œå’Œå†…æ ¸ä¸­çš„LWPæ˜¯<code>1:1</code>çš„</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181023276.png" alt="image-20221218102338117"></p><p>pthreadæ˜¯ä¸€ä¸ª<strong>åŠ¨æ€åº“</strong>ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Šé“¾æ¥é€‰é¡¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ test.cpp -o test -lpthread</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘çš„ <a target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/127668016?spm=1001.2014.3001.5501">åŠ¨é™æ€åº“</a> çš„åšå®¢ä¸­æœ‰è®²è¿°è¿‡ï¼ŒåŠ¨æ€åº“æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™åŠ¨æ€é“¾æ¥çš„ï¼Œå…¶ä¼šå°†åº“ä¸­çš„ä»£ç æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„<code>å…±äº«åŒº</code>ï¼Œä»è€Œè°ƒç”¨åŠ¨æ€åº“ä¸­çš„ä»£ç </p><blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>pthead_create</code>çš„æ—¶å€™ï¼Œ<strong>è¿›ç¨‹ä¼šè·³åˆ°å…±äº«åŒºä¸­</strong>ï¼Œæ‰§è¡ŒåŠ¨æ€åº“ä¸­çš„ä»£ç ï¼Œåˆ›å»ºæˆåŠŸåè¿”å›è‡ªå·±çš„<code>ä»£ç åŒº</code>ï¼Œå®Œæˆä¸€ä¸ªçº¿ç¨‹çš„åˆ›å»º</p></blockquote><p>è€Œçº¿ç¨‹æ‰€ç”¨çš„ç‹¬ç«‹æ ˆï¼Œä¹Ÿæ˜¯pthreadåº“å¸®æˆ‘ä»¬ç®¡ç†çš„ã€‚å› ä¸ºæœ‰å…±äº«åŒºçš„å­˜åœ¨ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡<code>pthread_t</code>ç›´æ¥è®¿é—®åˆ°åŠ¨æ€åº“ä¸­ç®¡ç†çš„<strong>çº¿ç¨‹çš„æ§åˆ¶æ¨¡å—</strong>ï¼Œä»è€Œå®Œæˆçº¿ç¨‹çš„å‹æ ˆã€å‡ºæ ˆç­‰ç­‰æ“ä½œ</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181036505.png" alt="image-20221218103643205"></p><p>ä¸‹ä¸ºlinuxçš„<code>pthreadtypes.h</code>ä¸­çš„éƒ¨åˆ†å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> __SIZEOF_PTHREAD_ATTR_T 36</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">pthread_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">pthread_attr_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> __size[__SIZEOF_PTHREAD_ATTR_T];</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> __align;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __have_pthread_attr_t</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">pthread_attr_t</span> <span class="title">pthread_attr_t</span>;</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __have_pthread_attr_t	1</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h2 id="3-3-çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨"><a href="#3-3-çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨" class="headerlink" title="3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨"></a>3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬æƒ³è®©åˆ›å»ºå‡ºæ¥çš„æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½èƒ½ç‹¬ç«‹çš„ä½¿ç”¨è¿™ä¸ªå…¨å±€å˜é‡ï¼Œé‚£å°±éœ€è¦ç”¨åˆ°çº¿ç¨‹çš„<strong>å±€éƒ¨å­˜å‚¨</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> global = <span class="number">10</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func3</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func thread &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt;  <span class="string">&quot; - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œï¼Œä¸ç®¡æ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œéƒ½æ‰“å°çš„æ˜¯ç›¸åŒçš„å€¼å’Œåœ°å€</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181107524.png" alt="image-20221218110718405"></p><p>å¦‚æœåœ¨æ‰§è¡Œçš„å‡½æ•°<code>func3</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>global++</code>ï¼Œåˆ™èƒ½è§‚å¯Ÿåˆ°æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…¬ç”¨çš„ä¸€ä¸ªå˜é‡ï¼Œè¿™é‡Œçš„+æ˜¯åŒæ­¥çš„ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181110159.png" alt="image-20221218111031984"></p><p>å¦‚æœæˆ‘ä»¬æƒ³è®©<code>int global</code>å˜æˆå±€éƒ¨å˜é‡ï¼Œåˆ™éœ€è¦åœ¨å®ƒä¹‹å‰åŠ ä¸Šä¸€ä¸ª<code>__thread</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__thread <span class="type">int</span> global = <span class="number">100</span>;<span class="comment">//å¯ä»¥è®©çº¿ç¨‹ç‹¬ç«‹ä½¿ç”¨çš„å…¨å±€å˜é‡</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªçº¿ç¨‹å’Œä¸»çº¿ç¨‹æ‰“å°çš„globalå˜é‡åœ°å€ä¸åŒï¼Œä»–ä»¬çš„<code>++</code>æ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼Œå˜é‡çš„å€¼ä¹Ÿæ˜¯ç‹¬ç«‹çš„</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181116428.png" alt="image-20221218111639283"></p><p>è¿™å°±å®ç°äº†å°†æŸä¸€ä¸ªå˜é‡åˆ’åˆ†ç»™çº¿ç¨‹è¿›è¡Œ<strong>å±€éƒ¨å­˜å‚¨</strong></p><h1 id="4-çº¿ç¨‹äº’æ–¥é—®é¢˜"><a href="#4-çº¿ç¨‹äº’æ–¥é—®é¢˜" class="headerlink" title="4.çº¿ç¨‹äº’æ–¥é—®é¢˜"></a>4.çº¿ç¨‹äº’æ–¥é—®é¢˜</h1><h2 id="4-1-ä¸´ç•Œèµ„æº"><a href="#4-1-ä¸´ç•Œèµ„æº" class="headerlink" title="4.1 ä¸´ç•Œèµ„æº"></a>4.1 ä¸´ç•Œèµ„æº</h2><p>åœ¨å…ˆå‰<a target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/127834035?spm=1001.2014.3001.5501">å…±äº«å†…å­˜ ä¿¡å·é‡</a>çš„åšå®¢ä¸­ï¼Œå·²ç»æ¶‰åŠåˆ°äº†è¿™éƒ¨åˆ†çš„å†…å®¹ï¼›å³å…³äºæ“ä½œ<strong>åŸå­æ€§</strong>å’Œè®¿é—®<strong>ä¸´ç•Œèµ„æº&#x2F;ä¸´ç•ŒåŒº</strong>çš„ç›¸å…³é—®é¢˜ã€‚</p><ul><li>èƒ½è¢«å¤šä¸ªè¿›ç¨‹&#x2F;çº¿ç¨‹çœ‹åˆ°çš„èµ„æºï¼Œè¢«ç§°ä¸º<code>ä¸´ç•Œèµ„æº</code></li><li>è¿›ç¨‹&#x2F;çº¿ç¨‹è®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ï¼Œè¢«ç§°ä¸º<code>ä¸´ç•ŒåŒº</code></li></ul><p>åœ¨çº¿ç¨‹ä¸­ï¼ŒåŒæ ·å­˜åœ¨è®¿é—®<strong>ä¸´ç•Œèµ„æº</strong>è€Œå¯¼è‡´çš„å†²çªï¼š</p><ul><li>çº¿ç¨‹Aå¯¹ä¸€ä¸ª<strong>å…¨å±€å˜é‡val</strong>è¿›è¡Œäº†<code>-1</code>æ“ä½œï¼Œå½“æ“ä½œæ‰§è¡Œåˆ°æ”¾å›å†…å­˜é‚£ä¸€æ­¥çš„æ—¶å€™ï¼Œå‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹Bå¼€å§‹å·¥ä½œ</li><li>çº¿ç¨‹BåŒæ ·è®¿é—®äº†è¯¥å…¨å±€å˜é‡valï¼Œå¯¹å®ƒè¿›è¡Œäº†<code>-10</code>æ“ä½œï¼Œæ­¤æ—¶å› ä¸ºçº¿ç¨‹Açš„<code>-1</code>æ“ä½œå°šæœªå†™å›å†…å­˜ï¼Œå…¨å±€å˜é‡valè¿˜æ˜¯ä¿æŒåˆå€¼ã€‚çº¿ç¨‹bå°†<code>-10</code>ä¹‹åçš„å…¨å±€å˜é‡valå†™å›äº†å†…å­˜</li><li>åˆå‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œè·³è½¬åˆ°çº¿ç¨‹Aåœæ­¢çš„<strong>çº¿ç¨‹ä¸Šä¸‹æ–‡æ•°æ®</strong>ä¸­å¼€å§‹æ‰§è¡Œï¼Œå°†å…¨å±€å˜é‡å†™å…¥å†…å­˜</li><li>è¿™æ—¶å€™ï¼Œçº¿ç¨‹Bçš„<code>-10</code>æ“ä½œå°±è¢«Açš„å†™å…¥è¦†ç›–äº†ï¼</li></ul><p>ä¸¾ä¸ªå®é™…ç‚¹çš„ä¾‹å­ï¼Œä»¥100ä¸ºå…¨å±€å˜é‡çš„åˆå§‹å€¼</p><ul><li>çº¿ç¨‹Aæ‰§è¡Œ-1ï¼Œ<code>100-1=99</code>ï¼Œè¿˜æœªå†™å…¥å†…å­˜æ—¶ï¼Œå°±çº¿ç¨‹åˆ‡æ¢</li><li>çº¿ç¨‹Bå–åˆ°çš„å…¨å±€å˜é‡è¿˜æ˜¯100ï¼Œå¯¹å…¶æ‰§è¡Œ-10ï¼Œå¹¶å†™å…¥å†…å­˜ï¼Œ æ­¤æ—¶å…¨å±€å˜é‡ä¸º90</li><li>è¿”å›çº¿ç¨‹Aç»§ç»­æ‰§è¡Œå†™å…¥å†…å­˜æ“ä½œï¼Œå…¨å±€å˜é‡åˆè¢«å¤å†™æˆäº†99ï¼›<strong>ç›¸å½“äºBçš„æ“ä½œæ˜¯æ— æ•ˆçš„</strong></li></ul><p>è¿™ç§æ¡ä»¶ä¸‹ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ï¼</p><h2 id="4-2-åŸå­-x2F-äº’æ–¥æ€§"><a href="#4-2-åŸå­-x2F-äº’æ–¥æ€§" class="headerlink" title="4.2 åŸå­&#x2F;äº’æ–¥æ€§"></a>4.2 åŸå­&#x2F;äº’æ–¥æ€§</h2><p>è¿™ç§æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿è¯è®¿é—®è¯¥å…¨å±€å˜é‡çš„æ“ä½œæ˜¯<strong>åŸå­</strong>çš„ï¼Œä¸èƒ½å‡ºç°ä¸­é—´çŠ¶æ€ï¼›</p><p>ä¹Ÿåº”è¯¥æ˜¯<strong>äº’æ–¥</strong>çš„ï¼Œä¸èƒ½å‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä»½èµ„æºçš„æƒ…å†µ</p><blockquote><p>äº’æ–¥æ€§ï¼šä»»ä½•æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµåœ¨è®¿é—®æŸä¸€ä»½èµ„æº</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212181937011.png" alt="image-20221218193343035"></p><p>æ“ä½œç³»ç»Ÿç»´æŠ¤åŸå­æ€§ï¼Œå°±å¿…é¡»ä¿è¯è¯¥æ“ä½œ<strong>åªç”¨ä¸€æ¡æ±‡ç¼–è¯­å¥</strong>æ‰§è¡Œï¼ˆè¿™æ ·æ‰ä¸ä¼šå‡ºç°è¿›ç¨‹&#x2F;çº¿ç¨‹åˆ‡æ¢å¯¼è‡´çš„é—®é¢˜ï¼‰è¿™ä¸ªåœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»</p><p>ä¸ºäº†è¾¾æˆè¿™ä¸€ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»™çº¿ç¨‹çš„æ“ä½œ<strong>åŠ é”</strong></p><h2 id="4-3-çº¿ç¨‹åŠ é”"><a href="#4-3-çº¿ç¨‹åŠ é”" class="headerlink" title="4.3 çº¿ç¨‹åŠ é”"></a>4.3 çº¿ç¨‹åŠ é”</h2><p>çº¿ç¨‹åŠ é”æ¶‰åŠåˆ°å‡ ä¸ªæ“ä½œï¼š</p><ul><li>æä¾›ä¸€æŠŠé”</li><li>åœ¨éœ€è¦ç»´æŒåŸå­æ€§ï¼ˆä¸´ç•ŒåŒºï¼‰çš„ä½ç½®åŠ ä¸Šé”</li><li>è®¿é—®ä¸´ç•ŒåŒºç»“æŸåï¼Œæ‰“å¼€é”</li><li>è¿›ç¨‹ç»“æŸåï¼ŒæŠŠé”ä¸¢äº†</li></ul><p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜</p><h3 id="4-3-1-pthread-mutex-init"><a href="#4-3-1-pthread-mutex-init" class="headerlink" title="4.3.1 pthread_mutex_init"></a>4.3.1 pthread_mutex_init</h3><p>pthreadçº¿ç¨‹åº“åœ¨è®¾è®¡ä¹‹åˆå°±è€ƒè™‘åˆ°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥å®ƒä¾¿ç»™æˆ‘ä»¬æä¾›äº†åŠ é”ç›¸å…³çš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_destroy</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">                       <span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€æŠŠé”ï¼Œç±»å‹æ˜¯<code>pthread_mutex_t</code></p><ul><li>å¦‚æœæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€æŠŠ<strong>å…¨å±€å˜é‡</strong>çš„é”ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨èµ‹å€¼<code>PTHREAD_MUTEX_INITIALIZER</code>ç»™è¿™æŠŠé”åˆå§‹åŒ–</li><li>å¦‚æœæ˜¯ä¸€æŠŠå±€éƒ¨çš„é”ï¼Œåˆ™ä½¿ç”¨å‡½æ•°<code>pthread_mutex_init</code>è¿›è¡Œåˆå§‹åŒ–</li></ul><p>åˆå§‹åŒ–çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä¼ å…¥é”å’Œå¯¹åº”çš„å±æ€§å°±è¡Œã€‚æ­¤æ—¶æˆ‘ä»¬å¿½ç•¥å±æ€§é—®é¢˜ï¼Œè®¾ç½®ä¸º<code>NULL</code>ä½¿ç”¨<strong>é»˜è®¤å±æ€§</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨é»˜è®¤å±æ€§çš„å…¨å±€é”oré™æ€staticé”</span></span><br><span class="line"><span class="comment">//æ— é¡»è°ƒç”¨å‡½æ•°åˆå§‹åŒ–ï¼Œå¯ä»¥ç›´æ¥ç”¨</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨å‡½æ•°è¿›è¡Œåˆå§‹åŒ–å±€éƒ¨çš„é”ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åˆå§‹åŒ–å…¨å±€é”ï¼‰</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;<span class="comment">//å®šä¹‰ä¸€æŠŠé”</span></span><br><span class="line">pthread_mutex_init(&amp;mutex, nullptr);<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">pthread_mutex_destroy(&amp;mutex);<span class="comment">//é”€æ¯</span></span><br></pre></td></tr></table></figure><h3 id="4-3-2-åŠ é”-x2F-è§£é”"><a href="#4-3-2-åŠ é”-x2F-è§£é”" class="headerlink" title="4.3.2 åŠ é”&#x2F;è§£é”"></a>4.3.2 åŠ é”&#x2F;è§£é”</h3><p>æœ‰äº†é”ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨éœ€è¦çš„ä½ç½®åŠ ä¸Šè¿™æŠŠé”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_lock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_unlock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­lockæ˜¯<strong>é˜»å¡å¼</strong>åŠ é”ï¼Œå¦‚æœä½ è°ƒç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œé”æ­£åœ¨è¢«åˆ«äººä½¿ç”¨ï¼Œåˆ™ä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›trylockæ˜¯<strong>éé˜»å¡</strong>åŠ é”ï¼Œå¦‚æœä½ è°ƒç”¨è¯¥æ¥å£æ—¶é”æ­£è¢«ä½¿ç”¨ï¼Œåˆ™ç›´æ¥<code>return</code>è¿”å›ï¼ˆç›¸å½“äºçœ‹çœ‹é”èƒ½å¦è¢«è·å–ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The pthread_mutex_trylock() function shall be equivalent to pthread_mutex_lock(), except that if the mutex object referenced  by  mutex  is  currently locked (by any thread, including the current thread), the call shall return immediately. </span><br></pre></td></tr></table></figure><p>åŠ äº†é”ä¹‹åï¼Œåœ¨éœ€è¦çš„ä½ç½®<code>unlock</code>è§£é”ï¼›</p><ul><li>åŠ é”å’Œè§£é”æ“ä½œ<strong>æœ¬èº«</strong>æ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°å†²çª</li><li>åŠ äº†é”ä¹‹åï¼Œå¯ä»¥ç†è§£ä¸ºåŠ é”è§£é”æ“ä½œ<strong>ä¸­é—´</strong>çš„ä»£ç ä¹Ÿæ˜¯åŸå­æ€§çš„ï¼Œ<strong>å¿…é¡»è¦è¿è¡Œåˆ°è§£é”ä½ç½®</strong>æ‰èƒ½è®©å¦å¤–ä¸€ä¸ªçº¿ç¨‹&#x2F;è¿›ç¨‹æ‰§è¡Œè¿™é‡Œçš„ä»£ç </li><li>åŠ é”çš„æœ¬è´¨æ˜¯è®©çº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ä¸²è¡ŒåŒ–</li></ul><h3 id="4-3-3-åŠ é”çš„æ³¨æ„äº‹é¡¹"><a href="#4-3-3-åŠ é”çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹"></a>4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹</h3><ul><li>åªå¯¹ä¸´ç•ŒåŒºåŠ é”ï¼›é”ä¿æŠ¤çš„å°±æ˜¯ä¸´ç•ŒåŒº</li><li>åŠ é”çš„ç²’åº¦è¶Šç»†è¶Šå¥½ï¼ˆå³åŠ é”çš„åŒºåŸŸè¶Šå°è¶Šå¥½ã€‚å¦‚æœè®¿é—®çš„ä¸æ˜¯ä¸´ç•ŒåŒºï¼Œåˆ™å¯ä»¥ä¸è€ƒè™‘åŠ é”ï¼‰</li><li>åŠ é”æ˜¯ç¼–ç¨‹çš„ä¸€ç§è§„èŒƒï¼›åœ¨å®é™…é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬è¦ä¿è¯<strong>è®¿é—®æŸä¸€ä¸´ç•Œèµ„æº</strong>çš„<strong>æ‰€æœ‰æ“ä½œ</strong>éƒ½è¦åŠ ä¸Šé”ã€‚ä¸èƒ½å‡ºç°å‡½æ•°AåŠ é”äº†ï¼Œä½†æ˜¯Bæ²¡æœ‰åŠ é”çš„æƒ…å†µï¼ˆè¿™æ ·ä¼šå¯¼è‡´Açš„åŠ é”ä¹Ÿæ²¡æœ‰æ„ä¹‰ï¼‰</li></ul><h2 id="4-4-ç¤ºä¾‹-å€’æ°´é—®é¢˜"><a href="#4-4-ç¤ºä¾‹-å€’æ°´é—®é¢˜" class="headerlink" title="4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜"></a>4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜</h2><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212240951765.png" alt="image-20221224095101707"></p><p>ä»¥<strong>å€’æ°´</strong>ä¸ºç¤ºä¾‹ï¼Œå‡è®¾æ¯å­å®¹é‡ä¸º10000ï¼Œ<strong>è£…æ»¡äº†æ°´å°±ä¼šæº¢å‡º</strong>ã€‚æˆ‘ä»¬ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªæ¯å­åŠ æ°´ï¼Œç›´åˆ°æ»¡äº†ä¹‹åçº¿ç¨‹é€€å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//ä¸´ç•Œèµ„æº</span></span><br><span class="line"><span class="type">int</span> water = <span class="number">0</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="type">int</span> cup = <span class="number">10000</span>;<span class="comment">//æ¯å­çš„å®¹é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)<span class="comment">//ä¸´ç•ŒåŒº</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº† &quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2,t3,t4;<span class="comment">//åˆ›å»º4ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t3,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t3&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t4,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›´æ¥åˆ†ç¦»çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t3);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ;<span class="comment">//å•¥éƒ½ä¸å¹²</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼Œæ˜æ˜æ°´å·²ç»æ»¡äº†ï¼Œä½†è¿˜æ˜¯ä¼šæœ‰éƒ¨åˆ†çº¿ç¨‹æŠ¥å‘Šæ°´è¿˜æ²¡æœ‰æ»¡ï¼Œä¸”æ•°å­—æœ‰å¾ˆä¸¥é‡çš„åå·®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9993</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9994</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line"> æ°´æ²¡æœ‰æ»¡ï¼š2723</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">0</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9668</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><p>å¤šè¿è¡Œå‡ æ¬¡ï¼Œä¹Ÿèƒ½å‘ç°ç›¸åŒçš„é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š1889</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10001</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š0</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10002</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š0</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10003</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><h3 id="4-4-1-åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ"><a href="#4-4-1-åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ" class="headerlink" title="4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ"></a>4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ</h3><p>é™¤äº†åå·®å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå¾€å‰ç¿»æ‰“å°è®°å½•ï¼Œä¼šå‘ç°ä¸€ç›´éƒ½æ˜¯<strong>æŸä¸€ä¸ªçº¿ç¨‹åœ¨å€’æ°´</strong>ï¼Œå…¶ä»–çº¿ç¨‹ä¼¼ä¹å•¥äº‹æ²¡æœ‰å¹²ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9786</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9787</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9788</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9789</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9790</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºå½“è¿è¡Œt3çš„æ—¶å€™ï¼Œt3åœ¨whileå¾ªç¯ä¸­ç»§ç»­è¿è¡Œçš„æ¶ˆè€—ï¼Œ<strong>å°äºåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹çš„æ¶ˆè€—</strong>ã€‚æ‰€ä»¥æ§åˆ¶å—å°±è®©t3ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å®ƒbreaké€€å‡ºå¾ªç¯</p><p>æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦åŠ ä¸Šä¸€ä¸ªusleepï¼Œå¢åŠ æ¯ä¸€ä¸ªwhileå¾ªç¯ä¸­éœ€è¦<strong>å¤„ç†çš„è´Ÿæ‹…</strong>ï¼Œå°±èƒ½è®©æ‰€æœ‰çº¿ç¨‹éƒ½æ¥å€’æ°´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//usleepåŠŸèƒ½æŠŠè¿›ç¨‹æŒ‚èµ·ä¸€æ®µæ—¶é—´ï¼Œ å•ä½æ˜¯å¾®ç§’ï¼ˆç™¾ä¸‡åˆ†ä¹‹ä¸€ç§’ï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">usleep</span><span class="params">(<span class="type">useconds_t</span> usec)</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºçº¿ç¨‹åˆ‡æ¢åŒæ ·ä¹Ÿæ˜¯æ—¶é—´ç‰‡åˆ°äº†ï¼Œä»å†…æ ¸è¿”å›ç”¨æˆ·æ€çš„æ—¶å€™åšæ£€æµ‹ï¼Œåˆ‡æ¢è‡³å…¶ä»–çº¿ç¨‹ã€‚</p><p>æ·»åŠ usleepèƒ½åˆ›é€ æ›´å¤š<strong>å†…æ ¸&#x2F;ç”¨æˆ·çš„ä¸­é—´æ€</strong>ï¼Œä»è€Œå¢å¤šåˆ‡æ¢çº¿ç¨‹çš„æ¬¡æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//ä¼‘æ¯100å¾®ç§’</span></span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº†&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™è¿˜æ˜¯æ²¡æœ‰è§£å†³æ•°å­—å‡ºé”™çš„é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š10000</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10001</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š10001</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10002</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š10002</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10003</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><h3 id="4-4-2-åŠ é”-é—®é¢˜è§£å†³"><a href="#4-4-2-åŠ é”-é—®é¢˜è§£å†³" class="headerlink" title="4.4.2 åŠ é”-é—®é¢˜è§£å†³"></a>4.4.2 åŠ é”-é—®é¢˜è§£å†³</h3><p>è¿™æ—¶å€™å°±éœ€è¦è¯·å‡ºæˆ‘ä»¬çš„é”äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//çœç•¥å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="type">int</span> water = <span class="number">0</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="type">int</span> cup = <span class="number">10000</span>;<span class="comment">//æ¯å­çš„å®¹é‡</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//å‡è£…å–æ°´</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº† &quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">            <span class="comment">//æ­¤å¤„ä¹Ÿéœ€è¦åŠ é”ï¼Œå¦åˆ™breakå‡ºå»ä¹‹åå…¶ä»–çº¿ç¨‹ä¼šå› ä¸ºæ²¡æœ‰è§£é”è€ŒæŒ‚èµ·</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœé‡åˆ°2å·ä¿¡å·ï¼Œå°±åœ¨é”€æ¯é”åé€€å‡ºè¿›ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">des</span><span class="params">(<span class="type">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//é”€æ¯é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;mutex);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;pthread_mutex_destroy, exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT,des);<span class="comment">//è‡ªå®šä¹‰æ•æ‰2å·ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;mutex,<span class="literal">nullptr</span>);<span class="comment">//åˆå§‹åŒ–é”</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t1,t2,t3,t4;<span class="comment">//åˆ›å»º4ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t3,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t3&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t4,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›´æ¥åˆ†ç¦»çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t3);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ;<span class="comment">//å•¥éƒ½ä¸å¹²</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¯è§ï¼Œæ•°å­—é”™è¯¯é—®é¢˜å°±æ²¡æœ‰å‡ºç°äº†ï¼›<strong>ä½†åˆå‡ºç°äº†åªæœ‰ä¸€ä¸ªçº¿ç¨‹å·¥ä½œçš„é—®é¢˜</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9996</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9997</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9998</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9999</span></span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">^Cpthread_mutex_destroy, exit</span><br></pre></td></tr></table></figure><p>è¿™è¿˜æ˜¯å› ä¸ºçº¿ç¨‹åˆ‡æ¢çš„æ•ˆç‡é—®é¢˜ï¼›ä¹Ÿæœ‰å¯èƒ½æ˜¯å› ä¸ºå…¶å®ƒçº¿ç¨‹ç”³è¯·é”çš„æ—¶å€™ï¼Œå‘ç°t1åœ¨ç”¨ï¼Œå°±è¿›è¡Œäº†<strong>é˜»å¡ç­‰å¾…</strong>è€ŒæŒ‚èµ·</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212191022656.png" alt="image-20221219102217522"></p><p>åªéœ€è¦åœ¨è§£é”ä¹‹åæ·»åŠ ä¸€ä¸ª<code>usleep</code>æ¨¡æ‹Ÿå…¶ä»–å·¥ä½œï¼Œå°±èƒ½è®©æ‰€æœ‰çº¿ç¨‹éƒ½è·‘èµ·æ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line"><span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">100</span>);</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    water++;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//å‡è£…å–æ°´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å‡ºç°æ•°æ®é”™è¯¯ï¼ŒåŠ é”çš„ç›®çš„æˆåŠŸè¾¾åˆ°ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9993</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9994</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">^Cpthread_mutex_destroy, exit</span><br></pre></td></tr></table></figure><h2 id="4-5-åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š"><a href="#4-5-åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š" class="headerlink" title="4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š"></a>4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š</h2><p>åœ¨è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç»™ä¸­é—´çš„å‡ è¡Œä»£ç åŠ äº†é”ï¼›ä½†è¿™å¹¶ä¸æ„å‘³ç€æ‰§è¡Œä¸­é—´è¿™éƒ¨åˆ†ä»£ç çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pthread_mutex_lock</span>(&amp;mutex);<span class="comment">//åŠ é”</span></span><br><span class="line"><span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">&#123;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    water++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);<span class="comment">//è§£é”</span></span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šï¼Œä»£ç æ‰§è¡Œçš„ä»»ä½•åœ°æ–¹ï¼Œéƒ½å¯èƒ½å‘ç”Ÿè¿›ç¨‹&#x2F;çº¿ç¨‹çš„åˆ‡æ¢ã€‚ä½†å› ä¸ºæˆ‘ä»¬åŠ äº†é”ï¼Œåˆ‡æ¢çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹è¦æ¥è®¿é—®è¿™é‡Œçš„èµ„æºï¼Œ<strong>å°±å¿…é¡»å…ˆç”³è¯·é”</strong></p><p>æ­¤æ—¶é”åœ¨<strong>è¢«åˆ‡èµ°çš„è¿›çº¿ç¨‹æ‰‹ä¸Š</strong>ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ä¸´ç•ŒåŒºçš„èµ„æºï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202211031203810.gif" alt="QQå›¾ç‰‡20220504102516"></p><blockquote><p>æ¢è¨€ä¹‹ï¼Œåªè¦<strong>å¼ ä¸‰</strong>æ‹¿åˆ°äº†é”ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå°±ä¸æ‹…å¿ƒè‡ªå·±çš„å·¥ä½œä¼šè¢«åˆ«äººè¦†ç›–çš„é—®é¢˜ï¼›</p><p>è€Œå¯¹å…¶ä»–çº¿ç¨‹è€Œè¨€ï¼Œå¼ ä¸‰è®¿é—®ä¸´ç•ŒåŒºçš„å·¥ä½œï¼Œåªæœ‰<strong>è¿˜æ²¡è¿›å…¥</strong>ä¸´ç•ŒåŒºå’Œ<strong>è®¿é—®å®Œæ¯•</strong>ä¸´ç•ŒåŒºä¸¤ç§çŠ¶æ€</p></blockquote><p>å› æ­¤ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯çº¿ç¨‹åˆ‡æ¢çš„æ•ˆç‡è¾ƒä½ï¼Œå…¶ä»–çº¿ç¨‹å‡ºç°äº†é˜»å¡ç­‰å¾…çš„æƒ…å†µï¼›ä¸ºäº†é¿å…æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥è®©è®¿é—®ä¸´ç•ŒåŒºçš„æ“ä½œå¿«å»å¿«å›ï¼Œå°½é‡ä¸è¦åœ¨ä¸´ç•ŒåŒºé‡Œé¢å¹²å•¥è€—æ—¶çš„äº‹æƒ…</p><h3 id="4-5-1-åŠ é”åŸå­æ€§çš„ä¿è¯"><a href="#4-5-1-åŠ é”åŸå­æ€§çš„ä¿è¯" class="headerlink" title="4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯"></a>4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯</h3><blockquote><p>å¤‡æ³¨ï¼šè¿™éƒ¨åˆ†ä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œè‹¥æœ‰é”™è¯¯ï¼Œè¿˜è¯·æŒ‡å‡ºï¼</p></blockquote><p>é‚£ä¹ˆåŠ é”è¿™ä¸ªæ“ä½œï¼Œæ˜¯å¦‚ä½•ä¿è¯å…¶è‡ªèº«çš„åŸå­æ€§å‘¢ï¼Ÿåœ¨åŠ é”çš„é€”ä¸­ä¸ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢å—ï¼Ÿ</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212240939271.png" alt="Snipaste_2022-12-24_09-38-46"></p><p>æˆ‘æ‰¾åˆ°äº†ä¸€å¼ èƒ½å¤§æ¦‚è¯´æ˜æ±‡ç¼–åŠ é”è¿‡ç¨‹çš„å›¾ç‰‡ï¼Œå…¶ä¸­<code>movb</code>çš„æ“ä½œå°±æ˜¯å°†alå¯„å­˜å™¨å†™ä¸º0ï¼Œ<code>xchgb</code>çš„æ“ä½œæ˜¯å°†alå¯„å­˜å™¨çš„å†…å®¹å’Œå†…å­˜ä¸­mutexé”çš„å€¼è¿›è¡Œäº¤æ¢</p><ul><li>å¼€å§‹çš„æ—¶å€™ï¼Œé”è¢«æ­£å¸¸åˆå§‹åŒ–ï¼Œå†…å­˜ä¸­mutexçš„å€¼ä¸º1ï¼ˆé”åªä¼šè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼‰</li><li>çº¿ç¨‹Aå¼€å§‹åŠ é”ï¼Œalå¯„å­˜å™¨å’Œmutexçš„å€¼å‘ç”Ÿäº¤æ¢ï¼Œæ­¤æ—¶å†…å­˜ä¸­çš„mutexä¸º0ï¼Œalä¸º1</li><li>åˆ¤æ–­alä¸ä¸º0ï¼Œä»£è¡¨è·å–é”æˆåŠŸï¼Œçº¿ç¨‹AåŠ é”æˆåŠŸ</li><li>çº¿ç¨‹Bä¹Ÿæ¥ç”³è¯·é”äº†ï¼Œ<code>movb</code>å°†alå¯„å­˜å™¨å†™ä¸º0ï¼Œå†å’Œå†…å­˜ä¸­çš„mutexäº¤æ¢åï¼Œå‘ç°è¿˜æ˜¯0ï¼Œåˆ™ä»£è¡¨é”åœ¨åˆ«äººæ‰‹ä¸Šï¼Œæ­¤æ—¶å°±éœ€è¦æŒ‚èµ·ç­‰å¾…</li></ul><p>å‰é¢ä¸€ç›´å¼ºè°ƒï¼Œçº¿ç¨‹æ˜¯æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç»“æ„å’Œä¸Šä¸‹æ–‡æ•°æ®çš„ï¼Œåœ¨åŠ é”çš„è¿™éƒ¨åˆ†æ±‡ç¼–æ“ä½œä¸­ï¼ŒåŒæ ·å¯èƒ½ä¼šåœ¨ä»»ä½•åœ°æ–¹å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ã€‚åˆ‡æ¢çš„æ—¶å€™ï¼Œçº¿ç¨‹çš„<strong>ä¸Šä¸‹æ–‡æ•°æ®</strong>ï¼ˆå›¾ä¸­å¯„å­˜å™¨çš„çŠ¶æ€ï¼‰ä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼Œ<strong>éšè¿™ä¸ªçº¿ç¨‹ä¸€èµ·è¢«åˆ‡æ¢èµ°</strong></p><p>æ‰€ä»¥çº¿ç¨‹Aè¢«åˆ‡æ¢çš„æ—¶å€™ï¼Œå±äºå®ƒä¸Šä¸‹æ–‡ä¸­é‚£ä¸ªå€¼ä¸º1çš„alå¯„å­˜å™¨ä¹Ÿè¢«åˆ‡èµ°äº†ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œåˆ‡èµ°çš„æ˜¯æ•°æ®ï¼Œalå¯„å­˜å™¨æœ¬èº«ä½œä¸ºç¡¬ä»¶ï¼Œ<strong>æœ‰ä¸”åªæœ‰ä¸€ä¸ª</strong>ï¼‰</p><p>ç”±æ­¤çœ‹æ¥ï¼ŒçœŸæ­£è·å–é”çš„æ“ä½œï¼Œå…¶å®åªæœ‰<code>xchgb</code>ä¸€æ¡äº¤æ¢æŒ‡ä»¤æ¥å®Œæˆï¼Œ<font color="Red">ä¿è¯åŠ é”æ“ä½œåªç”±ä¸€æ¡æ±‡ç¼–è¯­å¥å®ç°</font>ï¼Œå°±èƒ½ä¿è¯è¯¥æ“ä½œçš„åŸå­æ€§ï¼</p><p>è§£é”çš„æ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œ<code>movb</code>å°†1å†™å›mutexå˜é‡å³å¯ï¼Œä¹Ÿæ˜¯ä¸€æ¡æ±‡ç¼–å®Œæˆï¼›è€Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè§£é”æ˜¯ä¸ä¼šæœ‰æ‰§è¡Œæµå’Œä½ æŠ¢çš„ã€‚</p><blockquote><p>å…¶å®åŠ é”è¿œä¸æ­¢ä¸€ç§æ–¹æ³•ï¼Œé”çš„ç§ç±»æœ‰éå¸¸å¤šï¼Œè¿˜æœ‰<strong>æ€»çº¿é”ã€æ—‹è½¬é”</strong>ç­‰ç­‰ï¼Œæ¯ä¸€ä¸ªé”çš„å®ç°éƒ½ä¸å¤ªä¸€æ ·ï¼ä¸Šé¢æåˆ°çš„ä¸º<code>äº’æ–¥é”</code></p></blockquote><h3 id="4-5-2-æ€»çº¿é”"><a href="#4-5-2-æ€»çº¿é”" class="headerlink" title="4.5.2 æ€»çº¿é”"></a>4.5.2 æ€»çº¿é”</h3><p>ç°åœ¨çš„CPUä¸€èˆ¬éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨ç¼“å­˜ï¼Œæ ¹æ®ä¸€äº›è§„åˆ™å°†å†…å­˜ä¸­çš„æ•°æ®è¯»å–åˆ°å†…éƒ¨ç¼“å­˜ä¸­æ¥ï¼Œä»¥åŠ å¿«é¢‘ç¹è¯»å–çš„é€Ÿåº¦ã€‚ç°åœ¨æœåŠ¡å™¨é€šå¸¸æ˜¯å¤š CPUï¼Œæ›´æ™®éçš„æ˜¯ï¼Œæ¯å—CPUé‡Œæœ‰å¤šä¸ªå†…æ ¸ï¼Œè€Œæ¯ä¸ªå†…æ ¸éƒ½ç»´æŠ¤äº†è‡ªå·±çš„ç¼“å­˜ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¤šçº¿ç¨‹å¹¶å‘å°±ä¼šå­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´æ€§ï¼Œè¿™ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜ã€‚</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202301031154743.webp" alt="img"></p><p>æ€»çº¿é”å°±æ˜¯å°†cpuå’Œå†…å­˜ä¹‹é—´çš„<strong>é€šä¿¡</strong>é”ä½ï¼Œä½¿å¾—åœ¨é”å®šæœŸé—´ï¼Œå…¶ä»–cpuå¤„ç†å™¨ä¸èƒ½æ“ä½œå…¶ä»–å†…å­˜ä¸­æ•°æ®ï¼Œæ•…æ€»çº¿é”å¼€é”€æ¯”è¾ƒå¤§ï¼</p><p>æ€»çº¿é”çš„å®ç°æ˜¯é‡‡ç”¨cpuæä¾›çš„<code>LOCK#</code>ä¿¡å·ï¼Œå½“ä¸€ä¸ªcpuåœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶ä»–cpuçš„è¯·æ±‚å°†è¢«é˜»å¡ï¼Œé‚£ä¹ˆè¯¥cpuåˆ™<strong>ç‹¬å å…±äº«å†…å­˜</strong>ï¼Œç›¸å½“äºé”ä½äº†</p><ul><li>ä½•ä¸ºæ€»çº¿ï¼Ÿ</li></ul><p>CPUæ€»çº¿æ˜¯æ‰€æœ‰CPUä¸èŠ¯ç‰‡ç»„è¿æ¥çš„ä¸»å¹²é“ï¼Œ<strong>è´Ÿè´£CPUä¸å¤–ç•Œæ‰€æœ‰éƒ¨ä»¶çš„é€šä¿¡</strong>ï¼ŒåŒ…æ‹¬é«˜é€Ÿç¼“å­˜ã€å†…å­˜ã€åŒ—æ¡¥ï¼Œå…¶æ§åˆ¶æ€»çº¿å‘å„ä¸ªéƒ¨ä»¶å‘é€æ§åˆ¶ä¿¡å·ã€é€šè¿‡åœ°å€æ€»çº¿å‘é€åœ°å€ä¿¡å·æŒ‡å®šå…¶è¦è®¿é—®çš„éƒ¨ä»¶ã€é€šè¿‡æ•°æ®æ€»çº¿åŒå‘ä¼ è¾“</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202301031153214.png" alt="image-20230103115306140"></p><h1 id="5-æ­»é”"><a href="#5-æ­»é”" class="headerlink" title="5.æ­»é”"></a>5.æ­»é”</h1><p>æ­»é”å°±æ˜¯ä¸€ç§å› ä¸ºä¸¤æ”¾éƒ½ä¸ä¼šé‡Šæ”¾å¯¹æ–¹éœ€è¦çš„èµ„æºï¼Œä»è€Œé™·å…¥çš„æ°¸ä¹…ç­‰å¾…çŠ¶æ€</p><h2 id="5-1-æ­»é”æƒ…å†µæ¼”ç¤º"><a href="#5-1-æ­»é”æƒ…å†µæ¼”ç¤º" class="headerlink" title="5.1 æ­»é”æƒ…å†µæ¼”ç¤º"></a>5.1 æ­»é”æƒ…å†µæ¼”ç¤º</h2><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¼ ä¸‰æ‹¿äº†é”Aï¼Œç”³è¯·é”Bçš„æ—¶å€™ï¼Œå‘ç°é”Bæ— æ³•ç”³è¯·ï¼Œè€Œè¿›å…¥ç­‰å¾…ï¼›æå››æ‹¿äº†é”Bï¼Œæ¥ä¸‹æ¥ä»–æƒ³ç”³è¯·é”Aï¼Œç»“æœå‘ç°å¼ ä¸‰æ‹¿ç€é”Aï¼Œé‚£å°±åªèƒ½è¿›å…¥ç­‰å¾…ã€‚è¿™å°±é™·å…¥äº†ä¸€ä¸ªåƒµå±€ï¼Œå¼ ä¸‰æƒ³è¦æå››çš„ï¼Œæå››æƒ³è¦å¼ ä¸‰çš„ï¼Œè°éƒ½ä¸è®©è°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> m1;<span class="comment">//é”1</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> m2;<span class="comment">//é”2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m2,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ†ç¦»</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;main running...&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m1);</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™ä¸ªä»£ç ä¾¿èƒ½æ¨¡æ‹Ÿå‡ºè¿™ä¸ªæƒ…å†µï¼Œçº¿ç¨‹1å…ˆè¦äº†é”1ï¼Œå†è¦é”2ï¼›çº¿ç¨‹2å…ˆè¦é”2å†è¦é”1ï¼Œä»–ä»¬ä¿©å°±å®¹æ˜“æ‰“èµ·æ¥ï¼Œé€ æˆæ­»é”ã€‚</p><p>è¿è¡Œä»£ç çš„æ—¶å€™æˆ‘ä»¬å´å‘ç°ï¼Œä¼¼ä¹å¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œçº¿ç¨‹1å¥½åƒè¿˜æ˜¯æˆåŠŸæ‹¿åˆ°äº†ä¿©æŠŠé”ï¼Œå¹¶è¿è¡Œäº†èµ·æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-23_çº¿ç¨‹æ­»é”]$ ./test</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br></pre></td></tr></table></figure><p>é‚£æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ‰§è¡Œå…¶ä»–ä¸€äº›å·¥ä½œï¼Œä»è€Œå°†çº¿ç¨‹1å’Œ2ç”³è¯·é”çš„æ—¶é—´é”™å¼€</p><p>å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·ï¼Œåˆ©ç”¨<code>usleep</code>è®©ä¸¤ä¸ªçº¿ç¨‹ä¼‘çœ ä¸åŒæ—¶é—´ï¼Œç»“æœå°±ä¸åŒäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200</span>);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">300</span>);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶åªæœ‰ä¸»çº¿ç¨‹åœ¨è¿è¡Œï¼Œçº¿ç¨‹t1å’Œt2å‡ºç°äº†æ­»é”ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-23_çº¿ç¨‹æ­»é”]$ ./test</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br></pre></td></tr></table></figure><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202211031204889.jpg" alt="QQå›¾ç‰‡20220519220428"></p><h2 id="5-2-æ­»é”çš„æ¡ä»¶"><a href="#5-2-æ­»é”çš„æ¡ä»¶" class="headerlink" title="5.2 æ­»é”çš„æ¡ä»¶"></a>5.2 æ­»é”çš„æ¡ä»¶</h2><ul><li>äº’æ–¥æ¡ä»¶ï¼šæŸä»½èµ„æºåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªæ‰§è¡Œæµè®¿é—®</li><li>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªæ‰§è¡Œæµå› è¯·æ±‚æŸç§èµ„æºè¿›å…¥é˜»å¡ç­‰å¾…ï¼Œè€Œä¸é‡Šæ”¾è‡ªå·±çš„èµ„æºï¼ˆå¥½æ¯”ä¸Šé¢ä»£ç ä¾‹å­ä¸­ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¸é‡Šæ”¾è‡ªå·±çš„é”ï¼Œåˆæƒ³è¦åˆ«äººçš„é”ï¼‰</li><li>ä¸å‰¥å¤ºæ¡ä»¶ï¼šä¸€ä¸ªæ‰§è¡Œæµå·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨ä¹‹å‰ä¸èƒ½è¢«å‰¥å¤ºï¼ˆéƒ¨åˆ†é”æ˜¯å…è®¸è¢«å‰¥å¤ºçš„ï¼‰</li><li>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²æ‰§è¡Œæµä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºçš„çŠ¶æ€</li></ul><p>ä¸€æŠŠé”ä¹Ÿèƒ½é€ æˆæ­»é”å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_lock(&amp;m1);</span><br><span class="line">pthread_mutex_lock(&amp;m1);</span><br><span class="line"><span class="comment">//ä¸¤æ¬¡ç”³è¯·åŒä¸€æŠŠé”</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰äººå†™å‡ºè¿™ç§bugä»£ç ï¼Œé‚£å°±ä¼šå‡ºç°ä¸€æŠŠé”æŠŠè‡ªå·±æ­»é”äº†ï¼›æ­»é”æœ¬æ¥å°±æ˜¯ä»£ç çš„bugï¼Œæ‰€ä»¥è¿™ç§ä½çº§é”™è¯¯ä¹Ÿæ˜¯æ­»é”çš„æƒ…å†µä¹‹ä¸€ğŸ˜‚</p><h2 id="5-3-é¿å…æ­»é”"><a href="#5-3-é¿å…æ­»é”" class="headerlink" title="5.3 é¿å…æ­»é”"></a>5.3 é¿å…æ­»é”</h2><p>é¿å…æ­»é”ï¼Œå…¶ä¸­æœ€ç®€å•æ˜äº†çš„åŠæ³•ï¼Œå°±æ˜¯ç ´åä¸Šé¢æåˆ°çš„æ­»é”çš„4ä¸ªæ¡ä»¶ï¼›å…¶ä¸­äº’æ–¥æ¡ä»¶æ²¡å•¥å¥½åŠæ³•ç ´åï¼ˆé™¤éä½ ä¸åŠ é”ï¼‰ï¼Œæ›´ä¸»è¦çš„æ˜¯çœ‹å¦å¤–3ä¸ªæ¡ä»¶æ˜¯å¦èƒ½ç ´åï¼</p><ul><li>ä¿æŒåŠ é”é¡ºåºä¸€è‡´ï¼šä¸è¦å‡ºç°ä¸Šé¢ä»£ç ä¸­çš„çº¿ç¨‹aå…ˆç”³è¯·é”1ï¼Œçº¿ç¨‹bå…ˆç”³è¯·é”2çš„æƒ…å†µã€‚åœ¨ä¸åŒçš„æ‰§è¡Œæµä¸­ï¼ŒæŒ‰ç›¸åŒçš„é¡ºåºç”³è¯·é”ï¼ˆæ¯”å¦‚çº¿ç¨‹aå’Œbéƒ½æ˜¯æŒ‰é”1&#x2F;2çš„é¡ºåºç”³è¯·çš„ï¼‰ä¸€å®šç¨‹åº¦ä¸Šèƒ½ç ´å<code>è¯·æ±‚ä¸ä¿æŒ</code>æ¡ä»¶</li><li>é™ä½åŠ é”çš„ç²’åº¦ï¼šé”ä¿æŠ¤çš„åŒºåŸŸå˜å°ï¼ŒåŠ é”çš„ç²’åº¦å‡å°ï¼Œèƒ½ä¸€å®šç¨‹åº¦ä¸Šé¿å…é”æœªé‡Šæ”¾</li><li>èµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼šå‡å°‘ä¸´æ—¶èµ„æºåˆ†å¼€ç»™çš„æƒ…å†µ</li><li>å…è®¸æŠ¢å ï¼šçº¿ç¨‹ä¹‹é—´ä¾é ä¼˜å…ˆçº§æŠ¢å¤ºé”ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯<strong>é”å…è®¸è¢«å‰¥å¤º</strong></li></ul><hr><h1 id="6-çº¿ç¨‹å®‰å…¨"><a href="#6-çº¿ç¨‹å®‰å…¨" class="headerlink" title="6.çº¿ç¨‹å®‰å…¨"></a>6.çº¿ç¨‹å®‰å…¨</h1><p>çº¿ç¨‹å®‰å…¨ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡ŒåŒä¸€æ®µä»£ç çš„æ—¶å€™ï¼Œ<strong>ä¸ä¼š</strong>å‡ºç°ä¸åŒçš„ç»“æœ</p><p>çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼š</p><ul><li>ä¸ä¿æŠ¤ä¸´ç•Œèµ„æº</li><li>åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­è°ƒç”¨<strong>ä¸å¯é‡å…¥</strong>å‡½æ•°ï¼ˆæ¦‚å¿µè§<a target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/128138012?spm=1001.2014.3001.5502">linuxä¿¡å·</a>éƒ¨åˆ†ï¼‰</li><li>è¿”å›æŒ‡å‘é™æ€å˜é‡çš„æŒ‡é’ˆçš„å‡½æ•°</li></ul><p>çº¿ç¨‹å®‰å…¨ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹åªæ“ä½œå±€éƒ¨å˜é‡ï¼Œæˆ–è€…åªå¯¹å…¨å±€ã€é™æ€å˜é‡åªè¯»ä¸å†™</li><li>æ¥å£å¯¹çº¿ç¨‹æ¥è¯´æ˜¯åŸå­æ“ä½œï¼ˆè¢«é”ä¿æŠ¤ï¼‰</li><li>å¤šä¸ªçº¿ç¨‹åˆ‡æ¢ä¸ä¼šä½¿å‡½æ•°æ¥å£çš„ç»“æœå‡ºç°<strong>äºŒä¹‰æ€§</strong></li><li>å¤šçº¿ç¨‹æ“ä½œä¸è°ƒç”¨ä¸å¯é‡å…¥å‡½æ•°</li></ul><p>æ³¨æ„ï¼Œç»å¤§å¤šæ•°çš„ç³»ç»Ÿè‡ªå¸¦çš„åº“ï¼ˆæ¯”å¦‚C++çš„STLåº“ï¼‰éƒ½æ˜¯<strong>ä¸å¯é‡å…¥</strong>çš„</p><p><img src="/img/loading.gif" data-lazy-src="https://img.musnow.top/i/2023/02/202212241021973.jpeg" alt="QQå›¾ç‰‡20220512164211"></p><p>ä¸å¯é‡å…¥æ˜¯å‡½æ•°çš„ä¸€ç§<strong>æ€§è´¨</strong>ï¼Œå¹¶ä¸æ˜¯å®ƒçš„ç¼ºç‚¹ï¼å¦‚æœä¸€ä¸ªåº“å‡½æ•°æ˜æ˜å‘ŠçŸ¥ä½ äº†æˆ‘æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä½ è¿˜ä¸åŠ ä¿æŠ¤çš„åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­è°ƒç”¨å®ƒï¼Œ<strong>é‚£ä¹ˆè¿™æ®µä»£ç æ˜¯æœ‰bugçš„</strong>ï¼Œå¹¶ä¸æ˜¯åº“å‡½æ•°æœ¬èº«æœ‰é—®é¢˜</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://blog.musnow.top">æ…•é›ªå¹´å</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://blog.musnow.top/posts/1309150756/">https://blog.musnow.top/posts/1309150756/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://blog.musnow.top" target="_blank">æ…•é›ªçš„å¯’èˆ</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/%E7%BA%BF%E7%A8%8B/">çº¿ç¨‹</a></div><div class="post_share"><div class="social-share" data-image="/img/bg/gm1.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://afdian.net/a/128ahri" target="_blank"><img class="post-qr-code-img" src="/img/ico/aifadian.png" alt="çˆ±å‘ç”µ"></a><div class="post-qr-code-desc">çˆ±å‘ç”µ</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/4215614474/" title="ã€å›¾åºŠã€‘åšå®¢è¡¨æƒ…åŒ…"><img class="cover" src="https://img.musnow.top/i/2023/02/202211031201961.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ã€å›¾åºŠã€‘åšå®¢è¡¨æƒ…åŒ…</div></div></a></div><div class="next-post pull-right"><a href="/posts/3856317267/" title="ã€dockerã€‘ç»¿è”naséƒ¨ç½²mysql+wikijs"><img class="cover" src="/img/bg/gm2.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">ã€dockerã€‘ç»¿è”naséƒ¨ç½²mysql+wikijs</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/2186356144/" title="ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | åŒæ­¥"><img class="cover" src="/img/bg/gm11.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-30</div><div class="title">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | åŒæ­¥</div></div></a></div><div><a href="/posts/1969264863/" title="ã€Linuxã€‘çº¿ç¨‹å®ä¾‹ | ç®€å•çº¿ç¨‹æ± "><img class="cover" src="/img/bg/gm6.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-19</div><div class="title">ã€Linuxã€‘çº¿ç¨‹å®ä¾‹ | ç®€å•çº¿ç¨‹æ± </div></div></a></div><div><a href="/posts/368672249/" title="ã€Linuxã€‘æ¥å†™ä¸€ä¸ªudpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯"><img class="cover" src="/img/bg/gm13.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-02-01</div><div class="title">ã€Linuxã€‘æ¥å†™ä¸€ä¸ªudpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/favicon.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">æ…•é›ªå¹´å</div><div class="author-info__description">çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">306</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">69</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">14</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/musnows"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:muxue@musnow.top" target="_blank" title="email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://gitee.com/musnows" target="_blank" title="Gitee"><i class="fa-sharp fa-solid fa-g"></i></a><a class="social-icon" href="https://blog.csdn.net/muxuen" target="_blank" title="CSDN"><i class="fa-brands fa-blogger-b"></i></a><a class="social-icon" href="https://musnow.top/?utm_source=blog" target="_blank" title="ä¸ªäººä¸»é¡µ"><i class="fas fa-globe-asia"></i></a><a class="social-icon" href="https://web.musnow.top/?utm_source=blog" target="_blank" title="å¯¼èˆªç«™ç‚¹"><i class="fas fa-server"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æ¬¢è¿æ¥åˆ°å¯’èˆ</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-text">1.çº¿ç¨‹çš„æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="toc-text">1.1 æ‰§è¡Œæµ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%97%B6%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="toc-text">1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%A7%81%E6%9C%89%E7%89%A9"><span class="toc-text">1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-3-%E7%BA%BF%E7%A8%8B%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-text">1.5.3 çº¿ç¨‹ç»“æ„ä½“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E7%BA%BF%E7%A8%8B%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-1-%E7%BC%BA%E7%82%B9"><span class="toc-text">1.5.1 ç¼ºç‚¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-2-%E4%BC%98%E7%82%B9"><span class="toc-text">1.5.2 ä¼˜ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-linux%E4%B8%8B%E7%BA%BF%E7%A8%8B%E5%92%8C%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-text">1.6 linuxä¸‹çº¿ç¨‹å’Œè¿›ç¨‹çš„åŒºåˆ«</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%9F%BA%E7%A1%80%E5%87%BD%E6%95%B0"><span class="toc-text">2.åŸºç¡€å‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-pthread-create"><span class="toc-text">2.1 pthread_create</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-pthread-join"><span class="toc-text">2.2 pthread_join</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E5%9F%BA%E7%A1%80%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-C-%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-text">2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E7%BA%BF%E7%A8%8B%E9%80%80%E5%87%BA"><span class="toc-text">2.3 çº¿ç¨‹é€€å‡º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-retval"><span class="toc-text">2.3.1 retval</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-pthread-exit"><span class="toc-text">2.3.2 pthread_exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-ptrhead-cancel"><span class="toc-text">2.3.3 ptrhead_cancel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%9B%E7%A8%8B%E9%80%80%E5%87%BA%E4%B8%8D%E4%BC%9A%E5%90%91%E4%B8%BB%E8%BF%9B%E7%A8%8B%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7%EF%BC%9F"><span class="toc-text">2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-5-exit"><span class="toc-text">2.3.5 exit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-pthread-detach"><span class="toc-text">2.4 pthread_detach</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-1-%E5%AE%9E%E6%93%8D"><span class="toc-text">2.4.1 å®æ“</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-2-detach%E5%90%8Ejoin"><span class="toc-text">2.4.2 detachåjoin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-3-%E7%BA%BF%E7%A8%8B%E5%88%86%E7%A6%BB%E5%90%8E%EF%BC%8C%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%85%88%E9%80%80%E5%87%BA"><span class="toc-text">2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-gettid-x2F-syscall"><span class="toc-text">2.5 gettid&#x2F;syscall</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-text">3.ç›¸å…³æ¦‚å¿µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E7%BA%BF%E7%A8%8Bid%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-text">3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-pthread%E5%BA%93"><span class="toc-text">3.2 pthreadåº“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8"><span class="toc-text">3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E7%BA%BF%E7%A8%8B%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98"><span class="toc-text">4.çº¿ç¨‹äº’æ–¥é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E4%B8%B4%E7%95%8C%E8%B5%84%E6%BA%90"><span class="toc-text">4.1 ä¸´ç•Œèµ„æº</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E5%8E%9F%E5%AD%90-x2F-%E4%BA%92%E6%96%A5%E6%80%A7"><span class="toc-text">4.2 åŸå­&#x2F;äº’æ–¥æ€§</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E7%BA%BF%E7%A8%8B%E5%8A%A0%E9%94%81"><span class="toc-text">4.3 çº¿ç¨‹åŠ é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-pthread-mutex-init"><span class="toc-text">4.3.1 pthread_mutex_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-%E5%8A%A0%E9%94%81-x2F-%E8%A7%A3%E9%94%81"><span class="toc-text">4.3.2 åŠ é”&#x2F;è§£é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-%E5%8A%A0%E9%94%81%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E7%A4%BA%E4%BE%8B-%E5%80%92%E6%B0%B4%E9%97%AE%E9%A2%98"><span class="toc-text">4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-1-%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%9C%A8%E5%B7%A5%E4%BD%9C%EF%BC%9F"><span class="toc-text">4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-2-%E5%8A%A0%E9%94%81-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-text">4.4.2 åŠ é”-é—®é¢˜è§£å†³</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E5%8A%A0%E9%94%81%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E8%A7%A3%E9%87%8A"><span class="toc-text">4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-1-%E5%8A%A0%E9%94%81%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%E4%BF%9D%E8%AF%81"><span class="toc-text">4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-2-%E6%80%BB%E7%BA%BF%E9%94%81"><span class="toc-text">4.5.2 æ€»çº¿é”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E6%AD%BB%E9%94%81"><span class="toc-text">5.æ­»é”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E6%AD%BB%E9%94%81%E6%83%85%E5%86%B5%E6%BC%94%E7%A4%BA"><span class="toc-text">5.1 æ­»é”æƒ…å†µæ¼”ç¤º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%AD%BB%E9%94%81%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="toc-text">5.2 æ­»é”çš„æ¡ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="toc-text">5.3 é¿å…æ­»é”</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="toc-text">6.çº¿ç¨‹å®‰å…¨</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/1673796161/" title="ã€Hexoã€‘ä½¿ç”¨cloudflare pagesè‡ªåŠ¨åŒ–éƒ¨ç½²hexo"><img src="https://img.musnow.top/i/2023/12/121a43bdac3a64ed8fae7f5e34054a58.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Hexoã€‘ä½¿ç”¨cloudflare pagesè‡ªåŠ¨åŒ–éƒ¨ç½²hexo"></a><div class="content"><a class="title" href="/posts/1673796161/" title="ã€Hexoã€‘ä½¿ç”¨cloudflare pagesè‡ªåŠ¨åŒ–éƒ¨ç½²hexo">ã€Hexoã€‘ä½¿ç”¨cloudflare pagesè‡ªåŠ¨åŒ–éƒ¨ç½²hexo</a><time datetime="2023-12-30T03:53:00.000Z" title="å‘è¡¨äº 2023-12-30 11:53:00">2023-12-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3865345902/" title="ã€Hexoã€‘hexo-butterflyä¸»é¢˜æ·»åŠ éä¸»ç«™æç¤º"><img src="https://img.musnow.top/i/2023/12/658eccc474ffb.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Hexoã€‘hexo-butterflyä¸»é¢˜æ·»åŠ éä¸»ç«™æç¤º"></a><div class="content"><a class="title" href="/posts/3865345902/" title="ã€Hexoã€‘hexo-butterflyä¸»é¢˜æ·»åŠ éä¸»ç«™æç¤º">ã€Hexoã€‘hexo-butterflyä¸»é¢˜æ·»åŠ éä¸»ç«™æç¤º</a><time datetime="2023-12-29T13:42:00.000Z" title="å‘è¡¨äº 2023-12-29 21:42:00">2023-12-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/725561575/" title="ã€ç½‘ç»œã€‘P2Pæ‰“æ´åŸç†"><img src="https://img.musnow.top/i/2023/12/658cde730bac4.webp" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€ç½‘ç»œã€‘P2Pæ‰“æ´åŸç†"></a><div class="content"><a class="title" href="/posts/725561575/" title="ã€ç½‘ç»œã€‘P2Pæ‰“æ´åŸç†">ã€ç½‘ç»œã€‘P2Pæ‰“æ´åŸç†</a><time datetime="2023-12-27T08:40:00.000Z" title="å‘è¡¨äº 2023-12-27 16:40:00">2023-12-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/3259961914/" title="ã€Linuxã€‘gccä¸­__builtin_expectçš„ä½œç”¨"><img src="https://img.musnow.top/i/2023/12/658ac471db47a.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ã€Linuxã€‘gccä¸­__builtin_expectçš„ä½œç”¨"></a><div class="content"><a class="title" href="/posts/3259961914/" title="ã€Linuxã€‘gccä¸­__builtin_expectçš„ä½œç”¨">ã€Linuxã€‘gccä¸­__builtin_expectçš„ä½œç”¨</a><time datetime="2023-12-26T07:36:00.000Z" title="å‘è¡¨äº 2023-12-26 15:36:00">2023-12-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url(/img/main/mothra.webp)"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By æ…•é›ªå¹´å</div><div class="footer_custom_text"><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4" height="20px"></a>&nbsp<a href="/sitemap.xml" target="_blank"><img src="https://img.shields.io/badge/-SITEMAP-00CDCD" height="20px"></a>&nbsp<a href="https://beian.miit.gov.cn/" target="_blank"><img src="https://img.shields.io/badge/%E7%B2%A4ICP%E5%A4%872023007189-red" height="20px"></a><br><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="/img/ico/wormhole_1_tp.gif" height="25px"></a>&nbsp<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="/img/ico/upyun_cdn_w.png" height="25px"></a>&nbsp<a href="https://www.travellings.cn/go.html" target="_blank"><img src="/img/ico/travelling_icon.gif" height="25px"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.19/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.3/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script src="/js/domain_check.js"></script><script id="click-heart" src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/click-heart.min.js" async mobile="false"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-butterfly/4.9.0/js/search/local-search.min.js"></script></div></div></body></html>