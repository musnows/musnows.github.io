<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…"><meta name="author" content="æ…•é›ªå¹´å"><meta name="baidu-site-verification" content="codeva-E1K9nNha9u"><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><title>ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯ | æ…•é›ªçš„å¯’èˆ</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/myPNG.jpg"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.musnow.top","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/myPNG.jpg","favicon":"/images/myPNG.jpg","avatar":"/images/myPNG.jpg","font_size":null,"font_family":null,"left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":false,"background_img":"/images/MainBG.jpg","background_post_img":"/images/mothra.png","description":"å¾å¿ƒå¦‚ä¸€ï¼Œæ…•é›ªçº·çº·","font_color":null,"hitokoto":true},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"waline","valine":{"appid":"meufCipLPHNWVE3gWEnozHzz-gzGzoHsz","appkey":"CFX9WelJjGHkaMnSunOlv3dX","server_urls":null,"placeholder":"æ¬¢è¿ç•™ä¸‹ä½ çš„å£°éŸ³ğŸ˜‹"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://waline.musnow.top/","reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":false},"img_align":"center","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/about/"><img src="/images/myPNG.jpg"> </a><a class="logo-title" href="/">æ…•é›ªçš„å¯’èˆ</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">é¦–é¡µ</a></li><li class="menu-item"><a href="/archives">å½’æ¡£</a></li><li class="menu-item"><a href="/categories">åˆ†ç±»</a></li><li class="menu-item"><a href="/tags">æ ‡ç­¾</a></li><li class="menu-item"><a href="/qa">ç•™è¨€</a></li><li class="menu-item"><a href="/links">å‹é“¾</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="/archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="/categories">åˆ†ç±»</a></li><li class="drawer-menu-item flex-center"><a href="/tags">æ ‡ç­¾</a></li><li class="drawer-menu-item flex-center"><a href="/qa">ç•™è¨€</a></li><li class="drawer-menu-item flex-center"><a href="/links">å‹é“¾</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯</span></div><div class="article-header"><div class="avatar"><img src="/images/myPNG.jpg"></div><div class="info"><div class="author"><span class="name">æ…•é›ªå¹´å</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2023-02-05 12:30:55</span> <span class="mobile">2023-02-05 12:30</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-02-08 17:09:38</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Linux/">Linux</a>&nbsp;</li><li>| <a href="/tags/%E7%BD%91%E7%BB%9C/">ç½‘ç»œ</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>4.7k å­—</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>ä»Šå¤©è®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡å™¨&#x2F;å®¢æˆ·ç«¯ä»£ç </p><span id="more"></span><blockquote><p>å®Œæ•´ä»£ç è§æˆ‘çš„gitee <a class="link" target="_blank" rel="noopener" href="https://gitee.com/musnow/raspberry-practice/tree/master/code">è¿æ¥<i class="fas fa-external-link-alt"></i></a></p><p>é˜…è¯»æœ¬æ–‡å‰ï¼Œå»ºè®®å…ˆé˜…è¯»ğŸ‘‰ <a href="https://blog.musnow.top/2023/02/01/note_linux/27udp%E4%BB%A3%E7%A0%81/">udpæœåŠ¡å™¨</a></p></blockquote><h1 id="1-åŸºæœ¬æ¡†æ¶"><a href="#1-åŸºæœ¬æ¡†æ¶" class="headerlink" title="1.åŸºæœ¬æ¡†æ¶"></a>1.åŸºæœ¬æ¡†æ¶</h1><p>tcpçš„æœåŠ¡å™¨å’ŒudpæœåŠ¡å™¨åˆå§‹åŒ–æ¥å£æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼ŒåŒºåˆ«å°±åœ¨äºè¦é€‰æ‹©<code>å­—èŠ‚æµ</code>è¿›è¡Œåˆå§‹åŒ–</p><p>ä½†æ˜¯åˆ°è¿è¡ŒçŠ¶æ€å°±ä¸åŒäº†</p><ul><li>tcpæ˜¯éœ€è¦è¿æ¥çš„</li><li>udpä¸éœ€è¦è¿æ¥</li></ul><p>æ‰€ä»¥å°±ä¼šå‡ºç°åˆ†æ­§ï¼šudpå¯ä»¥ç”¨sendtoå’Œreceveæ¥å‘é€&#x2F;æ¥æ”¶ä¿¡æ¯ï¼ŒæœåŠ¡ç«¯åªéœ€è¦ç›‘å¬ç‰¹å®šç«¯å£æ”¶åˆ°äº†ä»€ä¹ˆä¿¡æ¯ï¼›</p><p>ä½†tcpå¹¶ä¸èƒ½è¿™ä¹ˆåšï¼Œåœ¨é€šä¿¡ä¹‹å‰ï¼ŒtcpæœåŠ¡å™¨å¿…é¡»è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é“¾æ¥ã€‚</p><p>ä¸¾ä¸ªä¸æ°å½“çš„ä¾‹å­ï¼ŒudpæœåŠ¡å™¨å¥½æ¯”ä¸€ä¸ªæ°´ç›†ï¼Œç­‰å¾…æ°´çš„æ³¨å…¥ï¼›è€ŒtcpæœåŠ¡å™¨æ˜¯ä¸ªæ°´ç®¡ï¼Œå¿…é¡»è¦ä¸¤å¤´è¿é€šäº†ï¼Œæ‰èƒ½å¼€å§‹æ³¨æ°´</p><h2 id="1-1-ç±»æˆå‘˜"><a href="#1-1-ç±»æˆå‘˜" class="headerlink" title="1.1 ç±»æˆå‘˜"></a>1.1 ç±»æˆå‘˜</h2><p>ç±»çš„æˆå‘˜å˜é‡å’Œudpå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯éœ€è¦æœåŠ¡å™¨çš„ipã€ç«¯å£ã€sockfdè¿™äº›ä¿¡æ¯ã€‚ä¸ºäº†æ›´å®¹æ˜“åŒºåˆ†ï¼Œå°†tcpæœåŠ¡å™¨çš„<code>socket fd</code>æ”¹ä¸º<code>_listenSock</code>ï¼Œæ„ä¸ºç›‘å¬ç«¯å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TcpServer</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ç«¯å£å·</span></span><br><span class="line">    <span class="type">uint16_t</span> _port;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨ipåœ°å€</span></span><br><span class="line">    string _ip;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨socket fdä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> _listenSock;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1-2-å¤´æ–‡ä»¶"><a href="#1-2-å¤´æ–‡ä»¶" class="headerlink" title="1.2 å¤´æ–‡ä»¶"></a>1.2 å¤´æ–‡ä»¶</h2><p>è¿™é‡Œå¯¹å¤´æ–‡ä»¶è¿›è¡Œä¸€å®šçš„è¯´æ˜ï¼Œå› ä¸ºæœåŠ¡å™¨ä»£ç ä¸­çš„å¤´æ–‡ä»¶å®åœ¨å¤ªå¤šäº†</p><p>å½“ä½ éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ¥å£çš„æ—¶å€™ï¼Œå¯ä»¥å»é‡‡ç”¨manæ‰‹å†Œæ¥è·å–è¯¥æ¥å£çš„å¤´æ–‡ä»¶ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="comment">// å¤´æ–‡ä»¶å¤ªå¤šäº†ï¼Œæ‰€ä»¥æ–°èµ·ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span><span class="comment">//åˆ¤æ–­å­—ç¬¦ä¸²å¤§å†™å°å†™æ¥å£éœ€è¦çš„åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;strings.h&gt;</span><span class="comment">// å¿½ç•¥å¤§å°å†™æ¯”è¾ƒstrcasecmp</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>  <span class="comment">//å¾ˆå¤šliunxç³»ç»Ÿæ¥å£éƒ½éœ€è¦è¿™ä¸ª</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span> <span class="comment">// ç½‘ç»œ</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SOCKET_ERR 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BIND_ERR   2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LISTEN_ERR 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USAGE_ERR  4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONN_ERR   5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br></pre></td></tr></table></figure><h1 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2.åˆå§‹åŒ–"></a>2.åˆå§‹åŒ–</h1><p>æ¥å£çš„ä»‹ç»å°±è·Ÿéšå®ç°ä¸€æ­¥ä¸€æ­¥æ¥å§</p><h2 id="2-1-æ„é€ sock"><a href="#2-1-æ„é€ sock" class="headerlink" title="2.1 æ„é€ sock"></a>2.1 æ„é€ sock</h2><p>è¿™é‡Œå‡ºç°äº†tcpå’Œudpç¬¬ä¸€ä¸ªä¸åŒä¹‹å¤„ï¼Œtcpæ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œudpé¢å‘çš„æ˜¯æ•°æ®æŠ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">TcpServer</span>(<span class="type">uint16_t</span> port,<span class="type">const</span> string&amp; ip=<span class="string">&quot;&quot;</span>)</span><br><span class="line"> :_port(port), _ip(ip), _listenSock(<span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºsocketå¥—æ¥å­—,é‡‡ç”¨å­—èŠ‚æµï¼ˆå³tcpï¼‰</span></span><br><span class="line">    _listenSock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//æœ¬è´¨æ˜¯æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (_listenSock &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">logging</span>(FATAL, <span class="string">&quot;socket:%s:%d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;socket create success: %d&quot;</span>, _listenSock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2-åˆå§‹åŒ–sockaddr-in"><a href="#2-2-åˆå§‹åŒ–sockaddr-in" class="headerlink" title="2.2 åˆå§‹åŒ–sockaddr_in"></a>2.2 åˆå§‹åŒ–sockaddr_in</h2><p>ç»§ç»­ï¼Œåˆå§‹åŒ–sockaddr_inçš„æ“ä½œå’Œudpæ˜¯å®Œå…¨ä¸€è‡´çš„</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2. ç»‘å®šç½‘ç»œä¿¡æ¯ï¼ŒæŒ‡æ˜ip+port</span></span><br><span class="line"><span class="comment">// 2.1 å…ˆå¡«å……åŸºæœ¬ä¿¡æ¯åˆ° struct sockaddr_in</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> local;</span><br><span class="line"><span class="built_in">memset</span>(&amp;local,<span class="number">0</span>,<span class="built_in">sizeof</span>(local));<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// åè®®å®¶æ—ï¼Œè®¾ç½®ä¸ºipv4</span></span><br><span class="line">local.sin_family = AF_INET; </span><br><span class="line"><span class="comment">// ç«¯å£ï¼Œéœ€è¦è¿›è¡Œ æœ¬åœ°-&gt;ç½‘ç»œè½¬æ¢</span></span><br><span class="line">local.sin_port = <span class="built_in">htons</span>(_port);</span><br><span class="line"><span class="comment">// é…ç½®ip</span></span><br><span class="line"><span class="comment">// å¦‚æœåˆå§‹åŒ–æ—¶å€™çš„ipä¸ºç©ºï¼Œåˆ™è°ƒç”¨INADDR_ANYä»£è¡¨ä»»æ„ipã€‚å¦åˆ™å¯¹ä¼ å…¥çš„ipè¿›è¡Œè½¬æ¢åèµ‹å€¼</span></span><br><span class="line">local.sin_addr.s_addr = _ip.<span class="built_in">empty</span>() ? <span class="built_in">htonl</span>(INADDR_ANY) : <span class="built_in">inet_addr</span>(_ip.<span class="built_in">c_str</span>());</span><br></pre></td></tr></table></figure><h2 id="2-3-bind"><a href="#2-3-bind" class="headerlink" title="2.3 bind"></a>2.3 bind</h2><p>ä¹Ÿæ˜¯ä¸€æ ·ï¼Œç»‘å®šæœåŠ¡å™¨çš„ipå’Œç«¯å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.2 ç»‘å®šipç«¯å£</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">bind</span>(_listenSock,(<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)&amp;local, <span class="built_in">sizeof</span>(local)) == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">logging</span>(FATAL, <span class="string">&quot;bind: %s:%d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">logging</span>(DEBUG,<span class="string">&quot;socket bind success: %d&quot;</span>, _listenSock);</span><br></pre></td></tr></table></figure><h2 id="2-4-ç›‘å¬listen"><a href="#2-4-ç›‘å¬listen" class="headerlink" title="2.4 ç›‘å¬listen"></a>2.4 ç›‘å¬listen</h2><p>å¯¹äºtcpæœåŠ¡å™¨æ¥è¯´ï¼Œæˆå‘˜å˜é‡çš„<code>_listenSock</code>æ˜¯ç”¨æ¥ç›‘å¬çš„ï¼Œå³æ‰¾ä¸ªè€å“¥ä¸€ç›´ç›¯ç€äº‘æœåŠ¡å™¨çš„è¿™ä¸ªç«¯å£ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰éœ€è¦è¿æ¥å®ƒçš„å®¢æˆ·ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æˆ‘ä»¬çš„<code>_listenSock</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºé™åˆ¶åœ¨é˜»å¡ç­‰å¾…è¿æ¥çš„æ•°é‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The backlog argument defines the maximum length to which the queue of pending connections for sockfd may grow.   If  a connection  request arrives when the queue is full, the client may receive an error with an indication of ECONNREFUSED or, if the underlying protocol supports retransmission, the request may be ignored so that a later reattempt  at  conâ€nection succeeds.</span><br></pre></td></tr></table></figure><p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œ<code>backlog</code>å‚æ•°é™åˆ¶äº†èƒ½è¢«é˜»å¡ç­‰å¾…è¿æ¥çš„æ•°é‡ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªæ•°é‡ï¼Œåˆ™ä¼šè¿”å›ä¸€ä¸ª<code>ECONNREFUSED</code>é”™è¯¯ã€‚äº¦æˆ–è€…å¦‚æœåè®®æ”¯æŒé‡ä¼ ï¼Œå¤šä½™çš„è¯·æ±‚ä¼šè¢«å¿½ç•¥ï¼Œåç»­å¯ä»¥é‡ä¼ </p><p>manæ‰‹å†Œä¸‹é¢çš„notesè¿˜æœ‰æ›´å¤šè§£é‡Š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The behavior of the backlog argument on TCP sockets changed with Linux 2.2.  Now it specifies  the  queue  length  for completely  established  sockets waiting to be accepted, instead of the number of incomplete connection requests.  The maximum length of the queue for incomplete sockets can be set using /proc/sys/net/ipv4/tcp_max_syn_backlog.  When synâ€cookies are enabled there is no logical maximum length and this setting is ignored.  See tcp(7) for more information.</span><br><span class="line"></span><br><span class="line"> If  the  backlog  argument is greater than the value in /proc/sys/net/core/somaxconn, then it is silently truncated to that value; the default value in this file is 128.  In kernels before 2.4.25, this  limit  was  a  hard  coded  value,SOMAXCONN, with the value 128.</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>backlog</code>å‚æ•°é«˜äº<code>/proc/sys/net/core/somaxconn</code>ä¸­çš„é»˜è®¤å€¼128ï¼Œåˆ™ä¼šè¢«æˆªæ–­ä¸º128</p><hr><p>åœ¨æˆ‘ä»¬è¿™é‡Œï¼Œå°†å…¶è®¾ç½®ä¸º5å³å¯ï¼Œåæ­£ä¹Ÿæ˜¯åšæµ‹è¯•å˜›ï¼Œé—®é¢˜ä¸å¤§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.ç›‘å¬</span></span><br><span class="line"><span class="comment">// tcpæœåŠ¡å™¨æ˜¯éœ€è¦è¿æ¥çš„ï¼Œè¿æ¥ä¹‹å‰è¦å…ˆç›‘å¬æœ‰æ²¡æœ‰äººæ¥è¿</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">listen</span>(_listenSock, <span class="number">5</span>) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">logging</span>(FATAL, <span class="string">&quot;listen: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="built_in">exit</span>(LISTEN_ERR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">logging</span>(DEBUG, <span class="string">&quot;listen: %s, %d&quot;</span>, <span class="built_in">strerror</span>(errno), _listenSock);</span><br></pre></td></tr></table></figure><h1 id="3-è¿è¡Œ"><a href="#3-è¿è¡Œ" class="headerlink" title="3.è¿è¡Œ"></a>3.è¿è¡Œ</h1><p>åˆå§‹åŒ–åˆ°è¿™å°±å®Œæ¯•äº†ï¼Œä¸‹é¢å°±æ˜¯å¼€è·‘äº†</p><h2 id="3-1-accept"><a href="#3-1-accept" class="headerlink" title="3.1 accept"></a>3.1 accept</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¥å£çš„ä½œç”¨å°±ç›¸å½“äºtcpä¸­çš„<code>recevefrom</code>ï¼Œä¼ å‚æ˜¯å®Œå…¨ç›¸åŒçš„ï¼›ä¸ä¹‹ä¸åŒçš„æ˜¯ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå…¨æ–°çš„<code>sockfd</code></p><ul><li>tcpéœ€è¦å’Œå®¢æˆ·ç«¯å»ºç«‹é“¾æ¥</li><li>é“¾æ¥éœ€è¦ç”¨socket fd æ¥ç®¡ç†</li><li>æ‰€ä»¥acceptå¿…é¡»è¿”å›æ–°çš„socket fdï¼Œè®©æœåŠ¡ç«¯æœ‰åŠæ³•ç®¡ç†æ–°çš„é“¾æ¥å’Œå·²æœ‰é“¾æ¥</li><li>åŸæœ‰çš„socket fdä¸å—å½±å“</li><li>å¦‚æœæ²¡æœ‰å®¢æˆ·ç«¯æ¥è¿æ¥ï¼Œè¿›ç¨‹ä¼šåœ¨acceptå†…é˜»å¡ç­‰å¾…</li></ul><p>ä¸‹ä¸ºmanæ‰‹å†Œä¸­çš„æè¿°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The  accept()  system  call  is  used  with connection-based socket types (SOCK_STREAM, SOCK_SEQPACKET).  It extracts the first connection request on the queue of pending connections for the listening socket, sockfd, creates a new connected  socket,  and  returns  a  new  file descriptor referring to that socket.  The newly created socket is not in the listening state.  The original socket sockfd is unaffected by this call.</span><br></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼ŒtcpæœåŠ¡å™¨è‡ªèº«çš„socket fdåªä¼šç”¨æ¥ç›‘å¬ç«¯å£ä¸Šæœ‰æ²¡æœ‰æ¶ˆæ¯ï¼Œå½“ç›‘å¬åˆ°æœ‰æ¶ˆæ¯å¹¶é€šè¿‡<code>accept</code>å»ºç«‹è¿æ¥åï¼Œå°±ä¼šè®©å¦å¤–ä¸€ä½æœåŠ¡å‘˜æ¥å¯¹è¿™ä¸ªè¿æ¥æä¾›æœåŠ¡ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peer;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="built_in">sizeof</span>(peer);</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥</span></span><br><span class="line">    <span class="type">int</span> conet = <span class="built_in">accept</span>(_listenSock,(<span class="keyword">struct</span> sockaddr*)&amp;peer,&amp;len);</span><br><span class="line">    <span class="keyword">if</span>(conet&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">logging</span>(FATAL, <span class="string">&quot;accept: %s&quot;</span>, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="built_in">exit</span>(CONN_ERR);<span class="comment">//è¿æ¥é”™è¯¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ã€‚ã€‚ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è¿™é‡Œlençš„å‚æ•°æ˜¯<code>socklen_t</code>ï¼Œå…¶æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´å½¢</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">__socklen_t</span> <span class="type">socklen_t</span>;</span><br><span class="line">__STD_TYPE __U32_TYPE <span class="type">__socklen_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __U32_TYPE		unsigned int</span></span><br></pre></td></tr></table></figure><h2 id="3-2-è·å–è¿æ¥ä¿¡æ¯"><a href="#3-2-è·å–è¿æ¥ä¿¡æ¯" class="headerlink" title="3.2 è·å–è¿æ¥ä¿¡æ¯"></a>3.2 è·å–è¿æ¥ä¿¡æ¯</h2><p>è¿™éƒ¨åˆ†å’Œudpæ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œé€šè¿‡acceptè¿”å›çš„socket fdï¼Œè·å–ç”¨æˆ·çš„ipå’Œç«¯å£è€¨</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è¿æ¥ä¿¡æ¯</span></span><br><span class="line">string senderIP = <span class="built_in">inet_ntoa</span>(peer.sin_addr);<span class="comment">// æ¥æºip</span></span><br><span class="line"><span class="type">uint16_t</span> senderPort = <span class="built_in">ntohs</span>(peer.sin_port); <span class="comment">// æ¥æºç«¯å£</span></span><br><span class="line"><span class="built_in">logging</span>(DEBUG, <span class="string">&quot;accept: %s | %s[%d], socket fd: %d&quot;</span>, <span class="built_in">strerror</span>(errno), senderIP.<span class="built_in">c_str</span>(), senderPort, conet);</span><br></pre></td></tr></table></figure><p>å…¶å®åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡ŒæœåŠ¡å™¨è¿›è¡Œæµ‹è¯•äº†ã€‚å› ä¸ºtcpçš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†™å®¢æˆ·ç«¯ï¼Œç›´æ¥ç”¨æµè§ˆå™¨å°±èƒ½è¿ä¸ŠæœåŠ¡ç«¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å‚æ•°åªæœ‰ä¸¤ä¸ªï¼ˆç«¯å£/ipï¼‰æ‰€ä»¥å‚æ•°ä¸ªæ•°åº”è¯¥æ˜¯2-3</span></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span> &amp;&amp; argc!=<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Usage: &quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; port [ip]&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    string ip;</span><br><span class="line">    <span class="comment">// 3ä¸ªå‚æ•°ï¼Œæœ‰ip</span></span><br><span class="line">    <span class="keyword">if</span>(argc==<span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ip = argv[<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">TcpServer <span class="title">t</span><span class="params">(atoi(argv[<span class="number">1</span>]),ip)</span></span>;</span><br><span class="line">    t.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆç¼–è¯‘åæ‰§è¡Œä»£ç ï¼Œè®©tcpæœåŠ¡å™¨è¿è¡Œèµ·æ¥</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e198bcc215e.png" alt="image-20230207081805916"></p><p>éšååœ¨æµè§ˆå™¨çš„åœ°å€æ è¾“å…¥<code>å…¬ç½‘ip:ç«¯å£</code>ï¼ˆå…ˆè¦å¼€å¯é˜²ç«å¢™å†…çš„ç«¯å£ï¼‰</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e198b144512.png" alt="image-20230207081754768"></p><p>æ­¤æ—¶ä¼šå‘ç°ä»€ä¹ˆéƒ½åŠ è½½ä¸å‡ºæ¥ï¼Œè¿™æ˜¯å¯¹çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰å†™å‰ç«¯ï¼Œä¹Ÿæ²¡æœ‰æä¾›ä»»ä½•æœåŠ¡ã€‚ä½†æ˜¯æ¥åˆ°åå°ï¼Œå¯ä»¥çœ‹åˆ°å‡ºç°äº†ä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œå¹¶æ˜¾ç¤ºå‡ºäº†ip+ç«¯å£</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e19990d9e97.png" alt="image-20230207082138291"></p><h2 id="3-3-æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰"><a href="#3-3-æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰" class="headerlink" title="3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰"></a>3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰</h2><p>æ¥ä¸‹æ¥è¦åšçš„ï¼Œå°±æ˜¯å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡äº†ï¼Œè¿™é‡Œæˆ‘å†™çš„æ˜¯å­—ç¬¦ä¸²è½¬ASCIIç ï¼Œä¼šå°†å‘å‡ºå»çš„å­—ç¬¦ä¸²çš„asciiç åŠ åŠ èµ·æ¥åè¿”å›</p><h3 id="3-3-1-é—®é¢˜1-å¦‚ä½•é€šä¿¡"><a href="#3-3-1-é—®é¢˜1-å¦‚ä½•é€šä¿¡" class="headerlink" title="3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡"></a>3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡</h3><p>æ­¤æ—¶é—®é¢˜å°±æ¥äº†ï¼ŒtcpæœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨recevefromå’Œsendtoï¼Œé‚£ä¹ˆè·å–åˆ°socketä¹‹åè¦æ€ä¹ˆè¿›è¡Œé€šä¿¡å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ï¼š<strong>ç”¨linuxçš„æ–‡ä»¶è¯»å†™æ¥å£</strong>ï¼Œreadå’Œwriteã€‚åˆ«å¿˜äº†ï¼Œsocket fdæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªlinuxä¸‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼</p><h3 id="3-3-2-é—®é¢˜2-å¤šå®¢æˆ·ç«¯"><a href="#3-3-2-é—®é¢˜2-å¤šå®¢æˆ·ç«¯" class="headerlink" title="3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯"></a>3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯</h3><p>tcpæœåŠ¡å™¨è¦æƒ³ç»™å¤šä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œå°±å¿…é¡»é‡‡ç”¨å¤šçº¿ç¨‹&#x2F;å¤šè¿›ç¨‹çš„æ–¹å¼æ¥å®ç°æ“ä½œã€‚å¦åˆ™ä¼šå‡ºç°ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼ŒæœåŠ¡ç«¯å› ä¸ºæä¾›æœåŠ¡è€Œæ²¡æœ‰<code>accept</code>ï¼Œæ— æ³•é“¾æ¥ä¸Šä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//accept è·å–åˆ°é“¾æ¥ä¸Šçš„å®¢æˆ·ç«¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//å¦‚æœåœ¨è¿™é‡Œæä¾›æœåŠ¡ï¼Œåˆ™ä¼šå…¶ä»–è¿æ¥ä¼šåœ¨listené‡Œé¢é˜»å¡</span></span><br><span class="line">    	<span class="comment">//åªæœ‰å½“å‰æœåŠ¡ç»ˆæ­¢äº†ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„å…¶ä¸­ä¹‹ä¸€æ‰èƒ½è¿ä¸ŠæœåŠ¡å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-3-é—®é¢˜3-çº¿ç¨‹ä¼ å‚"><a href="#3-3-3-é—®é¢˜3-çº¿ç¨‹ä¼ å‚" class="headerlink" title="3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚"></a>3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚</h3><p>æ—¢ç„¶éœ€è¦é‡‡ç”¨å¤šçº¿ç¨‹æœåŠ¡ï¼Œé‚£å°±éœ€è¦è®¾å®šå¥½ç»™çº¿ç¨‹ä¼ çš„å‚æ•°ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥acceptçš„è¿”å›å€¼<code>socket fd</code>å³å¯è¿›è¡Œ<code>read/write</code></p><p>ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ‰“å°debugæ¶ˆæ¯ï¼Œè¦çŸ¥é“å½“å‰æ˜¯è°å‘ä½ å‘é€äº†è¿™æ¡æ¶ˆæ¯ï¼Œipå’Œç«¯å£æ˜¯ä»€ä¹ˆã€‚</p><p>ä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œè¿™é‡Œå°è£…ä¸€ä¸ªç»“æ„ä½“ï¼Œå°†socket fdï¼Œå®¢æˆ·ç«¯çš„ip+ç«¯å£å°è£…æˆä¸€ä¸ªå‚æ•°è¿›è¡Œä¼ å‚ï¼ˆ<strong>çº¿ç¨‹çš„å‡½æ•°åªèƒ½ä¼ å…¥ä¸€ä¸ªå‚æ•°</strong>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ClientData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> _fd;</span><br><span class="line">    <span class="type">uint16_t</span> _port;</span><br><span class="line">    <span class="built_in">string</span> _ip;</span><br><span class="line">    TcpServer* _this;</span><br><span class="line"></span><br><span class="line">    ClientData(<span class="type">int</span> fd,<span class="type">uint16_t</span> port,<span class="type">const</span> <span class="built_in">string</span>&amp; ip,TcpServer* this1)</span><br><span class="line">        :_fd(fd),_port(port), _ip(ip),_this(this1)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½ä¼šæƒ³åˆ°å¦å¤–ä¸€ä¸ªåŠæ³•ï¼Œé‚£å°±æ˜¯åœ¨tcpæœåŠ¡å™¨çš„classä¸­æ–°å¢ä¸€ä¸ªmapæˆå‘˜å˜é‡ï¼Œç”¨äºæ˜ å°„socket fdå’Œå®¢æˆ·ç«¯ä¿¡æ¯çš„é”®å€¼å¯¹ï¼Œä½†æ˜¯è¿™æ— æ³•å®ç°ã€‚</p><p>å› ä¸ºåœ¨ç±»ä¸­è®¾è®¡çš„å¤šçº¿ç¨‹å‡½æ•°ï¼Œä¸ºäº†å»æ‰é»˜è®¤ä¼ å…¥çš„<code>this</code>æŒ‡é’ˆï¼Œå¿…é¡»è¦è®¾ç½®æˆ<code>static</code>é™æ€çš„ï¼Œæ­¤æ—¶è¯¥é™æ€å‡½æ•°<strong>æ— æ³•è®¿é—®</strong>ç±»å†…æˆå‘˜ï¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å› ä¸ºéœ€è¦å–æ¶ˆthisæŒ‡é’ˆï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®æˆé™æ€çš„</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">threadRoutine</span><span class="params">(<span class="type">void</span>*args)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>()); <span class="comment">//è®¾ç½®çº¿ç¨‹åˆ†ç¦»</span></span><br><span class="line">    ClientData* data=(ClientData*)args;</span><br><span class="line">    <span class="comment">// é€šè¿‡é¢„å…ˆè®¾ç½®çš„thisæŒ‡é’ˆæ¥è®¿é—®ç±»å†…æˆå‘˜ï¼Œå¹¶è¿›è¡Œä¼ å‚</span></span><br><span class="line">    data-&gt;_this-&gt;<span class="built_in">transService</span>(data-&gt;_fd,data-&gt;_ip,data-&gt;_port);</span><br><span class="line">    <span class="keyword">delete</span> data;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3-4-æœåŠ¡ä»£ç "><a href="#3-3-4-æœåŠ¡ä»£ç " class="headerlink" title="3.3.4 æœåŠ¡ä»£ç "></a>3.3.4 æœåŠ¡ä»£ç </h3><p>è§£å†³äº†ä¸Šé¢çš„é—®é¢˜ï¼Œå°±å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹çœ‹æœåŠ¡ç«¯çš„ä»£ç äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›æœåŠ¡</span></span><br><span class="line"><span class="type">pthread_t</span> service;</span><br><span class="line"><span class="comment">// å› ä¸ºè¿™ä¸ªæˆå‘˜ä½¿ç”¨èŒƒå›´æå°ï¼Œæ‰€ä»¥é‡‡ç”¨new/deleteï¼Œé¿å…å ç”¨å¤ªå¤šç©ºé—´</span></span><br><span class="line">ClientData* data = <span class="keyword">new</span> <span class="built_in">ClientData</span>(conet,senderPort,senderIP,<span class="keyword">this</span>);</span><br><span class="line"><span class="built_in">pthread_create</span>(&amp;service,<span class="literal">nullptr</span>,threadRoutine,(<span class="type">void</span>*)data);</span><br></pre></td></tr></table></figure><p>åœ¨acceptä¹‹åï¼Œé€šè¿‡çº¿ç¨‹æ“ä½œç”¨çº¿ç¨‹æ¥æä¾›æœåŠ¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">threadRoutine</span><span class="params">(<span class="type">void</span>*args)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>()); <span class="comment">//è®¾ç½®çº¿ç¨‹åˆ†ç¦»</span></span><br><span class="line">    ClientData* data=(ClientData*)args;</span><br><span class="line">    <span class="comment">// é€šè¿‡é¢„å…ˆè®¾ç½®çš„thisæŒ‡é’ˆæ¥è®¿é—®ç±»å†…æˆå‘˜ï¼Œå¹¶è¿›è¡Œä¼ å‚</span></span><br><span class="line">    data-&gt;_this-&gt;<span class="built_in">transService</span>(data-&gt;_fd,data-&gt;_ip,data-&gt;_port);</span><br><span class="line">    <span class="keyword">delete</span> data;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>threadRoutine</code>çš„ä½œç”¨å°±æ˜¯æŠŠçº¿ç¨‹çš„å•å‚æ•°è½¬ä¸ºå¤šå‚æ•°ï¼Œä¼ ç»™çœŸæ­£ç”¨æ¥æœåŠ¡çš„å‡½æ•°ã€‚å‡½æ•°çš„æ“ä½œå¾ˆç®€å•ï¼Œå°±æ˜¯Linuxä¸‹æ–‡ä»¶æ“ä½œçš„è¯»å†™ã€‚</p><p>è¯»å†™æˆåŠŸåï¼Œå°†å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯è½¬æˆASCIIç çš„å’Œå‘å›ç»™å®¢æˆ·ç«¯</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">transService</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> std::string &amp;clientIp, <span class="type">uint16_t</span> clientPort)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(sockfd &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">assert</span>(!clientIp.<span class="built_in">empty</span>());</span><br><span class="line">    <span class="built_in">assert</span>(clientPort&gt;<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// å¼€å§‹æœåŠ¡</span></span><br><span class="line">    <span class="type">char</span> buf[BUFFER_SIZE];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è¯»å–å®¢æˆ·ç«¯å‘æ¥çš„ä¿¡æ¯,sæ˜¯è¯»å–åˆ°çš„å­—èŠ‚æ•°</span></span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">read</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf)<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span>(s&gt;<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            buf[s]=<span class="string">&#x27;\0&#x27;</span>;<span class="comment">//æ‰‹åŠ¨æ·»åŠ å­—ç¬¦ä¸²ç»ˆæ­¢ç¬¦</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(buf,<span class="string">&quot;quit&quot;</span>)==<span class="number">0</span>)</span><br><span class="line">            &#123;<span class="comment">//å®¢æˆ·ç«¯ä¸»åŠ¨é€€å‡º</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æœåŠ¡</span></span><br><span class="line">            string tmp = buf;</span><br><span class="line">            <span class="type">int</span> ret = <span class="built_in">str2ascii</span>(tmp);<span class="comment">//è·å–å­—ç¬¦ä¸²çš„asciiæ€»å’Œ</span></span><br><span class="line">            cout &lt;&lt; ret &lt;&lt; endl;</span><br><span class="line">            string retS =  <span class="built_in">to_string</span>(ret);<span class="comment">//è½¬å­—ç¬¦ä¸²</span></span><br><span class="line">            cout &lt;&lt; retS &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">write</span>(sockfd,retS.<span class="built_in">c_str</span>(),retS.<span class="built_in">size</span>());<span class="comment">//å†™å…¥</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == <span class="number">0</span>)</span><br><span class="line">        &#123;<span class="comment">//s == 0ä»£è¡¨å¯¹æ–¹å…³é—­,å®¢æˆ·ç«¯é€€å‡º</span></span><br><span class="line">            <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;client quit: %s[%d]&quot;</span>, clientIp.<span class="built_in">c_str</span>(), clientPort);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">logging</span>(DEBUG, <span class="string">&quot;read err: %s[%d] -  %s&quot;</span>, clientIp.<span class="built_in">c_str</span>(), clientPort, <span class="built_in">strerror</span>(errno));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(sockfd);</span><br><span class="line">    <span class="built_in">logging</span>(DEBUG,<span class="string">&quot;server quit %d&quot;</span>,sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// æœåŠ¡å‡½æ•°å¯ä»¥ä¸æš´éœ²</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">str2ascii</span><span class="params">(<span class="type">const</span> string&amp; str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> e:str)</span><br><span class="line">        &#123;</span><br><span class="line">            ret += e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="3-4-æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰"><a href="#3-4-æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰" class="headerlink" title="3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰"></a>3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰</h2><p>ä¸Šé¢çš„ä»£ç é‡‡ç”¨çš„æ˜¯çº¿ç¨‹æ¥æä¾›æœåŠ¡ï¼Œé™¤äº†çº¿ç¨‹ï¼Œæˆ‘ä»¬è¿˜æœ‰çˆ¶å­è¿›ç¨‹çš„æ–¹å¼ï¼Œä¹Ÿèƒ½é¿å…é˜»å¡</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œçˆ¶å­è¿›ç¨‹éƒ½éœ€è¦å…³é—­æ‰å¯¹æ–¹ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé¿å…å‡ºç°æ–‡ä»¶æè¿°ç¬¦åœ¨æœåŠ¡ç»“æŸåè¿˜æ²¡æœ‰å…³é—­çš„æƒ…å†µ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pid_t</span> id = fork();</span><br><span class="line"><span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>(_listenSock);<span class="comment">//å› ä¸ºå­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬ï¼Œæ‰€ä»¥å…³é—­æ‰ç›‘å¬socket</span></span><br><span class="line">    <span class="comment">//å­è¿›ç¨‹</span></span><br><span class="line">    <span class="built_in">transService</span>(conet, senderIP, senderPort);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);<span class="comment">// æœåŠ¡ç»“æŸåï¼Œé€€å‡ºï¼Œå­è¿›ç¨‹ä¼šè¿›å…¥åƒµå°¸çŠ¶æ€ç­‰å¾…çˆ¶è¿›ç¨‹å›æ”¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">close</span>(conet); <span class="comment">// å› ä¸ºæ­¤æ—¶æ˜¯å­è¿›ç¨‹æä¾›æœåŠ¡ï¼Œconetä¼šæœ‰æ‹·è´ï¼Œç›¸å½“äºæœ‰ä¸¤ä¸ªè¿›ç¨‹æ‰“å¼€äº†è¯¥æ–‡ä»¶</span></span><br><span class="line"><span class="comment">// å¦‚æœçˆ¶è¿›ç¨‹ä¸å…³é—­ï¼Œå³ä¾¿å­è¿›ç¨‹ç»“æŸæœåŠ¡äº†ï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦ä¹Ÿä¼šä¿æŒå¼€å¯</span></span><br><span class="line"><span class="type">pid_t</span> ret = <span class="built_in">waitpid</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿™æ ·å†™æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯çˆ¶è¿›ç¨‹æ²¡æœ‰åŠæ³•æ­£å¸¸é‡Šæ”¾å­è¿›ç¨‹çš„èµ„æº</p><ul><li>å¦‚æœè¿›è¡Œé˜»å¡ç­‰å¾…ï¼Œé‚£å°±è¿èƒŒäº†åˆè¡·ï¼Œå®Œå…¨æ²¡æœ‰æ„ä¹‰</li><li>å¦‚æœè¿›è¡Œéé˜»å¡ç­‰å¾…ï¼Œåœ¨<code>waitpid</code>ç»“æŸä¹‹åï¼Œçˆ¶è¿›ç¨‹ç›´æ¥å»å¹²å…¶ä»–äº‹äº†ï¼Œå®Œå…¨å¿˜è®°äº†è¿™é‡Œçš„è¿™ä¸ªå­è¿›ç¨‹</li></ul><p>æ‰€ä»¥æˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯åœ¨å­è¿›ç¨‹é€€å‡ºï¼Œå‘<strong>çˆ¶è¿›ç¨‹å‘é€ä¿¡å·</strong>çš„æ—¶å€™å›æ”¶å­è¿›ç¨‹</p><h3 id="3-4-1-ä¿¡å·å›æ”¶"><a href="#3-4-1-ä¿¡å·å›æ”¶" class="headerlink" title="3.4.1 ä¿¡å·å›æ”¶"></a>3.4.1 ä¿¡å·å›æ”¶</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGCHLD, FreeChild);<span class="comment">//è‡ªå®šä¹‰æ•æ‰</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›æ”¶å­è¿›ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FreeChild</span><span class="params">(<span class="type">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(signo == SIGCHLD);</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰å­è¿›ç¨‹äº†ï¼Œwaitpidå°±ä¼šè°ƒç”¨å¤±è´¥</span></span><br><span class="line">        <span class="type">pid_t</span> id = <span class="built_in">waitpid</span>(<span class="number">-1</span>, <span class="literal">nullptr</span>, WNOHANG); <span class="comment">// éé˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹ç­‰å¾…æˆåŠŸ, child pid: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//è¿˜æœ‰å­è¿›ç¨‹æ²¡æœ‰é€€å‡º</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;å°šæœ‰æœªé€€å‡ºçš„å­è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹ç»§ç»­è¿è¡Œ&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">//é€€å‡ºç­‰å¾…å­è¿›ç¨‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;çˆ¶è¿›ç¨‹ç­‰å¾…æ‰€æœ‰å­è¿›ç¨‹ç»“æŸ&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†è‡ªå®šä¹‰æ•æ‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾ç½®æˆignoreä¸æ­ç†å­è¿›ç¨‹ï¼Œè¿™æ ·å­è¿›ç¨‹é€€å‡ºçš„æ—¶å€™å°±ä¼šè¢«ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">signal(SIGCHLD, SIG_IGN);</span><br></pre></td></tr></table></figure><h3 id="3-4-2-çˆ·çˆ·è¿›ç¨‹"><a href="#3-4-2-çˆ·çˆ·è¿›ç¨‹" class="headerlink" title="3.4.2 çˆ·çˆ·è¿›ç¨‹"></a>3.4.2 çˆ·çˆ·è¿›ç¨‹</h3><p>è¿™é‡Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªéªšæ“ä½œï¼Œé‚£å°±æ˜¯åœ¨åˆ›å»ºå­è¿›ç¨‹ä¹‹åï¼Œå†åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›æœåŠ¡ï¼ˆå­™å­è¿›ç¨‹ï¼‰-2</span></span><br><span class="line"><span class="type">pid_t</span> id = fork();</span><br><span class="line"><span class="keyword">if</span>(id == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">close</span>(_listenSock);<span class="comment">//å› ä¸ºå­è¿›ç¨‹ä¸éœ€è¦ç›‘å¬ï¼Œæ‰€ä»¥å…³é—­æ‰ç›‘å¬socket</span></span><br><span class="line">    <span class="comment">//åˆåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¤§äº0ä»£è¡¨æ˜¯çˆ¶è¿›ç¨‹ï¼Œå³åˆ›å»ºå®Œå­è¿›ç¨‹åçˆ¶è¿›ç¨‹ç›´æ¥é€€å‡º</span></span><br><span class="line">    <span class="keyword">if</span>(fork()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­™å­è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    <span class="built_in">transService</span>(conet, senderIP, senderPort);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);<span class="comment">// æœåŠ¡ç»“æŸåï¼Œé€€å‡ºï¼Œå­è¿›ç¨‹ä¼šè¿›å…¥åƒµå°¸çŠ¶æ€ç­‰å¾…çˆ¶è¿›ç¨‹å›æ”¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ·çˆ·è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">close</span>(conet); </span><br><span class="line"><span class="type">pid_t</span> ret = <span class="built_in">waitpid</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>); <span class="comment">//æ­¤æ—¶å°±å¯ä»¥ç›´æ¥ç”¨é˜»å¡å¼ç­‰å¾…äº†</span></span><br><span class="line"><span class="built_in">assert</span>(ret &gt; <span class="number">0</span>);<span class="comment">//retå¦‚æœä¸å¤§äº0ï¼Œåˆ™ä»£è¡¨ç­‰å¾…å‘ç”Ÿäº†é”™è¯¯</span></span><br></pre></td></tr></table></figure><p>é‡‡ç”¨è¿™ç§åŠæ³•ä»¥åï¼Œç”±äºçˆ¶è¿›ç¨‹é€€å‡ºäº†ï¼Œ<strong>å­™å­è¿›ç¨‹ä¼šç›´æ¥è¢«æ“ä½œç³»ç»Ÿæ¥ç®¡</strong>ã€‚ä¸‹å›¾ä¸­èƒ½çœ‹åˆ°è¿™äº›è¿›ç¨‹çš„çˆ¶è¿›ç¨‹éƒ½æ˜¯<strong>1</strong>ï¼Œå³æ“ä½œç³»ç»Ÿã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æ‹…å¿ƒå­è¿›ç¨‹çš„é‡Šæ”¾é—®é¢˜äº†</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e1c184403cd.png" alt="image-20230207111205871"></p><h1 id="4-å®¢æˆ·ç«¯"><a href="#4-å®¢æˆ·ç«¯" class="headerlink" title="4.å®¢æˆ·ç«¯"></a>4.å®¢æˆ·ç«¯</h1><p>å®¢æˆ·ç«¯éƒ¨åˆ†çš„ä»£ç å’Œudpä¹Ÿå¾ˆç›¸ä¼¼ï¼Œåªä¸è¿‡å°†sendtoæ”¹æˆäº†write</p><p>ä¸‹æ–¹æä¾›äº†å®¢æˆ·ç«¯çš„ä»£ç ï¼Œéƒ½å†™äº†æ³¨é‡ŠğŸ˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;utils.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ./clientTcp serverIp serverPort</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>)<span class="comment">//å®¢æˆ·ç«¯å¿…é¡»è¦æœ‰3ä¸ªå‚æ•°</span></span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Usage:\n\t&quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; serverIp serverPort&quot;</span> &lt;&lt; endl;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;Example:\n\t&quot;</span> &lt;&lt; argv[<span class="number">0</span>] &lt;&lt; <span class="string">&quot; 127.0.0.1 8080\n&quot;</span></span><br><span class="line">                &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(USAGE_ERR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è§£ææœåŠ¡ç«¯çš„ipå’Œç«¯å£</span></span><br><span class="line">    string serverIp = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">uint16_t</span> serverPort = <span class="built_in">atoi</span>(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. åˆ›å»ºtcpçš„socket SOCK_STREAM</span></span><br><span class="line">    <span class="type">int</span> sock = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;socket: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(SOCKET_ERR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. connectï¼Œå‘èµ·é“¾æ¥è¯·æ±‚ï¼Œä½ æƒ³è°å‘èµ·è¯·æ±‚å‘¢ï¼Ÿï¼Ÿå½“ç„¶æ˜¯å‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚å–½</span></span><br><span class="line">    <span class="comment">// 2.1 å…ˆå¡«å……éœ€è¦è¿æ¥çš„è¿œç«¯ä¸»æœºçš„åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> server;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;server, <span class="number">0</span>, <span class="built_in">sizeof</span>(server));</span><br><span class="line">    server.sin_family = AF_INET;</span><br><span class="line">    server.sin_port = <span class="built_in">htons</span>(serverPort);</span><br><span class="line">    <span class="built_in">inet_aton</span>(serverIp.<span class="built_in">c_str</span>(), &amp;server.sin_addr);</span><br><span class="line">    <span class="comment">// 2.2 å‘èµ·è¯·æ±‚ï¼Œconnect ä¼šè‡ªåŠ¨bind</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connect</span>(sock, (<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)&amp;server, <span class="built_in">sizeof</span>(server)) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(CONN_ERR);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;connect success: &quot;</span> &lt;&lt; sock &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®¢æˆ·ç«¯å‘ç°çš„æ¶ˆæ¯</span></span><br><span class="line">    string message;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        message.<span class="built_in">clear</span>();<span class="comment">//æ¯æ¬¡å¾ªç¯å¼€å§‹ï¼Œéƒ½æ¸…ç©ºä¸€ä¸‹msg</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;è¯·è¾“å…¥ä½ çš„æ¶ˆæ¯# &quot;</span>;</span><br><span class="line">        <span class="built_in">getline</span>(cin, message);<span class="comment">//è·å–è¾“å…¥</span></span><br><span class="line">        <span class="comment">// å¦‚æœå®¢æˆ·ç«¯è¾“å…¥äº†quitï¼Œåˆ™é€€å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(message.<span class="built_in">c_str</span>(), <span class="string">&quot;quit&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯</span></span><br><span class="line">        <span class="type">ssize_t</span> s = <span class="built_in">write</span>(sock, message.<span class="built_in">c_str</span>(), message.<span class="built_in">size</span>());</span><br><span class="line">        <span class="keyword">if</span> (s &gt; <span class="number">0</span>) <span class="comment">// å†™å…¥æˆåŠŸ</span></span><br><span class="line">        &#123;</span><br><span class="line">            message.<span class="built_in">clear</span>();<span class="comment">//æ¸…ç©ºè¾“å…¥çš„æ¶ˆæ¯</span></span><br><span class="line">            message.<span class="built_in">resize</span>(BUFFER_SIZE);</span><br><span class="line">            <span class="comment">// å› ä¸ºstringçš„c_stræœ¬è´¨ä¸Šæ˜¯è¿”å›åœ°å€ï¼Œæ‰€ä»¥å¼ºè½¬åæ˜¯å¯ä»¥å¾€é‡Œé¢å†™å…¥çš„</span></span><br><span class="line">            s = <span class="built_in">read</span>(sock, (<span class="type">char</span> *)(message.<span class="built_in">c_str</span>()), BUFFER_SIZE);<span class="comment">// è·å–æœåŠ¡ç«¯çš„ç»“æœ</span></span><br><span class="line">            <span class="keyword">if</span> (s &gt; <span class="number">0</span>)<span class="comment">// è¯»å–æˆåŠŸ</span></span><br><span class="line">            &#123;</span><br><span class="line">                message[s] = <span class="string">&#x27;\0&#x27;</span>;<span class="comment">//è¿½åŠ \0</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ‰“å°è¿”å›å€¼</span></span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;Server Echo# &quot;</span> &lt;&lt; message &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s &lt;= <span class="number">0</span>) <span class="comment">// å†™å…¥å¤±è´¥</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…³é—­æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="built_in">close</span>(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-1-è¿è¡Œæµ‹è¯•"><a href="#4-1-è¿è¡Œæµ‹è¯•" class="headerlink" title="4.1 è¿è¡Œæµ‹è¯•"></a>4.1 è¿è¡Œæµ‹è¯•</h2><p>å…ˆè¿è¡ŒæœåŠ¡ç«¯ï¼Œå†è¿è¡Œå®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¾“å…¥åï¼ŒæœåŠ¡çŸ­ä¼šè¿”å›å­—ç¬¦ä¸²çš„asciiç æ€»å’Œ</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e1aff8cb944.png" alt="image-20230207095713615"></p><p>è€Œå®¢æˆ·ç«¯è¾“å…¥quitåï¼Œåœ¨æœåŠ¡ç«¯å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯é€€å‡ºï¼Œä½†æœåŠ¡ç«¯å¹¶æ²¡æœ‰æ¨å‡ºï¼Œæ­£åœ¨ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/23/02/63e1b0576b69f.png" alt="image-20230207095848863"></p><h1 id="5-å®ˆæŠ¤è¿›ç¨‹"><a href="#5-å®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="5.å®ˆæŠ¤è¿›ç¨‹"></a>5.å®ˆæŠ¤è¿›ç¨‹</h1><p>å®ˆæŠ¤è¿›ç¨‹å§é»˜è®¤çš„0.1.2éƒ½é‡å®šå‘åˆ°<code>dev/null</code>ï¼Œæ˜¯å› ä¸ºè®¾ç½®æˆç‹¬ç«‹çš„è¿›ç¨‹ç»„å’Œè¿›ç¨‹ä¼šè¯äº†ä¹‹åï¼Œå½“å‰è¿›ç¨‹æ˜¯æ²¡æœ‰å’Œbashå…³è”çš„ï¼Œé»˜è®¤è¿™ä¸ª0ï¼Œ1ï¼Œ2æ‰€æŒ‡å‘çš„bashæ˜¯æ— æ•ˆçš„ï¼Œæ­¤æ—¶å¦‚æœä¸é‡å®šå‘ï¼Œä½¿ç”¨coutæ‰“å°çš„æ—¶å€™ï¼Œå°±ä¼šå¼•å‘å¼‚å¸¸ï¼ˆå¯ä»¥ç†è§£ä¸ºå¾€ä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶ä¸­å†™å†…å®¹ï¼‰æ— æ³•å®ç°å®ˆæŠ¤è¿›ç¨‹</p><p>é‡å®šå‘äº†ä¹‹åï¼Œæ‰€æœ‰çš„æ‰“å°è¾“å‡ºéƒ½ä¼šè¢«ä¸¢åˆ°<code>/dev/null</code>è¿™ä¸ªæ–‡ä»¶åƒåœ¾æ¡¶ä¸­ï¼Œä¹Ÿå°±ä¸éœ€è¦æ‹…å¿ƒä¸Šè¿°çš„é—®é¢˜</p><p>linuxç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªæ¥å£<code>daemon</code>ï¼Œå¯ä»¥å¸®æˆ‘ä»¬å®ç°å®ˆæŠ¤è¿›ç¨‹ã€‚</p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">æœ¬æ–‡æ ‡é¢˜</span>ï¼š<span class="content">ã€Linuxã€‘æ¥å†™ä¸€ä¸ªtcpçš„æœåŠ¡ç«¯+å®¢æˆ·ç«¯</span></li><li class="post-author"><span class="type">æœ¬æ–‡ä½œè€…</span>ï¼š<span class="content">æ…•é›ªå¹´å</span></li><li class="post-time"><span class="type">åˆ›å»ºæ—¶é—´</span>ï¼š<span class="content">2023-02-05 12:30:55</span></li><li class="post-link"><span class="type">æœ¬æ–‡é“¾æ¥</span>ï¼š<span class="content">2023/02/05/note_Linux/29tcpä»£ç /</span></li><li class="post-license"><span class="type">ç‰ˆæƒå£°æ˜</span>ï¼š<span class="content">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="å¤åˆ¶ç‰ˆæƒä¿¡æ¯" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E7%BD%91%E7%BB%9C/">#ç½‘ç»œ</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/02/08/note_cpp/27using%E7%9A%84%E4%B8%89%E7%A7%8D%E7%94%A8%E6%B3%95/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">ã€C++ã€‘usingçš„ä¸‰ç§ç”¨æ³•</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2023/02/04/note_Python/8python%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%8B%E8%BD%BDmd%E6%96%87%E4%BB%B6%E4%B8%AD%E5%9B%BE%E7%89%87/"><span class="title flex-center"><span class="post-nav-title-item">ã€Pythonã€‘è‡ªåŠ¨è§£æmarkdownä¸­çš„å›¾ç‰‡å¹¶ä¿å­˜</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;è¯„è®º</div><div class="waline-comment-container"><link rel="stylesheet" href="/css/my/waline.css"><link rel="stylesheet" href="/css/my/waline-meta.css"><script data-pjax src="/css/my/waline.js"></script><div id="waline-comment"></div><script data-pjax>function loadWaline() {
            Waline.init({
              el: '#waline-comment',
              serverURL: 'https://waline.musnow.top/',
              lang: 'zh-CN' || 'zh-CN',
              comment: '.post-comments-count',
              reaction: 'false' === 'true'
            })
          }

          if ('true' === 'true') {
            setTimeout(() => {
              loadWaline()
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadWaline)
          }</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-text">1.åŸºæœ¬æ¡†æ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E7%B1%BB%E6%88%90%E5%91%98"><span class="nav-text">1.1 ç±»æˆå‘˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="nav-text">1.2 å¤´æ–‡ä»¶</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">2.åˆå§‹åŒ–</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%9E%84%E9%80%A0sock"><span class="nav-text">2.1 æ„é€ sock</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%88%9D%E5%A7%8B%E5%8C%96sockaddr-in"><span class="nav-text">2.2 åˆå§‹åŒ–sockaddr_in</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-bind"><span class="nav-text">2.3 bind</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E7%9B%91%E5%90%AClisten"><span class="nav-text">2.4 ç›‘å¬listen</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E8%BF%90%E8%A1%8C"><span class="nav-text">3.è¿è¡Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-accept"><span class="nav-text">3.1 accept</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="nav-text">3.2 è·å–è¿æ¥ä¿¡æ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%BA%BF%E7%A8%8B%EF%BC%89"><span class="nav-text">3.3 æä¾›æœåŠ¡ï¼ˆçº¿ç¨‹ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-%E9%97%AE%E9%A2%981-%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1"><span class="nav-text">3.3.1 é—®é¢˜1 å¦‚ä½•é€šä¿¡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-%E9%97%AE%E9%A2%982-%E5%A4%9A%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">3.3.2 é—®é¢˜2 å¤šå®¢æˆ·ç«¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-3-%E9%97%AE%E9%A2%983-%E7%BA%BF%E7%A8%8B%E4%BC%A0%E5%8F%82"><span class="nav-text">3.3.3 é—®é¢˜3 çº¿ç¨‹ä¼ å‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-4-%E6%9C%8D%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="nav-text">3.3.4 æœåŠ¡ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E6%8F%90%E4%BE%9B%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%AD%90%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="nav-text">3.4 æä¾›æœåŠ¡ï¼ˆå­è¿›ç¨‹ï¼‰</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E4%BF%A1%E5%8F%B7%E5%9B%9E%E6%94%B6"><span class="nav-text">3.4.1 ä¿¡å·å›æ”¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-%E7%88%B7%E7%88%B7%E8%BF%9B%E7%A8%8B"><span class="nav-text">3.4.2 çˆ·çˆ·è¿›ç¨‹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">4.å®¢æˆ·ç«¯</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-text">4.1 è¿è¡Œæµ‹è¯•</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="nav-text">5.å®ˆæŠ¤è¿›ç¨‹</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">æ…•é›ªå¹´å</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="timerun-info info-item"><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/16/2022 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="å·²å‹‰å¼ºè¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" æ—¶ "+mnum+" åˆ† "+snum+" ç§’"}setInterval("createtime()",250)</script></div><div class="shields-info info-item"><a href="https://github.com/XPoet/hexo-theme-keep" target="_blank"><img src="https://img.shields.io/badge/hexo-keep-blue" height="20px"> </a><a href="https://musnow.top" target="_blank"><img src="https://img.shields.io/badge/%E4%B8%BB%E7%AB%99-%E7%82%B9%E6%88%91-blueviolet" height="20px"> </a><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4" height="20px"> </a><a href="https://beian.miit.gov.cn/" target="_blank"><img src="https://img.shields.io/badge/%E7%B2%A4ICP%E5%A4%87-2023007189%E5%8F%B7-red" height="20px"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank"><img src="/images/UPYUN-CDN.png" height="20px"></a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });</script><script type="text/javascript" src="/js/snow.js"></script></body></html>