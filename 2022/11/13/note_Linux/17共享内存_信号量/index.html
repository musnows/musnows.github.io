<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="æ…•é›ªå¹´å"><meta name="baidu-site-verification" content="codeva-E1K9nNha9u"><script async defer data-website-id="f999c61c-4313-4008-b56e-7b3181301711" src="https://umi.outpost54.top/umami.js"></script><title>ã€Linuxã€‘è¿›ç¨‹é€šä¿¡ | å…±äº«å†…å­˜ | ä¿¡å·é‡ | æ…•é›ªçš„å¯’èˆ</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/myPNG.jpg"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.outpost54.top","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/myPNG.jpg","favicon":"/images/myPNG.jpg","avatar":"/images/myPNG.jpg","font_size":null,"font_family":null,"left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":false,"background_img":"/images/MainBG.jpg","background_post_img":"/images/mothra.png","description":"å¾å¿ƒå¦‚ä¸€ï¼Œæ…•é›ªçº·çº·","font_color":null,"hitokoto":true},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"waline","valine":{"appid":"meufCipLPHNWVE3gWEnozHzz-gzGzoHsz","appkey":"CFX9WelJjGHkaMnSunOlv3dX","server_urls":null,"placeholder":"æ¬¢è¿ç•™ä¸‹ä½ çš„å£°éŸ³ğŸ˜‹"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://vrcl.outpost54.top/","reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":false},"img_align":"center","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/myPNG.jpg"> </a><a class="logo-title" href="/">æ…•é›ªçš„å¯’èˆ</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">é¦–é¡µ</a></li><li class="menu-item"><a href="/archives">å½’æ¡£</a></li><li class="menu-item"><a href="/categories">åˆ†ç±»</a></li><li class="menu-item"><a href="/tags">æ ‡ç­¾</a></li><li class="menu-item"><a href="/QA">ç•™è¨€æ¿</a></li><li class="menu-item"><a href="/links">å‹é“¾</a></li><li class="menu-item"><a href="/about">å…³äº</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="/archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="/categories">åˆ†ç±»</a></li><li class="drawer-menu-item flex-center"><a href="/tags">æ ‡ç­¾</a></li><li class="drawer-menu-item flex-center"><a href="/QA">ç•™è¨€æ¿</a></li><li class="drawer-menu-item flex-center"><a href="/links">å‹é“¾</a></li><li class="drawer-menu-item flex-center"><a href="/about">å…³äº</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ã€Linuxã€‘è¿›ç¨‹é€šä¿¡ | å…±äº«å†…å­˜ | ä¿¡å·é‡</span></div><div class="article-header"><div class="avatar"><img src="/images/myPNG.jpg"></div><div class="info"><div class="author"><span class="name">æ…•é›ªå¹´å</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-11-13 10:40:16</span> <span class="mobile">2022-11-13 10:40</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-01-15 16:12:54</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Linux/">Linux</a>&nbsp;</li><li>| <a href="/tags/%E8%BF%9B%E7%A8%8B/">è¿›ç¨‹</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>6.5k å­—</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>ä¸Šç¯‡Linuxçš„åšå®¢æ˜¯æœ‰å…³ç®¡é“çš„ï¼Œä»Šæ—¥å°±è®©æˆ‘ä»¬ç»§ç»­åº·åº·è¿›ç¨‹é—´é€šä¿¡çš„å¦å¤–ä¸€ç§æ–¹æ³•ï¼š<code>å…±äº«å†…å­˜</code></p><span id="more"></span><p>å®Œæ•´ä»£ç è¯¦è§æˆ‘çš„giteeä»“åº“ ğŸ‘‡</p><blockquote><p><a class="link" target="_blank" rel="noopener" href="https://gitee.com/ewait/raspberry-practice/tree/master/code/22-11-12_systemV">https://gitee.com/ewait/raspberry-practice/tree/master/code/22-11-12_systemV<i class="fas fa-external-link-alt"></i></a></p></blockquote><p>[TOC]</p><h1 id="1-å•¥æ˜¯å…±äº«å†…å­˜ï¼Ÿ"><a href="#1-å•¥æ˜¯å…±äº«å†…å­˜ï¼Ÿ" class="headerlink" title="1.å•¥æ˜¯å…±äº«å†…å­˜ï¼Ÿ"></a>1.å•¥æ˜¯å…±äº«å†…å­˜ï¼Ÿ</h1><p>è¿›ç¨‹é—´é€šä¿¡çš„åŸºæœ¬æ–¹å¼ï¼Œå°±æ˜¯è®©ä¸¤ä¸ªè¿›ç¨‹çœ‹åˆ°åŒä¸€ä»½èµ„æºã€‚</p><p>å…±äº«å†…å­˜çš„æ–¹å¼ï¼Œé€šè¿‡ç³»ç»Ÿæ¥å£å¼€è¾Ÿä¸€æ®µå†…å­˜ï¼Œå†è®©å¤šä¸ªè¿›ç¨‹å»è®¿é—®è¿™å—å†…å­˜ï¼Œå°±èƒ½åŒæ—¶çœ‹åˆ°ä¸€ä»½èµ„æºã€‚</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211120900047.png" alt="image-20221112090042941"></p><p>è¿™é‡Œè´´å‡ºä¹‹å‰åŠ¨æ€åº“åšå®¢ä¸­çš„å›¾ï¼Œå…±äº«å†…å­˜çš„æ–¹å¼å’Œè¯¥å›¾å±•ç¤ºçš„æ–¹å¼ç±»ä¼¼ã€‚è¿›ç¨‹éœ€è¦è°ƒç”¨ç³»ç»Ÿæ¥å£ï¼Œå°†å·²ç»å¼€è¾Ÿå¥½çš„å…±äº«å†…å­˜æ˜ å°„åˆ°è‡ªå·±çš„é¡µè¡¨ä¸­ï¼Œä»¥å®ç°è®¿é—®ã€‚</p><p>è¿™é‡Œå°±å‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼š</p><ul><li>æ“ä½œç³»ç»Ÿçš„æ¥å£æ€ä¹ˆçŸ¥é“è¿›ç¨‹è¦çš„æ˜¯é‚£ä¸€å—å…±äº«å†…å­˜ï¼Ÿå³å…±äº«å†…å­˜æ˜¯æ€ä¹ˆæ ‡è¯†çš„ï¼Ÿ</li></ul><p>è¦çŸ¥é“ï¼Œä¹‹å‰æˆ‘ä»¬æ‰“å¼€æ–‡ä»¶ã€å¼€è¾Ÿç®¡é“ç­‰ç­‰ï¼Œéƒ½æ˜¯å…·æœ‰å”¯ä¸€çš„æ–‡ä»¶è·¯å¾„æ¥æ ‡è¯†æ–‡ä»¶çš„ã€‚å¦‚æœæŒ‰ä»¥å‰çš„æƒ³æ³•ï¼š<code>æ‰“å¼€æ–‡ä»¶-&gt;ç³»ç»Ÿè¿”å›æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦</code>ï¼Œå…±äº«å†…å­˜åˆ™åº”è¯¥æ˜¯<code>å¼€è¾Ÿå…±äº«å†…å­˜-&gt;ç³»ç»Ÿè¿”å›å…±äº«å†…å­˜çš„ç¼–å·</code></p><ul><li>è¿™å°±å‡ºç°äº†é—®é¢˜ï¼</li></ul><p>å‡è®¾è¿›ç¨‹Aå¼€è¾Ÿäº†ä¸€æ®µå…±äº«å†…å­˜ï¼Œç³»ç»Ÿè¿”å›äº†ç¼–å·123ï¼Œé‚£ä¹ˆè¿›ç¨‹Aè¦æ€ä¹ˆè®©å…¶ä»–æƒ³ä½¿ç”¨è¿™å—å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡çš„è¿›ç¨‹ï¼Œ<span id="jump">çŸ¥é“å®ƒå¼€è¾Ÿçš„å…±äº«å†…å­˜ç¼–å·</span>æ˜¯123å‘¢ï¼Ÿæ€»ä¸èƒ½å¼€ä¸ªç®¡é“å‘Šè¯‰å®ƒå§ï¼Ÿé‚£å²‚ä¸æ˜¯å¤šæ­¤ä¸€ä¸¾ğŸ˜‚</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211031201142.gif" alt="QQå›¾ç‰‡20220502222002"></p><p>æ‰€ä»¥ï¼Œå…±äº«å†…å­˜çš„ç¼–å·å…¶å®å’Œå‘½åç®¡é“ä¸€æ ·ï¼Œ<strong>æ˜¯ç”±ç”¨æˆ·æ‰‹åŠ¨åœ¨ä»£ç ä¸­æŒ‡å®šçš„</strong>ã€‚åªè¦è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªç¼–å·å»è·å–å…±äº«å†…å­˜ï¼Œä»–ä»¬å°±èƒ½è·å–åˆ°åŒä¸€ä»½ï¼</p><hr><h1 id="2-ç›¸å…³æ¥å£"><a href="#2-ç›¸å…³æ¥å£" class="headerlink" title="2.ç›¸å…³æ¥å£"></a>2.ç›¸å…³æ¥å£</h1><p>è¯´å®Œäº†åŸºæœ¬æ¦‚å¿µï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥åº·åº·å®ƒçš„ä½¿ç”¨</p><h2 id="2-1-ftok"><a href="#2-1-ftok" class="headerlink" title="2.1 ftok"></a>2.1 ftok</h2><p><code>ftok - convert a pathname and a project identifier to a System V IPC key</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="type">key_t</span> <span class="title function_">ftok</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> proj_id)</span>;</span><br></pre></td></tr></table></figure><p>å‰é¢æåˆ°äº†ï¼Œå…±äº«å†…å­˜çš„keyæ˜¯æˆ‘ä»¬è‡ªå·±æŒ‡å®šçš„ã€‚Linuxç³»ç»Ÿç»™å®šäº†<code>ftok</code>æ¥å£ï¼Œå°†ç”¨æˆ·æä¾›çš„<code>pathname</code>å·¥ä½œè·¯å¾„ï¼Œä»¥åŠ<code>proj_id</code>é¡¹ç›®ç¼–å·è½¬æ¢ä¸ºä¸€ä¸ªå…±äº«å†…å­˜çš„keyï¼ˆå…¶å®å°±æ˜¯intç±»å‹ï¼‰</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211121323400.png" alt="image-20221112132307366"></p><p>åªè¦æˆ‘ä»¬çš„<strong>å·¥ä½œè·¯å¾„å’Œé¡¹ç›®ç¼–å·</strong>ä¼ çš„æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå®ƒè¿”å›çš„keyå°±æ˜¯ä¸€æ ·çš„ï¼</p><h2 id="2-2-shmget"><a href="#2-2-shmget" class="headerlink" title="2.2 shmget"></a>2.2 shmget</h2><p><code>shmget - allocates a System V shared memory segment</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">size_t</span> size, <span class="type">int</span> shmflg)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°åˆ†åˆ«ä¸ºkeyå€¼ï¼Œå…±äº«å†…å­˜çš„å¤§å°ï¼Œä»¥åŠåˆ›å»ºå…±äº«å†…å­˜çš„æ–¹å¼ã€‚</p><p>keyå€¼éœ€è¦é€šè¿‡<code>ftok</code>å‡½æ•°è·å–ï¼›</p><p>å…¶ä¸­å…±äº«å†…å­˜çš„å¤§å°æœ€å¥½è®¾ç½®ä¸º4kbçš„æ•´æ•°å€ï¼Œå› ä¸ºæ“ä½œç³»ç»ŸIOçš„åŸºæœ¬å•ä½æ˜¯4KBã€‚å¦‚æœä½ ç”³è¯·äº†ä¸æ˜¯4çš„æ•´æ•°å€çš„å­—èŠ‚ï¼Œæ¯”å¦‚15ä¸ªå­—èŠ‚ï¼Œå…¶è¿˜æ˜¯ä¼šç”³è¯·16ä¸ªå­—èŠ‚(4ä¸ªé¡µ)äº¤ç»™ä½ ï¼Œè€Œå…¶ä¸­æœ‰1kbçš„å†…å­˜ä½ æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œå³é€ æˆäº†å†…å­˜æµªè´¹ğŸ˜¥</p><p>åˆ›å»ºå…±äº«å†…å­˜çš„<code>shmflg</code>:</p><ul><li><code>IPC_CREAT</code>ï¼šåˆ›å»ºå…±äº«å†…å­˜ã€‚å¦‚æœå­˜åœ¨åˆ™è·å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºåè·å–</li><li><code>IPC_EXCL</code>ï¼šå¿…é¡»é…åˆ<code>IPC_CREAT</code>ä½¿ç”¨ï¼Œå¦‚æœä¸å­˜åœ¨æŒ‡å®šçš„å…±äº«å†…å­˜ï¼Œå°±è¿›è¡Œåˆ›å»ºï¼›å¦‚æœè¯¥å…±äº«å†…å­˜å­˜åœ¨ï¼Œåˆ™<strong>å‡ºé”™è¿”å›</strong>ï¼ˆå³ä¿è¯è·å–åˆ°çš„å…±äº«å†…å­˜ä¸€å®šæ˜¯å½“å‰è¿›ç¨‹åˆ›å»ºçš„ï¼Œæ˜¯ä¸€ä¸ªæ–°çš„å…±äº«å†…å­˜ï¼‰</li></ul><p>è¿”å›å€¼æ˜¯ä¸€ä¸ªå…±äº«å†…å­˜çš„<strong>æ ‡è¯†ç¬¦</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RETURN VALUE</span><br><span class="line">       On success, a valid shared memory identifier is returned.  On errir, -1 is returned, and errno is set to indicate the error.</span><br></pre></td></tr></table></figure><p>è¿™äº›å·¥ä½œéƒ½æ˜¯æ“ä½œç³»ç»Ÿåšçš„ã€‚å…¶å†…æ ¸ä¸­æœ‰ä¸“é—¨çš„ç®¡ç†å•å…ƒæ¥åˆ¤æ–­ä¸€ä¸ªå…±äº«å†…å­˜æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠä½•æ—¶è¢«åˆ›å»ºã€è¢«ä½¿ç”¨ã€è¢«ä»€ä¹ˆè¿›ç¨‹ç»‘å®šç­‰ç­‰â€¦</p><p>å‘½ä»¤è¡Œé”®å…¥<code>man shmctl</code>ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„å†…æ ¸ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_ds</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">shm_perm</span>;</span>    <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">    <span class="type">size_t</span>          shm_segsz;   <span class="comment">/* Size of segment (bytes) */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_atime;   <span class="comment">/* Last attach time */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_dtime;   <span class="comment">/* Last detach time */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_ctime;   <span class="comment">/* Last change time */</span></span><br><span class="line">    <span class="type">pid_t</span>           shm_cpid;    <span class="comment">/* PID of creator */</span></span><br><span class="line">    <span class="type">pid_t</span>           shm_lpid;    <span class="comment">/* PID of last shmat(2)/shmdt(2) */</span></span><br><span class="line">    <span class="type">shmatt_t</span>        shm_nattch;  <span class="comment">/* No. of current attaches */</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> &#123;</span></span><br><span class="line">    <span class="type">key_t</span>          __key;    <span class="comment">/* Key supplied to shmget(2) */</span></span><br><span class="line">    <span class="type">uid_t</span>          uid;      <span class="comment">/* Effective UID of owner */</span></span><br><span class="line">    <span class="type">gid_t</span>          gid;      <span class="comment">/* Effective GID of owner */</span></span><br><span class="line">    <span class="type">uid_t</span>          cuid;     <span class="comment">/* Effective UID of creator */</span></span><br><span class="line">    <span class="type">gid_t</span>          cgid;     <span class="comment">/* Effective GID of creator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> mode;     <span class="comment">/* Permissions + SHM_DEST and</span></span><br><span class="line"><span class="comment">                                           SHM_LOCKED flags */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> __seq;    <span class="comment">/* Sequence number */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…±äº«å†…å­˜è¦è¢«ç®¡ç†ï¼Œå…¶å†…æ ¸ç»“æ„ä¸­ä¸€å®šæœ‰ä¸€ä¸ªå”¯ä¸€çš„keyå€¼æ¥æ ‡è¯†è¯¥å…±äº«å†…å­˜ï¼Œå³å’Œæ–‡ä»¶çš„<code>inode</code>ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">key_t</span>     __key; <span class="comment">//å…±äº«å†…å­˜çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”±ç”¨æˆ·åœ¨shmgetä¸­æä¾›</span></span><br></pre></td></tr></table></figure><p>å…³äºkeyä¸ºä½•è¦è®©ç”¨æˆ·æä¾›ï¼Œå·²ç»åœ¨ä¸Šé¢åšå‡ºè¿‡è§£é‡ŠğŸ‘‰ <a href="#jump">å›é¡¾ä¸€ä¸‹</a></p><hr><h2 id="2-3-shmat-x2F-shmdt"><a href="#2-3-shmat-x2F-shmdt" class="headerlink" title="2.3 shmat&#x2F;shmdt"></a>2.3 shmat&#x2F;shmdt</h2><p>atå…¶å®æ˜¯attachç»‘å®šçš„ç¼©å†™ï¼Œè¿™ä¸ªæ¥å£çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªå…±äº«å†…å­˜å’Œæˆ‘ä»¬å½“å‰çš„è¿›ç¨‹ç»‘å®šã€‚</p><p>å…¶å®å°±æ˜¯å°†è¿™ä¸ªå…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹çš„é¡µè¡¨ä¸­ï¼ˆå †æ ˆä¹‹é—´ï¼‰</p><p><code>shmat, shmdt - System V shared memory operations</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">const</span> <span class="type">void</span> *shmaddr, <span class="type">int</span> shmflg)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">shmdt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *shmaddr)</span>;</span><br></pre></td></tr></table></figure><p>ä¸€å…±æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸ºatå’Œdtï¼Œç”¨äºç»‘å®š&#x2F;è§£ç»‘å…±äº«å†…å­˜</p><p><code>shmat</code>çš„ä¸‰ä¸ªå‚æ•°å¦‚ä¸‹</p><ul><li>shmidï¼šä¸º<code>shmget</code>çš„è¿”å›å€¼</li><li>shmaddrï¼šæŒ‡å®šå…±äº«å†…å­˜è¿æ¥åˆ°å½“å‰è¿›ç¨‹ä¸­çš„åœ°å€ä½ç½®ã€‚é€šå¸¸ä¸ºç©ºï¼Œè¡¨ç¤ºè®©ç³»ç»Ÿæ¥é€‰æ‹©å…±äº«å†…å­˜çš„åœ°å€ã€‚</li><li>shmflgï¼šå¦‚æœæŒ‡å®šäº†<code>SHM_RDONLY</code>ä½ï¼Œåˆ™ä»¥åªè¯»æ–¹å¼è¿æ¥æ­¤æ®µï¼›å¦åˆ™ä»¥è¯»å†™çš„æ–¹å¼è¿æ¥æ­¤æ®µï¼›é€šå¸¸è®¾ç½®ä¸º0</li></ul><p>è°ƒç”¨æˆåŠŸçš„æ—¶å€™ï¼Œè¿”å›æŒ‡å‘å…±äº«å†…å­˜ç¬¬ä¸€ä¸ªå­—èŠ‚çš„æŒ‡é’ˆï¼›å‡ºé”™è¿”å›-1</p><ul><li><code>shmdt</code>çš„å‚æ•°ä¸º<code>shmat</code>æ­£ç¡®è°ƒç”¨æ—¶çš„è¿”å›å€¼</li></ul><p>ä»¥ä¸‹æ˜¯manæ‰‹å†Œä¸­å¯¹è¿™ä¸¤ä¸ªå‡½æ•°è¿”å›å€¼çš„æè¿°ğŸ‘‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RETURN VALUE</span><br><span class="line">       On success shmat() returns the address of the attached shared memory segment; on error (void *) -1 is returned, and errno is set  to</span><br><span class="line">       indicate the cause of the error.</span><br><span class="line"></span><br><span class="line">       On success shmdt() returns 0; on error -1 is returned, and errno is set to indicate the cause of the error.</span><br></pre></td></tr></table></figure><h2 id="2-4-shmctl"><a href="#2-4-shmctl" class="headerlink" title="2.4 shmctl"></a>2.4 shmctl</h2><p>è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨äºæ“ä½œæˆ‘ä»¬çš„å…±äº«å†…å­˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmctl</span><span class="params">(<span class="type">int</span> shmid, <span class="type">int</span> cmd, <span class="keyword">struct</span> shmid_ds *buf)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­cmdçš„å‚æ•°æœ‰ä¸‹é¢å‡ ç§</p><ul><li><p><code>IPC_RMID</code> åˆ é™¤è¯¥å…±äº«å†…å­˜</p></li><li><p><code>IPC_STAT</code> æŠŠ<code>shmid_ds</code>ç»“æ„ä¸­çš„æ•°æ®è®¾ç½®ä¸ºå…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼ï¼Œå³ç”¨å…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼è¦†ç›–<code>shmid_ds</code>çš„å€¼</p></li><li><p><code>IPC_SET</code> å¦‚æœè¿›ç¨‹æœ‰è¶³å¤Ÿçš„æƒé™ï¼Œå°±æŠŠå…±äº«å†…å­˜çš„å½“å‰å…³è”å€¼è®¾ç½®ä¸º<code>shmid_ds</code>ç»“æ„ä¸­ç»™å‡ºçš„å€¼</p></li></ul><p>æœ€åä¸€ä¸ªbufå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘<code>shmid_ds</code>ç»“æ„çš„æŒ‡é’ˆï¼Œä¸€èˆ¬è®¾ä¸ºNULL</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The buf argument is a pointer to a shmid_ds structure</span><br></pre></td></tr></table></figure><p><code>shmid_ds</code>çš„åŸºæœ¬ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_ds</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uid_t</span> shm_perm.uid;</span><br><span class="line">    <span class="type">uid_t</span> shm_perm.gid;</span><br><span class="line">    <span class="type">mode_t</span> shm_perm.mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»¥åˆ é™¤ä¸ºä¾‹ï¼Œå…¶æ“ä½œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shmctl(shmid, IPC_RMID, <span class="literal">NULL</span>);<span class="comment">//åˆ é™¤shmidçš„å…±äº«å†…å­˜</span></span><br></pre></td></tr></table></figure><h2 id="2-5-ipcså‘½ä»¤"><a href="#2-5-ipcså‘½ä»¤" class="headerlink" title="2.5 ipcså‘½ä»¤"></a>2.5 ipcså‘½ä»¤</h2><p>å…ˆæ¥åº·åº·å‡ ä¸ª<code>ipcs</code>å‘½ä»¤çš„é€‰é¡¹ï¼Œå…¶ä¸­æˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯<code>-m</code>æŸ¥çœ‹å…±äº«å†…å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ipcs -c <span class="comment">#æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—/å…±äº«å†…å­˜/ä¿¡å·é‡</span></span><br><span class="line">ipcs -s <span class="comment">#å•ç‹¬æŸ¥çœ‹ä¿¡å·é‡</span></span><br><span class="line">ipcs -q <span class="comment">#å•ç‹¬æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—</span></span><br><span class="line">ipcs -m <span class="comment">#å•ç‹¬æŸ¥çœ‹å…±äº«å†…å­˜</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œäº†ä¹‹åï¼Œä¼šåˆ—å‡ºå½“å‰æ“ä½œç³»ç»Ÿä¸­å¼€è¾Ÿçš„å…±äº«å†…å­˜ï¼Œä»¥åŠå®ƒä»¬çš„åŸºæœ¬ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ipcs -m </span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 1          muxue      0          1024       0    </span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„keyå’Œæˆ‘ä»¬ä½¿ç”¨<code>ftok</code>è·å–åˆ°çš„keyå€¼æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬æ‰“å°çš„æ—¶å€™æ˜¯åè¿›åˆ¶ï¼Œæ“ä½œç³»ç»Ÿåˆ—å‡ºæ¥çš„ä¸ºåå…­è¿›åˆ¶</p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ipcrm -m å…±äº«å†…å­˜çš„shmid</code>æ¥åˆ é™¤å…±äº«å†…å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 1          muxue      0          1024       0                       </span><br><span class="line"></span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ipcrm -m 1</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„å…±äº«å†…å­˜å·²ç»è¢«åˆ é™¤äº†</p><hr><h3 id="æ¶ˆæ¯é˜Ÿåˆ—-x2F-ä¿¡å·é‡çš„æ¥å£"><a href="#æ¶ˆæ¯é˜Ÿåˆ—-x2F-ä¿¡å·é‡çš„æ¥å£" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—&#x2F;ä¿¡å·é‡çš„æ¥å£"></a>æ¶ˆæ¯é˜Ÿåˆ—&#x2F;ä¿¡å·é‡çš„æ¥å£</h3><p>æ¶ˆæ¯é˜Ÿåˆ—å’Œä¿¡å·é‡çš„æ¥å£å’Œå…±äº«å†…å­˜å¾ˆç›¸ä¼¼</p><p>æ¶ˆæ¯é˜Ÿåˆ—ç”¨çš„ä¸å¤šï¼Œä¿¡å·é‡çš„éš¾åº¦å¾ˆé«˜ï¼ğŸ˜‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³æ¥å£</span></span><br><span class="line">msgget <span class="comment">//è·å–</span></span><br><span class="line">msgctl <span class="comment">//æ“ä½œ</span></span><br><span class="line">msgsnd <span class="comment">//å‘é€ä¿¡æ¯</span></span><br><span class="line">msgrcv </span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¿¡å·é‡</span></span><br><span class="line">semget</span><br><span class="line">semctl</span><br><span class="line">semop</span><br></pre></td></tr></table></figure><h3 id="ipcrm"><a href="#ipcrm" class="headerlink" title="ipcrm"></a>ipcrm</h3><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥ç”¨ä¸åˆ é™¤ipcèµ„æºï¼ŒåŒ…æ‹¬å…±äº«å†…å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipcrm -m shmid <span class="comment">#åˆ é™¤å…±äº«å†…å­˜</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å°è¯•ç”¨è¯¥å‘½ä»¤åˆ é™¤ä¸€ä¸ªæ­£åœ¨è¢«ä½¿ç”¨çš„å…±äº«å†…å­˜æ—¶ï¼Œå®ƒå¹¶ä¸ä¼šè¢«ç«‹å³åˆ é™¤ï¼ˆç«‹å³åˆ é™¤ä¼šå½±å“è¿›ç¨‹è¿è¡Œï¼‰</p><p>æ­¤æ—¶æ‰§è¡Œåˆ é™¤ï¼Œåœ¨å…±äº«å†…å­˜çš„<code>status</code>åˆ—ä¼šå‡ºç°<code>dest</code>ï¼›è§‚å¯Ÿç»“æœï¼Œå½“<strong>è¿›ç¨‹ç»“æŸ</strong>çš„æ—¶å€™ï¼Œè¿™ä¸ªå…±äº«å†…å­˜ä¼šè¢«ç›´æ¥åˆ é™¤ï¼ˆè¿›ç¨‹å†…éƒ¨å¹¶æ²¡æœ‰è°ƒç”¨<code>shmctl</code>æ¥å£ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 21         muxue      666        1024       2                       </span><br><span class="line"></span><br><span class="line">[muxue@bt-7274:~/git]$ ipcrm -m 21</span><br><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x00000000 21         muxue      666        1024       2          dest         </span><br><span class="line"></span><br><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                 </span><br></pre></td></tr></table></figure><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¦‚æœä¸æ‰§è¡Œ<code>ipcrm</code>å‘½ä»¤+è¿›ç¨‹å†…éƒ¨ä¸è°ƒç”¨<code>shmctl</code>æ¥å£ï¼Œè¿™ä¸ªå…±äº«å†…å­˜å°±ä¼šä¸€ç›´å­˜åœ¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 22         muxue      666        1024       0                       </span><br></pre></td></tr></table></figure><p>ç»“è®ºï¼šä½¿ç”¨<code>ipcrm -m</code>å‘½ä»¤åˆ é™¤å…±äº«å†…å­˜ä¹‹åï¼Œå…¶å…±äº«å†…å­˜ä¸ä¸€å®šä¼šç«‹å³é‡Šæ”¾ã€‚å¦‚æœæœ‰è¿›ç¨‹å…³è”äº†è¯¥å…±äº«å†…å­˜ï¼Œåˆ™ä¼šåœ¨è¿›ç¨‹<strong>å»å…³è”ä¹‹åé‡Šæ”¾</strong></p><h1 id="3-ä½¿ç”¨"><a href="#3-ä½¿ç”¨" class="headerlink" title="3.ä½¿ç”¨"></a>3.ä½¿ç”¨</h1><h2 id="3-1-åˆ›å»ºå¹¶è·å–"><a href="#3-1-åˆ›å»ºå¹¶è·å–" class="headerlink" title="3.1 åˆ›å»ºå¹¶è·å–"></a>3.1 åˆ›å»ºå¹¶è·å–</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¤´æ–‡ä»¶å®åœ¨å¤ªå¤šï¼Œä¸ºäº†åšå®¢ç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥äº†</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROJ_ID 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PATH_NAME <span class="string">&quot;/home/muxue/git/linux/code/22-11-12_systemV&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">key_t</span> <span class="title function_">CreateKey</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">key_t</span> key = ftok(PATH_NAME, PROJ_ID);</span><br><span class="line">    <span class="keyword">if</span>(key &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cerr</span> &lt;&lt;<span class="string">&quot;ftok: &quot;</span>&lt;&lt; strerror(errno) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//keyè·å–é”™è¯¯ç›´æ¥é€€å‡ºç¨‹åº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">key_t</span> key = CreateKey();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> id = shmget(key, NUM, IPC_CREAT | IPC_EXCL);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cerr</span>&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; strerror(errno) &lt;&lt; <span class="built_in">endl</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="File-exists"><a href="#File-exists" class="headerlink" title="File exists"></a>File exists</h3><p>è¿™é‡Œä¼šå‘ç°ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œä»£ç çš„æ—¶å€™ï¼Œç¨‹åºæˆåŠŸè·å–äº†å…±äº«å†…å­˜ï¼›ä½†æ˜¯ç¬¬äºŒæ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œå´æŠ¥é”™è¯´<code>File exists(æ–‡ä»¶å­˜åœ¨)</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ./test</span><br><span class="line">shmget: 1</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ./test</span><br><span class="line">shmget err: File exists</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºå…±äº«å†…å­˜çš„å£°æ˜å‘¨æœŸæ˜¯éšå†…æ ¸çš„ã€‚å³åªè¦è¿™ä¸ªå…±äº«å†…å­˜ä¸è¢«åˆ é™¤ï¼Œä»–å°±ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å†…æ ¸å› ä¸ºæŸç§åŸå› é‡Šæ”¾æ‰å®ƒï¼Œäº¦æˆ–è€…æ“ä½œç³»ç»Ÿå…³æœº</p><p>é€šè¿‡ä¸Šé¢æåˆ°çš„<code>ipcrm -m shmid</code> å‘½ä»¤åˆ é™¤å…±äº«å†…å­˜ï¼Œæ‰èƒ½é‡æ–°è¿è¡Œä»£ç è·å–æ–°çš„å…±äº«å†…å­˜</p><blockquote><p>ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œåº”è¯¥åœ¨è¿›ç¨‹ç»“æŸåä½¿ç”¨<code>shmctl</code>æ¥å£åˆ é™¤å…±äº«å†…å­˜</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ./test</span><br><span class="line">shmget success: 2</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-11-12_systemV]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 2          muxue      0          1024       0                       </span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®æƒé™å€¼"><a href="#è®¾ç½®æƒé™å€¼" class="headerlink" title="è®¾ç½®æƒé™å€¼"></a>è®¾ç½®æƒé™å€¼</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å…±äº«å†…å­˜çš„<code>perms</code>æ˜¯0ï¼Œä»£è¡¨æ²¡æœ‰ç”¨æˆ·èƒ½è®¿é—®è¿™ä¸ªå…±äº«å†…å­˜ã€‚æ‰€ä»¥åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åœ¨flagé‡Œé¢ç›´æ¥æˆ–ä¸Šè¿™ä¸ªå…±äº«å†…å­˜çš„æƒé™å€¼</p><p>ä»£ç å¦‚ä¸‹ğŸ‘‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">key_t</span> key = CreateKey();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> id = shmget(key, NUM, IPC_CREAT | IPC_EXCL | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cerr</span>&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; strerror(errno) &lt;&lt; <span class="built_in">endl</span>; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    shmctl(id,IPC_RMID,nullptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™åˆ›å»ºçš„å…±äº«å†…å­˜å°±æœ‰æ­£ç¡®çš„æƒé™å€¼äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 4          muxue      666        1024       0    </span><br></pre></td></tr></table></figure><h2 id="3-2-æŒ‚æ¥-x2F-å–æ¶ˆæŒ‚æ¥"><a href="#3-2-æŒ‚æ¥-x2F-å–æ¶ˆæŒ‚æ¥" class="headerlink" title="3.2 æŒ‚æ¥&#x2F;å–æ¶ˆæŒ‚æ¥"></a>3.2 æŒ‚æ¥&#x2F;å–æ¶ˆæŒ‚æ¥</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³è”å…±äº«å†…å­˜</span></span><br><span class="line"><span class="type">char</span> *str = (<span class="type">char</span>*)<span class="built_in">shmat</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>å› ä¸ºshmatå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª<code>void*</code>æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ä½¿ç”¨<code>malloc</code>ä¸€æ ·çš„æ–¹å¼ä½¿æ¥æŒ‚æ¥å…±äº«å†…å­˜ã€‚éšåå¯¹è¿™ä¸ªå†…å­˜çš„æ“ä½œå°±æ˜¯æ­£å¸¸çš„æŒ‡é’ˆæ“ä½œäº†ï¼</p><p>åŒæ ·çš„ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹ä¹Ÿéœ€è¦ç”¨åŒæ ·çš„æ–¹å¼æŒ‚æ¥å…±äº«å†…å­˜ï¼Œæ‰èƒ½è¯»å–åˆ°ç›¸åŒçš„æ•°æ®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git]$ ipcs -m</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status      </span><br><span class="line">0x00005feb 0          root       666        12000      1                       </span><br><span class="line">0x20011ac8 4          muxue      666        1024       1   </span><br></pre></td></tr></table></figure><p>æŒ‚æ¥æˆåŠŸåï¼Œå¯ä»¥å‘ç°<code>nattch</code>çš„å€¼ä»0å˜ä¸º1</p><h3 id="å–æ¶ˆ-x2F-åˆ é™¤"><a href="#å–æ¶ˆ-x2F-åˆ é™¤" class="headerlink" title="å–æ¶ˆ&#x2F;åˆ é™¤"></a>å–æ¶ˆ&#x2F;åˆ é™¤</h3><p>å–æ¶ˆæŒ‚æ¥çš„æ–¹å¼å¾ˆç®€å•ï¼Œç›´æ¥æŠŠ<code>shmat</code>çš„è¿”å›å€¼ä¼ å…¥å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shmdt(str);<span class="comment">//å–æ¶ˆæŒ‚æ¥</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯æœåŠ¡ç«¯ï¼Œåˆ™è¿˜éœ€è¦åœ¨å–æ¶ˆæŒ‚æ¥ä¹‹åï¼Œåˆ é™¤å…±äº«å†…å­˜ã€‚é¿å…ä¸‹æ¬¡ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œæ— æ³•é€šè¿‡keyè·å–åˆ°æ–°çš„å…±äº«å†…å­˜</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">shmctl</span>(id,IPC_RMID,<span class="literal">nullptr</span>);<span class="comment">//åˆ é™¤å…±äº«å†…å­˜</span></span><br></pre></td></tr></table></figure><h2 id="3-3-å†™å…¥å†…å®¹"><a href="#3-3-å†™å…¥å†…å®¹" class="headerlink" title="3.3 å†™å…¥å†…å®¹"></a>3.3 å†™å…¥å†…å®¹</h2><p>å› ä¸ºå…±äº«å†…å­˜æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå†…å­˜ï¼Œå…¶å’Œmallocå‡ºæ¥çš„å†…å­˜éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç›´æ¥ä½¿ç”¨å³å¯</p><p>è¿™é‡Œè¿˜æ˜¯ç”¨ä¸€ä¸ªæœåŠ¡ç«¯å’Œä¸€ä¸ªå®¢æˆ·ç«¯æ¥è¿›è¡Œæ¼”ç¤º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Mykey.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–keyå€¼</span></span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">CreateKey</span>();</span><br><span class="line">    <span class="comment">//åˆ›å»ºå…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> id = <span class="built_in">shmget</span>(key, NUM, IPC_CREAT | IPC_EXCL | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//å…³è”å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">char</span> *str = (<span class="type">char</span>*)<span class="built_in">shmat</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] shmat success\n&quot;</span>);</span><br><span class="line">    <span class="comment">//è¯»å–æ•°æ®ï¼Œsleep(1)</span></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=<span class="number">40</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%03d] %s\n&quot;</span>,i,str);</span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»å…³è”</span></span><br><span class="line">    <span class="built_in">shmdt</span>(str);<span class="comment">//shmatçš„è¿”å›å€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] shmdt(str)\n&quot;</span>);</span><br><span class="line">    <span class="comment">//åˆ é™¤å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="built_in">shmctl</span>(id,IPC_RMID,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//client.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Mykey.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–keyå€¼</span></span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">CreateKey</span>();</span><br><span class="line">    <span class="comment">//è·å–å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> id = <span class="built_in">shmget</span>(key, NUM, IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//å…³è”å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">char</span> *str = (<span class="type">char</span>*)<span class="built_in">shmat</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[client] shmat success\n&quot;</span>);</span><br><span class="line">    <span class="comment">//å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;<span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> base = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        str[i] = base+i;</span><br><span class="line">        str[i+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write times: %02d\n&quot;</span>,i);</span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»å…³è”</span></span><br><span class="line">    <span class="built_in">shmdt</span>(str);<span class="comment">//shmatçš„è¿”å›å€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[client] shmdt &amp; exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·‘èµ·æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯å‘å…±äº«å†…å­˜ä¸­å†™å…¥æ•°æ®ï¼ˆæ³¨æ„æ§åˆ¶<code>\0</code>ï¼‰æœåŠ¡ç«¯è¿›è¡Œè¯»å–ã€‚è¿™ä¾¿å®ç°äº†æˆ‘ä»¬è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211130917762.png" alt="image-20221113091741600"></p><p>ä¸è¿‡æˆ‘ä»¬å‘ç°ï¼Œå®¢æˆ·ç«¯å·²ç»åœæ­¢å†™å…¥ä¹‹åï¼ŒæœåŠ¡ç«¯è¿˜æ˜¯åœ¨ä¸åœçš„è¯»å–ã€‚å¦‚æœæˆ‘ä»¬ä¸æ§åˆ¶<code>while</code>å¾ªç¯çš„è¯ï¼Œå…¶ä¼šä¸€ç›´è¿™ä¹ˆè¯»å–ä¸‹å»</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211130918667.png" alt="image-20221113091847579"></p><p>è¿™ä¾¿ç‰µæ‰¯å‡ºå…±äº«å†…å­˜çš„ä¸€ä¸ªç‰¹æ€§äº†</p><h3 id="å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶"><a href="#å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶" class="headerlink" title="å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶"></a>å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶</h3><p>åœ¨ç®¡é“çš„åšå®¢ä¸­æåˆ°ï¼Œç®¡é“æ˜¯æœ‰è®¿é—®æ§åˆ¶çš„è¿›ç¨‹é€šä¿¡æ–¹å¼ï¼Œå†™ç«¯æ²¡æœ‰å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œè¯»ç«¯ä¼šåœ¨<code>read</code>ä¸­è¿›è¡Œç­‰å¾…</p><p>è€Œå…±äº«å†…å­˜å› ä¸ºæˆ‘ä»¬æ˜¯ç›´æ¥åƒæ“ä½œä¸€ä¸ªmallocå‡ºæ¥çš„ç©ºé—´ä¸€æ ·è®¿é—®ï¼Œ<strong>æ²¡æœ‰ä½¿ç”¨ä»»ä½•ç³»ç»Ÿæ¥å£</strong>ï¼ˆç›¸æ¯”ä¹‹ä¸‹ç®¡é“éœ€è¦ä½¿ç”¨<code>read/write</code>ï¼‰æ‰€ä»¥æ“ä½œç³»ç»Ÿæ²¡æœ‰åŠæ³•å¸®æˆ‘ä»¬è¿›è¡Œè®¿é—®æ§åˆ¶</p><p>ä¹Ÿæ­£æ˜¯å› ä¸ºæ²¡æœ‰ç­‰å¾…ï¼Œå…±äº«å†…å­˜æ˜¯è¿›ç¨‹ä¸­é€šä¿¡ä¸­<strong>æœ€å¿«</strong>çš„ä¸€ç§æ–¹å¼</p><h3 id="é€šè¿‡ç®¡é“è¿›è¡Œå…±äº«å†…å­˜çš„æ§åˆ¶"><a href="#é€šè¿‡ç®¡é“è¿›è¡Œå…±äº«å†…å­˜çš„æ§åˆ¶" class="headerlink" title="é€šè¿‡ç®¡é“è¿›è¡Œå…±äº«å†…å­˜çš„æ§åˆ¶"></a>é€šè¿‡ç®¡é“è¿›è¡Œå…±äº«å†…å­˜çš„æ§åˆ¶</h3><p>æ—¢ç„¶å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç®¡é“æ¥è®©æ§åˆ¶å…±äº«å†…å­˜çš„è¯»å†™</p><ul><li>å†™ç«¯å†™å®Œåï¼Œå°†å®Œæˆä¿¡å·å†™å…¥ç®¡é“ï¼Œç”±è¯»ç«¯è¯»å–</li><li>è¯»ç«¯ä»ç®¡é“ä¸­è·å–åˆ°ä¿¡å·åï¼Œè®¿é—®å…±äº«å†…å­˜è¯»å‡ºå†…å®¹</li><li>å¦‚æœå†™ç«¯æ²¡æœ‰å†™å¥½ï¼Œè¯»ç«¯å°±ä¼šåœ¨ç®¡é“readå†…éƒ¨ç­‰å¾…</li></ul><p>ä½ å¯èƒ½ä¼šè¯´ï¼Œé‚£ä¸ºä½•ä¸ç›´æ¥ç”¨ç®¡é“é€šä¿¡å‘¢ï¼Ÿ</p><ul><li>ç®¡é“ä»…ä½œè®¿é—®æ§åˆ¶ï¼Œåªéœ€è¦ä¸€ä¸ªintä¹ƒè‡³ä¸€ä¸ªcharç±»å‹å³å¯ï¼›</li><li>ç›¸æ¯”ç›´æ¥ç®¡é“é€šä¿¡ï¼Œå†…å­˜çš„æ–¹å¼æ›´å¥½æ§åˆ¶ï¼ˆæ¯•ç«Ÿä½¿ç”¨å†…å­˜çš„æ–¹å¼å’Œä½¿ç”¨æŒ‡é’ˆä¸€æ ·ï¼Œç®¡é“è¿˜éœ€è¦æ–‡ä»¶æ“ä½œï¼‰</li><li>è¯»å–å¾ˆé•¿ä¸€ä¸²æ•°æ®çš„æ—¶å€™ï¼Œå…±äº«å†…å­˜çš„é€Ÿåº¦ä¼˜åŠ¿èƒ½ä½“ç°å‡ºæ¥</li></ul><p>ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç ğŸ‘‡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//mykey.hpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROJ_ID 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PATH_NAME <span class="string">&quot;/home/muxue/git/linux/code/22-11-12_systemV&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIFO_FILE <span class="string">&quot;sc.pipe&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">key_t</span> <span class="title">CreateKey</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">ftok</span>(PATH_NAME, PROJ_ID);</span><br><span class="line">    <span class="keyword">if</span>(key &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt;<span class="string">&quot;ftok: &quot;</span>&lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);<span class="comment">//keyè·å–é”™è¯¯ç›´æ¥é€€å‡ºç¨‹åº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CreateFifo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">umask</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">mkfifo</span>(FIFO_FILE, <span class="number">0666</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;fifo: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‰“å¼€ç®¡é“æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Open</span><span class="params">(<span class="type">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(FIFO_FILE, flags);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è®©è¯»ç«¯é€šè¿‡ç®¡é“ç­‰å¾…</span></span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">Wait</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœå†™ç«¯æ²¡æœ‰å†™å…¥ï¼Œå…¶å°±ä¼šåœ¨readä¸­ç­‰å¾…</span></span><br><span class="line">    <span class="type">ssize_t</span> s = <span class="built_in">read</span>(fd, &amp;val, <span class="built_in">sizeof</span>(val));</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å‘é€å®Œæˆä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Signal</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> sig = <span class="string">&#x27;g&#x27;</span>;</span><br><span class="line">    <span class="built_in">write</span>(fd, &amp;sig, <span class="built_in">sizeof</span>(sig));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//server.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Mykey.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºç®¡é“</span></span><br><span class="line">    <span class="built_in">CreateFifo</span>();</span><br><span class="line">    <span class="comment">//è·å–keyå€¼</span></span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">CreateKey</span>();</span><br><span class="line">    <span class="comment">//åˆ›å»ºå…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> id = <span class="built_in">shmget</span>(key, NUM, IPC_CREAT | IPC_EXCL | <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">    <span class="comment">//è·å–ç®¡é“</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">Open</span>(O_RDONLY);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;open fifo success: &quot;</span> &lt;&lt; fd &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//å…³è”å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">char</span> *str = (<span class="type">char</span>*)<span class="built_in">shmat</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] shmat success\n&quot;</span>);</span><br><span class="line">    <span class="comment">//è¯»å–æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;=<span class="number">40</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">ssize_t</span> ret = <span class="built_in">Wait</span>(fd);<span class="comment">//é€šè¿‡ç®¡é“ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span>(ret!=<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%03d] %s\n&quot;</span>,i,str);</span><br><span class="line">            i++;</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout&lt;&lt;<span class="string">&quot;[server] wait finish, break&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»å…³è”</span></span><br><span class="line">    <span class="built_in">shmdt</span>(str);<span class="comment">//shmatçš„è¿”å›å€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] shmdt(str)\n&quot;</span>);</span><br><span class="line">    <span class="comment">//åˆ é™¤å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="built_in">shmctl</span>(id,IPC_RMID,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">unlink</span>(FIFO_FILE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[server] exit\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//client.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Mykey.hpp&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//è·å–keyå€¼</span></span><br><span class="line">    <span class="type">key_t</span> key = <span class="built_in">CreateKey</span>();</span><br><span class="line">    <span class="comment">//è·å–å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">int</span> id = <span class="built_in">shmget</span>(key, NUM, IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span>(id&lt;<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr&lt;&lt; <span class="string">&quot;shmget err: &quot;</span> &lt;&lt; <span class="built_in">strerror</span>(errno) &lt;&lt; endl; </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;shmget success: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ç®¡é“</span></span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">Open</span>(O_WRONLY);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;open fifo success: &quot;</span> &lt;&lt; fd &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//å…³è”å…±äº«å†…å­˜</span></span><br><span class="line">    <span class="type">char</span> *str = (<span class="type">char</span>*)<span class="built_in">shmat</span>(id, <span class="literal">nullptr</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[client] shmat success\n&quot;</span>);</span><br><span class="line">    <span class="comment">//å†™å…¥æ•°æ®</span></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i&lt;<span class="number">26</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> base = <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        str[i] = base+i;</span><br><span class="line">        str[i+<span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;write times: %02d\n&quot;</span>,i);</span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">Signal</span>(fd);</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å»å…³è”</span></span><br><span class="line">    <span class="built_in">shmdt</span>(str);<span class="comment">//shmatçš„è¿”å›å€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[client] shmdt &amp; exit\n&quot;</span>);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[client] close fifo\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p>ç®¡é“æ§åˆ¶äº†ä¹‹åï¼Œå½“å®¢æˆ·ç«¯é€€å‡ºçš„æ—¶å€™ï¼Œç®¡é“ä¹Ÿä¸ä¼šç»§ç»­è¯»å–ï¼Œè€Œæ˜¯åœ¨readå†…ç­‰å¾…</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211131049472.png" alt="image-20221113104949379"></p><p>å¦‚æœå®¢æˆ·ç«¯æœ€åå…³é—­äº†ç®¡é“çš„å†™æ®µï¼ŒæœåŠ¡å™¨ç«¯å°±ä¼šç›´æ¥é€€å‡ºã€‚è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†é€šè¿‡ç®¡é“æ§åˆ¶<strong>å…±äº«å†…å­˜</strong>çš„è¯»å†™ğŸ‘</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211131117485.png" alt="image-20221113111731418"></p><hr><h1 id="4-ç›¸å…³æ¦‚å¿µ"><a href="#4-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="4.ç›¸å…³æ¦‚å¿µ"></a>4.ç›¸å…³æ¦‚å¿µ</h1><h2 id="4-0-ä¸´ç•Œèµ„æº"><a href="#4-0-ä¸´ç•Œèµ„æº" class="headerlink" title="4.0 ä¸´ç•Œèµ„æº"></a>4.0 ä¸´ç•Œèµ„æº</h2><p>èƒ½è¢«å¤šä¸ªè¿›ç¨‹çœ‹åˆ°çš„èµ„æºï¼Œè¢«ç§°ä¸º<code>ä¸´ç•Œèµ„æº</code></p><p>å¦‚æœä¸å¯¹ä¸´ç•Œèµ„æºè¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œè¿›ç¨‹å¯¹è¯¥èµ„æºçš„è®¿é—®å°±æ˜¯<strong>ä¹±åºçš„</strong>ï¼ˆæ¯”å¦‚çˆ¶å­è¿›ç¨‹å‘æ˜¾ç¤ºå™¨æ‰“å°å†…å®¹ï¼‰å¯èƒ½ä¼šå› ä¸ºæ•°æ®äº¤å‰å¯¼è‡´ä¹±ç ã€æ•°æ®ä¸å¯ç”¨ç­‰æƒ…å†µ</p><p>ä»¥æ­¤å¯è§ï¼Œæ˜¾ç¤ºå™¨ã€ç®¡é“ã€å…±äº«å†…å­˜éƒ½æ˜¯ä¸´ç•Œèµ„æº</p><ul><li>ç®¡é“æ˜¯æœ‰è®¿é—®æ§åˆ¶çš„ä¸´ç•Œèµ„æº</li></ul><p>è¿›ç¨‹è®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ï¼Œç§°ä¸º<code>ä¸´ç•ŒåŒº</code></p><ul><li>ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ä»£ç éƒ½åœ¨è®¿é—®ä¸´ç•Œèµ„æºã€‚å¦‚ç®¡é“ä¸­ï¼Œå…¶å®åªæœ‰<code>read/write</code>æ¥å£åœ¨è®¿é—®ä¸´ç•Œèµ„æº</li></ul><p><strong>äº’æ–¥</strong>ï¼šä»»ä½•æ—¶åˆ»ï¼Œåªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®ä¸´ç•Œèµ„æº</p><p><strong>åŸå­æ€§</strong>ï¼šä¸€ä»¶äº‹æƒ…åªæœ‰<code>åšå®Œ/æ²¡åš</code>ä¸¤ç§çŠ¶æ€ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€</p><p>ä¸‹é¢å¯¹ä¿¡å·é‡çš„æ¦‚å¿µè¿›è¡Œè®²è§£~åªç”¨åŸºæœ¬ç†è§£å³å¯</p><h2 id="4-1-ä¿¡å·é‡"><a href="#4-1-ä¿¡å·é‡" class="headerlink" title="4.1 ä¿¡å·é‡"></a>4.1 ä¿¡å·é‡</h2><p>ä¿¡å·é‡æ˜¯å¯¹<code>ä¸´ç•Œèµ„æº</code>çš„æ§åˆ¶æ–¹å¼ä¹‹ä¸€ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ª<strong>è®¡æ•°å™¨</strong></p><ul><li>ä¿¡å·é‡ä¿è¯<strong>ä¸ä¼šæœ‰å¤šä½™</strong>çš„è¿›ç¨‹è¿æ¥åˆ°è¿™ä»½ä¸´ç•Œèµ„æº</li><li>è¿˜éœ€è¦ä¿è¯æ¯ä¸€ä¸ªè¿›ç¨‹çš„èƒ½å¤Ÿè®¿é—®åˆ°ä¸´ç•Œèµ„æºçš„ä¸åŒä½ç½®ï¼ˆæ ¹æ®ä¸Šå±‚ä¸šåŠ¡å†³å®šï¼‰</li></ul><p>ä¿¡å·é‡æ ¹æ®æƒ…å†µçš„ä¸åŒåˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>äºŒå…ƒä¿¡å·é‡ï¼ˆ<strong>äº’æ–¥</strong>çŠ¶æ€ï¼Œå½“è¿›ç¨‹ä½¿ç”¨çš„æ—¶å€™ä¸º1ï¼Œæ²¡æœ‰è¿›ç¨‹ä½¿ç”¨çš„æ—¶å€™ä¸º0ï¼‰</li><li>å¤šå…ƒä¿¡å·é‡ï¼ˆå¸¸è§„ï¼‰</li></ul><p>å¦‚æœä¸€ä¸ªè¿›ç¨‹æƒ³è®¿é—®ç”±ä¿¡å·é‡æ§åˆ¶çš„ä¸´ç•Œèµ„æºï¼Œå¿…é¡»å…ˆç”³è¯·ä¿¡å·é‡ã€‚ç”³è¯·æˆåŠŸï¼Œå°±ä¸€å®šèƒ½è®¿é—®åˆ°è¿™ä¸ªä¸´ç•Œèµ„æºä¸­çš„ä¸€éƒ¨åˆ†ï¼ˆæˆ–è€…å…¨éƒ¨ï¼‰</p><h3 id="åŸå­æ€§çš„è¯´æ˜"><a href="#åŸå­æ€§çš„è¯´æ˜" class="headerlink" title="åŸå­æ€§çš„è¯´æ˜"></a>åŸå­æ€§çš„è¯´æ˜</h3><p>å…ˆæ¥æƒ³æƒ³ï¼Œæˆ‘ä»¬å¯¹ä¸€ä¸ªå˜é‡<code>+1/-1</code>éœ€è¦åšä»€ä¹ˆå·¥ä½œï¼š</p><ul><li>å°†è¿™ä¸ªå˜é‡ä»å†…å­˜ä¸­æ‹¿åˆ°CPUçš„å¯„å­˜å™¨ä¸­</li><li>åœ¨å¯„å­˜å™¨ä¸­å®ŒæˆåŠ å‡æ“ä½œ</li><li>æ”¾å›å†…å­˜</li></ul><p>è¿™å…¶ä¸­æ˜¯æœ‰å¾ˆå¤šä¸ªä¸­é—´çŠ¶æ€çš„ï¼Œè®¾è¯¥å˜é‡åˆå§‹å€¼ä¸º100</p><ul><li>å‡è®¾ä¸€ä¸ªè¿›ç¨‹Aæ‹¿èµ°äº†è¿™ä¸ªå˜é‡ï¼Œæ”¾å…¥CPUçš„å¯„å­˜å™¨</li><li>å¦å¤–ä¸€ä¸ªè¿›ç¨‹Bä¹Ÿæ¥æ‹¿èµ°äº†è¿™ä¸ªå˜é‡</li><li>æ­¤æ—¶Aå’ŒBæ‹¿åˆ°çš„éƒ½æ˜¯100</li><li>Aå¯¹è¯¥å˜é‡è¿›è¡Œäº†å¾ªç¯<code>--</code>æ“ä½œï¼Œæœ€ç»ˆè¯¥å˜é‡å˜æˆäº†50ï¼Œå°†å…¶æ”¾å›å†…å­˜</li><li>Bå¯¹è¯¥å˜é‡<code>-1</code>ï¼Œå°†å…¶æ”¾å›å†…å­˜</li><li>æœ€ç»ˆå¯¼è‡´Aå¯¹å˜é‡çš„æ“ä½œè¢«Bè¦†ç›–ï¼Œå‡ºç°äº†å˜é‡ä¸ç»Ÿä¸€çš„æƒ…å†µ</li></ul><p>è€Œæˆ‘ä»¬çš„ä¿¡å·é‡ä¸ºäº†ä¿è¯èƒ½å¤Ÿæ­£ç¡®çš„æ§åˆ¶è¿›ç¨‹çš„è®¿é—®ï¼Œ<strong>å…¶å°±å¿…é¡»ç»´æŠ¤è‡ªèº«çš„åŸå­æ€§</strong>ï¼ä¸èƒ½æœ‰<strong>ä¸­é—´çŠ¶æ€</strong></p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211031203959.jpg" alt="QQå›¾ç‰‡20220424132543"></p><p>è¯´äººè¯å°±æ˜¯ï¼Œå¦‚æœè¿›ç¨‹Aåœ¨è®¿é—®ä¿¡å·é‡ï¼Œè¿›ç¨‹Bæ¥äº†ï¼Œä¿¡å·é‡åº”è¯¥æ‹’ç»Bçš„è®¿é—®ï¼Œç›´åˆ°Aè®¿é—®ç»“æŸã€‚ä¸èƒ½è®©Bä¸­é€”æ’å…¥è®¿é—®ï¼Œä»è€Œå¯¼è‡´<strong>å¯èƒ½çš„æ•°æ®ä¸ç»Ÿä¸€</strong></p><blockquote><p><strong>å…±äº«å†…å­˜åŒæ ·å¯ä»¥é€šè¿‡ä¿¡å·é‡è¿›è¡Œè®¿é—®æ§åˆ¶</strong></p></blockquote><h3 id="æ”¹å˜ä¿¡å·é‡çš„å€¼"><a href="#æ”¹å˜ä¿¡å·é‡çš„å€¼" class="headerlink" title="æ”¹å˜ä¿¡å·é‡çš„å€¼"></a>æ”¹å˜ä¿¡å·é‡çš„å€¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">semop</span><span class="params">(<span class="type">int</span> semid, <span class="keyword">struct</span> sembuf *sops, <span class="type">size_t</span> nops)</span>;</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼š æ“ä½œä¿¡å·é‡ï¼Œ<code>P V</code> æ“ä½œ</p><p>å‚æ•°ï¼š</p><ul><li>semid ä¸ºä¿¡å·é‡é›†çš„æ ‡è¯†ç¬¦ï¼›</li><li>sops æŒ‡å‘è¿›è¡Œæ“ä½œçš„ç»“æ„ä½“æ•°ç»„çš„é¦–åœ°å€ï¼›</li><li>nsops æŒ‡å‡ºå°†è¦è¿›è¡Œæ“ä½œçš„ä¿¡å·çš„ä¸ªæ•°ï¼›</li></ul><p>è¿”å›å€¼ï¼š æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RETURN VALUE</span><br><span class="line">       If successful semop() and semtimedop() return 0; otherwise they return -1 with errno indicating the error.</span><br></pre></td></tr></table></figure><h2 id="4-2-æ‰©å±•-mmap"><a href="#4-2-æ‰©å±•-mmap" class="headerlink" title="4.2 æ‰©å±• mmap"></a>4.2 æ‰©å±• mmap</h2><blockquote><p>è¿™éƒ¨åˆ†ä»…ä¾›å‚è€ƒï¼Œå¯èƒ½æœ‰é”™è¯¯ğŸ˜¥<a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/224953636#:~:text=struct%20ipc_ids%20%7B%20int%20in_use%3B%2F%2F%E8%AF%B4%E6%98%8E%E5%B7%B2%E5%88%86%E9%85%8D%E7%9A%84%E8%B5%84%E6%BA%90%E4%B8%AA%E6%95%B0%20int%20max_id%3B%2F%E5%9C%A8%E4%BD%BF%E7%94%A8%E7%9A%84%E6%9C%80%E5%A4%A7%E7%9A%84%E4%BD%8D%E7%BD%AE%E7%B4%A2%E5%BC%95%20unsigned,ipc_ids%E7%9A%84%E4%BF%A1%E5%8F%B7%E9%87%8F%20struct%20ipc_id_ary%20nullentry%3B%2F%2F%E5%A6%82%E6%9E%9CIPC%E8%B5%84%E6%BA%90%E6%97%A0%E6%B3%95%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E5%88%99entries%E5%AD%97%E6%AE%B5%E6%8C%87%E5%90%91%E4%BC%AA%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20struct%20ipc_id_ary%2A%20entries%3B%2F%2F%E6%8C%87%E5%90%91%E8%B5%84%E6%BA%90ipc_id_ary%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E6%8C%87%E9%92%88%20%7D%3B">éƒ¨åˆ†èµ„æ–™å‚è€ƒ<i class="fas fa-external-link-alt"></i></a></p></blockquote><p>å‰é¢è´´å‡ºè¿‡<code>IPC</code>èµ„æºçš„å†…æ ¸ç»“æ„ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼šç¬¬ä¸€ä¸ªæˆå‘˜éƒ½ç›¸åŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_ds</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">shm_perm</span>;</span>    <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">    <span class="type">size_t</span>          shm_segsz;   <span class="comment">/* Size of segment (bytes) */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_atime;   <span class="comment">/* Last attach time */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_dtime;   <span class="comment">/* Last detach time */</span></span><br><span class="line">    <span class="type">time_t</span>          shm_ctime;   <span class="comment">/* Last change time */</span></span><br><span class="line">    <span class="type">pid_t</span>           shm_cpid;    <span class="comment">/* PID of creator */</span></span><br><span class="line">    <span class="type">pid_t</span>           shm_lpid;    <span class="comment">/* PID of last shmat(2)/shmdt(2) */</span></span><br><span class="line">    <span class="type">shmatt_t</span>        shm_nattch;  <span class="comment">/* No. of current attaches */</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">sem_perm</span>;</span>  <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">    <span class="type">time_t</span>          sem_otime; <span class="comment">/* Last semop time */</span></span><br><span class="line">    <span class="type">time_t</span>          sem_ctime; <span class="comment">/* Last change time */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   sem_nsems; <span class="comment">/* No. of semaphores in set */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msqid_ds</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">msg_perm</span>;</span>     <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">    <span class="type">time_t</span>          msg_stime;    <span class="comment">/* Time of last msgsnd(2) */</span></span><br><span class="line">    <span class="type">time_t</span>          msg_rtime;    <span class="comment">/* Time of last msgrcv(2) */</span></span><br><span class="line">    <span class="type">time_t</span>          msg_ctime;    <span class="comment">/* Time of last change */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>   __msg_cbytes; <span class="comment">/* Current number of bytes in</span></span><br><span class="line"><span class="comment">                                                queue (nonstandard) */</span></span><br><span class="line">    <span class="type">msgqnum_t</span>       msg_qnum;     <span class="comment">/* Current number of messages</span></span><br><span class="line"><span class="comment">                                                in queue */</span></span><br><span class="line">    <span class="type">msglen_t</span>        msg_qbytes;   <span class="comment">/* Maximum number of bytes</span></span><br><span class="line"><span class="comment">                                                allowed in queue */</span></span><br><span class="line">    <span class="type">pid_t</span>           msg_lspid;    <span class="comment">/* PID of last msgsnd(2) */</span></span><br><span class="line">    <span class="type">pid_t</span>           msg_lrpid;    <span class="comment">/* PID of last msgrcv(2) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®ƒä»¬çš„<strong>ç¬¬ä¸€ä¸ªæˆå‘˜</strong>éƒ½æ˜¯ä¸€ä¸ª<code>struct ipc_perm</code>ï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªä¿¡å·é‡çš„åŸºæœ¬ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> &#123;</span></span><br><span class="line">    <span class="type">key_t</span>          __key;    <span class="comment">/* Key supplied to shmget(2) */</span></span><br><span class="line">    <span class="type">uid_t</span>          uid;      <span class="comment">/* Effective UID of owner */</span></span><br><span class="line">    <span class="type">gid_t</span>          gid;      <span class="comment">/* Effective GID of owner */</span></span><br><span class="line">    <span class="type">uid_t</span>          cuid;     <span class="comment">/* Effective UID of creator */</span></span><br><span class="line">    <span class="type">gid_t</span>          cgid;     <span class="comment">/* Effective GID of creator */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> mode;     <span class="comment">/* Permissions + SHM_DEST and</span></span><br><span class="line"><span class="comment">                                           SHM_LOCKED flags */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> __seq;    <span class="comment">/* Sequence number */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è€Œå†…æ ¸ä¸­å¯¹<code>IPC</code>èµ„æºçš„ç®¡ç†ï¼Œæ˜¯é€šè¿‡ä¸€ä¸ª<strong>æ•°ç»„</strong>è¿›è¡Œçš„ã€‚æˆ‘ä»¬æ‰€è·å–çš„<code>shmid</code>ï¼Œå’Œæ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ï¼Œ<strong>éƒ½æ˜¯ä¸€ä¸ªæ•°ç»„çš„ä¸‹æ ‡</strong></p><p>å…¶ä¸­æˆ‘åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œä¾¿å‘ç°äº†ä¸€ç‚¹ï¼šæˆ‘ä»¬æ¯ä¸€æ¬¡è·å–çš„æ–°çš„å…±äº«å†…å­˜ï¼Œå®ƒçš„ç¼–å·éƒ½ä¼š<code>+1</code>ï¼Œè€Œä¸åƒæ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ï¼Œæä¾›ç¬¬ä¸€ä¸ªæ²¡æœ‰è¢«ä½¿ç”¨çš„ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_ids</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> in_use;<span class="comment">//è¯´æ˜å·²åˆ†é…çš„èµ„æºä¸ªæ•°</span></span><br><span class="line">    <span class="type">int</span> max_id;<span class="comment">//åœ¨ä½¿ç”¨çš„æœ€å¤§çš„ä½ç½®ç´¢å¼•</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> seq;<span class="comment">//ä¸‹ä¸€ä¸ªåˆ†é…çš„ä½ç½®åºåˆ—å·</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> seq_max;<span class="comment">//æœ€å¤§ä½ç½®ä½¿ç”¨åºåˆ—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sem</span>;</span> <span class="comment">//ä¿æŠ¤ ipc_idsçš„ä¿¡å·é‡</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_id_ary</span> <span class="title">nullentry</span>;</span><span class="comment">//å¦‚æœIPCèµ„æºæ— æ³•åˆå§‹åŒ–ï¼Œåˆ™entrieså­—æ®µæŒ‡å‘ä¼ªæ•°æ®ç»“æ„</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_id_ary</span>* <span class="title">entries</span>;</span><span class="comment">//æŒ‡å‘èµ„æºipc_id_aryæ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸ä¸­ï¼Œ<code>struct ipc_id_ary* entries</code>æ˜¯ä¸€ä¸ªæŒ‡å‘æ‰€æœ‰<code>ipc_perm</code>çš„<strong>æŒ‡é’ˆæ•°ç»„</strong>ã€‚å…¶èƒ½å¤Ÿé€šè¿‡è¯¥æ•°ç»„æ‰¾åˆ°æˆ‘ä»¬å¯¹äºidï¼ˆä¸‹æ ‡ï¼‰çš„èµ„æºï¼Œå¯¹å…¶è¿›è¡Œè®¿é—®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_id_ary</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">int</span> size;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kern_ipc_perm</span> *<span class="title">p</span>[0];</span><span class="comment">//æŒ‡é’ˆæ•°ç»„</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211131639022.png" alt="image-20221113163918931"></p><p>é‚£ä½ å¯èƒ½æƒ³é—®äº†ï¼Œè¿™é‡Œåªæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ å•Šï¼Ÿé‚£å¦‚æœæˆ‘æƒ³è®¿é—®<code>shmid_ds</code>ç»“æ„çš„å…¶ä»–æˆå‘˜ï¼Œå²‚ä¸æ˜¯æ²¡æœ‰åŠæ³•è®¿é—®äº†ï¼Ÿ</p><p>è¦æ˜¯è¿™ä¹ˆæƒ³ï¼Œå°±è¿˜æ˜¯å¤ªå¹´è½»äº†ğŸ˜‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(strcut shmid_ds*)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åªéœ€è¦å¯¹è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œå¼ºè½¬ï¼Œå°±èƒ½ç›´æ¥è®¿é—®å…¶ä»–æˆå‘˜ï¼</p><p>è¿™æ˜¯å› ä¸ºï¼š<font color="orange">Cè¯­è¨€ä¸­ï¼Œç»“æ„ä½“ç¬¬ä¸€ä¸ªå…ƒç´ çš„åœ°å€ï¼Œå’Œç»“æ„ä½“æ•´ä½“çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼</font></p><p>æŒ‡é’ˆçš„ç±»å‹ä¼šé™åˆ¶è¿™ä¸ªæŒ‡é’ˆè®¿é—®å…ƒç´ çš„èƒ½åŠ›ï¼Œåªè¦æˆ‘ä»¬è¿›è¡Œå¼ºè½¬ï¼Œå…¶å°±èƒ½ç›´æ¥è®¿é—®çˆ¶ç»“æ„ä½“çš„å…¶ä»–æˆå‘˜ï¼</p><blockquote><p>è¿™æ˜¯ä¸€ç§<strong>åˆ‡ç‰‡</strong>çš„æ€æƒ³</p></blockquote><p>ç”¨è¿™ç§åŠæ³•ï¼Œå¯ä»¥ç”¨ç»Ÿä¸€çš„è§„åˆ™åœ¨å†…æ ¸ä¸­ç®¡ç†ä¸åŒçš„<code>IPC</code>èµ„æºï¼Œæ²¡æœ‰å¿…è¦å†ä¸ºæ¯ä¸€ä¸ªIPCèµ„æºå»ºç«‹ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„æ¥ç®¡ç†ã€‚</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211031202438.gif" alt="QQå›¾ç‰‡20220419103136"></p><p>ä¸å¾—ä¸è¯´ï¼Œ<code>linus</code>å¤§ä½¬æ˜¯çœŸçš„ç‰›é€¼ï¼</p><hr><h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><p>å…³äºå…±äº«å†…å­˜çš„æ“ä½œåˆ°è¿™é‡Œå°±OVERäº†ï¼</p><p>æœ€åè¿˜äº†è§£äº†ä¸€äº›å†…æ ¸è®¾è®¡ä¸Šçš„å°å¦™æ‹›ï¼Œä¸å¾—ä¸è¯´ï¼ŒçœŸçš„ç‰›æ‰¹~</p><p><strong>å¦‚æœæœ¬æ–‡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºæå‡º</strong></p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202211031206219.png" alt="QQå›¾ç‰‡20220527185356"></p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">æœ¬æ–‡æ ‡é¢˜</span>ï¼š<span class="content">ã€Linuxã€‘è¿›ç¨‹é€šä¿¡ | å…±äº«å†…å­˜ | ä¿¡å·é‡</span></li><li class="post-author"><span class="type">æœ¬æ–‡ä½œè€…</span>ï¼š<span class="content">æ…•é›ªå¹´å</span></li><li class="post-time"><span class="type">åˆ›å»ºæ—¶é—´</span>ï¼š<span class="content">2022-11-13 10:40:16</span></li><li class="post-link"><span class="type">æœ¬æ–‡é“¾æ¥</span>ï¼š<span class="content">2022/11/13/note_Linux/17å…±äº«å†…å­˜_ä¿¡å·é‡/</span></li><li class="post-license"><span class="type">ç‰ˆæƒå£°æ˜</span>ï¼š<span class="content">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="å¤åˆ¶ç‰ˆæƒä¿¡æ¯" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E8%BF%9B%E7%A8%8B/">#è¿›ç¨‹</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2022/11/20/note_Linux/18%E4%BF%A1%E5%8F%B7/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">ã€Linuxã€‘è¿›ç¨‹é€šä¿¡ | ä¿¡å·</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2022/11/11/note_Linux/16%E7%AE%A1%E9%81%93/"><span class="title flex-center"><span class="post-nav-title-item">ã€Linuxã€‘è¿›ç¨‹é€šä¿¡ | ç®¡é“</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;è¯„è®º</div><div class="waline-comment-container"><link rel="stylesheet" href="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline.css"><link rel="stylesheet" href="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline-meta.css"><script data-pjax src="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline.js"></script><div id="waline-comment"></div><script data-pjax>function loadWaline() {
            Waline.init({
              el: '#waline-comment',
              serverURL: 'https://vrcl.outpost54.top/',
              lang: 'zh-CN' || 'zh-CN',
              comment: '.post-comments-count',
              reaction: 'false' === 'true'
            })
          }

          if ('true' === 'true') {
            setTimeout(() => {
              loadWaline()
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadWaline)
          }</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%95%A5%E6%98%AF%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%EF%BC%9F"><span class="nav-text">1.å•¥æ˜¯å…±äº«å†…å­˜ï¼Ÿ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3"><span class="nav-text">2.ç›¸å…³æ¥å£</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-ftok"><span class="nav-text">2.1 ftok</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-shmget"><span class="nav-text">2.2 shmget</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-shmat-x2F-shmdt"><span class="nav-text">2.3 shmat&#x2F;shmdt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-shmctl"><span class="nav-text">2.4 shmctl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-ipcs%E5%91%BD%E4%BB%A4"><span class="nav-text">2.5 ipcså‘½ä»¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-x2F-%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="nav-text">æ¶ˆæ¯é˜Ÿåˆ—&#x2F;ä¿¡å·é‡çš„æ¥å£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ipcrm"><span class="nav-text">ipcrm</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="nav-text">3.ä½¿ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%88%9B%E5%BB%BA%E5%B9%B6%E8%8E%B7%E5%8F%96"><span class="nav-text">3.1 åˆ›å»ºå¹¶è·å–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#File-exists"><span class="nav-text">File exists</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E6%9D%83%E9%99%90%E5%80%BC"><span class="nav-text">è®¾ç½®æƒé™å€¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%8C%82%E6%8E%A5-x2F-%E5%8F%96%E6%B6%88%E6%8C%82%E6%8E%A5"><span class="nav-text">3.2 æŒ‚æ¥&#x2F;å–æ¶ˆæŒ‚æ¥</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%B6%88-x2F-%E5%88%A0%E9%99%A4"><span class="nav-text">å–æ¶ˆ&#x2F;åˆ é™¤</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%86%99%E5%85%A5%E5%86%85%E5%AE%B9"><span class="nav-text">3.3 å†™å…¥å†…å®¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E6%B2%A1%E6%9C%89%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">å…±äº«å†…å­˜æ²¡æœ‰è®¿é—®æ§åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87%E7%AE%A1%E9%81%93%E8%BF%9B%E8%A1%8C%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9A%84%E6%8E%A7%E5%88%B6"><span class="nav-text">é€šè¿‡ç®¡é“è¿›è¡Œå…±äº«å†…å­˜çš„æ§åˆ¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="nav-text">è¿è¡Œç»“æœ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-text">4.ç›¸å…³æ¦‚å¿µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-0-%E4%B8%B4%E7%95%8C%E8%B5%84%E6%BA%90"><span class="nav-text">4.0 ä¸´ç•Œèµ„æº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">4.1 ä¿¡å·é‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="nav-text">åŸå­æ€§çš„è¯´æ˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9%E5%8F%98%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%80%BC"><span class="nav-text">æ”¹å˜ä¿¡å·é‡çš„å€¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E6%89%A9%E5%B1%95-mmap"><span class="nav-text">4.2 æ‰©å±• mmap</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-text">ç»“è¯­</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">æ…•é›ªå¹´å</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="timerun-info info-item"><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/16/2022 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="å‹‰å¼ºè¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" æ—¶ "+mnum+" åˆ† "+snum+" ç§’"}setInterval("createtime()",250)</script></div><div class="shields-info info-item"><a href="https://github.com/XPoet/hexo-theme-keep" target="_blank"><img src="https://img.shields.io/badge/hexo-keep%20v3.6.1-blue" height="20px"> </a><a href="https://www.travellings.cn/go.html" target="_blank"><img src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/travellingICON.gif" height="20px"> </a><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054%E5%8F%B7-ff69b4" height="20px"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank"><img src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/%E5%8F%88%E6%8B%8D%E4%BA%91_logo5.png" height="20px"></a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });</script><script type="text/javascript" src="/js/snow.js"></script></body></html>