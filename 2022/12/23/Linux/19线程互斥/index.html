<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="çˆ±æŠ˜è…¾çš„ä»£ç åˆå­¦è€…"><meta name="author" content="æ…•é›ªå¹´å"><meta name="baidu-site-verification" content="codeva-aZGKJiqRSI"><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"JwxEfuZ8fwQ1GPEq",ck:"JwxEfuZ8fwQ1GPEq"})</script><title>ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥ | æ…•é›ªçš„å¯’èˆ</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/myPNG.jpg"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.musnow.top","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/myPNG.jpg","favicon":"/images/myPNG.jpg","avatar":"/images/myPNG.jpg","font_size":null,"font_family":null,"hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":false,"background_img":"/images/MainBG.jpg","background_post_img":"/images/mothra.png","description":"å¾å¿ƒå¦‚ä¸€ï¼Œæ…•é›ªçº·çº·","font_color":null,"hitokoto":true},"scroll":{"progress_bar":true,"percent":true},"left_side_width":"260px","content_max_width":"920px"},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"waline","valine":{"appid":"meufCipLPHNWVE3gWEnozHzz-gzGzoHsz","appkey":"CFX9WelJjGHkaMnSunOlv3dX","server_urls":null,"placeholder":"æ¬¢è¿ç•™ä¸‹ä½ çš„å£°éŸ³ğŸ˜‹"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://waline.musnow.top/","reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":false},"img_align":"center","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="æ…•é›ªçš„å¯’èˆ" type="application/atom+xml"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/about/"><img src="/images/myPNG.jpg"> </a><a class="logo-title" href="/">æ…•é›ªçš„å¯’èˆ</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">é¦–é¡µ</a></li><li class="menu-item"><a href="/archives">å½’æ¡£</a></li><li class="menu-item"><a href="/categories">åˆ†ç±»</a></li><li class="menu-item"><a href="/tags">æ ‡ç­¾</a></li><li class="menu-item"><a href="/qa">ç•™è¨€</a></li><li class="menu-item"><a href="/links">å‹é“¾</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="/archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="/categories">åˆ†ç±»</a></li><li class="drawer-menu-item flex-center"><a href="/tags">æ ‡ç­¾</a></li><li class="drawer-menu-item flex-center"><a href="/qa">ç•™è¨€</a></li><li class="drawer-menu-item flex-center"><a href="/links">å‹é“¾</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥</span></div><div class="article-header"><div class="avatar"><img src="/images/myPNG.jpg"></div><div class="info"><div class="author"><span class="name">æ…•é›ªå¹´å</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-12-23 16:30:16</span> <span class="mobile">2022-12-23 16:30</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-03-11 19:25:36</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Linux/">Linux</a>&nbsp;</li><li>| <a href="/tags/%E7%BA%BF%E7%A8%8B/">çº¿ç¨‹</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>11.2k å­—</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>åƒå‘¼ä¸‡å”¤å§‹å‡ºæ¥ï¼Œç»ˆäºåˆ°å¤šçº¿ç¨‹æ–¹é¢çš„å­¦ä¹ äº†ï¼</p><span id="more"></span><blockquote><p>æ‰€ç”¨ç³»ç»Ÿ<code>Centos7.6</code> æœ¬æ–‡çš„æºç ğŸ‘‰<a class="link" target="_blank" rel="noopener" href="https://gitee.com/musnow/raspberry-practice/tree/master/code/22-12-15_pthread">ã€ä¼ é€é—¨ã€‘<i class="fas fa-external-link-alt"></i></a></p></blockquote><p>[TOC]</p><h1 id="1-çº¿ç¨‹çš„æ¦‚å¿µ"><a href="#1-çº¿ç¨‹çš„æ¦‚å¿µ" class="headerlink" title="1.çº¿ç¨‹çš„æ¦‚å¿µ"></a>1.çº¿ç¨‹çš„æ¦‚å¿µ</h1><p>åœ¨ä¹‹å‰çš„linuxå­¦ä¹ ä¸­ï¼Œå·²ç»æ¥è§¦è¿‡äº†è¿›ç¨‹çš„æ¦‚å¿µï¼Œè¿›ç¨‹ç”±ä¸€ä¸ª<code>task_struct</code>ç»“æ„ä½“åœ¨æ“ä½œç³»ç»Ÿä¸­è¿›è¡Œæè¿°ï¼ŒCPUåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šä¾ç…§è¿›ç¨‹æ—¶é—´ç‰‡è¿›è¡Œè½®è¯¢è°ƒåº¦ï¼Œè®©æ¯ä¸€ä¸ªè¿›ç¨‹çš„ä»£ç éƒ½å¾—ä»¥æ¨è¿›ï¼Œå®ç°å¤šä¸ªè¿›ç¨‹çš„åŒæ—¶è¿è¡Œ</p><p>è€Œçº¿ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ç§è½»é‡åŒ–çš„è¿›ç¨‹ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½å¯ä»¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œå¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¿›ç¨‹:çº¿ç¨‹ = 1:N</span><br></pre></td></tr></table></figure><p>åœ¨ä¹‹å‰çš„å¤šè¿›ç¨‹æ“ä½œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>fork</code>æ¥å£åˆ›å»ºå­è¿›ç¨‹ï¼Œé€šè¿‡<code>if/else</code>è¯­å¥åˆ¤æ–­ï¼Œå®ç°å¯¹ç‰¹å®šæ‰§è¡Œæµçš„åˆ’åˆ†</p><ul><li>åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œéœ€è¦æ‹·è´ä¸€ä»½<code>task_struct/mm_struct</code>å¹¶åˆ›å»ºé¡µè¡¨</li><li>å½“å­è¿›ç¨‹ä¿®æ”¹äº†ä¸€éƒ¨åˆ†å˜é‡ï¼Œä¼šå‘ç”Ÿ<strong>å†™æ—¶æ‹·è´</strong>ï¼Œä¿®æ”¹é¡µè¡¨åœ¨ç‰©ç†å†…å­˜ä¸Šçš„æ˜ å°„</li></ul><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦åšä¸å°‘çš„å·¥ä½œ</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212151917491.png" alt="image-20221215191721355"></p><h2 id="1-1-æ‰§è¡Œæµ"><a href="#1-1-æ‰§è¡Œæµ" class="headerlink" title="1.1 æ‰§è¡Œæµ"></a>1.1 æ‰§è¡Œæµ</h2><p>è®©æˆ‘ä»¬åº·åº·æ‰§è¡Œæµè¿™ä¸€æ¦‚å¿µï¼š</p><ul><li>å•æ‰§è¡Œæµè¿›ç¨‹ï¼šå†…éƒ¨åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµçš„è¿›ç¨‹</li><li>å¤šæ‰§è¡Œæµè¿›ç¨‹ï¼šå†…éƒ¨æœ‰å¤šä¸ªæ‰§è¡Œæµçš„è¿›ç¨‹</li></ul><p><code>è¿›ç¨‹=å†…æ ¸æ•°æ®ç»“æ„+ä»£ç å’Œæ•°æ®</code>ï¼Œåœ¨å†…æ ¸è§†è§’ä¸­ï¼Œè¿›ç¨‹æ˜¯<code>æ‰¿æ‹…åˆ†é…ç³»ç»Ÿèµ„æºçš„åŸºæœ¬å®ä½“</code>ï¼ˆè¿›ç¨‹çš„åŸºåº§å±æ€§ï¼‰</p><ul><li>è¿›ç¨‹ï¼šå‘ç³»ç»Ÿç”³è¯·èµ„æºçš„åŸºæœ¬å•ä½ï¼ˆç³»ç»Ÿåˆ†é…ï¼‰</li><li>çº¿ç¨‹ï¼šç³»ç»Ÿè°ƒåº¦çš„åŸºæœ¬å•ä½</li></ul><hr><h2 id="1-2-çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ"><a href="#1-2-çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ"></a>1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ</h2><p>é‚£çº¿ç¨‹çš„åˆ›å»ºéœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>ä¸åŒæ“ä½œç³»ç»Ÿçš„å®ç°ä¸åŒï¼Œä¸€èˆ¬ç”¨<code>tcb</code>æŒ‡ä»£æè¿°çº¿ç¨‹çš„ç»“æ„ä½“</p></blockquote><p>åœ¨linuxä¸­ï¼Œæ²¡æœ‰è¿›ç¨‹å’Œçº¿ç¨‹åœ¨æ¦‚å¿µä¸Šçš„åŒºåˆ†ï¼Œå…¶ä»¥<strong>æ‰§è¡Œæµ</strong>ä¸ºåŸºç¡€ï¼Œçº¿ç¨‹åªæ˜¯ç®€å•çš„å¯¹<code>task_strcut</code>è¿›è¡Œäº†äºŒæ¬¡å°è£…ï¼›çº¿ç¨‹æ˜¯åœ¨è¿›ç¨‹å†…éƒ¨è¿è¡Œçš„æ‰§è¡Œæµ</p><ul><li>è¯´äººè¯ï¼šlinuxä¸‹çš„çº¿ç¨‹æ˜¯<strong>ç”¨è¿›ç¨‹æ¨¡æ‹Ÿ</strong>çš„</li><li>æ¢å¥è¯ï¼šlinuxä¸‹çš„è¿›ç¨‹ä¹Ÿæ˜¯ä¸€ç§çº¿ç¨‹ï¼Œä½†æ˜¯å…¶<strong>åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµ</strong></li><li>å¯¹äºCPUè€Œè¨€ï¼Œå…¶çœ‹åˆ°çš„<code>task_struct</code>éƒ½æ˜¯ä¸€ä¸ªæ‰§è¡Œæµ</li></ul><p>è€Œåˆ›å»ºçº¿ç¨‹æ—¶ä¹Ÿæœ‰è¯´æ³•ï¼Œçº¿ç¨‹éš¶å±äºæŸä¸€ä¸ªè¿›ç¨‹ä¸‹ï¼Œå¹¶ä¸æ˜¯ç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œæ‰€ä»¥ä¸éœ€è¦åˆ›å»ºæ–°çš„<code>mm_struct</code>å’Œé¡µè¡¨æ˜ å°„ï¼Œåˆ›å»ºçš„æ•ˆç‡é«˜äºå­è¿›ç¨‹ã€‚åªéœ€è¦å°†<code>task_struct</code>æŒ‡å‘åŸæœ‰è¿›ç¨‹çš„<code>mm_struct</code>å’Œé¡µè¡¨å³å¯ã€‚</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212151923818.png" alt="image-20221215192345757"></p><p>åŒæ ·çš„ï¼ŒCPUåœ¨æ¨è¡Œå¤šçº¿ç¨‹æ“ä½œçš„æ—¶å€™ï¼Œæ— é¡»æ‰§è¡Œpcbåˆ‡æ¢ï¼Œå°±èƒ½å®ç°<strong>å•è¿›ç¨‹å¤šä¸ªçº¿ç¨‹æ“ä½œ</strong>çš„åŒæ—¶è¿›è¡Œï¼Œæ‰§è¡Œæ•ˆç‡å˜é«˜ï¼</p><blockquote><p>çº¿ç¨‹æ˜¯ä¸€ç§<code>Light weight process è½»é‡çº§è¿›ç¨‹</code>ï¼Œç®€ç§°<code>LWP</code></p></blockquote><h2 id="1-3-å†…æ ¸æºç ä¸­çš„ä½“ç°"><a href="#1-3-å†…æ ¸æºç ä¸­çš„ä½“ç°" class="headerlink" title="1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°"></a>1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°</h2><p>åœ¨<code>task_strcut</code>ç»“æ„ä½“ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªå­—æ®µ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* CPU-specific state of this task */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> <span class="title">thread</span>;</span></span><br></pre></td></tr></table></figure><p>è½¬åˆ°å®šä¹‰ï¼Œå…¶å†…éƒ¨éƒ½æ˜¯ä¸€äº›<strong>å¯„å­˜å™¨</strong>ä¿¡æ¯ï¼Œç”¨äºæ ‡è¯†è¿™ä¸ªçº¿ç¨‹çš„åŸºæœ¬ä¿¡æ¯ã€‚è¿™ä¹Ÿæ˜¯linuxä¸­æ²¡æœ‰<strong>å•ç‹¬</strong>å®ç°çº¿ç¨‹tcbçš„ä½“ç°ï¼Œè€Œæ˜¯ç”¨<code>task_struct</code>æ¥æ¨¡æ‹Ÿçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Cached TLS descriptors: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	<span class="title">tls_array</span>[<span class="title">GDT_ENTRY_TLS_ENTRIES</span>];</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sp0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		sysenter_cs;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		usersp;	<span class="comment">/* Copy from PDA */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		es;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		ds;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		fsindex;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span>		gsindex;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		ip;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_64</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		fs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		gs;</span><br><span class="line">	<span class="comment">/* Hardware debugging registers: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg3;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg6;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		debugreg7;</span><br><span class="line">	<span class="comment">/* Fault info: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		cr2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		trap_no;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		error_code;</span><br><span class="line">	<span class="comment">/* floating point and extended processor state */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> <span class="title">thread_xstate</span>	*<span class="title">xstate</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	<span class="comment">/* Virtual 86 mode info */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm86_struct</span> __<span class="title">user</span> *<span class="title">vm86_info</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		screen_bitmap;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		v86flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		v86mask;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		saved_sp0;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		saved_fs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		saved_gs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* IO permissions: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		*io_bitmap_ptr;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		iopl;</span><br><span class="line">	<span class="comment">/* Max allowed port in the bitmap, in bytes: */</span></span><br><span class="line">	<span class="type">unsigned</span>		io_bitmap_max;</span><br><span class="line"><span class="comment">/* MSR_IA32_DEBUGCTLMSR value to switch in if TIF_DEBUGCTLMSR is set.  */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>	debugctlmsr;</span><br><span class="line">	<span class="comment">/* Debug Store context; see asm/ds.h */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ds_context</span>	*<span class="title">ds_ctx</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="1-4-çº¿ç¨‹çš„ç§æœ‰ç‰©"><a href="#1-4-çº¿ç¨‹çš„ç§æœ‰ç‰©" class="headerlink" title="1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©"></a>1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªè¿›ç¨‹æ˜¯å®Œå…¨ç‹¬ç«‹çš„ã€‚ä½†æ˜¯çº¿ç¨‹å¹¶ä¸æ˜¯ï¼Œå› ä¸ºçº¿ç¨‹åªæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªæ‰§è¡Œæµåˆ†æ”¯ï¼Œå®ƒä»è¿›ç¨‹ç»§æ‰¿äº†ç»å¤§éƒ¨åˆ†å±æ€§ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºæ˜¯å…±äº«çš„ï¼‰</p><ul><li>ç”¨æˆ·idå’Œç»„id</li><li>è¿›ç¨‹id</li><li>è¿›ç¨‹å·¥ä½œç›®å½•</li><li>æ–‡ä»¶æè¿°ç¬¦è¡¨</li><li>ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼ˆå¦‚æœè¿›ç¨‹æœ‰å¯¹æŸä¸ªä¿¡å·è¿›è¡Œè‡ªå®šä¹‰æ•æ‰ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¼šå…±ç”¨è¿™ä¸ªè‡ªå®šä¹‰æ•æ‰ï¼‰</li><li>å’Œè¿›ç¨‹å…±ç”¨ä¸€ä¸ªå †</li></ul><p>ä½†çº¿ç¨‹ä¹Ÿä¼šæœ‰è‡ªå·±çš„<strong>ç§æœ‰ç‰©</strong>ï¼</p><ul><li>çº¿ç¨‹id</li><li>çº¿ç¨‹ç‹¬ç«‹çš„å¯„å­˜å™¨ï¼ˆå› ä¸ºçº¿ç¨‹ä¹Ÿéœ€è¦æ‰§è¡Œä»£ç ï¼Œæœ‰ä¸Šä¸‹æ–‡æ•°æ®ï¼‰</li><li>æ ˆï¼ˆçº¿ç¨‹è¿è¡Œå‡½æ•°æ—¶ä¹Ÿéœ€è¦å‹æ ˆå’Œå‡ºæ ˆï¼Œå¿…é¡»ç‹¬ç«‹å¦åˆ™æ‰§è¡Œæµä¼šå‡ºé—®é¢˜ï¼‰</li><li>errnoï¼ˆå•ç‹¬çš„æŠ¥é”™ä¿¡æ¯ï¼‰</li><li>ä¿¡å·å±è”½å­—ï¼ˆå¯ä»¥å•ç‹¬é’ˆå¯¹æŸä¸ªä¿¡å·å¤„ç†ï¼‰</li><li>çº¿ç¨‹è°ƒåº¦ä¼˜å…ˆçº§</li></ul><h2 id="1-5-çº¿ç¨‹ä¼˜ç¼ºç‚¹"><a href="#1-5-çº¿ç¨‹ä¼˜ç¼ºç‚¹" class="headerlink" title="1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹"></a>1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹</h2><h3 id="1-5-1-ç¼ºç‚¹"><a href="#1-5-1-ç¼ºç‚¹" class="headerlink" title="1.5.1 ç¼ºç‚¹"></a>1.5.1 ç¼ºç‚¹</h3><ul><li><p>çº¿ç¨‹æ˜¯ç¼ºä¹ä¿æŠ¤çš„ï¼ˆä¸å…·å¤‡è¿›ç¨‹çš„<strong>ç‹¬ç«‹æ€§</strong>ï¼‰è¿™ä¹Ÿè¢«ç§°ä¸º<code>å¥å£®æ€§</code>ï¼›çº¿ç¨‹çš„å¥å£®æ€§ä½</p><ul><li>å½“è¿›ç¨‹è¢«åœæ­¢çš„æ—¶å€™ï¼Œå…¶ä¸‹çº¿ç¨‹ä¹Ÿä¼šè¢«åœæ­¢</li><li>å½“æœ‰ä¸€ä¸ªçº¿ç¨‹å‡ºbugäº†ï¼Œä¼šè®©æ•´ä¸ªè¿›ç¨‹é€€å‡º</li><li>å¤šçº¿ç¨‹ä¸­çš„å…¨å±€å˜é‡é—®é¢˜</li></ul></li><li><p>çº¿ç¨‹ç¼ºä¹è®¿é—®æ§åˆ¶ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨æŸäº›æ“ä½œç³»ç»Ÿçš„æ¥å£ä¼šå½±å“æ•´ä¸ªè¿›ç¨‹</p></li><li><p>debugå¤šçº¿ç¨‹è¾ƒéº»çƒ¦</p></li><li><p>å¦‚æœåŒä¸€ä¸ªè¿›ç¨‹æ‰€ç”¨çº¿ç¨‹å¤ªå¤šï¼Œå¯èƒ½ä¼šæ— æ³•å……åˆ†åˆ©ç”¨cpuæ€§èƒ½è€Œé€ æˆæ€§èƒ½æŸå¤±</p></li></ul><h3 id="1-5-2-ä¼˜ç‚¹"><a href="#1-5-2-ä¼˜ç‚¹" class="headerlink" title="1.5.2 ä¼˜ç‚¹"></a>1.5.2 ä¼˜ç‚¹</h3><ul><li>å¼€è¾Ÿçš„æ¶ˆè€—ä½äºè¿›ç¨‹ï¼Œå ç”¨çš„èµ„æºä½äºè¿›ç¨‹</li><li>åˆ‡æ¢çº¿ç¨‹æ— é¡»åˆ‡æ¢é¡µè¡¨ç­‰ç»“æ„ï¼Œé€Ÿåº¦å¿«</li><li>ç­‰å¾…æ…¢IOè®¾å¤‡æ—¶ï¼Œè¿›ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–æ“ä½œï¼›å°†éƒ¨åˆ†IOæ“ä½œé‡å ï¼Œèƒ½è®©è¿›ç¨‹åŒæ—¶ç­‰å¾…å¤šä¸ªIOæ“ä½œ</li><li>èƒ½å……åˆ†åˆ©ç”¨å¤„ç†å™¨çš„<strong>å¯å¹¶è¡Œæ•°é‡</strong></li></ul><hr><h1 id="2-åŸºç¡€å‡½æ•°"><a href="#2-åŸºç¡€å‡½æ•°" class="headerlink" title="2.åŸºç¡€å‡½æ•°"></a>2.åŸºç¡€å‡½æ•°</h1><p>linuxä¸‹æä¾›äº†<code>pthread</code>åº“æ¥å®ç°çº¿ç¨‹æ“ä½œ</p><h2 id="2-1-pthread-create"><a href="#2-1-pthread-create" class="headerlink" title="2.1 pthread_create"></a>2.1 pthread_create</h2><p>äººå¦‚å…¶åï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ¥åˆ›å»ºæ–°è¿›ç¨‹çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *thread, <span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *(*start_routine) (<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª<strong>è¾“å‡ºå‹å‚æ•°</strong>ï¼Œä¸ºè¯¥çº¿ç¨‹çš„id</li><li>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç”¨äºæŒ‡å®šçº¿ç¨‹çš„å±æ€§ï¼Œæš‚æ—¶è®¾ç½®ä¸º<code>NULL</code>ä½¿ç”¨é»˜è®¤å±æ€§</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯è®©è¯¥è¿›ç¨‹æ‰§è¡Œçš„å‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½ä¸º<code>void*</code></li><li>ç¬¬å››ä¸ªå‚æ•°æ˜¯<strong>ä¼ ç»™ç¬¬ä¸‰ä¸ªæ‰§è¡Œå‡½æ•°çš„å‚æ•°</strong></li></ul><p>åˆ›å»ºæ­£å¸¸åè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç </p><p>æ³¨æ„ï¼Œä½¿ç”¨äº†pthreadåº“åï¼Œéœ€è¦åœ¨ç¼–è¯‘çš„æ—¶å€™æŒ‡å®šé“¾æ¥ï¼Œ<code>-lpthread</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">pthread_t</span>;<span class="comment">//çº¿ç¨‹id</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºçº¿ç¨‹åæ‰“å°å¯ä»¥å‘ç°ï¼Œçº¿ç¨‹idæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå¹¶ä¸åƒè¿›ç¨‹PIDé‚£ä¹ˆå°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//cout &lt;&lt; &quot;pthread_create &quot;&lt;&lt; t1 &lt;&lt; &quot; &quot; &lt;&lt; t2 &lt;&lt; endl;</span></span><br><span class="line">pthread_create <span class="number">140689524995840</span> <span class="number">140689516603136</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡<code>printf %x</code>çš„æ–¹å¼æ¥å‡å°‘æ‰“å°é•¿åº¦</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//printf(&quot;0x%x  0x%x\n&quot;,t1,t2);</span></span><br><span class="line"><span class="number">0x393d0700</span>  <span class="number">0x38bcf700</span></span><br></pre></td></tr></table></figure><h2 id="2-2-pthread-join"><a href="#2-2-pthread-join" class="headerlink" title="2.2 pthread_join"></a>2.2 pthread_join</h2><p>å…‰æ˜¯åˆ›å»ºè¿›ç¨‹è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿›ç¨‹<strong>è¿›è¡Œç­‰å¾…</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯çº¿ç¨‹çš„idï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€</p><p>ç­‰å¾…æˆåŠŸåè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ç </p><ul><li>joinå¯ä»¥åœ¨çº¿ç¨‹é€€å‡ºåï¼Œé‡Šæ”¾çº¿ç¨‹çš„èµ„æº</li><li>åŒæ—¶è·å–çº¿ç¨‹å¯¹åº”çš„é€€å‡ºç </li><li>joinè¿˜èƒ½ä¿è¯æ˜¯æ–°åˆ›å»ºçš„çº¿ç¨‹é€€å‡ºåï¼Œä¸»çº¿ç¨‹æ‰é€€å‡º</li></ul><h3 id="2-2-1-åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ"><a href="#2-2-1-åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ" class="headerlink" title="2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ"></a>2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ</h3><p>æœ‰äº†è¿™ä¸¤ä¸ªï¼Œæˆ‘ä»¬å°±èƒ½å†™ä¸€ä¸ªç®€å•çš„å¤šçº¿ç¨‹æ“ä½œäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main::&quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¼šå‘ç°ï¼Œå¤šçº¿ç¨‹æ“ä½œæˆåŠŸå¯åŠ¨ï¼Œä¸”æ‰“å°çš„è¿›ç¨‹pidéƒ½æ˜¯ä¸€æ ·çš„ï¼Œ<strong>ä»£è¡¨å…¶éš¶å±äºåŒä¸€ä¸ªè¿›ç¨‹</strong></p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212152032424.png" alt="image-20221215203210372"></p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„è¯­å¥æ¥æŸ¥çœ‹è½»é‡çº§è¿›ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -aL</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ‰§è¡Œäº†ç¨‹åºä¹‹åï¼Œå‡ºç°äº†3ä¸ª<code>PID</code>ç›¸åŒï¼Œ<code>LWP</code>ä¸åŒçš„è½»é‡çº§è¿›ç¨‹ï¼Œè¿™å°±ä»£è¡¨æˆ‘ä»¬çš„å¤šçº¿ç¨‹æ“ä½œæˆåŠŸäº†ï¼›</p><p>åŒæ—¶ä¹Ÿèƒ½çœ‹åˆ°ï¼Œåœ¨å¤šçº¿ç¨‹æ“ä½œæ—¶ï¼Œè°å…ˆè¿è¡Œæ˜¯ä¸ç¡®å®šçš„ã€‚è¿™æ˜¯ç”±ç³»ç»Ÿè°ƒåº¦éšæœºå†³å®šçš„</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212152033288.png" alt="image-20221215203326193"></p><h3 id="2-2-2-C-çš„å¤šçº¿ç¨‹æ“ä½œ"><a href="#2-2-2-C-çš„å¤šçº¿ç¨‹æ“ä½œ" class="headerlink" title="2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ"></a>2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ</h3><p>C++11ä¹Ÿæ”¯æŒäº†å¤šçº¿ç¨‹æ“ä½œï¼Œå…¶å°è£…äº†æ“ä½œç³»ç»Ÿçš„pthreadæ¥å£ï¼ŒåŸºæœ¬çš„æ“ä½œå¾ˆç›¸ä¼¼</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(func1,(<span class="type">char</span>*)<span class="string">&quot;test1&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(func2,(<span class="type">char</span>*)<span class="string">&quot;test2&quot;</span>)</span></span>;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåçš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒC++çš„threadåº“è¿˜å¯ä»¥ä¼ å…¥<code>functional</code>å°è£…çš„å¯è°ƒç”¨å‡½æ•°ï¼Œå’Œ<code>lambda</code>è¡¨è¾¾å¼</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212152054822.png" alt="image-20221215205453606"></p><h2 id="2-3-çº¿ç¨‹é€€å‡º"><a href="#2-3-çº¿ç¨‹é€€å‡º" class="headerlink" title="2.3 çº¿ç¨‹é€€å‡º"></a>2.3 çº¿ç¨‹é€€å‡º</h2><h3 id="2-3-1-retval"><a href="#2-3-1-retval" class="headerlink" title="2.3.1 retval"></a>2.3.1 retval</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ¥è·å–çº¿ç¨‹æ‰€æ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼ã€‚<code>retval</code>æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œæ˜¯ä¸€ä¸ª<strong>è¾“å‡ºå‹å‚æ•°</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func1 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1;</span><br><span class="line">    <span class="type">void</span>* r2;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="built_in">test3</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹é€€å‡ºä¹‹åï¼Œä¸»å‡½æ•°ä¸­æˆåŠŸæ‰“å°å‡ºäº†ä»–ä»¬çš„è¿”å›å€¼</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212161842059.png" alt="image-20221216184220924"></p><p>æ³¨æ„ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯å°†<code>void*</code>çš„æŒ‡é’ˆå¼ºè½¬ä¸ºintï¼Œå¦‚æœåœ¨æ‰“å°çš„æ—¶å€™å¼ºè½¬ä¸º<code>int</code>ï¼Œä¼šå‡ºç°<strong>ç²¾åº¦ä¸¢å¤±</strong>çš„æŠ¥é”™ï¼Œéœ€è¦ä½¿ç”¨<code>long long</code>æ¥è§„é¿æŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ make</span><br><span class="line">g++ test.cpp -o test -lpthread -std=c++11</span><br><span class="line">.test.cpp: In function â€˜void test3()â€™:</span><br><span class="line">test.cpp:88:35: error: cast from â€˜void*â€™ to â€˜intâ€™ loses precision [-fpermissive]</span><br><span class="line">     cout &lt;&lt; &quot;retval 1 : &quot; &lt;&lt; (int)r1 &lt;&lt; endl;</span><br><span class="line">                                   ^</span><br><span class="line">make: *** [test] Error 1</span><br></pre></td></tr></table></figure><h3 id="2-3-2-pthread-exit"><a href="#2-3-2-pthread-exit" class="headerlink" title="2.3.2 pthread_exit"></a>2.3.2 pthread_exit</h3><p>é™¤äº†ç›´æ¥returnï¼Œçº¿ç¨‹è¿˜å¯ä»¥è°ƒç”¨<code>pthread_exit</code>å‡½æ•°å®ç°é€€å‡º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_exit</span><span class="params">(<span class="type">void</span> *retval)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœå®Œå…¨ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//return (void*)10;</span></span><br><span class="line">pthread_exit((<span class="type">void</span>*)<span class="number">10</span>);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œä¸»çº¿ç¨‹mainä¸­è°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶ä¸ä¼šå¯¼è‡´è¿›ç¨‹é€€å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot; tid: &quot;</span> &lt;&lt; <span class="built_in">syscall</span>(SYS_gettid) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">pthread_exit</span>((<span class="type">void</span>*)<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">	<span class="comment">//func2ä¼šæ‰§è¡Œ10s</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="built_in">test5</span>();</span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="number">0</span>);<span class="comment">//ä¸»çº¿ç¨‹æå‰é€€å‡º</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main exit&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸»å‡½æ•°å·²ç»è°ƒç”¨äº†<code>pthread_exit</code>é€€å‡ºäº†ï¼Œä½†æ˜¯çº¿ç¨‹è¿˜åœ¨è·‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br><span class="line">main exit</span><br><span class="line">func2 thread:: 1 :: 9474 tid: 9475</span><br><span class="line">func2 thread:: 2 :: 9474 tid: 9476</span><br></pre></td></tr></table></figure><h3 id="2-3-3-ptrhead-cancel"><a href="#2-3-3-ptrhead-cancel" class="headerlink" title="2.3.3 ptrhead_cancel"></a>2.3.3 ptrhead_cancel</h3><p>é™¤äº†ä¸Šé¢ä¿©ç§æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨mainé‡Œé¢ç›´æ¥æŠŠæŸä¸€ä¸ªçº¿ç¨‹ç»™å…³æ‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main:: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>()&lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(a==<span class="number">11</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cancel</span>(t1);</span><br><span class="line">            <span class="built_in">pthread_cancel</span>(t2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span>* r1;</span><br><span class="line">    <span class="type">void</span>* r2;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«æå‰ç»ˆæ­¢çš„è¿›ç¨‹ï¼Œè¿”å›å€¼éƒ½ä¸º-1</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212161903290.png" alt="image-20221216190338205"></p><h3 id="2-3-4-ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ"><a href="#2-3-4-ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ" class="headerlink" title="2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ"></a>2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ</h3><p>è¦ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯éœ€è¦æ·±çŸ¥ä¸€ä¸ªæ¦‚å¿µï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œæµï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ã€‚</p><p>å…ˆæ¥å›é¡¾ä¸€ä¸‹è¿›ç¨‹é€€å‡ºçš„å‡ ç§æƒ…å†µï¼š</p><ul><li>ä»£ç è·‘å®Œï¼Œç»“æœæ­£ç¡®</li><li>ä»£ç è·‘å®Œï¼Œç»“æœæœ‰é—®é¢˜</li><li>ä»£ç å‡ºé”™äº†ï¼Œå¼‚å¸¸</li></ul><p>çº¿ç¨‹é€€å‡ºçš„æƒ…å†µä¹Ÿæ˜¯è¿™æ ·ï¼Œä½†çº¿ç¨‹å¦‚æœå› ä¸ºæŸäº›å¼‚å¸¸é€€å‡ºï¼Œ<strong>è¿›ç¨‹ä¹Ÿä¼šåŒæ­¥é€€å‡º</strong>ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">this is main:: 13845</span><br><span class="line">Floating point exception</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯è§ï¼Œ<code>çº¿ç¨‹å¼‚å¸¸ = è¿›ç¨‹å¼‚å¸¸</code></p><p>è¿™é‡Œä¹Ÿå°±æ¶‰åŠåˆ°<code>1.5.1</code>ä¸­æåˆ°çš„çº¿ç¨‹<strong>å¥å£®æ€§</strong>é—®é¢˜ï¼Œçº¿ç¨‹çš„å¼‚å¸¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œï¼Œä¼šå¯¼è‡´è¿›ç¨‹æ•´ä½“å¼‚å¸¸é€€å‡ºã€‚</p><p>æ‰€ä»¥åœ¨<code>join</code>ç­‰å¾…çº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦è€ƒè™‘çº¿ç¨‹æ­£å¸¸é€€å‡ºçš„æƒ…å†µï¼›</p><blockquote><p>å¼‚å¸¸é€€å‡ºçš„æ—¶å€™ææ€•ä¹Ÿç­‰ä¸äº†ğŸ˜‚å› ä¸ºè¿›ç¨‹ä¹ŸæŒ‚äº†</p></blockquote><h2 id="2-3-5-exit"><a href="#2-3-5-exit" class="headerlink" title="2.3.5 exit"></a>2.3.5 exit</h2><p>ä»»ä½•ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ<code>exit()</code>å‡½æ•°ï¼Œéƒ½ä¼šå¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡º</p><hr><h2 id="2-4-pthread-detach"><a href="#2-4-pthread-detach" class="headerlink" title="2.4 pthread_detach"></a>2.4 pthread_detach</h2><p>ç­‰å¾…æ˜¯æœ‰æ€§èƒ½æŸå¤±çš„ï¼é»˜è®¤åˆ›å»ºçš„è¿›ç¨‹æ˜¯<code>joinable</code>ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¢«ä¸»çº¿ç¨‹è¿›è¡Œ<code>pthread_join</code>ç­‰å¾…çš„ï¼›</p><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è®©ä¸»çº¿ç¨‹ä¸ç®¡åˆ›å»ºå‡ºæ¥çš„å­çº¿ç¨‹ï¼Œä¹Ÿä¸ç”¨å»ç­‰å¾…å®ƒï¼Œç›¸å½“äºå–æ¶ˆäº†å®ƒçš„<code>joinable</code>å±æ€§ï¼›</p><p>å°±å¥½æ¯”çˆ¶è¿›ç¨‹ä¸æƒ³ç®¡å­è¿›ç¨‹çš„æ—¶å€™ï¼Œå°†<code>SIGCHLD</code>è®¾ç½®ä¸º<code>SIG_IGN</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br><span class="line"><span class="comment">//Compile and link with -pthread.</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦åº”è¯¥ç­‰å¾…ï¼Œå–å†³äºæ˜¯å¦éœ€è¦è·å–è¯¥çº¿ç¨‹çš„è¿”å›å€¼ï¼›å¦‚æœæ— é¡»è·å–è¿”å›å€¼ï¼Œåˆ™ä½¿ç”¨åˆ†ç¦»èƒ½æé«˜è¿è¡Œæ•ˆç‡</p><blockquote><p>å³ä¾¿çº¿ç¨‹æ‰€è¿è¡Œçš„å‡½æ•°returnæ˜¯æ— æ•ˆçš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥ç”¨è¾“å‡ºå‹å‚æ•°æ¥è·å–è¿”å›å€¼</p></blockquote><h3 id="2-4-1-å®æ“"><a href="#2-4-1-å®æ“" class="headerlink" title="2.4.1 å®æ“"></a>2.4.1 å®æ“</h3><p>ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦æŒ‡å®šçº¿ç¨‹çš„idå°±è¡Œäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬å·²æ— æ³•è·å–åˆ°è¯¥çº¿ç¨‹çš„è¿”å›å€¼</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181127252.png" alt="image-20221218112720052"></p><hr><h3 id="2-4-2-detachåjoin"><a href="#2-4-2-detachåjoin" class="headerlink" title="2.4.2 detachåjoin"></a>2.4.2 detachåjoin</h3><p>ä½†å¦‚æœæˆ‘ä»¬åœ¨detachä¹‹ååˆè¿›è¡Œ<code>pthread_join</code>ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func3</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_detach</span>(<span class="built_in">pthread_self</span>());</span><br><span class="line">    <span class="type">int</span> a = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;func thread:%s - global:%d - &amp;global:%p\n&quot;</span>,(<span class="type">char</span>*)arg,global,&amp;global);</span><br><span class="line">        global++;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">void</span>* r2=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¶ï¼Œè¿™ä¸è¿˜æ˜¯è·å–åˆ°äº†è¿”å›å€¼å—ï¼Ÿè¿™ä¹ˆè¯´ï¼Œä»–è¿™ä¸ª<code>detach</code>å²‚ä¸æ˜¯æ²¡ç”¨ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func thread:1 - global:103 - &amp;global:0x7fb5648b06fc</span><br><span class="line">func thread:2 - global:103 - &amp;global:0x7fb5640af6fc</span><br><span class="line">func thread:1 - global:104 - &amp;global:0x7fb5648b06fc</span><br><span class="line">func thread:2 - global:104 - &amp;global:0x7fb5640af6fc</span><br><span class="line">func exit</span><br><span class="line">func exit</span><br><span class="line">retval 1 : 10</span><br><span class="line">retval 2 : 10</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬createä¸€ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œå®ƒä¼šå…ˆå»æ‰§è¡Œçº¿ç¨‹åˆ›å»ºçš„ç›¸å…³ä»£ç ï¼Œæ­¤æ—¶mainåˆç›´æ¥å»æ‰§è¡Œåé¢çš„ä»£ç äº†ï¼›æ­¤æ—¶<code>pthread_join</code>çš„è°ƒç”¨æ˜¯æˆåŠŸçš„ï¼Œå› ä¸ºçº¿ç¨‹è‡ªå·±çš„<code>detach</code>ä»£ç <strong>è¿˜æ²¡æœ‰è¢«æ‰§è¡Œ</strong>ï¼</p><hr><p>è€Œå¦‚æœæˆ‘ä»¬åœ¨createä¹‹åï¼Œç­‰çº¿ç¨‹å¼€å§‹è¿è¡Œäº†åœ¨æ‰§è¡Œ<code>detach</code>ï¼Œæ­¤æ—¶joinå°±ä¼šå¤±è´¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* r1=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">void</span>* r2=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">pthread_join</span>(t1,&amp;r1);</span><br><span class="line">    cout &lt;&lt; ret &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">strerror</span>(ret) &lt;&lt; endl;</span><br><span class="line">    ret = <span class="built_in">pthread_join</span>(t2,&amp;r2);</span><br><span class="line">    cout &lt;&lt; ret &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; <span class="built_in">strerror</span>(ret) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 1 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r1 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;retval 2 : &quot;</span> &lt;&lt; (<span class="type">long</span> <span class="type">long</span>)r2 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å°é”™è¯¯ç ä¹Ÿèƒ½çœ‹åˆ°ï¼Œç³»ç»Ÿæç¤ºæˆ‘ä»¬ç»™<code>join</code>ä¼ å…¥äº†ä¸€ä¸ªæ— æ•ˆçš„å‚æ•°ï¼Œçº¿ç¨‹ä¾æ—§åœ¨æ­£å¸¸è¿è¡Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt<span class="number">-7274</span>:~/git/linux/code/<span class="number">22</span><span class="number">-12</span><span class="number">-15</span>_pthread]$ ./test</span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">101</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">101</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">102</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">102</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br><span class="line"><span class="number">22</span>:Invalid argument</span><br><span class="line"><span class="number">22</span>:Invalid argument</span><br><span class="line">retval <span class="number">1</span> : <span class="number">0</span></span><br><span class="line">retval <span class="number">2</span> : <span class="number">0</span></span><br><span class="line">func thread:<span class="number">2</span> - global:<span class="number">103</span> - &amp;global:<span class="number">0x7f2d431126fc</span></span><br><span class="line">func thread:<span class="number">1</span> - global:<span class="number">103</span> - &amp;global:<span class="number">0x7f2d439136fc</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æ­£ç¡®çš„åšæ³•ï¼Œ<strong>åº”è¯¥æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»çº¿ç¨‹</strong>ï¼Œä¸è¦åœ¨çº¿ç¨‹è‡ªå·±çš„ä»£ç ä¸­æ‰§è¡Œdetachï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸Šé¢çš„åˆ†ç¦»å¤±è´¥çš„æƒ…å†µ</p><h3 id="2-4-3-çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º"><a href="#2-4-3-çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º" class="headerlink" title="2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º"></a>2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º</h3><p>å¦‚æœæ‰§è¡Œå®Œæ¯•<code>pthread_detach</code>åï¼Œä¸»çº¿ç¨‹æå‰é€€å‡ºäº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¾è€Œæ˜“è§ï¼Œçº¿ç¨‹ä¹Ÿè·Ÿç€ä¸€å¹¶é€€å‡ºäº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ ./test</span><br><span class="line">func thread:1 - global:100 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">func thread:2 - global:100 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:2 - global:101 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:1 - global:101 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">func thread:2 - global:102 - &amp;global:0x7f01ccc996fc</span><br><span class="line">func thread:1 - global:102 - &amp;global:0x7f01cd49a6fc</span><br><span class="line">main exit</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-15_pthread]$ </span><br></pre></td></tr></table></figure><p>å› ä¸ºçº¿ç¨‹<strong>æ²¡æœ‰ç‹¬ç«‹æ€§</strong>ï¼Œå®Œå…¨å±äºè¿™ä¸ªè¿›ç¨‹ã€‚ä¸å¯èƒ½å‡ºç°ä½ å®¶æˆ¿å­å¡Œäº†ï¼Œä½ è‡ªå·±çš„æˆ¿é—´è¿˜åœ¨çš„æƒ…å†µğŸ˜‚</p><blockquote><p>è¿›ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå°±å›æ”¶äº†è¿™ä¸ªè¿›ç¨‹çš„ç¨‹åºåœ°å€ç©ºé—´ï¼Œè¿èµ„æºéƒ½è¢«é‡Šæ”¾äº†ï¼Œçº¿ç¨‹å°±æ²¡æœ‰åŠæ³•ç»§ç»­è¿è¡Œï¼Œè‡ªç„¶å°±é€€å‡ºäº†ã€‚</p></blockquote><p>æ‰€ä»¥ï¼Œä¸ºäº†é¿å…è¿™ç§é—®é¢˜ï¼Œä¸€èˆ¬æˆ‘ä»¬åˆ†ç¦»çº¿ç¨‹çš„æ—¶å€™ï¼Œéƒ½å€¾å‘äºè®©ä¸»çº¿ç¨‹ä¿æŒåœ¨åå°è¿è¡Œï¼ˆå¸¸é©»å†…å­˜çš„ç¨‹åºï¼‰</p><h2 id="2-5-gettid-x2F-syscall"><a href="#2-5-gettid-x2F-syscall" class="headerlink" title="2.5 gettid&#x2F;syscall"></a>2.5 gettid&#x2F;syscall</h2><p>è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªç³»ç»Ÿæ¥å£ï¼Œ<strong>ä½†å®ƒå¹¶ä¸èƒ½ç›´æ¥è¿è¡Œ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NAME</span><br><span class="line">       gettid - get thread identification</span><br><span class="line">SYNOPSIS</span><br><span class="line">       #include &lt;sys/types.h&gt;</span><br><span class="line">       pid_t gettid(void);</span><br><span class="line"></span><br><span class="line">       Note:  There  is  no  glibc wrapper for this system call; see</span><br><span class="line">       NOTES.</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ç”¨<strong>syscallå‡½æ•°</strong>æ¥è°ƒç”¨è¯¥æ¥å£ï¼Œè¿™ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡æ¥è§¦åˆ°syscallå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE         <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span>   <span class="comment">/* For SYS_xxx definitions */</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">syscall</span><span class="params">(<span class="type">int</span> number, ...)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨syscallçš„manæ‰‹å†Œä¸­ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°è·å–çº¿ç¨‹idç›¸å…³çš„ç¤ºä¾‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EXAMPLE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> tid;</span><br><span class="line"></span><br><span class="line">    tid = syscall(SYS_gettid);</span><br><span class="line">    tid = syscall(SYS_tgkill, getpid(), tid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸‹é¢çš„ä»£ç è¿›è¡Œæµ‹è¯•</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 thread:: &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; :: &quot;</span> &lt;&lt; <span class="built_in">getpid</span>() &lt;&lt; <span class="string">&quot; tid: &quot;</span> &lt;&lt; <span class="built_in">syscall</span>(SYS_gettid) &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func2 exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">pthread_exit</span>((<span class="type">void</span>*)<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;tis is main - pid:%d - tid:%d\n&quot;</span>,<span class="built_in">getpid</span>(),<span class="built_in">syscall</span>(SYS_gettid));</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹æ‰“å°å‡ºäº†ç›¸åŒçš„PIDå’Œä¸åŒçš„TIDï¼Œå…¶TIDå¯¹åº”çš„å°±æ˜¯<code>ps -aL</code>ä¸­æ˜¾ç¤ºçš„<code>LWP</code>ç¼–å·</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181307710.png" alt="image-20221218130755643"></p><h1 id="3-ç›¸å…³æ¦‚å¿µ"><a href="#3-ç›¸å…³æ¦‚å¿µ" class="headerlink" title="3.ç›¸å…³æ¦‚å¿µ"></a>3.ç›¸å…³æ¦‚å¿µ</h1><h2 id="3-1-çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#3-1-çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ"></a>3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å‰é¢æåˆ°è¿‡ï¼Œ<code>pthread_t</code>æ˜¯çº¿ç¨‹ç‹¬ç«‹çš„idï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ— ç¬¦å·é•¿æ•´å½¢ï¼Œæ‰“å°å‡ºæ¥åï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ•°å­—ã€‚è¿™ä¸ªæ•°å­—æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å«ä¹‰å—ï¼Ÿ</p><p>å…ˆæ¥å›é¡¾ä¸€ä¸‹çº¿ç¨‹çš„åŸºæœ¬æ¦‚å¿µï¼š</p><ul><li>çº¿ç¨‹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæµ</li><li>çº¿ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿè‡ªå·±çš„ä¸´æ—¶æ•°æ®</li><li>çº¿ç¨‹è°ƒç”¨å‡½æ•°çš„å‹æ ˆå‡ºæ ˆæ“ä½œï¼Œæœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç»“æ„</li></ul><p>å› æ­¤ï¼Œæ—¢ç„¶æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ ˆç»“æ„ï¼Œå…¶å°±éœ€è¦æœ‰ä¸€ä¸ªæ ‡è¯†ç¬¦æ¥æŒ‡å‘è¿™ä¸ªæ ˆç»“æ„ï¼Œæ–¹ä¾¿ç¨‹åºè¿è¡Œçš„æ—¶å€™è¿›è¡Œè°ƒç”¨ï¼</p><p>æ‰€ä»¥ï¼Œ<code>pthread_t</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåœ°å€ï¼å…¶æŒ‡å‘çš„å°±æ˜¯è¿™ä¸ª<strong>çº¿ç¨‹çš„æ§åˆ¶å—</strong>ï¼Œå…¶å†…éƒ¨åŒ…å«äº†è¿™ä¸ªçº¿ç¨‹çš„ç‹¬ç«‹æ ˆç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//printf(&quot;0x%x  0x%x\n&quot;,t1,t2);</span></span><br><span class="line"><span class="number">0x393d0700</span>  <span class="number">0x38bcf700</span> <span class="comment">//æ‰“å°å‡ºæ¥çš„ç»“æœä¹Ÿå¾ˆåƒåœ°å€</span></span><br></pre></td></tr></table></figure><h2 id="3-2-pthreadåº“"><a href="#3-2-pthreadåº“" class="headerlink" title="3.2 pthreadåº“"></a>3.2 pthreadåº“</h2><p>pthreadåº“å¹¶ä¸æ˜¯ä¸€ä¸ªå†…æ ¸çº§çš„æ¥å£åº“ï¼Œå…¶å®é™…ä¸Šæ˜¯å°è£…äº†ç³»ç»Ÿçš„<code>clone/vfork</code>ç­‰æ¥å£ï¼Œä»è€Œä¸ºæˆ‘ä»¬æä¾›çš„ç”¨æˆ·çº§çš„çº¿ç¨‹åº“ã€‚</p><p>ä½¿ç”¨pthreadåº“åˆ›å»ºçš„è¿›ç¨‹ï¼Œå’Œå†…æ ¸ä¸­çš„LWPæ˜¯<code>1:1</code>çš„</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181023276.png" alt="image-20221218102338117"></p><p>pthreadæ˜¯ä¸€ä¸ª<strong>åŠ¨æ€åº“</strong>ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™éœ€è¦åŠ ä¸Šé“¾æ¥é€‰é¡¹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ test.cpp -o test -lpthread</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘çš„ <a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/127668016?spm=1001.2014.3001.5501">åŠ¨é™æ€åº“<i class="fas fa-external-link-alt"></i></a> çš„åšå®¢ä¸­æœ‰è®²è¿°è¿‡ï¼ŒåŠ¨æ€åº“æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™åŠ¨æ€é“¾æ¥çš„ï¼Œå…¶ä¼šå°†åº“ä¸­çš„ä»£ç æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„<code>å…±äº«åŒº</code>ï¼Œä»è€Œè°ƒç”¨åŠ¨æ€åº“ä¸­çš„ä»£ç </p><blockquote><p>ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>pthead_create</code>çš„æ—¶å€™ï¼Œ<strong>è¿›ç¨‹ä¼šè·³åˆ°å…±äº«åŒºä¸­</strong>ï¼Œæ‰§è¡ŒåŠ¨æ€åº“ä¸­çš„ä»£ç ï¼Œåˆ›å»ºæˆåŠŸåè¿”å›è‡ªå·±çš„<code>ä»£ç åŒº</code>ï¼Œå®Œæˆä¸€ä¸ªçº¿ç¨‹çš„åˆ›å»º</p></blockquote><p>è€Œçº¿ç¨‹æ‰€ç”¨çš„ç‹¬ç«‹æ ˆï¼Œä¹Ÿæ˜¯pthreadåº“å¸®æˆ‘ä»¬ç®¡ç†çš„ã€‚å› ä¸ºæœ‰å…±äº«åŒºçš„å­˜åœ¨ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡<code>pthread_t</code>ç›´æ¥è®¿é—®åˆ°åŠ¨æ€åº“ä¸­ç®¡ç†çš„<strong>çº¿ç¨‹çš„æ§åˆ¶æ¨¡å—</strong>ï¼Œä»è€Œå®Œæˆçº¿ç¨‹çš„å‹æ ˆã€å‡ºæ ˆç­‰ç­‰æ“ä½œ</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181036505.png" alt="image-20221218103643205"></p><p>ä¸‹ä¸ºlinuxçš„<code>pthreadtypes.h</code>ä¸­çš„éƒ¨åˆ†å†…å®¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> __SIZEOF_PTHREAD_ATTR_T 36</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">pthread_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">pthread_attr_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> __size[__SIZEOF_PTHREAD_ATTR_T];</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> __align;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __have_pthread_attr_t</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">pthread_attr_t</span> <span class="title">pthread_attr_t</span>;</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> __have_pthread_attr_t	1</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h2 id="3-3-çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨"><a href="#3-3-çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨" class="headerlink" title="3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨"></a>3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬æƒ³è®©åˆ›å»ºå‡ºæ¥çš„æ¯ä¸€ä¸ªçº¿ç¨‹ï¼Œéƒ½èƒ½ç‹¬ç«‹çš„ä½¿ç”¨è¿™ä¸ªå…¨å±€å˜é‡ï¼Œé‚£å°±éœ€è¦ç”¨åˆ°çº¿ç¨‹çš„<strong>å±€éƒ¨å­˜å‚¨</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> global = <span class="number">10</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func3</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(a--)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func thread &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt;  <span class="string">&quot; - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func3,(<span class="type">void</span>*)<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;this is main - global: &quot;</span> &lt;&lt; global &lt;&lt; <span class="string">&quot; - &amp;global: &quot;</span> &lt;&lt; &amp;global &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œï¼Œä¸ç®¡æ˜¯ä¸»çº¿ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œéƒ½æ‰“å°çš„æ˜¯ç›¸åŒçš„å€¼å’Œåœ°å€</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181107524.png" alt="image-20221218110718405"></p><p>å¦‚æœåœ¨æ‰§è¡Œçš„å‡½æ•°<code>func3</code>ä¸­æ·»åŠ ä¸€ä¸ª<code>global++</code>ï¼Œåˆ™èƒ½è§‚å¯Ÿåˆ°æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…¬ç”¨çš„ä¸€ä¸ªå˜é‡ï¼Œè¿™é‡Œçš„+æ˜¯åŒæ­¥çš„ã€‚</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181110159.png" alt="image-20221218111031984"></p><p>å¦‚æœæˆ‘ä»¬æƒ³è®©<code>int global</code>å˜æˆå±€éƒ¨å˜é‡ï¼Œåˆ™éœ€è¦åœ¨å®ƒä¹‹å‰åŠ ä¸Šä¸€ä¸ª<code>__thread</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__thread <span class="type">int</span> global = <span class="number">100</span>;<span class="comment">//å¯ä»¥è®©çº¿ç¨‹ç‹¬ç«‹ä½¿ç”¨çš„å…¨å±€å˜é‡</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªçº¿ç¨‹å’Œä¸»çº¿ç¨‹æ‰“å°çš„globalå˜é‡åœ°å€ä¸åŒï¼Œä»–ä»¬çš„<code>++</code>æ“ä½œæ˜¯ç‹¬ç«‹çš„ï¼Œå˜é‡çš„å€¼ä¹Ÿæ˜¯ç‹¬ç«‹çš„</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181116428.png" alt="image-20221218111639283"></p><p>è¿™å°±å®ç°äº†å°†æŸä¸€ä¸ªå˜é‡åˆ’åˆ†ç»™çº¿ç¨‹è¿›è¡Œ<strong>å±€éƒ¨å­˜å‚¨</strong></p><h1 id="4-çº¿ç¨‹äº’æ–¥é—®é¢˜"><a href="#4-çº¿ç¨‹äº’æ–¥é—®é¢˜" class="headerlink" title="4.çº¿ç¨‹äº’æ–¥é—®é¢˜"></a>4.çº¿ç¨‹äº’æ–¥é—®é¢˜</h1><h2 id="4-1-ä¸´ç•Œèµ„æº"><a href="#4-1-ä¸´ç•Œèµ„æº" class="headerlink" title="4.1 ä¸´ç•Œèµ„æº"></a>4.1 ä¸´ç•Œèµ„æº</h2><p>åœ¨å…ˆå‰<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/127834035?spm=1001.2014.3001.5501">å…±äº«å†…å­˜ ä¿¡å·é‡<i class="fas fa-external-link-alt"></i></a>çš„åšå®¢ä¸­ï¼Œå·²ç»æ¶‰åŠåˆ°äº†è¿™éƒ¨åˆ†çš„å†…å®¹ï¼›å³å…³äºæ“ä½œ<strong>åŸå­æ€§</strong>å’Œè®¿é—®<strong>ä¸´ç•Œèµ„æº&#x2F;ä¸´ç•ŒåŒº</strong>çš„ç›¸å…³é—®é¢˜ã€‚</p><ul><li>èƒ½è¢«å¤šä¸ªè¿›ç¨‹&#x2F;çº¿ç¨‹çœ‹åˆ°çš„èµ„æºï¼Œè¢«ç§°ä¸º<code>ä¸´ç•Œèµ„æº</code></li><li>è¿›ç¨‹&#x2F;çº¿ç¨‹è®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ï¼Œè¢«ç§°ä¸º<code>ä¸´ç•ŒåŒº</code></li></ul><p>åœ¨çº¿ç¨‹ä¸­ï¼ŒåŒæ ·å­˜åœ¨è®¿é—®<strong>ä¸´ç•Œèµ„æº</strong>è€Œå¯¼è‡´çš„å†²çªï¼š</p><ul><li>çº¿ç¨‹Aå¯¹ä¸€ä¸ª<strong>å…¨å±€å˜é‡val</strong>è¿›è¡Œäº†<code>-1</code>æ“ä½œï¼Œå½“æ“ä½œæ‰§è¡Œåˆ°æ”¾å›å†…å­˜é‚£ä¸€æ­¥çš„æ—¶å€™ï¼Œå‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹Bå¼€å§‹å·¥ä½œ</li><li>çº¿ç¨‹BåŒæ ·è®¿é—®äº†è¯¥å…¨å±€å˜é‡valï¼Œå¯¹å®ƒè¿›è¡Œäº†<code>-10</code>æ“ä½œï¼Œæ­¤æ—¶å› ä¸ºçº¿ç¨‹Açš„<code>-1</code>æ“ä½œå°šæœªå†™å›å†…å­˜ï¼Œå…¨å±€å˜é‡valè¿˜æ˜¯ä¿æŒåˆå€¼ã€‚çº¿ç¨‹bå°†<code>-10</code>ä¹‹åçš„å…¨å±€å˜é‡valå†™å›äº†å†…å­˜</li><li>åˆå‘ç”Ÿäº†çº¿ç¨‹åˆ‡æ¢ï¼Œè·³è½¬åˆ°çº¿ç¨‹Aåœæ­¢çš„<strong>çº¿ç¨‹ä¸Šä¸‹æ–‡æ•°æ®</strong>ä¸­å¼€å§‹æ‰§è¡Œï¼Œå°†å…¨å±€å˜é‡å†™å…¥å†…å­˜</li><li>è¿™æ—¶å€™ï¼Œçº¿ç¨‹Bçš„<code>-10</code>æ“ä½œå°±è¢«Açš„å†™å…¥è¦†ç›–äº†ï¼</li></ul><p>ä¸¾ä¸ªå®é™…ç‚¹çš„ä¾‹å­ï¼Œä»¥100ä¸ºå…¨å±€å˜é‡çš„åˆå§‹å€¼</p><ul><li>çº¿ç¨‹Aæ‰§è¡Œ-1ï¼Œ<code>100-1=99</code>ï¼Œè¿˜æœªå†™å…¥å†…å­˜æ—¶ï¼Œå°±çº¿ç¨‹åˆ‡æ¢</li><li>çº¿ç¨‹Bå–åˆ°çš„å…¨å±€å˜é‡è¿˜æ˜¯100ï¼Œå¯¹å…¶æ‰§è¡Œ-10ï¼Œå¹¶å†™å…¥å†…å­˜ï¼Œ æ­¤æ—¶å…¨å±€å˜é‡ä¸º90</li><li>è¿”å›çº¿ç¨‹Aç»§ç»­æ‰§è¡Œå†™å…¥å†…å­˜æ“ä½œï¼Œå…¨å±€å˜é‡åˆè¢«å¤å†™æˆäº†99ï¼›<strong>ç›¸å½“äºBçš„æ“ä½œæ˜¯æ— æ•ˆçš„</strong></li></ul><p>è¿™ç§æ¡ä»¶ä¸‹ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ï¼</p><h2 id="4-2-åŸå­-x2F-äº’æ–¥æ€§"><a href="#4-2-åŸå­-x2F-äº’æ–¥æ€§" class="headerlink" title="4.2 åŸå­&#x2F;äº’æ–¥æ€§"></a>4.2 åŸå­&#x2F;äº’æ–¥æ€§</h2><p>è¿™ç§æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿è¯è®¿é—®è¯¥å…¨å±€å˜é‡çš„æ“ä½œæ˜¯<strong>åŸå­</strong>çš„ï¼Œä¸èƒ½å‡ºç°ä¸­é—´çŠ¶æ€ï¼›</p><p>ä¹Ÿåº”è¯¥æ˜¯<strong>äº’æ–¥</strong>çš„ï¼Œä¸èƒ½å‡ºç°ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä»½èµ„æºçš„æƒ…å†µ</p><blockquote><p>äº’æ–¥æ€§ï¼šä»»ä½•æ—¶å€™éƒ½åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµåœ¨è®¿é—®æŸä¸€ä»½èµ„æº</p></blockquote><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212181937011.png" alt="image-20221218193343035"></p><p>ä¸ºäº†è¾¾æˆè¿™ä¸€ç›®çš„ï¼Œæˆ‘ä»¬éœ€è¦ç»™çº¿ç¨‹çš„æ“ä½œ<strong>åŠ é”</strong></p><h2 id="4-3-çº¿ç¨‹åŠ é”"><a href="#4-3-çº¿ç¨‹åŠ é”" class="headerlink" title="4.3 çº¿ç¨‹åŠ é”"></a>4.3 çº¿ç¨‹åŠ é”</h2><p>çº¿ç¨‹åŠ é”æ¶‰åŠåˆ°å‡ ä¸ªæ“ä½œï¼š</p><ul><li>æä¾›ä¸€æŠŠé”</li><li>åœ¨éœ€è¦ç»´æŒåŸå­æ€§ï¼ˆä¸´ç•ŒåŒºï¼‰çš„ä½ç½®åŠ ä¸Šé”</li><li>è®¿é—®ä¸´ç•ŒåŒºç»“æŸåï¼Œæ‰“å¼€é”</li><li>è¿›ç¨‹ç»“æŸåï¼ŒæŠŠé”ä¸¢äº†</li></ul><p>æ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜</p><h3 id="4-3-1-pthread-mutex-init"><a href="#4-3-1-pthread-mutex-init" class="headerlink" title="4.3.1 pthread_mutex_init"></a>4.3.1 pthread_mutex_init</h3><p>pthreadåœ¨è®¾è®¡ä¹‹åˆå°±è€ƒè™‘åˆ°äº†è¿™ç§é—®é¢˜ï¼Œæ‰€ä»¥å®ƒä¾¿ç»™æˆ‘ä»¬æä¾›äº†åŠ é”ç›¸å…³çš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_destroy</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">                       <span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€æŠŠé”ï¼Œç±»å‹æ˜¯<code>pthread_mutex_t</code></p><ul><li>å¦‚æœæˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€æŠŠ<strong>å…¨å±€å˜é‡</strong>çš„é”ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨<code>PTHREAD_MUTEX_INITIALIZER</code>ç»™è¿™æŠŠé”åˆå§‹åŒ–</li><li>å¦‚æœæ˜¯ä¸€æŠŠå±€éƒ¨çš„é”ï¼Œåˆ™ä½¿ç”¨å‡½æ•°<code>pthread_mutex_init</code>è¿›è¡Œåˆå§‹åŒ–</li></ul><p>åˆå§‹åŒ–çš„æ–¹æ³•å¾ˆç®€å•ï¼Œä¼ å…¥é”å’Œå¯¹åº”çš„å±æ€§å°±è¡Œã€‚æ­¤æ—¶æˆ‘ä»¬å¿½ç•¥å±æ€§é—®é¢˜ï¼Œè®¾ç½®ä¸º<code>NULL</code>ä½¿ç”¨<strong>é»˜è®¤å±æ€§</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨é»˜è®¤å±æ€§çš„å…¨å±€é”oré™æ€staticé”</span></span><br><span class="line"><span class="comment">//æ— é¡»è°ƒç”¨å‡½æ•°åˆå§‹åŒ–ï¼Œå¯ä»¥ç›´æ¥ç”¨</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨å‡½æ•°è¿›è¡Œåˆå§‹åŒ–å±€éƒ¨çš„é”ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åˆå§‹åŒ–å…¨å±€é”ï¼‰</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;<span class="comment">//å®šä¹‰ä¸€æŠŠé”</span></span><br><span class="line">pthread_mutex_init(&amp;mutex, nullptr);<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line">pthread_mutex_destroy(&amp;mutex);<span class="comment">//é”€æ¯</span></span><br></pre></td></tr></table></figure><h3 id="4-3-2-åŠ é”-x2F-è§£é”"><a href="#4-3-2-åŠ é”-x2F-è§£é”" class="headerlink" title="4.3.2 åŠ é”&#x2F;è§£é”"></a>4.3.2 åŠ é”&#x2F;è§£é”</h3><p>æœ‰äº†é”ï¼Œé‚£ä¹ˆå°±å¯ä»¥åœ¨éœ€è¦çš„ä½ç½®åŠ ä¸Šè¿™æŠŠé”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_lock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_unlock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­lockæ˜¯<strong>é˜»å¡å¼</strong>åŠ é”ï¼Œå¦‚æœä½ è°ƒç”¨è¿™ä¸ªæ¥å£çš„æ—¶å€™ï¼Œé”æ­£åœ¨è¢«åˆ«äººä½¿ç”¨ï¼Œåˆ™ä¼šåœ¨è¿™é‡Œç­‰å¾…ï¼›trylockæ˜¯<strong>éé˜»å¡</strong>åŠ é”ï¼Œå¦‚æœä½ è°ƒç”¨è¯¥æ¥å£æ—¶é”æ­£è¢«ä½¿ç”¨ï¼Œåˆ™ç›´æ¥<code>return</code>è¿”å›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The pthread_mutex_trylock() function shall be equivalent to pthread_mutex_lock(), except that if the mutex object referenced  by  mutex  is  currently locked (by any thread, including the current thread), the call shall return immediately. </span><br></pre></td></tr></table></figure><p>åŠ äº†é”ä¹‹åï¼Œåœ¨éœ€è¦çš„ä½ç½®<code>unlock</code>è§£é”ï¼›</p><ul><li>åŠ é”å’Œè§£é”æ“ä½œ<strong>æœ¬èº«</strong>æ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°å†²çª</li><li>åŠ äº†é”ä¹‹åï¼Œå¯ä»¥ç†è§£ä¸ºåŠ é”è§£é”æ“ä½œ<strong>ä¸­é—´</strong>çš„ä»£ç ä¹Ÿæ˜¯åŸå­æ€§çš„ï¼Œ<strong>å¿…é¡»è¦è¿è¡Œåˆ°è§£é”ä½ç½®</strong>æ‰èƒ½è®©å¦å¤–ä¸€ä¸ªçº¿ç¨‹&#x2F;è¿›ç¨‹æ‰§è¡Œè¿™é‡Œçš„ä»£ç </li><li>åŠ é”çš„æœ¬è´¨æ˜¯è®©çº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºçš„ä»£ç ä¸²è¡ŒåŒ–</li></ul><h3 id="4-3-3-åŠ é”çš„æ³¨æ„äº‹é¡¹"><a href="#4-3-3-åŠ é”çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹"></a>4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹</h3><ul><li>åªå¯¹ä¸´ç•ŒåŒºåŠ é”ï¼›é”ä¿æŠ¤çš„å°±æ˜¯ä¸´ç•ŒåŒº</li><li>åŠ é”çš„ç²’åº¦è¶Šç»†è¶Šå¥½ï¼ˆå³åŠ é”çš„åŒºåŸŸè¶Šå°è¶Šå¥½ï¼‰</li><li>åŠ é”æ˜¯ç¼–ç¨‹çš„ä¸€ç§è§„èŒƒï¼›åœ¨å®é™…é—®é¢˜ä¸­ï¼Œæˆ‘ä»¬è¦ä¿è¯è®¿é—®æŸä¸€ä¸´ç•Œèµ„æºçš„æ‰€æœ‰æ“ä½œéƒ½è¦åŠ ä¸Šé”ã€‚ä¸èƒ½å‡ºç°å‡½æ•°AåŠ é”äº†ï¼Œä½†æ˜¯Bæ²¡æœ‰åŠ é”çš„æƒ…å†µï¼ˆè¿™æ ·ä¼šå¯¼è‡´Açš„åŠ é”ä¹Ÿæ²¡æœ‰æ„ä¹‰ï¼‰</li></ul><h2 id="4-4-ç¤ºä¾‹-å€’æ°´é—®é¢˜"><a href="#4-4-ç¤ºä¾‹-å€’æ°´é—®é¢˜" class="headerlink" title="4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜"></a>4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜</h2><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212240951765.png" alt="image-20221224095101707"></p><p>ä»¥<strong>å€’æ°´</strong>ä¸ºç¤ºä¾‹ï¼Œå‡è®¾æ¯å­å®¹é‡ä¸º10000ï¼Œ<strong>è£…æ»¡äº†æ°´å°±ä¼šæº¢å‡º</strong>ã€‚æˆ‘ä»¬ä½¿ç”¨å¤šä¸ªçº¿ç¨‹å¯¹è¿™ä¸ªæ¯å­åŠ æ°´ï¼Œç›´åˆ°æ»¡äº†ä¹‹åçº¿ç¨‹é€€å‡º</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//ä¸´ç•Œèµ„æº</span></span><br><span class="line"><span class="type">int</span> water = <span class="number">0</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="type">int</span> cup = <span class="number">10000</span>;<span class="comment">//æ¯å­çš„å®¹é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)<span class="comment">//ä¸´ç•ŒåŒº</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº† &quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2,t3,t4;<span class="comment">//åˆ›å»º4ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t3,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t3&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t4,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›´æ¥åˆ†ç¦»çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t3);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ;<span class="comment">//å•¥éƒ½ä¸å¹²</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼Œæ˜æ˜æ°´å·²ç»æ»¡äº†ï¼Œä½†è¿˜æ˜¯ä¼šæœ‰éƒ¨åˆ†çº¿ç¨‹æŠ¥å‘Šæ°´è¿˜æ²¡æœ‰æ»¡ï¼Œä¸”æ•°å­—æœ‰å¾ˆä¸¥é‡çš„åå·®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9993</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9994</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line"> æ°´æ²¡æœ‰æ»¡ï¼š2723</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">0</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9668</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº†</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><p>å¤šè¿è¡Œå‡ æ¬¡ï¼Œä¹Ÿèƒ½å‘ç°ç›¸åŒçš„é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š1889</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10001</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š0</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10002</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š0</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10003</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><h3 id="4-4-1-åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ"><a href="#4-4-1-åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ" class="headerlink" title="4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ"></a>4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ</h3><p>é™¤äº†åå·®å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œå¾€å‰ç¿»æ‰“å°è®°å½•ï¼Œä¼šå‘ç°ä¸€ç›´éƒ½æ˜¯<strong>æŸä¸€ä¸ªçº¿ç¨‹åœ¨å€’æ°´</strong>ï¼Œå…¶ä»–çº¿ç¨‹ä¼¼ä¹å•¥äº‹æ²¡æœ‰å¹²ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9786</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9787</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9788</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9789</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9790</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºå½“è¿è¡Œt3çš„æ—¶å€™ï¼Œt3åœ¨whileå¾ªç¯ä¸­ç»§ç»­è¿è¡Œçš„æ¶ˆè€—ï¼Œ<strong>å°äºåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹çš„æ¶ˆè€—</strong>ã€‚æ‰€ä»¥æ§åˆ¶å—å°±è®©t3ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å®ƒbreaké€€å‡ºå¾ªç¯</p><p>æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦åŠ ä¸Šä¸€ä¸ªusleepï¼Œå¢åŠ æ¯ä¸€ä¸ªwhileå¾ªç¯ä¸­éœ€è¦<strong>å¤„ç†çš„è´Ÿæ‹…</strong>ï¼Œå°±èƒ½è®©æ‰€æœ‰çº¿ç¨‹éƒ½æ¥å€’æ°´</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//usleepåŠŸèƒ½æŠŠè¿›ç¨‹æŒ‚èµ·ä¸€æ®µæ—¶é—´ï¼Œ å•ä½æ˜¯å¾®ç§’ï¼ˆç™¾ä¸‡åˆ†ä¹‹ä¸€ç§’ï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">usleep</span><span class="params">(<span class="type">useconds_t</span> usec)</span>;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸ºçº¿ç¨‹åˆ‡æ¢åŒæ ·ä¹Ÿæ˜¯æ—¶é—´ç‰‡åˆ°äº†ï¼Œä»å†…æ ¸è¿”å›ç”¨æˆ·æ€çš„æ—¶å€™åšæ£€æµ‹ï¼Œåˆ‡æ¢è‡³å…¶ä»–çº¿ç¨‹ã€‚</p><p>æ·»åŠ usleepèƒ½åˆ›é€ æ›´å¤š<strong>å†…æ ¸&#x2F;ç”¨æˆ·çš„ä¸­é—´æ€</strong>ï¼Œä»è€Œå¢å¤šåˆ‡æ¢çº¿ç¨‹çš„æ¬¡æ•°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//ä¼‘æ¯100å¾®ç§’</span></span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº†&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™è¿˜æ˜¯æ²¡æœ‰è§£å†³æ•°å­—å‡ºé”™çš„é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š10000</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10001</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š10001</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10002</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š10002</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10003</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br></pre></td></tr></table></figure><h3 id="4-4-2-åŠ é”-é—®é¢˜è§£å†³"><a href="#4-4-2-åŠ é”-é—®é¢˜è§£å†³" class="headerlink" title="4.4.2 åŠ é”-é—®é¢˜è§£å†³"></a>4.4.2 åŠ é”-é—®é¢˜è§£å†³</h3><p>è¿™æ—¶å€™å°±éœ€è¦è¯·å‡ºæˆ‘ä»¬çš„é”äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//çœç•¥å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="type">int</span> water = <span class="number">0</span>;<span class="comment">//å…¨å±€å˜é‡</span></span><br><span class="line"><span class="type">int</span> cup = <span class="number">10000</span>;<span class="comment">//æ¯å­çš„å®¹é‡</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line">        <span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            water++;</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//å‡è£…å–æ°´</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´å·²ç»æ»¡äº† &quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">            <span class="comment">//æ­¤å¤„ä¹Ÿéœ€è¦åŠ é”ï¼Œå¦åˆ™breakå‡ºå»ä¹‹åå…¶ä»–çº¿ç¨‹ä¼šå› ä¸ºæ²¡æœ‰è§£é”è€ŒæŒ‚èµ·</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; çº¿ç¨‹é€€å‡º&quot;</span> &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœé‡åˆ°2å·ä¿¡å·ï¼Œå°±åœ¨é”€æ¯é”åé€€å‡ºè¿›ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">des</span><span class="params">(<span class="type">int</span> signo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//é”€æ¯é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;mutex);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;pthread_mutex_destroy, exit&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">signal</span>(SIGINT,des);<span class="comment">//è‡ªå®šä¹‰æ•æ‰2å·ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;mutex,<span class="literal">nullptr</span>);<span class="comment">//åˆå§‹åŒ–é”</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t1,t2,t3,t4;<span class="comment">//åˆ›å»º4ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t3,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t3&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t4,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t4&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç›´æ¥åˆ†ç¦»çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t3);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ;<span class="comment">//å•¥éƒ½ä¸å¹²</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¯è§ï¼Œæ•°å­—é”™è¯¯é—®é¢˜å°±æ²¡æœ‰å‡ºç°äº†ï¼›<strong>ä½†åˆå‡ºç°äº†åªæœ‰ä¸€ä¸ªçº¿ç¨‹å·¥ä½œçš„é—®é¢˜</strong></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9996</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9997</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9998</span></span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š<span class="number">9999</span></span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† <span class="number">10000</span></span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">^Cpthread_mutex_destroy, exit</span><br></pre></td></tr></table></figure><p>è¿™è¿˜æ˜¯å› ä¸ºçº¿ç¨‹åˆ‡æ¢çš„æ•ˆç‡é—®é¢˜ï¼›ä¹Ÿæœ‰å¯èƒ½æ˜¯å› ä¸ºå…¶å®ƒçº¿ç¨‹ç”³è¯·é”çš„æ—¶å€™ï¼Œå‘ç°t1åœ¨ç”¨ï¼Œå°±è¿›è¡Œäº†<strong>é˜»å¡ç­‰å¾…</strong>è€ŒæŒ‚èµ·</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212191022656.png" alt="image-20221219102217522"></p><p>åªéœ€è¦åœ¨è§£é”ä¹‹åæ·»åŠ ä¸€ä¸ª<code>usleep</code>æ¨¡æ‹Ÿå…¶ä»–å·¥ä½œï¼Œå°±èƒ½è®©æ‰€æœ‰çº¿ç¨‹éƒ½è·‘èµ·æ¥</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line"><span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">100</span>);</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    water++;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">100</span>);<span class="comment">//å‡è£…å–æ°´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å‡ºç°æ•°æ®é”™è¯¯ï¼ŒåŠ é”çš„ç›®çš„æˆåŠŸè¾¾åˆ°ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9993</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9994</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9995</span><br><span class="line">t2 æ°´æ²¡æœ‰æ»¡ï¼š9996</span><br><span class="line">t1 æ°´æ²¡æœ‰æ»¡ï¼š9997</span><br><span class="line">t3 æ°´æ²¡æœ‰æ»¡ï¼š9998</span><br><span class="line">t4 æ°´æ²¡æœ‰æ»¡ï¼š9999</span><br><span class="line">t2 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t2 çº¿ç¨‹é€€å‡º</span><br><span class="line">t1 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t1 çº¿ç¨‹é€€å‡º</span><br><span class="line">t3 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t3 çº¿ç¨‹é€€å‡º</span><br><span class="line">t4 æ°´å·²ç»æ»¡äº† 10000</span><br><span class="line">t4 çº¿ç¨‹é€€å‡º</span><br><span class="line">^Cpthread_mutex_destroy, exit</span><br></pre></td></tr></table></figure><h2 id="4-5-åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š"><a href="#4-5-åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š" class="headerlink" title="4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š"></a>4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š</h2><p>åœ¨è¿™ä¸ªä»£ç ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç»™ä¸­é—´çš„å‡ è¡Œä»£ç åŠ äº†é”ï¼›ä½†è¿™å¹¶ä¸æ„å‘³ç€æ‰§è¡Œä¸­é—´è¿™éƒ¨åˆ†ä»£ç çš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pthread_mutex_lock</span>(&amp;mutex);<span class="comment">//åŠ é”</span></span><br><span class="line"><span class="keyword">if</span>(water&lt;cup)</span><br><span class="line">&#123;</span><br><span class="line">    cout &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; <span class="string">&quot; æ°´æ²¡æœ‰æ»¡ï¼š&quot;</span> &lt;&lt; water &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    water++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);<span class="comment">//è§£é”</span></span><br></pre></td></tr></table></figure><p>äº‹å®ä¸Šï¼Œä»£ç æ‰§è¡Œçš„ä»»ä½•åœ°æ–¹ï¼Œéƒ½å¯èƒ½å‘ç”Ÿè¿›ç¨‹&#x2F;çº¿ç¨‹çš„åˆ‡æ¢ã€‚ä½†å› ä¸ºæˆ‘ä»¬åŠ äº†é”ï¼Œåˆ‡æ¢çš„æ—¶å€™ï¼Œå…¶ä»–çº¿ç¨‹è¦æ¥è®¿é—®è¿™é‡Œçš„èµ„æºï¼Œ<strong>å°±å¿…é¡»å…ˆç”³è¯·é”</strong></p><p>æ­¤æ—¶é”åœ¨<strong>è¢«åˆ‡èµ°çš„è¿›çº¿ç¨‹æ‰‹ä¸Š</strong>ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ä¸´ç•ŒåŒºçš„èµ„æºï¼Œä¹Ÿå°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202211031203810.gif" alt="QQå›¾ç‰‡20220504102516"></p><blockquote><p>æ¢è¨€ä¹‹ï¼Œåªè¦<strong>å¼ ä¸‰</strong>æ‹¿åˆ°äº†é”ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå°±ä¸æ‹…å¿ƒè‡ªå·±çš„å·¥ä½œä¼šè¢«åˆ«äººè¦†ç›–çš„é—®é¢˜ï¼›</p><p>è€Œå¯¹å…¶ä»–çº¿ç¨‹è€Œè¨€ï¼Œå¼ ä¸‰è®¿é—®ä¸´ç•ŒåŒºçš„å·¥ä½œï¼Œåªæœ‰<strong>è¿˜æ²¡è¿›å…¥</strong>ä¸´ç•ŒåŒºå’Œ<strong>è®¿é—®å®Œæ¯•</strong>ä¸´ç•ŒåŒºä¸¤ç§çŠ¶æ€</p></blockquote><p>å› æ­¤ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯çº¿ç¨‹åˆ‡æ¢çš„æ•ˆç‡è¾ƒä½ï¼Œå…¶ä»–çº¿ç¨‹å‡ºç°äº†é˜»å¡ç­‰å¾…çš„æƒ…å†µï¼›ä¸ºäº†é¿å…æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥è®©è®¿é—®ä¸´ç•ŒåŒºçš„æ“ä½œå¿«å»å¿«å›ï¼Œå°½é‡ä¸è¦åœ¨ä¸´ç•ŒåŒºé‡Œé¢å¹²å•¥è€—æ—¶çš„äº‹æƒ…</p><h3 id="4-5-1-åŠ é”åŸå­æ€§çš„ä¿è¯"><a href="#4-5-1-åŠ é”åŸå­æ€§çš„ä¿è¯" class="headerlink" title="4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯"></a>4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯</h3><blockquote><p>å¤‡æ³¨ï¼šè¿™éƒ¨åˆ†ä»…ä¾›å­¦ä¹ å‚è€ƒï¼Œè‹¥æœ‰é”™è¯¯ï¼Œè¿˜è¯·æŒ‡å‡ºï¼</p></blockquote><p>é‚£ä¹ˆåŠ é”è¿™ä¸ªæ“ä½œï¼Œæ˜¯å¦‚ä½•ä¿è¯å…¶è‡ªèº«çš„åŸå­æ€§å‘¢ï¼Ÿåœ¨åŠ é”çš„é€”ä¸­ä¸ä¼šå‘ç”Ÿçº¿ç¨‹åˆ‡æ¢å—ï¼Ÿ</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212240939271.png" alt="Snipaste_2022-12-24_09-38-46"></p><p>æˆ‘æ‰¾åˆ°äº†ä¸€å¼ èƒ½å¤§æ¦‚è¯´æ˜æ±‡ç¼–åŠ é”è¿‡ç¨‹çš„å›¾ç‰‡ï¼Œå…¶ä¸­<code>movb</code>çš„æ“ä½œå°±æ˜¯å°†alå¯„å­˜å™¨å†™ä¸º0ï¼Œ<code>xchgb</code>çš„æ“ä½œæ˜¯å°†alå¯„å­˜å™¨çš„å†…å®¹å’Œå†…å­˜ä¸­mutexé”çš„å€¼è¿›è¡Œäº¤æ¢</p><ul><li>å¼€å§‹çš„æ—¶å€™ï¼Œé”è¢«æ­£å¸¸åˆå§‹åŒ–ï¼Œå†…å­˜ä¸­mutexçš„å€¼ä¸º1ï¼ˆé”åªä¼šè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼‰</li><li>çº¿ç¨‹Aå¼€å§‹åŠ é”ï¼Œalå¯„å­˜å™¨å’Œmutexçš„å€¼å‘ç”Ÿäº¤æ¢ï¼Œæ­¤æ—¶å†…å­˜ä¸­çš„mutexä¸º0ï¼Œalä¸º1</li><li>åˆ¤æ–­alä¸ä¸º0ï¼Œä»£è¡¨è·å–é”æˆåŠŸï¼Œçº¿ç¨‹AåŠ é”æˆåŠŸ</li><li>çº¿ç¨‹Bä¹Ÿæ¥ç”³è¯·é”äº†ï¼Œ<code>movb</code>å°†alå¯„å­˜å™¨å†™ä¸º0ï¼Œå†å’Œå†…å­˜ä¸­çš„mutexäº¤æ¢åï¼Œå‘ç°è¿˜æ˜¯0ï¼Œåˆ™ä»£è¡¨é”åœ¨åˆ«äººæ‰‹ä¸Šï¼Œæ­¤æ—¶å°±éœ€è¦æŒ‚èµ·ç­‰å¾…</li></ul><p>å‰é¢ä¸€ç›´å¼ºè°ƒï¼Œçº¿ç¨‹æ˜¯æœ‰è‡ªå·±ç‹¬ç«‹çš„æ ˆç»“æ„å’Œä¸Šä¸‹æ–‡æ•°æ®çš„ï¼Œåœ¨åŠ é”çš„è¿™éƒ¨åˆ†æ±‡ç¼–æ“ä½œä¸­ï¼ŒåŒæ ·å¯èƒ½ä¼šåœ¨ä»»ä½•åœ°æ–¹å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ã€‚åˆ‡æ¢çš„æ—¶å€™ï¼Œçº¿ç¨‹çš„<strong>ä¸Šä¸‹æ–‡æ•°æ®</strong>ï¼ˆå›¾ä¸­å¯„å­˜å™¨çš„çŠ¶æ€ï¼‰ä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼Œ<strong>éšè¿™ä¸ªçº¿ç¨‹ä¸€èµ·è¢«åˆ‡æ¢èµ°</strong></p><p>æ‰€ä»¥çº¿ç¨‹Aè¢«åˆ‡æ¢çš„æ—¶å€™ï¼Œå±äºå®ƒä¸Šä¸‹æ–‡ä¸­é‚£ä¸ªå€¼ä¸º1çš„alå¯„å­˜å™¨ä¹Ÿè¢«åˆ‡èµ°äº†ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œåˆ‡èµ°çš„æ˜¯æ•°æ®ï¼Œalå¯„å­˜å™¨æœ¬èº«ä½œä¸ºç¡¬ä»¶ï¼Œ<strong>æœ‰ä¸”åªæœ‰ä¸€ä¸ª</strong>ï¼‰</p><p>ç”±æ­¤çœ‹æ¥ï¼ŒçœŸæ­£è·å–é”çš„æ“ä½œï¼Œå…¶å®åªæœ‰<code>xchgb</code>ä¸€æ¡äº¤æ¢æŒ‡ä»¤æ¥å®Œæˆï¼Œ<font color="Red">ä¿è¯åŠ é”æ“ä½œåªç”±ä¸€æ¡æ±‡ç¼–è¯­å¥å®ç°</font>ï¼Œå°±èƒ½ä¿è¯è¯¥æ“ä½œçš„åŸå­æ€§ï¼</p><p>è§£é”çš„æ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œ<code>movb</code>å°†1å†™å›mutexå˜é‡å³å¯ï¼Œä¹Ÿæ˜¯ä¸€æ¡æ±‡ç¼–å®Œæˆï¼›è€Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè§£é”æ˜¯ä¸ä¼šæœ‰æ‰§è¡Œæµå’Œä½ æŠ¢çš„ã€‚</p><blockquote><p>å…¶å®åŠ é”è¿œä¸æ­¢ä¸€ç§æ–¹æ³•ï¼Œé”çš„ç§ç±»æœ‰éå¸¸å¤šï¼Œè¿˜æœ‰<strong>æ€»çº¿é”ã€æ—‹è½¬é”</strong>ç­‰ç­‰ï¼Œæ¯ä¸€ä¸ªé”çš„å®ç°éƒ½ä¸å¤ªä¸€æ ·ï¼ä¸Šé¢æåˆ°çš„ä¸º<code>äº’æ–¥é”</code></p></blockquote><h3 id="4-5-2-æ€»çº¿é”"><a href="#4-5-2-æ€»çº¿é”" class="headerlink" title="4.5.2 æ€»çº¿é”"></a>4.5.2 æ€»çº¿é”</h3><p>ç°åœ¨çš„CPUä¸€èˆ¬éƒ½æœ‰è‡ªå·±çš„å†…éƒ¨ç¼“å­˜ï¼Œæ ¹æ®ä¸€äº›è§„åˆ™å°†å†…å­˜ä¸­çš„æ•°æ®è¯»å–åˆ°å†…éƒ¨ç¼“å­˜ä¸­æ¥ï¼Œä»¥åŠ å¿«é¢‘ç¹è¯»å–çš„é€Ÿåº¦ã€‚ç°åœ¨æœåŠ¡å™¨é€šå¸¸æ˜¯å¤š CPUï¼Œæ›´æ™®éçš„æ˜¯ï¼Œæ¯å—CPUé‡Œæœ‰å¤šä¸ªå†…æ ¸ï¼Œè€Œæ¯ä¸ªå†…æ ¸éƒ½ç»´æŠ¤äº†è‡ªå·±çš„ç¼“å­˜ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¤šçº¿ç¨‹å¹¶å‘å°±ä¼šå­˜åœ¨ç¼“å­˜ä¸ä¸€è‡´æ€§ï¼Œè¿™ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜ã€‚</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202301031154743.webp" alt="img"></p><p>æ€»çº¿é”å°±æ˜¯å°†cpuå’Œå†…å­˜ä¹‹é—´çš„<strong>é€šä¿¡</strong>é”ä½ï¼Œä½¿å¾—åœ¨é”å®šæœŸé—´ï¼Œå…¶ä»–cpuå¤„ç†å™¨ä¸èƒ½æ“ä½œå…¶ä»–å†…å­˜ä¸­æ•°æ®ï¼Œæ•…æ€»çº¿é”å¼€é”€æ¯”è¾ƒå¤§ï¼</p><p>æ€»çº¿é”çš„å®ç°æ˜¯é‡‡ç”¨cpuæä¾›çš„<code>LOCK#</code>ä¿¡å·ï¼Œå½“ä¸€ä¸ªcpuåœ¨æ€»çº¿ä¸Šè¾“å‡ºæ­¤ä¿¡å·æ—¶ï¼Œå…¶ä»–cpuçš„è¯·æ±‚å°†è¢«é˜»å¡ï¼Œé‚£ä¹ˆè¯¥cpuåˆ™<strong>ç‹¬å å…±äº«å†…å­˜</strong>ï¼Œç›¸å½“äºé”ä½äº†</p><ul><li>ä½•ä¸ºæ€»çº¿ï¼Ÿ</li></ul><p>CPUæ€»çº¿æ˜¯æ‰€æœ‰CPUä¸èŠ¯ç‰‡ç»„è¿æ¥çš„ä¸»å¹²é“ï¼Œ<strong>è´Ÿè´£CPUä¸å¤–ç•Œæ‰€æœ‰éƒ¨ä»¶çš„é€šä¿¡</strong>ï¼ŒåŒ…æ‹¬é«˜é€Ÿç¼“å­˜ã€å†…å­˜ã€åŒ—æ¡¥ï¼Œå…¶æ§åˆ¶æ€»çº¿å‘å„ä¸ªéƒ¨ä»¶å‘é€æ§åˆ¶ä¿¡å·ã€é€šè¿‡åœ°å€æ€»çº¿å‘é€åœ°å€ä¿¡å·æŒ‡å®šå…¶è¦è®¿é—®çš„éƒ¨ä»¶ã€é€šè¿‡æ•°æ®æ€»çº¿åŒå‘ä¼ è¾“</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202301031153214.png" alt="image-20230103115306140"></p><h1 id="5-æ­»é”"><a href="#5-æ­»é”" class="headerlink" title="5.æ­»é”"></a>5.æ­»é”</h1><p>æ­»é”å°±æ˜¯ä¸€ç§å› ä¸ºä¸¤æ”¾éƒ½ä¸ä¼šé‡Šæ”¾å¯¹æ–¹éœ€è¦çš„èµ„æºï¼Œä»è€Œé™·å…¥çš„æ°¸ä¹…ç­‰å¾…çŠ¶æ€</p><h2 id="5-1-æ­»é”æƒ…å†µæ¼”ç¤º"><a href="#5-1-æ­»é”æƒ…å†µæ¼”ç¤º" class="headerlink" title="5.1 æ­»é”æƒ…å†µæ¼”ç¤º"></a>5.1 æ­»é”æƒ…å†µæ¼”ç¤º</h2><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¼ ä¸‰æ‹¿äº†é”Aï¼Œç”³è¯·é”Bçš„æ—¶å€™ï¼Œå‘ç°é”Bæ— æ³•ç”³è¯·ï¼Œè€Œè¿›å…¥ç­‰å¾…ï¼›æå››æ‹¿äº†é”Bï¼Œæ¥ä¸‹æ¥ä»–æƒ³ç”³è¯·é”Aï¼Œç»“æœå‘ç°å¼ ä¸‰æ‹¿ç€é”Aï¼Œé‚£å°±åªèƒ½è¿›å…¥ç­‰å¾…ã€‚è¿™å°±é™·å…¥äº†ä¸€ä¸ªåƒµå±€ï¼Œå¼ ä¸‰æƒ³è¦æå››çš„ï¼Œæå››æƒ³è¦å¼ ä¸‰çš„ï¼Œè°éƒ½ä¸è®©è°</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> m1;<span class="comment">//é”1</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> m2;<span class="comment">//é”2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;m2,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func1,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func2,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ†ç¦»</span></span><br><span class="line">    <span class="built_in">pthread_detach</span>(t1);</span><br><span class="line">    <span class="built_in">pthread_detach</span>(t2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;main running...&quot;</span> &lt;&lt;endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m1);</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;m2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™ä¸ªä»£ç ä¾¿èƒ½æ¨¡æ‹Ÿå‡ºè¿™ä¸ªæƒ…å†µï¼Œçº¿ç¨‹1å…ˆè¦äº†é”1ï¼Œå†è¦é”2ï¼›çº¿ç¨‹2å…ˆè¦é”2å†è¦é”1ï¼Œä»–ä»¬ä¿©å°±å®¹æ˜“æ‰“èµ·æ¥ï¼Œé€ æˆæ­»é”ã€‚</p><p>è¿è¡Œä»£ç çš„æ—¶å€™æˆ‘ä»¬å´å‘ç°ï¼Œä¼¼ä¹å¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œçº¿ç¨‹1å¥½åƒè¿˜æ˜¯æˆåŠŸæ‹¿åˆ°äº†ä¿©æŠŠé”ï¼Œå¹¶è¿è¡Œäº†èµ·æ¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-23_çº¿ç¨‹æ­»é”]$ ./test</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br><span class="line">func1 is running... t1</span><br><span class="line">main running...</span><br></pre></td></tr></table></figure><p>é‚£æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ‰§è¡Œå…¶ä»–ä¸€äº›å·¥ä½œï¼Œä»è€Œå°†çº¿ç¨‹1å’Œ2ç”³è¯·é”çš„æ—¶é—´é”™å¼€</p><p>å°†ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·ï¼Œåˆ©ç”¨<code>usleep</code>è®©ä¸¤ä¸ªçº¿ç¨‹ä¼‘çœ ä¸åŒæ—¶é—´ï¼Œç»“æœå°±ä¸åŒäº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func1</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">200</span>);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func1 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func2</span><span class="params">(<span class="type">void</span>*arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m2);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">300</span>);</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;m1);</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;func2 is running... &quot;</span> &lt;&lt;(<span class="type">const</span> <span class="type">char</span>*)arg&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m1);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;m2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶åªæœ‰ä¸»çº¿ç¨‹åœ¨è¿è¡Œï¼Œçº¿ç¨‹t1å’Œt2å‡ºç°äº†æ­»é”ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-23_çº¿ç¨‹æ­»é”]$ ./test</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br><span class="line">main running...</span><br></pre></td></tr></table></figure><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202211031204889.jpg" alt="QQå›¾ç‰‡20220519220428"></p><h2 id="5-2-æ­»é”çš„æ¡ä»¶"><a href="#5-2-æ­»é”çš„æ¡ä»¶" class="headerlink" title="5.2 æ­»é”çš„æ¡ä»¶"></a>5.2 æ­»é”çš„æ¡ä»¶</h2><ul><li>äº’æ–¥æ¡ä»¶ï¼šæŸä»½èµ„æºåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªæ‰§è¡Œæµè®¿é—®</li><li>è¯·æ±‚ä¸ä¿æŒï¼šä¸€ä¸ªæ‰§è¡Œæµå› è¯·æ±‚æŸç§èµ„æºè¿›å…¥é˜»å¡ç­‰å¾…ï¼Œè€Œä¸é‡Šæ”¾è‡ªå·±çš„èµ„æºï¼ˆå¥½æ¯”ä¸Šé¢ä»£ç ä¾‹å­ä¸­ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¸é‡Šæ”¾è‡ªå·±çš„é”ï¼Œåˆæƒ³è¦åˆ«äººçš„é”ï¼‰</li><li>ä¸å‰¥å¤ºæ¡ä»¶ï¼šä¸€ä¸ªæ‰§è¡Œæµå·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨ä¹‹å‰ä¸èƒ½è¢«å‰¥å¤ºï¼ˆéƒ¨åˆ†é”æ˜¯å…è®¸è¢«å‰¥å¤ºçš„ï¼‰</li><li>å¾ªç¯ç­‰å¾…ï¼šè‹¥å¹²æ‰§è¡Œæµä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºçš„çŠ¶æ€</li></ul><p>ä¸€æŠŠé”ä¹Ÿèƒ½é€ æˆæ­»é”å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_lock(&amp;m1);</span><br><span class="line">pthread_mutex_lock(&amp;m1);</span><br><span class="line"><span class="comment">//ä¸¤æ¬¡ç”³è¯·åŒä¸€æŠŠé”</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰äººå†™å‡ºè¿™ç§bugä»£ç ï¼Œé‚£å°±ä¼šå‡ºç°ä¸€æŠŠé”æŠŠè‡ªå·±æ­»é”äº†ï¼›æ­»é”æœ¬æ¥å°±æ˜¯ä»£ç çš„bugï¼Œæ‰€ä»¥è¿™ç§ä½çº§é”™è¯¯ä¹Ÿæ˜¯æ­»é”çš„æƒ…å†µä¹‹ä¸€ğŸ˜‚</p><h2 id="5-3-é¿å…æ­»é”"><a href="#5-3-é¿å…æ­»é”" class="headerlink" title="5.3 é¿å…æ­»é”"></a>5.3 é¿å…æ­»é”</h2><p>é¿å…æ­»é”ï¼Œå…¶ä¸­æœ€ç®€å•æ˜äº†çš„åŠæ³•ï¼Œå°±æ˜¯ç ´åä¸Šé¢æåˆ°çš„æ­»é”çš„4ä¸ªæ¡ä»¶ï¼›å…¶ä¸­äº’æ–¥æ¡ä»¶æ²¡å•¥å¥½åŠæ³•ç ´åï¼ˆé™¤éä½ ä¸åŠ é”ï¼‰ï¼Œæ›´ä¸»è¦çš„æ˜¯çœ‹å¦å¤–3ä¸ªæ¡ä»¶æ˜¯å¦èƒ½ç ´åï¼</p><ul><li>ä¿æŒåŠ é”é¡ºåºä¸€è‡´ï¼šä¸è¦å‡ºç°ä¸Šé¢ä»£ç ä¸­çš„çº¿ç¨‹aå…ˆç”³è¯·é”1ï¼Œçº¿ç¨‹bå…ˆç”³è¯·é”2çš„æƒ…å†µã€‚åœ¨ä¸åŒçš„æ‰§è¡Œæµä¸­ï¼ŒæŒ‰ç›¸åŒçš„é¡ºåºç”³è¯·é”ï¼ˆæ¯”å¦‚çº¿ç¨‹aå’Œbéƒ½æ˜¯æŒ‰é”1&#x2F;2çš„é¡ºåºç”³è¯·çš„ï¼‰ä¸€å®šç¨‹åº¦ä¸Šèƒ½ç ´å<code>è¯·æ±‚ä¸ä¿æŒ</code>æ¡ä»¶</li><li>é™ä½åŠ é”çš„ç²’åº¦ï¼šé”ä¿æŠ¤çš„åŒºåŸŸå˜å°ï¼ŒåŠ é”çš„ç²’åº¦å‡å°ï¼Œèƒ½ä¸€å®šç¨‹åº¦ä¸Šé¿å…é”æœªé‡Šæ”¾</li><li>èµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼šå‡å°‘ä¸´æ—¶èµ„æºåˆ†å¼€ç»™çš„æƒ…å†µ</li><li>å…è®¸æŠ¢å ï¼šçº¿ç¨‹ä¹‹é—´ä¾é ä¼˜å…ˆçº§æŠ¢å¤ºé”ï¼Œè¿™ç§æƒ…å†µå°±æ˜¯<strong>é”å…è®¸è¢«å‰¥å¤º</strong></li></ul><hr><h1 id="6-çº¿ç¨‹å®‰å…¨"><a href="#6-çº¿ç¨‹å®‰å…¨" class="headerlink" title="6.çº¿ç¨‹å®‰å…¨"></a>6.çº¿ç¨‹å®‰å…¨</h1><p>çº¿ç¨‹å®‰å…¨ï¼šå¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡ŒåŒä¸€æ®µä»£ç çš„æ—¶å€™ï¼Œ<strong>ä¸ä¼š</strong>å‡ºç°ä¸åŒçš„ç»“æœ</p><p>çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µï¼š</p><ul><li>ä¸ä¿æŠ¤ä¸´ç•Œèµ„æº</li><li>åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­è°ƒç”¨<strong>ä¸å¯é‡å…¥</strong>å‡½æ•°ï¼ˆæ¦‚å¿µè§<a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/muxuen/article/details/128138012?spm=1001.2014.3001.5502">linuxä¿¡å·<i class="fas fa-external-link-alt"></i></a>éƒ¨åˆ†ï¼‰</li><li>è¿”å›æŒ‡å‘é™æ€å˜é‡çš„æŒ‡é’ˆçš„å‡½æ•°</li></ul><p>çº¿ç¨‹å®‰å…¨ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹åªæ“ä½œå±€éƒ¨å˜é‡ï¼Œæˆ–è€…åªå¯¹å…¨å±€ã€é™æ€å˜é‡åªè¯»ä¸å†™</li><li>æ¥å£å¯¹çº¿ç¨‹æ¥è¯´æ˜¯åŸå­æ“ä½œï¼ˆè¢«é”ä¿æŠ¤ï¼‰</li><li>å¤šä¸ªçº¿ç¨‹åˆ‡æ¢ä¸ä¼šä½¿å‡½æ•°æ¥å£çš„ç»“æœå‡ºç°<strong>äºŒä¹‰æ€§</strong></li><li>å¤šçº¿ç¨‹æ“ä½œä¸è°ƒç”¨ä¸å¯é‡å…¥å‡½æ•°</li></ul><p>æ³¨æ„ï¼Œç»å¤§å¤šæ•°çš„ç³»ç»Ÿè‡ªå¸¦çš„åº“ï¼ˆæ¯”å¦‚C++çš„STLåº“ï¼‰éƒ½æ˜¯<strong>ä¸å¯é‡å…¥</strong>çš„</p><p><img lazyload alt="image" data-src="https://img1.musnow.top/i/2023/02/202212241021973.jpeg" alt="QQå›¾ç‰‡20220512164211"></p><p>ä¸å¯é‡å…¥æ˜¯å‡½æ•°çš„ä¸€ç§<strong>æ€§è´¨</strong>ï¼Œå¹¶ä¸æ˜¯å®ƒçš„ç¼ºç‚¹ï¼å¦‚æœä¸€ä¸ªåº“å‡½æ•°æ˜æ˜å‘ŠçŸ¥ä½ äº†æˆ‘æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä½ è¿˜ä¸åŠ ä¿æŠ¤çš„åœ¨å¤šçº¿ç¨‹æ“ä½œä¸­è°ƒç”¨å®ƒï¼Œ<strong>é‚£ä¹ˆè¿™æ®µä»£ç æ˜¯æœ‰bugçš„</strong>ï¼Œå¹¶ä¸æ˜¯åº“å‡½æ•°æœ¬èº«æœ‰é—®é¢˜</p></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">æœ¬æ–‡æ ‡é¢˜</span>ï¼š<span class="content">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | äº’æ–¥</span></li><li class="post-author"><span class="type">æœ¬æ–‡ä½œè€…</span>ï¼š<span class="content">æ…•é›ªå¹´å</span></li><li class="post-time"><span class="type">åˆ›å»ºæ—¶é—´</span>ï¼š<span class="content">2022-12-23 16:30:16</span></li><li class="post-link"><span class="type">æœ¬æ–‡é“¾æ¥</span>ï¼š<span class="content">2022/12/23/Linux/19çº¿ç¨‹äº’æ–¥/</span></li><li class="post-license"><span class="type">ç‰ˆæƒå£°æ˜</span>ï¼š<span class="content">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="å¤åˆ¶ç‰ˆæƒä¿¡æ¯" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E7%BA%BF%E7%A8%8B/">#çº¿ç¨‹</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2022/12/23/blog/%E5%8D%9A%E5%AE%A2%E8%A1%A8%E6%83%85%E5%8C%85/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">ã€å›¾åºŠã€‘åšå®¢è¡¨æƒ…åŒ…</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2022/12/11/nas/8%E7%89%B9%E6%AE%8A%E5%9F%BA%E6%9C%AC%E5%90%8D%E8%AF%8D%E7%9A%84%E8%A7%A3%E9%87%8A/"><span class="title flex-center"><span class="post-nav-title-item">ã€Nasã€‘ä¸€äº›æ—¥å¿—è®°å½•</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;è¯„è®º</div><div class="waline-comment-container"><link rel="stylesheet" href="/css/my/waline.css"><link rel="stylesheet" href="/css/my/waline-meta.css"><script data-pjax src="/css/my/waline.js"></script><div id="waline-comment"></div><script data-pjax>function loadWaline() {
            Waline.init({
              el: '#waline-comment',
              serverURL: 'https://waline.musnow.top/',
              lang: 'zh-CN' || 'zh-CN',
              comment: '.post-comments-count',
              reaction: 'false' === 'true',
              requiredMeta: ['nick','mail'] 
            })
          }

          if ('true' === 'true') {
            setTimeout(() => {
              loadWaline()
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadWaline)
          }</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E7%BA%BF%E7%A8%8B%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">1.çº¿ç¨‹çš„æ¦‚å¿µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%89%A7%E8%A1%8C%E6%B5%81"><span class="nav-text">1.1 æ‰§è¡Œæµ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%97%B6%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">1.2 çº¿ç¨‹åˆ›å»ºæ—¶åšäº†ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0"><span class="nav-text">1.3 å†…æ ¸æºç ä¸­çš„ä½“ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E7%BA%BF%E7%A8%8B%E7%9A%84%E7%A7%81%E6%9C%89%E7%89%A9"><span class="nav-text">1.4 çº¿ç¨‹çš„ç§æœ‰ç‰©</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-%E7%BA%BF%E7%A8%8B%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">1.5 çº¿ç¨‹ä¼˜ç¼ºç‚¹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-1-%E7%BC%BA%E7%82%B9"><span class="nav-text">1.5.1 ç¼ºç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-2-%E4%BC%98%E7%82%B9"><span class="nav-text">1.5.2 ä¼˜ç‚¹</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%9F%BA%E7%A1%80%E5%87%BD%E6%95%B0"><span class="nav-text">2.åŸºç¡€å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-pthread-create"><span class="nav-text">2.1 pthread_create</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-pthread-join"><span class="nav-text">2.2 pthread_join</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E5%9F%BA%E7%A1%80%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="nav-text">2.2.1 åŸºç¡€çš„å¤šçº¿ç¨‹æ“ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-C-%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="nav-text">2.2.2 C++çš„å¤šçº¿ç¨‹æ“ä½œ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E7%BA%BF%E7%A8%8B%E9%80%80%E5%87%BA"><span class="nav-text">2.3 çº¿ç¨‹é€€å‡º</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-retval"><span class="nav-text">2.3.1 retval</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-pthread-exit"><span class="nav-text">2.3.2 pthread_exit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-ptrhead-cancel"><span class="nav-text">2.3.3 ptrhead_cancel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-4-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%9B%E7%A8%8B%E9%80%80%E5%87%BA%E4%B8%8D%E4%BC%9A%E5%90%91%E4%B8%BB%E8%BF%9B%E7%A8%8B%E5%8F%91%E9%80%81%E4%BF%A1%E5%8F%B7%EF%BC%9F"><span class="nav-text">2.3.4 ä¸ºä»€ä¹ˆè¿›ç¨‹é€€å‡ºä¸ä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¿¡å·ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-5-exit"><span class="nav-text">2.3.5 exit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-pthread-detach"><span class="nav-text">2.4 pthread_detach</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E5%AE%9E%E6%93%8D"><span class="nav-text">2.4.1 å®æ“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-detach%E5%90%8Ejoin"><span class="nav-text">2.4.2 detachåjoin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E7%BA%BF%E7%A8%8B%E5%88%86%E7%A6%BB%E5%90%8E%EF%BC%8C%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%85%88%E9%80%80%E5%87%BA"><span class="nav-text">2.4.3 çº¿ç¨‹åˆ†ç¦»åï¼Œä¸»çº¿ç¨‹å…ˆé€€å‡º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-gettid-x2F-syscall"><span class="nav-text">2.5 gettid&#x2F;syscall</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-text">3.ç›¸å…³æ¦‚å¿µ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E7%BA%BF%E7%A8%8Bid%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-text">3.1 çº¿ç¨‹idæ˜¯ä»€ä¹ˆï¼Ÿ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-pthread%E5%BA%93"><span class="nav-text">3.2 pthreadåº“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8"><span class="nav-text">3.3 çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E7%BA%BF%E7%A8%8B%E4%BA%92%E6%96%A5%E9%97%AE%E9%A2%98"><span class="nav-text">4.çº¿ç¨‹äº’æ–¥é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E4%B8%B4%E7%95%8C%E8%B5%84%E6%BA%90"><span class="nav-text">4.1 ä¸´ç•Œèµ„æº</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%8E%9F%E5%AD%90-x2F-%E4%BA%92%E6%96%A5%E6%80%A7"><span class="nav-text">4.2 åŸå­&#x2F;äº’æ–¥æ€§</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E7%BA%BF%E7%A8%8B%E5%8A%A0%E9%94%81"><span class="nav-text">4.3 çº¿ç¨‹åŠ é”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-pthread-mutex-init"><span class="nav-text">4.3.1 pthread_mutex_init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E5%8A%A0%E9%94%81-x2F-%E8%A7%A3%E9%94%81"><span class="nav-text">4.3.2 åŠ é”&#x2F;è§£é”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E5%8A%A0%E9%94%81%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">4.3.3 åŠ é”çš„æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E7%A4%BA%E4%BE%8B-%E5%80%92%E6%B0%B4%E9%97%AE%E9%A2%98"><span class="nav-text">4.4 ç¤ºä¾‹-å€’æ°´é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%9C%A8%E5%B7%A5%E4%BD%9C%EF%BC%9F"><span class="nav-text">4.4.1 åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E5%8A%A0%E9%94%81-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="nav-text">4.4.2 åŠ é”-é—®é¢˜è§£å†³</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-%E5%8A%A0%E9%94%81%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E8%A7%A3%E9%87%8A"><span class="nav-text">4.5 åŠ é”çš„è¿›ä¸€æ­¥è§£é‡Š</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-1-%E5%8A%A0%E9%94%81%E5%8E%9F%E5%AD%90%E6%80%A7%E7%9A%84%E4%BF%9D%E8%AF%81"><span class="nav-text">4.5.1 åŠ é”åŸå­æ€§çš„ä¿è¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-2-%E6%80%BB%E7%BA%BF%E9%94%81"><span class="nav-text">4.5.2 æ€»çº¿é”</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E6%AD%BB%E9%94%81"><span class="nav-text">5.æ­»é”</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E6%AD%BB%E9%94%81%E6%83%85%E5%86%B5%E6%BC%94%E7%A4%BA"><span class="nav-text">5.1 æ­»é”æƒ…å†µæ¼”ç¤º</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E6%AD%BB%E9%94%81%E7%9A%84%E6%9D%A1%E4%BB%B6"><span class="nav-text">5.2 æ­»é”çš„æ¡ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="nav-text">5.3 é¿å…æ­»é”</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8"><span class="nav-text">6.çº¿ç¨‹å®‰å…¨</span></a></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/about">æ…•é›ªå¹´å</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="timerun-info info-item"><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/16/2022 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="å·²å‹‰å¼ºè¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" æ—¶ "+mnum+" åˆ† "+snum+" ç§’"}setInterval("createtime()",250)</script></div><div class="shields-info info-item"><a href="https://www.foreverblog.cn/go.html" target="_blank"><img src="https://img.foreverblog.cn/wormhole_3_tp.gif" height="20px"> </a><a href="https://github.com/XPoet/hexo-theme-keep" target="_blank"><img src="https://img.shields.io/badge/hexo-keep-blue" height="20px"> </a><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054-ff69b4" height="20px"> </a><a href="https://beian.miit.gov.cn/" target="_blank"><img src="https://img.shields.io/badge/%E7%B2%A4ICP%E5%A4%87-2023007189%E5%8F%B7-red" height="20px"> </a><a href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" target="_blank"><img src="/images/UPYUN-CDN.png" height="20px"></a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item rss flex-center"><a class="flex-center" href="/atom.xml" target="_blank"><i class="fas fa-rss"></i></a></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="arrow-up fas fa-arrow-up"></i> <span class="percent"></span></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });</script><script type="text/javascript" src="/js/snow.js"></script></body></html>