<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="Hexo Theme Keep"><meta name="author" content="æ…•é›ªå¹´å"><meta name="referrer" content="no-referrer"><title>ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | åŒæ­¥ | æ…•é›ªçš„å¯’èˆ</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/myPNG.jpg"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/fontawesome.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/regular.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/solid.min.css"><link rel="stylesheet" href="//unpkg.com/hexo-theme-keep@3.6.1/source/font/css/brands.min.css"><script id="hexo-configurations">let KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"blog.outpost54.top","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/myPNG.jpg","favicon":"/images/myPNG.jpg","avatar":"/images/myPNG.jpg","font_size":null,"font_family":null,"left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"header_transparent":false,"background_img":"https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/MainBG.jpg","background_post_img":"https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/mothra.png","description":"å¾å¿ƒå¦‚ä¸€ï¼Œæ…•é›ªçº·çº·","font_color":null,"hitokoto":true},"scroll":{"progress_bar":true,"percent":false}},"local_search":{"enable":true,"preload":true},"code_copy":{},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"side_tools":{},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"waline","valine":{"appid":"Qe4QleZhY3IMzI6EMSokgLGZ-MdYXbMMI","appkey":"TPXkCvMB9gw8xBObFcDaLiGc","server_urls":"lecd.outpost54.top","placeholder":"æ¬¢è¿ç•™ä¸‹ä½ çš„å£°éŸ³ğŸ˜‹"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.8"},"waline":{"server_url":"https://vrcl.outpost54.top/","reaction":false,"version":2}},"post":{"author_label":{"enable":false,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":false},"img_align":"center","copyright_info":true},"version":"3.6.1"}
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"}
    KEEP.language_code_block = {"copy":"å¤åˆ¶ä»£ç ","copied":"å·²å¤åˆ¶","fold":"æŠ˜å ä»£ç å—","folded":"å·²æŠ˜å "}
    KEEP.language_copy_copyright = {"copy":"å¤åˆ¶ç‰ˆæƒä¿¡æ¯","copied":"å·²å¤åˆ¶","title":"åŸæ–‡æ ‡é¢˜","author":"åŸæ–‡ä½œè€…","link":"åŸæ–‡é“¾æ¥"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"><meta name="generator" content="Hexo 6.2.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/myPNG.jpg"> </a><a class="logo-title" href="/">æ…•é›ªçš„å¯’èˆ</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">é¦–é¡µ</a></li><li class="menu-item"><a href="/archives">å½’æ¡£</a></li><li class="menu-item"><a href="/categories">åˆ†ç±»</a></li><li class="menu-item"><a href="/tags">æ ‡ç­¾</a></li><li class="menu-item"><a href="/QA">ç•™è¨€æ¿</a></li><li class="menu-item"><a href="/links">å‹é“¾</a></li><li class="menu-item"><a href="/about">å…³äº</a></li><li class="menu-item"><a target="_blank" rel="noopener" href="https://www.travellings.cn/go.html">ğŸš‰</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">é¦–é¡µ</a></li><li class="drawer-menu-item flex-center"><a href="/archives">å½’æ¡£</a></li><li class="drawer-menu-item flex-center"><a href="/categories">åˆ†ç±»</a></li><li class="drawer-menu-item flex-center"><a href="/tags">æ ‡ç­¾</a></li><li class="drawer-menu-item flex-center"><a href="/QA">ç•™è¨€æ¿</a></li><li class="drawer-menu-item flex-center"><a href="/links">å‹é“¾</a></li><li class="drawer-menu-item flex-center"><a href="/about">å…³äº</a></li><li class="drawer-menu-item flex-center"><a target="_blank" rel="noopener" href="https://www.travellings.cn/go.html">ğŸš‰</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="post-page-container"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | åŒæ­¥</span></div><div class="article-header"><div class="avatar"><img src="/images/myPNG.jpg"></div><div class="info"><div class="author"><span class="name">æ…•é›ªå¹´å</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-calendar-plus"></i>&nbsp; <span class="pc">2022-12-30 17:30:16</span> <span class="mobile">2022-12-30 17:30</span> </span><span class="article-update-date article-meta-item"><i class="fas fa-file-pen"></i>&nbsp; <span class="pc">2023-01-10 13:07:29</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/%E7%8E%A9%E4%B8%8ALinux/">ç©ä¸ŠLinux</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/Linux/">Linux</a>&nbsp;</li><li>| <a href="/tags/%E7%BA%BF%E7%A8%8B/">çº¿ç¨‹</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fas fa-file-word"></i>&nbsp;<span>4.6k å­—</span> </span><span class="article-pv article-meta-item"><i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content keep-markdown-body"><p>é™¤äº†çº¿ç¨‹äº’æ–¥ï¼Œæˆ‘ä»¬è¿˜æœ‰çº¿ç¨‹åŒæ­¥ï¼Œæ¥åº·åº·å§</p><span id="more"></span><p>[TOC]</p><h1 id="1-ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥"><a href="#1-ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥" class="headerlink" title="1.ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥"></a>1.ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥</h1><p>åœ¨éƒ¨åˆ†æ¡ä»¶ä¸‹ï¼Œäº’æ–¥æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯ä¸åˆç†ã€‚æ¯”å¦‚é£Ÿå ‚æ‰“é¥­çš„æ—¶å€™ï¼Œé£Ÿå ‚é˜¿å§¨ä¸€æ¬¡åªèƒ½ç»™ä¸€ä¸ªäººæ‰“é¥­ï¼Œäºæ˜¯å°±é€‰æ‹©é€šè¿‡ç«äº‰æ¥è·å¾—æ‰“é¥­çš„æƒåˆ©ã€‚æ­¤æ—¶å°±ä¼šå‡ºç°æœ‰äº›çº¿ç¨‹å› ä¸ºä¼˜å…ˆçº§è¿‡ä½æˆ–è€…CPUè°ƒåº¦é—®é¢˜ï¼Œä¸€ç›´æ‰“ä¸åˆ°é¥­ï¼Œäºæ˜¯å°±å‡ºç°äº†<strong>é¥¥é¥¿é—®é¢˜</strong>ã€‚</p><p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¯¹å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªèµ„æºæ²¡æœ‰è¿›è¡Œé™åˆ¶ï¼Œå…¨é CPUè°ƒåº¦æ¥å†³å®šè¿è¡Œé¡ºåºï¼›æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹çº¿ç¨‹è¿›è¡Œä¸€å®šçš„æ§åˆ¶ï¼Œè¿™å°±æ˜¯<strong>çº¿ç¨‹åŒæ­¥</strong>çš„æ¦‚å¿µ</p><ul><li>é¥¥é¥¿é—®é¢˜ï¼šæŸä¸€ä¸ªçº¿ç¨‹ä¸€ç›´æ— æ³•ç”³è¯·åˆ°æŸç§èµ„æºï¼ˆæ¯”å¦‚å› ä¸ºä¼˜å…ˆçº§è¿‡ä½ï¼‰</li><li>åŒæ­¥ï¼šä¿è¯æ•°æ®å®‰å…¨ï¼ˆä¸´ç•Œèµ„æºè®¿é—®ï¼‰çš„å‰æä¸‹ï¼Œè®©çº¿ç¨‹æ ¹æ®ä¸€å®šæ¡ä»¶å’Œé¡ºåºè®¿é—®ä¸´ç•Œèµ„æºï¼Œä»è€Œé¿å…é¥¥é¥¿é—®é¢˜</li><li>ç«æ€æ¡ä»¶ï¼šå› ä¸ºæ—¶åºé—®é¢˜ï¼ˆCPUè°ƒåº¦ï¼‰è€Œå¯¼è‡´ç¨‹åºå¼‚å¸¸ï¼›</li></ul><h1 id="2-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹"><a href="#2-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹" class="headerlink" title="2.ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹"></a>2.ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹</h1><p>è¿™ä¸ªæ¨¡å‹å…¶å®å¾ˆç®€å•ï¼Œæ¶ˆè´¹è€…å»è¶…å¸‚è´­ä¹°ä¸œè¥¿ï¼Œç”Ÿäº§è€…æŠŠå•†å“æŠ•æ”¾åˆ°è¶…å¸‚ä¸­ã€‚</p><ul><li>è¿™æ—¶å€™å°±ä¸éœ€è¦æ¶ˆè´¹è€…ç›´æ¥å»æ‰¾å·¥å‚é—®ä»–xxä¸œè¥¿åˆæ²¡æœ‰ç”Ÿäº§ï¼Œä»–éœ€è¦è´­ä¹°ï¼›è€Œæ˜¯è½¬å»è¶…å¸‚é‡Œé¢è´­ä¹°xxä¸œè¥¿ï¼›</li><li>å¦‚æœxxä¸œè¥¿æ²¡æœ‰è´§äº†ï¼Œè¶…å¸‚å°±ä¼šé€šçŸ¥ç”Ÿäº§è€…è¿›è¡Œè¡¥è´§ã€‚å¦‚æœè¶…å¸‚é‡Œé¢çš„è´§æ¶å·²ç»æ»¡äº†ï¼Œå°±é€šçŸ¥ç”Ÿäº§è€…ä¸éœ€è¦ç»§ç»­ç”Ÿäº§äº†ï¼›</li><li>å½“å•†å“æ²¡è´§äº†ï¼Œè¶…å¸‚ä¼šå‘ŠçŸ¥æ¶ˆè´¹è€…è¿™ä¸ªä¸œè¥¿æ²¡è´§ï¼Œæ¶ˆè´¹è€…ä¼šåœæ­¢æ¶ˆè´¹è¡Œä¸ºï¼›è€Œç”Ÿäº§è€…è¡¥è´§äº†ä¹‹åï¼Œè¶…å¸‚å°±ä¼šé€šçŸ¥æ¶ˆè´¹è€…è®©ä»–æ¥è´­ä¹°</li></ul><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202301031841235.png" alt="image-20230103184124025"></p><p>åœ¨åŸºç¡€æ¨¡å¼ä¸­ï¼Œæ¶ˆè´¹è€…è¦æƒ³çŸ¥é“ä¸€ä¸ªä¸œè¥¿æœ‰æ²¡æœ‰è´§ï¼Œéœ€è¦å»è¶…å¸‚é‡Œé¢çœ‹ï¼ˆç›¸å½“äºè½®å¾ªæ£€æµ‹ï¼‰</p><p>æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€ä¸ª<strong>é€šçŸ¥æ–¹å¼</strong>ï¼Œæ¯”å¦‚è¶…å¸‚å¼€æ”¾ä¸€ä¸ªå¾®ä¿¡å…¬ä¼—å·ï¼Œå‘ŠçŸ¥æ¶ˆè´¹è€…xxç‰©å“æ˜¯å¦æœ‰è´§ï¼Œä»¥åŠå‘ŠçŸ¥æ¶ˆè´¹è€…ä»€ä¹ˆæ—¶å€™éœ€è¦è¡¥è´§ï¼Œæ­¤æ—¶å°±ä¸éœ€è¦æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…<strong>ä¸æ–­è¯¢é—®</strong>è¶…å¸‚å…³äºä¸€ä¸ªå•†å“çš„æƒ…å†µäº†ï¼è¿™å°±ç›¸å½“äº<code>çº¿ç¨‹åŒæ­¥</code>ï¼</p><h2 id="2-1-ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»"><a href="#2-1-ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»" class="headerlink" title="2.1 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»"></a>2.1 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»</h2><p>ä¸‹é¢æåˆ°çš„æ˜¯æ™®é€‚æƒ…å†µ</p><ul><li>æ¶ˆè´¹è€…æœ‰å¤šä¸ªï¼Œä»–ä»¬ä¹‹é—´æ˜¯ç«äº‰å…³ç³»ï¼ˆäº’æ–¥ï¼‰ç«äº‰å•†å“çš„è´­ä¹°</li><li>ç”Ÿäº§è€…æœ‰å¤šä¸ªï¼Œä»–ä»¬ä¹‹é—´æ˜¯ç«äº‰å…³ç³»ï¼ˆäº’æ–¥ï¼‰ç«äº‰è¶…å¸‚çš„è´§æ¶</li><li>æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…ä¹‹é—´ï¼Œæ—¢æœ‰äº’æ–¥å…³ç³»ï¼Œä¹Ÿæ˜¯åŒæ­¥å…³ç³»ï¼ˆéœ€è¦ç”Ÿäº§è€…ä¾›è´§äº†ä¹‹åï¼Œæ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹ï¼‰è¿™ä¸¤ä¸ªå…³ç³»å¹¶ä¸å†²çªï¼</li></ul><p>é™¤äº†ä¸Šé¢æåˆ°çš„<strong>3ç§ç”Ÿäº§å…³ç³»</strong>ï¼Œè¿˜æœ‰ä¸‹é¢ä¿©ç‚¹</p><p>åœ¨å®é™…ç¨‹åºä¸­ï¼Œæ¶ˆè´¹è€…å’Œç”Ÿäº§è€…éƒ½æ˜¯ç”±çº¿ç¨‹æ‰¿æ‹…çš„ï¼ˆ<strong>2ç§è§’è‰²</strong>ï¼‰</p><p>è¶…å¸‚æ˜¯å†…å­˜ä¸­ç‰¹å®šçš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¹Ÿæ˜¯ä¸´ç•Œèµ„æºï¼ˆ<strong>1ä¸ªäº¤æ˜“åœºæ‰€</strong>ï¼‰</p><blockquote><p>æˆ‘ä»¬å¯ä»¥ç”¨<strong>321åŸåˆ™</strong>æ¥å¿«é€Ÿè®°ä½è¿™å‡ æ¡ï¼Œè¿™æ ·å°±è®°ä½äº†ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼ğŸ‘</p></blockquote><h2 id="2-2-ä»¥ç®€å•ä»£ç ä¸ºä¾‹"><a href="#2-2-ä»¥ç®€å•ä»£ç ä¸ºä¾‹" class="headerlink" title="2.2 ä»¥ç®€å•ä»£ç ä¸ºä¾‹"></a>2.2 ä»¥ç®€å•ä»£ç ä¸ºä¾‹</h2><p>åœ¨æ—§æ¨¡å¼ä¸­ï¼Œmainå‡½æ•°è°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œæƒ³è·å¾—è¿”å›å€¼ï¼Œéœ€è¦ç­‰è¿™ä¸ªå‡½æ•°è¿è¡Œå®Œæ¯•ï¼›å¥½æ¯”æ¶ˆè´¹è€…è´­ä¹°ä¸œè¥¿ï¼Œéœ€è¦å»æ‰¾å‚å®¶å¹¶ç­‰å¾…å‚å®¶ç”Ÿäº§â€¦â€¦</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202301031903172.png" alt="image-20230103190310130"></p><p>è€Œåœ¨ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œmainä½œä¸ºä¸»çº¿ç¨‹ï¼Œåªéœ€è¦æŠŠå¾…å¤„ç†çš„æ•°æ®ä¸¢è¿›ç¼“å†²åŒºï¼›è€Œçº¿ç¨‹Bä»ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®ï¼Œå¤„ç†å®Œæ¯•åæ”¾å›ç¼“å†²åŒºã€‚mainå¯ä»¥å…ˆæ‰§è¡Œå…¶ä»–ä»£ç ï¼Œè¿‡ä¸€ä¼šå†è¿‡æ¥æ‹¿çº¿ç¨‹Bå¤„ç†å¥½çš„ç»“æœã€‚</p><p>è¿™å°±å®ç°äº†<strong>ç”Ÿäº§å’Œæ¶ˆè´¹çš„è§£è€¦</strong>ï¼</p><p><img lazyload alt="image" data-src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/img1/202301031904159.png" alt="image-20230103190405101"></p><hr><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¦è§£å†³ä¸‹é¢è¿™äº›é—®é¢˜ğŸ˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.å¦‚ä½•è®©å¤šä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…å‘¢?åˆå¦‚ä½•è®©æ¶ˆè´¹è€…çº¿ç¨‹è¢«å”¤é†’å‘¢?</span><br><span class="line">2.å¦‚ä½•è®©å¤šä¸ªç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…å‘¢?åˆå¦‚ä½•è®©ç”Ÿäº§è€…çº¿ç¨‹è¢«å”¤é†’å‘¢?</span><br><span class="line">3.å¦‚ä½•è¡¡é‡æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…æ‰€å…³å¿ƒçš„æ¡ä»¶æ˜¯å¦å°±ç»ªå‘¢?</span><br></pre></td></tr></table></figure><p>è€Œå‰é¢æåˆ°çš„é€šçŸ¥æ–¹å¼ï¼Œåœ¨linuxç³»ç»Ÿä¸­ï¼Œå°±æ˜¯<code>æ¡ä»¶å˜é‡</code>äº†ï¼</p><h1 id="3-æ¡ä»¶å˜é‡æ¥å£"><a href="#3-æ¡ä»¶å˜é‡æ¥å£" class="headerlink" title="3.æ¡ä»¶å˜é‡æ¥å£"></a>3.æ¡ä»¶å˜é‡æ¥å£</h1><h2 id="3-1-init-x2F-destroy"><a href="#3-1-init-x2F-destroy" class="headerlink" title="3.1 init&#x2F;destroy"></a>3.1 init&#x2F;destroy</h2><p>åŸºæœ¬çš„æ¥å£å’Œpthreadåº“çš„å…¶ä»–æ¥å£å¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯ä¸€æ ·çš„ç”¨æ³•ï¼›å…¶ä¸­<code>attr</code>ä¹Ÿæ˜¯è®¾ç½®æ¡ä»¶å˜é‡çš„å±æ€§ï¼Œè¿™é‡Œç½®ä¸ºnullptrå³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_destroy</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_init</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="type">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br></pre></td></tr></table></figure><h2 id="3-2-pthread-cond-wait"><a href="#3-2-pthread-cond-wait" class="headerlink" title="3.2 pthread_cond_wait"></a>3.2 pthread_cond_wait</h2><p>è¿™ä¸¤ä¸ªæ¥å£éƒ½æ˜¯è®©çº¿ç¨‹åœ¨ä¸€ä¸ªæ¡ä»¶å˜é‡ä¸‹è¿›è¡Œç­‰å¾…ï¼Œå…¶ä¸­<code>timewait</code>æ¥å£å¯ä»¥è®¾ç½®ç­‰å¾…çš„æ—¶é—´ï¼ˆè¶…æ—¶äº†å°±ä¸ç­‰äº†ï¼‰</p><p>æ¡ä»¶å˜é‡ä¹Ÿæ˜¯ä¸´ç•Œèµ„æºï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä¸€ä¸ªmutexé”æ¥ä¿è¯<strong>æ¡ä»¶å˜é‡</strong>è¯»å†™çš„åŸå­æ€§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_timedwait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">                           <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">                           <span class="type">const</span> <span class="keyword">struct</span> timespec *<span class="keyword">restrict</span> abstime)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">                      <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span>;</span><br></pre></td></tr></table></figure><h2 id="3-3-pthrea-cond-signal-x2F-broadcast"><a href="#3-3-pthrea-cond-signal-x2F-broadcast" class="headerlink" title="3.3 pthrea_cond_signal&#x2F;broadcast"></a>3.3 pthrea_cond_signal&#x2F;broadcast</h2><p>è¿™ä¸ªæ¥å£çš„ä½œç”¨æ˜¯ç»™åœ¨æ¡ä»¶å˜é‡ä¸‹ç­‰å¾…çš„çº¿ç¨‹å‘ä¿¡å·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_broadcast</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_signal</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>broadcast</code>æ˜¯ç»™åœ¨å½“å‰æ¡ä»¶å˜é‡ç­‰å¾…çš„<strong>æ‰€æœ‰çº¿ç¨‹</strong>å‘ä¿¡å·ï¼Œè€Œ<code>signal</code>æ˜¯å‘é€ä¿¡å·ï¼Œåªå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼›</p><p>å¦‚æœè°ƒç”¨æˆåŠŸï¼Œè¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šè¿”å›0ï¼›å¦åˆ™è¿”å›é”™è¯¯ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RETURN VALUE</span><br><span class="line">       If  successful, the pthread_cond_broadcast() and pthread_cond_signal() functions shall return zero; otherwise, an error number shall</span><br><span class="line">       be returned to indicate the error.</span><br></pre></td></tr></table></figure><h2 id="3-4-ä»£ç ç¤ºä¾‹"><a href="#3-4-ä»£ç ç¤ºä¾‹" class="headerlink" title="3.4 ä»£ç ç¤ºä¾‹"></a>3.4 ä»£ç ç¤ºä¾‹</h2><p>ä¸‹é¢è¿™ä¸ªä»£ç å¯ä»¥å¾ˆå¥½çš„æ¼”ç¤ºä¸Šé¢æåˆ°çš„å¤šä¸ªæ¥å£</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;<span class="comment">//é”</span></span><br><span class="line"><span class="type">pthread_cond_t</span> cond;<span class="comment">//æ¡ä»¶å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">bool</span> quit = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>*<span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(!quit)<span class="comment">//è¿™é‡Œæœ‰bugï¼Œåç»­ä¼šæåˆ°</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;cond,&amp;mutex);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread is running... &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread quit... &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_cond_init</span>(&amp;cond,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2,t3;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t3,<span class="literal">nullptr</span>,func,(<span class="type">void</span>*)<span class="string">&quot;t3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[a/b]$ &quot;</span>;</span><br><span class="line">        cin &gt;&gt; c;</span><br><span class="line">        <span class="keyword">if</span>(c==<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cond_signal</span>(&amp;cond);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(c==<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">pthread_cond_broadcast</span>(&amp;cond);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            quit = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main break: &quot;</span> &lt;&lt; quit &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">pthread_cond_broadcast</span>(&amp;cond);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t3,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡è¾“å…¥aï¼Œå°±<code>signal</code>ä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼›æ¯æ¬¡è¾“å…¥bï¼Œä¼šè°ƒç”¨<code>broadcast</code>ï¼Œå”¤é†’å½“å‰æ‰€æœ‰çº¿ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-25_çº¿ç¨‹åŒæ­¥]$ ./test</span><br><span class="line">[a/b]$ a</span><br><span class="line">thread is running... t1</span><br><span class="line">[a/b]$ a</span><br><span class="line">thread is running... t2</span><br><span class="line">[a/b]$ a</span><br><span class="line">thread is running... t3</span><br><span class="line">[a/b]$ b</span><br><span class="line">thread is running... t1</span><br><span class="line">thread is running... t2</span><br><span class="line">thread is running... t3</span><br></pre></td></tr></table></figure><h3 id="3-4-1-å°bug"><a href="#3-4-1-å°bug" class="headerlink" title="3.4.1 å°bug"></a>3.4.1 å°bug</h3><p>ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ï¼Œä¼šå‡ºç°ä¸‹é¢çš„é—®é¢˜ï¼Œå³æˆ‘ä»¬è¾“å…¥é™¤äº†aå’Œbä»¥å¤–çš„æ‰€æœ‰å­—ç¬¦ï¼Œéƒ½åº”è¯¥ä¼šæŠŠå…¨å±€å˜é‡<code>quit</code>æ”¹æˆtrueï¼Œè®©ä¸‰ä¸ªçº¿ç¨‹éƒ½é€€å‡º</p><p>ä½†è§‚å¯Ÿåˆ°çš„ç°è±¡å´æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹é€€å‡ºäº†ï¼Œå…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…äº†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-25_çº¿ç¨‹åŒæ­¥]$ ./test</span><br><span class="line">[a/b]$ q</span><br><span class="line">main break: 1</span><br><span class="line">thread is running... t3</span><br><span class="line">thread quit... t3</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º<code>pthread_cond_wait</code>é‡Œé¢è¿›è¡Œäº†<strong>ç‹¬ç‰¹çš„æ“ä½œ</strong>ï¼Œå³ç­‰å¾…ä¹‹å‰ï¼Œå®ƒä¼šé‡Šæ”¾é”ï¼Œç­‰å¾…ä¹‹åï¼Œä»–ä¼šé‡æ–°ç”³è¯·é”</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">                      <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span></span><br><span class="line">&#123;</span><br><span class="line">	pthread_mutex_unlock(mutex);<span class="comment">//å…ˆè§£é”</span></span><br><span class="line">    <span class="comment">//é¿å…å› ä¸ºè¯¥çº¿ç¨‹æ‹¿ç€é”å»ä¼‘çœ äº†ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•ç”³è¯·è¯¥é”</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">//æ¡ä»¶å˜é‡ç›¸å…³ä»£ç </span></span><br><span class="line">	</span><br><span class="line">    pthread_mutex_lock(mutex);<span class="comment">//æ¡ä»¶æ»¡è¶³åï¼Œå†åŠ é”</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªé€€å‡ºçš„çº¿ç¨‹ï¼Œé€€å‡ºä¹‹å‰ç”³è¯·äº†é”å´æ²¡æœ‰é‡Šæ”¾ï¼Œäºæ˜¯å°±å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨<strong>æ¡ä»¶æ»¡è¶³å</strong>ï¼Œæ²¡æœ‰åŠæ³•ç”³è¯·é”ï¼Œåªèƒ½é˜»å¡ç­‰å¾…ï¼</p><h3 id="3-4-2-ä¿®æ­£"><a href="#3-4-2-ä¿®æ­£" class="headerlink" title="3.4.2 ä¿®æ­£"></a>3.4.2 ä¿®æ­£</h3><p>ä¿®æ­£çš„æ–¹æ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨<code>while(!quit)</code>å¾ªç¯çš„é€€å‡ºæ¡ä»¶æ»¡è¶³ä¹‹åï¼Œé‡Šæ”¾ä¸€ä¸‹é”ï¼Œå°±OKäº†ï¼</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>*<span class="title">func</span><span class="params">(<span class="type">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(!quit)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;cond,&amp;mutex);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread is running... &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; endl;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);<span class="comment">//æ­£ç¡®æ“ä½œï¼šéœ€è¦åœ¨æ¡ä»¶æ»¡è¶³åï¼Œè§£é”</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread quit... &quot;</span> &lt;&lt; (<span class="type">char</span>*)arg &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±èƒ½çœ‹åˆ°ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½æ­£å¸¸é€€å‡ºäº†ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-25_çº¿ç¨‹åŒæ­¥]$ ./test</span><br><span class="line">[a/b]$ q</span><br><span class="line">main break: 1</span><br><span class="line">thread is running... t1</span><br><span class="line">thread quit... t1</span><br><span class="line">thread is running... t2</span><br><span class="line">thread quit... t2</span><br><span class="line">thread is running... t3</span><br><span class="line">thread quit... t3</span><br><span class="line">[muxue@bt-7274:~/git/linux/code/22-12-25_çº¿ç¨‹åŒæ­¥]$</span><br></pre></td></tr></table></figure><h3 id="3-4-3-å…¸å‹é”™è¯¯"><a href="#3-4-3-å…¸å‹é”™è¯¯" class="headerlink" title="3.4.3 å…¸å‹é”™è¯¯"></a>3.4.3 å…¸å‹é”™è¯¯</h3><p>æ ¹æ®è¿™ç‚¹ï¼Œå°±èƒ½å¼•å‡ºä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„é”™è¯¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pthread_mutex_lock(&amp;mutex);</span><br><span class="line"><span class="keyword">while</span> (condition_is_false) &#123;</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">    pthread_cond_wait(&amp;cond);<span class="comment">//è§£é”å’ŒåŠ é”çš„æ“ä½œï¼Œè¯¥å‡½æ•°ä¼šå¸®æˆ‘ä»¬å®Œæˆ</span></span><br><span class="line">    pthread_mutex_lock(&amp;mutex);<span class="comment">//äºŒæ¬¡ç”³è¯·åŒä¸€æŠŠé”ï¼Œå‡ºç°æ­»é”ï¼</span></span><br><span class="line">&#125;</span><br><span class="line">pthread_mutex_unlock(&amp;mutex);</span><br></pre></td></tr></table></figure><p>ä¸¤æ¬¡ç”³è¯·åŒä¸€æŠŠé”ï¼Œå°±å¥½æ¯”è‡ªå·±æŠŠè‡ªå·±ç»Šå€’äº†ğŸ˜‚æˆ‘ä»¬è¦é¿å…å†™å‡ºè¿™æ ·çš„é”™è¯¯ä»£ç ï¼</p><hr><h1 id="4-é˜»å¡é˜Ÿåˆ—-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ä¾‹"><a href="#4-é˜»å¡é˜Ÿåˆ—-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ä¾‹" class="headerlink" title="4.é˜»å¡é˜Ÿåˆ—-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ä¾‹"></a>4.é˜»å¡é˜Ÿåˆ—-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ä¾‹</h1><p>è¿™ä¸ªé˜Ÿåˆ—çš„ä½œç”¨ï¼Œå°±æ˜¯æä¾›ä¸€ä¸ªè¶…å¸‚ï¼Œä¾›ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¿›è¡Œæ•°æ®çš„äº¤æ¢</p><ul><li>ç”Ÿäº§è€…ï¼Œå¾€é˜Ÿåˆ—é‡Œé¢pushæ•°æ®</li><li>æ¶ˆè´¹è€…ï¼Œä»é˜Ÿåˆ—é‡Œé¢popæ•°æ®</li></ul><p>çœ‹èµ·æ¥æœ‰äº›ç±»ä¼¼äºç®¡é“ï¼ŒåŒæ ·çš„ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åœ¨è¯»å–é˜»å¡é˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¸ä»…éœ€è¦ä¿è¯è‡ªå·±çš„æ“ä½œæ˜¯åŸå­æ“ä½œï¼Œè¿˜éœ€è¦åšåˆ°ä¸€å®šçš„<code>è®¿é—®æ§åˆ¶</code>ï¼›å³æ¶ˆè´¹è€…åœ¨é˜Ÿåˆ—ç©ºçš„æ—¶å€™ä¸èƒ½ç»§ç»­popï¼Œç”Ÿäº§è€…åœ¨é˜Ÿåˆ—æ»¡çš„æ—¶å€™ä¸èƒ½ç»§ç»­push</p><p>æ­¤æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¼•å…¥ä¸€ä¸ª<code>å¾®ä¿¡å…¬ä¼—å·</code>ï¼Œä¹Ÿå°±æ˜¯ä¸€å®šçš„é€šçŸ¥æ–¹å¼ï¼šä¸è¦è®©ç”Ÿäº§è€…ã€æ¶ˆè´¹è€…ç–¯ç‹‚æ£€æµ‹é˜»å¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯å¼•å…¥æ¡ä»¶å˜é‡ï¼Œåœ¨é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æ—¶å€™ï¼Œé€šçŸ¥æ¶ˆè´¹è€…ï¼›åœ¨é˜Ÿåˆ—ä¸ä¸ºæ»¡çš„æ—¶å€™ï¼Œé€šçŸ¥ç”Ÿäº§è€…ï¼›è¿™æ ·å°±è¾¾åˆ°äº†çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚</p><h2 id="4-1-æˆå‘˜å˜é‡"><a href="#4-1-æˆå‘˜å˜é‡" class="headerlink" title="4.1 æˆå‘˜å˜é‡"></a>4.1 æˆå‘˜å˜é‡</h2><p>è¦å®ç°é˜»å¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç†æ¸…æ¥šéœ€è¦ä»€ä¹ˆæˆå‘˜å˜é‡ï¼Œæ¥ä¿æŠ¤è¯¥é˜Ÿåˆ—</p><ul><li>ç”¨äºè®¿é—®æ§åˆ¶çš„é”ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®é˜Ÿåˆ—</li><li>ç”¨æˆ·çº¿ç¨‹åŒæ­¥çš„æ¡ä»¶å˜é‡ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦åœ¨ä¸åŒçš„æ¡ä»¶ä¸‹é€šçŸ¥ä¸åŒçš„äººï¼Œæ‰€ä»¥éœ€è¦2ä¸ªæ¡ä»¶å˜é‡</li><li>ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œé‡‡ç”¨<code>std::queue</code>ï¼Œè¿™æ ·å°±ä¸ç”¨è‡ªå·±é€ è½®å­äº†</li></ul><p>ç†æ¸…æ¥šäº†ä¹‹åï¼Œå°±å¯ä»¥æ¥å†™æˆå‘˜å˜é‡å•¦ï¼›æˆ‘é‡‡ç”¨äº†æ¨¡æ¿ç±»å‹ï¼Œè¿™æ ·é˜»å¡é˜Ÿåˆ—å°±å¯ä»¥ç”¨æ¥å­˜æ”¾ä»»ä½•æˆ‘ä»¬æƒ³è¦çš„ç±»å‹äº†</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockQueue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    queue&lt;T&gt; _bq;<span class="comment">//é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">size_t</span> _size;<span class="comment">//å¤§å°</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> _mutex;<span class="comment">//é”</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> _proInf;<span class="comment">//é€šçŸ¥ç”Ÿäº§è€…</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> _conInf;<span class="comment">//é€šçŸ¥æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BlockQueue</span>(<span class="type">int</span> sz=<span class="number">5</span>)</span><br><span class="line">        :_size(sz)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;_mutex,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;_proInf,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;_conInf,<span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">BlockQueue</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;_mutex);</span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;_proInf);</span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;_conInf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä½ å¯èƒ½æƒ³é—®ï¼Œqueueä¸æ˜¯æœ‰å°è£…sizeå—ï¼Ÿå“ªè¿™é‡Œæˆ‘ä»¬è¿˜å®šä¹‰ä¸€ä¸ªå¤§å°å˜é‡ï¼Œä¼šä¸ä¼šæœ‰äº›å¤šä½™ï¼Ÿ</p><p>nopeï¼å®é™…ä¸Šï¼Œè¿™é‡Œçš„è¿™ä¸ª<code>_size</code> å°±å¥½æ¯”æˆ‘ä»¬åœ¨Cè¯­è¨€å†™é¡ºåºè¡¨çš„æ—¶å€™ï¼Œæˆå‘˜<code>capacity</code>ï¼›å…¶ä½œç”¨æ˜¯æ¥åˆ¤æ–­æˆ‘ä»¬çš„é˜Ÿåˆ—<strong>æœ‰æ²¡æœ‰æ»¡</strong>çš„ã€‚</p><hr><h2 id="4-2-pushå’Œpop"><a href="#4-2-pushå’Œpop" class="headerlink" title="4.2 pushå’Œpop"></a>4.2 pushå’Œpop</h2><p>å¯¹äºä¸€ä¸ªé˜Ÿåˆ—ï¼Œæœ€é‡è¦çš„æ“ä½œå°±æ˜¯åœ¨é˜Ÿå¤´å‡ºæ•°æ®ï¼Œé˜Ÿå°¾å…¥æ•°æ®</p><p>ç®€å•è¯´æ¥ï¼Œå°±æ˜¯éœ€è¦åœ¨å¤„ç†é˜Ÿåˆ—æ•°æ®çš„æ—¶å€™è¿›è¡ŒåŠ é”ï¼Œä¿è¯åŸå­æ€§ï¼›</p><p>é™¤æ­¤ä»¥å¤–ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æœ‰ä¸åŒçš„æ“ä½œé€»è¾‘ï¼š</p><ul><li>ç”Ÿäº§<ul><li>åˆ¤æ–­æ˜¯å¦ç¬¦åˆç”Ÿäº§æ¡ä»¶ï¼ˆé˜Ÿåˆ—æ²¡æœ‰æ»¡ï¼‰</li><li>æ»¡ï¼Œä¸ç”Ÿäº§ï¼›ä¸æ»¡ï¼Œç”Ÿäº§ï¼›</li><li>æ»¡äº†çš„æ—¶å€™ï¼Œç”Ÿäº§è€…åº”åœ¨æ¡ä»¶å˜é‡ä¸­ç­‰å¾…ï¼ˆç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ï¼‰</li><li>ä¸æ»¡çš„æ—¶å€™ï¼Œç”Ÿäº§è€…ç”Ÿäº§ï¼Œå¹¶é€šçŸ¥æ¶ˆè´¹è€…æ¥æ¶ˆè´¹</li></ul></li><li>æ¶ˆè´¹<ul><li>åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ¶ˆè´¹æ¡ä»¶ï¼ˆé˜Ÿåˆ—ä¸ä¸ºç©ºï¼‰</li><li>ç©ºï¼Œä¸æ¶ˆè´¹ï¼›ä¸ç©ºï¼Œæ¶ˆè´¹ï¼›</li><li>ç©ºäº†çš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…åº”è¯¥åœ¨æ¡ä»¶å˜é‡ä¸­ç­‰å¾…ï¼ˆç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§ï¼‰</li><li>ä¸ç©ºçš„æ—¶å€™ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå¹¶é€šçŸ¥ç”Ÿäº§è€…ç»§ç»­ç”Ÿäº§</li></ul></li></ul><p>è¿™æ ·å°±å®ç°äº†é˜»å¡é˜Ÿåˆ—pushå’Œpopçš„åŸºæœ¬é€»è¾‘ï¼›ç”±æ­¤å¯ä»¥å†™å‡ºä¸‹é¢çš„ä»£ç </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¶ˆè´¹è€…æ¶ˆè´¹</span></span><br><span class="line"><span class="function">T <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//åŠ é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;_mutex);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(_size)<span class="comment">//ç©ºï¼Œä¸æ¶ˆè´¹</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;_conInf,&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¶ˆè´¹å¹¶é€šçŸ¥ç”Ÿäº§è€…</span></span><br><span class="line">    T tmp = _bq.<span class="built_in">front</span>();</span><br><span class="line">    _bq.<span class="built_in">pop</span>();</span><br><span class="line">    <span class="built_in">pthread_cond_signal</span>(&amp;_proInf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;_mutex);</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç”Ÿäº§è€…ç”Ÿäº§</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Push</span><span class="params">(<span class="type">const</span> T&amp; in)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//åŠ é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;_mutex);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(bq.<span class="built_in">size</span>()&gt;=_size)<span class="comment">//æ»¡ï¼Œä¸ç”Ÿäº§</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;_proInf,&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç”Ÿäº§å¹¶é€šçŸ¥æ¶ˆè´¹è€…</span></span><br><span class="line">    _bq.<span class="built_in">push</span>(in);</span><br><span class="line">    <span class="built_in">pthread_cond_signal</span>(&amp;_conInf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-1-è¿è¡Œæµ‹è¯•"><a href="#4-2-1-è¿è¡Œæµ‹è¯•" class="headerlink" title="4.2.1 è¿è¡Œæµ‹è¯•"></a>4.2.1 è¿è¡Œæµ‹è¯•</h3><p>æœ‰äº†è¿™ä¸ªåŸºæœ¬æ¡†æ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥æµ‹è¯•ä¸€ä¸‹ä»£ç å•¦ï¼</p><p>å…ˆæ¥ä¸€ä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…åº·åº·å§</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;blockqueue.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">consume</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BlockQueue&lt;<span class="type">int</span>&gt; *bqp = (BlockQueue&lt;<span class="type">int</span>&gt; *)args;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æ¶ˆè´¹</span></span><br><span class="line">        <span class="type">int</span> ret = bqp-&gt;<span class="built_in">pop</span>();</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;consume &quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>() &lt;&lt; <span class="string">&quot; æ¶ˆè´¹ï¼š&quot;</span> &lt;&lt; ret &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">produce</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BlockQueue&lt;<span class="type">int</span>&gt; *bqp = (BlockQueue&lt;<span class="type">int</span>&gt; *)args;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// åˆ¶ä½œ</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;########â†“&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="type">int</span> a = <span class="built_in">rand</span>()%<span class="number">100</span>;</span><br><span class="line">        <span class="comment">// æŠ•æ”¾åˆ°è¶…å¸‚</span></span><br><span class="line">        bqp-&gt;<span class="built_in">push</span>(a);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;produce &quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>() &lt;&lt; <span class="string">&quot; ç”Ÿäº§ï¼š&quot;</span> &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srand</span>((<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>));</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="function">BlockQueue&lt;<span class="type">int</span>&gt; <span class="title">bq</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,produce,(<span class="type">void</span>*)&amp;bq);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,consume,(<span class="type">void</span>*)&amp;bq);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåˆšå¼€å§‹æ¶ˆè´¹è€…å¹¶æ²¡æœ‰è¿è¡Œï¼Œè€Œæ˜¯ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§å‡ºæ•°æ®äº†ä¹‹åï¼Œå†å¼€å§‹æ¶ˆè´¹ï¼æˆ‘ä»¬çš„ç›®çš„æˆåŠŸè¾¾æˆï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/23-01-08 blockqueue]$ ./test</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š41</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š11</span><br><span class="line">consume 139716357375744 æ¶ˆè´¹ï¼š41</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š19</span><br><span class="line">consume 139716357375744 æ¶ˆè´¹ï¼š11</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š19</span><br><span class="line">consume 139716357375744 æ¶ˆè´¹ï¼š19</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š25</span><br><span class="line">consume 139716357375744 æ¶ˆè´¹ï¼š19</span><br><span class="line">########â†“</span><br><span class="line">produce 139716365768448 ç”Ÿäº§ï¼š63</span><br><span class="line">consume 139716357375744 æ¶ˆè´¹ï¼š25</span><br></pre></td></tr></table></figure><p>å¦‚æœå¢åŠ çº¿ç¨‹åˆ°2ç”Ÿäº§2æ¶ˆè´¹ï¼Œåˆ™ä¼šçœ‹åˆ°ä¸‹é¢çš„æƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/23-01-08 blockqueue]$ ./test</span><br><span class="line">########â†“</span><br><span class="line">produce 140483816179456 ç”Ÿäº§ï¼š51</span><br><span class="line">consume 140483807786752 æ¶ˆè´¹ï¼š51</span><br><span class="line">########â†“</span><br><span class="line">produce 140483799394048 ç”Ÿäº§ï¼š38</span><br><span class="line">consume 140483791001344 æ¶ˆè´¹ï¼š38</span><br><span class="line">########â†“</span><br><span class="line">produce 140483816179456 ç”Ÿäº§ï¼š37</span><br><span class="line">consume 140483807786752 æ¶ˆè´¹ï¼š37</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡è¢«å”¤é†’çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œäº¤æ›¿å”¤é†’</p><h3 id="4-2-2-è¿›ä¸€æ­¥å°è£…"><a href="#4-2-2-è¿›ä¸€æ­¥å°è£…" class="headerlink" title="4.2.2 è¿›ä¸€æ­¥å°è£…"></a>4.2.2 è¿›ä¸€æ­¥å°è£…</h3><p>ä¸ºäº†ä»£ç çš„å¯è¯»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹é˜»å¡é˜Ÿåˆ—è¿›ä¸€æ­¥å°è£…</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlockQueue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    queue&lt;T&gt; _bq;<span class="comment">//é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">size_t</span> _size;<span class="comment">//å¤§å°</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> _mutex;<span class="comment">//é”</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> _proInf;<span class="comment">//é€šçŸ¥ç”Ÿäº§è€…</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> _conInf;<span class="comment">//é€šçŸ¥æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BlockQueue</span>(<span class="type">int</span> sz=<span class="number">5</span>)</span><br><span class="line">        :_size(sz)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_init</span>(&amp;_mutex,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;_proInf,<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="built_in">pthread_cond_init</span>(&amp;_conInf,<span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">BlockQueue</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_destroy</span>(&amp;_mutex);</span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;_proInf);</span><br><span class="line">        <span class="built_in">pthread_cond_destroy</span>(&amp;_conInf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¶ˆè´¹è€…æ¶ˆè´¹</span></span><br><span class="line">    <span class="function">T <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//åŠ é”</span></span><br><span class="line">        <span class="built_in">lock</span>();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isEmpty</span>())<span class="comment">//ç©ºï¼Œä¸æ¶ˆè´¹</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">ConWait</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ¶ˆè´¹å¹¶é€šçŸ¥ç”Ÿäº§è€…</span></span><br><span class="line">        T tmp = _bq.<span class="built_in">front</span>();</span><br><span class="line">        _bq.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="built_in">WakeUpPro</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è§£é”</span></span><br><span class="line">        <span class="built_in">unlock</span>();</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”Ÿäº§è€…ç”Ÿäº§</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T&amp; in)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//åŠ é”</span></span><br><span class="line">        <span class="built_in">lock</span>();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isFull</span>())<span class="comment">//æ»¡ï¼Œä¸ç”Ÿäº§</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">ProWait</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ç”Ÿäº§å¹¶é€šçŸ¥æ¶ˆè´¹è€…</span></span><br><span class="line">        _bq.<span class="built_in">push</span>(in);</span><br><span class="line">        <span class="built_in">WakeUpCon</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è§£é”</span></span><br><span class="line">        <span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å”¤é†’æ¶ˆè´¹è€…</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WakeUpCon</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;_conInf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å”¤é†’ç”Ÿäº§è€…</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">WakeUpPro</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;_proInf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ¶ˆè´¹è€…ç­‰å¾…</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ConWait</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;_conInf,&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”Ÿäº§è€…ç­‰å¾…</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ProWait</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">pthread_cond_wait</span>(&amp;_proInf,&amp;_mutex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ¡ä»¶</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isFull</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _size == _bq.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">isEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _bq.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-2-3-ä½¿ç”¨taskåˆ†é…è¿ç®—ä»»åŠ¡"><a href="#4-2-3-ä½¿ç”¨taskåˆ†é…è¿ç®—ä»»åŠ¡" class="headerlink" title="4.2.3 ä½¿ç”¨taskåˆ†é…è¿ç®—ä»»åŠ¡"></a>4.2.3 ä½¿ç”¨taskåˆ†é…è¿ç®—ä»»åŠ¡</h3><p>å› ä¸ºé˜»å¡é˜Ÿåˆ—æ˜¯ç”¨æ¨¡æ¿ç±»å‹çš„ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª<code>ä»¿å‡½æ•°</code>ï¼Œæ¥ç»™ç”Ÿäº§è€…æ¶ˆè´¹è€…åˆ†é…ä»»åŠ¡</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Task</span>(<span class="type">int</span> one=<span class="number">0</span>, <span class="type">int</span> two=<span class="number">0</span>, <span class="type">char</span> op=<span class="string">&quot;+&quot;</span>) </span><br><span class="line">        : _elem1(one), _elem2(two), _operator(op)</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="comment">// ä»¿å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span><span class="params">()</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">run</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿è¡Œä»¿å‡½æ•°</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (_operator)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">            result = _elem1 + _elem2;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            result = _elem1 - _elem2;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">            result = _elem1 * _elem2;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_elem2 == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;div zero, abort&quot;</span> &lt;&lt; endl;</span><br><span class="line">                result = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                result = _elem1 / _elem2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (_elem2 == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;mod zero, abort&quot;</span> &lt;&lt; endl;</span><br><span class="line">                result = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                result = _elem1 % _elem2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;unknown: &quot;</span> &lt;&lt; _operator &lt;&lt; endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å…ƒç´ ï¼Œæ–¹ä¾¿æ‰“å°</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">get</span><span class="params">(<span class="type">int</span> *e1, <span class="type">int</span> *e2, <span class="type">char</span> *op)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        *e1 = _elem1;</span><br><span class="line">        *e2 = _elem2;</span><br><span class="line">        *op = _operator;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> _elem1;</span><br><span class="line">    <span class="type">int</span> _elem2;</span><br><span class="line">    <span class="type">char</span> _operator;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;blockqueue.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;task.hpp&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line">string ops =<span class="string">&quot;+-*/%&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">consumer</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BlockQueue&lt;Task&gt; *bqp = (BlockQueue&lt;Task&gt; *)args;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Task t = bqp-&gt;<span class="built_in">pop</span>();</span><br><span class="line">        <span class="type">int</span> result = <span class="built_in">t</span>();    <span class="comment">//å¤„ç†ä»»åŠ¡</span></span><br><span class="line">        <span class="type">int</span> one, two;</span><br><span class="line">        <span class="type">char</span> op;</span><br><span class="line">        t.<span class="built_in">get</span>(&amp;one, &amp;two, &amp;op);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;consumer [&quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>() &lt;&lt; <span class="string">&quot;] &quot;</span> &lt;&lt; (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>) &lt;&lt; <span class="string">&quot; æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: &quot;</span> &lt;&lt; one &lt;&lt; op &lt;&lt; two &lt;&lt; <span class="string">&quot; = &quot;</span> &lt;&lt; result &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">producer</span><span class="params">(<span class="type">void</span> *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BlockQueue&lt;Task&gt; *bqp = (BlockQueue&lt;Task&gt; *)args;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// åˆ¶ä½œä»»åŠ¡</span></span><br><span class="line">        <span class="type">int</span> one = <span class="built_in">rand</span>() % <span class="number">50</span>;</span><br><span class="line">        <span class="type">int</span> two = <span class="built_in">rand</span>() % <span class="number">20</span>;</span><br><span class="line">        <span class="type">char</span> op = ops[<span class="built_in">rand</span>() % ops.<span class="built_in">size</span>()];</span><br><span class="line">        <span class="function">Task <span class="title">t</span><span class="params">(one, two, op)</span></span>;</span><br><span class="line">        <span class="comment">// æŠ•æ”¾ç»™æ¶ˆè´¹è€…ç”Ÿäº§</span></span><br><span class="line">        bqp-&gt;<span class="built_in">push</span>(t);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;producter[&quot;</span> &lt;&lt; <span class="built_in">pthread_self</span>() &lt;&lt; <span class="string">&quot;] &quot;</span> &lt;&lt; (<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>) &lt;&lt; <span class="string">&quot; ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: &quot;</span> &lt;&lt; one &lt;&lt; op &lt;&lt; two &lt;&lt; <span class="string">&quot; = ?&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pthread_t</span> t1,t2;</span><br><span class="line">    <span class="function">BlockQueue&lt;Task&gt; <span class="title">bq</span><span class="params">(<span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t1,<span class="literal">nullptr</span>,producer,(<span class="type">void</span>*)&amp;bq);</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">pthread_create</span>(&amp;t2,<span class="literal">nullptr</span>,consumer,(<span class="type">void</span>*)&amp;bq);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">pthread_join</span>(t1,<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">pthread_join</span>(t2,<span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srand</span>((<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">time</span>(<span class="literal">nullptr</span>));<span class="comment">//ä¹˜ä¸€ä¸ªæ•°å­—æ·»åŠ éšæœºæ€§</span></span><br><span class="line">    <span class="built_in">test2</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿäº§è€…ç”Ÿäº§äº†é—®é¢˜ä¹‹åï¼Œæ¶ˆè´¹è€…ä¼šå»è§£ç­”ã€‚æ­¤æ—¶æˆ‘ä»¬åªéœ€è¦åœ¨çº¿ç¨‹ä¸­å–å›è¿ç®—å¥½çš„ç»“æœï¼Œå°±OKäº†ï¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[muxue@bt-7274:~/git/linux/code/23-01-08 blockqueue]$ ./test</span><br><span class="line">producter[140703422265088] 1673319321 ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: 43-16 = ?</span><br><span class="line">consumer [140703413872384] 1673319322 æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: 43-16 = 27</span><br><span class="line">producter[140703422265088] 1673319322 ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: 45/12 = ?</span><br><span class="line">consumer [140703413872384] 1673319322 æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: 45/12 = 3</span><br><span class="line">producter[140703422265088] 1673319323 ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: 17/7 = ?</span><br><span class="line">consumer [140703413872384] 1673319323 æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: 17/7 = 2</span><br><span class="line">producter[140703422265088] 1673319324 ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: 49-14 = ?</span><br><span class="line">consumer [140703413872384] 1673319324 æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: 49-14 = 35</span><br><span class="line">producter[140703422265088] 1673319325 ç”Ÿäº§äº†ä¸€ä¸ªä»»åŠ¡: 4%4 = ?</span><br><span class="line">consumer [140703413872384] 1673319325 æ¶ˆè´¹äº†ä¸€ä¸ªä»»åŠ¡: 4%4 = 0</span><br></pre></td></tr></table></figure><hr></div><div class="post-copyright-info"><div class="article-copyright-info-container"><ul class="copyright-info-content"><li class="post-title"><span class="type">æœ¬æ–‡æ ‡é¢˜</span>ï¼š<span class="content">ã€Linuxã€‘çº¿ç¨‹æ¦‚å¿µ | åŒæ­¥</span></li><li class="post-author"><span class="type">æœ¬æ–‡ä½œè€…</span>ï¼š<span class="content">æ…•é›ªå¹´å</span></li><li class="post-time"><span class="type">åˆ›å»ºæ—¶é—´</span>ï¼š<span class="content">2022-12-30 17:30:16</span></li><li class="post-link"><span class="type">æœ¬æ–‡é“¾æ¥</span>ï¼š<span class="content">2022/12/30/note_Linux/20çº¿ç¨‹åŒæ­¥/</span></li><li class="post-license"><span class="type">ç‰ˆæƒå£°æ˜</span>ï¼š<span class="content">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</span></li></ul><div class="copy-copyright-info flex-center tooltip" data-content="å¤åˆ¶ç‰ˆæƒä¿¡æ¯" data-offset-y="-2px"><i class="fa-solid fa-copy"></i></div></div></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/Linux/">#Linux</a>&nbsp;</li><li class="tag-item"><a href="/tags/%E7%BA%BF%E7%A8%8B/">#çº¿ç¨‹</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2023/01/05/tools/wikijs%E4%BD%BF%E7%94%A8artalk%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">ã€Artalkã€‘åœ¨wiki jsç«™ç‚¹ä¸Šä½¿ç”¨Artalkè¯„è®ºç³»ç»Ÿ</span> <span class="post-nav-item">ä¸Šä¸€ç¯‡</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2022/12/23/%E5%8D%9A%E5%AE%A2%E8%A1%A8%E6%83%85%E5%8C%85/"><span class="title flex-center"><span class="post-nav-title-item">ã€å›¾åºŠã€‘åšå®¢è¡¨æƒ…åŒ…</span> <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div><div class="comment-container"><div class="comments-container"><div id="comments-anchor"></div><div class="comment-area-title"><i class="fas fa-comments"></i>&nbsp;è¯„è®º</div><div class="waline-comment-container"><link rel="stylesheet" href="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline.css"><link rel="stylesheet" href="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline-meta.css"><script data-pjax src="//img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/waline.js"></script><div id="waline-comment"></div><script data-pjax>function loadWaline() {
            Waline.init({
              el: '#waline-comment',
              serverURL: 'https://vrcl.outpost54.top/',
              lang: 'zh-CN' || 'zh-CN',
              comment: '.post-comments-count',
              reaction: 'false' === 'true'
            })
          }

          if ('true' === 'true') {
            setTimeout(() => {
              loadWaline()
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadWaline)
          }</script></div></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%90%8C%E6%AD%A5"><span class="nav-text">1.ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B"><span class="nav-text">2.ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">2.1 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å…³ç³»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E4%BB%A5%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E4%B8%BA%E4%BE%8B"><span class="nav-text">2.2 ä»¥ç®€å•ä»£ç ä¸ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F%E6%8E%A5%E5%8F%A3"><span class="nav-text">3.æ¡ä»¶å˜é‡æ¥å£</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-init-x2F-destroy"><span class="nav-text">3.1 init&#x2F;destroy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-pthread-cond-wait"><span class="nav-text">3.2 pthread_cond_wait</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-pthrea-cond-signal-x2F-broadcast"><span class="nav-text">3.3 pthrea_cond_signal&#x2F;broadcast</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="nav-text">3.4 ä»£ç ç¤ºä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-1-%E5%B0%8Fbug"><span class="nav-text">3.4.1 å°bug</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-2-%E4%BF%AE%E6%AD%A3"><span class="nav-text">3.4.2 ä¿®æ­£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-3-%E5%85%B8%E5%9E%8B%E9%94%99%E8%AF%AF"><span class="nav-text">3.4.3 å…¸å‹é”™è¯¯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97-%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B%E5%AE%9E%E4%BE%8B"><span class="nav-text">4.é˜»å¡é˜Ÿåˆ—-ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹å®ä¾‹</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F"><span class="nav-text">4.1 æˆå‘˜å˜é‡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-push%E5%92%8Cpop"><span class="nav-text">4.2 pushå’Œpop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-%E8%BF%90%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="nav-text">4.2.1 è¿è¡Œæµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%B0%81%E8%A3%85"><span class="nav-text">4.2.2 è¿›ä¸€æ­¥å°è£…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E4%BD%BF%E7%94%A8task%E5%88%86%E9%85%8D%E8%BF%90%E7%AE%97%E4%BB%BB%E5%8A%A1"><span class="nav-text">4.2.3 ä½¿ç”¨taskåˆ†é…è¿ç®—ä»»åŠ¡</span></a></li></ol></li></ol></li></ol></div></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2021</span> - 2023 &nbsp;<i class="fas fa-heart icon-animate"></i> &nbsp;<a href="/">æ…•é›ªå¹´å</a></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="website-count info-item">è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp; æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span></div><div class="timerun-info info-item"><span id="timeDate">è½½å…¥å¤©æ•°...</span><span id="times">è½½å…¥æ—¶åˆ†ç§’...</span><script>var now=new Date;function createtime(){var n=new Date("04/16/2022 00:00:00");now.setTime(now.getTime()+250),days=(now-n)/1e3/60/60/24,dnum=Math.floor(days),hours=(now-n)/1e3/60/60-24*dnum,hnum=Math.floor(hours),1==String(hnum).length&&(hnum="0"+hnum),minutes=(now-n)/1e3/60-1440*dnum-60*hnum,mnum=Math.floor(minutes),1==String(mnum).length&&(mnum="0"+mnum),seconds=(now-n)/1e3-86400*dnum-3600*hnum-60*mnum,snum=Math.round(seconds),1==String(snum).length&&(snum="0"+snum),document.getElementById("timeDate").innerHTML="æœ¬ç«™å·²å®‰å…¨è¿è¡Œ "+dnum+" å¤© ",document.getElementById("times").innerHTML=hnum+" å°æ—¶ "+mnum+" åˆ† "+snum+" ç§’"}setInterval("createtime()",250)</script></div><div class="shields-info info-item"><a href="https://github.com/XPoet/hexo-theme-keep" target="_blank"><img src="https://img.shields.io/badge/hexo-keep%20v3.6.1-blue" height="20px"> </a><a href="https://www.travellings.cn/go.html" target="_blank"><img src="https://img-7758-typora.oss-cn-shanghai.aliyuncs.com/hexo/travellingICON.gif" height="20px"> </a><a href="https://icp.gov.moe/?keyword=20230054" target="_blank"><img src="https://img.shields.io/badge/-%E8%90%8CICP%E5%A4%8720230054%E5%8F%B7-ff69b4" height="20px"></a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item flex-center toggle-show-toc"><i class="fas fa-list"></i></li><li class="tools-item flex-center go-to-comments"><i class="fas fa-comment"></i> <span class="post-comments-count"></span></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="fas fa-arrow-up"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li></ul></div></div><div class="zoom-in-image-mask"><img class="zoom-in-image"></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="æœç´¢..." spellcheck="false" type="search" class="search-input"></div><span class="close-popup-btn"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/utils.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/main.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/header-shrink.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/back2top.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/dark-light-toggle.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/local-search.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/code-block.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/lazyload.js"></script><div class="post-scripts pjax"><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/post-helper.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/anime.min.js"></script><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/toc.js"></script></div><script src="//unpkg.com/hexo-theme-keep@3.6.1/source/js/libs/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });</script><script type="text/javascript" src="/js/snow.js"></script></body></html>